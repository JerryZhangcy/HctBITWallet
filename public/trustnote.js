!function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r}()({1:[function(require,module,exports){var Client=require("./lib");module.exports=Client},{"./lib":9}],2:[function(require,module,exports){(function(process,Buffer){"use strict";function API(opts){opts=opts||{},this.verbose=!!opts.verbose,this.timeout=opts.timeout||5e4,walletDefinedByKeys=require("trustnote-common/wallet_defined_by_keys.js"),this.verbose?log.setLevel("debug"):log.setLevel("info")}if(process.browser){var conf=require("trustnote-common/conf.js"),appPackageJson=require("../../../package.json");conf.program=appPackageJson.name,conf.program_version=appPackageJson.version}var walletDefinedByKeys,breadcrumbs=(require("trustnote-common/signature.js"),require("trustnote-common/breadcrumbs.js")),constants=require("trustnote-common/constants.js"),_=require("lodash"),$=require("preconditions").singleton(),util=require("util"),events=require("events"),eventBus=require("trustnote-common/event_bus.js"),Bitcore=require("bitcore-lib"),Common=require("./common"),Constants=Common.Constants,log=require("./log"),Credentials=require("./credentials"),Errors=require("./errors/errordefinitions");util.inherits(API,events.EventEmitter),API.privateKeyEncryptionOpts={iter:1e4},API.prototype.initialize=function(opts,cb){return $.checkState(this.credentials),cb()},API.prototype.seedFromRandom=function(opts){$.checkArgument(arguments.length<=1,"DEPRECATED: only 1 argument accepted."),$.checkArgument(_.isUndefined(opts)||_.isObject(opts),"DEPRECATED: argument should be an options object."),opts=opts||{},this.credentials=Credentials.create(opts.network||"livenet",opts.account||0)},API.prototype.seedFromRandomWithMnemonic=function(opts){$.checkArgument(arguments.length<=1,"DEPRECATED: only 1 argument accepted."),$.checkArgument(_.isUndefined(opts)||_.isObject(opts),"DEPRECATED: argument should be an options object."),opts=opts||{},console.log("client: seedFromRandomWithMnemonic "+JSON.stringify(opts)),this.credentials=Credentials.createWithMnemonic(opts.network||"livenet",opts.passphrase,opts.language||"en",opts.account||0)},API.prototype.getMnemonic=function(){return this.credentials.getMnemonic()},API.prototype.mnemonicHasPassphrase=function(){return this.credentials.mnemonicHasPassphrase},API.prototype.clearMnemonic=function(){return this.credentials.clearMnemonic()},API.prototype.seedFromExtendedPrivateKey=function(xPrivKey,account){this.credentials=Credentials.fromExtendedPrivateKey(xPrivKey,account)},API.prototype.seedFromMnemonic=function(words,opts){$.checkArgument(_.isUndefined(opts)||_.isObject(opts),"DEPRECATED: second argument should be an options object."),opts=opts||{},this.credentials=Credentials.fromMnemonic(opts.network||"livenet",words,opts.passphrase,opts.account||0,opts.derivationStrategy||Constants.DERIVATION_STRATEGIES.BIP44)},API.prototype.seedFromExtendedPublicKey=function(xPubKey,source,entropySourceHex,opts){$.checkArgument(_.isUndefined(opts)||_.isObject(opts)),opts=opts||{},this.credentials=Credentials.fromExtendedPublicKey(xPubKey,source,entropySourceHex,opts.account||0,opts.derivationStrategy||Constants.DERIVATION_STRATEGIES.BIP44)},API.prototype["export"]=function(opts){$.checkState(this.credentials),opts=opts||{};var output,c=Credentials.fromObj(this.credentials);return opts.noSign&&c.setNoSign(),output=JSON.stringify(c.toObj())},API.prototype["import"]=function(str,opts){opts=opts||{};try{var credentials=Credentials.fromObj(JSON.parse(str));this.credentials=credentials}catch(ex){throw Errors.INVALID_BACKUP}},API.prototype._import=function(cb){$.checkState(this.credentials),self.openWallet(function(err,ret){cb(null,ret)})},API.prototype.importFromMnemonic=function(words,opts,cb){log.debug("Importing from 12 Words"),opts=opts||{};try{this.credentials=Credentials.fromMnemonic(opts.network||"livenet",words,opts.passphrase,opts.account||0,opts.derivationStrategy||Constants.DERIVATION_STRATEGIES.BIP44)}catch(e){return log.info("Mnemonic error:",e),cb(Errors.INVALID_BACKUP)}this._import(cb)},API.prototype.importFromExtendedPrivateKey=function(xPrivKey,cb){log.debug("Importing from Extended Private Key");try{this.credentials=Credentials.fromExtendedPrivateKey(xPrivKey)}catch(e){return log.info("xPriv error:",e),cb(Errors.INVALID_BACKUP)}this._import(cb)},API.prototype.importFromExtendedPublicKey=function(xPubKey,source,entropySourceHex,opts,cb){$.checkArgument(5==arguments.length,"DEPRECATED: should receive 5 arguments"),$.checkArgument(_.isUndefined(opts)||_.isObject(opts)),$.shouldBeFunction(cb),opts=opts||{},log.debug("Importing from Extended Private Key");try{this.credentials=Credentials.fromExtendedPublicKey(xPubKey,source,entropySourceHex,opts.account||0,opts.derivationStrategy||Constants.DERIVATION_STRATEGIES.BIP44)}catch(e){return log.info("xPriv error:",e),cb(Errors.INVALID_BACKUP)}this._import(cb)},API.prototype.decryptBIP38PrivateKey=function(encryptedPrivateKeyBase58,passphrase,opts,cb){var privateKeyWif,Bip38=require("bip38"),bip38=new Bip38;try{privateKeyWif=bip38.decrypt(encryptedPrivateKeyBase58,passphrase)}catch(ex){return cb(new Error("Could not decrypt BIP38 private key",ex))}var privateKey=new Bitcore.PrivateKey(privateKeyWif),address=privateKey.publicKey.toAddress().toString(),addrBuff=new Buffer(address,"ascii"),actualChecksum=Bitcore.crypto.Hash.sha256sha256(addrBuff).toString("hex").substring(0,8),expectedChecksum=Bitcore.encoding.Base58Check.decode(encryptedPrivateKeyBase58).toString("hex").substring(6,14);return actualChecksum!=expectedChecksum?cb(new Error("Incorrect passphrase")):cb(null,privateKeyWif)},API.prototype.openWallet=function(cb){$.checkState(this.credentials);var self=this;return self.credentials.isComplete()&&self.credentials.hasWalletInfo()?cb(null,!0):cb()},API.prototype.isComplete=function(){return this.credentials&&this.credentials.isComplete()},API.prototype.isPrivKeyEncrypted=function(){return this.credentials&&this.credentials.isPrivKeyEncrypted()},API.prototype.hasPrivKeyEncrypted=function(){return this.credentials&&this.credentials.hasPrivKeyEncrypted()},API.prototype.isPrivKeyExternal=function(){return this.credentials&&this.credentials.hasExternalSource()},API.prototype.getPrivKeyExternalSourceName=function(){return this.credentials?this.credentials.getExternalSourceName():null},API.prototype.unlock=function(password){try{this.credentials.unlock(password)}catch(e){throw new Error("Could not unlock:"+e)}},API.prototype.canSign=function(){return this.credentials&&this.credentials.canSign()},API.prototype.setPrivateKeyEncryption=function(password,opts){this.credentials.setPrivateKeyEncryption(password,opts||API.privateKeyEncryptionOpts)},API.prototype.disablePrivateKeyEncryption=function(password,opts){return this.credentials.disablePrivateKeyEncryption()},API.prototype.lock=function(){this.credentials.lock()},API.prototype.createWallet=function(walletName,m,n,opts,cb){var self=this;opts&&$.shouldBeObject(opts),opts=opts||{};var network=opts.network||"livenet";return _.includes(["testnet","livenet"],network)?(self.credentials?log.info("Using existing keys for "+walletName+": "+JSON.stringify(opts)):(log.info("Generating new keys"),self.seedFromRandom({network:network,account:opts.account})),void walletDefinedByKeys.createWalletByDevices(self.credentials.xPubKey,opts.account||0,m,opts.cosigners||[],walletName,function(wallet){return self.credentials.walletId=wallet,console.log("wallet created: "+JSON.stringify(self.credentials)),network!=self.credentials.network?cb(new Error("Existing keys were created for a different network")):(self.credentials.addWalletInfo(walletName,m,n),void cb(null))})):cb(new Error("Invalid network"))},API.prototype.recreateWallet=function(cb){$.checkState(this.credentials),$.checkState(this.credentials.isComplete()),self.openWallet(function(err){return cb(err)}),cb()},API.prototype.createAddress=function(is_change,cb){$.checkState(this.credentials&&this.credentials.isComplete()),$.shouldBeFunction(cb),$.shouldBeNumber(is_change);var coin="livenet"==this.credentials.network?"0":"1",self=this;breadcrumbs.add("createAddress wallet="+this.credentials.walletId+", is_change="+is_change),walletDefinedByKeys.issueOrSelectNextAddress(this.credentials.walletId,is_change,function(addressInfo){var path="m/44'/"+coin+"'/"+self.credentials.account+"'/0/"+addressInfo.address_index;cb(null,{address:addressInfo.address,path:path,createdOn:addressInfo.creation_ts})})},API.prototype.sendMultiPayment=function(opts,cb){var sigtemp,self=this,coin="livenet"==this.credentials.network?"0":"1",Wallet=require("trustnote-common/wallet.js");if(opts.signWithLocalPrivateKey=function(wallet_id,account,is_change,address_index,text_to_sign,handleSig){var path="m/44'/"+coin+"'/"+account+"'/"+is_change+"/"+address_index,xPrivKey=new Bitcore.HDPrivateKey.fromString(self.credentials.xPrivKey),privateKey=xPrivKey.derive(path).privateKey;privateKey.bn.toBuffer({size:32});eventBus.emit("apiTowalletHome",account,is_change,address_index,text_to_sign,function(sig){return"close"==sig?void handleSig("[refused]"):void(sigtemp!=sig&&(sigtemp=sig,sig&&"function"==typeof handleSig?handleSig(sig):"function"==typeof cb?cb("close"):null))})},opts.shared_address)opts.paying_addresses=[opts.shared_address],opts.change_address=opts.shared_address,opts.asset&&"base"!==opts.asset&&(opts.fee_paying_wallet=self.credentials.walletId),Wallet.sendMultiPayment(opts,cb);else{if(opts.paying_addresses||(opts.wallet=self.credentials.walletId),opts.change_address)return Wallet.sendMultiPayment(opts,cb);walletDefinedByKeys.issueOrSelectNextChangeAddress(self.credentials.walletId,function(objAddr){opts.change_address=objAddr.address,Wallet.sendMultiPayment(opts,cb)})}},API.prototype.getAddresses=function(opts,cb){var coin="livenet"==this.credentials.network?"0":"1",self=this;walletDefinedByKeys.readAddresses(this.credentials.walletId,opts,function(arrAddressInfos){cb(null,arrAddressInfos.map(function(addressInfo){return{address:addressInfo.address,createdOn:addressInfo.creation_ts,path:"m/44'/"+coin+"'/"+self.credentials.account+"'/"+addressInfo.is_change+"/"+addressInfo.address_index}}))})},API.prototype.getBalance=function(shared_address,cb){var Wallet=require("trustnote-common/wallet.js");$.checkState(this.credentials&&this.credentials.isComplete());var walletId=this.credentials.walletId;Wallet.readBalance(shared_address||walletId,function(assocBalances){assocBalances[constants.BLACKBYTES_ASSET]||(assocBalances[constants.BLACKBYTES_ASSET]={is_private:1,stable:0,pending:0}),Wallet.readSharedBalance(walletId,function(assocSharedBalances){var assocSharedAddresses={};for(var asset in assocSharedBalances){assocBalances[asset]||(assocBalances[asset]={stable:0,pending:0});for(var sa in assocSharedBalances[asset])assocSharedAddresses[sa]=!0}for(var sa in assocSharedAddresses)for(var asset in assocBalances)assocSharedBalances[asset]||(assocSharedBalances[asset]={}),assocSharedBalances[asset][sa]||(assocSharedBalances[asset][sa]={stable:0,pending:0});cb(null,assocBalances,assocSharedBalances)})})},API.prototype.getListOfBalancesOnAddresses=function(cb){var Wallet=require("trustnote-common/wallet.js");$.checkState(this.credentials&&this.credentials.isComplete());var walletId=this.credentials.walletId;Wallet.readBalancesOnAddresses(walletId,function(assocBalances){cb(assocBalances)})},API.prototype.getTxHistory=function(asset,shared_address,cb){var Wallet=require("trustnote-common/wallet.js");$.checkState(this.credentials&&this.credentials.isComplete());var opts={asset:asset};shared_address?opts.address=shared_address:opts.wallet=this.credentials.walletId,Wallet.readTransactionHistory(opts,function(arrTransactions){cb(arrTransactions)})},API.prototype.initDeviceProperties=function(xPrivKey,device_address,hub,deviceName){console.log("initDeviceProperties");var device=require("trustnote-common/device.js"),lightWallet=require("trustnote-common/light_wallet.js");device_address&&device.setDeviceAddress(device_address),device.setDeviceName(deviceName),device.setDeviceHub(hub),lightWallet.setLightVendorHost(hub);try{device.setDevicePrivateKey(Bitcore.HDPrivateKey.fromString(xPrivKey).derive("m/1'").privateKey.bn.toBuffer({size:32}))}catch(e){throw console.log("error in initDeviceProperties: "+e),e}},module.exports=API}).call(this,require("_process"),require("buffer").Buffer)},{"../../../package.json":420,"./common":4,"./credentials":6,"./errors/errordefinitions":8,"./log":10,_process:309,bip38:32,"bitcore-lib":34,buffer:151,events:215,lodash:271,preconditions:303,"trustnote-common/breadcrumbs.js":365,"trustnote-common/conf.js":370,"trustnote-common/constants.js":371,"trustnote-common/device.js":375,"trustnote-common/event_bus.js":378,"trustnote-common/light_wallet.js":384,"trustnote-common/signature.js":399,"trustnote-common/wallet.js":406,"trustnote-common/wallet_defined_by_keys.js":408,util:418}],3:[function(require,module,exports){"use strict";var Constants={};Constants.DERIVATION_STRATEGIES={BIP44:"BIP44",BIP48:"BIP48"},Constants.UNITS={one:{value:1,maxDecimals:0,minDecimals:0},kilo:{value:1e3,maxDecimals:0,minDecimals:0},mega:{value:1e6,maxDecimals:0,minDecimals:0},giga:{value:1e9,maxDecimals:0,minDecimals:0}},module.exports=Constants},{}],4:[function(require,module,exports){var Common={};Common.Constants=require("./constants"),module.exports=Common},{"./constants":3}],5:[function(require,module,exports){"use strict";function Utils(){}var _=require("lodash"),Constants=require("./constants");Utils.formatAmount=function(bytes,unitCode,opts){function addSeparators(nStr,thousands,decimal,minDecimals){nStr=nStr.replace(".",decimal);var x=nStr.split(decimal),x0=x[0],x1=x[1];x1=_.dropRightWhile(x1,function(n,i){return"0"==n&&i>=minDecimals}).join("");var x2=x.length>1&&parseInt(x[1])?decimal+x1:"";return navigator&&navigator.vendor&&navigator.vendor.indexOf("Apple")>=0?(x0=x0.replace(/\B(?=(\d{3})+(?!\d))/g,thousands),x0+x2):parseFloat(x0+x2).toLocaleString([],{maximumFractionDigits:20})}if(!_.isNumber(bytes))throw new Error("Variable should be a Number.");if(!Constants.UNITS[unitCode])throw new Error("Illegal Argument.");opts=opts||{};var u=Constants.UNITS[unitCode],intAmountLength=Math.floor(bytes/u.value).toString().length,digits=intAmountLength>=7||"one"==unitCode?0:7-intAmountLength,amount=opts.dontRound?(bytes/u.value).toString():(bytes/u.value).toFixed(digits);return addSeparators(amount,opts.thousandsSeparator||",",opts.decimalSeparator||".",u.minDecimals)},module.exports=Utils},{"./constants":3,lodash:271}],6:[function(require,module,exports){(function(Buffer){"use strict";function Credentials(){this.version="1.0.0",this.derivationStrategy=Constants.DERIVATION_STRATEGIES.BIP44,this.account=0}function _checkNetwork(network){if(!_.includes(["livenet","testnet"],network))throw new Error("Invalid network")}var $=(require("crypto"),require("preconditions").singleton()),_=require("lodash"),Bitcore=require("bitcore-lib"),Mnemonic=require("bitcore-mnemonic"),sjcl=require("sjcl"),Common=require("./common"),Constants=Common.Constants,FIELDS=["walletId","network","xPrivKey","xPrivKeyEncrypted","xPubKey","publicKeyRing","walletName","m","n","externalSource","mnemonic","mnemonicEncrypted","entropySource","mnemonicHasPassphrase","derivationStrategy","account"];Credentials.create=function(network,account){_checkNetwork(network);var x=new Credentials;return x.network=network,x.account=account,x.xPrivKey=new Bitcore.HDPrivateKey(network).toString(),x._expand(),x};var wordsForLang={en:Mnemonic.Words.ENGLISH,es:Mnemonic.Words.SPANISH,ja:Mnemonic.Words.JAPANESE,zh:Mnemonic.Words.CHINESE,fr:Mnemonic.Words.FRENCH};Credentials.createWithMnemonic=function(network,passphrase,language,account){if(_checkNetwork(network),!wordsForLang[language])throw new Error("Unsupported language");$.shouldBeNumber(account);for(var m=new Mnemonic(wordsForLang[language]);!Mnemonic.isValid(m.toString());)console.log("--- retrying mnemonic generation"),m=new Mnemonic(wordsForLang[language]);var x=new Credentials;return x.network=network,x.account=account,x.xPrivKey=m.toHDPrivateKey(passphrase,network).toString(),x._expand(),x.mnemonic=m.phrase,x.mnemonicHasPassphrase=!!passphrase,console.log("credentials: createWithMnemonic "+network+", "+passphrase+","+language+","+account),x},Credentials.fromExtendedPrivateKey=function(xPrivKey,account){var x=new Credentials;return x.xPrivKey=xPrivKey,x.account=account||0,x._expand(),x},Credentials.fromMnemonic=function(network,words,passphrase,account,derivationStrategy){_checkNetwork(network),$.shouldBeNumber(account),$.checkArgument(_.includes(_.values(Constants.DERIVATION_STRATEGIES),derivationStrategy));var m=new Mnemonic(words),x=new Credentials;return x.xPrivKey=m.toHDPrivateKey(passphrase,network).toString(),x.mnemonic=words,x.mnemonicHasPassphrase=!!passphrase,x.account=account,x.derivationStrategy=derivationStrategy,x._expand(),x},Credentials.fromExtendedPublicKey=function(xPubKey,source,entropySourceHex,account,derivationStrategy){$.checkArgument(entropySourceHex),$.shouldBeNumber(account),$.checkArgument(_.includes(_.values(Constants.DERIVATION_STRATEGIES),derivationStrategy));var entropyBuffer=new Buffer(entropySourceHex,"hex");$.checkArgument(entropyBuffer.length>=14,"At least 112 bits of entropy are needed");var x=new Credentials;return x.xPubKey=xPubKey,x.entropySource=Bitcore.crypto.Hash.sha256sha256(entropyBuffer).toString("hex"),x.account=account,x.derivationStrategy=derivationStrategy,x.externalSource=source,x._expand(),x},Credentials._getNetworkFromExtendedKey=function(xKey){return $.checkArgument(xKey&&_.isString(xKey)),"t"==xKey.charAt(0)?"testnet":"livenet"},Credentials.prototype._hashFromEntropy=function(prefix,length){$.checkState(prefix);var b=new Buffer(this.entropySource,"hex"),b2=Bitcore.crypto.Hash.sha256hmac(b,new Buffer(prefix));return b2.slice(0,length)},Credentials.prototype._expand=function(){$.checkState(this.xPrivKey||this.xPubKey&&this.entropySource);var network=Credentials._getNetworkFromExtendedKey(this.xPrivKey||this.xPubKey);if(this.network?$.checkState(this.network==network):this.network=network,this.xPrivKey){console.log("_expand path: "+this.getBaseAddressDerivationPath());var xPrivKey=new Bitcore.HDPrivateKey.fromString(this.xPrivKey),addressDerivation=xPrivKey.derive(this.getBaseAddressDerivationPath());this.xPubKey=new Bitcore.HDPublicKey(addressDerivation).toString(),console.log("_expand xPubKey: "+this.xPubKey)}this.publicKeyRing=[{xPubKey:this.xPubKey}]},Credentials.fromObj=function(obj){var x=new Credentials;return _.each(FIELDS,function(k){x[k]=obj[k]}),x.derivationStrategy=x.derivationStrategy||Constants.DERIVATION_STRATEGIES.BIP44,x.account=x.account||0,$.checkState(x.xPrivKey||x.xPubKey||x.xPrivKeyEncrypted,"invalid input"),x},Credentials.prototype.toObj=function(){var self=this;self.hasPrivKeyEncrypted()&&self.lock();var x={};return _.each(FIELDS,function(k){"xPrivKey"!==k&&"mnemonic"!==k&&"xPrivKeyEncrypted"!==k&&"mnemonicEncrypted"!==k&&(x[k]=self[k])}),x},Credentials.prototype.getBaseAddressDerivationPath=function(){var purpose;switch(this.derivationStrategy){case Constants.DERIVATION_STRATEGIES.BIP44:purpose="44";break;case Constants.DERIVATION_STRATEGIES.BIP48:purpose="48"}var coin="livenet"==this.network?"0":"1";return"m/"+purpose+"'/"+coin+"'/"+this.account+"'"},Credentials.prototype.getDerivedXPrivKey=function(){var path=this.getBaseAddressDerivationPath();return new Bitcore.HDPrivateKey(this.xPrivKey,this.network).derive(path)},Credentials.prototype.addWalletInfo=function(walletName,m,n){this.walletName=walletName,this.m=m,this.n=n,!this.xPrivKey&&this.externalSource&&n>1&&(this.derivationStrategy=Constants.DERIVATION_STRATEGIES.BIP48),1==n&&this.addPublicKeyRing([{xPubKey:this.xPubKey}])},Credentials.prototype.hasWalletInfo=function(){return!!this.n},Credentials.prototype.isPrivKeyEncrypted=function(){return!!this.xPrivKeyEncrypted&&!this.xPrivKey},Credentials.prototype.hasPrivKeyEncrypted=function(){return!!this.xPrivKeyEncrypted},Credentials.prototype.setPrivateKeyEncryption=function(password,opts){if(this.xPrivKeyEncrypted)throw new Error("Encrypted Privkey Already exists");if(!this.xPrivKey)throw new Error("No private key to encrypt");if(this.xPrivKeyEncrypted=sjcl.encrypt(password,this.xPrivKey,opts),!this.xPrivKeyEncrypted)throw new Error("Could not encrypt");this.mnemonic&&(this.mnemonicEncrypted=sjcl.encrypt(password,this.mnemonic,opts))},Credentials.prototype.disablePrivateKeyEncryption=function(){if(!this.xPrivKeyEncrypted)throw new Error("Private Key is not encrypted");if(!this.xPrivKey)throw new Error("Wallet is locked, cannot disable encryption");this.xPrivKeyEncrypted=null,this.mnemonicEncrypted=null},Credentials.prototype.lock=function(){if(!this.xPrivKeyEncrypted)throw new Error("Could not lock, no encrypted private key");delete this.xPrivKey,delete this.mnemonic},Credentials.prototype.unlock=function(password){$.checkArgument(password),this.xPrivKeyEncrypted&&(this.xPrivKey=sjcl.decrypt(password,this.xPrivKeyEncrypted),this.mnemonicEncrypted&&(this.mnemonic=sjcl.decrypt(password,this.mnemonicEncrypted)))},Credentials.prototype.addPublicKeyRing=function(publicKeyRing){this.publicKeyRing=_.clone(publicKeyRing)},Credentials.prototype.canSign=function(){return!!this.xPrivKey||!!this.xPrivKeyEncrypted},Credentials.prototype.setNoSign=function(){delete this.xPrivKey,delete this.xPrivKeyEncrypted,delete this.mnemonic,delete this.mnemonicEncrypted},Credentials.prototype.isComplete=function(){return!(!this.m||!this.n)&&!(!this.publicKeyRing||this.publicKeyRing.length!=this.n)},Credentials.prototype.hasExternalSource=function(){return"string"==typeof this.externalSource},Credentials.prototype.getExternalSourceName=function(){return this.externalSource},Credentials.prototype.getMnemonic=function(){if(this.mnemonicEncrypted&&!this.mnemonic)throw new Error("Credentials are encrypted");return this.mnemonic},Credentials.prototype.clearMnemonic=function(){delete this.mnemonic,delete this.mnemonicEncrypted},module.exports=Credentials}).call(this,require("buffer").Buffer)},{"./common":4,"bitcore-lib":34,"bitcore-mnemonic":107,buffer:151,crypto:181,lodash:271,preconditions:303,sjcl:344}],7:[function(require,module,exports){"use strict";function ClientError(code,message){this.code=code,this.message=message}ClientError.prototype.toString=function(){return"<ClientError:"+this.code+" "+this.message+">"},module.exports=ClientError},{}],8:[function(require,module,exports){"use strict";var _=require("lodash"),ClientError=require("./clienterror"),errors={INVALID_BACKUP:"Invalid Backup",WALLET_DOES_NOT_EXIST:"Wallet does not exist. Need to recreate",MISSING_PRIVATE_KEY:"Missing private keys to sign",ENCRYPTED_PRIVATE_KEY:"Private key is encrypted, cannot sign",SERVER_COMPROMISED:"Server response could not be verified",COULD_NOT_BUILD_TRANSACTION:"Could not build transaction",INSUFFICIENT_FUNDS:"Insufficient funds"},errorObjects=_.zipObject(_.map(errors,function(msg,code){return[code,new ClientError(code,msg)]}));errorObjects.codes=_.mapValues(errors,function(v,k){return k}),module.exports=errorObjects},{"./clienterror":7,lodash:271}],9:[function(require,module,exports){var client=module.exports=require("./api");client.Utils=require("./common/utils"),client.sjcl=require("sjcl"),client.Bitcore=require("bitcore-lib")},{"./api":2,"./common/utils":5,"bitcore-lib":34,sjcl:344}],10:[function(require,module,exports){var _=require("lodash"),Logger=function(name){this.name=name||"log",this.level=2};Logger.prototype.getLevels=function(){return levels};var levels={debug:0,info:1,log:2,warn:3,error:4,fatal:5};_.each(levels,function(level,levelName){Logger.prototype[levelName]=function(){if(level>=levels[this.level]){if(Error.stackTraceLimit&&"debug"==this.level){var old=Error.stackTraceLimit;Error.stackTraceLimit=2;var stack;try{anerror()}catch(e){stack=e.stack}var lines=stack.split("\n"),caller=lines[2];caller=":"+caller.substr(6),Error.stackTraceLimit=old}var extraArgs,str="["+levelName+(caller||"")+"] "+arguments[0],extraArgs=[].slice.call(arguments,1);console[levelName]?(extraArgs.unshift(str),console[levelName].apply(console,extraArgs)):(extraArgs.length&&(str+=JSON.stringify(extraArgs)),console.log(str))}}}),Logger.prototype.setLevel=function(level){this.level=level};var logger=new Logger("trustnote");new Error;logger.setLevel("info"),module.exports=logger},{lodash:271}],11:[function(require,module,exports){var asn1=exports;asn1.bignum=require("bn.js"),asn1.define=require("./asn1/api").define,asn1.base=require("./asn1/base"),asn1.constants=require("./asn1/constants"),asn1.decoders=require("./asn1/decoders"),asn1.encoders=require("./asn1/encoders")},{"./asn1/api":12,"./asn1/base":14,"./asn1/constants":18,"./asn1/decoders":20,"./asn1/encoders":23,"bn.js":117}],12:[function(require,module,exports){function Entity(name,body){this.name=name,this.body=body,this.decoders={},this.encoders={}}var asn1=require("../asn1"),inherits=require("inherits"),api=exports;api.define=function(name,body){return new Entity(name,body)},Entity.prototype._createNamed=function(base){var named;try{named=require("vm").runInThisContext("(function "+this.name+"(entity) {\n  this._initNamed(entity);\n})")}catch(e){named=function(entity){this._initNamed(entity)}}return inherits(named,base),named.prototype._initNamed=function(entity){base.call(this,entity)},new named(this)},Entity.prototype._getDecoder=function(enc){return enc=enc||"der",this.decoders.hasOwnProperty(enc)||(this.decoders[enc]=this._createNamed(asn1.decoders[enc])),this.decoders[enc]},Entity.prototype.decode=function(data,enc,options){return this._getDecoder(enc).decode(data,options)},Entity.prototype._getEncoder=function(enc){return enc=enc||"der",this.encoders.hasOwnProperty(enc)||(this.encoders[enc]=this._createNamed(asn1.encoders[enc])),this.encoders[enc]},Entity.prototype.encode=function(data,enc,reporter){return this._getEncoder(enc).encode(data,reporter)}},{"../asn1":11,inherits:233,vm:419}],13:[function(require,module,exports){function DecoderBuffer(base,options){return Reporter.call(this,options),Buffer.isBuffer(base)?(this.base=base,this.offset=0,void(this.length=base.length)):void this.error("Input not Buffer")}function EncoderBuffer(value,reporter){if(Array.isArray(value))this.length=0,this.value=value.map(function(item){return item instanceof EncoderBuffer||(item=new EncoderBuffer(item,reporter)),this.length+=item.length,item},this);else if("number"==typeof value){if(!(0<=value&&value<=255))return reporter.error("non-byte EncoderBuffer value");this.value=value,this.length=1}else if("string"==typeof value)this.value=value,this.length=Buffer.byteLength(value);else{if(!Buffer.isBuffer(value))return reporter.error("Unsupported type: "+typeof value);this.value=value,this.length=value.length}}var inherits=require("inherits"),Reporter=require("../base").Reporter,Buffer=require("buffer").Buffer;inherits(DecoderBuffer,Reporter),exports.DecoderBuffer=DecoderBuffer,DecoderBuffer.prototype.save=function(){return{offset:this.offset,reporter:Reporter.prototype.save.call(this)}},DecoderBuffer.prototype.restore=function(save){var res=new DecoderBuffer(this.base);return res.offset=save.offset,res.length=this.offset,this.offset=save.offset,Reporter.prototype.restore.call(this,save.reporter),res},DecoderBuffer.prototype.isEmpty=function(){return this.offset===this.length},DecoderBuffer.prototype.readUInt8=function(fail){return this.offset+1<=this.length?this.base.readUInt8(this.offset++,!0):this.error(fail||"DecoderBuffer overrun")},DecoderBuffer.prototype.skip=function(bytes,fail){if(!(this.offset+bytes<=this.length))return this.error(fail||"DecoderBuffer overrun");var res=new DecoderBuffer(this.base);return res._reporterState=this._reporterState,res.offset=this.offset,res.length=this.offset+bytes,this.offset+=bytes,res},DecoderBuffer.prototype.raw=function(save){return this.base.slice(save?save.offset:this.offset,this.length)},exports.EncoderBuffer=EncoderBuffer,EncoderBuffer.prototype.join=function(out,offset){return out||(out=new Buffer(this.length)),offset||(offset=0),0===this.length?out:(Array.isArray(this.value)?this.value.forEach(function(item){item.join(out,offset),offset+=item.length}):("number"==typeof this.value?out[offset]=this.value:"string"==typeof this.value?out.write(this.value,offset):Buffer.isBuffer(this.value)&&this.value.copy(out,offset),offset+=this.length),out)}},{"../base":14,buffer:151,inherits:233}],14:[function(require,module,exports){var base=exports;base.Reporter=require("./reporter").Reporter,base.DecoderBuffer=require("./buffer").DecoderBuffer,base.EncoderBuffer=require("./buffer").EncoderBuffer,base.Node=require("./node")},{"./buffer":13,"./node":15,"./reporter":16}],15:[function(require,module,exports){function Node(enc,parent){var state={};this._baseState=state,state.enc=enc,state.parent=parent||null,state.children=null,state.tag=null,state.args=null,state.reverseArgs=null,state.choice=null,state.optional=!1,state.any=!1,state.obj=!1,state.use=null,state.useDecoder=null,state.key=null,state["default"]=null,state.explicit=null,state.implicit=null,state.contains=null,state.parent||(state.children=[],this._wrap())}var Reporter=require("../base").Reporter,EncoderBuffer=require("../base").EncoderBuffer,DecoderBuffer=require("../base").DecoderBuffer,assert=require("minimalistic-assert"),tags=["seq","seqof","set","setof","objid","bool","gentime","utctime","null_","enum","int","objDesc","bitstr","bmpstr","charstr","genstr","graphstr","ia5str","iso646str","numstr","octstr","printstr","t61str","unistr","utf8str","videostr"],methods=["key","obj","use","optional","explicit","implicit","def","choice","any","contains"].concat(tags),overrided=["_peekTag","_decodeTag","_use","_decodeStr","_decodeObjid","_decodeTime","_decodeNull","_decodeInt","_decodeBool","_decodeList","_encodeComposite","_encodeStr","_encodeObjid","_encodeTime","_encodeNull","_encodeInt","_encodeBool"];module.exports=Node;var stateProps=["enc","parent","children","tag","args","reverseArgs","choice","optional","any","obj","use","alteredUse","key","default","explicit","implicit","contains"];Node.prototype.clone=function(){var state=this._baseState,cstate={};stateProps.forEach(function(prop){cstate[prop]=state[prop]});var res=new this.constructor(cstate.parent);return res._baseState=cstate,res},Node.prototype._wrap=function(){var state=this._baseState;methods.forEach(function(method){this[method]=function(){var clone=new this.constructor(this);return state.children.push(clone),clone[method].apply(clone,arguments)}},this)},Node.prototype._init=function(body){var state=this._baseState;assert(null===state.parent),body.call(this),state.children=state.children.filter(function(child){return child._baseState.parent===this},this),assert.equal(state.children.length,1,"Root node can have only one child")},Node.prototype._useArgs=function(args){var state=this._baseState,children=args.filter(function(arg){return arg instanceof this.constructor},this);args=args.filter(function(arg){return!(arg instanceof this.constructor)},this),0!==children.length&&(assert(null===state.children),state.children=children,children.forEach(function(child){child._baseState.parent=this},this)),0!==args.length&&(assert(null===state.args),state.args=args,state.reverseArgs=args.map(function(arg){if("object"!=typeof arg||arg.constructor!==Object)return arg;var res={};return Object.keys(arg).forEach(function(key){key==(0|key)&&(key|=0);var value=arg[key];res[value]=key}),res}))},overrided.forEach(function(method){Node.prototype[method]=function(){
var state=this._baseState;throw new Error(method+" not implemented for encoding: "+state.enc)}}),tags.forEach(function(tag){Node.prototype[tag]=function(){var state=this._baseState,args=Array.prototype.slice.call(arguments);return assert(null===state.tag),state.tag=tag,this._useArgs(args),this}}),Node.prototype.use=function(item){assert(item);var state=this._baseState;return assert(null===state.use),state.use=item,this},Node.prototype.optional=function(){var state=this._baseState;return state.optional=!0,this},Node.prototype.def=function(val){var state=this._baseState;return assert(null===state["default"]),state["default"]=val,state.optional=!0,this},Node.prototype.explicit=function(num){var state=this._baseState;return assert(null===state.explicit&&null===state.implicit),state.explicit=num,this},Node.prototype.implicit=function(num){var state=this._baseState;return assert(null===state.explicit&&null===state.implicit),state.implicit=num,this},Node.prototype.obj=function(){var state=this._baseState,args=Array.prototype.slice.call(arguments);return state.obj=!0,0!==args.length&&this._useArgs(args),this},Node.prototype.key=function(newKey){var state=this._baseState;return assert(null===state.key),state.key=newKey,this},Node.prototype.any=function(){var state=this._baseState;return state.any=!0,this},Node.prototype.choice=function(obj){var state=this._baseState;return assert(null===state.choice),state.choice=obj,this._useArgs(Object.keys(obj).map(function(key){return obj[key]})),this},Node.prototype.contains=function(item){var state=this._baseState;return assert(null===state.use),state.contains=item,this},Node.prototype._decode=function(input,options){var state=this._baseState;if(null===state.parent)return input.wrapResult(state.children[0]._decode(input,options));var result=state["default"],present=!0,prevKey=null;if(null!==state.key&&(prevKey=input.enterKey(state.key)),state.optional){var tag=null;if(null!==state.explicit?tag=state.explicit:null!==state.implicit?tag=state.implicit:null!==state.tag&&(tag=state.tag),null!==tag||state.any){if(present=this._peekTag(input,tag,state.any),input.isError(present))return present}else{var save=input.save();try{null===state.choice?this._decodeGeneric(state.tag,input,options):this._decodeChoice(input,options),present=!0}catch(e){present=!1}input.restore(save)}}var prevObj;if(state.obj&&present&&(prevObj=input.enterObject()),present){if(null!==state.explicit){var explicit=this._decodeTag(input,state.explicit);if(input.isError(explicit))return explicit;input=explicit}var start=input.offset;if(null===state.use&&null===state.choice){if(state.any)var save=input.save();var body=this._decodeTag(input,null!==state.implicit?state.implicit:state.tag,state.any);if(input.isError(body))return body;state.any?result=input.raw(save):input=body}if(options&&options.track&&null!==state.tag&&options.track(input.path(),start,input.length,"tagged"),options&&options.track&&null!==state.tag&&options.track(input.path(),input.offset,input.length,"content"),result=state.any?result:null===state.choice?this._decodeGeneric(state.tag,input,options):this._decodeChoice(input,options),input.isError(result))return result;if(state.any||null!==state.choice||null===state.children||state.children.forEach(function(child){child._decode(input,options)}),state.contains&&("octstr"===state.tag||"bitstr"===state.tag)){var data=new DecoderBuffer(result);result=this._getUse(state.contains,input._reporterState.obj)._decode(data,options)}}return state.obj&&present&&(result=input.leaveObject(prevObj)),null===state.key||null===result&&present!==!0?null!==prevKey&&input.exitKey(prevKey):input.leaveKey(prevKey,state.key,result),result},Node.prototype._decodeGeneric=function(tag,input,options){var state=this._baseState;return"seq"===tag||"set"===tag?null:"seqof"===tag||"setof"===tag?this._decodeList(input,tag,state.args[0],options):/str$/.test(tag)?this._decodeStr(input,tag,options):"objid"===tag&&state.args?this._decodeObjid(input,state.args[0],state.args[1],options):"objid"===tag?this._decodeObjid(input,null,null,options):"gentime"===tag||"utctime"===tag?this._decodeTime(input,tag,options):"null_"===tag?this._decodeNull(input,options):"bool"===tag?this._decodeBool(input,options):"objDesc"===tag?this._decodeStr(input,tag,options):"int"===tag||"enum"===tag?this._decodeInt(input,state.args&&state.args[0],options):null!==state.use?this._getUse(state.use,input._reporterState.obj)._decode(input,options):input.error("unknown tag: "+tag)},Node.prototype._getUse=function(entity,obj){var state=this._baseState;return state.useDecoder=this._use(entity,obj),assert(null===state.useDecoder._baseState.parent),state.useDecoder=state.useDecoder._baseState.children[0],state.implicit!==state.useDecoder._baseState.implicit&&(state.useDecoder=state.useDecoder.clone(),state.useDecoder._baseState.implicit=state.implicit),state.useDecoder},Node.prototype._decodeChoice=function(input,options){var state=this._baseState,result=null,match=!1;return Object.keys(state.choice).some(function(key){var save=input.save(),node=state.choice[key];try{var value=node._decode(input,options);if(input.isError(value))return!1;result={type:key,value:value},match=!0}catch(e){return input.restore(save),!1}return!0},this),match?result:input.error("Choice not matched")},Node.prototype._createEncoderBuffer=function(data){return new EncoderBuffer(data,this.reporter)},Node.prototype._encode=function(data,reporter,parent){var state=this._baseState;if(null===state["default"]||state["default"]!==data){var result=this._encodeValue(data,reporter,parent);if(void 0!==result&&!this._skipDefault(result,reporter,parent))return result}},Node.prototype._encodeValue=function(data,reporter,parent){var state=this._baseState;if(null===state.parent)return state.children[0]._encode(data,reporter||new Reporter);var result=null;if(this.reporter=reporter,state.optional&&void 0===data){if(null===state["default"])return;data=state["default"]}var content=null,primitive=!1;if(state.any)result=this._createEncoderBuffer(data);else if(state.choice)result=this._encodeChoice(data,reporter);else if(state.contains)content=this._getUse(state.contains,parent)._encode(data,reporter),primitive=!0;else if(state.children)content=state.children.map(function(child){if("null_"===child._baseState.tag)return child._encode(null,reporter,data);if(null===child._baseState.key)return reporter.error("Child should have a key");var prevKey=reporter.enterKey(child._baseState.key);if("object"!=typeof data)return reporter.error("Child expected, but input is not object");var res=child._encode(data[child._baseState.key],reporter,data);return reporter.leaveKey(prevKey),res},this).filter(function(child){return child}),content=this._createEncoderBuffer(content);else if("seqof"===state.tag||"setof"===state.tag){if(!state.args||1!==state.args.length)return reporter.error("Too many args for : "+state.tag);if(!Array.isArray(data))return reporter.error("seqof/setof, but data is not Array");var child=this.clone();child._baseState.implicit=null,content=this._createEncoderBuffer(data.map(function(item){var state=this._baseState;return this._getUse(state.args[0],data)._encode(item,reporter)},child))}else null!==state.use?result=this._getUse(state.use,parent)._encode(data,reporter):(content=this._encodePrimitive(state.tag,data),primitive=!0);var result;if(!state.any&&null===state.choice){var tag=null!==state.implicit?state.implicit:state.tag,cls=null===state.implicit?"universal":"context";null===tag?null===state.use&&reporter.error("Tag could be omitted only for .use()"):null===state.use&&(result=this._encodeComposite(tag,primitive,cls,content))}return null!==state.explicit&&(result=this._encodeComposite(state.explicit,!1,"context",result)),result},Node.prototype._encodeChoice=function(data,reporter){var state=this._baseState,node=state.choice[data.type];return node||assert(!1,data.type+" not found in "+JSON.stringify(Object.keys(state.choice))),node._encode(data.value,reporter)},Node.prototype._encodePrimitive=function(tag,data){var state=this._baseState;if(/str$/.test(tag))return this._encodeStr(data,tag);if("objid"===tag&&state.args)return this._encodeObjid(data,state.reverseArgs[0],state.args[1]);if("objid"===tag)return this._encodeObjid(data,null,null);if("gentime"===tag||"utctime"===tag)return this._encodeTime(data,tag);if("null_"===tag)return this._encodeNull();if("int"===tag||"enum"===tag)return this._encodeInt(data,state.args&&state.reverseArgs[0]);if("bool"===tag)return this._encodeBool(data);if("objDesc"===tag)return this._encodeStr(data,tag);throw new Error("Unsupported tag: "+tag)},Node.prototype._isNumstr=function(str){return/^[0-9 ]*$/.test(str)},Node.prototype._isPrintstr=function(str){return/^[A-Za-z0-9 '\(\)\+,\-\.\/:=\?]*$/.test(str)}},{"../base":14,"minimalistic-assert":274}],16:[function(require,module,exports){function Reporter(options){this._reporterState={obj:null,path:[],options:options||{},errors:[]}}function ReporterError(path,msg){this.path=path,this.rethrow(msg)}var inherits=require("inherits");exports.Reporter=Reporter,Reporter.prototype.isError=function(obj){return obj instanceof ReporterError},Reporter.prototype.save=function(){var state=this._reporterState;return{obj:state.obj,pathLen:state.path.length}},Reporter.prototype.restore=function(data){var state=this._reporterState;state.obj=data.obj,state.path=state.path.slice(0,data.pathLen)},Reporter.prototype.enterKey=function(key){return this._reporterState.path.push(key)},Reporter.prototype.exitKey=function(index){var state=this._reporterState;state.path=state.path.slice(0,index-1)},Reporter.prototype.leaveKey=function(index,key,value){var state=this._reporterState;this.exitKey(index),null!==state.obj&&(state.obj[key]=value)},Reporter.prototype.path=function(){return this._reporterState.path.join("/")},Reporter.prototype.enterObject=function(){var state=this._reporterState,prev=state.obj;return state.obj={},prev},Reporter.prototype.leaveObject=function(prev){var state=this._reporterState,now=state.obj;return state.obj=prev,now},Reporter.prototype.error=function(msg){var err,state=this._reporterState,inherited=msg instanceof ReporterError;if(err=inherited?msg:new ReporterError(state.path.map(function(elem){return"["+JSON.stringify(elem)+"]"}).join(""),msg.message||msg,msg.stack),!state.options.partial)throw err;return inherited||state.errors.push(err),err},Reporter.prototype.wrapResult=function(result){var state=this._reporterState;return state.options.partial?{result:this.isError(result)?null:result,errors:state.errors}:result},inherits(ReporterError,Error),ReporterError.prototype.rethrow=function(msg){if(this.message=msg+" at: "+(this.path||"(shallow)"),Error.captureStackTrace&&Error.captureStackTrace(this,ReporterError),!this.stack)try{throw new Error(this.message)}catch(e){this.stack=e.stack}return this}},{inherits:233}],17:[function(require,module,exports){var constants=require("../constants");exports.tagClass={0:"universal",1:"application",2:"context",3:"private"},exports.tagClassByName=constants._reverse(exports.tagClass),exports.tag={0:"end",1:"bool",2:"int",3:"bitstr",4:"octstr",5:"null_",6:"objid",7:"objDesc",8:"external",9:"real",10:"enum",11:"embed",12:"utf8str",13:"relativeOid",16:"seq",17:"set",18:"numstr",19:"printstr",20:"t61str",21:"videostr",22:"ia5str",23:"utctime",24:"gentime",25:"graphstr",26:"iso646str",27:"genstr",28:"unistr",29:"charstr",30:"bmpstr"},exports.tagByName=constants._reverse(exports.tag)},{"../constants":18}],18:[function(require,module,exports){var constants=exports;constants._reverse=function(map){var res={};return Object.keys(map).forEach(function(key){(0|key)==key&&(key=0|key);var value=map[key];res[value]=key}),res},constants.der=require("./der")},{"./der":17}],19:[function(require,module,exports){function DERDecoder(entity){this.enc="der",this.name=entity.name,this.entity=entity,this.tree=new DERNode,this.tree._init(entity.body)}function DERNode(parent){base.Node.call(this,"der",parent)}function derDecodeTag(buf,fail){var tag=buf.readUInt8(fail);if(buf.isError(tag))return tag;var cls=der.tagClass[tag>>6],primitive=0===(32&tag);if(31===(31&tag)){var oct=tag;for(tag=0;128===(128&oct);){if(oct=buf.readUInt8(fail),buf.isError(oct))return oct;tag<<=7,tag|=127&oct}}else tag&=31;var tagStr=der.tag[tag];return{cls:cls,primitive:primitive,tag:tag,tagStr:tagStr}}function derDecodeLen(buf,primitive,fail){var len=buf.readUInt8(fail);if(buf.isError(len))return len;if(!primitive&&128===len)return null;if(0===(128&len))return len;var num=127&len;if(num>4)return buf.error("length octect is too long");len=0;for(var i=0;i<num;i++){len<<=8;var j=buf.readUInt8(fail);if(buf.isError(j))return j;len|=j}return len}var inherits=require("inherits"),asn1=require("../../asn1"),base=asn1.base,bignum=asn1.bignum,der=asn1.constants.der;module.exports=DERDecoder,DERDecoder.prototype.decode=function(data,options){return data instanceof base.DecoderBuffer||(data=new base.DecoderBuffer(data,options)),this.tree._decode(data,options)},inherits(DERNode,base.Node),DERNode.prototype._peekTag=function(buffer,tag,any){if(buffer.isEmpty())return!1;var state=buffer.save(),decodedTag=derDecodeTag(buffer,'Failed to peek tag: "'+tag+'"');return buffer.isError(decodedTag)?decodedTag:(buffer.restore(state),decodedTag.tag===tag||decodedTag.tagStr===tag||decodedTag.tagStr+"of"===tag||any)},DERNode.prototype._decodeTag=function(buffer,tag,any){var decodedTag=derDecodeTag(buffer,'Failed to decode tag of "'+tag+'"');if(buffer.isError(decodedTag))return decodedTag;var len=derDecodeLen(buffer,decodedTag.primitive,'Failed to get length of "'+tag+'"');if(buffer.isError(len))return len;if(!any&&decodedTag.tag!==tag&&decodedTag.tagStr!==tag&&decodedTag.tagStr+"of"!==tag)return buffer.error('Failed to match tag: "'+tag+'"');if(decodedTag.primitive||null!==len)return buffer.skip(len,'Failed to match body of: "'+tag+'"');var state=buffer.save(),res=this._skipUntilEnd(buffer,'Failed to skip indefinite length body: "'+this.tag+'"');return buffer.isError(res)?res:(len=buffer.offset-state.offset,buffer.restore(state),buffer.skip(len,'Failed to match body of: "'+tag+'"'))},DERNode.prototype._skipUntilEnd=function(buffer,fail){for(;;){var tag=derDecodeTag(buffer,fail);if(buffer.isError(tag))return tag;var len=derDecodeLen(buffer,tag.primitive,fail);if(buffer.isError(len))return len;var res;if(res=tag.primitive||null!==len?buffer.skip(len):this._skipUntilEnd(buffer,fail),buffer.isError(res))return res;if("end"===tag.tagStr)break}},DERNode.prototype._decodeList=function(buffer,tag,decoder,options){for(var result=[];!buffer.isEmpty();){var possibleEnd=this._peekTag(buffer,"end");if(buffer.isError(possibleEnd))return possibleEnd;var res=decoder.decode(buffer,"der",options);if(buffer.isError(res)&&possibleEnd)break;result.push(res)}return result},DERNode.prototype._decodeStr=function(buffer,tag){if("bitstr"===tag){var unused=buffer.readUInt8();return buffer.isError(unused)?unused:{unused:unused,data:buffer.raw()}}if("bmpstr"===tag){var raw=buffer.raw();if(raw.length%2===1)return buffer.error("Decoding of string type: bmpstr length mismatch");for(var str="",i=0;i<raw.length/2;i++)str+=String.fromCharCode(raw.readUInt16BE(2*i));return str}if("numstr"===tag){var numstr=buffer.raw().toString("ascii");return this._isNumstr(numstr)?numstr:buffer.error("Decoding of string type: numstr unsupported characters")}if("octstr"===tag)return buffer.raw();if("objDesc"===tag)return buffer.raw();if("printstr"===tag){var printstr=buffer.raw().toString("ascii");return this._isPrintstr(printstr)?printstr:buffer.error("Decoding of string type: printstr unsupported characters")}return/str$/.test(tag)?buffer.raw().toString():buffer.error("Decoding of string type: "+tag+" unsupported")},DERNode.prototype._decodeObjid=function(buffer,values,relative){for(var result,identifiers=[],ident=0;!buffer.isEmpty();){var subident=buffer.readUInt8();ident<<=7,ident|=127&subident,0===(128&subident)&&(identifiers.push(ident),ident=0)}128&subident&&identifiers.push(ident);var first=identifiers[0]/40|0,second=identifiers[0]%40;if(result=relative?identifiers:[first,second].concat(identifiers.slice(1)),values){var tmp=values[result.join(" ")];void 0===tmp&&(tmp=values[result.join(".")]),void 0!==tmp&&(result=tmp)}return result},DERNode.prototype._decodeTime=function(buffer,tag){var str=buffer.raw().toString();if("gentime"===tag)var year=0|str.slice(0,4),mon=0|str.slice(4,6),day=0|str.slice(6,8),hour=0|str.slice(8,10),min=0|str.slice(10,12),sec=0|str.slice(12,14);else{if("utctime"!==tag)return buffer.error("Decoding "+tag+" time is not supported yet");var year=0|str.slice(0,2),mon=0|str.slice(2,4),day=0|str.slice(4,6),hour=0|str.slice(6,8),min=0|str.slice(8,10),sec=0|str.slice(10,12);year=year<70?2e3+year:1900+year}return Date.UTC(year,mon-1,day,hour,min,sec,0)},DERNode.prototype._decodeNull=function(buffer){return null},DERNode.prototype._decodeBool=function(buffer){var res=buffer.readUInt8();return buffer.isError(res)?res:0!==res},DERNode.prototype._decodeInt=function(buffer,values){var raw=buffer.raw(),res=new bignum(raw);return values&&(res=values[res.toString(10)]||res),res},DERNode.prototype._use=function(entity,obj){return"function"==typeof entity&&(entity=entity(obj)),entity._getDecoder("der").tree}},{"../../asn1":11,inherits:233}],20:[function(require,module,exports){var decoders=exports;decoders.der=require("./der"),decoders.pem=require("./pem")},{"./der":19,"./pem":21}],21:[function(require,module,exports){function PEMDecoder(entity){DERDecoder.call(this,entity),this.enc="pem"}var inherits=require("inherits"),Buffer=require("buffer").Buffer,DERDecoder=require("./der");inherits(PEMDecoder,DERDecoder),module.exports=PEMDecoder,PEMDecoder.prototype.decode=function(data,options){for(var lines=data.toString().split(/[\r\n]+/g),label=options.label.toUpperCase(),re=/^-----(BEGIN|END) ([^-]+)-----$/,start=-1,end=-1,i=0;i<lines.length;i++){var match=lines[i].match(re);if(null!==match&&match[2]===label){if(start!==-1){if("END"!==match[1])break;end=i;break}if("BEGIN"!==match[1])break;start=i}}if(start===-1||end===-1)throw new Error("PEM section not found for: "+label);var base64=lines.slice(start+1,end).join("");base64.replace(/[^a-z0-9\+\/=]+/gi,"");var input=new Buffer(base64,"base64");return DERDecoder.prototype.decode.call(this,input,options)}},{"./der":19,buffer:151,inherits:233}],22:[function(require,module,exports){function DEREncoder(entity){this.enc="der",this.name=entity.name,this.entity=entity,this.tree=new DERNode,this.tree._init(entity.body)}function DERNode(parent){base.Node.call(this,"der",parent)}function two(num){return num<10?"0"+num:num}function encodeTag(tag,primitive,cls,reporter){var res;if("seqof"===tag?tag="seq":"setof"===tag&&(tag="set"),der.tagByName.hasOwnProperty(tag))res=der.tagByName[tag];else{if("number"!=typeof tag||(0|tag)!==tag)return reporter.error("Unknown tag: "+tag);res=tag}return res>=31?reporter.error("Multi-octet tag encoding unsupported"):(primitive||(res|=32),res|=der.tagClassByName[cls||"universal"]<<6)}var inherits=require("inherits"),Buffer=require("buffer").Buffer,asn1=require("../../asn1"),base=asn1.base,der=asn1.constants.der;module.exports=DEREncoder,DEREncoder.prototype.encode=function(data,reporter){return this.tree._encode(data,reporter).join()},inherits(DERNode,base.Node),DERNode.prototype._encodeComposite=function(tag,primitive,cls,content){var encodedTag=encodeTag(tag,primitive,cls,this.reporter);if(content.length<128){var header=new Buffer(2);return header[0]=encodedTag,header[1]=content.length,this._createEncoderBuffer([header,content])}for(var lenOctets=1,i=content.length;i>=256;i>>=8)lenOctets++;var header=new Buffer(2+lenOctets);header[0]=encodedTag,header[1]=128|lenOctets;for(var i=1+lenOctets,j=content.length;j>0;i--,j>>=8)header[i]=255&j;return this._createEncoderBuffer([header,content])},DERNode.prototype._encodeStr=function(str,tag){if("bitstr"===tag)return this._createEncoderBuffer([0|str.unused,str.data]);if("bmpstr"===tag){for(var buf=new Buffer(2*str.length),i=0;i<str.length;i++)buf.writeUInt16BE(str.charCodeAt(i),2*i);return this._createEncoderBuffer(buf)}return"numstr"===tag?this._isNumstr(str)?this._createEncoderBuffer(str):this.reporter.error("Encoding of string type: numstr supports only digits and space"):"printstr"===tag?this._isPrintstr(str)?this._createEncoderBuffer(str):this.reporter.error("Encoding of string type: printstr supports only latin upper and lower case letters, digits, space, apostrophe, left and rigth parenthesis, plus sign, comma, hyphen, dot, slash, colon, equal sign, question mark"):/str$/.test(tag)?this._createEncoderBuffer(str):"objDesc"===tag?this._createEncoderBuffer(str):this.reporter.error("Encoding of string type: "+tag+" unsupported")},DERNode.prototype._encodeObjid=function(id,values,relative){if("string"==typeof id){if(!values)return this.reporter.error("string objid given, but no values map found");if(!values.hasOwnProperty(id))return this.reporter.error("objid not found in values map");id=values[id].split(/[\s\.]+/g);for(var i=0;i<id.length;i++)id[i]|=0}else if(Array.isArray(id)){id=id.slice();for(var i=0;i<id.length;i++)id[i]|=0}if(!Array.isArray(id))return this.reporter.error("objid() should be either array or string, got: "+JSON.stringify(id));if(!relative){if(id[1]>=40)return this.reporter.error("Second objid identifier OOB");id.splice(0,2,40*id[0]+id[1])}for(var size=0,i=0;i<id.length;i++){var ident=id[i];for(size++;ident>=128;ident>>=7)size++}for(var objid=new Buffer(size),offset=objid.length-1,i=id.length-1;i>=0;i--){var ident=id[i];for(objid[offset--]=127&ident;(ident>>=7)>0;)objid[offset--]=128|127&ident}return this._createEncoderBuffer(objid)},DERNode.prototype._encodeTime=function(time,tag){var str,date=new Date(time);return"gentime"===tag?str=[two(date.getFullYear()),two(date.getUTCMonth()+1),two(date.getUTCDate()),two(date.getUTCHours()),two(date.getUTCMinutes()),two(date.getUTCSeconds()),"Z"].join(""):"utctime"===tag?str=[two(date.getFullYear()%100),two(date.getUTCMonth()+1),two(date.getUTCDate()),two(date.getUTCHours()),two(date.getUTCMinutes()),two(date.getUTCSeconds()),"Z"].join(""):this.reporter.error("Encoding "+tag+" time is not supported yet"),this._encodeStr(str,"octstr")},DERNode.prototype._encodeNull=function(){return this._createEncoderBuffer("")},DERNode.prototype._encodeInt=function(num,values){if("string"==typeof num){if(!values)return this.reporter.error("String int or enum given, but no values map");if(!values.hasOwnProperty(num))return this.reporter.error("Values map doesn't contain: "+JSON.stringify(num));num=values[num]}if("number"!=typeof num&&!Buffer.isBuffer(num)){var numArray=num.toArray();!num.sign&&128&numArray[0]&&numArray.unshift(0),num=new Buffer(numArray)}if(Buffer.isBuffer(num)){var size=num.length;0===num.length&&size++;var out=new Buffer(size);return num.copy(out),0===num.length&&(out[0]=0),this._createEncoderBuffer(out)}if(num<128)return this._createEncoderBuffer(num);if(num<256)return this._createEncoderBuffer([0,num]);for(var size=1,i=num;i>=256;i>>=8)size++;for(var out=new Array(size),i=out.length-1;i>=0;i--)out[i]=255&num,num>>=8;return 128&out[0]&&out.unshift(0),this._createEncoderBuffer(new Buffer(out))},DERNode.prototype._encodeBool=function(value){return this._createEncoderBuffer(value?255:0)},DERNode.prototype._use=function(entity,obj){return"function"==typeof entity&&(entity=entity(obj)),entity._getEncoder("der").tree},DERNode.prototype._skipDefault=function(dataBuffer,reporter,parent){var i,state=this._baseState;if(null===state["default"])return!1;var data=dataBuffer.join();if(void 0===state.defaultBuffer&&(state.defaultBuffer=this._encodeValue(state["default"],reporter,parent).join()),data.length!==state.defaultBuffer.length)return!1;for(i=0;i<data.length;i++)if(data[i]!==state.defaultBuffer[i])return!1;return!0}},{"../../asn1":11,buffer:151,inherits:233}],23:[function(require,module,exports){var encoders=exports;encoders.der=require("./der"),encoders.pem=require("./pem")},{"./der":22,"./pem":24}],24:[function(require,module,exports){function PEMEncoder(entity){DEREncoder.call(this,entity),this.enc="pem"}var inherits=require("inherits"),DEREncoder=require("./der");inherits(PEMEncoder,DEREncoder),module.exports=PEMEncoder,PEMEncoder.prototype.encode=function(data,options){for(var buf=DEREncoder.prototype.encode.call(this,data),p=buf.toString("base64"),out=["-----BEGIN "+options.label+"-----"],i=0;i<p.length;i+=64)out.push(p.slice(i,i+64));return out.push("-----END "+options.label+"-----"),out.join("\n")}},{"./der":22,inherits:233}],25:[function(require,module,exports){(function(global){"use strict";function compare(a,b){if(a===b)return 0;for(var x=a.length,y=b.length,i=0,len=Math.min(x,y);i<len;++i)if(a[i]!==b[i]){x=a[i],y=b[i];break}return x<y?-1:y<x?1:0}function isBuffer(b){return global.Buffer&&"function"==typeof global.Buffer.isBuffer?global.Buffer.isBuffer(b):!(null==b||!b._isBuffer)}function pToString(obj){return Object.prototype.toString.call(obj)}function isView(arrbuf){return!isBuffer(arrbuf)&&("function"==typeof global.ArrayBuffer&&("function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(arrbuf):!!arrbuf&&(arrbuf instanceof DataView||!!(arrbuf.buffer&&arrbuf.buffer instanceof ArrayBuffer))))}function getName(func){if(util.isFunction(func)){if(functionsHaveNames)return func.name;var str=func.toString(),match=str.match(regex);return match&&match[1]}}function truncate(s,n){return"string"==typeof s?s.length<n?s:s.slice(0,n):s}function inspect(something){if(functionsHaveNames||!util.isFunction(something))return util.inspect(something);var rawname=getName(something),name=rawname?": "+rawname:"";return"[Function"+name+"]"}function getMessage(self){return truncate(inspect(self.actual),128)+" "+self.operator+" "+truncate(inspect(self.expected),128)}function fail(actual,expected,message,operator,stackStartFunction){throw new assert.AssertionError({message:message,actual:actual,expected:expected,operator:operator,stackStartFunction:stackStartFunction})}function ok(value,message){value||fail(value,!0,message,"==",assert.ok)}function _deepEqual(actual,expected,strict,memos){if(actual===expected)return!0;if(isBuffer(actual)&&isBuffer(expected))return 0===compare(actual,expected);if(util.isDate(actual)&&util.isDate(expected))return actual.getTime()===expected.getTime();if(util.isRegExp(actual)&&util.isRegExp(expected))return actual.source===expected.source&&actual.global===expected.global&&actual.multiline===expected.multiline&&actual.lastIndex===expected.lastIndex&&actual.ignoreCase===expected.ignoreCase;if(null!==actual&&"object"==typeof actual||null!==expected&&"object"==typeof expected){if(isView(actual)&&isView(expected)&&pToString(actual)===pToString(expected)&&!(actual instanceof Float32Array||actual instanceof Float64Array))return 0===compare(new Uint8Array(actual.buffer),new Uint8Array(expected.buffer));if(isBuffer(actual)!==isBuffer(expected))return!1;memos=memos||{actual:[],expected:[]};var actualIndex=memos.actual.indexOf(actual);return actualIndex!==-1&&actualIndex===memos.expected.indexOf(expected)||(memos.actual.push(actual),memos.expected.push(expected),objEquiv(actual,expected,strict,memos))}return strict?actual===expected:actual==expected}function isArguments(object){return"[object Arguments]"==Object.prototype.toString.call(object)}function objEquiv(a,b,strict,actualVisitedObjects){if(null===a||void 0===a||null===b||void 0===b)return!1;if(util.isPrimitive(a)||util.isPrimitive(b))return a===b;if(strict&&Object.getPrototypeOf(a)!==Object.getPrototypeOf(b))return!1;var aIsArgs=isArguments(a),bIsArgs=isArguments(b);if(aIsArgs&&!bIsArgs||!aIsArgs&&bIsArgs)return!1;if(aIsArgs)return a=pSlice.call(a),b=pSlice.call(b),_deepEqual(a,b,strict);var key,i,ka=objectKeys(a),kb=objectKeys(b);if(ka.length!==kb.length)return!1;for(ka.sort(),kb.sort(),i=ka.length-1;i>=0;i--)if(ka[i]!==kb[i])return!1;for(i=ka.length-1;i>=0;i--)if(key=ka[i],!_deepEqual(a[key],b[key],strict,actualVisitedObjects))return!1;return!0}function notDeepStrictEqual(actual,expected,message){_deepEqual(actual,expected,!0)&&fail(actual,expected,message,"notDeepStrictEqual",notDeepStrictEqual)}function expectedException(actual,expected){if(!actual||!expected)return!1;if("[object RegExp]"==Object.prototype.toString.call(expected))return expected.test(actual);try{if(actual instanceof expected)return!0}catch(e){}return!Error.isPrototypeOf(expected)&&expected.call({},actual)===!0}function _tryBlock(block){var error;try{block()}catch(e){error=e}return error}function _throws(shouldThrow,block,expected,message){var actual;if("function"!=typeof block)throw new TypeError('"block" argument must be a function');"string"==typeof expected&&(message=expected,expected=null),actual=_tryBlock(block),message=(expected&&expected.name?" ("+expected.name+").":".")+(message?" "+message:"."),shouldThrow&&!actual&&fail(actual,expected,"Missing expected exception"+message);var userProvidedMessage="string"==typeof message,isUnwantedException=!shouldThrow&&util.isError(actual),isUnexpectedException=!shouldThrow&&actual&&!expected;if((isUnwantedException&&userProvidedMessage&&expectedException(actual,expected)||isUnexpectedException)&&fail(actual,expected,"Got unwanted exception"+message),shouldThrow&&actual&&expected&&!expectedException(actual,expected)||!shouldThrow&&actual)throw actual}var util=require("util/"),hasOwn=Object.prototype.hasOwnProperty,pSlice=Array.prototype.slice,functionsHaveNames=function(){return"foo"===function(){}.name}(),assert=module.exports=ok,regex=/\s*function\s+([^\(\s]*)\s*/;assert.AssertionError=function(options){this.name="AssertionError",this.actual=options.actual,this.expected=options.expected,this.operator=options.operator,options.message?(this.message=options.message,this.generatedMessage=!1):(this.message=getMessage(this),this.generatedMessage=!0);var stackStartFunction=options.stackStartFunction||fail;if(Error.captureStackTrace)Error.captureStackTrace(this,stackStartFunction);else{var err=new Error;if(err.stack){var out=err.stack,fn_name=getName(stackStartFunction),idx=out.indexOf("\n"+fn_name);if(idx>=0){var next_line=out.indexOf("\n",idx+1);out=out.substring(next_line+1)}this.stack=out}}},util.inherits(assert.AssertionError,Error),assert.fail=fail,assert.ok=ok,assert.equal=function(actual,expected,message){actual!=expected&&fail(actual,expected,message,"==",assert.equal)},assert.notEqual=function(actual,expected,message){actual==expected&&fail(actual,expected,message,"!=",assert.notEqual)},assert.deepEqual=function(actual,expected,message){_deepEqual(actual,expected,!1)||fail(actual,expected,message,"deepEqual",assert.deepEqual)},assert.deepStrictEqual=function(actual,expected,message){_deepEqual(actual,expected,!0)||fail(actual,expected,message,"deepStrictEqual",assert.deepStrictEqual)},assert.notDeepEqual=function(actual,expected,message){_deepEqual(actual,expected,!1)&&fail(actual,expected,message,"notDeepEqual",assert.notDeepEqual)},assert.notDeepStrictEqual=notDeepStrictEqual,assert.strictEqual=function(actual,expected,message){actual!==expected&&fail(actual,expected,message,"===",assert.strictEqual)},assert.notStrictEqual=function(actual,expected,message){actual===expected&&fail(actual,expected,message,"!==",assert.notStrictEqual)},assert["throws"]=function(block,error,message){_throws(!0,block,error,message)},assert.doesNotThrow=function(block,error,message){_throws(!1,block,error,message)},assert.ifError=function(err){if(err)throw err};var objectKeys=Object.keys||function(obj){var keys=[];for(var key in obj)hasOwn.call(obj,key)&&keys.push(key);return keys}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"util/":418}],26:[function(require,module,exports){(function(process,global){!function(){function noop(){}function identity(v){return v}function toBool(v){return!!v}function notId(v){return!v}function only_once(fn){
return function(){if(null===fn)throw new Error("Callback was already called.");fn.apply(this,arguments),fn=null}}function _once(fn){return function(){null!==fn&&(fn.apply(this,arguments),fn=null)}}function _isArrayLike(arr){return _isArray(arr)||"number"==typeof arr.length&&arr.length>=0&&arr.length%1===0}function _arrayEach(arr,iterator){for(var index=-1,length=arr.length;++index<length;)iterator(arr[index],index,arr)}function _map(arr,iterator){for(var index=-1,length=arr.length,result=Array(length);++index<length;)result[index]=iterator(arr[index],index,arr);return result}function _range(count){return _map(Array(count),function(v,i){return i})}function _reduce(arr,iterator,memo){return _arrayEach(arr,function(x,i,a){memo=iterator(memo,x,i,a)}),memo}function _forEachOf(object,iterator){_arrayEach(_keys(object),function(key){iterator(object[key],key)})}function _indexOf(arr,item){for(var i=0;i<arr.length;i++)if(arr[i]===item)return i;return-1}function _keyIterator(coll){var len,keys,i=-1;return _isArrayLike(coll)?(len=coll.length,function(){return i++,i<len?i:null}):(keys=_keys(coll),len=keys.length,function(){return i++,i<len?keys[i]:null})}function _restParam(func,startIndex){return startIndex=null==startIndex?func.length-1:+startIndex,function(){for(var length=Math.max(arguments.length-startIndex,0),rest=Array(length),index=0;index<length;index++)rest[index]=arguments[index+startIndex];switch(startIndex){case 0:return func.call(this,rest);case 1:return func.call(this,arguments[0],rest)}}}function _withoutIndex(iterator){return function(value,index,callback){return iterator(value,callback)}}function _eachOfLimit(limit){return function(obj,iterator,callback){callback=_once(callback||noop),obj=obj||[];var nextKey=_keyIterator(obj);if(limit<=0)return callback(null);var done=!1,running=0,errored=!1;!function replenish(){if(done&&running<=0)return callback(null);for(;running<limit&&!errored;){var key=nextKey();if(null===key)return done=!0,void(running<=0&&callback(null));running+=1,iterator(obj[key],key,only_once(function(err){running-=1,err?(callback(err),errored=!0):replenish()}))}}()}}function doParallel(fn){return function(obj,iterator,callback){return fn(async.eachOf,obj,iterator,callback)}}function doParallelLimit(fn){return function(obj,limit,iterator,callback){return fn(_eachOfLimit(limit),obj,iterator,callback)}}function doSeries(fn){return function(obj,iterator,callback){return fn(async.eachOfSeries,obj,iterator,callback)}}function _asyncMap(eachfn,arr,iterator,callback){callback=_once(callback||noop),arr=arr||[];var results=_isArrayLike(arr)?[]:{};eachfn(arr,function(value,index,callback){iterator(value,function(err,v){results[index]=v,callback(err)})},function(err){callback(err,results)})}function _filter(eachfn,arr,iterator,callback){var results=[];eachfn(arr,function(x,index,callback){iterator(x,function(v){v&&results.push({index:index,value:x}),callback()})},function(){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})}function _reject(eachfn,arr,iterator,callback){_filter(eachfn,arr,function(value,cb){iterator(value,function(v){cb(!v)})},callback)}function _createTester(eachfn,check,getResult){return function(arr,limit,iterator,cb){function done(){cb&&cb(getResult(!1,void 0))}function iteratee(x,_,callback){return cb?void iterator(x,function(v){cb&&check(v)&&(cb(getResult(!0,x)),cb=iterator=!1),callback()}):callback()}arguments.length>3?eachfn(arr,limit,iteratee,done):(cb=iterator,iterator=limit,eachfn(arr,iteratee,done))}}function _findGetResult(v,x){return x}function _parallel(eachfn,tasks,callback){callback=callback||noop;var results=_isArrayLike(tasks)?[]:{};eachfn(tasks,function(task,key,callback){task(_restParam(function(err,args){args.length<=1&&(args=args[0]),results[key]=args,callback(err)}))},function(err){callback(err,results)})}function _concat(eachfn,arr,fn,callback){var result=[];eachfn(arr,function(x,index,cb){fn(x,function(err,y){result=result.concat(y||[]),cb(err)})},function(err){callback(err,result)})}function _queue(worker,concurrency,payload){function _insert(q,data,pos,callback){if(null!=callback&&"function"!=typeof callback)throw new Error("task callback must be a function");return q.started=!0,_isArray(data)||(data=[data]),0===data.length&&q.idle()?async.setImmediate(function(){q.drain()}):(_arrayEach(data,function(task){var item={data:task,callback:callback||noop};pos?q.tasks.unshift(item):q.tasks.push(item),q.tasks.length===q.concurrency&&q.saturated()}),void async.setImmediate(q.process))}function _next(q,tasks){return function(){workers-=1;var removed=!1,args=arguments;_arrayEach(tasks,function(task){_arrayEach(workersList,function(worker,index){worker!==task||removed||(workersList.splice(index,1),removed=!0)}),task.callback.apply(task,args)}),q.tasks.length+workers===0&&q.drain(),q.process()}}if(null==concurrency)concurrency=1;else if(0===concurrency)throw new Error("Concurrency must not be zero");var workers=0,workersList=[],q={tasks:[],concurrency:concurrency,payload:payload,saturated:noop,empty:noop,drain:noop,started:!1,paused:!1,push:function(data,callback){_insert(q,data,!1,callback)},kill:function(){q.drain=noop,q.tasks=[]},unshift:function(data,callback){_insert(q,data,!0,callback)},process:function(){for(;!q.paused&&workers<q.concurrency&&q.tasks.length;){var tasks=q.payload?q.tasks.splice(0,q.payload):q.tasks.splice(0,q.tasks.length),data=_map(tasks,function(task){return task.data});0===q.tasks.length&&q.empty(),workers+=1,workersList.push(tasks[0]);var cb=only_once(_next(q,tasks));worker(data,cb)}},length:function(){return q.tasks.length},running:function(){return workers},workersList:function(){return workersList},idle:function(){return q.tasks.length+workers===0},pause:function(){q.paused=!0},resume:function(){if(q.paused!==!1){q.paused=!1;for(var resumeCount=Math.min(q.concurrency,q.tasks.length),w=1;w<=resumeCount;w++)async.setImmediate(q.process)}}};return q}function _console_fn(name){return _restParam(function(fn,args){fn.apply(null,args.concat([_restParam(function(err,args){"object"==typeof console&&(err?console.error&&console.error(err):console[name]&&_arrayEach(args,function(x){console[name](x)}))})]))})}function _times(mapper){return function(count,iterator,callback){mapper(_range(count),iterator,callback)}}function _applyEach(eachfn){return _restParam(function(fns,args){var go=_restParam(function(args){var that=this,callback=args.pop();return eachfn(fns,function(fn,_,cb){fn.apply(that,args.concat([cb]))},callback)});return args.length?go.apply(this,args):go})}function ensureAsync(fn){return _restParam(function(args){var callback=args.pop();args.push(function(){var innerArgs=arguments;sync?async.setImmediate(function(){callback.apply(null,innerArgs)}):callback.apply(null,innerArgs)});var sync=!0;fn.apply(this,args),sync=!1})}var previous_async,async={},root="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||this;null!=root&&(previous_async=root.async),async.noConflict=function(){return root.async=previous_async,async};var _toString=Object.prototype.toString,_isArray=Array.isArray||function(obj){return"[object Array]"===_toString.call(obj)},_isObject=function(obj){var type=typeof obj;return"function"===type||"object"===type&&!!obj},_keys=Object.keys||function(obj){var keys=[];for(var k in obj)obj.hasOwnProperty(k)&&keys.push(k);return keys},_setImmediate="function"==typeof setImmediate&&setImmediate,_delay=_setImmediate?function(fn){_setImmediate(fn)}:function(fn){setTimeout(fn,0)};"object"==typeof process&&"function"==typeof process.nextTick?async.nextTick=process.nextTick:async.nextTick=_delay,async.setImmediate=_setImmediate?_delay:async.nextTick,async.forEach=async.each=function(arr,iterator,callback){return async.eachOf(arr,_withoutIndex(iterator),callback)},async.forEachSeries=async.eachSeries=function(arr,iterator,callback){return async.eachOfSeries(arr,_withoutIndex(iterator),callback)},async.forEachLimit=async.eachLimit=function(arr,limit,iterator,callback){return _eachOfLimit(limit)(arr,_withoutIndex(iterator),callback)},async.forEachOf=async.eachOf=function(object,iterator,callback){function done(err){completed--,err?callback(err):null===key&&completed<=0&&callback(null)}callback=_once(callback||noop),object=object||[];for(var key,iter=_keyIterator(object),completed=0;null!=(key=iter());)completed+=1,iterator(object[key],key,only_once(done));0===completed&&callback(null)},async.forEachOfSeries=async.eachOfSeries=function(obj,iterator,callback){function iterate(){var sync=!0;return null===key?callback(null):(iterator(obj[key],key,only_once(function(err){if(err)callback(err);else{if(key=nextKey(),null===key)return callback(null);sync?async.setImmediate(iterate):iterate()}})),void(sync=!1))}callback=_once(callback||noop),obj=obj||[];var nextKey=_keyIterator(obj),key=nextKey();iterate()},async.forEachOfLimit=async.eachOfLimit=function(obj,limit,iterator,callback){_eachOfLimit(limit)(obj,iterator,callback)},async.map=doParallel(_asyncMap),async.mapSeries=doSeries(_asyncMap),async.mapLimit=doParallelLimit(_asyncMap),async.inject=async.foldl=async.reduce=function(arr,memo,iterator,callback){async.eachOfSeries(arr,function(x,i,callback){iterator(memo,x,function(err,v){memo=v,callback(err)})},function(err){callback(err,memo)})},async.foldr=async.reduceRight=function(arr,memo,iterator,callback){var reversed=_map(arr,identity).reverse();async.reduce(reversed,memo,iterator,callback)},async.transform=function(arr,memo,iterator,callback){3===arguments.length&&(callback=iterator,iterator=memo,memo=_isArray(arr)?[]:{}),async.eachOf(arr,function(v,k,cb){iterator(memo,v,k,cb)},function(err){callback(err,memo)})},async.select=async.filter=doParallel(_filter),async.selectLimit=async.filterLimit=doParallelLimit(_filter),async.selectSeries=async.filterSeries=doSeries(_filter),async.reject=doParallel(_reject),async.rejectLimit=doParallelLimit(_reject),async.rejectSeries=doSeries(_reject),async.any=async.some=_createTester(async.eachOf,toBool,identity),async.someLimit=_createTester(async.eachOfLimit,toBool,identity),async.all=async.every=_createTester(async.eachOf,notId,notId),async.everyLimit=_createTester(async.eachOfLimit,notId,notId),async.detect=_createTester(async.eachOf,identity,_findGetResult),async.detectSeries=_createTester(async.eachOfSeries,identity,_findGetResult),async.detectLimit=_createTester(async.eachOfLimit,identity,_findGetResult),async.sortBy=function(arr,iterator,callback){function comparator(left,right){var a=left.criteria,b=right.criteria;return a<b?-1:a>b?1:0}async.map(arr,function(x,callback){iterator(x,function(err,criteria){err?callback(err):callback(null,{value:x,criteria:criteria})})},function(err,results){return err?callback(err):void callback(null,_map(results.sort(comparator),function(x){return x.value}))})},async.auto=function(tasks,concurrency,callback){function addListener(fn){listeners.unshift(fn)}function removeListener(fn){var idx=_indexOf(listeners,fn);idx>=0&&listeners.splice(idx,1)}function taskComplete(){remainingTasks--,_arrayEach(listeners.slice(0),function(fn){fn()})}"function"==typeof arguments[1]&&(callback=concurrency,concurrency=null),callback=_once(callback||noop);var keys=_keys(tasks),remainingTasks=keys.length;if(!remainingTasks)return callback(null);concurrency||(concurrency=remainingTasks);var results={},runningTasks=0,hasError=!1,listeners=[];addListener(function(){remainingTasks||callback(null,results)}),_arrayEach(keys,function(k){function ready(){return runningTasks<concurrency&&_reduce(requires,function(a,x){return a&&results.hasOwnProperty(x)},!0)&&!results.hasOwnProperty(k)}function listener(){ready()&&(runningTasks++,removeListener(listener),task[task.length-1](taskCallback,results))}if(!hasError){for(var dep,task=_isArray(tasks[k])?tasks[k]:[tasks[k]],taskCallback=_restParam(function(err,args){if(runningTasks--,args.length<=1&&(args=args[0]),err){var safeResults={};_forEachOf(results,function(val,rkey){safeResults[rkey]=val}),safeResults[k]=args,hasError=!0,callback(err,safeResults)}else results[k]=args,async.setImmediate(taskComplete)}),requires=task.slice(0,task.length-1),len=requires.length;len--;){if(!(dep=tasks[requires[len]]))throw new Error("Has nonexistent dependency in "+requires.join(", "));if(_isArray(dep)&&_indexOf(dep,k)>=0)throw new Error("Has cyclic dependencies")}ready()?(runningTasks++,task[task.length-1](taskCallback,results)):addListener(listener)}})},async.retry=function(times,task,callback){function parseTimes(acc,t){if("number"==typeof t)acc.times=parseInt(t,10)||DEFAULT_TIMES;else{if("object"!=typeof t)throw new Error("Unsupported argument type for 'times': "+typeof t);acc.times=parseInt(t.times,10)||DEFAULT_TIMES,acc.interval=parseInt(t.interval,10)||DEFAULT_INTERVAL}}function wrappedTask(wrappedCallback,wrappedResults){function retryAttempt(task,finalAttempt){return function(seriesCallback){task(function(err,result){seriesCallback(!err||finalAttempt,{err:err,result:result})},wrappedResults)}}function retryInterval(interval){return function(seriesCallback){setTimeout(function(){seriesCallback(null)},interval)}}for(;opts.times;){var finalAttempt=!(opts.times-=1);attempts.push(retryAttempt(opts.task,finalAttempt)),!finalAttempt&&opts.interval>0&&attempts.push(retryInterval(opts.interval))}async.series(attempts,function(done,data){data=data[data.length-1],(wrappedCallback||opts.callback)(data.err,data.result)})}var DEFAULT_TIMES=5,DEFAULT_INTERVAL=0,attempts=[],opts={times:DEFAULT_TIMES,interval:DEFAULT_INTERVAL},length=arguments.length;if(length<1||length>3)throw new Error("Invalid arguments - must be either (task), (task, callback), (times, task) or (times, task, callback)");return length<=2&&"function"==typeof times&&(callback=task,task=times),"function"!=typeof times&&parseTimes(opts,times),opts.callback=callback,opts.task=task,opts.callback?wrappedTask():wrappedTask},async.waterfall=function(tasks,callback){function wrapIterator(iterator){return _restParam(function(err,args){if(err)callback.apply(null,[err].concat(args));else{var next=iterator.next();next?args.push(wrapIterator(next)):args.push(callback),ensureAsync(iterator).apply(null,args)}})}if(callback=_once(callback||noop),!_isArray(tasks)){var err=new Error("First argument to waterfall must be an array of functions");return callback(err)}return tasks.length?void wrapIterator(async.iterator(tasks))():callback()},async.parallel=function(tasks,callback){_parallel(async.eachOf,tasks,callback)},async.parallelLimit=function(tasks,limit,callback){_parallel(_eachOfLimit(limit),tasks,callback)},async.series=function(tasks,callback){_parallel(async.eachOfSeries,tasks,callback)},async.iterator=function(tasks){function makeCallback(index){function fn(){return tasks.length&&tasks[index].apply(null,arguments),fn.next()}return fn.next=function(){return index<tasks.length-1?makeCallback(index+1):null},fn}return makeCallback(0)},async.apply=_restParam(function(fn,args){return _restParam(function(callArgs){return fn.apply(null,args.concat(callArgs))})}),async.concat=doParallel(_concat),async.concatSeries=doSeries(_concat),async.whilst=function(test,iterator,callback){if(callback=callback||noop,test()){var next=_restParam(function(err,args){err?callback(err):test.apply(this,args)?iterator(next):callback.apply(null,[null].concat(args))});iterator(next)}else callback(null)},async.doWhilst=function(iterator,test,callback){var calls=0;return async.whilst(function(){return++calls<=1||test.apply(this,arguments)},iterator,callback)},async.until=function(test,iterator,callback){return async.whilst(function(){return!test.apply(this,arguments)},iterator,callback)},async.doUntil=function(iterator,test,callback){return async.doWhilst(iterator,function(){return!test.apply(this,arguments)},callback)},async.during=function(test,iterator,callback){callback=callback||noop;var next=_restParam(function(err,args){err?callback(err):(args.push(check),test.apply(this,args))}),check=function(err,truth){err?callback(err):truth?iterator(next):callback(null)};test(check)},async.doDuring=function(iterator,test,callback){var calls=0;async.during(function(next){calls++<1?next(null,!0):test.apply(this,arguments)},iterator,callback)},async.queue=function(worker,concurrency){var q=_queue(function(items,cb){worker(items[0],cb)},concurrency,1);return q},async.priorityQueue=function(worker,concurrency){function _compareTasks(a,b){return a.priority-b.priority}function _binarySearch(sequence,item,compare){for(var beg=-1,end=sequence.length-1;beg<end;){var mid=beg+(end-beg+1>>>1);compare(item,sequence[mid])>=0?beg=mid:end=mid-1}return beg}function _insert(q,data,priority,callback){if(null!=callback&&"function"!=typeof callback)throw new Error("task callback must be a function");return q.started=!0,_isArray(data)||(data=[data]),0===data.length?async.setImmediate(function(){q.drain()}):void _arrayEach(data,function(task){var item={data:task,priority:priority,callback:"function"==typeof callback?callback:noop};q.tasks.splice(_binarySearch(q.tasks,item,_compareTasks)+1,0,item),q.tasks.length===q.concurrency&&q.saturated(),async.setImmediate(q.process)})}var q=async.queue(worker,concurrency);return q.push=function(data,priority,callback){_insert(q,data,priority,callback)},delete q.unshift,q},async.cargo=function(worker,payload){return _queue(worker,1,payload)},async.log=_console_fn("log"),async.dir=_console_fn("dir"),async.memoize=function(fn,hasher){var memo={},queues={},has=Object.prototype.hasOwnProperty;hasher=hasher||identity;var memoized=_restParam(function(args){var callback=args.pop(),key=hasher.apply(null,args);has.call(memo,key)?async.setImmediate(function(){callback.apply(null,memo[key])}):has.call(queues,key)?queues[key].push(callback):(queues[key]=[callback],fn.apply(null,args.concat([_restParam(function(args){memo[key]=args;var q=queues[key];delete queues[key];for(var i=0,l=q.length;i<l;i++)q[i].apply(null,args)})])))});return memoized.memo=memo,memoized.unmemoized=fn,memoized},async.unmemoize=function(fn){return function(){return(fn.unmemoized||fn).apply(null,arguments)}},async.times=_times(async.map),async.timesSeries=_times(async.mapSeries),async.timesLimit=function(count,limit,iterator,callback){return async.mapLimit(_range(count),limit,iterator,callback)},async.seq=function(){var fns=arguments;return _restParam(function(args){var that=this,callback=args[args.length-1];"function"==typeof callback?args.pop():callback=noop,async.reduce(fns,args,function(newargs,fn,cb){fn.apply(that,newargs.concat([_restParam(function(err,nextargs){cb(err,nextargs)})]))},function(err,results){callback.apply(that,[err].concat(results))})})},async.compose=function(){return async.seq.apply(null,Array.prototype.reverse.call(arguments))},async.applyEach=_applyEach(async.eachOf),async.applyEachSeries=_applyEach(async.eachOfSeries),async.forever=function(fn,callback){function next(err){return err?done(err):void task(next)}var done=only_once(callback||noop),task=ensureAsync(fn);next()},async.ensureAsync=ensureAsync,async.constant=_restParam(function(values){var args=[null].concat(values);return function(callback){return callback.apply(this,args)}}),async.wrapSync=async.asyncify=function(func){return _restParam(function(args){var result,callback=args.pop();try{result=func.apply(this,args)}catch(e){return callback(e)}_isObject(result)&&"function"==typeof result.then?result.then(function(value){callback(null,value)})["catch"](function(err){callback(err.message?err:new Error(err))}):callback(null,result)})},"object"==typeof module&&module.exports?module.exports=async:"function"==typeof define&&define.amd?define([],function(){return async}):root.async=async}()}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{_process:309}],27:[function(require,module,exports){"use strict";function getLens(b64){var len=b64.length;if(len%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var validLen=b64.indexOf("=");validLen===-1&&(validLen=len);var placeHoldersLen=validLen===len?0:4-validLen%4;return[validLen,placeHoldersLen]}function byteLength(b64){var lens=getLens(b64),validLen=lens[0],placeHoldersLen=lens[1];return 3*(validLen+placeHoldersLen)/4-placeHoldersLen}function _byteLength(b64,validLen,placeHoldersLen){return 3*(validLen+placeHoldersLen)/4-placeHoldersLen}function toByteArray(b64){for(var tmp,lens=getLens(b64),validLen=lens[0],placeHoldersLen=lens[1],arr=new Arr(_byteLength(b64,validLen,placeHoldersLen)),curByte=0,len=placeHoldersLen>0?validLen-4:validLen,i=0;i<len;i+=4)tmp=revLookup[b64.charCodeAt(i)]<<18|revLookup[b64.charCodeAt(i+1)]<<12|revLookup[b64.charCodeAt(i+2)]<<6|revLookup[b64.charCodeAt(i+3)],arr[curByte++]=tmp>>16&255,arr[curByte++]=tmp>>8&255,arr[curByte++]=255&tmp;return 2===placeHoldersLen&&(tmp=revLookup[b64.charCodeAt(i)]<<2|revLookup[b64.charCodeAt(i+1)]>>4,arr[curByte++]=255&tmp),1===placeHoldersLen&&(tmp=revLookup[b64.charCodeAt(i)]<<10|revLookup[b64.charCodeAt(i+1)]<<4|revLookup[b64.charCodeAt(i+2)]>>2,arr[curByte++]=tmp>>8&255,arr[curByte++]=255&tmp),arr}function tripletToBase64(num){return lookup[num>>18&63]+lookup[num>>12&63]+lookup[num>>6&63]+lookup[63&num]}function encodeChunk(uint8,start,end){for(var tmp,output=[],i=start;i<end;i+=3)tmp=(uint8[i]<<16&16711680)+(uint8[i+1]<<8&65280)+(255&uint8[i+2]),output.push(tripletToBase64(tmp));return output.join("")}function fromByteArray(uint8){for(var tmp,len=uint8.length,extraBytes=len%3,parts=[],maxChunkLength=16383,i=0,len2=len-extraBytes;i<len2;i+=maxChunkLength)parts.push(encodeChunk(uint8,i,i+maxChunkLength>len2?len2:i+maxChunkLength));return 1===extraBytes?(tmp=uint8[len-1],parts.push(lookup[tmp>>2]+lookup[tmp<<4&63]+"==")):2===extraBytes&&(tmp=(uint8[len-2]<<8)+uint8[len-1],parts.push(lookup[tmp>>10]+lookup[tmp>>4&63]+lookup[tmp<<2&63]+"=")),parts.join("")}exports.byteLength=byteLength,exports.toByteArray=toByteArray,exports.fromByteArray=fromByteArray;for(var lookup=[],revLookup=[],Arr="undefined"!=typeof Uint8Array?Uint8Array:Array,code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,len=code.length;i<len;++i)lookup[i]=code[i],revLookup[code.charCodeAt(i)]=i;revLookup["-".charCodeAt(0)]=62,revLookup["_".charCodeAt(0)]=63},{}],28:[function(require,module,exports){function BigInteger(a,b,c){return this instanceof BigInteger?void(null!=a&&("number"==typeof a?this.fromNumber(a,b,c):null==b&&"string"!=typeof a?this.fromString(a,256):this.fromString(a,b))):new BigInteger(a,b,c)}function am1(i,x,w,j,c,n){for(;--n>=0;){var v=x*this[i++]+w[j]+c;c=Math.floor(v/67108864),w[j++]=67108863&v}return c}function int2char(n){return BI_RM.charAt(n)}function intAt(s,i){var c=BI_RC[s.charCodeAt(i)];return null==c?-1:c}function bnpCopyTo(r){for(var i=this.t-1;i>=0;--i)r[i]=this[i];r.t=this.t,r.s=this.s}function bnpFromInt(x){this.t=1,this.s=x<0?-1:0,x>0?this[0]=x:x<-1?this[0]=x+DV:this.t=0}function nbv(i){var r=new BigInteger;return r.fromInt(i),r}function bnpFromString(s,b){var k,self=this;if(16==b)k=4;else if(8==b)k=3;else if(256==b)k=8;else if(2==b)k=1;else if(32==b)k=5;else{if(4!=b)return void self.fromRadix(s,b);k=2}self.t=0,self.s=0;for(var i=s.length,mi=!1,sh=0;--i>=0;){var x=8==k?255&s[i]:intAt(s,i);x<0?"-"==s.charAt(i)&&(mi=!0):(mi=!1,0==sh?self[self.t++]=x:sh+k>self.DB?(self[self.t-1]|=(x&(1<<self.DB-sh)-1)<<sh,self[self.t++]=x>>self.DB-sh):self[self.t-1]|=x<<sh,sh+=k,sh>=self.DB&&(sh-=self.DB))}8==k&&0!=(128&s[0])&&(self.s=-1,sh>0&&(self[self.t-1]|=(1<<self.DB-sh)-1<<sh)),self.clamp(),mi&&BigInteger.ZERO.subTo(self,self)}function bnpClamp(){for(var c=this.s&this.DM;this.t>0&&this[this.t-1]==c;)--this.t}function bnToString(b){var self=this;if(self.s<0)return"-"+self.negate().toString(b);var k;if(16==b)k=4;else if(8==b)k=3;else if(2==b)k=1;else if(32==b)k=5;else{if(4!=b)return self.toRadix(b);k=2}var d,km=(1<<k)-1,m=!1,r="",i=self.t,p=self.DB-i*self.DB%k;if(i-- >0)for(p<self.DB&&(d=self[i]>>p)>0&&(m=!0,r=int2char(d));i>=0;)p<k?(d=(self[i]&(1<<p)-1)<<k-p,d|=self[--i]>>(p+=self.DB-k)):(d=self[i]>>(p-=k)&km,p<=0&&(p+=self.DB,--i)),d>0&&(m=!0),m&&(r+=int2char(d));return m?r:"0"}function bnNegate(){var r=new BigInteger;return BigInteger.ZERO.subTo(this,r),r}function bnAbs(){return this.s<0?this.negate():this}function bnCompareTo(a){var r=this.s-a.s;if(0!=r)return r;var i=this.t;if(r=i-a.t,0!=r)return this.s<0?-r:r;for(;--i>=0;)if(0!=(r=this[i]-a[i]))return r;return 0}function nbits(x){var t,r=1;return 0!=(t=x>>>16)&&(x=t,r+=16),0!=(t=x>>8)&&(x=t,r+=8),0!=(t=x>>4)&&(x=t,r+=4),0!=(t=x>>2)&&(x=t,r+=2),0!=(t=x>>1)&&(x=t,r+=1),r}function bnBitLength(){return this.t<=0?0:this.DB*(this.t-1)+nbits(this[this.t-1]^this.s&this.DM)}function bnByteLength(){return this.bitLength()>>3}function bnpDLShiftTo(n,r){var i;for(i=this.t-1;i>=0;--i)r[i+n]=this[i];for(i=n-1;i>=0;--i)r[i]=0;r.t=this.t+n,r.s=this.s}function bnpDRShiftTo(n,r){for(var i=n;i<this.t;++i)r[i-n]=this[i];r.t=Math.max(this.t-n,0),r.s=this.s}function bnpLShiftTo(n,r){var i,self=this,bs=n%self.DB,cbs=self.DB-bs,bm=(1<<cbs)-1,ds=Math.floor(n/self.DB),c=self.s<<bs&self.DM;for(i=self.t-1;i>=0;--i)r[i+ds+1]=self[i]>>cbs|c,c=(self[i]&bm)<<bs;for(i=ds-1;i>=0;--i)r[i]=0;r[ds]=c,r.t=self.t+ds+1,r.s=self.s,r.clamp()}function bnpRShiftTo(n,r){var self=this;r.s=self.s;var ds=Math.floor(n/self.DB);if(ds>=self.t)return void(r.t=0);var bs=n%self.DB,cbs=self.DB-bs,bm=(1<<bs)-1;r[0]=self[ds]>>bs;for(var i=ds+1;i<self.t;++i)r[i-ds-1]|=(self[i]&bm)<<cbs,r[i-ds]=self[i]>>bs;bs>0&&(r[self.t-ds-1]|=(self.s&bm)<<cbs),r.t=self.t-ds,r.clamp()}function bnpSubTo(a,r){for(var self=this,i=0,c=0,m=Math.min(a.t,self.t);i<m;)c+=self[i]-a[i],r[i++]=c&self.DM,c>>=self.DB;if(a.t<self.t){for(c-=a.s;i<self.t;)c+=self[i],r[i++]=c&self.DM,c>>=self.DB;c+=self.s}else{for(c+=self.s;i<a.t;)c-=a[i],r[i++]=c&self.DM,c>>=self.DB;c-=a.s}r.s=c<0?-1:0,c<-1?r[i++]=self.DV+c:c>0&&(r[i++]=c),r.t=i,r.clamp()}function bnpMultiplyTo(a,r){var x=this.abs(),y=a.abs(),i=x.t;for(r.t=i+y.t;--i>=0;)r[i]=0;for(i=0;i<y.t;++i)r[i+x.t]=x.am(0,y[i],r,i,0,x.t);r.s=0,r.clamp(),this.s!=a.s&&BigInteger.ZERO.subTo(r,r)}function bnpSquareTo(r){for(var x=this.abs(),i=r.t=2*x.t;--i>=0;)r[i]=0;for(i=0;i<x.t-1;++i){var c=x.am(i,x[i],r,2*i,0,1);(r[i+x.t]+=x.am(i+1,2*x[i],r,2*i+1,c,x.t-i-1))>=x.DV&&(r[i+x.t]-=x.DV,r[i+x.t+1]=1)}r.t>0&&(r[r.t-1]+=x.am(i,x[i],r,2*i,0,1)),r.s=0,r.clamp()}function bnpDivRemTo(m,q,r){var self=this,pm=m.abs();if(!(pm.t<=0)){var pt=self.abs();if(pt.t<pm.t)return null!=q&&q.fromInt(0),void(null!=r&&self.copyTo(r));null==r&&(r=new BigInteger);var y=new BigInteger,ts=self.s,ms=m.s,nsh=self.DB-nbits(pm[pm.t-1]);nsh>0?(pm.lShiftTo(nsh,y),pt.lShiftTo(nsh,r)):(pm.copyTo(y),pt.copyTo(r));var ys=y.t,y0=y[ys-1];if(0!=y0){var yt=y0*(1<<self.F1)+(ys>1?y[ys-2]>>self.F2:0),d1=self.FV/yt,d2=(1<<self.F1)/yt,e=1<<self.F2,i=r.t,j=i-ys,t=null==q?new BigInteger:q;for(y.dlShiftTo(j,t),r.compareTo(t)>=0&&(r[r.t++]=1,r.subTo(t,r)),BigInteger.ONE.dlShiftTo(ys,t),t.subTo(y,y);y.t<ys;)y[y.t++]=0;for(;--j>=0;){var qd=r[--i]==y0?self.DM:Math.floor(r[i]*d1+(r[i-1]+e)*d2);if((r[i]+=y.am(0,qd,r,j,0,ys))<qd)for(y.dlShiftTo(j,t),r.subTo(t,r);r[i]<--qd;)r.subTo(t,r)}null!=q&&(r.drShiftTo(ys,q),ts!=ms&&BigInteger.ZERO.subTo(q,q)),r.t=ys,r.clamp(),nsh>0&&r.rShiftTo(nsh,r),ts<0&&BigInteger.ZERO.subTo(r,r)}}}function bnMod(a){var r=new BigInteger;return this.abs().divRemTo(a,null,r),this.s<0&&r.compareTo(BigInteger.ZERO)>0&&a.subTo(r,r),r}function Classic(m){this.m=m}function cConvert(x){return x.s<0||x.compareTo(this.m)>=0?x.mod(this.m):x}function cRevert(x){return x}function cReduce(x){x.divRemTo(this.m,null,x)}function cMulTo(x,y,r){x.multiplyTo(y,r),this.reduce(r)}function cSqrTo(x,r){x.squareTo(r),this.reduce(r)}function bnpInvDigit(){if(this.t<1)return 0;var x=this[0];if(0==(1&x))return 0;var y=3&x;return y=y*(2-(15&x)*y)&15,y=y*(2-(255&x)*y)&255,y=y*(2-((65535&x)*y&65535))&65535,y=y*(2-x*y%this.DV)%this.DV,y>0?this.DV-y:-y}function Montgomery(m){this.m=m,this.mp=m.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<m.DB-15)-1,this.mt2=2*m.t}function montConvert(x){var r=new BigInteger;return x.abs().dlShiftTo(this.m.t,r),r.divRemTo(this.m,null,r),x.s<0&&r.compareTo(BigInteger.ZERO)>0&&this.m.subTo(r,r),r}function montRevert(x){var r=new BigInteger;return x.copyTo(r),this.reduce(r),r}function montReduce(x){for(;x.t<=this.mt2;)x[x.t++]=0;for(var i=0;i<this.m.t;++i){var j=32767&x[i],u0=j*this.mpl+((j*this.mph+(x[i]>>15)*this.mpl&this.um)<<15)&x.DM;for(j=i+this.m.t,x[j]+=this.m.am(0,u0,x,i,0,this.m.t);x[j]>=x.DV;)x[j]-=x.DV,x[++j]++}x.clamp(),x.drShiftTo(this.m.t,x),x.compareTo(this.m)>=0&&x.subTo(this.m,x)}function montSqrTo(x,r){x.squareTo(r),this.reduce(r)}function montMulTo(x,y,r){x.multiplyTo(y,r),this.reduce(r)}function bnpIsEven(){return 0==(this.t>0?1&this[0]:this.s)}function bnpExp(e,z){if(e>4294967295||e<1)return BigInteger.ONE;var r=new BigInteger,r2=new BigInteger,g=z.convert(this),i=nbits(e)-1;for(g.copyTo(r);--i>=0;)if(z.sqrTo(r,r2),(e&1<<i)>0)z.mulTo(r2,g,r);else{var t=r;r=r2,r2=t}return z.revert(r)}function bnModPowInt(e,m){var z;return z=e<256||m.isEven()?new Classic(m):new Montgomery(m),this.exp(e,z)}function bnClone(){var r=new BigInteger;return this.copyTo(r),r}function bnIntValue(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]}function bnByteValue(){return 0==this.t?this.s:this[0]<<24>>24}function bnShortValue(){return 0==this.t?this.s:this[0]<<16>>16}function bnpChunkSize(r){return Math.floor(Math.LN2*this.DB/Math.log(r))}function bnSigNum(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1}function bnpToRadix(b){if(null==b&&(b=10),0==this.signum()||b<2||b>36)return"0";var cs=this.chunkSize(b),a=Math.pow(b,cs),d=nbv(a),y=new BigInteger,z=new BigInteger,r="";for(this.divRemTo(d,y,z);y.signum()>0;)r=(a+z.intValue()).toString(b).substr(1)+r,y.divRemTo(d,y,z);return z.intValue().toString(b)+r}function bnpFromRadix(s,b){var self=this;self.fromInt(0),null==b&&(b=10);for(var cs=self.chunkSize(b),d=Math.pow(b,cs),mi=!1,j=0,w=0,i=0;i<s.length;++i){var x=intAt(s,i);x<0?"-"==s.charAt(i)&&0==self.signum()&&(mi=!0):(w=b*w+x,++j>=cs&&(self.dMultiply(d),self.dAddOffset(w,0),j=0,w=0))}j>0&&(self.dMultiply(Math.pow(b,j)),self.dAddOffset(w,0)),mi&&BigInteger.ZERO.subTo(self,self)}function bnpFromNumber(a,b,c){var self=this;if("number"==typeof b)if(a<2)self.fromInt(1);else for(self.fromNumber(a,c),self.testBit(a-1)||self.bitwiseTo(BigInteger.ONE.shiftLeft(a-1),op_or,self),self.isEven()&&self.dAddOffset(1,0);!self.isProbablePrime(b);)self.dAddOffset(2,0),self.bitLength()>a&&self.subTo(BigInteger.ONE.shiftLeft(a-1),self);else{var x=new Array,t=7&a;x.length=(a>>3)+1,b.nextBytes(x),t>0?x[0]&=(1<<t)-1:x[0]=0,self.fromString(x,256)}}function bnToByteArray(){var self=this,i=self.t,r=new Array;r[0]=self.s;var d,p=self.DB-i*self.DB%8,k=0;if(i-- >0)for(p<self.DB&&(d=self[i]>>p)!=(self.s&self.DM)>>p&&(r[k++]=d|self.s<<self.DB-p);i>=0;)p<8?(d=(self[i]&(1<<p)-1)<<8-p,d|=self[--i]>>(p+=self.DB-8)):(d=self[i]>>(p-=8)&255,p<=0&&(p+=self.DB,--i)),0!=(128&d)&&(d|=-256),0===k&&(128&self.s)!=(128&d)&&++k,(k>0||d!=self.s)&&(r[k++]=d);return r}function bnEquals(a){return 0==this.compareTo(a)}function bnMin(a){return this.compareTo(a)<0?this:a}function bnMax(a){return this.compareTo(a)>0?this:a}function bnpBitwiseTo(a,op,r){var i,f,self=this,m=Math.min(a.t,self.t);for(i=0;i<m;++i)r[i]=op(self[i],a[i]);if(a.t<self.t){for(f=a.s&self.DM,i=m;i<self.t;++i)r[i]=op(self[i],f);r.t=self.t}else{for(f=self.s&self.DM,i=m;i<a.t;++i)r[i]=op(f,a[i]);r.t=a.t}r.s=op(self.s,a.s),r.clamp()}function op_and(x,y){return x&y}function bnAnd(a){var r=new BigInteger;return this.bitwiseTo(a,op_and,r),r}function op_or(x,y){return x|y}function bnOr(a){var r=new BigInteger;return this.bitwiseTo(a,op_or,r),r}function op_xor(x,y){
return x^y}function bnXor(a){var r=new BigInteger;return this.bitwiseTo(a,op_xor,r),r}function op_andnot(x,y){return x&~y}function bnAndNot(a){var r=new BigInteger;return this.bitwiseTo(a,op_andnot,r),r}function bnNot(){for(var r=new BigInteger,i=0;i<this.t;++i)r[i]=this.DM&~this[i];return r.t=this.t,r.s=~this.s,r}function bnShiftLeft(n){var r=new BigInteger;return n<0?this.rShiftTo(-n,r):this.lShiftTo(n,r),r}function bnShiftRight(n){var r=new BigInteger;return n<0?this.lShiftTo(-n,r):this.rShiftTo(n,r),r}function lbit(x){if(0==x)return-1;var r=0;return 0==(65535&x)&&(x>>=16,r+=16),0==(255&x)&&(x>>=8,r+=8),0==(15&x)&&(x>>=4,r+=4),0==(3&x)&&(x>>=2,r+=2),0==(1&x)&&++r,r}function bnGetLowestSetBit(){for(var i=0;i<this.t;++i)if(0!=this[i])return i*this.DB+lbit(this[i]);return this.s<0?this.t*this.DB:-1}function cbit(x){for(var r=0;0!=x;)x&=x-1,++r;return r}function bnBitCount(){for(var r=0,x=this.s&this.DM,i=0;i<this.t;++i)r+=cbit(this[i]^x);return r}function bnTestBit(n){var j=Math.floor(n/this.DB);return j>=this.t?0!=this.s:0!=(this[j]&1<<n%this.DB)}function bnpChangeBit(n,op){var r=BigInteger.ONE.shiftLeft(n);return this.bitwiseTo(r,op,r),r}function bnSetBit(n){return this.changeBit(n,op_or)}function bnClearBit(n){return this.changeBit(n,op_andnot)}function bnFlipBit(n){return this.changeBit(n,op_xor)}function bnpAddTo(a,r){for(var self=this,i=0,c=0,m=Math.min(a.t,self.t);i<m;)c+=self[i]+a[i],r[i++]=c&self.DM,c>>=self.DB;if(a.t<self.t){for(c+=a.s;i<self.t;)c+=self[i],r[i++]=c&self.DM,c>>=self.DB;c+=self.s}else{for(c+=self.s;i<a.t;)c+=a[i],r[i++]=c&self.DM,c>>=self.DB;c+=a.s}r.s=c<0?-1:0,c>0?r[i++]=c:c<-1&&(r[i++]=self.DV+c),r.t=i,r.clamp()}function bnAdd(a){var r=new BigInteger;return this.addTo(a,r),r}function bnSubtract(a){var r=new BigInteger;return this.subTo(a,r),r}function bnMultiply(a){var r=new BigInteger;return this.multiplyTo(a,r),r}function bnSquare(){var r=new BigInteger;return this.squareTo(r),r}function bnDivide(a){var r=new BigInteger;return this.divRemTo(a,r,null),r}function bnRemainder(a){var r=new BigInteger;return this.divRemTo(a,null,r),r}function bnDivideAndRemainder(a){var q=new BigInteger,r=new BigInteger;return this.divRemTo(a,q,r),new Array(q,r)}function bnpDMultiply(n){this[this.t]=this.am(0,n-1,this,0,0,this.t),++this.t,this.clamp()}function bnpDAddOffset(n,w){if(0!=n){for(;this.t<=w;)this[this.t++]=0;for(this[w]+=n;this[w]>=this.DV;)this[w]-=this.DV,++w>=this.t&&(this[this.t++]=0),++this[w]}}function NullExp(){}function nNop(x){return x}function nMulTo(x,y,r){x.multiplyTo(y,r)}function nSqrTo(x,r){x.squareTo(r)}function bnPow(e){return this.exp(e,new NullExp)}function bnpMultiplyLowerTo(a,n,r){var i=Math.min(this.t+a.t,n);for(r.s=0,r.t=i;i>0;)r[--i]=0;var j;for(j=r.t-this.t;i<j;++i)r[i+this.t]=this.am(0,a[i],r,i,0,this.t);for(j=Math.min(a.t,n);i<j;++i)this.am(0,a[i],r,i,0,n-i);r.clamp()}function bnpMultiplyUpperTo(a,n,r){--n;var i=r.t=this.t+a.t-n;for(r.s=0;--i>=0;)r[i]=0;for(i=Math.max(n-this.t,0);i<a.t;++i)r[this.t+i-n]=this.am(n-i,a[i],r,0,0,this.t+i-n);r.clamp(),r.drShiftTo(1,r)}function Barrett(m){this.r2=new BigInteger,this.q3=new BigInteger,BigInteger.ONE.dlShiftTo(2*m.t,this.r2),this.mu=this.r2.divide(m),this.m=m}function barrettConvert(x){if(x.s<0||x.t>2*this.m.t)return x.mod(this.m);if(x.compareTo(this.m)<0)return x;var r=new BigInteger;return x.copyTo(r),this.reduce(r),r}function barrettRevert(x){return x}function barrettReduce(x){var self=this;for(x.drShiftTo(self.m.t-1,self.r2),x.t>self.m.t+1&&(x.t=self.m.t+1,x.clamp()),self.mu.multiplyUpperTo(self.r2,self.m.t+1,self.q3),self.m.multiplyLowerTo(self.q3,self.m.t+1,self.r2);x.compareTo(self.r2)<0;)x.dAddOffset(1,self.m.t+1);for(x.subTo(self.r2,x);x.compareTo(self.m)>=0;)x.subTo(self.m,x)}function barrettSqrTo(x,r){x.squareTo(r),this.reduce(r)}function barrettMulTo(x,y,r){x.multiplyTo(y,r),this.reduce(r)}function bnModPow(e,m){var k,z,i=e.bitLength(),r=nbv(1);if(i<=0)return r;k=i<18?1:i<48?3:i<144?4:i<768?5:6,z=i<8?new Classic(m):m.isEven()?new Barrett(m):new Montgomery(m);var g=new Array,n=3,k1=k-1,km=(1<<k)-1;if(g[1]=z.convert(this),k>1){var g2=new BigInteger;for(z.sqrTo(g[1],g2);n<=km;)g[n]=new BigInteger,z.mulTo(g2,g[n-2],g[n]),n+=2}var w,t,j=e.t-1,is1=!0,r2=new BigInteger;for(i=nbits(e[j])-1;j>=0;){for(i>=k1?w=e[j]>>i-k1&km:(w=(e[j]&(1<<i+1)-1)<<k1-i,j>0&&(w|=e[j-1]>>this.DB+i-k1)),n=k;0==(1&w);)w>>=1,--n;if((i-=n)<0&&(i+=this.DB,--j),is1)g[w].copyTo(r),is1=!1;else{for(;n>1;)z.sqrTo(r,r2),z.sqrTo(r2,r),n-=2;n>0?z.sqrTo(r,r2):(t=r,r=r2,r2=t),z.mulTo(r2,g[w],r)}for(;j>=0&&0==(e[j]&1<<i);)z.sqrTo(r,r2),t=r,r=r2,r2=t,--i<0&&(i=this.DB-1,--j)}return z.revert(r)}function bnGCD(a){var x=this.s<0?this.negate():this.clone(),y=a.s<0?a.negate():a.clone();if(x.compareTo(y)<0){var t=x;x=y,y=t}var i=x.getLowestSetBit(),g=y.getLowestSetBit();if(g<0)return x;for(i<g&&(g=i),g>0&&(x.rShiftTo(g,x),y.rShiftTo(g,y));x.signum()>0;)(i=x.getLowestSetBit())>0&&x.rShiftTo(i,x),(i=y.getLowestSetBit())>0&&y.rShiftTo(i,y),x.compareTo(y)>=0?(x.subTo(y,x),x.rShiftTo(1,x)):(y.subTo(x,y),y.rShiftTo(1,y));return g>0&&y.lShiftTo(g,y),y}function bnpModInt(n){if(n<=0)return 0;var d=this.DV%n,r=this.s<0?n-1:0;if(this.t>0)if(0==d)r=this[0]%n;else for(var i=this.t-1;i>=0;--i)r=(d*r+this[i])%n;return r}function bnModInverse(m){var ac=m.isEven();if(0===this.signum())throw new Error("division by zero");if(this.isEven()&&ac||0==m.signum())return BigInteger.ZERO;for(var u=m.clone(),v=this.clone(),a=nbv(1),b=nbv(0),c=nbv(0),d=nbv(1);0!=u.signum();){for(;u.isEven();)u.rShiftTo(1,u),ac?(a.isEven()&&b.isEven()||(a.addTo(this,a),b.subTo(m,b)),a.rShiftTo(1,a)):b.isEven()||b.subTo(m,b),b.rShiftTo(1,b);for(;v.isEven();)v.rShiftTo(1,v),ac?(c.isEven()&&d.isEven()||(c.addTo(this,c),d.subTo(m,d)),c.rShiftTo(1,c)):d.isEven()||d.subTo(m,d),d.rShiftTo(1,d);u.compareTo(v)>=0?(u.subTo(v,u),ac&&a.subTo(c,a),b.subTo(d,b)):(v.subTo(u,v),ac&&c.subTo(a,c),d.subTo(b,d))}if(0!=v.compareTo(BigInteger.ONE))return BigInteger.ZERO;for(;d.compareTo(m)>=0;)d.subTo(m,d);for(;d.signum()<0;)d.addTo(m,d);return d}function bnIsProbablePrime(t){var i,x=this.abs();if(1==x.t&&x[0]<=lowprimes[lowprimes.length-1]){for(i=0;i<lowprimes.length;++i)if(x[0]==lowprimes[i])return!0;return!1}if(x.isEven())return!1;for(i=1;i<lowprimes.length;){for(var m=lowprimes[i],j=i+1;j<lowprimes.length&&m<lplim;)m*=lowprimes[j++];for(m=x.modInt(m);i<j;)if(m%lowprimes[i++]==0)return!1}return x.millerRabin(t)}function bnpMillerRabin(t){var n1=this.subtract(BigInteger.ONE),k=n1.getLowestSetBit();if(k<=0)return!1;var r=n1.shiftRight(k);t=t+1>>1,t>lowprimes.length&&(t=lowprimes.length);for(var j,a=new BigInteger(null),bases=[],i=0;i<t;++i){for(;j=lowprimes[Math.floor(Math.random()*lowprimes.length)],bases.indexOf(j)!=-1;);bases.push(j),a.fromInt(j);var y=a.modPow(r,this);if(0!=y.compareTo(BigInteger.ONE)&&0!=y.compareTo(n1)){for(var j=1;j++<k&&0!=y.compareTo(n1);)if(y=y.modPowInt(2,this),0==y.compareTo(BigInteger.ONE))return!1;if(0!=y.compareTo(n1))return!1}}return!0}var proto=BigInteger.prototype;proto.__bigi=require("../package.json").version,BigInteger.isBigInteger=function(obj,check_ver){return obj&&obj.__bigi&&(!check_ver||obj.__bigi===proto.__bigi)};var dbits;BigInteger.prototype.am=am1,dbits=26,BigInteger.prototype.DB=dbits,BigInteger.prototype.DM=(1<<dbits)-1;var DV=BigInteger.prototype.DV=1<<dbits,BI_FP=52;BigInteger.prototype.FV=Math.pow(2,BI_FP),BigInteger.prototype.F1=BI_FP-dbits,BigInteger.prototype.F2=2*dbits-BI_FP;var rr,vv,BI_RM="0123456789abcdefghijklmnopqrstuvwxyz",BI_RC=new Array;for(rr="0".charCodeAt(0),vv=0;vv<=9;++vv)BI_RC[rr++]=vv;for(rr="a".charCodeAt(0),vv=10;vv<36;++vv)BI_RC[rr++]=vv;for(rr="A".charCodeAt(0),vv=10;vv<36;++vv)BI_RC[rr++]=vv;Classic.prototype.convert=cConvert,Classic.prototype.revert=cRevert,Classic.prototype.reduce=cReduce,Classic.prototype.mulTo=cMulTo,Classic.prototype.sqrTo=cSqrTo,Montgomery.prototype.convert=montConvert,Montgomery.prototype.revert=montRevert,Montgomery.prototype.reduce=montReduce,Montgomery.prototype.mulTo=montMulTo,Montgomery.prototype.sqrTo=montSqrTo,proto.copyTo=bnpCopyTo,proto.fromInt=bnpFromInt,proto.fromString=bnpFromString,proto.clamp=bnpClamp,proto.dlShiftTo=bnpDLShiftTo,proto.drShiftTo=bnpDRShiftTo,proto.lShiftTo=bnpLShiftTo,proto.rShiftTo=bnpRShiftTo,proto.subTo=bnpSubTo,proto.multiplyTo=bnpMultiplyTo,proto.squareTo=bnpSquareTo,proto.divRemTo=bnpDivRemTo,proto.invDigit=bnpInvDigit,proto.isEven=bnpIsEven,proto.exp=bnpExp,proto.toString=bnToString,proto.negate=bnNegate,proto.abs=bnAbs,proto.compareTo=bnCompareTo,proto.bitLength=bnBitLength,proto.byteLength=bnByteLength,proto.mod=bnMod,proto.modPowInt=bnModPowInt,NullExp.prototype.convert=nNop,NullExp.prototype.revert=nNop,NullExp.prototype.mulTo=nMulTo,NullExp.prototype.sqrTo=nSqrTo,Barrett.prototype.convert=barrettConvert,Barrett.prototype.revert=barrettRevert,Barrett.prototype.reduce=barrettReduce,Barrett.prototype.mulTo=barrettMulTo,Barrett.prototype.sqrTo=barrettSqrTo;var lowprimes=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],lplim=(1<<26)/lowprimes[lowprimes.length-1];proto.chunkSize=bnpChunkSize,proto.toRadix=bnpToRadix,proto.fromRadix=bnpFromRadix,proto.fromNumber=bnpFromNumber,proto.bitwiseTo=bnpBitwiseTo,proto.changeBit=bnpChangeBit,proto.addTo=bnpAddTo,proto.dMultiply=bnpDMultiply,proto.dAddOffset=bnpDAddOffset,proto.multiplyLowerTo=bnpMultiplyLowerTo,proto.multiplyUpperTo=bnpMultiplyUpperTo,proto.modInt=bnpModInt,proto.millerRabin=bnpMillerRabin,proto.clone=bnClone,proto.intValue=bnIntValue,proto.byteValue=bnByteValue,proto.shortValue=bnShortValue,proto.signum=bnSigNum,proto.toByteArray=bnToByteArray,proto.equals=bnEquals,proto.min=bnMin,proto.max=bnMax,proto.and=bnAnd,proto.or=bnOr,proto.xor=bnXor,proto.andNot=bnAndNot,proto.not=bnNot,proto.shiftLeft=bnShiftLeft,proto.shiftRight=bnShiftRight,proto.getLowestSetBit=bnGetLowestSetBit,proto.bitCount=bnBitCount,proto.testBit=bnTestBit,proto.setBit=bnSetBit,proto.clearBit=bnClearBit,proto.flipBit=bnFlipBit,proto.add=bnAdd,proto.subtract=bnSubtract,proto.multiply=bnMultiply,proto.divide=bnDivide,proto.remainder=bnRemainder,proto.divideAndRemainder=bnDivideAndRemainder,proto.modPow=bnModPow,proto.modInverse=bnModInverse,proto.pow=bnPow,proto.gcd=bnGCD,proto.isProbablePrime=bnIsProbablePrime,proto.square=bnSquare,BigInteger.ZERO=nbv(0),BigInteger.ONE=nbv(1),BigInteger.valueOf=nbv,module.exports=BigInteger},{"../package.json":31}],29:[function(require,module,exports){(function(Buffer){var assert=require("assert"),BigInteger=require("./bigi");BigInteger.fromByteArrayUnsigned=function(byteArray){return new BigInteger(128&byteArray[0]?[0].concat(byteArray):byteArray)},BigInteger.prototype.toByteArrayUnsigned=function(){var byteArray=this.toByteArray();return 0===byteArray[0]?byteArray.slice(1):byteArray},BigInteger.fromDERInteger=function(byteArray){return new BigInteger(byteArray)},BigInteger.prototype.toDERInteger=BigInteger.prototype.toByteArray,BigInteger.fromBuffer=function(buffer){if(128&buffer[0]){var byteArray=Array.prototype.slice.call(buffer);return new BigInteger([0].concat(byteArray))}return new BigInteger(buffer)},BigInteger.fromHex=function(hex){return""===hex?BigInteger.ZERO:(assert.equal(hex,hex.match(/^[A-Fa-f0-9]+/),"Invalid hex string"),assert.equal(hex.length%2,0,"Incomplete hex"),new BigInteger(hex,16))},BigInteger.prototype.toBuffer=function(size){for(var byteArray=this.toByteArrayUnsigned(),zeros=[],padding=size-byteArray.length;zeros.length<padding;)zeros.push(0);return new Buffer(zeros.concat(byteArray))},BigInteger.prototype.toHex=function(size){return this.toBuffer(size).toString("hex")}}).call(this,require("buffer").Buffer)},{"./bigi":28,assert:25,buffer:151}],30:[function(require,module,exports){var BigInteger=require("./bigi");require("./convert"),module.exports=BigInteger},{"./bigi":28,"./convert":29}],31:[function(require,module,exports){module.exports={_args:[["bigi@^1.2.0","/home/zhangchongyang/code/hdWallet/trustnote-wallet/node_modules/bip38"]],_from:"bigi@>=1.2.0 <2.0.0",_id:"bigi@1.4.2",_inCache:!0,_installable:!0,_location:"/bigi",_nodeVersion:"6.1.0",_npmOperationalInternal:{host:"packages-12-west.internal.npmjs.com",tmp:"tmp/bigi-1.4.2.tgz_1469584192413_0.6801238611806184"},_npmUser:{email:"jprichardson@gmail.com",name:"jprichardson"},_npmVersion:"3.8.6",_phantomChildren:{},_requested:{name:"bigi",raw:"bigi@^1.2.0",rawSpec:"^1.2.0",scope:null,spec:">=1.2.0 <2.0.0",type:"range"},_requiredBy:["/bip38","/ecurve"],_resolved:"https://registry.npmjs.org/bigi/-/bigi-1.4.2.tgz",_shasum:"9c665a95f88b8b08fc05cfd731f561859d725825",_shrinkwrap:null,_spec:"bigi@^1.2.0",_where:"/home/zhangchongyang/code/hdWallet/trustnote-wallet/node_modules/bip38",bugs:{url:"https://github.com/cryptocoinjs/bigi/issues"},dependencies:{},description:"Big integers.",devDependencies:{coveralls:"^2.11.2",istanbul:"^0.3.5",jshint:"^2.5.1",mocha:"^2.1.0",mochify:"^2.1.0"},directories:{},dist:{shasum:"9c665a95f88b8b08fc05cfd731f561859d725825",tarball:"https://registry.npmjs.org/bigi/-/bigi-1.4.2.tgz"},gitHead:"c25308081c896ff84702303722bf5ecd8b3f78e3",homepage:"https://github.com/cryptocoinjs/bigi#readme",keywords:["cryptography","math","bitcoin","arbitrary","precision","arithmetic","big","integer","int","number","biginteger","bigint","bignumber","decimal","float"],main:"./lib/index.js",maintainers:[{email:"boydb@midnightdesign.ws",name:"midnightlightning"},{email:"sidazhang89@gmail.com",name:"sidazhang"},{email:"npm@shesek.info",name:"nadav"},{email:"jprichardson@gmail.com",name:"jprichardson"}],name:"bigi",optionalDependencies:{},readme:"ERROR: No README data found!",repository:{type:"git",url:"git+https://github.com/cryptocoinjs/bigi.git"},scripts:{"browser-test":"mochify --wd -R spec",coverage:"istanbul cover ./node_modules/.bin/_mocha -- --reporter list test/*.js",coveralls:"npm run-script coverage && node ./node_modules/.bin/coveralls < coverage/lcov.info",jshint:"jshint --config jshint.json lib/*.js ; true",test:"_mocha -- test/*.js",unit:"mocha"},testling:{browsers:["ie/9..latest","firefox/latest","chrome/latest","safari/6.0..latest","iphone/6.0..latest","android-browser/4.2..latest"],files:"test/*.js",harness:"mocha"},version:"1.4.2"}},{}],32:[function(require,module,exports){(function(Buffer){function sha256x2(buffer){return buffer=createHash("sha256").update(buffer).digest(),createHash("sha256").update(buffer).digest()}function Bip38(versions){return this instanceof Bip38?(this.versions=versions||{"private":128},void(this.scryptParams={N:16384,r:8,p:8})):new Bip38}var aes=require("browserify-aes"),assert=require("assert"),createHash=require("create-hash"),cs=require("coinstring"),scrypt=require("scryptsy"),xor=require("buffer-xor"),ecurve=require("ecurve"),curve=ecurve.getCurveByName("secp256k1"),BigInteger=require("bigi");Bip38.prototype.encryptRaw=function(buffer,compressed,passphrase,saltAddress,progressCallback){assert.equal(buffer.length,32,"Invalid private key length");var secret=new Buffer(passphrase,"utf8"),salt=sha256x2(saltAddress).slice(0,4),N=this.scryptParams.N,r=this.scryptParams.r,p=this.scryptParams.p,scryptBuf=scrypt(secret,salt,N,r,p,64,progressCallback),derivedHalf1=scryptBuf.slice(0,32),derivedHalf2=scryptBuf.slice(32,64),xorBuf=xor(buffer,derivedHalf1),cipher=aes.createCipheriv("aes-256-ecb",derivedHalf2,new Buffer(0));cipher.setAutoPadding(!1),cipher.end(xorBuf);var cipherText=cipher.read(),flagByte=compressed?224:192,prefix=new Buffer(3);return prefix.writeUInt8(1,0),prefix.writeUInt8(66,1),prefix.writeUInt8(flagByte,2),Buffer.concat([prefix,salt,cipherText])},Bip38.prototype.encrypt=function(wif,passphrase,saltAddress,progressCallback){var d=cs.decode(wif).slice(1),compressed=33===d.length&&1===d[32];return compressed&&(d=d.slice(0,-1)),cs.encode(this.encryptRaw(d,compressed,passphrase,saltAddress,progressCallback))},Bip38.prototype.decryptRaw=function(encData,passphrase,progressCallback){assert.equal(encData.length,39,"Invalid BIP38 data length"),assert.equal(encData.readUInt8(0),1,"Invalid BIP38 prefix");var type=encData.readUInt8(1);if(67===type)return this.decryptECMult(encData,passphrase,progressCallback);passphrase=new Buffer(passphrase,"utf8"),assert.equal(type,66,"Invalid BIP38 type");var flagByte=encData.readUInt8(2),compressed=224===flagByte;compressed||assert.equal(flagByte,192,"Invalid BIP38 compression flag");var N=this.scryptParams.N,r=this.scryptParams.r,p=this.scryptParams.p,addresshash=encData.slice(3,7),scryptBuf=scrypt(passphrase,addresshash,N,r,p,64,progressCallback),derivedHalf1=scryptBuf.slice(0,32),derivedHalf2=scryptBuf.slice(32,64),privKeyBuf=encData.slice(7,39),decipher=aes.createDecipheriv("aes-256-ecb",derivedHalf2,new Buffer(0));decipher.setAutoPadding(!1),decipher.end(privKeyBuf);var plainText=decipher.read(),privateKey=xor(plainText,derivedHalf1);return{privateKey:privateKey,compressed:compressed}},Bip38.prototype.decrypt=function(encryptedBase58,passphrase,progressCallback){var encBuffer=cs.decode(encryptedBase58),decrypt=this.decryptRaw(encBuffer,passphrase,progressCallback),bufferLen=decrypt.compressed?34:33,buffer=new Buffer(bufferLen);return buffer.writeUInt8(this.versions["private"],0),decrypt.privateKey.copy(buffer,1),decrypt.compressed&&buffer.writeUInt8(1,33),cs.encode(buffer)},Bip38.prototype.decryptECMult=function(encData,passphrase,progressCallback){passphrase=new Buffer(passphrase,"utf8"),encData=encData.slice(1);var compressed=0!==(32&encData[1]),hasLotSeq=0!==(4&encData[1]);assert.equal(36&encData[1],encData[1],"Invalid private key.");var ownerSalt,addresshash=encData.slice(2,6),ownerEntropy=encData.slice(6,14);ownerSalt=hasLotSeq?ownerEntropy.slice(0,4):ownerEntropy;var passFactor,encryptedPart1=encData.slice(14,22),encryptedPart2=encData.slice(22,38),N=this.scryptParams.N,r=this.scryptParams.r,p=this.scryptParams.p,preFactor=scrypt(passphrase,ownerSalt,N,r,p,32,progressCallback);if(hasLotSeq){var hashTarget=Buffer.concat([preFactor,ownerEntropy]);passFactor=sha256x2(hashTarget)}else passFactor=preFactor;var passInt=BigInteger.fromBuffer(passFactor),passPoint=curve.G.multiply(passInt).getEncoded(!0),seedBPass=scrypt(passPoint,Buffer.concat([addresshash,ownerEntropy]),1024,1,1,64),derivedHalf1=seedBPass.slice(0,32),derivedHalf2=seedBPass.slice(32,64),decipher=aes.createDecipheriv("aes-256-ecb",derivedHalf2,new Buffer(0));decipher.setAutoPadding(!1),decipher.end(encryptedPart2);var decryptedPart2=decipher.read(),tmp=xor(decryptedPart2,derivedHalf1.slice(16,32)),seedBPart2=tmp.slice(8,16),decipher2=aes.createDecipheriv("aes-256-ecb",derivedHalf2,new Buffer(0));decipher2.setAutoPadding(!1),decipher2.write(encryptedPart1),decipher2.end(tmp.slice(0,8));var seedBPart1=xor(decipher2.read(),derivedHalf1.slice(0,16)),seedB=Buffer.concat([seedBPart1,seedBPart2],24),factorB=sha256x2(seedB),d=passInt.multiply(BigInteger.fromBuffer(factorB)).mod(curve.n);return{privateKey:d.toBuffer(32),compressed:compressed}},Bip38.prototype.verify=function(encryptedBase58){var decoded;try{decoded=cs.decode(encryptedBase58)}catch(e){return!1}if(39!==decoded.length)return!1;if(1!==decoded.readUInt8(0))return!1;var type=decoded.readUInt8(1),flag=decoded.readUInt8(2);if(66===type){if(192!==flag&&224!==flag)return!1}else{if(67!==type)return!1;if(flag&-37)return!1}return!0},module.exports=Bip38}).call(this,require("buffer").Buffer)},{assert:25,bigi:30,"browserify-aes":122,buffer:151,"buffer-xor":150,coinstring:153,"create-hash":177,ecurve:196,scryptsy:324}],33:[function(require,module,exports){function check(buffer){if(buffer.length<8)return!1;if(buffer.length>72)return!1;if(48!==buffer[0])return!1;if(buffer[1]!==buffer.length-2)return!1;if(2!==buffer[2])return!1;var lenR=buffer[3];if(0===lenR)return!1;if(5+lenR>=buffer.length)return!1;if(2!==buffer[4+lenR])return!1;var lenS=buffer[5+lenR];return 0!==lenS&&(6+lenR+lenS===buffer.length&&(!(128&buffer[4])&&(!(lenR>1&&0===buffer[4]&&!(128&buffer[5]))&&(!(128&buffer[lenR+6])&&!(lenS>1&&0===buffer[lenR+6]&&!(128&buffer[lenR+7]))))))}function decode(buffer){if(buffer.length<8)throw new Error("DER sequence length is too short");if(buffer.length>72)throw new Error("DER sequence length is too long");if(48!==buffer[0])throw new Error("Expected DER sequence");if(buffer[1]!==buffer.length-2)throw new Error("DER sequence length is invalid");if(2!==buffer[2])throw new Error("Expected DER integer");var lenR=buffer[3];if(0===lenR)throw new Error("R length is zero");if(5+lenR>=buffer.length)throw new Error("R length is too long");if(2!==buffer[4+lenR])throw new Error("Expected DER integer (2)");var lenS=buffer[5+lenR];if(0===lenS)throw new Error("S length is zero");if(6+lenR+lenS!==buffer.length)throw new Error("S length is invalid");if(128&buffer[4])throw new Error("R value is negative");if(lenR>1&&0===buffer[4]&&!(128&buffer[5]))throw new Error("R value excessively padded");if(128&buffer[lenR+6])throw new Error("S value is negative");if(lenS>1&&0===buffer[lenR+6]&&!(128&buffer[lenR+7]))throw new Error("S value excessively padded");return{r:buffer.slice(4,4+lenR),s:buffer.slice(6+lenR)}}function encode(r,s){var lenR=r.length,lenS=s.length;if(0===lenR)throw new Error("R length is zero");if(0===lenS)throw new Error("S length is zero");if(lenR>33)throw new Error("R length is too long");if(lenS>33)throw new Error("S length is too long");if(128&r[0])throw new Error("R value is negative");if(128&s[0])throw new Error("S value is negative");if(lenR>1&&0===r[0]&&!(128&r[1]))throw new Error("R value excessively padded");if(lenS>1&&0===s[0]&&!(128&s[1]))throw new Error("S value excessively padded");var signature=Buffer.allocUnsafe(6+lenR+lenS);return signature[0]=48,signature[1]=signature.length-2,signature[2]=2,signature[3]=r.length,r.copy(signature,4),signature[4+lenR]=2,signature[5+lenR]=s.length,s.copy(signature,6+lenR),signature}var Buffer=require("safe-buffer").Buffer;module.exports={check:check,decode:decode,encode:encode}},{"safe-buffer":323}],34:[function(require,module,exports){(function(global,Buffer){"use strict";var bitcore=module.exports;bitcore.version="v"+require("./package.json").version,bitcore.versionGuard=function(version){if(void 0!==version){var message="More than one instance of bitcore-lib found. Please make sure to require bitcore-lib and check that submodules do not also include their own bitcore-lib dependency.";throw new Error(message)}},bitcore.versionGuard(global._bitcore),global._bitcore=bitcore.version,bitcore.crypto={},bitcore.crypto.BN=require("./lib/crypto/bn"),bitcore.crypto.ECDSA=require("./lib/crypto/ecdsa"),bitcore.crypto.Hash=require("./lib/crypto/hash"),bitcore.crypto.Random=require("./lib/crypto/random"),bitcore.crypto.Point=require("./lib/crypto/point"),bitcore.crypto.Signature=require("./lib/crypto/signature"),bitcore.encoding={},bitcore.encoding.Base58=require("./lib/encoding/base58"),bitcore.encoding.Base58Check=require("./lib/encoding/base58check"),bitcore.encoding.BufferReader=require("./lib/encoding/bufferreader"),bitcore.encoding.BufferWriter=require("./lib/encoding/bufferwriter"),bitcore.encoding.Varint=require("./lib/encoding/varint"),bitcore.util={},bitcore.util.buffer=require("./lib/util/buffer"),bitcore.util.js=require("./lib/util/js"),bitcore.util.preconditions=require("./lib/util/preconditions"),bitcore.errors=require("./lib/errors"),bitcore.Address=require("./lib/address"),bitcore.Block=require("./lib/block"),bitcore.MerkleBlock=require("./lib/block/merkleblock"),bitcore.BlockHeader=require("./lib/block/blockheader"),bitcore.HDPrivateKey=require("./lib/hdprivatekey.js"),bitcore.HDPublicKey=require("./lib/hdpublickey.js"),bitcore.Networks=require("./lib/networks"),bitcore.Opcode=require("./lib/opcode"),bitcore.PrivateKey=require("./lib/privatekey"),bitcore.PublicKey=require("./lib/publickey"),bitcore.Script=require("./lib/script"),bitcore.Transaction=require("./lib/transaction"),bitcore.URI=require("./lib/uri"),bitcore.Unit=require("./lib/unit"),bitcore.deps={},bitcore.deps.bnjs=require("bn.js"),bitcore.deps.bs58=require("bs58"),bitcore.deps.Buffer=Buffer,bitcore.deps.elliptic=require("elliptic"),bitcore.deps._=require("lodash"),bitcore._HDKeyCache=require("./lib/hdkeycache"),bitcore.Transaction.sighash=require("./lib/transaction/sighash")}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},require("buffer").Buffer)},{"./lib/address":35,"./lib/block":38,"./lib/block/blockheader":37,"./lib/block/merkleblock":39,"./lib/crypto/bn":40,"./lib/crypto/ecdsa":41,"./lib/crypto/hash":42,"./lib/crypto/point":43,"./lib/crypto/random":44,"./lib/crypto/signature":45,"./lib/encoding/base58":46,"./lib/encoding/base58check":47,"./lib/encoding/bufferreader":48,"./lib/encoding/bufferwriter":49,"./lib/encoding/varint":50,"./lib/errors":51,"./lib/hdkeycache":53,"./lib/hdprivatekey.js":54,"./lib/hdpublickey.js":55,"./lib/networks":56,"./lib/opcode":57,"./lib/privatekey":58,"./lib/publickey":59,"./lib/script":60,"./lib/transaction":63,"./lib/transaction/sighash":71,"./lib/unit":75,"./lib/uri":76,"./lib/util/buffer":77,"./lib/util/js":78,"./lib/util/preconditions":79,"./package.json":106,"bn.js":80,bs58:81,buffer:151,elliptic:83,lodash:105}],35:[function(require,module,exports){(function(Buffer){"use strict";function Address(data,network,type){if(!(this instanceof Address))return new Address(data,network,type);if(_.isArray(data)&&_.isNumber(network))return Address.createMultisig(data,network,type);if(data instanceof Address)return data;if($.checkArgument(data,"First argument is required, please include address data.","guide/address.html"),network&&!Networks.get(network))throw new TypeError('Second argument must be "livenet" or "testnet".');if(type&&type!==Address.PayToPublicKeyHash&&type!==Address.PayToScriptHash)throw new TypeError('Third argument must be "pubkeyhash" or "scripthash".');var info=this._classifyArguments(data,network,type);return info.network=info.network||Networks.get(network)||Networks.defaultNetwork,info.type=info.type||type||Address.PayToPublicKeyHash,JSUtil.defineImmutable(this,{hashBuffer:info.hashBuffer,network:info.network,type:info.type}),this}var _=require("lodash"),$=require("./util/preconditions"),errors=require("./errors"),Base58Check=require("./encoding/base58check"),Networks=require("./networks"),Hash=require("./crypto/hash"),JSUtil=require("./util/js"),PublicKey=require("./publickey");Address.prototype._classifyArguments=function(data,network,type){if((data instanceof Buffer||data instanceof Uint8Array)&&20===data.length)return Address._transformHash(data);if((data instanceof Buffer||data instanceof Uint8Array)&&21===data.length)return Address._transformBuffer(data,network,type);if(data instanceof PublicKey)return Address._transformPublicKey(data);if(data instanceof Script)return Address._transformScript(data,network);if("string"==typeof data)return Address._transformString(data,network,type);if(_.isObject(data))return Address._transformObject(data);throw new TypeError("First argument is an unrecognized data format.")},Address.PayToPublicKeyHash="pubkeyhash",Address.PayToScriptHash="scripthash",Address._transformHash=function(hash){var info={};if(!(hash instanceof Buffer||hash instanceof Uint8Array))throw new TypeError("Address supplied is not a buffer.");if(20!==hash.length)throw new TypeError("Address hashbuffers must be exactly 20 bytes.");return info.hashBuffer=hash,info},Address._transformObject=function(data){return $.checkArgument(data.hash||data.hashBuffer,"Must provide a `hash` or `hashBuffer` property"),$.checkArgument(data.type,"Must provide a `type` property"),{hashBuffer:data.hash?new Buffer(data.hash,"hex"):data.hashBuffer,network:Networks.get(data.network)||Networks.defaultNetwork,type:data.type}},Address._classifyFromVersion=function(buffer){var version={},pubkeyhashNetwork=Networks.get(buffer[0],"pubkeyhash"),scripthashNetwork=Networks.get(buffer[0],"scripthash");return pubkeyhashNetwork?(version.network=pubkeyhashNetwork,version.type=Address.PayToPublicKeyHash):scripthashNetwork&&(version.network=scripthashNetwork,version.type=Address.PayToScriptHash),version},Address._transformBuffer=function(buffer,network,type){var info={};if(!(buffer instanceof Buffer||buffer instanceof Uint8Array))throw new TypeError("Address supplied is not a buffer.");if(21!==buffer.length)throw new TypeError("Address buffers must be exactly 21 bytes.");network=Networks.get(network);var bufferVersion=Address._classifyFromVersion(buffer);if(!bufferVersion.network||network&&network!==bufferVersion.network)throw new TypeError("Address has mismatched network type.");if(!bufferVersion.type||type&&type!==bufferVersion.type)throw new TypeError("Address has mismatched type.");return info.hashBuffer=buffer.slice(1),info.network=bufferVersion.network,info.type=bufferVersion.type,info},Address._transformPublicKey=function(pubkey){var info={};if(!(pubkey instanceof PublicKey))throw new TypeError("Address must be an instance of PublicKey.");return info.hashBuffer=Hash.sha256ripemd160(pubkey.toBuffer()),info.type=Address.PayToPublicKeyHash,info},Address._transformScript=function(script,network){$.checkArgument(script instanceof Script,"script must be a Script instance");var info=script.getAddressInfo(network);if(!info)throw new errors.Script.CantDeriveAddress(script);return info},Address.createMultisig=function(publicKeys,threshold,network){return network=network||publicKeys[0].network||Networks.defaultNetwork,Address.payingTo(Script.buildMultisigOut(publicKeys,threshold),network)},Address._transformString=function(data,network,type){if("string"!=typeof data)throw new TypeError("data parameter supplied is not a string.");data=data.trim();var addressBuffer=Base58Check.decode(data),info=Address._transformBuffer(addressBuffer,network,type);return info},Address.fromPublicKey=function(data,network){var info=Address._transformPublicKey(data);return network=network||Networks.defaultNetwork,new Address(info.hashBuffer,network,info.type)},Address.fromPublicKeyHash=function(hash,network){var info=Address._transformHash(hash);return new Address(info.hashBuffer,network,Address.PayToPublicKeyHash)},Address.fromScriptHash=function(hash,network){$.checkArgument(hash,"hash parameter is required");var info=Address._transformHash(hash);return new Address(info.hashBuffer,network,Address.PayToScriptHash)},Address.payingTo=function(script,network){return $.checkArgument(script,"script is required"),$.checkArgument(script instanceof Script,"script must be instance of Script"),Address.fromScriptHash(Hash.sha256ripemd160(script.toBuffer()),network)},Address.fromScript=function(script,network){$.checkArgument(script instanceof Script,"script must be a Script instance");var info=Address._transformScript(script,network);return new Address(info.hashBuffer,network,info.type)},Address.fromBuffer=function(buffer,network,type){var info=Address._transformBuffer(buffer,network,type);return new Address(info.hashBuffer,info.network,info.type)},Address.fromString=function(str,network,type){var info=Address._transformString(str,network,type);return new Address(info.hashBuffer,info.network,info.type)},Address.fromObject=function(obj){$.checkState(JSUtil.isHexa(obj.hash),'Unexpected hash property, "'+obj.hash+'", expected to be hex.');var hashBuffer=new Buffer(obj.hash,"hex");return new Address(hashBuffer,obj.network,obj.type)},Address.getValidationError=function(data,network,type){var error;try{new Address(data,network,type);
}catch(e){error=e}return error},Address.isValid=function(data,network,type){return!Address.getValidationError(data,network,type)},Address.prototype.isPayToPublicKeyHash=function(){return this.type===Address.PayToPublicKeyHash},Address.prototype.isPayToScriptHash=function(){return this.type===Address.PayToScriptHash},Address.prototype.toBuffer=function(){var version=new Buffer([this.network[this.type]]),buf=Buffer.concat([version,this.hashBuffer]);return buf},Address.prototype.toObject=Address.prototype.toJSON=function(){return{hash:this.hashBuffer.toString("hex"),type:this.type,network:this.network.toString()}},Address.prototype.toString=function(){return Base58Check.encode(this.toBuffer())},Address.prototype.inspect=function(){return"<Address: "+this.toString()+", type: "+this.type+", network: "+this.network+">"},module.exports=Address;var Script=require("./script")}).call(this,require("buffer").Buffer)},{"./crypto/hash":42,"./encoding/base58check":47,"./errors":51,"./networks":56,"./publickey":59,"./script":60,"./util/js":78,"./util/preconditions":79,buffer:151,lodash:105}],36:[function(require,module,exports){(function(Buffer){"use strict";function Block(arg){return this instanceof Block?(_.extend(this,Block._from(arg)),this):new Block(arg)}var _=require("lodash"),BlockHeader=require("./blockheader"),BN=require("../crypto/bn"),BufferUtil=require("../util/buffer"),BufferReader=require("../encoding/bufferreader"),BufferWriter=require("../encoding/bufferwriter"),Hash=require("../crypto/hash"),Transaction=require("../transaction"),$=require("../util/preconditions");Block.MAX_BLOCK_SIZE=1e6,Block._from=function(arg){var info={};if(BufferUtil.isBuffer(arg))info=Block._fromBufferReader(BufferReader(arg));else{if(!_.isObject(arg))throw new TypeError("Unrecognized argument for Block");info=Block._fromObject(arg)}return info},Block._fromObject=function(data){var transactions=[];data.transactions.forEach(function(tx){tx instanceof Transaction?transactions.push(tx):transactions.push(Transaction().fromObject(tx))});var info={header:BlockHeader.fromObject(data.header),transactions:transactions};return info},Block.fromObject=function(obj){var info=Block._fromObject(obj);return new Block(info)},Block._fromBufferReader=function(br){var info={};$.checkState(!br.finished(),"No block data received"),info.header=BlockHeader.fromBufferReader(br);var transactions=br.readVarintNum();info.transactions=[];for(var i=0;i<transactions;i++)info.transactions.push(Transaction().fromBufferReader(br));return info},Block.fromBufferReader=function(br){$.checkArgument(br,"br is required");var info=Block._fromBufferReader(br);return new Block(info)},Block.fromBuffer=function(buf){return Block.fromBufferReader(new BufferReader(buf))},Block.fromString=function(str){var buf=new Buffer(str,"hex");return Block.fromBuffer(buf)},Block.fromRawBlock=function(data){BufferUtil.isBuffer(data)||(data=new Buffer(data,"binary"));var br=BufferReader(data);br.pos=Block.Values.START_OF_BLOCK;var info=Block._fromBufferReader(br);return new Block(info)},Block.prototype.toObject=Block.prototype.toJSON=function(){var transactions=[];return this.transactions.forEach(function(tx){transactions.push(tx.toObject())}),{header:this.header.toObject(),transactions:transactions}},Block.prototype.toBuffer=function(){return this.toBufferWriter().concat()},Block.prototype.toString=function(){return this.toBuffer().toString("hex")},Block.prototype.toBufferWriter=function(bw){bw||(bw=new BufferWriter),bw.write(this.header.toBuffer()),bw.writeVarintNum(this.transactions.length);for(var i=0;i<this.transactions.length;i++)this.transactions[i].toBufferWriter(bw);return bw},Block.prototype.getTransactionHashes=function(){var hashes=[];if(0===this.transactions.length)return[Block.Values.NULL_HASH];for(var t=0;t<this.transactions.length;t++)hashes.push(this.transactions[t]._getHash());return hashes},Block.prototype.getMerkleTree=function(){for(var tree=this.getTransactionHashes(),j=0,size=this.transactions.length;size>1;size=Math.floor((size+1)/2)){for(var i=0;i<size;i+=2){var i2=Math.min(i+1,size-1),buf=Buffer.concat([tree[j+i],tree[j+i2]]);tree.push(Hash.sha256sha256(buf))}j+=size}return tree},Block.prototype.getMerkleRoot=function(){var tree=this.getMerkleTree();return tree[tree.length-1]},Block.prototype.validMerkleRoot=function(){var h=new BN(this.header.merkleRoot.toString("hex"),"hex"),c=new BN(this.getMerkleRoot().toString("hex"),"hex");return 0===h.cmp(c)},Block.prototype._getHash=function(){return this.header._getHash()};var idProperty={configurable:!1,enumerable:!0,get:function(){return this._id||(this._id=this.header.id),this._id},set:_.noop};Object.defineProperty(Block.prototype,"id",idProperty),Object.defineProperty(Block.prototype,"hash",idProperty),Block.prototype.inspect=function(){return"<Block "+this.id+">"},Block.Values={START_OF_BLOCK:8,NULL_HASH:new Buffer("0000000000000000000000000000000000000000000000000000000000000000","hex")},module.exports=Block}).call(this,require("buffer").Buffer)},{"../crypto/bn":40,"../crypto/hash":42,"../encoding/bufferreader":48,"../encoding/bufferwriter":49,"../transaction":63,"../util/buffer":77,"../util/preconditions":79,"./blockheader":37,buffer:151,lodash:105}],37:[function(require,module,exports){(function(Buffer){"use strict";var _=require("lodash"),BN=require("../crypto/bn"),BufferUtil=require("../util/buffer"),BufferReader=require("../encoding/bufferreader"),BufferWriter=require("../encoding/bufferwriter"),Hash=require("../crypto/hash"),$=(require("../util/js"),require("../util/preconditions")),GENESIS_BITS=486604799,BlockHeader=function BlockHeader(arg){if(!(this instanceof BlockHeader))return new BlockHeader(arg);var info=BlockHeader._from(arg);return this.version=info.version,this.prevHash=info.prevHash,this.merkleRoot=info.merkleRoot,this.time=info.time,this.timestamp=info.time,this.bits=info.bits,this.nonce=info.nonce,info.hash&&$.checkState(this.hash===info.hash,"Argument object hash property does not match block hash."),this};BlockHeader._from=function(arg){var info={};if(BufferUtil.isBuffer(arg))info=BlockHeader._fromBufferReader(BufferReader(arg));else{if(!_.isObject(arg))throw new TypeError("Unrecognized argument for BlockHeader");info=BlockHeader._fromObject(arg)}return info},BlockHeader._fromObject=function(data){$.checkArgument(data,"data is required");var prevHash=data.prevHash,merkleRoot=data.merkleRoot;_.isString(data.prevHash)&&(prevHash=BufferUtil.reverse(new Buffer(data.prevHash,"hex"))),_.isString(data.merkleRoot)&&(merkleRoot=BufferUtil.reverse(new Buffer(data.merkleRoot,"hex")));var info={hash:data.hash,version:data.version,prevHash:prevHash,merkleRoot:merkleRoot,time:data.time,timestamp:data.time,bits:data.bits,nonce:data.nonce};return info},BlockHeader.fromObject=function(obj){var info=BlockHeader._fromObject(obj);return new BlockHeader(info)},BlockHeader.fromRawBlock=function(data){BufferUtil.isBuffer(data)||(data=new Buffer(data,"binary"));var br=BufferReader(data);br.pos=BlockHeader.Constants.START_OF_HEADER;var info=BlockHeader._fromBufferReader(br);return new BlockHeader(info)},BlockHeader.fromBuffer=function(buf){var info=BlockHeader._fromBufferReader(BufferReader(buf));return new BlockHeader(info)},BlockHeader.fromString=function(str){var buf=new Buffer(str,"hex");return BlockHeader.fromBuffer(buf)},BlockHeader._fromBufferReader=function(br){var info={};return info.version=br.readUInt32LE(),info.prevHash=br.read(32),info.merkleRoot=br.read(32),info.time=br.readUInt32LE(),info.bits=br.readUInt32LE(),info.nonce=br.readUInt32LE(),info},BlockHeader.fromBufferReader=function(br){var info=BlockHeader._fromBufferReader(br);return new BlockHeader(info)},BlockHeader.prototype.toObject=BlockHeader.prototype.toJSON=function(){return{hash:this.hash,version:this.version,prevHash:BufferUtil.reverse(this.prevHash).toString("hex"),merkleRoot:BufferUtil.reverse(this.merkleRoot).toString("hex"),time:this.time,bits:this.bits,nonce:this.nonce}},BlockHeader.prototype.toBuffer=function(){return this.toBufferWriter().concat()},BlockHeader.prototype.toString=function(){return this.toBuffer().toString("hex")},BlockHeader.prototype.toBufferWriter=function(bw){return bw||(bw=new BufferWriter),bw.writeUInt32LE(this.version),bw.write(this.prevHash),bw.write(this.merkleRoot),bw.writeUInt32LE(this.time),bw.writeUInt32LE(this.bits),bw.writeUInt32LE(this.nonce),bw},BlockHeader.prototype.getTargetDifficulty=function(bits){bits=bits||this.bits;for(var target=new BN(16777215&bits),mov=8*((bits>>>24)-3);mov-- >0;)target=target.mul(new BN(2));return target},BlockHeader.prototype.getDifficulty=function(){var difficulty1TargetBN=this.getTargetDifficulty(GENESIS_BITS).mul(new BN(Math.pow(10,8))),currentTargetBN=this.getTargetDifficulty(),difficultyString=difficulty1TargetBN.div(currentTargetBN).toString(10),decimalPos=difficultyString.length-8;return difficultyString=difficultyString.slice(0,decimalPos)+"."+difficultyString.slice(decimalPos),parseFloat(difficultyString)},BlockHeader.prototype._getHash=function(){var buf=this.toBuffer();return Hash.sha256sha256(buf)};var idProperty={configurable:!1,enumerable:!0,get:function(){return this._id||(this._id=BufferReader(this._getHash()).readReverse().toString("hex")),this._id},set:_.noop};Object.defineProperty(BlockHeader.prototype,"id",idProperty),Object.defineProperty(BlockHeader.prototype,"hash",idProperty),BlockHeader.prototype.validTimestamp=function(){var currentTime=Math.round((new Date).getTime()/1e3);return!(this.time>currentTime+BlockHeader.Constants.MAX_TIME_OFFSET)},BlockHeader.prototype.validProofOfWork=function(){var pow=new BN(this.id,"hex"),target=this.getTargetDifficulty();return!(pow.cmp(target)>0)},BlockHeader.prototype.inspect=function(){return"<BlockHeader "+this.id+">"},BlockHeader.Constants={START_OF_HEADER:8,MAX_TIME_OFFSET:7200,LARGEST_HASH:new BN("10000000000000000000000000000000000000000000000000000000000000000","hex")},module.exports=BlockHeader}).call(this,require("buffer").Buffer)},{"../crypto/bn":40,"../crypto/hash":42,"../encoding/bufferreader":48,"../encoding/bufferwriter":49,"../util/buffer":77,"../util/js":78,"../util/preconditions":79,buffer:151,lodash:105}],38:[function(require,module,exports){module.exports=require("./block"),module.exports.BlockHeader=require("./blockheader"),module.exports.MerkleBlock=require("./merkleblock")},{"./block":36,"./blockheader":37,"./merkleblock":39}],39:[function(require,module,exports){(function(Buffer){"use strict";function MerkleBlock(arg){if(!(this instanceof MerkleBlock))return new MerkleBlock(arg);var info={};if(BufferUtil.isBuffer(arg))info=MerkleBlock._fromBufferReader(BufferReader(arg));else{if(!_.isObject(arg))throw new TypeError("Unrecognized argument for MerkleBlock");var header;header=arg.header instanceof BlockHeader?arg.header:BlockHeader.fromObject(arg.header),info={header:header,numTransactions:arg.numTransactions,hashes:arg.hashes,flags:arg.flags}}return _.extend(this,info),this._flagBitsUsed=0,this._hashesUsed=0,this}var _=require("lodash"),BlockHeader=require("./blockheader"),BufferUtil=require("../util/buffer"),BufferReader=require("../encoding/bufferreader"),BufferWriter=require("../encoding/bufferwriter"),Hash=require("../crypto/hash"),Transaction=(require("../util/js"),require("../transaction")),$=require("../util/preconditions");MerkleBlock.fromBuffer=function(buf){return MerkleBlock.fromBufferReader(BufferReader(buf))},MerkleBlock.fromBufferReader=function(br){return new MerkleBlock(MerkleBlock._fromBufferReader(br))},MerkleBlock.prototype.toBuffer=function(){return this.toBufferWriter().concat()},MerkleBlock.prototype.toBufferWriter=function(bw){bw||(bw=new BufferWriter),bw.write(this.header.toBuffer()),bw.writeUInt32LE(this.numTransactions),bw.writeVarintNum(this.hashes.length);for(var i=0;i<this.hashes.length;i++)bw.write(new Buffer(this.hashes[i],"hex"));for(bw.writeVarintNum(this.flags.length),i=0;i<this.flags.length;i++)bw.writeUInt8(this.flags[i]);return bw},MerkleBlock.prototype.toObject=MerkleBlock.prototype.toJSON=function(){return{header:this.header.toObject(),numTransactions:this.numTransactions,hashes:this.hashes,flags:this.flags}},MerkleBlock.prototype.validMerkleTree=function(){if($.checkState(_.isArray(this.flags),"MerkleBlock flags is not an array"),$.checkState(_.isArray(this.hashes),"MerkleBlock hashes is not an array"),this.hashes.length>this.numTransactions)return!1;if(8*this.flags.length<this.hashes.length)return!1;var height=this._calcTreeHeight(),opts={hashesUsed:0,flagBitsUsed:0},root=this._traverseMerkleTree(height,0,opts);return opts.hashesUsed===this.hashes.length&&BufferUtil.equals(root,this.header.merkleRoot)},MerkleBlock.prototype._traverseMerkleTree=function(depth,pos,opts){if(opts=opts||{},opts.txs=opts.txs||[],opts.flagBitsUsed=opts.flagBitsUsed||0,opts.hashesUsed=opts.hashesUsed||0,opts.flagBitsUsed>8*this.flags.length)return null;var isParentOfMatch=this.flags[opts.flagBitsUsed>>3]>>>(7&opts.flagBitsUsed++)&1;if(0!==depth&&isParentOfMatch){var left=this._traverseMerkleTree(depth-1,2*pos,opts),right=left;return 2*pos+1<this._calcTreeWidth(depth-1)&&(right=this._traverseMerkleTree(depth-1,2*pos+1,opts)),Hash.sha256sha256(new Buffer.concat([left,right]))}if(opts.hashesUsed>=this.hashes.length)return null;var hash=this.hashes[opts.hashesUsed++];return 0===depth&&isParentOfMatch&&opts.txs.push(hash),new Buffer(hash,"hex")},MerkleBlock.prototype._calcTreeWidth=function(height){return this.numTransactions+(1<<height)-1>>height},MerkleBlock.prototype._calcTreeHeight=function(){for(var height=0;this._calcTreeWidth(height)>1;)height++;return height},MerkleBlock.prototype.hasTransaction=function(tx){$.checkArgument(!_.isUndefined(tx),"tx cannot be undefined"),$.checkArgument(tx instanceof Transaction||"string"==typeof tx,'Invalid tx given, tx must be a "string" or "Transaction"');var hash=tx;tx instanceof Transaction&&(hash=BufferUtil.reverse(new Buffer(tx.id,"hex")).toString("hex"));var txs=[],height=this._calcTreeHeight();return this._traverseMerkleTree(height,0,{txs:txs}),txs.indexOf(hash)!==-1},MerkleBlock._fromBufferReader=function(br){$.checkState(!br.finished(),"No merkleblock data received");var info={};info.header=BlockHeader.fromBufferReader(br),info.numTransactions=br.readUInt32LE();var numHashes=br.readVarintNum();info.hashes=[];for(var i=0;i<numHashes;i++)info.hashes.push(br.read(32).toString("hex"));var numFlags=br.readVarintNum();for(info.flags=[],i=0;i<numFlags;i++)info.flags.push(br.readUInt8());return info},MerkleBlock.fromObject=function(obj){return new MerkleBlock(obj)},module.exports=MerkleBlock}).call(this,require("buffer").Buffer)},{"../crypto/hash":42,"../encoding/bufferreader":48,"../encoding/bufferwriter":49,"../transaction":63,"../util/buffer":77,"../util/js":78,"../util/preconditions":79,"./blockheader":37,buffer:151,lodash:105}],40:[function(require,module,exports){(function(Buffer){"use strict";var BN=require("bn.js"),$=require("../util/preconditions"),_=require("lodash"),reversebuf=function(buf){for(var buf2=new Buffer(buf.length),i=0;i<buf.length;i++)buf2[i]=buf[buf.length-1-i];return buf2};BN.Zero=new BN(0),BN.One=new BN(1),BN.Minus1=new BN((-1)),BN.fromNumber=function(n){return $.checkArgument(_.isNumber(n)),new BN(n)},BN.fromString=function(str,base){return $.checkArgument(_.isString(str)),new BN(str,base)},BN.fromBuffer=function(buf,opts){"undefined"!=typeof opts&&"little"===opts.endian&&(buf=reversebuf(buf));var hex=buf.toString("hex"),bn=new BN(hex,16);return bn},BN.fromSM=function(buf,opts){var ret;if(0===buf.length)return BN.fromBuffer(new Buffer([0]));var endian="big";return opts&&(endian=opts.endian),"little"===endian&&(buf=reversebuf(buf)),128&buf[0]?(buf[0]=127&buf[0],ret=BN.fromBuffer(buf),ret.neg().copy(ret)):ret=BN.fromBuffer(buf),ret},BN.prototype.toNumber=function(){return parseInt(this.toString(10),10)},BN.prototype.toBuffer=function(opts){var buf,hex;if(opts&&opts.size){hex=this.toString(16,2);var natlen=hex.length/2;buf=new Buffer(hex,"hex"),natlen===opts.size?buf=buf:natlen>opts.size?buf=BN.trim(buf,natlen):natlen<opts.size&&(buf=BN.pad(buf,natlen,opts.size))}else hex=this.toString(16,2),buf=new Buffer(hex,"hex");return"undefined"!=typeof opts&&"little"===opts.endian&&(buf=reversebuf(buf)),buf},BN.prototype.toSMBigEndian=function(){var buf;return this.cmp(BN.Zero)===-1?(buf=this.neg().toBuffer(),128&buf[0]?buf=Buffer.concat([new Buffer([128]),buf]):buf[0]=128|buf[0]):(buf=this.toBuffer(),128&buf[0]&&(buf=Buffer.concat([new Buffer([0]),buf]))),1===buf.length&0===buf[0]&&(buf=new Buffer([])),buf},BN.prototype.toSM=function(opts){var endian=opts?opts.endian:"big",buf=this.toSMBigEndian();return"little"===endian&&(buf=reversebuf(buf)),buf},BN.fromScriptNumBuffer=function(buf,fRequireMinimal,size){var nMaxNumSize=size||4;if($.checkArgument(buf.length<=nMaxNumSize,new Error("script number overflow")),fRequireMinimal&&buf.length>0&&0===(127&buf[buf.length-1])&&(buf.length<=1||0===(128&buf[buf.length-2])))throw new Error("non-minimally encoded script number");return BN.fromSM(buf,{endian:"little"})},BN.prototype.toScriptNumBuffer=function(){return this.toSM({endian:"little"})},BN.prototype.gt=function(b){return this.cmp(b)>0},BN.prototype.gte=function(b){return this.cmp(b)>=0},BN.prototype.lt=function(b){return this.cmp(b)<0},BN.trim=function(buf,natlen){return buf.slice(natlen-buf.length,buf.length)},BN.pad=function(buf,natlen,size){for(var rbuf=new Buffer(size),i=0;i<buf.length;i++)rbuf[rbuf.length-1-i]=buf[buf.length-1-i];for(i=0;i<size-natlen;i++)rbuf[i]=0;return rbuf},module.exports=BN}).call(this,require("buffer").Buffer)},{"../util/preconditions":79,"bn.js":80,buffer:151,lodash:105}],41:[function(require,module,exports){(function(Buffer){"use strict";var BN=require("./bn"),Point=require("./point"),Signature=require("./signature"),PublicKey=require("../publickey"),Random=require("./random"),Hash=require("./hash"),BufferUtil=require("../util/buffer"),_=require("lodash"),$=require("../util/preconditions"),ECDSA=function ECDSA(obj){return this instanceof ECDSA?void(obj&&this.set(obj)):new ECDSA(obj)};ECDSA.prototype.set=function(obj){return this.hashbuf=obj.hashbuf||this.hashbuf,this.endian=obj.endian||this.endian,this.privkey=obj.privkey||this.privkey,this.pubkey=obj.pubkey||(this.privkey?this.privkey.publicKey:this.pubkey),this.sig=obj.sig||this.sig,this.k=obj.k||this.k,this.verified=obj.verified||this.verified,this},ECDSA.prototype.privkey2pubkey=function(){this.pubkey=this.privkey.toPublicKey()},ECDSA.prototype.calci=function(){for(var i=0;i<4;i++){this.sig.i=i;var Qprime;try{Qprime=this.toPublicKey()}catch(e){console.error(e);continue}if(Qprime.point.eq(this.pubkey.point))return this.sig.compressed=this.pubkey.compressed,this}throw this.sig.i=void 0,new Error("Unable to find valid recovery factor")},ECDSA.fromString=function(str){var obj=JSON.parse(str);return new ECDSA(obj)},ECDSA.prototype.randomK=function(){var k,N=Point.getN();do k=BN.fromBuffer(Random.getRandomBuffer(32));while(!k.lt(N)||!k.gt(BN.Zero));return this.k=k,this},ECDSA.prototype.deterministicK=function(badrs){_.isUndefined(badrs)&&(badrs=0);var v=new Buffer(32);v.fill(1);var k=new Buffer(32);k.fill(0);var x=this.privkey.bn.toBuffer({size:32}),hashbuf="little"===this.endian?BufferUtil.reverse(this.hashbuf):this.hashbuf;k=Hash.sha256hmac(Buffer.concat([v,new Buffer([0]),x,hashbuf]),k),v=Hash.sha256hmac(v,k),k=Hash.sha256hmac(Buffer.concat([v,new Buffer([1]),x,hashbuf]),k),v=Hash.sha256hmac(v,k),v=Hash.sha256hmac(v,k);for(var T=BN.fromBuffer(v),N=Point.getN(),i=0;i<badrs||!T.lt(N)||!T.gt(BN.Zero);i++)k=Hash.sha256hmac(Buffer.concat([v,new Buffer([0])]),k),v=Hash.sha256hmac(v,k),v=Hash.sha256hmac(v,k),T=BN.fromBuffer(v);return this.k=T,this},ECDSA.prototype.toPublicKey=function(){var i=this.sig.i;$.checkArgument(0===i||1===i||2===i||3===i,new Error("i must be equal to 0, 1, 2, or 3"));var e=BN.fromBuffer(this.hashbuf),r=this.sig.r,s=this.sig.s,isYOdd=1&i,isSecondKey=i>>1,n=Point.getN(),G=Point.getG(),x=isSecondKey?r.add(n):r,R=Point.fromX(isYOdd,x),nR=R.mul(n);if(!nR.isInfinity())throw new Error("nR is not a valid curve point");var eNeg=e.neg().mod(n),rInv=r.invm(n),Q=R.mul(s).add(G.mul(eNeg)).mul(rInv),pubkey=PublicKey.fromPoint(Q,this.sig.compressed);return pubkey},ECDSA.prototype.sigError=function(){if(!BufferUtil.isBuffer(this.hashbuf)||32!==this.hashbuf.length)return"hashbuf must be a 32 byte buffer";var r=this.sig.r,s=this.sig.s;if(!(r.gt(BN.Zero)&&r.lt(Point.getN())&&s.gt(BN.Zero)&&s.lt(Point.getN())))return"r and s not in range";var e=BN.fromBuffer(this.hashbuf,this.endian?{endian:this.endian}:void 0),n=Point.getN(),sinv=s.invm(n),u1=sinv.mul(e).mod(n),u2=sinv.mul(r).mod(n),p=Point.getG().mulAdd(u1,this.pubkey.point,u2);return p.isInfinity()?"p is infinity":0!==p.getX().mod(n).cmp(r)&&"Invalid signature"},ECDSA.toLowS=function(s){return s.gt(BN.fromBuffer(new Buffer("7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5D576E7357A4501DDFE92F46681B20A0","hex")))&&(s=Point.getN().sub(s)),s},ECDSA.prototype._findSignature=function(d,e){var k,Q,r,s,N=Point.getN(),G=Point.getG(),badrs=0;do(!this.k||badrs>0)&&this.deterministicK(badrs),badrs++,k=this.k,Q=G.mul(k),r=Q.x.mod(N),s=k.invm(N).mul(e.add(d.mul(r))).mod(N);while(r.cmp(BN.Zero)<=0||s.cmp(BN.Zero)<=0);return s=ECDSA.toLowS(s),{s:s,r:r}},ECDSA.prototype.sign=function(){var hashbuf=this.hashbuf,privkey=this.privkey,d=privkey.bn;$.checkState(hashbuf&&privkey&&d,new Error("invalid parameters")),$.checkState(BufferUtil.isBuffer(hashbuf)&&32===hashbuf.length,new Error("hashbuf must be a 32 byte buffer"));var e=BN.fromBuffer(hashbuf,this.endian?{endian:this.endian}:void 0),obj=this._findSignature(d,e);return obj.compressed=this.pubkey.compressed,this.sig=new Signature(obj),this},ECDSA.prototype.signRandomK=function(){return this.randomK(),this.sign()},ECDSA.prototype.toString=function(){var obj={};return this.hashbuf&&(obj.hashbuf=this.hashbuf.toString("hex")),this.privkey&&(obj.privkey=this.privkey.toString()),this.pubkey&&(obj.pubkey=this.pubkey.toString()),this.sig&&(obj.sig=this.sig.toString()),this.k&&(obj.k=this.k.toString()),JSON.stringify(obj)},ECDSA.prototype.verify=function(){return this.sigError()?this.verified=!1:this.verified=!0,this},ECDSA.sign=function(hashbuf,privkey,endian){return ECDSA().set({hashbuf:hashbuf,endian:endian,privkey:privkey}).sign().sig},ECDSA.verify=function(hashbuf,sig,pubkey,endian){return ECDSA().set({hashbuf:hashbuf,endian:endian,sig:sig,pubkey:pubkey}).verify().verified},module.exports=ECDSA}).call(this,require("buffer").Buffer)},{"../publickey":59,"../util/buffer":77,"../util/preconditions":79,"./bn":40,"./hash":42,"./point":43,"./random":44,"./signature":45,buffer:151,lodash:105}],42:[function(require,module,exports){(function(Buffer){"use strict";var crypto=require("crypto"),BufferUtil=require("../util/buffer"),$=require("../util/preconditions"),Hash=module.exports;Hash.sha1=function(buf){return $.checkArgument(BufferUtil.isBuffer(buf)),crypto.createHash("sha1").update(buf).digest()},Hash.sha1.blocksize=512,Hash.sha256=function(buf){return $.checkArgument(BufferUtil.isBuffer(buf)),crypto.createHash("sha256").update(buf).digest()},Hash.sha256.blocksize=512,Hash.sha256sha256=function(buf){return $.checkArgument(BufferUtil.isBuffer(buf)),Hash.sha256(Hash.sha256(buf))},Hash.ripemd160=function(buf){return $.checkArgument(BufferUtil.isBuffer(buf)),crypto.createHash("ripemd160").update(buf).digest()},Hash.sha256ripemd160=function(buf){return $.checkArgument(BufferUtil.isBuffer(buf)),Hash.ripemd160(Hash.sha256(buf))},Hash.sha512=function(buf){return $.checkArgument(BufferUtil.isBuffer(buf)),crypto.createHash("sha512").update(buf).digest()},Hash.sha512.blocksize=1024,Hash.hmac=function(hashf,data,key){$.checkArgument(BufferUtil.isBuffer(data)),$.checkArgument(BufferUtil.isBuffer(key)),$.checkArgument(hashf.blocksize);var blocksize=hashf.blocksize/8;if(key.length>blocksize)key=hashf(key);else if(key<blocksize){var fill=new Buffer(blocksize);fill.fill(0),key.copy(fill),key=fill}var o_key=new Buffer(blocksize);o_key.fill(92);var i_key=new Buffer(blocksize);i_key.fill(54);for(var o_key_pad=new Buffer(blocksize),i_key_pad=new Buffer(blocksize),i=0;i<blocksize;i++)o_key_pad[i]=o_key[i]^key[i],i_key_pad[i]=i_key[i]^key[i];return hashf(Buffer.concat([o_key_pad,hashf(Buffer.concat([i_key_pad,data]))]))},Hash.sha256hmac=function(data,key){return Hash.hmac(Hash.sha256,data,key)},Hash.sha512hmac=function(data,key){return Hash.hmac(Hash.sha512,data,key)}}).call(this,require("buffer").Buffer)},{"../util/buffer":77,"../util/preconditions":79,buffer:151,crypto:181}],43:[function(require,module,exports){(function(Buffer){"use strict";var BN=require("./bn"),BufferUtil=require("../util/buffer"),ec=require("elliptic").curves.secp256k1,ecPoint=ec.curve.point.bind(ec.curve),ecPointFromX=ec.curve.pointFromX.bind(ec.curve),Point=function(x,y,isRed){var point=ecPoint(x,y,isRed);return point.validate(),point};Point.prototype=Object.getPrototypeOf(ec.curve.point()),Point.fromX=function(odd,x){var point=ecPointFromX(odd,x);return point.validate(),point},Point.getG=function(){return ec.curve.g},Point.getN=function(){return new BN(ec.curve.n.toArray())},Point.prototype._getX=Point.prototype.getX,Point.prototype.getX=function(){return new BN(this._getX().toArray())},Point.prototype._getY=Point.prototype.getY,Point.prototype.getY=function(){return new BN(this._getY().toArray())},Point.prototype.validate=function(){if(this.isInfinity())throw new Error("Point cannot be equal to Infinity");if(0===this.getX().cmp(BN.Zero)||0===this.getY().cmp(BN.Zero))throw new Error("Invalid x,y value for curve, cannot equal 0.");var p2=ecPointFromX(this.getY().isOdd(),this.getX());if(0!==p2.y.cmp(this.y))throw new Error("Invalid y value for curve.");var xValidRange=this.getX().gt(BN.Minus1)&&this.getX().lt(Point.getN()),yValidRange=this.getY().gt(BN.Minus1)&&this.getY().lt(Point.getN());if(!xValidRange||!yValidRange)throw new Error("Point does not lie on the curve");if(!this.mul(Point.getN()).isInfinity())throw new Error("Point times N must be infinity");return this},Point.pointToCompressed=function(point){var prefix,xbuf=point.getX().toBuffer({size:32}),ybuf=point.getY().toBuffer({size:32}),odd=ybuf[ybuf.length-1]%2;return prefix=new Buffer(odd?[3]:[2]),BufferUtil.concat([prefix,xbuf])},module.exports=Point}).call(this,require("buffer").Buffer)},{"../util/buffer":77,"./bn":40,buffer:151,elliptic:83}],44:[function(require,module,exports){(function(process,Buffer){"use strict";function Random(){}Random.getRandomBuffer=function(size){return process.browser?Random.getRandomBufferBrowser(size):Random.getRandomBufferNode(size)},Random.getRandomBufferNode=function(size){var crypto=require("crypto");return crypto.randomBytes(size)},Random.getRandomBufferBrowser=function(size){if(!window.crypto&&!window.msCrypto)throw new Error("window.crypto not available");if(window.crypto&&window.crypto.getRandomValues)var crypto=window.crypto;else{if(!window.msCrypto||!window.msCrypto.getRandomValues)throw new Error("window.crypto.getRandomValues not available");var crypto=window.msCrypto}var bbuf=new Uint8Array(size);crypto.getRandomValues(bbuf);var buf=new Buffer(bbuf);return buf},Random.getPseudoRandomBuffer=function(size){for(var r,b32=4294967296,b=new Buffer(size),i=0;i<=size;i++){var j=Math.floor(i/4),k=i-4*j;0===k?(r=Math.random()*b32,b[i]=255&r):b[i]=255&(r>>>=8)}return b},module.exports=Random}).call(this,require("_process"),require("buffer").Buffer)},{_process:309,buffer:151,crypto:181}],45:[function(require,module,exports){(function(Buffer){"use strict";var BN=require("./bn"),_=require("lodash"),$=require("../util/preconditions"),BufferUtil=require("../util/buffer"),JSUtil=require("../util/js"),Signature=function Signature(r,s){if(!(this instanceof Signature))return new Signature(r,s);if(r instanceof BN)this.set({r:r,s:s});else if(r){var obj=r;this.set(obj)}};Signature.prototype.set=function(obj){return this.r=obj.r||this.r||void 0,this.s=obj.s||this.s||void 0,this.i="undefined"!=typeof obj.i?obj.i:this.i,this.compressed="undefined"!=typeof obj.compressed?obj.compressed:this.compressed,this.nhashtype=obj.nhashtype||this.nhashtype||void 0,this},Signature.fromCompact=function(buf){$.checkArgument(BufferUtil.isBuffer(buf),"Argument is expected to be a Buffer");var sig=new Signature,compressed=!0,i=buf.slice(0,1)[0]-27-4;i<0&&(compressed=!1,i+=4);var b2=buf.slice(1,33),b3=buf.slice(33,65);return $.checkArgument(0===i||1===i||2===i||3===i,new Error("i must be 0, 1, 2, or 3")),$.checkArgument(32===b2.length,new Error("r must be 32 bytes")),$.checkArgument(32===b3.length,new Error("s must be 32 bytes")),sig.compressed=compressed,sig.i=i,sig.r=BN.fromBuffer(b2),sig.s=BN.fromBuffer(b3),sig},Signature.fromDER=Signature.fromBuffer=function(buf,strict){var obj=Signature.parseDER(buf,strict),sig=new Signature;return sig.r=obj.r,sig.s=obj.s,sig},Signature.fromTxFormat=function(buf){var nhashtype=buf.readUInt8(buf.length-1),derbuf=buf.slice(0,buf.length-1),sig=new Signature.fromDER(derbuf,(!1));return sig.nhashtype=nhashtype,sig},Signature.fromString=function(str){var buf=new Buffer(str,"hex");return Signature.fromDER(buf)},Signature.parseDER=function(buf,strict){$.checkArgument(BufferUtil.isBuffer(buf),new Error("DER formatted signature should be a buffer")),_.isUndefined(strict)&&(strict=!0);var header=buf[0];$.checkArgument(48===header,new Error("Header byte should be 0x30"));var length=buf[1],buflength=buf.slice(2).length;$.checkArgument(!strict||length===buflength,new Error("Length byte should length of what follows")),length=length<buflength?length:buflength;var rheader=buf[2];$.checkArgument(2===rheader,new Error("Integer byte for r should be 0x02"));var rlength=buf[3],rbuf=buf.slice(4,4+rlength),r=BN.fromBuffer(rbuf),rneg=0===buf[4];$.checkArgument(rlength===rbuf.length,new Error("Length of r incorrect"));var sheader=buf[4+rlength+0];$.checkArgument(2===sheader,new Error("Integer byte for s should be 0x02"));var slength=buf[4+rlength+1],sbuf=buf.slice(4+rlength+2,4+rlength+2+slength),s=BN.fromBuffer(sbuf),sneg=0===buf[4+rlength+2+2];$.checkArgument(slength===sbuf.length,new Error("Length of s incorrect"));var sumlength=4+rlength+2+slength;$.checkArgument(length===sumlength-2,new Error("Length of signature incorrect"));var obj={header:header,length:length,rheader:rheader,rlength:rlength,rneg:rneg,rbuf:rbuf,r:r,sheader:sheader,slength:slength,sneg:sneg,sbuf:sbuf,s:s};return obj},Signature.prototype.toCompact=function(i,compressed){if(i="number"==typeof i?i:this.i,compressed="boolean"==typeof compressed?compressed:this.compressed,0!==i&&1!==i&&2!==i&&3!==i)throw new Error("i must be equal to 0, 1, 2, or 3");var val=i+27+4;compressed===!1&&(val-=4);var b1=new Buffer([val]),b2=this.r.toBuffer({size:32}),b3=this.s.toBuffer({size:32});return Buffer.concat([b1,b2,b3])},Signature.prototype.toBuffer=Signature.prototype.toDER=function(){var rnbuf=this.r.toBuffer(),snbuf=this.s.toBuffer(),rneg=!!(128&rnbuf[0]),sneg=!!(128&snbuf[0]),rbuf=rneg?Buffer.concat([new Buffer([0]),rnbuf]):rnbuf,sbuf=sneg?Buffer.concat([new Buffer([0]),snbuf]):snbuf,rlength=rbuf.length,slength=sbuf.length,length=2+rlength+2+slength,rheader=2,sheader=2,header=48,der=Buffer.concat([new Buffer([header,length,rheader,rlength]),rbuf,new Buffer([sheader,slength]),sbuf]);return der},Signature.prototype.toString=function(){var buf=this.toDER();return buf.toString("hex")},Signature.isTxDER=function(buf){if(buf.length<9)return!1;if(buf.length>73)return!1;if(48!==buf[0])return!1;if(buf[1]!==buf.length-3)return!1;var nLenR=buf[3];if(5+nLenR>=buf.length)return!1;var nLenS=buf[5+nLenR];if(nLenR+nLenS+7!==buf.length)return!1;var R=buf.slice(4);if(2!==buf[2])return!1;if(0===nLenR)return!1;if(128&R[0])return!1;if(nLenR>1&&0===R[0]&&!(128&R[1]))return!1;var S=buf.slice(6+nLenR);return 2===buf[6+nLenR-2]&&(0!==nLenS&&(!(128&S[0])&&!(nLenS>1&&0===S[0]&&!(128&S[1]))))},Signature.prototype.hasLowS=function(){
return!this.s.lt(new BN(1))&&!this.s.gt(new BN("7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5D576E7357A4501DDFE92F46681B20A0","hex"))},Signature.prototype.hasDefinedHashtype=function(){if(!JSUtil.isNaturalNumber(this.nhashtype))return!1;var temp=this.nhashtype&~Signature.SIGHASH_ANYONECANPAY;return!(temp<Signature.SIGHASH_ALL||temp>Signature.SIGHASH_SINGLE)},Signature.prototype.toTxFormat=function(){var derbuf=this.toDER(),buf=new Buffer(1);return buf.writeUInt8(this.nhashtype,0),Buffer.concat([derbuf,buf])},Signature.SIGHASH_ALL=1,Signature.SIGHASH_NONE=2,Signature.SIGHASH_SINGLE=3,Signature.SIGHASH_ANYONECANPAY=128,module.exports=Signature}).call(this,require("buffer").Buffer)},{"../util/buffer":77,"../util/js":78,"../util/preconditions":79,"./bn":40,buffer:151,lodash:105}],46:[function(require,module,exports){(function(Buffer){"use strict";var _=require("lodash"),bs58=require("bs58"),buffer=require("buffer"),ALPHABET="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz".split(""),Base58=function Base58(obj){if(!(this instanceof Base58))return new Base58(obj);if(Buffer.isBuffer(obj)){var buf=obj;this.fromBuffer(buf)}else if("string"==typeof obj){var str=obj;this.fromString(str)}else obj&&this.set(obj)};Base58.validCharacters=function(chars){return buffer.Buffer.isBuffer(chars)&&(chars=chars.toString()),_.all(_.map(chars,function(char){return _.contains(ALPHABET,char)}))},Base58.prototype.set=function(obj){return this.buf=obj.buf||this.buf||void 0,this},Base58.encode=function(buf){if(!buffer.Buffer.isBuffer(buf))throw new Error("Input should be a buffer");return bs58.encode(buf)},Base58.decode=function(str){if("string"!=typeof str)throw new Error("Input should be a string");return new Buffer(bs58.decode(str))},Base58.prototype.fromBuffer=function(buf){return this.buf=buf,this},Base58.prototype.fromString=function(str){var buf=Base58.decode(str);return this.buf=buf,this},Base58.prototype.toBuffer=function(){return this.buf},Base58.prototype.toString=function(){return Base58.encode(this.buf)},module.exports=Base58}).call(this,require("buffer").Buffer)},{bs58:81,buffer:151,lodash:105}],47:[function(require,module,exports){(function(Buffer){"use strict";var _=require("lodash"),Base58=require("./base58"),buffer=require("buffer"),sha256sha256=require("../crypto/hash").sha256sha256,Base58Check=function Base58Check(obj){if(!(this instanceof Base58Check))return new Base58Check(obj);if(Buffer.isBuffer(obj)){var buf=obj;this.fromBuffer(buf)}else if("string"==typeof obj){var str=obj;this.fromString(str)}else obj&&this.set(obj)};Base58Check.prototype.set=function(obj){return this.buf=obj.buf||this.buf||void 0,this},Base58Check.validChecksum=function(data,checksum){return _.isString(data)&&(data=new buffer.Buffer(Base58.decode(data))),_.isString(checksum)&&(checksum=new buffer.Buffer(Base58.decode(checksum))),checksum||(checksum=data.slice(-4),data=data.slice(0,-4)),Base58Check.checksum(data).toString("hex")===checksum.toString("hex")},Base58Check.decode=function(s){if("string"!=typeof s)throw new Error("Input must be a string");var buf=new Buffer(Base58.decode(s));if(buf.length<4)throw new Error("Input string too short");var data=buf.slice(0,-4),csum=buf.slice(-4),hash=sha256sha256(data),hash4=hash.slice(0,4);if(csum.toString("hex")!==hash4.toString("hex"))throw new Error("Checksum mismatch");return data},Base58Check.checksum=function(buffer){return sha256sha256(buffer).slice(0,4)},Base58Check.encode=function(buf){if(!Buffer.isBuffer(buf))throw new Error("Input must be a buffer");var checkedBuf=new Buffer(buf.length+4),hash=Base58Check.checksum(buf);return buf.copy(checkedBuf),hash.copy(checkedBuf,buf.length),Base58.encode(checkedBuf)},Base58Check.prototype.fromBuffer=function(buf){return this.buf=buf,this},Base58Check.prototype.fromString=function(str){var buf=Base58Check.decode(str);return this.buf=buf,this},Base58Check.prototype.toBuffer=function(){return this.buf},Base58Check.prototype.toString=function(){return Base58Check.encode(this.buf)},module.exports=Base58Check}).call(this,require("buffer").Buffer)},{"../crypto/hash":42,"./base58":46,buffer:151,lodash:105}],48:[function(require,module,exports){(function(Buffer){"use strict";var _=require("lodash"),$=require("../util/preconditions"),BufferUtil=require("../util/buffer"),BN=require("../crypto/bn"),BufferReader=function BufferReader(buf){if(!(this instanceof BufferReader))return new BufferReader(buf);if(!_.isUndefined(buf))if(Buffer.isBuffer(buf))this.set({buf:buf});else if(_.isString(buf))this.set({buf:new Buffer(buf,"hex")});else{if(!_.isObject(buf))throw new TypeError("Unrecognized argument for BufferReader");var obj=buf;this.set(obj)}};BufferReader.prototype.set=function(obj){return this.buf=obj.buf||this.buf||void 0,this.pos=obj.pos||this.pos||0,this},BufferReader.prototype.eof=function(){return this.pos>=this.buf.length},BufferReader.prototype.finished=BufferReader.prototype.eof,BufferReader.prototype.read=function(len){$.checkArgument(!_.isUndefined(len),"Must specify a length");var buf=this.buf.slice(this.pos,this.pos+len);return this.pos=this.pos+len,buf},BufferReader.prototype.readAll=function(){var buf=this.buf.slice(this.pos,this.buf.length);return this.pos=this.buf.length,buf},BufferReader.prototype.readUInt8=function(){var val=this.buf.readUInt8(this.pos);return this.pos=this.pos+1,val},BufferReader.prototype.readUInt16BE=function(){var val=this.buf.readUInt16BE(this.pos);return this.pos=this.pos+2,val},BufferReader.prototype.readUInt16LE=function(){var val=this.buf.readUInt16LE(this.pos);return this.pos=this.pos+2,val},BufferReader.prototype.readUInt32BE=function(){var val=this.buf.readUInt32BE(this.pos);return this.pos=this.pos+4,val},BufferReader.prototype.readUInt32LE=function(){var val=this.buf.readUInt32LE(this.pos);return this.pos=this.pos+4,val},BufferReader.prototype.readUInt64BEBN=function(){var buf=this.buf.slice(this.pos,this.pos+8),bn=BN.fromBuffer(buf);return this.pos=this.pos+8,bn},BufferReader.prototype.readUInt64LEBN=function(){var bn,second=this.buf.readUInt32LE(this.pos),first=this.buf.readUInt32LE(this.pos+4),combined=4294967296*first+second;if(combined<=9007199254740991)bn=new BN(combined);else{var data=Array.prototype.slice.call(this.buf,this.pos,this.pos+8);bn=new BN(data,10,"le")}return this.pos=this.pos+8,bn},BufferReader.prototype.readVarintNum=function(){var first=this.readUInt8();switch(first){case 253:return this.readUInt16LE();case 254:return this.readUInt32LE();case 255:var bn=this.readUInt64LEBN(),n=bn.toNumber();if(n<=Math.pow(2,53))return n;throw new Error("number too large to retain precision - use readVarintBN");default:return first}},BufferReader.prototype.readVarLengthBuffer=function(){var len=this.readVarintNum(),buf=this.read(len);return $.checkState(buf.length===len,"Invalid length while reading varlength buffer. Expected to read: "+len+" and read "+buf.length),buf},BufferReader.prototype.readVarintBuf=function(){var first=this.buf.readUInt8(this.pos);switch(first){case 253:return this.read(3);case 254:return this.read(5);case 255:return this.read(9);default:return this.read(1)}},BufferReader.prototype.readVarintBN=function(){var first=this.readUInt8();switch(first){case 253:return new BN(this.readUInt16LE());case 254:return new BN(this.readUInt32LE());case 255:return this.readUInt64LEBN();default:return new BN(first)}},BufferReader.prototype.reverse=function(){for(var buf=new Buffer(this.buf.length),i=0;i<buf.length;i++)buf[i]=this.buf[this.buf.length-1-i];return this.buf=buf,this},BufferReader.prototype.readReverse=function(len){_.isUndefined(len)&&(len=this.buf.length);var buf=this.buf.slice(this.pos,this.pos+len);return this.pos=this.pos+len,BufferUtil.reverse(buf)},module.exports=BufferReader}).call(this,require("buffer").Buffer)},{"../crypto/bn":40,"../util/buffer":77,"../util/preconditions":79,buffer:151,lodash:105}],49:[function(require,module,exports){(function(Buffer){"use strict";var bufferUtil=require("../util/buffer"),assert=require("assert"),BufferWriter=function BufferWriter(obj){return this instanceof BufferWriter?void(obj?this.set(obj):this.bufs=[]):new BufferWriter(obj)};BufferWriter.prototype.set=function(obj){return this.bufs=obj.bufs||this.bufs||[],this},BufferWriter.prototype.toBuffer=function(){return this.concat()},BufferWriter.prototype.concat=function(){return Buffer.concat(this.bufs)},BufferWriter.prototype.write=function(buf){return assert(bufferUtil.isBuffer(buf)),this.bufs.push(buf),this},BufferWriter.prototype.writeReverse=function(buf){return assert(bufferUtil.isBuffer(buf)),this.bufs.push(bufferUtil.reverse(buf)),this},BufferWriter.prototype.writeUInt8=function(n){var buf=new Buffer(1);return buf.writeUInt8(n,0),this.write(buf),this},BufferWriter.prototype.writeUInt16BE=function(n){var buf=new Buffer(2);return buf.writeUInt16BE(n,0),this.write(buf),this},BufferWriter.prototype.writeUInt16LE=function(n){var buf=new Buffer(2);return buf.writeUInt16LE(n,0),this.write(buf),this},BufferWriter.prototype.writeUInt32BE=function(n){var buf=new Buffer(4);return buf.writeUInt32BE(n,0),this.write(buf),this},BufferWriter.prototype.writeInt32LE=function(n){var buf=new Buffer(4);return buf.writeInt32LE(n,0),this.write(buf),this},BufferWriter.prototype.writeUInt32LE=function(n){var buf=new Buffer(4);return buf.writeUInt32LE(n,0),this.write(buf),this},BufferWriter.prototype.writeUInt64BEBN=function(bn){var buf=bn.toBuffer({size:8});return this.write(buf),this},BufferWriter.prototype.writeUInt64LEBN=function(bn){var buf=bn.toBuffer({size:8});return this.writeReverse(buf),this},BufferWriter.prototype.writeVarintNum=function(n){var buf=BufferWriter.varintBufNum(n);return this.write(buf),this},BufferWriter.prototype.writeVarintBN=function(bn){var buf=BufferWriter.varintBufBN(bn);return this.write(buf),this},BufferWriter.varintBufNum=function(n){var buf=void 0;return n<253?(buf=new Buffer(1),buf.writeUInt8(n,0)):n<65536?(buf=new Buffer(3),buf.writeUInt8(253,0),buf.writeUInt16LE(n,1)):n<4294967296?(buf=new Buffer(5),buf.writeUInt8(254,0),buf.writeUInt32LE(n,1)):(buf=new Buffer(9),buf.writeUInt8(255,0),buf.writeInt32LE(n&-1,1),buf.writeUInt32LE(Math.floor(n/4294967296),5)),buf},BufferWriter.varintBufBN=function(bn){var buf=void 0,n=bn.toNumber();if(n<253)buf=new Buffer(1),buf.writeUInt8(n,0);else if(n<65536)buf=new Buffer(3),buf.writeUInt8(253,0),buf.writeUInt16LE(n,1);else if(n<4294967296)buf=new Buffer(5),buf.writeUInt8(254,0),buf.writeUInt32LE(n,1);else{var bw=new BufferWriter;bw.writeUInt8(255),bw.writeUInt64LEBN(bn);var buf=bw.concat()}return buf},module.exports=BufferWriter}).call(this,require("buffer").Buffer)},{"../util/buffer":77,assert:25,buffer:151}],50:[function(require,module,exports){(function(Buffer){"use strict";var BufferWriter=require("./bufferwriter"),BufferReader=require("./bufferreader"),BN=require("../crypto/bn"),Varint=function Varint(buf){if(!(this instanceof Varint))return new Varint(buf);if(Buffer.isBuffer(buf))this.buf=buf;else if("number"==typeof buf){var num=buf;this.fromNumber(num)}else if(buf instanceof BN){var bn=buf;this.fromBN(bn)}else if(buf){var obj=buf;this.set(obj)}};Varint.prototype.set=function(obj){return this.buf=obj.buf||this.buf,this},Varint.prototype.fromString=function(str){return this.set({buf:new Buffer(str,"hex")}),this},Varint.prototype.toString=function(){return this.buf.toString("hex")},Varint.prototype.fromBuffer=function(buf){return this.buf=buf,this},Varint.prototype.fromBufferReader=function(br){return this.buf=br.readVarintBuf(),this},Varint.prototype.fromBN=function(bn){return this.buf=BufferWriter().writeVarintBN(bn).concat(),this},Varint.prototype.fromNumber=function(num){return this.buf=BufferWriter().writeVarintNum(num).concat(),this},Varint.prototype.toBuffer=function(){return this.buf},Varint.prototype.toBN=function(){return BufferReader(this.buf).readVarintBN()},Varint.prototype.toNumber=function(){return BufferReader(this.buf).readVarintNum()},module.exports=Varint}).call(this,require("buffer").Buffer)},{"../crypto/bn":40,"./bufferreader":48,"./bufferwriter":49,buffer:151}],51:[function(require,module,exports){"use strict";function format(message,args){return message.replace("{0}",args[0]).replace("{1}",args[1]).replace("{2}",args[2])}var _=require("lodash"),traverseNode=function(parent,errorDefinition){var NodeError=function(){if(_.isString(errorDefinition.message))this.message=format(errorDefinition.message,arguments);else{if(!_.isFunction(errorDefinition.message))throw new Error("Invalid error definition for "+errorDefinition.name);this.message=errorDefinition.message.apply(null,arguments)}this.stack=this.message+"\n"+(new Error).stack};return NodeError.prototype=Object.create(parent.prototype),NodeError.prototype.name=parent.prototype.name+errorDefinition.name,parent[errorDefinition.name]=NodeError,errorDefinition.errors&&childDefinitions(NodeError,errorDefinition.errors),NodeError},childDefinitions=function(parent,childDefinitions){_.each(childDefinitions,function(childDefinition){traverseNode(parent,childDefinition)})},traverseRoot=function(parent,errorsDefinition){return childDefinitions(parent,errorsDefinition),parent},bitcore={};bitcore.Error=function(){this.message="Internal error",this.stack=this.message+"\n"+(new Error).stack},bitcore.Error.prototype=Object.create(Error.prototype),bitcore.Error.prototype.name="bitcore.Error";var data=require("./spec");traverseRoot(bitcore.Error,data),module.exports=bitcore.Error,module.exports.extend=function(spec){return traverseNode(bitcore.Error,spec)}},{"./spec":52,lodash:105}],52:[function(require,module,exports){"use strict";var docsURL="http://bitcore.io/";module.exports=[{name:"InvalidB58Char",message:"Invalid Base58 character: {0} in {1}"},{name:"InvalidB58Checksum",message:"Invalid Base58 checksum for {0}"},{name:"InvalidNetwork",message:"Invalid version for network: got {0}"},{name:"InvalidState",message:"Invalid state: {0}"},{name:"NotImplemented",message:"Function {0} was not implemented yet"},{name:"InvalidNetworkArgument",message:'Invalid network: must be "livenet" or "testnet", got {0}'},{name:"InvalidArgument",message:function(){return"Invalid Argument"+(arguments[0]?": "+arguments[0]:"")+(arguments[1]?" Documentation: "+docsURL+arguments[1]:"")}},{name:"AbstractMethodInvoked",message:"Abstract Method Invocation: {0}"},{name:"InvalidArgumentType",message:function(){return"Invalid Argument for "+arguments[2]+", expected "+arguments[1]+" but got "+typeof arguments[0]}},{name:"Unit",message:"Internal Error on Unit {0}",errors:[{name:"UnknownCode",message:"Unrecognized unit code: {0}"},{name:"InvalidRate",message:"Invalid exchange rate: {0}"}]},{name:"Transaction",message:"Internal Error on Transaction {0}",errors:[{name:"Input",message:"Internal Error on Input {0}",errors:[{name:"MissingScript",message:"Need a script to create an input"},{name:"UnsupportedScript",message:"Unsupported input script type: {0}"},{name:"MissingPreviousOutput",message:"No previous output information."}]},{name:"NeedMoreInfo",message:"{0}"},{name:"InvalidSorting",message:"The sorting function provided did not return the change output as one of the array elements"},{name:"InvalidOutputAmountSum",message:"{0}"},{name:"MissingSignatures",message:"Some inputs have not been fully signed"},{name:"InvalidIndex",message:"Invalid index: {0} is not between 0, {1}"},{name:"UnableToVerifySignature",message:"Unable to verify signature: {0}"},{name:"DustOutputs",message:"Dust amount detected in one output"},{name:"InvalidSatoshis",message:"Output satoshis are invalid"},{name:"FeeError",message:"Internal Error on Fee {0}",errors:[{name:"TooSmall",message:"Fee is too small: {0}"},{name:"TooLarge",message:"Fee is too large: {0}"},{name:"Different",message:"Unspent value is different from specified fee: {0}"}]},{name:"ChangeAddressMissing",message:"Change address is missing"},{name:"BlockHeightTooHigh",message:"Block Height can be at most 2^32 -1"},{name:"NLockTimeOutOfRange",message:"Block Height can only be between 0 and 499 999 999"},{name:"LockTimeTooEarly",message:"Lock Time can't be earlier than UNIX date 500 000 000"}]},{name:"Script",message:"Internal Error on Script {0}",errors:[{name:"UnrecognizedAddress",message:"Expected argument {0} to be an address"},{name:"CantDeriveAddress",message:"Can't derive address associated with script {0}, needs to be p2pkh in, p2pkh out, p2sh in, or p2sh out."},{name:"InvalidBuffer",message:"Invalid script buffer: can't parse valid script from given buffer {0}"}]},{name:"HDPrivateKey",message:"Internal Error on HDPrivateKey {0}",errors:[{name:"InvalidDerivationArgument",message:"Invalid derivation argument {0}, expected string, or number and boolean"},{name:"InvalidEntropyArgument",message:"Invalid entropy: must be an hexa string or binary buffer, got {0}",errors:[{name:"TooMuchEntropy",message:'Invalid entropy: more than 512 bits is non standard, got "{0}"'},{name:"NotEnoughEntropy",message:'Invalid entropy: at least 128 bits needed, got "{0}"'}]},{name:"InvalidLength",message:"Invalid length for xprivkey string in {0}"},{name:"InvalidPath",message:"Invalid derivation path: {0}"},{name:"UnrecognizedArgument",message:'Invalid argument: creating a HDPrivateKey requires a string, buffer, json or object, got "{0}"'}]},{name:"HDPublicKey",message:"Internal Error on HDPublicKey {0}",errors:[{name:"ArgumentIsPrivateExtended",message:"Argument is an extended private key: {0}"},{name:"InvalidDerivationArgument",message:"Invalid derivation argument: got {0}"},{name:"InvalidLength",message:'Invalid length for xpubkey: got "{0}"'},{name:"InvalidPath",message:'Invalid derivation path, it should look like: "m/1/100", got "{0}"'},{name:"InvalidIndexCantDeriveHardened",message:"Invalid argument: creating a hardened path requires an HDPrivateKey"},{name:"MustSupplyArgument",message:"Must supply an argument to create a HDPublicKey"},{name:"UnrecognizedArgument",message:"Invalid argument for creation, must be string, json, buffer, or object"}]}]},{}],53:[function(require,module,exports){"use strict";module.exports={_cache:{},_count:0,_eraseIndex:0,_usedList:{},_usedIndex:{},_CACHE_SIZE:5e3,get:function(xkey,number,hardened){hardened=!!hardened;var key=xkey+"/"+number+"/"+hardened;if(this._cache[key])return this._cacheHit(key),this._cache[key]},set:function(xkey,number,hardened,derived){hardened=!!hardened;var key=xkey+"/"+number+"/"+hardened;this._cache[key]=derived,this._cacheHit(key)},_cacheHit:function(key){this._usedIndex[key]&&delete this._usedList[this._usedIndex[key]],this._usedList[this._count]=key,this._usedIndex[key]=this._count,this._count++,this._cacheRemove()},_cacheRemove:function(){for(;this._eraseIndex<this._count-this._CACHE_SIZE;){if(this._usedList[this._eraseIndex]){var removeKey=this._usedList[this._eraseIndex];delete this._usedIndex[removeKey],delete this._cache[removeKey]}delete this._usedList[this._eraseIndex],this._eraseIndex++}}}},{}],54:[function(require,module,exports){(function(Buffer){"use strict";function HDPrivateKey(arg){if(arg instanceof HDPrivateKey)return arg;if(!(this instanceof HDPrivateKey))return new HDPrivateKey(arg);if(!arg)return this._generateRandomly();if(Network.get(arg))return this._generateRandomly(arg);if(_.isString(arg)||BufferUtil.isBuffer(arg))if(HDPrivateKey.isValidSerialized(arg))this._buildFromSerialized(arg);else if(JSUtil.isValidJSON(arg))this._buildFromJSON(arg);else{if(!BufferUtil.isBuffer(arg)||!HDPrivateKey.isValidSerialized(arg.toString()))throw HDPrivateKey.getSerializedError(arg);this._buildFromSerialized(arg.toString())}else{if(!_.isObject(arg))throw new hdErrors.UnrecognizedArgument(arg);this._buildFromObject(arg)}}var assert=require("assert"),buffer=require("buffer"),_=require("lodash"),$=require("./util/preconditions"),BN=require("./crypto/bn"),Base58=require("./encoding/base58"),Base58Check=require("./encoding/base58check"),Hash=require("./crypto/hash"),Network=require("./networks"),HDKeyCache=require("./hdkeycache"),Point=require("./crypto/point"),PrivateKey=require("./privatekey"),Random=require("./crypto/random"),errors=require("./errors"),hdErrors=errors.HDPrivateKey,BufferUtil=require("./util/buffer"),JSUtil=require("./util/js"),MINIMUM_ENTROPY_BITS=128,BITS_TO_BYTES=1/8,MAXIMUM_ENTROPY_BITS=512;HDPrivateKey.isValidPath=function(arg,hardened){if(_.isString(arg)){var indexes=HDPrivateKey._getDerivationIndexes(arg);return null!==indexes&&_.all(indexes,HDPrivateKey.isValidPath)}return!!_.isNumber(arg)&&(arg<HDPrivateKey.Hardened&&hardened===!0&&(arg+=HDPrivateKey.Hardened),arg>=0&&arg<HDPrivateKey.MaxIndex)},HDPrivateKey._getDerivationIndexes=function(path){var steps=path.split("/");if(_.contains(HDPrivateKey.RootElementAlias,path))return[];if(!_.contains(HDPrivateKey.RootElementAlias,steps[0]))return null;var indexes=steps.slice(1).map(function(step){var isHardened="'"===step.slice(-1);if(isHardened&&(step=step.slice(0,-1)),!step||"-"===step[0])return NaN;var index=+step;return isHardened&&(index+=HDPrivateKey.Hardened),index});return _.any(indexes,isNaN)?null:indexes},HDPrivateKey.prototype.derive=function(arg,hardened){if(_.isNumber(arg))return this._deriveWithNumber(arg,hardened);if(_.isString(arg))return this._deriveFromString(arg);throw new hdErrors.InvalidDerivationArgument(arg)},HDPrivateKey.prototype._deriveWithNumber=function(index,hardened){if(!HDPrivateKey.isValidPath(index,hardened))throw new hdErrors.InvalidPath(index);hardened=index>=HDPrivateKey.Hardened||hardened,index<HDPrivateKey.Hardened&&hardened===!0&&(index+=HDPrivateKey.Hardened);var cached=HDKeyCache.get(this.xprivkey,index,hardened);if(cached)return cached;var data,indexBuffer=BufferUtil.integerAsBuffer(index);data=hardened?BufferUtil.concat([new buffer.Buffer([0]),this.privateKey.toBuffer(),indexBuffer]):BufferUtil.concat([this.publicKey.toBuffer(),indexBuffer]);var hash=Hash.sha512hmac(data,this._buffers.chainCode),leftPart=BN.fromBuffer(hash.slice(0,32),{size:32}),chainCode=hash.slice(32,64),privateKey=leftPart.add(this.privateKey.toBigNumber()).mod(Point.getN()).toBuffer({size:32}),derived=new HDPrivateKey({network:this.network,depth:this.depth+1,parentFingerPrint:this.fingerPrint,childIndex:index,chainCode:chainCode,privateKey:privateKey});return HDKeyCache.set(this.xprivkey,index,hardened,derived),derived},HDPrivateKey.prototype._deriveFromString=function(path){if(!HDPrivateKey.isValidPath(path))throw new hdErrors.InvalidPath(path);var indexes=HDPrivateKey._getDerivationIndexes(path),derived=indexes.reduce(function(prev,index){return prev._deriveWithNumber(index)},this);return derived},HDPrivateKey.isValidSerialized=function(data,network){return!HDPrivateKey.getSerializedError(data,network)},HDPrivateKey.getSerializedError=function(data,network){if(!_.isString(data)&&!BufferUtil.isBuffer(data))return new hdErrors.UnrecognizedArgument("Expected string or buffer");if(!Base58.validCharacters(data))return new errors.InvalidB58Char("(unknown)",data);try{data=Base58Check.decode(data)}catch(e){return new errors.InvalidB58Checksum(data)}if(data.length!==HDPrivateKey.DataLength)return new hdErrors.InvalidLength(data);if(!_.isUndefined(network)){var error=HDPrivateKey._validateNetwork(data,network);if(error)return error}return null},HDPrivateKey._validateNetwork=function(data,networkArg){var network=Network.get(networkArg);if(!network)return new errors.InvalidNetworkArgument(networkArg);var version=data.slice(0,4);return BufferUtil.integerFromBuffer(version)!==network.xprivkey?new errors.InvalidNetwork(version):null},HDPrivateKey.fromString=function(arg){return $.checkArgument(_.isString(arg),"No valid string was provided"),new HDPrivateKey(arg)},HDPrivateKey.fromObject=function(arg){return $.checkArgument(_.isObject(arg),"No valid argument was provided"),new HDPrivateKey(arg)},HDPrivateKey.prototype._buildFromJSON=function(arg){return this._buildFromObject(JSON.parse(arg))},HDPrivateKey.prototype._buildFromObject=function(arg){var buffers={version:arg.network?BufferUtil.integerAsBuffer(Network.get(arg.network).xprivkey):arg.version,depth:_.isNumber(arg.depth)?BufferUtil.integerAsSingleByteBuffer(arg.depth):arg.depth,parentFingerPrint:_.isNumber(arg.parentFingerPrint)?BufferUtil.integerAsBuffer(arg.parentFingerPrint):arg.parentFingerPrint,childIndex:_.isNumber(arg.childIndex)?BufferUtil.integerAsBuffer(arg.childIndex):arg.childIndex,chainCode:_.isString(arg.chainCode)?BufferUtil.hexToBuffer(arg.chainCode):arg.chainCode,privateKey:_.isString(arg.privateKey)&&JSUtil.isHexa(arg.privateKey)?BufferUtil.hexToBuffer(arg.privateKey):arg.privateKey,checksum:arg.checksum?arg.checksum.length?arg.checksum:BufferUtil.integerAsBuffer(arg.checksum):void 0};return this._buildFromBuffers(buffers)},HDPrivateKey.prototype._buildFromSerialized=function(arg){var decoded=Base58Check.decode(arg),buffers={version:decoded.slice(HDPrivateKey.VersionStart,HDPrivateKey.VersionEnd),depth:decoded.slice(HDPrivateKey.DepthStart,HDPrivateKey.DepthEnd),parentFingerPrint:decoded.slice(HDPrivateKey.ParentFingerPrintStart,HDPrivateKey.ParentFingerPrintEnd),childIndex:decoded.slice(HDPrivateKey.ChildIndexStart,HDPrivateKey.ChildIndexEnd),chainCode:decoded.slice(HDPrivateKey.ChainCodeStart,HDPrivateKey.ChainCodeEnd),privateKey:decoded.slice(HDPrivateKey.PrivateKeyStart,HDPrivateKey.PrivateKeyEnd),checksum:decoded.slice(HDPrivateKey.ChecksumStart,HDPrivateKey.ChecksumEnd),xprivkey:arg};return this._buildFromBuffers(buffers)},HDPrivateKey.prototype._generateRandomly=function(network){return HDPrivateKey.fromSeed(Random.getRandomBuffer(64),network)},HDPrivateKey.fromSeed=function(hexa,network){if(JSUtil.isHexaString(hexa)&&(hexa=BufferUtil.hexToBuffer(hexa)),!Buffer.isBuffer(hexa))throw new hdErrors.InvalidEntropyArgument(hexa);if(hexa.length<MINIMUM_ENTROPY_BITS*BITS_TO_BYTES)throw new hdErrors.InvalidEntropyArgument.NotEnoughEntropy(hexa);if(hexa.length>MAXIMUM_ENTROPY_BITS*BITS_TO_BYTES)throw new hdErrors.InvalidEntropyArgument.TooMuchEntropy(hexa);var hash=Hash.sha512hmac(hexa,new buffer.Buffer("Bitcoin seed"));return new HDPrivateKey({network:Network.get(network)||Network.defaultNetwork,depth:0,parentFingerPrint:0,childIndex:0,privateKey:hash.slice(0,32),chainCode:hash.slice(32,64)})},HDPrivateKey.prototype._calcHDPublicKey=function(){if(!this._hdPublicKey){var HDPublicKey=require("./hdpublickey");this._hdPublicKey=new HDPublicKey(this)}},HDPrivateKey.prototype._buildFromBuffers=function(arg){HDPrivateKey._validateBufferArguments(arg),JSUtil.defineImmutable(this,{_buffers:arg});var sequence=[arg.version,arg.depth,arg.parentFingerPrint,arg.childIndex,arg.chainCode,BufferUtil.emptyBuffer(1),arg.privateKey],concat=buffer.Buffer.concat(sequence);if(arg.checksum&&arg.checksum.length){if(arg.checksum.toString()!==Base58Check.checksum(concat).toString())throw new errors.InvalidB58Checksum(concat)}else arg.checksum=Base58Check.checksum(concat);var xprivkey,network=Network.get(BufferUtil.integerFromBuffer(arg.version));xprivkey=Base58Check.encode(buffer.Buffer.concat(sequence)),arg.xprivkey=new Buffer(xprivkey);var privateKey=new PrivateKey(BN.fromBuffer(arg.privateKey),network),publicKey=privateKey.toPublicKey(),size=HDPrivateKey.ParentFingerPrintSize,fingerPrint=Hash.sha256ripemd160(publicKey.toBuffer()).slice(0,size);return JSUtil.defineImmutable(this,{xprivkey:xprivkey,network:network,depth:BufferUtil.integerFromSingleByteBuffer(arg.depth),privateKey:privateKey,publicKey:publicKey,fingerPrint:fingerPrint}),this._hdPublicKey=null,Object.defineProperty(this,"hdPublicKey",{configurable:!1,enumerable:!0,get:function(){return this._calcHDPublicKey(),this._hdPublicKey}}),Object.defineProperty(this,"xpubkey",{configurable:!1,enumerable:!0,get:function(){return this._calcHDPublicKey(),this._hdPublicKey.xpubkey}}),this},HDPrivateKey._validateBufferArguments=function(arg){var checkBuffer=function(name,size){var buff=arg[name];assert(BufferUtil.isBuffer(buff),name+" argument is not a buffer"),assert(buff.length===size,name+" has not the expected size: found "+buff.length+", expected "+size)};checkBuffer("version",HDPrivateKey.VersionSize),checkBuffer("depth",HDPrivateKey.DepthSize),checkBuffer("parentFingerPrint",HDPrivateKey.ParentFingerPrintSize),checkBuffer("childIndex",HDPrivateKey.ChildIndexSize),checkBuffer("chainCode",HDPrivateKey.ChainCodeSize),checkBuffer("privateKey",HDPrivateKey.PrivateKeySize),arg.checksum&&arg.checksum.length&&checkBuffer("checksum",HDPrivateKey.CheckSumSize)},HDPrivateKey.prototype.toString=function(){return this.xprivkey},HDPrivateKey.prototype.inspect=function(){return"<HDPrivateKey: "+this.xprivkey+">"},HDPrivateKey.prototype.toObject=HDPrivateKey.prototype.toJSON=function(){return{network:Network.get(BufferUtil.integerFromBuffer(this._buffers.version),"xprivkey").name,depth:BufferUtil.integerFromSingleByteBuffer(this._buffers.depth),fingerPrint:BufferUtil.integerFromBuffer(this.fingerPrint),parentFingerPrint:BufferUtil.integerFromBuffer(this._buffers.parentFingerPrint),childIndex:BufferUtil.integerFromBuffer(this._buffers.childIndex),chainCode:BufferUtil.bufferToHex(this._buffers.chainCode),privateKey:this.privateKey.toBuffer().toString("hex"),checksum:BufferUtil.integerFromBuffer(this._buffers.checksum),xprivkey:this.xprivkey}},HDPrivateKey.fromBuffer=function(arg){return new HDPrivateKey(arg.toString())},HDPrivateKey.prototype.toBuffer=function(){return BufferUtil.copy(this._buffers.xprivkey)},HDPrivateKey.DefaultDepth=0,HDPrivateKey.DefaultFingerprint=0,HDPrivateKey.DefaultChildIndex=0,HDPrivateKey.Hardened=2147483648,HDPrivateKey.MaxIndex=2*HDPrivateKey.Hardened,HDPrivateKey.RootElementAlias=["m","M","m'","M'"],HDPrivateKey.VersionSize=4,HDPrivateKey.DepthSize=1,HDPrivateKey.ParentFingerPrintSize=4,HDPrivateKey.ChildIndexSize=4,HDPrivateKey.ChainCodeSize=32,HDPrivateKey.PrivateKeySize=32,HDPrivateKey.CheckSumSize=4,HDPrivateKey.DataLength=78,HDPrivateKey.SerializedByteSize=82,HDPrivateKey.VersionStart=0,HDPrivateKey.VersionEnd=HDPrivateKey.VersionStart+HDPrivateKey.VersionSize,HDPrivateKey.DepthStart=HDPrivateKey.VersionEnd,HDPrivateKey.DepthEnd=HDPrivateKey.DepthStart+HDPrivateKey.DepthSize,HDPrivateKey.ParentFingerPrintStart=HDPrivateKey.DepthEnd,HDPrivateKey.ParentFingerPrintEnd=HDPrivateKey.ParentFingerPrintStart+HDPrivateKey.ParentFingerPrintSize,HDPrivateKey.ChildIndexStart=HDPrivateKey.ParentFingerPrintEnd,HDPrivateKey.ChildIndexEnd=HDPrivateKey.ChildIndexStart+HDPrivateKey.ChildIndexSize,HDPrivateKey.ChainCodeStart=HDPrivateKey.ChildIndexEnd,HDPrivateKey.ChainCodeEnd=HDPrivateKey.ChainCodeStart+HDPrivateKey.ChainCodeSize,HDPrivateKey.PrivateKeyStart=HDPrivateKey.ChainCodeEnd+1,HDPrivateKey.PrivateKeyEnd=HDPrivateKey.PrivateKeyStart+HDPrivateKey.PrivateKeySize,HDPrivateKey.ChecksumStart=HDPrivateKey.PrivateKeyEnd,HDPrivateKey.ChecksumEnd=HDPrivateKey.ChecksumStart+HDPrivateKey.CheckSumSize,assert(HDPrivateKey.ChecksumEnd===HDPrivateKey.SerializedByteSize),module.exports=HDPrivateKey}).call(this,require("buffer").Buffer)},{"./crypto/bn":40,"./crypto/hash":42,"./crypto/point":43,"./crypto/random":44,"./encoding/base58":46,"./encoding/base58check":47,"./errors":51,"./hdkeycache":53,"./hdpublickey":55,"./networks":56,"./privatekey":58,"./util/buffer":77,"./util/js":78,"./util/preconditions":79,assert:25,buffer:151,lodash:105}],55:[function(require,module,exports){(function(Buffer){"use strict";function HDPublicKey(arg){if(arg instanceof HDPublicKey)return arg;if(!(this instanceof HDPublicKey))return new HDPublicKey(arg);if(arg){if(_.isString(arg)||BufferUtil.isBuffer(arg)){var error=HDPublicKey.getSerializedError(arg);if(error){if(BufferUtil.isBuffer(arg)&&!HDPublicKey.getSerializedError(arg.toString()))return this._buildFromSerialized(arg.toString());if(error instanceof hdErrors.ArgumentIsPrivateExtended)return new HDPrivateKey(arg).hdPublicKey;throw error}return this._buildFromSerialized(arg)}if(_.isObject(arg))return arg instanceof HDPrivateKey?this._buildFromPrivate(arg):this._buildFromObject(arg);throw new hdErrors.UnrecognizedArgument(arg);
}throw new hdErrors.MustSupplyArgument}var _=require("lodash"),$=require("./util/preconditions"),BN=require("./crypto/bn"),Base58=require("./encoding/base58"),Base58Check=require("./encoding/base58check"),Hash=require("./crypto/hash"),HDPrivateKey=require("./hdprivatekey"),HDKeyCache=require("./hdkeycache"),Network=require("./networks"),Point=require("./crypto/point"),PublicKey=require("./publickey"),bitcoreErrors=require("./errors"),errors=bitcoreErrors,hdErrors=bitcoreErrors.HDPublicKey,assert=require("assert"),JSUtil=require("./util/js"),BufferUtil=require("./util/buffer");HDPublicKey.isValidPath=function(arg){if(_.isString(arg)){var indexes=HDPrivateKey._getDerivationIndexes(arg);return null!==indexes&&_.all(indexes,HDPublicKey.isValidPath)}return!!_.isNumber(arg)&&(arg>=0&&arg<HDPublicKey.Hardened)},HDPublicKey.prototype.derive=function(arg,hardened){if(_.isNumber(arg))return this._deriveWithNumber(arg,hardened);if(_.isString(arg))return this._deriveFromString(arg);throw new hdErrors.InvalidDerivationArgument(arg)},HDPublicKey.prototype._deriveWithNumber=function(index,hardened){if(index>=HDPublicKey.Hardened||hardened)throw new hdErrors.InvalidIndexCantDeriveHardened;if(index<0)throw new hdErrors.InvalidPath(index);var cached=HDKeyCache.get(this.xpubkey,index,!1);if(cached)return cached;var indexBuffer=BufferUtil.integerAsBuffer(index),data=BufferUtil.concat([this.publicKey.toBuffer(),indexBuffer]),hash=Hash.sha512hmac(data,this._buffers.chainCode),leftPart=BN.fromBuffer(hash.slice(0,32),{size:32}),chainCode=hash.slice(32,64),publicKey=PublicKey.fromPoint(Point.getG().mul(leftPart).add(this.publicKey.point)),derived=new HDPublicKey({network:this.network,depth:this.depth+1,parentFingerPrint:this.fingerPrint,childIndex:index,chainCode:chainCode,publicKey:publicKey});return HDKeyCache.set(this.xpubkey,index,!1,derived),derived},HDPublicKey.prototype._deriveFromString=function(path){if(_.contains(path,"'"))throw new hdErrors.InvalidIndexCantDeriveHardened;if(!HDPublicKey.isValidPath(path))throw new hdErrors.InvalidPath(path);var indexes=HDPrivateKey._getDerivationIndexes(path),derived=indexes.reduce(function(prev,index){return prev._deriveWithNumber(index)},this);return derived},HDPublicKey.isValidSerialized=function(data,network){return _.isNull(HDPublicKey.getSerializedError(data,network))},HDPublicKey.getSerializedError=function(data,network){if(!_.isString(data)&&!BufferUtil.isBuffer(data))return new hdErrors.UnrecognizedArgument("expected buffer or string");if(!Base58.validCharacters(data))return new errors.InvalidB58Char("(unknown)",data);try{data=Base58Check.decode(data)}catch(e){return new errors.InvalidB58Checksum(data)}if(data.length!==HDPublicKey.DataSize)return new hdErrors.InvalidLength(data);if(!_.isUndefined(network)){var error=HDPublicKey._validateNetwork(data,network);if(error)return error}var version=BufferUtil.integerFromBuffer(data.slice(0,4));return version===Network.livenet.xprivkey||version===Network.testnet.xprivkey?new hdErrors.ArgumentIsPrivateExtended:null},HDPublicKey._validateNetwork=function(data,networkArg){var network=Network.get(networkArg);if(!network)return new errors.InvalidNetworkArgument(networkArg);var version=data.slice(HDPublicKey.VersionStart,HDPublicKey.VersionEnd);return BufferUtil.integerFromBuffer(version)!==network.xpubkey?new errors.InvalidNetwork(version):null},HDPublicKey.prototype._buildFromPrivate=function(arg){var args=_.clone(arg._buffers),point=Point.getG().mul(BN.fromBuffer(args.privateKey));return args.publicKey=Point.pointToCompressed(point),args.version=BufferUtil.integerAsBuffer(Network.get(BufferUtil.integerFromBuffer(args.version)).xpubkey),args.privateKey=void 0,args.checksum=void 0,args.xprivkey=void 0,this._buildFromBuffers(args)},HDPublicKey.prototype._buildFromObject=function(arg){var buffers={version:arg.network?BufferUtil.integerAsBuffer(Network.get(arg.network).xpubkey):arg.version,depth:_.isNumber(arg.depth)?BufferUtil.integerAsSingleByteBuffer(arg.depth):arg.depth,parentFingerPrint:_.isNumber(arg.parentFingerPrint)?BufferUtil.integerAsBuffer(arg.parentFingerPrint):arg.parentFingerPrint,childIndex:_.isNumber(arg.childIndex)?BufferUtil.integerAsBuffer(arg.childIndex):arg.childIndex,chainCode:_.isString(arg.chainCode)?BufferUtil.hexToBuffer(arg.chainCode):arg.chainCode,publicKey:_.isString(arg.publicKey)?BufferUtil.hexToBuffer(arg.publicKey):BufferUtil.isBuffer(arg.publicKey)?arg.publicKey:arg.publicKey.toBuffer(),checksum:_.isNumber(arg.checksum)?BufferUtil.integerAsBuffer(arg.checksum):arg.checksum};return this._buildFromBuffers(buffers)},HDPublicKey.prototype._buildFromSerialized=function(arg){var decoded=Base58Check.decode(arg),buffers={version:decoded.slice(HDPublicKey.VersionStart,HDPublicKey.VersionEnd),depth:decoded.slice(HDPublicKey.DepthStart,HDPublicKey.DepthEnd),parentFingerPrint:decoded.slice(HDPublicKey.ParentFingerPrintStart,HDPublicKey.ParentFingerPrintEnd),childIndex:decoded.slice(HDPublicKey.ChildIndexStart,HDPublicKey.ChildIndexEnd),chainCode:decoded.slice(HDPublicKey.ChainCodeStart,HDPublicKey.ChainCodeEnd),publicKey:decoded.slice(HDPublicKey.PublicKeyStart,HDPublicKey.PublicKeyEnd),checksum:decoded.slice(HDPublicKey.ChecksumStart,HDPublicKey.ChecksumEnd),xpubkey:arg};return this._buildFromBuffers(buffers)},HDPublicKey.prototype._buildFromBuffers=function(arg){HDPublicKey._validateBufferArguments(arg),JSUtil.defineImmutable(this,{_buffers:arg});var sequence=[arg.version,arg.depth,arg.parentFingerPrint,arg.childIndex,arg.chainCode,arg.publicKey],concat=BufferUtil.concat(sequence),checksum=Base58Check.checksum(concat);if(arg.checksum&&arg.checksum.length){if(arg.checksum.toString("hex")!==checksum.toString("hex"))throw new errors.InvalidB58Checksum(concat,checksum)}else arg.checksum=checksum;var xpubkey,network=Network.get(BufferUtil.integerFromBuffer(arg.version));xpubkey=Base58Check.encode(BufferUtil.concat(sequence)),arg.xpubkey=new Buffer(xpubkey);var publicKey=new PublicKey(arg.publicKey,{network:network}),size=HDPublicKey.ParentFingerPrintSize,fingerPrint=Hash.sha256ripemd160(publicKey.toBuffer()).slice(0,size);return JSUtil.defineImmutable(this,{xpubkey:xpubkey,network:network,depth:BufferUtil.integerFromSingleByteBuffer(arg.depth),publicKey:publicKey,fingerPrint:fingerPrint}),this},HDPublicKey._validateBufferArguments=function(arg){var checkBuffer=function(name,size){var buff=arg[name];assert(BufferUtil.isBuffer(buff),name+" argument is not a buffer, it's "+typeof buff),assert(buff.length===size,name+" has not the expected size: found "+buff.length+", expected "+size)};checkBuffer("version",HDPublicKey.VersionSize),checkBuffer("depth",HDPublicKey.DepthSize),checkBuffer("parentFingerPrint",HDPublicKey.ParentFingerPrintSize),checkBuffer("childIndex",HDPublicKey.ChildIndexSize),checkBuffer("chainCode",HDPublicKey.ChainCodeSize),checkBuffer("publicKey",HDPublicKey.PublicKeySize),arg.checksum&&arg.checksum.length&&checkBuffer("checksum",HDPublicKey.CheckSumSize)},HDPublicKey.fromString=function(arg){return $.checkArgument(_.isString(arg),"No valid string was provided"),new HDPublicKey(arg)},HDPublicKey.fromObject=function(arg){return $.checkArgument(_.isObject(arg),"No valid argument was provided"),new HDPublicKey(arg)},HDPublicKey.prototype.toString=function(){return this.xpubkey},HDPublicKey.prototype.inspect=function(){return"<HDPublicKey: "+this.xpubkey+">"},HDPublicKey.prototype.toObject=HDPublicKey.prototype.toJSON=function(){return{network:Network.get(BufferUtil.integerFromBuffer(this._buffers.version)).name,depth:BufferUtil.integerFromSingleByteBuffer(this._buffers.depth),fingerPrint:BufferUtil.integerFromBuffer(this.fingerPrint),parentFingerPrint:BufferUtil.integerFromBuffer(this._buffers.parentFingerPrint),childIndex:BufferUtil.integerFromBuffer(this._buffers.childIndex),chainCode:BufferUtil.bufferToHex(this._buffers.chainCode),publicKey:this.publicKey.toString(),checksum:BufferUtil.integerFromBuffer(this._buffers.checksum),xpubkey:this.xpubkey}},HDPublicKey.fromBuffer=function(arg){return new HDPublicKey(arg)},HDPublicKey.prototype.toBuffer=function(){return BufferUtil.copy(this._buffers.xpubkey)},HDPublicKey.Hardened=2147483648,HDPublicKey.RootElementAlias=["m","M"],HDPublicKey.VersionSize=4,HDPublicKey.DepthSize=1,HDPublicKey.ParentFingerPrintSize=4,HDPublicKey.ChildIndexSize=4,HDPublicKey.ChainCodeSize=32,HDPublicKey.PublicKeySize=33,HDPublicKey.CheckSumSize=4,HDPublicKey.DataSize=78,HDPublicKey.SerializedByteSize=82,HDPublicKey.VersionStart=0,HDPublicKey.VersionEnd=HDPublicKey.VersionStart+HDPublicKey.VersionSize,HDPublicKey.DepthStart=HDPublicKey.VersionEnd,HDPublicKey.DepthEnd=HDPublicKey.DepthStart+HDPublicKey.DepthSize,HDPublicKey.ParentFingerPrintStart=HDPublicKey.DepthEnd,HDPublicKey.ParentFingerPrintEnd=HDPublicKey.ParentFingerPrintStart+HDPublicKey.ParentFingerPrintSize,HDPublicKey.ChildIndexStart=HDPublicKey.ParentFingerPrintEnd,HDPublicKey.ChildIndexEnd=HDPublicKey.ChildIndexStart+HDPublicKey.ChildIndexSize,HDPublicKey.ChainCodeStart=HDPublicKey.ChildIndexEnd,HDPublicKey.ChainCodeEnd=HDPublicKey.ChainCodeStart+HDPublicKey.ChainCodeSize,HDPublicKey.PublicKeyStart=HDPublicKey.ChainCodeEnd,HDPublicKey.PublicKeyEnd=HDPublicKey.PublicKeyStart+HDPublicKey.PublicKeySize,HDPublicKey.ChecksumStart=HDPublicKey.PublicKeyEnd,HDPublicKey.ChecksumEnd=HDPublicKey.ChecksumStart+HDPublicKey.CheckSumSize,assert(HDPublicKey.PublicKeyEnd===HDPublicKey.DataSize),assert(HDPublicKey.ChecksumEnd===HDPublicKey.SerializedByteSize),module.exports=HDPublicKey}).call(this,require("buffer").Buffer)},{"./crypto/bn":40,"./crypto/hash":42,"./crypto/point":43,"./encoding/base58":46,"./encoding/base58check":47,"./errors":51,"./hdkeycache":53,"./hdprivatekey":54,"./networks":56,"./publickey":59,"./util/buffer":77,"./util/js":78,"./util/preconditions":79,assert:25,buffer:151,lodash:105}],56:[function(require,module,exports){"use strict";function Network(){}function get(arg,keys){if(~networks.indexOf(arg))return arg;{if(!keys)return networkMaps[arg];_.isArray(keys)||(keys=[keys]);var containsArg=function(key){return networks[index][key]===arg};for(var index in networks)if(_.any(keys,containsArg))return networks[index]}}function addNetwork(data){var network=new Network;return JSUtil.defineImmutable(network,{name:data.name,alias:data.alias,pubkeyhash:data.pubkeyhash,privatekey:data.privatekey,scripthash:data.scripthash,xpubkey:data.xpubkey,xprivkey:data.xprivkey}),data.networkMagic&&JSUtil.defineImmutable(network,{networkMagic:BufferUtil.integerAsBuffer(data.networkMagic)}),data.port&&JSUtil.defineImmutable(network,{port:data.port}),data.dnsSeeds&&JSUtil.defineImmutable(network,{dnsSeeds:data.dnsSeeds}),_.each(network,function(value){_.isUndefined(value)||_.isObject(value)||(networkMaps[value]=network)}),networks.push(network),network}function removeNetwork(network){for(var i=0;i<networks.length;i++)networks[i]===network&&networks.splice(i,1);for(var key in networkMaps)networkMaps[key]===network&&delete networkMaps[key]}function enableRegtest(){testnet.regtestEnabled=!0}function disableRegtest(){testnet.regtestEnabled=!1}var _=require("lodash"),BufferUtil=require("./util/buffer"),JSUtil=require("./util/js"),networks=[],networkMaps={};Network.prototype.toString=function(){return this.name},addNetwork({name:"livenet",alias:"mainnet",pubkeyhash:0,privatekey:128,scripthash:5,xpubkey:76067358,xprivkey:76066276,networkMagic:4190024921,port:8333,dnsSeeds:["seed.bitcoin.sipa.be","dnsseed.bluematt.me","dnsseed.bitcoin.dashjr.org","seed.bitcoinstats.com","seed.bitnodes.io","bitseed.xf2.org"]});var livenet=get("livenet");addNetwork({name:"testnet",alias:"regtest",pubkeyhash:111,privatekey:239,scripthash:196,xpubkey:70617039,xprivkey:70615956});var testnet=get("testnet"),TESTNET={PORT:18333,NETWORK_MAGIC:BufferUtil.integerAsBuffer(185665799),DNS_SEEDS:["testnet-seed.bitcoin.petertodd.org","testnet-seed.bluematt.me","testnet-seed.alexykot.me","testnet-seed.bitcoin.schildbach.de"]};for(var key in TESTNET)_.isObject(TESTNET[key])||(networkMaps[TESTNET[key]]=testnet);var REGTEST={PORT:18444,NETWORK_MAGIC:BufferUtil.integerAsBuffer(4206867930),DNS_SEEDS:[]};for(var key in REGTEST)_.isObject(REGTEST[key])||(networkMaps[REGTEST[key]]=testnet);Object.defineProperty(testnet,"port",{enumerable:!0,configurable:!1,get:function(){return this.regtestEnabled?REGTEST.PORT:TESTNET.PORT}}),Object.defineProperty(testnet,"networkMagic",{enumerable:!0,configurable:!1,get:function(){return this.regtestEnabled?REGTEST.NETWORK_MAGIC:TESTNET.NETWORK_MAGIC}}),Object.defineProperty(testnet,"dnsSeeds",{enumerable:!0,configurable:!1,get:function(){return this.regtestEnabled?REGTEST.DNS_SEEDS:TESTNET.DNS_SEEDS}}),module.exports={add:addNetwork,remove:removeNetwork,defaultNetwork:livenet,livenet:livenet,mainnet:livenet,testnet:testnet,get:get,enableRegtest:enableRegtest,disableRegtest:disableRegtest}},{"./util/buffer":77,"./util/js":78,lodash:105}],57:[function(require,module,exports){(function(Buffer){"use strict";function Opcode(num){if(!(this instanceof Opcode))return new Opcode(num);var value;if(_.isNumber(num))value=num;else{if(!_.isString(num))throw new TypeError('Unrecognized num type: "'+typeof num+'" for Opcode');value=Opcode.map[num]}return JSUtil.defineImmutable(this,{num:value}),this}var _=require("lodash"),$=require("./util/preconditions"),BufferUtil=require("./util/buffer"),JSUtil=require("./util/js");Opcode.fromBuffer=function(buf){return $.checkArgument(BufferUtil.isBuffer(buf)),new Opcode(Number("0x"+buf.toString("hex")))},Opcode.fromNumber=function(num){return $.checkArgument(_.isNumber(num)),new Opcode(num)},Opcode.fromString=function(str){$.checkArgument(_.isString(str));var value=Opcode.map[str];if("undefined"==typeof value)throw new TypeError("Invalid opcodestr");return new Opcode(value)},Opcode.prototype.toHex=function(){return this.num.toString(16)},Opcode.prototype.toBuffer=function(){return new Buffer(this.toHex(),"hex")},Opcode.prototype.toNumber=function(){return this.num},Opcode.prototype.toString=function(){var str=Opcode.reverseMap[this.num];if("undefined"==typeof str)throw new Error("Opcode does not have a string representation");return str},Opcode.smallInt=function(n){return $.checkArgument(_.isNumber(n),"Invalid Argument: n should be number"),$.checkArgument(n>=0&&n<=16,"Invalid Argument: n must be between 0 and 16"),0===n?Opcode("OP_0"):new Opcode(Opcode.map.OP_1+n-1)},Opcode.map={OP_FALSE:0,OP_0:0,OP_PUSHDATA1:76,OP_PUSHDATA2:77,OP_PUSHDATA4:78,OP_1NEGATE:79,OP_RESERVED:80,OP_TRUE:81,OP_1:81,OP_2:82,OP_3:83,OP_4:84,OP_5:85,OP_6:86,OP_7:87,OP_8:88,OP_9:89,OP_10:90,OP_11:91,OP_12:92,OP_13:93,OP_14:94,OP_15:95,OP_16:96,OP_NOP:97,OP_VER:98,OP_IF:99,OP_NOTIF:100,OP_VERIF:101,OP_VERNOTIF:102,OP_ELSE:103,OP_ENDIF:104,OP_VERIFY:105,OP_RETURN:106,OP_TOALTSTACK:107,OP_FROMALTSTACK:108,OP_2DROP:109,OP_2DUP:110,OP_3DUP:111,OP_2OVER:112,OP_2ROT:113,OP_2SWAP:114,OP_IFDUP:115,OP_DEPTH:116,OP_DROP:117,OP_DUP:118,OP_NIP:119,OP_OVER:120,OP_PICK:121,OP_ROLL:122,OP_ROT:123,OP_SWAP:124,OP_TUCK:125,OP_CAT:126,OP_SUBSTR:127,OP_LEFT:128,OP_RIGHT:129,OP_SIZE:130,OP_INVERT:131,OP_AND:132,OP_OR:133,OP_XOR:134,OP_EQUAL:135,OP_EQUALVERIFY:136,OP_RESERVED1:137,OP_RESERVED2:138,OP_1ADD:139,OP_1SUB:140,OP_2MUL:141,OP_2DIV:142,OP_NEGATE:143,OP_ABS:144,OP_NOT:145,OP_0NOTEQUAL:146,OP_ADD:147,OP_SUB:148,OP_MUL:149,OP_DIV:150,OP_MOD:151,OP_LSHIFT:152,OP_RSHIFT:153,OP_BOOLAND:154,OP_BOOLOR:155,OP_NUMEQUAL:156,OP_NUMEQUALVERIFY:157,OP_NUMNOTEQUAL:158,OP_LESSTHAN:159,OP_GREATERTHAN:160,OP_LESSTHANOREQUAL:161,OP_GREATERTHANOREQUAL:162,OP_MIN:163,OP_MAX:164,OP_WITHIN:165,OP_RIPEMD160:166,OP_SHA1:167,OP_SHA256:168,OP_HASH160:169,OP_HASH256:170,OP_CODESEPARATOR:171,OP_CHECKSIG:172,OP_CHECKSIGVERIFY:173,OP_CHECKMULTISIG:174,OP_CHECKMULTISIGVERIFY:175,OP_CHECKLOCKTIMEVERIFY:177,OP_NOP1:176,OP_NOP2:177,OP_NOP3:178,OP_NOP4:179,OP_NOP5:180,OP_NOP6:181,OP_NOP7:182,OP_NOP8:183,OP_NOP9:184,OP_NOP10:185,OP_PUBKEYHASH:253,OP_PUBKEY:254,OP_INVALIDOPCODE:255},Opcode.reverseMap=[];for(var k in Opcode.map)Opcode.reverseMap[Opcode.map[k]]=k;_.extend(Opcode,Opcode.map),Opcode.isSmallIntOp=function(opcode){return opcode instanceof Opcode&&(opcode=opcode.toNumber()),opcode===Opcode.map.OP_0||opcode>=Opcode.map.OP_1&&opcode<=Opcode.map.OP_16},Opcode.prototype.inspect=function(){return"<Opcode: "+this.toString()+", hex: "+this.toHex()+", decimal: "+this.num+">"},module.exports=Opcode}).call(this,require("buffer").Buffer)},{"./util/buffer":77,"./util/js":78,"./util/preconditions":79,buffer:151,lodash:105}],58:[function(require,module,exports){(function(Buffer){"use strict";function PrivateKey(data,network){if(!(this instanceof PrivateKey))return new PrivateKey(data,network);if(data instanceof PrivateKey)return data;var info=this._classifyArguments(data,network);if(!info.bn||0===info.bn.cmp(new BN(0)))throw new TypeError("Number can not be equal to zero, undefined, null or false");if(!info.bn.lt(Point.getN()))throw new TypeError("Number must be less than N");if("undefined"==typeof info.network)throw new TypeError('Must specify the network ("livenet" or "testnet")');return JSUtil.defineImmutable(this,{bn:info.bn,compressed:info.compressed,network:info.network}),Object.defineProperty(this,"publicKey",{configurable:!1,enumerable:!0,get:this.toPublicKey.bind(this)}),this}var _=require("lodash"),Address=require("./address"),Base58Check=require("./encoding/base58check"),BN=require("./crypto/bn"),JSUtil=require("./util/js"),Networks=require("./networks"),Point=require("./crypto/point"),PublicKey=require("./publickey"),Random=require("./crypto/random"),$=require("./util/preconditions");PrivateKey.prototype._classifyArguments=function(data,network){var info={compressed:!0,network:network?Networks.get(network):Networks.defaultNetwork};if(_.isUndefined(data)||_.isNull(data))info.bn=PrivateKey._getRandomBN();else if(data instanceof BN)info.bn=data;else if(data instanceof Buffer||data instanceof Uint8Array)info=PrivateKey._transformBuffer(data,network);else if(data.bn&&data.network)info=PrivateKey._transformObject(data);else if(!network&&Networks.get(data))info.bn=PrivateKey._getRandomBN(),info.network=Networks.get(data);else{if("string"!=typeof data)throw new TypeError("First argument is an unrecognized data type.");JSUtil.isHexa(data)?info.bn=new BN(new Buffer(data,"hex")):info=PrivateKey._transformWIF(data,network)}return info},PrivateKey._getRandomBN=function(){var condition,bn;do{var privbuf=Random.getRandomBuffer(32);bn=BN.fromBuffer(privbuf),condition=bn.lt(Point.getN())}while(!condition);return bn},PrivateKey._transformBuffer=function(buf,network){var info={};if(32===buf.length)return PrivateKey._transformBNBuffer(buf,network);if(info.network=Networks.get(buf[0],"privatekey"),!info.network)throw new Error("Invalid network");if(network&&info.network!==Networks.get(network))throw new TypeError("Private key network mismatch");if(34===buf.length&&1===buf[33])info.compressed=!0;else{if(33!==buf.length)throw new Error("Length of buffer must be 33 (uncompressed) or 34 (compressed)");info.compressed=!1}return info.bn=BN.fromBuffer(buf.slice(1,33)),info},PrivateKey._transformBNBuffer=function(buf,network){var info={};return info.network=Networks.get(network)||Networks.defaultNetwork,info.bn=BN.fromBuffer(buf),info.compressed=!1,info},PrivateKey._transformWIF=function(str,network){return PrivateKey._transformBuffer(Base58Check.decode(str),network)},PrivateKey.fromBuffer=function(arg,network){return new PrivateKey(arg,network)},PrivateKey._transformObject=function(json){var bn=new BN(json.bn,"hex"),network=Networks.get(json.network);return{bn:bn,network:network,compressed:json.compressed}},PrivateKey.fromString=PrivateKey.fromWIF=function(str){return $.checkArgument(_.isString(str),"First argument is expected to be a string."),new PrivateKey(str)},PrivateKey.fromObject=function(obj){return $.checkArgument(_.isObject(obj),"First argument is expected to be an object."),new PrivateKey(obj)},PrivateKey.fromRandom=function(network){var bn=PrivateKey._getRandomBN();return new PrivateKey(bn,network)},PrivateKey.getValidationError=function(data,network){var error;try{new PrivateKey(data,network)}catch(e){error=e}return error},PrivateKey.isValid=function(data,network){return!!data&&!PrivateKey.getValidationError(data,network)},PrivateKey.prototype.toString=function(){return this.toBuffer().toString("hex")},PrivateKey.prototype.toWIF=function(){var buf,network=this.network,compressed=this.compressed;return buf=compressed?Buffer.concat([new Buffer([network.privatekey]),this.bn.toBuffer({size:32}),new Buffer([1])]):Buffer.concat([new Buffer([network.privatekey]),this.bn.toBuffer({size:32})]),Base58Check.encode(buf)},PrivateKey.prototype.toBigNumber=function(){return this.bn},PrivateKey.prototype.toBuffer=function(){return this.bn.toBuffer()},PrivateKey.prototype.toPublicKey=function(){return this._pubkey||(this._pubkey=PublicKey.fromPrivateKey(this)),this._pubkey},PrivateKey.prototype.toAddress=function(network){var pubkey=this.toPublicKey();return Address.fromPublicKey(pubkey,network||this.network)},PrivateKey.prototype.toObject=PrivateKey.prototype.toJSON=function(){return{bn:this.bn.toString("hex"),compressed:this.compressed,network:this.network.toString()}},PrivateKey.prototype.inspect=function(){var uncompressed=this.compressed?"":", uncompressed";return"<PrivateKey: "+this.toString()+", network: "+this.network+uncompressed+">"},module.exports=PrivateKey}).call(this,require("buffer").Buffer)},{"./address":35,"./crypto/bn":40,"./crypto/point":43,"./crypto/random":44,"./encoding/base58check":47,"./networks":56,"./publickey":59,"./util/js":78,"./util/preconditions":79,buffer:151,lodash:105}],59:[function(require,module,exports){(function(Buffer){"use strict";function PublicKey(data,extra){if(!(this instanceof PublicKey))return new PublicKey(data,extra);if($.checkArgument(data,"First argument is required, please include public key data."),data instanceof PublicKey)return data;extra=extra||{};var info=this._classifyArgs(data,extra);return info.point.validate(),JSUtil.defineImmutable(this,{point:info.point,compressed:info.compressed,network:info.network||Network.defaultNetwork}),this}var BN=require("./crypto/bn"),Point=require("./crypto/point"),Hash=require("./crypto/hash"),JSUtil=require("./util/js"),Network=require("./networks"),_=require("lodash"),$=require("./util/preconditions");PublicKey.prototype._classifyArgs=function(data,extra){var info={compressed:_.isUndefined(extra.compressed)||extra.compressed};if(data instanceof Point)info.point=data;else if(data.x&&data.y)info=PublicKey._transformObject(data);else if("string"==typeof data)info=PublicKey._transformDER(new Buffer(data,"hex"));else if(PublicKey._isBuffer(data))info=PublicKey._transformDER(data);else{if(!PublicKey._isPrivateKey(data))throw new TypeError("First argument is an unrecognized data format.");info=PublicKey._transformPrivateKey(data)}return info.network||(info.network=_.isUndefined(extra.network)?void 0:Network.get(extra.network)),info},PublicKey._isPrivateKey=function(param){var PrivateKey=require("./privatekey");return param instanceof PrivateKey},PublicKey._isBuffer=function(param){return param instanceof Buffer||param instanceof Uint8Array},PublicKey._transformPrivateKey=function(privkey){$.checkArgument(PublicKey._isPrivateKey(privkey),"Must be an instance of PrivateKey");var info={};return info.point=Point.getG().mul(privkey.bn),info.compressed=privkey.compressed,info.network=privkey.network,info},PublicKey._transformDER=function(buf,strict){$.checkArgument(PublicKey._isBuffer(buf),"Must be a hex buffer of DER encoded public key");var info={};strict=!!_.isUndefined(strict)||strict;var x,y,xbuf,ybuf;if(4!==buf[0]&&(strict||6!==buf[0]&&7!==buf[0]))if(3===buf[0])xbuf=buf.slice(1),x=new BN(xbuf),info=PublicKey._transformX(!0,x),info.compressed=!0;else{if(2!==buf[0])throw new TypeError("Invalid DER format public key");xbuf=buf.slice(1),x=new BN(xbuf),info=PublicKey._transformX(!1,x),info.compressed=!0}else{if(xbuf=buf.slice(1,33),ybuf=buf.slice(33,65),32!==xbuf.length||32!==ybuf.length||65!==buf.length)throw new TypeError("Length of x and y must be 32 bytes");x=new BN(xbuf),y=new BN(ybuf),info.point=new Point(x,y),info.compressed=!1}return info},PublicKey._transformX=function(odd,x){$.checkArgument("boolean"==typeof odd,"Must specify whether y is odd or not (true or false)");var info={};return info.point=Point.fromX(odd,x),info},PublicKey._transformObject=function(json){var x=new BN(json.x,"hex"),y=new BN(json.y,"hex"),point=new Point(x,y);return new PublicKey(point,{compressed:json.compressed})},PublicKey.fromPrivateKey=function(privkey){$.checkArgument(PublicKey._isPrivateKey(privkey),"Must be an instance of PrivateKey");var info=PublicKey._transformPrivateKey(privkey);return new PublicKey(info.point,{compressed:info.compressed,network:info.network})},PublicKey.fromDER=PublicKey.fromBuffer=function(buf,strict){$.checkArgument(PublicKey._isBuffer(buf),"Must be a hex buffer of DER encoded public key");var info=PublicKey._transformDER(buf,strict);return new PublicKey(info.point,{compressed:info.compressed})},PublicKey.fromPoint=function(point,compressed){return $.checkArgument(point instanceof Point,"First argument must be an instance of Point."),new PublicKey(point,{compressed:compressed})},PublicKey.fromString=function(str,encoding){var buf=new Buffer(str,encoding||"hex"),info=PublicKey._transformDER(buf);return new PublicKey(info.point,{compressed:info.compressed})},PublicKey.fromX=function(odd,x){var info=PublicKey._transformX(odd,x);return new PublicKey(info.point,{compressed:info.compressed})},PublicKey.getValidationError=function(data){var error;try{new PublicKey(data)}catch(e){error=e}return error},PublicKey.isValid=function(data){return!PublicKey.getValidationError(data)},PublicKey.prototype.toObject=PublicKey.prototype.toJSON=function(){return{x:this.point.getX().toString("hex",2),y:this.point.getY().toString("hex",2),compressed:this.compressed}},PublicKey.prototype.toBuffer=PublicKey.prototype.toDER=function(){var prefix,x=this.point.getX(),y=this.point.getY(),xbuf=x.toBuffer({size:32}),ybuf=y.toBuffer({size:32});if(this.compressed){var odd=ybuf[ybuf.length-1]%2;return prefix=new Buffer(odd?[3]:[2]),Buffer.concat([prefix,xbuf])}return prefix=new Buffer([4]),Buffer.concat([prefix,xbuf,ybuf])},PublicKey.prototype._getID=function(){return Hash.sha256ripemd160(this.toBuffer())},PublicKey.prototype.toAddress=function(network){var Address=require("./address");return Address.fromPublicKey(this,network||this.network)},PublicKey.prototype.toString=function(){return this.toDER().toString("hex")},PublicKey.prototype.inspect=function(){return"<PublicKey: "+this.toString()+(this.compressed?"":", uncompressed")+">"},module.exports=PublicKey}).call(this,require("buffer").Buffer)},{"./address":35,"./crypto/bn":40,"./crypto/hash":42,"./crypto/point":43,"./networks":56,"./privatekey":58,"./util/js":78,"./util/preconditions":79,buffer:151,lodash:105}],60:[function(require,module,exports){module.exports=require("./script"),module.exports.Interpreter=require("./interpreter")},{"./interpreter":61,"./script":62}],61:[function(require,module,exports){(function(Buffer){"use strict";var _=require("lodash"),Script=require("./script"),Opcode=require("../opcode"),BN=require("../crypto/bn"),Hash=require("../crypto/hash"),Signature=require("../crypto/signature"),PublicKey=require("../publickey"),Interpreter=function Interpreter(obj){return this instanceof Interpreter?void(obj?(this.initialize(),this.set(obj)):this.initialize()):new Interpreter(obj)};Interpreter.prototype.verify=function(scriptSig,scriptPubkey,tx,nin,flags){var Transaction=require("../transaction");_.isUndefined(tx)&&(tx=new Transaction),_.isUndefined(nin)&&(nin=0),_.isUndefined(flags)&&(flags=0),this.set({script:scriptSig,tx:tx,nin:nin,flags:flags});var stackCopy;if(0!==(flags&Interpreter.SCRIPT_VERIFY_SIGPUSHONLY)&&!scriptSig.isPushOnly())return this.errstr="SCRIPT_ERR_SIG_PUSHONLY",!1;if(!this.evaluate())return!1;flags&Interpreter.SCRIPT_VERIFY_P2SH&&(stackCopy=this.stack.slice());var stack=this.stack;if(this.initialize(),this.set({script:scriptPubkey,stack:stack,tx:tx,nin:nin,flags:flags}),!this.evaluate())return!1;if(0===this.stack.length)return this.errstr="SCRIPT_ERR_EVAL_FALSE_NO_RESULT",!1;var buf=this.stack[this.stack.length-1];if(!Interpreter.castToBool(buf))return this.errstr="SCRIPT_ERR_EVAL_FALSE_IN_STACK",!1;if(flags&Interpreter.SCRIPT_VERIFY_P2SH&&scriptPubkey.isScriptHashOut()){if(!scriptSig.isPushOnly())return this.errstr="SCRIPT_ERR_SIG_PUSHONLY",!1;if(0===stackCopy.length)throw new Error("internal error - stack copy empty");var redeemScriptSerialized=stackCopy[stackCopy.length-1],redeemScript=Script.fromBuffer(redeemScriptSerialized);return stackCopy.pop(),this.initialize(),this.set({script:redeemScript,stack:stackCopy,tx:tx,nin:nin,flags:flags}),!!this.evaluate()&&(0===stackCopy.length?(this.errstr="SCRIPT_ERR_EVAL_FALSE_NO_P2SH_STACK",!1):!!Interpreter.castToBool(stackCopy[stackCopy.length-1])||(this.errstr="SCRIPT_ERR_EVAL_FALSE_IN_P2SH_STACK",!1))}return!0},module.exports=Interpreter,Interpreter.prototype.initialize=function(obj){this.stack=[],this.altstack=[],this.pc=0,this.pbegincodehash=0,this.nOpCount=0,this.vfExec=[],this.errstr="",this.flags=0},Interpreter.prototype.set=function(obj){this.script=obj.script||this.script,this.tx=obj.tx||this.tx,this.nin="undefined"!=typeof obj.nin?obj.nin:this.nin,this.stack=obj.stack||this.stack,this.altstack=obj.altack||this.altstack,this.pc="undefined"!=typeof obj.pc?obj.pc:this.pc,this.pbegincodehash="undefined"!=typeof obj.pbegincodehash?obj.pbegincodehash:this.pbegincodehash,this.nOpCount="undefined"!=typeof obj.nOpCount?obj.nOpCount:this.nOpCount,this.vfExec=obj.vfExec||this.vfExec,this.errstr=obj.errstr||this.errstr,this.flags="undefined"!=typeof obj.flags?obj.flags:this.flags},Interpreter["true"]=new Buffer([1]),Interpreter["false"]=new Buffer([]),Interpreter.MAX_SCRIPT_ELEMENT_SIZE=520,Interpreter.LOCKTIME_THRESHOLD=5e8,Interpreter.LOCKTIME_THRESHOLD_BN=new BN(Interpreter.LOCKTIME_THRESHOLD),Interpreter.SCRIPT_VERIFY_NONE=0,Interpreter.SCRIPT_VERIFY_P2SH=1,Interpreter.SCRIPT_VERIFY_STRICTENC=2,Interpreter.SCRIPT_VERIFY_DERSIG=4,Interpreter.SCRIPT_VERIFY_LOW_S=8,Interpreter.SCRIPT_VERIFY_NULLDUMMY=16,Interpreter.SCRIPT_VERIFY_SIGPUSHONLY=32,Interpreter.SCRIPT_VERIFY_MINIMALDATA=64,Interpreter.SCRIPT_VERIFY_DISCOURAGE_UPGRADABLE_NOPS=128,Interpreter.SCRIPT_VERIFY_CHECKLOCKTIMEVERIFY=512,Interpreter.castToBool=function(buf){for(var i=0;i<buf.length;i++)if(0!==buf[i])return i!==buf.length-1||128!==buf[i];return!1},Interpreter.prototype.checkSignatureEncoding=function(buf){var sig;if(0!==(this.flags&(Interpreter.SCRIPT_VERIFY_DERSIG|Interpreter.SCRIPT_VERIFY_LOW_S|Interpreter.SCRIPT_VERIFY_STRICTENC))&&!Signature.isTxDER(buf))return this.errstr="SCRIPT_ERR_SIG_DER_INVALID_FORMAT",!1;if(0!==(this.flags&Interpreter.SCRIPT_VERIFY_LOW_S)){if(sig=Signature.fromTxFormat(buf),!sig.hasLowS())return this.errstr="SCRIPT_ERR_SIG_DER_HIGH_S",!1}else if(0!==(this.flags&Interpreter.SCRIPT_VERIFY_STRICTENC)&&(sig=Signature.fromTxFormat(buf),!sig.hasDefinedHashtype()))return this.errstr="SCRIPT_ERR_SIG_HASHTYPE",!1;return!0},Interpreter.prototype.checkPubkeyEncoding=function(buf){return!(0!==(this.flags&Interpreter.SCRIPT_VERIFY_STRICTENC)&&!PublicKey.isValid(buf))||(this.errstr="SCRIPT_ERR_PUBKEYTYPE",!1)},Interpreter.prototype.evaluate=function(){if(this.script.toBuffer().length>1e4)return this.errstr="SCRIPT_ERR_SCRIPT_SIZE",!1;try{for(;this.pc<this.script.chunks.length;){var fSuccess=this.step();if(!fSuccess)return!1}if(this.stack.length+this.altstack.length>1e3)return this.errstr="SCRIPT_ERR_STACK_SIZE",!1}catch(e){return this.errstr="SCRIPT_ERR_UNKNOWN_ERROR: "+e,!1}return!(this.vfExec.length>0)||(this.errstr="SCRIPT_ERR_UNBALANCED_CONDITIONAL",!1)},Interpreter.prototype.checkLockTime=function(nLockTime){return!!(this.tx.nLockTime<Interpreter.LOCKTIME_THRESHOLD&&nLockTime.lt(Interpreter.LOCKTIME_THRESHOLD_BN)||this.tx.nLockTime>=Interpreter.LOCKTIME_THRESHOLD&&nLockTime.gte(Interpreter.LOCKTIME_THRESHOLD_BN))&&(!nLockTime.gt(new BN(this.tx.nLockTime))&&!!this.tx.inputs[this.nin].isFinal());
},Interpreter.prototype.step=function(){var buf,buf1,buf2,spliced,n,x1,x2,bn,bn1,bn2,bufSig,bufPubkey,subscript,sig,pubkey,fValue,fSuccess,fRequireMinimal=0!==(this.flags&Interpreter.SCRIPT_VERIFY_MINIMALDATA),fExec=this.vfExec.indexOf(!1)===-1,chunk=this.script.chunks[this.pc];this.pc++;var opcodenum=chunk.opcodenum;if(_.isUndefined(opcodenum))return this.errstr="SCRIPT_ERR_UNDEFINED_OPCODE",!1;if(chunk.buf&&chunk.buf.length>Interpreter.MAX_SCRIPT_ELEMENT_SIZE)return this.errstr="SCRIPT_ERR_PUSH_SIZE",!1;if(opcodenum>Opcode.OP_16&&++this.nOpCount>201)return this.errstr="SCRIPT_ERR_OP_COUNT",!1;if(opcodenum===Opcode.OP_CAT||opcodenum===Opcode.OP_SUBSTR||opcodenum===Opcode.OP_LEFT||opcodenum===Opcode.OP_RIGHT||opcodenum===Opcode.OP_INVERT||opcodenum===Opcode.OP_AND||opcodenum===Opcode.OP_OR||opcodenum===Opcode.OP_XOR||opcodenum===Opcode.OP_2MUL||opcodenum===Opcode.OP_2DIV||opcodenum===Opcode.OP_MUL||opcodenum===Opcode.OP_DIV||opcodenum===Opcode.OP_MOD||opcodenum===Opcode.OP_LSHIFT||opcodenum===Opcode.OP_RSHIFT)return this.errstr="SCRIPT_ERR_DISABLED_OPCODE",!1;if(fExec&&0<=opcodenum&&opcodenum<=Opcode.OP_PUSHDATA4){if(fRequireMinimal&&!this.script.checkMinimalPush(this.pc-1))return this.errstr="SCRIPT_ERR_MINIMALDATA",!1;if(chunk.buf){if(chunk.len!==chunk.buf.length)throw new Error("Length of push value not equal to length of data");this.stack.push(chunk.buf)}else this.stack.push(Interpreter["false"])}else if(fExec||Opcode.OP_IF<=opcodenum&&opcodenum<=Opcode.OP_ENDIF)switch(opcodenum){case Opcode.OP_1NEGATE:case Opcode.OP_1:case Opcode.OP_2:case Opcode.OP_3:case Opcode.OP_4:case Opcode.OP_5:case Opcode.OP_6:case Opcode.OP_7:case Opcode.OP_8:case Opcode.OP_9:case Opcode.OP_10:case Opcode.OP_11:case Opcode.OP_12:case Opcode.OP_13:case Opcode.OP_14:case Opcode.OP_15:case Opcode.OP_16:n=opcodenum-(Opcode.OP_1-1),buf=new BN(n).toScriptNumBuffer(),this.stack.push(buf);break;case Opcode.OP_NOP:break;case Opcode.OP_NOP2:case Opcode.OP_CHECKLOCKTIMEVERIFY:if(!(this.flags&Interpreter.SCRIPT_VERIFY_CHECKLOCKTIMEVERIFY)){if(this.flags&Interpreter.SCRIPT_VERIFY_DISCOURAGE_UPGRADABLE_NOPS)return this.errstr="SCRIPT_ERR_DISCOURAGE_UPGRADABLE_NOPS",!1;break}if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;var nLockTime=BN.fromScriptNumBuffer(this.stack[this.stack.length-1],fRequireMinimal,5);if(nLockTime.lt(new BN(0)))return this.errstr="SCRIPT_ERR_NEGATIVE_LOCKTIME",!1;if(!this.checkLockTime(nLockTime))return this.errstr="SCRIPT_ERR_UNSATISFIED_LOCKTIME",!1;break;case Opcode.OP_NOP1:case Opcode.OP_NOP3:case Opcode.OP_NOP4:case Opcode.OP_NOP5:case Opcode.OP_NOP6:case Opcode.OP_NOP7:case Opcode.OP_NOP8:case Opcode.OP_NOP9:case Opcode.OP_NOP10:if(this.flags&Interpreter.SCRIPT_VERIFY_DISCOURAGE_UPGRADABLE_NOPS)return this.errstr="SCRIPT_ERR_DISCOURAGE_UPGRADABLE_NOPS",!1;break;case Opcode.OP_IF:case Opcode.OP_NOTIF:if(fValue=!1,fExec){if(this.stack.length<1)return this.errstr="SCRIPT_ERR_UNBALANCED_CONDITIONAL",!1;buf=this.stack.pop(),fValue=Interpreter.castToBool(buf),opcodenum===Opcode.OP_NOTIF&&(fValue=!fValue)}this.vfExec.push(fValue);break;case Opcode.OP_ELSE:if(0===this.vfExec.length)return this.errstr="SCRIPT_ERR_UNBALANCED_CONDITIONAL",!1;this.vfExec[this.vfExec.length-1]=!this.vfExec[this.vfExec.length-1];break;case Opcode.OP_ENDIF:if(0===this.vfExec.length)return this.errstr="SCRIPT_ERR_UNBALANCED_CONDITIONAL",!1;this.vfExec.pop();break;case Opcode.OP_VERIFY:if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;if(buf=this.stack[this.stack.length-1],fValue=Interpreter.castToBool(buf),!fValue)return this.errstr="SCRIPT_ERR_VERIFY",!1;this.stack.pop();break;case Opcode.OP_RETURN:return this.errstr="SCRIPT_ERR_OP_RETURN",!1;case Opcode.OP_TOALTSTACK:if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;this.altstack.push(this.stack.pop());break;case Opcode.OP_FROMALTSTACK:if(this.altstack.length<1)return this.errstr="SCRIPT_ERR_INVALID_ALTSTACK_OPERATION",!1;this.stack.push(this.altstack.pop());break;case Opcode.OP_2DROP:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;this.stack.pop(),this.stack.pop();break;case Opcode.OP_2DUP:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;buf1=this.stack[this.stack.length-2],buf2=this.stack[this.stack.length-1],this.stack.push(buf1),this.stack.push(buf2);break;case Opcode.OP_3DUP:if(this.stack.length<3)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;buf1=this.stack[this.stack.length-3],buf2=this.stack[this.stack.length-2];var buf3=this.stack[this.stack.length-1];this.stack.push(buf1),this.stack.push(buf2),this.stack.push(buf3);break;case Opcode.OP_2OVER:if(this.stack.length<4)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;buf1=this.stack[this.stack.length-4],buf2=this.stack[this.stack.length-3],this.stack.push(buf1),this.stack.push(buf2);break;case Opcode.OP_2ROT:if(this.stack.length<6)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;spliced=this.stack.splice(this.stack.length-6,2),this.stack.push(spliced[0]),this.stack.push(spliced[1]);break;case Opcode.OP_2SWAP:if(this.stack.length<4)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;spliced=this.stack.splice(this.stack.length-4,2),this.stack.push(spliced[0]),this.stack.push(spliced[1]);break;case Opcode.OP_IFDUP:if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;buf=this.stack[this.stack.length-1],fValue=Interpreter.castToBool(buf),fValue&&this.stack.push(buf);break;case Opcode.OP_DEPTH:buf=new BN(this.stack.length).toScriptNumBuffer(),this.stack.push(buf);break;case Opcode.OP_DROP:if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;this.stack.pop();break;case Opcode.OP_DUP:if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;this.stack.push(this.stack[this.stack.length-1]);break;case Opcode.OP_NIP:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;this.stack.splice(this.stack.length-2,1);break;case Opcode.OP_OVER:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;this.stack.push(this.stack[this.stack.length-2]);break;case Opcode.OP_PICK:case Opcode.OP_ROLL:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;if(buf=this.stack[this.stack.length-1],bn=BN.fromScriptNumBuffer(buf,fRequireMinimal),n=bn.toNumber(),this.stack.pop(),n<0||n>=this.stack.length)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;buf=this.stack[this.stack.length-n-1],opcodenum===Opcode.OP_ROLL&&this.stack.splice(this.stack.length-n-1,1),this.stack.push(buf);break;case Opcode.OP_ROT:if(this.stack.length<3)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;x1=this.stack[this.stack.length-3],x2=this.stack[this.stack.length-2];var x3=this.stack[this.stack.length-1];this.stack[this.stack.length-3]=x2,this.stack[this.stack.length-2]=x3,this.stack[this.stack.length-1]=x1;break;case Opcode.OP_SWAP:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;x1=this.stack[this.stack.length-2],x2=this.stack[this.stack.length-1],this.stack[this.stack.length-2]=x2,this.stack[this.stack.length-1]=x1;break;case Opcode.OP_TUCK:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;this.stack.splice(this.stack.length-2,0,this.stack[this.stack.length-1]);break;case Opcode.OP_SIZE:if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;bn=new BN(this.stack[this.stack.length-1].length),this.stack.push(bn.toScriptNumBuffer());break;case Opcode.OP_EQUAL:case Opcode.OP_EQUALVERIFY:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;buf1=this.stack[this.stack.length-2],buf2=this.stack[this.stack.length-1];var fEqual=buf1.toString("hex")===buf2.toString("hex");if(this.stack.pop(),this.stack.pop(),this.stack.push(fEqual?Interpreter["true"]:Interpreter["false"]),opcodenum===Opcode.OP_EQUALVERIFY){if(!fEqual)return this.errstr="SCRIPT_ERR_EQUALVERIFY",!1;this.stack.pop()}break;case Opcode.OP_1ADD:case Opcode.OP_1SUB:case Opcode.OP_NEGATE:case Opcode.OP_ABS:case Opcode.OP_NOT:case Opcode.OP_0NOTEQUAL:if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;switch(buf=this.stack[this.stack.length-1],bn=BN.fromScriptNumBuffer(buf,fRequireMinimal),opcodenum){case Opcode.OP_1ADD:bn=bn.add(BN.One);break;case Opcode.OP_1SUB:bn=bn.sub(BN.One);break;case Opcode.OP_NEGATE:bn=bn.neg();break;case Opcode.OP_ABS:bn.cmp(BN.Zero)<0&&(bn=bn.neg());break;case Opcode.OP_NOT:bn=new BN((0===bn.cmp(BN.Zero))+0);break;case Opcode.OP_0NOTEQUAL:bn=new BN((0!==bn.cmp(BN.Zero))+0)}this.stack.pop(),this.stack.push(bn.toScriptNumBuffer());break;case Opcode.OP_ADD:case Opcode.OP_SUB:case Opcode.OP_BOOLAND:case Opcode.OP_BOOLOR:case Opcode.OP_NUMEQUAL:case Opcode.OP_NUMEQUALVERIFY:case Opcode.OP_NUMNOTEQUAL:case Opcode.OP_LESSTHAN:case Opcode.OP_GREATERTHAN:case Opcode.OP_LESSTHANOREQUAL:case Opcode.OP_GREATERTHANOREQUAL:case Opcode.OP_MIN:case Opcode.OP_MAX:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;switch(bn1=BN.fromScriptNumBuffer(this.stack[this.stack.length-2],fRequireMinimal),bn2=BN.fromScriptNumBuffer(this.stack[this.stack.length-1],fRequireMinimal),bn=new BN(0),opcodenum){case Opcode.OP_ADD:bn=bn1.add(bn2);break;case Opcode.OP_SUB:bn=bn1.sub(bn2);break;case Opcode.OP_BOOLAND:bn=new BN((0!==bn1.cmp(BN.Zero)&&0!==bn2.cmp(BN.Zero))+0);break;case Opcode.OP_BOOLOR:bn=new BN((0!==bn1.cmp(BN.Zero)||0!==bn2.cmp(BN.Zero))+0);break;case Opcode.OP_NUMEQUAL:bn=new BN((0===bn1.cmp(bn2))+0);break;case Opcode.OP_NUMEQUALVERIFY:bn=new BN((0===bn1.cmp(bn2))+0);break;case Opcode.OP_NUMNOTEQUAL:bn=new BN((0!==bn1.cmp(bn2))+0);break;case Opcode.OP_LESSTHAN:bn=new BN((bn1.cmp(bn2)<0)+0);break;case Opcode.OP_GREATERTHAN:bn=new BN((bn1.cmp(bn2)>0)+0);break;case Opcode.OP_LESSTHANOREQUAL:bn=new BN((bn1.cmp(bn2)<=0)+0);break;case Opcode.OP_GREATERTHANOREQUAL:bn=new BN((bn1.cmp(bn2)>=0)+0);break;case Opcode.OP_MIN:bn=bn1.cmp(bn2)<0?bn1:bn2;break;case Opcode.OP_MAX:bn=bn1.cmp(bn2)>0?bn1:bn2}if(this.stack.pop(),this.stack.pop(),this.stack.push(bn.toScriptNumBuffer()),opcodenum===Opcode.OP_NUMEQUALVERIFY){if(!Interpreter.castToBool(this.stack[this.stack.length-1]))return this.errstr="SCRIPT_ERR_NUMEQUALVERIFY",!1;this.stack.pop()}break;case Opcode.OP_WITHIN:if(this.stack.length<3)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;bn1=BN.fromScriptNumBuffer(this.stack[this.stack.length-3],fRequireMinimal),bn2=BN.fromScriptNumBuffer(this.stack[this.stack.length-2],fRequireMinimal);var bn3=BN.fromScriptNumBuffer(this.stack[this.stack.length-1],fRequireMinimal);fValue=bn2.cmp(bn1)<=0&&bn1.cmp(bn3)<0,this.stack.pop(),this.stack.pop(),this.stack.pop(),this.stack.push(fValue?Interpreter["true"]:Interpreter["false"]);break;case Opcode.OP_RIPEMD160:case Opcode.OP_SHA1:case Opcode.OP_SHA256:case Opcode.OP_HASH160:case Opcode.OP_HASH256:if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;buf=this.stack[this.stack.length-1];var bufHash;opcodenum===Opcode.OP_RIPEMD160?bufHash=Hash.ripemd160(buf):opcodenum===Opcode.OP_SHA1?bufHash=Hash.sha1(buf):opcodenum===Opcode.OP_SHA256?bufHash=Hash.sha256(buf):opcodenum===Opcode.OP_HASH160?bufHash=Hash.sha256ripemd160(buf):opcodenum===Opcode.OP_HASH256&&(bufHash=Hash.sha256sha256(buf)),this.stack.pop(),this.stack.push(bufHash);break;case Opcode.OP_CODESEPARATOR:this.pbegincodehash=this.pc;break;case Opcode.OP_CHECKSIG:case Opcode.OP_CHECKSIGVERIFY:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;bufSig=this.stack[this.stack.length-2],bufPubkey=this.stack[this.stack.length-1],subscript=(new Script).set({chunks:this.script.chunks.slice(this.pbegincodehash)});var tmpScript=(new Script).add(bufSig);if(subscript.findAndDelete(tmpScript),!this.checkSignatureEncoding(bufSig)||!this.checkPubkeyEncoding(bufPubkey))return!1;try{sig=Signature.fromTxFormat(bufSig),pubkey=PublicKey.fromBuffer(bufPubkey,!1),fSuccess=this.tx.verifySignature(sig,pubkey,this.nin,subscript)}catch(e){fSuccess=!1}if(this.stack.pop(),this.stack.pop(),this.stack.push(fSuccess?Interpreter["true"]:Interpreter["false"]),opcodenum===Opcode.OP_CHECKSIGVERIFY){if(!fSuccess)return this.errstr="SCRIPT_ERR_CHECKSIGVERIFY",!1;this.stack.pop()}break;case Opcode.OP_CHECKMULTISIG:case Opcode.OP_CHECKMULTISIGVERIFY:var i=1;if(this.stack.length<i)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;var nKeysCount=BN.fromScriptNumBuffer(this.stack[this.stack.length-i],fRequireMinimal).toNumber();if(nKeysCount<0||nKeysCount>20)return this.errstr="SCRIPT_ERR_PUBKEY_COUNT",!1;if(this.nOpCount+=nKeysCount,this.nOpCount>201)return this.errstr="SCRIPT_ERR_OP_COUNT",!1;var ikey=++i;if(i+=nKeysCount,this.stack.length<i)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;var nSigsCount=BN.fromScriptNumBuffer(this.stack[this.stack.length-i],fRequireMinimal).toNumber();if(nSigsCount<0||nSigsCount>nKeysCount)return this.errstr="SCRIPT_ERR_SIG_COUNT",!1;var isig=++i;if(i+=nSigsCount,this.stack.length<i)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;subscript=(new Script).set({chunks:this.script.chunks.slice(this.pbegincodehash)});for(var k=0;k<nSigsCount;k++)bufSig=this.stack[this.stack.length-isig-k],subscript.findAndDelete((new Script).add(bufSig));for(fSuccess=!0;fSuccess&&nSigsCount>0;){if(bufSig=this.stack[this.stack.length-isig],bufPubkey=this.stack[this.stack.length-ikey],!this.checkSignatureEncoding(bufSig)||!this.checkPubkeyEncoding(bufPubkey))return!1;var fOk;try{sig=Signature.fromTxFormat(bufSig),pubkey=PublicKey.fromBuffer(bufPubkey,!1),fOk=this.tx.verifySignature(sig,pubkey,this.nin,subscript)}catch(e){fOk=!1}fOk&&(isig++,nSigsCount--),ikey++,nKeysCount--,nSigsCount>nKeysCount&&(fSuccess=!1)}for(;i-- >1;)this.stack.pop();if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;if(this.flags&Interpreter.SCRIPT_VERIFY_NULLDUMMY&&this.stack[this.stack.length-1].length)return this.errstr="SCRIPT_ERR_SIG_NULLDUMMY",!1;if(this.stack.pop(),this.stack.push(fSuccess?Interpreter["true"]:Interpreter["false"]),opcodenum===Opcode.OP_CHECKMULTISIGVERIFY){if(!fSuccess)return this.errstr="SCRIPT_ERR_CHECKMULTISIGVERIFY",!1;this.stack.pop()}break;default:return this.errstr="SCRIPT_ERR_BAD_OPCODE",!1}return!0}}).call(this,require("buffer").Buffer)},{"../crypto/bn":40,"../crypto/hash":42,"../crypto/signature":45,"../opcode":57,"../publickey":59,"../transaction":63,"./script":62,buffer:151,lodash:105}],62:[function(require,module,exports){(function(Buffer){"use strict";var Address=require("../address"),BufferReader=require("../encoding/bufferreader"),BufferWriter=require("../encoding/bufferwriter"),Hash=require("../crypto/hash"),Opcode=require("../opcode"),PublicKey=require("../publickey"),Signature=require("../crypto/signature"),Networks=require("../networks"),$=require("../util/preconditions"),_=require("lodash"),errors=require("../errors"),buffer=require("buffer"),BufferUtil=require("../util/buffer"),JSUtil=require("../util/js"),Script=function Script(from){return this instanceof Script?(this.chunks=[],BufferUtil.isBuffer(from)?Script.fromBuffer(from):from instanceof Address?Script.fromAddress(from):from instanceof Script?Script.fromBuffer(from.toBuffer()):"string"==typeof from?Script.fromString(from):void("undefined"!=typeof from&&this.set(from))):new Script(from)};Script.prototype.set=function(obj){return this.chunks=obj.chunks||this.chunks,this},Script.fromBuffer=function(buffer){var script=new Script;script.chunks=[];for(var br=new BufferReader(buffer);!br.finished();)try{var len,buf,opcodenum=br.readUInt8();opcodenum>0&&opcodenum<Opcode.OP_PUSHDATA1?(len=opcodenum,script.chunks.push({buf:br.read(len),len:len,opcodenum:opcodenum})):opcodenum===Opcode.OP_PUSHDATA1?(len=br.readUInt8(),buf=br.read(len),script.chunks.push({buf:buf,len:len,opcodenum:opcodenum})):opcodenum===Opcode.OP_PUSHDATA2?(len=br.readUInt16LE(),buf=br.read(len),script.chunks.push({buf:buf,len:len,opcodenum:opcodenum})):opcodenum===Opcode.OP_PUSHDATA4?(len=br.readUInt32LE(),buf=br.read(len),script.chunks.push({buf:buf,len:len,opcodenum:opcodenum})):script.chunks.push({opcodenum:opcodenum})}catch(e){if(e instanceof RangeError)throw new errors.Script.InvalidBuffer(buffer.toString("hex"));throw e}return script},Script.prototype.toBuffer=function(){for(var bw=new BufferWriter,i=0;i<this.chunks.length;i++){var chunk=this.chunks[i],opcodenum=chunk.opcodenum;bw.writeUInt8(chunk.opcodenum),chunk.buf&&(opcodenum<Opcode.OP_PUSHDATA1?bw.write(chunk.buf):opcodenum===Opcode.OP_PUSHDATA1?(bw.writeUInt8(chunk.len),bw.write(chunk.buf)):opcodenum===Opcode.OP_PUSHDATA2?(bw.writeUInt16LE(chunk.len),bw.write(chunk.buf)):opcodenum===Opcode.OP_PUSHDATA4&&(bw.writeUInt32LE(chunk.len),bw.write(chunk.buf)))}return bw.concat()},Script.fromASM=function(str){var script=new Script;script.chunks=[];for(var tokens=str.split(" "),i=0;i<tokens.length;){var token=tokens[i],opcode=Opcode(token),opcodenum=opcode.toNumber();if(_.isUndefined(opcodenum)){var buf=new Buffer(tokens[i],"hex");script.chunks.push({buf:buf,len:buf.length,opcodenum:buf.length}),i+=1}else opcodenum===Opcode.OP_PUSHDATA1||opcodenum===Opcode.OP_PUSHDATA2||opcodenum===Opcode.OP_PUSHDATA4?(script.chunks.push({buf:new Buffer(tokens[i+2],"hex"),len:parseInt(tokens[i+1]),opcodenum:opcodenum}),i+=3):(script.chunks.push({opcodenum:opcodenum}),i+=1)}return script},Script.fromHex=function(str){return new Script(new buffer.Buffer(str,"hex"))},Script.fromString=function(str){if(JSUtil.isHexa(str)||0===str.length)return new Script(new buffer.Buffer(str,"hex"));var script=new Script;script.chunks=[];for(var tokens=str.split(" "),i=0;i<tokens.length;){var token=tokens[i],opcode=Opcode(token),opcodenum=opcode.toNumber();if(_.isUndefined(opcodenum)){if(opcodenum=parseInt(token),!(opcodenum>0&&opcodenum<Opcode.OP_PUSHDATA1))throw new Error("Invalid script: "+JSON.stringify(str));script.chunks.push({buf:new Buffer(tokens[i+1].slice(2),"hex"),len:opcodenum,opcodenum:opcodenum}),i+=2}else if(opcodenum===Opcode.OP_PUSHDATA1||opcodenum===Opcode.OP_PUSHDATA2||opcodenum===Opcode.OP_PUSHDATA4){if("0x"!==tokens[i+2].slice(0,2))throw new Error("Pushdata data must start with 0x");script.chunks.push({buf:new Buffer(tokens[i+2].slice(2),"hex"),len:parseInt(tokens[i+1]),opcodenum:opcodenum}),i+=3}else script.chunks.push({opcodenum:opcodenum}),i+=1}return script},Script.prototype._chunkToString=function(chunk,type){var opcodenum=chunk.opcodenum,asm="asm"===type,str="";if(chunk.buf)opcodenum!==Opcode.OP_PUSHDATA1&&opcodenum!==Opcode.OP_PUSHDATA2&&opcodenum!==Opcode.OP_PUSHDATA4||(str=str+" "+Opcode(opcodenum).toString()),chunk.len>0&&(str=asm?str+" "+chunk.buf.toString("hex"):str+" "+chunk.len+" 0x"+chunk.buf.toString("hex"));else if("undefined"!=typeof Opcode.reverseMap[opcodenum])str=str+" "+Opcode(opcodenum).toString();else{var numstr=opcodenum.toString(16);numstr.length%2!==0&&(numstr="0"+numstr),str=asm?str+" "+numstr:str+" 0x"+numstr}return str},Script.prototype.toASM=function(){for(var str="",i=0;i<this.chunks.length;i++){var chunk=this.chunks[i];str+=this._chunkToString(chunk,"asm")}return str.substr(1)},Script.prototype.toString=function(){for(var str="",i=0;i<this.chunks.length;i++){var chunk=this.chunks[i];str+=this._chunkToString(chunk)}return str.substr(1)},Script.prototype.toHex=function(){return this.toBuffer().toString("hex")},Script.prototype.inspect=function(){return"<Script: "+this.toString()+">"},Script.prototype.isPublicKeyHashOut=function(){return!(5!==this.chunks.length||this.chunks[0].opcodenum!==Opcode.OP_DUP||this.chunks[1].opcodenum!==Opcode.OP_HASH160||!this.chunks[2].buf||20!==this.chunks[2].buf.length||this.chunks[3].opcodenum!==Opcode.OP_EQUALVERIFY||this.chunks[4].opcodenum!==Opcode.OP_CHECKSIG)},Script.prototype.isPublicKeyHashIn=function(){if(2===this.chunks.length){var signatureBuf=this.chunks[0].buf,pubkeyBuf=this.chunks[1].buf;if(signatureBuf&&signatureBuf.length&&48===signatureBuf[0]&&pubkeyBuf&&pubkeyBuf.length){var version=pubkeyBuf[0];if((4===version||6===version||7===version)&&65===pubkeyBuf.length)return!0;if((3===version||2===version)&&33===pubkeyBuf.length)return!0}}return!1},Script.prototype.getPublicKey=function(){return $.checkState(this.isPublicKeyOut(),"Can't retreive PublicKey from a non-PK output"),this.chunks[0].buf},Script.prototype.getPublicKeyHash=function(){return $.checkState(this.isPublicKeyHashOut(),"Can't retrieve PublicKeyHash from a non-PKH output"),this.chunks[2].buf},Script.prototype.isPublicKeyOut=function(){if(2===this.chunks.length&&this.chunks[0].buf&&this.chunks[0].buf.length&&this.chunks[1].opcodenum===Opcode.OP_CHECKSIG){var pubkeyBuf=this.chunks[0].buf,version=pubkeyBuf[0],isVersion=!1;if(4!==version&&6!==version&&7!==version||65!==pubkeyBuf.length?3!==version&&2!==version||33!==pubkeyBuf.length||(isVersion=!0):isVersion=!0,isVersion)return PublicKey.isValid(pubkeyBuf)}return!1},Script.prototype.isPublicKeyIn=function(){if(1===this.chunks.length){var signatureBuf=this.chunks[0].buf;if(signatureBuf&&signatureBuf.length&&48===signatureBuf[0])return!0}return!1},Script.prototype.isScriptHashOut=function(){var buf=this.toBuffer();return 23===buf.length&&buf[0]===Opcode.OP_HASH160&&20===buf[1]&&buf[buf.length-1]===Opcode.OP_EQUAL},Script.prototype.isScriptHashIn=function(){if(this.chunks.length<=1)return!1;var redeemChunk=this.chunks[this.chunks.length-1],redeemBuf=redeemChunk.buf;if(!redeemBuf)return!1;var redeemScript;try{redeemScript=Script.fromBuffer(redeemBuf)}catch(e){if(e instanceof errors.Script.InvalidBuffer)return!1;throw e}var type=redeemScript.classify();return type!==Script.types.UNKNOWN},Script.prototype.isMultisigOut=function(){return this.chunks.length>3&&Opcode.isSmallIntOp(this.chunks[0].opcodenum)&&this.chunks.slice(1,this.chunks.length-2).every(function(obj){return obj.buf&&BufferUtil.isBuffer(obj.buf)})&&Opcode.isSmallIntOp(this.chunks[this.chunks.length-2].opcodenum)&&this.chunks[this.chunks.length-1].opcodenum===Opcode.OP_CHECKMULTISIG},Script.prototype.isMultisigIn=function(){return this.chunks.length>=2&&0===this.chunks[0].opcodenum&&this.chunks.slice(1,this.chunks.length).every(function(obj){return obj.buf&&BufferUtil.isBuffer(obj.buf)&&Signature.isTxDER(obj.buf)})},Script.prototype.isDataOut=function(){return this.chunks.length>=1&&this.chunks[0].opcodenum===Opcode.OP_RETURN&&(1===this.chunks.length||2===this.chunks.length&&this.chunks[1].buf&&this.chunks[1].buf.length<=Script.OP_RETURN_STANDARD_SIZE&&this.chunks[1].length===this.chunks.len)},Script.prototype.getData=function(){if(this.isDataOut()||this.isScriptHashOut())return new Buffer(_.isUndefined(this.chunks[1])?0:this.chunks[1].buf);if(this.isPublicKeyHashOut())return new Buffer(this.chunks[2].buf);throw new Error("Unrecognized script type to get data from")},Script.prototype.isPushOnly=function(){return _.every(this.chunks,function(chunk){return chunk.opcodenum<=Opcode.OP_16})},Script.types={},Script.types.UNKNOWN="Unknown",Script.types.PUBKEY_OUT="Pay to public key",Script.types.PUBKEY_IN="Spend from public key",Script.types.PUBKEYHASH_OUT="Pay to public key hash",Script.types.PUBKEYHASH_IN="Spend from public key hash",Script.types.SCRIPTHASH_OUT="Pay to script hash",Script.types.SCRIPTHASH_IN="Spend from script hash",Script.types.MULTISIG_OUT="Pay to multisig",Script.types.MULTISIG_IN="Spend from multisig",Script.types.DATA_OUT="Data push",Script.OP_RETURN_STANDARD_SIZE=80,Script.prototype.classify=function(){if(this._isInput)return this.classifyInput();if(this._isOutput)return this.classifyOutput();var outputType=this.classifyOutput();return outputType!=Script.types.UNKNOWN?outputType:this.classifyInput()},Script.outputIdentifiers={},Script.outputIdentifiers.PUBKEY_OUT=Script.prototype.isPublicKeyOut,Script.outputIdentifiers.PUBKEYHASH_OUT=Script.prototype.isPublicKeyHashOut,Script.outputIdentifiers.MULTISIG_OUT=Script.prototype.isMultisigOut,Script.outputIdentifiers.SCRIPTHASH_OUT=Script.prototype.isScriptHashOut,Script.outputIdentifiers.DATA_OUT=Script.prototype.isDataOut,Script.prototype.classifyOutput=function(){for(var type in Script.outputIdentifiers)if(Script.outputIdentifiers[type].bind(this)())return Script.types[type];return Script.types.UNKNOWN},Script.inputIdentifiers={},Script.inputIdentifiers.PUBKEY_IN=Script.prototype.isPublicKeyIn,Script.inputIdentifiers.PUBKEYHASH_IN=Script.prototype.isPublicKeyHashIn,Script.inputIdentifiers.MULTISIG_IN=Script.prototype.isMultisigIn,Script.inputIdentifiers.SCRIPTHASH_IN=Script.prototype.isScriptHashIn,Script.prototype.classifyInput=function(){for(var type in Script.inputIdentifiers)if(Script.inputIdentifiers[type].bind(this)())return Script.types[type];return Script.types.UNKNOWN},Script.prototype.isStandard=function(){return this.classify()!==Script.types.UNKNOWN},Script.prototype.prepend=function(obj){return this._addByType(obj,!0),this},Script.prototype.equals=function(script){if($.checkState(script instanceof Script,"Must provide another script"),this.chunks.length!==script.chunks.length)return!1;var i;for(i=0;i<this.chunks.length;i++){if(BufferUtil.isBuffer(this.chunks[i].buf)&&!BufferUtil.isBuffer(script.chunks[i].buf))return!1;if(BufferUtil.isBuffer(this.chunks[i].buf)&&!BufferUtil.equals(this.chunks[i].buf,script.chunks[i].buf))return!1;if(this.chunks[i].opcodenum!==script.chunks[i].opcodenum)return!1}return!0},Script.prototype.add=function(obj){return this._addByType(obj,!1),this},Script.prototype._addByType=function(obj,prepend){if("string"==typeof obj)this._addOpcode(obj,prepend);else if("number"==typeof obj)this._addOpcode(obj,prepend);else if(obj instanceof Opcode)this._addOpcode(obj,prepend);else if(BufferUtil.isBuffer(obj))this._addBuffer(obj,prepend);else if(obj instanceof Script)this.chunks=this.chunks.concat(obj.chunks);else{if("object"!=typeof obj)throw new Error("Invalid script chunk");this._insertAtPosition(obj,prepend)}},Script.prototype._insertAtPosition=function(op,prepend){prepend?this.chunks.unshift(op):this.chunks.push(op)},Script.prototype._addOpcode=function(opcode,prepend){var op;return op="number"==typeof opcode?opcode:opcode instanceof Opcode?opcode.toNumber():Opcode(opcode).toNumber(),this._insertAtPosition({opcodenum:op},prepend),this},Script.prototype._addBuffer=function(buf,prepend){var opcodenum,len=buf.length;if(len>=0&&len<Opcode.OP_PUSHDATA1)opcodenum=len;else if(len<Math.pow(2,8))opcodenum=Opcode.OP_PUSHDATA1;else if(len<Math.pow(2,16))opcodenum=Opcode.OP_PUSHDATA2;else{if(!(len<Math.pow(2,32)))throw new Error("You can't push that much data");opcodenum=Opcode.OP_PUSHDATA4}return this._insertAtPosition({buf:buf,len:len,opcodenum:opcodenum},prepend),this},Script.prototype.removeCodeseparators=function(){for(var chunks=[],i=0;i<this.chunks.length;i++)this.chunks[i].opcodenum!==Opcode.OP_CODESEPARATOR&&chunks.push(this.chunks[i]);return this.chunks=chunks,this},Script.buildMultisigOut=function(publicKeys,threshold,opts){$.checkArgument(threshold<=publicKeys.length,"Number of required signatures must be less than or equal to the number of public keys"),opts=opts||{};var script=new Script;script.add(Opcode.smallInt(threshold)),publicKeys=_.map(publicKeys,PublicKey);var sorted=publicKeys;opts.noSorting||(sorted=_.sortBy(publicKeys,function(publicKey){return publicKey.toString("hex")}));for(var i=0;i<sorted.length;i++){var publicKey=sorted[i];script.add(publicKey.toBuffer())}return script.add(Opcode.smallInt(publicKeys.length)),script.add(Opcode.OP_CHECKMULTISIG),script},Script.buildMultisigIn=function(pubkeys,threshold,signatures,opts){$.checkArgument(_.isArray(pubkeys)),$.checkArgument(_.isNumber(threshold)),$.checkArgument(_.isArray(signatures)),opts=opts||{};var s=new Script;return s.add(Opcode.OP_0),_.each(signatures,function(signature){$.checkArgument(BufferUtil.isBuffer(signature),"Signatures must be an array of Buffers"),s.add(signature)}),s},Script.buildP2SHMultisigIn=function(pubkeys,threshold,signatures,opts){$.checkArgument(_.isArray(pubkeys)),$.checkArgument(_.isNumber(threshold)),$.checkArgument(_.isArray(signatures)),opts=opts||{};var s=new Script;return s.add(Opcode.OP_0),_.each(signatures,function(signature){$.checkArgument(BufferUtil.isBuffer(signature),"Signatures must be an array of Buffers"),s.add(signature)}),s.add((opts.cachedMultisig||Script.buildMultisigOut(pubkeys,threshold,opts)).toBuffer()),s},Script.buildPublicKeyHashOut=function(to){$.checkArgument(!_.isUndefined(to)),$.checkArgument(to instanceof PublicKey||to instanceof Address||_.isString(to)),to instanceof PublicKey?to=to.toAddress():_.isString(to)&&(to=new Address(to));var s=new Script;return s.add(Opcode.OP_DUP).add(Opcode.OP_HASH160).add(to.hashBuffer).add(Opcode.OP_EQUALVERIFY).add(Opcode.OP_CHECKSIG),s._network=to.network,s},Script.buildPublicKeyOut=function(pubkey){$.checkArgument(pubkey instanceof PublicKey);var s=new Script;return s.add(pubkey.toBuffer()).add(Opcode.OP_CHECKSIG),s},Script.buildDataOut=function(data,encoding){$.checkArgument(_.isUndefined(data)||_.isString(data)||BufferUtil.isBuffer(data)),_.isString(data)&&(data=new Buffer(data,encoding));var s=new Script;return s.add(Opcode.OP_RETURN),_.isUndefined(data)||s.add(data),s},Script.buildScriptHashOut=function(script){$.checkArgument(script instanceof Script||script instanceof Address&&script.isPayToScriptHash());var s=new Script;return s.add(Opcode.OP_HASH160).add(script instanceof Address?script.hashBuffer:Hash.sha256ripemd160(script.toBuffer())).add(Opcode.OP_EQUAL),s._network=script._network||script.network,s},Script.buildPublicKeyIn=function(signature,sigtype){$.checkArgument(signature instanceof Signature||BufferUtil.isBuffer(signature)),$.checkArgument(_.isUndefined(sigtype)||_.isNumber(sigtype)),signature instanceof Signature&&(signature=signature.toBuffer());var script=new Script;return script.add(BufferUtil.concat([signature,BufferUtil.integerAsSingleByteBuffer(sigtype||Signature.SIGHASH_ALL)])),script},Script.buildPublicKeyHashIn=function(publicKey,signature,sigtype){$.checkArgument(signature instanceof Signature||BufferUtil.isBuffer(signature)),$.checkArgument(_.isUndefined(sigtype)||_.isNumber(sigtype)),signature instanceof Signature&&(signature=signature.toBuffer());var script=(new Script).add(BufferUtil.concat([signature,BufferUtil.integerAsSingleByteBuffer(sigtype||Signature.SIGHASH_ALL)])).add(new PublicKey(publicKey).toBuffer());return script},Script.empty=function(){return new Script},Script.prototype.toScriptHashOut=function(){return Script.buildScriptHashOut(this)},Script.fromAddress=function(address){if(address=Address(address),address.isPayToScriptHash())return Script.buildScriptHashOut(address);if(address.isPayToPublicKeyHash())return Script.buildPublicKeyHashOut(address);throw new errors.Script.UnrecognizedAddress(address)},Script.prototype.getAddressInfo=function(opts){if(this._isInput)return this._getInputAddressInfo();if(this._isOutput)return this._getOutputAddressInfo();var info=this._getOutputAddressInfo();return info?info:this._getInputAddressInfo()},Script.prototype._getOutputAddressInfo=function(){var info={};if(this.isScriptHashOut())info.hashBuffer=this.getData(),info.type=Address.PayToScriptHash;else{if(!this.isPublicKeyHashOut())return!1;info.hashBuffer=this.getData(),info.type=Address.PayToPublicKeyHash}return info},Script.prototype._getInputAddressInfo=function(){var info={};if(this.isPublicKeyHashIn())info.hashBuffer=Hash.sha256ripemd160(this.chunks[1].buf),info.type=Address.PayToPublicKeyHash;else{if(!this.isScriptHashIn())return!1;info.hashBuffer=Hash.sha256ripemd160(this.chunks[this.chunks.length-1].buf),info.type=Address.PayToScriptHash}return info},Script.prototype.toAddress=function(network){var info=this.getAddressInfo();return!!info&&(info.network=Networks.get(network)||this._network||Networks.defaultNetwork,
new Address(info))},Script.prototype.findAndDelete=function(script){for(var buf=script.toBuffer(),hex=buf.toString("hex"),i=0;i<this.chunks.length;i++){var script2=Script({chunks:[this.chunks[i]]}),buf2=script2.toBuffer(),hex2=buf2.toString("hex");hex===hex2&&this.chunks.splice(i,1)}return this},Script.prototype.checkMinimalPush=function(i){var chunk=this.chunks[i],buf=chunk.buf,opcodenum=chunk.opcodenum;return!buf||(0===buf.length?opcodenum===Opcode.OP_0:1===buf.length&&buf[0]>=1&&buf[0]<=16?opcodenum===Opcode.OP_1+(buf[0]-1):1===buf.length&&129===buf[0]?opcodenum===Opcode.OP_1NEGATE:buf.length<=75?opcodenum===buf.length:buf.length<=255?opcodenum===Opcode.OP_PUSHDATA1:!(buf.length<=65535)||opcodenum===Opcode.OP_PUSHDATA2)},Script.prototype._decodeOP_N=function(opcode){if(opcode===Opcode.OP_0)return 0;if(opcode>=Opcode.OP_1&&opcode<=Opcode.OP_16)return opcode-(Opcode.OP_1-1);throw new Error("Invalid opcode: "+JSON.stringify(opcode))},Script.prototype.getSignatureOperationsCount=function(accurate){accurate=!!_.isUndefined(accurate)||accurate;var self=this,n=0,lastOpcode=Opcode.OP_INVALIDOPCODE;return _.each(self.chunks,function(chunk){var opcode=chunk.opcodenum;opcode==Opcode.OP_CHECKSIG||opcode==Opcode.OP_CHECKSIGVERIFY?n++:opcode!=Opcode.OP_CHECKMULTISIG&&opcode!=Opcode.OP_CHECKMULTISIGVERIFY||(n+=accurate&&lastOpcode>=Opcode.OP_1&&lastOpcode<=Opcode.OP_16?self._decodeOP_N(lastOpcode):20),lastOpcode=opcode}),n},module.exports=Script}).call(this,require("buffer").Buffer)},{"../address":35,"../crypto/hash":42,"../crypto/signature":45,"../encoding/bufferreader":48,"../encoding/bufferwriter":49,"../errors":51,"../networks":56,"../opcode":57,"../publickey":59,"../util/buffer":77,"../util/js":78,"../util/preconditions":79,buffer:151,lodash:105}],63:[function(require,module,exports){module.exports=require("./transaction"),module.exports.Input=require("./input"),module.exports.Output=require("./output"),module.exports.UnspentOutput=require("./unspentoutput"),module.exports.Signature=require("./signature"),module.exports.Sighash=require("./sighash")},{"./input":64,"./output":70,"./sighash":71,"./signature":72,"./transaction":73,"./unspentoutput":74}],64:[function(require,module,exports){module.exports=require("./input"),module.exports.PublicKey=require("./publickey"),module.exports.PublicKeyHash=require("./publickeyhash"),module.exports.MultiSig=require("./multisig.js"),module.exports.MultiSigScriptHash=require("./multisigscripthash.js")},{"./input":65,"./multisig.js":66,"./multisigscripthash.js":67,"./publickey":68,"./publickeyhash":69}],65:[function(require,module,exports){"use strict";function Input(params){return this instanceof Input?params?this._fromObject(params):void 0:new Input(params)}var _=require("lodash"),$=require("../../util/preconditions"),errors=require("../../errors"),BufferWriter=require("../../encoding/bufferwriter"),buffer=require("buffer"),BufferUtil=require("../../util/buffer"),JSUtil=require("../../util/js"),Script=require("../../script"),Sighash=require("../sighash"),Output=require("../output"),MAXINT=4294967295,DEFAULT_RBF_SEQNUMBER=MAXINT-2,DEFAULT_SEQNUMBER=MAXINT,DEFAULT_LOCKTIME_SEQNUMBER=MAXINT-1;Input.MAXINT=MAXINT,Input.DEFAULT_SEQNUMBER=DEFAULT_SEQNUMBER,Input.DEFAULT_LOCKTIME_SEQNUMBER=DEFAULT_LOCKTIME_SEQNUMBER,Input.DEFAULT_RBF_SEQNUMBER=DEFAULT_RBF_SEQNUMBER,Object.defineProperty(Input.prototype,"script",{configurable:!1,enumerable:!0,get:function(){return this.isNull()?null:(this._script||(this._script=new Script(this._scriptBuffer),this._script._isInput=!0),this._script)}}),Input.fromObject=function(obj){$.checkArgument(_.isObject(obj));var input=new Input;return input._fromObject(obj)},Input.prototype._fromObject=function(params){var prevTxId;if(prevTxId=_.isString(params.prevTxId)&&JSUtil.isHexa(params.prevTxId)?new buffer.Buffer(params.prevTxId,"hex"):params.prevTxId,this.output=params.output?params.output instanceof Output?params.output:new Output(params.output):void 0,this.prevTxId=prevTxId||params.txidbuf,this.outputIndex=_.isUndefined(params.outputIndex)?params.txoutnum:params.outputIndex,this.sequenceNumber=_.isUndefined(params.sequenceNumber)?_.isUndefined(params.seqnum)?DEFAULT_SEQNUMBER:params.seqnum:params.sequenceNumber,_.isUndefined(params.script)&&_.isUndefined(params.scriptBuffer))throw new errors.Transaction.Input.MissingScript;return this.setScript(params.scriptBuffer||params.script),this},Input.prototype.toObject=Input.prototype.toJSON=function(){var obj={prevTxId:this.prevTxId.toString("hex"),outputIndex:this.outputIndex,sequenceNumber:this.sequenceNumber,script:this._scriptBuffer.toString("hex")};return this.script&&(obj.scriptString=this.script.toString()),this.output&&(obj.output=this.output.toObject()),obj},Input.fromBufferReader=function(br){var input=new Input;return input.prevTxId=br.readReverse(32),input.outputIndex=br.readUInt32LE(),input._scriptBuffer=br.readVarLengthBuffer(),input.sequenceNumber=br.readUInt32LE(),input},Input.prototype.toBufferWriter=function(writer){writer||(writer=new BufferWriter),writer.writeReverse(this.prevTxId),writer.writeUInt32LE(this.outputIndex);var script=this._scriptBuffer;return writer.writeVarintNum(script.length),writer.write(script),writer.writeUInt32LE(this.sequenceNumber),writer},Input.prototype.setScript=function(script){if(this._script=null,script instanceof Script)this._script=script,this._script._isInput=!0,this._scriptBuffer=script.toBuffer();else if(JSUtil.isHexa(script))this._scriptBuffer=new buffer.Buffer(script,"hex");else if(_.isString(script))this._script=new Script(script),this._script._isInput=!0,this._scriptBuffer=this._script.toBuffer();else{if(!BufferUtil.isBuffer(script))throw new TypeError("Invalid argument type: script");this._scriptBuffer=new buffer.Buffer(script)}return this},Input.prototype.getSignatures=function(){throw new errors.AbstractMethodInvoked("Trying to sign unsupported output type (only P2PKH and P2SH multisig inputs are supported) for input: "+JSON.stringify(this))},Input.prototype.isFullySigned=function(){throw new errors.AbstractMethodInvoked("Input#isFullySigned")},Input.prototype.isFinal=function(){return 4294967295!==this.sequenceNumber},Input.prototype.addSignature=function(){throw new errors.AbstractMethodInvoked("Input#addSignature")},Input.prototype.clearSignatures=function(){throw new errors.AbstractMethodInvoked("Input#clearSignatures")},Input.prototype.isValidSignature=function(transaction,signature){return signature.signature.nhashtype=signature.sigtype,Sighash.verify(transaction,signature.signature,signature.publicKey,signature.inputIndex,this.output.script)},Input.prototype.isNull=function(){return"0000000000000000000000000000000000000000000000000000000000000000"===this.prevTxId.toString("hex")&&4294967295===this.outputIndex},Input.prototype._estimateSize=function(){return this.toBufferWriter().toBuffer().length},module.exports=Input},{"../../encoding/bufferwriter":49,"../../errors":51,"../../script":60,"../../util/buffer":77,"../../util/js":78,"../../util/preconditions":79,"../output":70,"../sighash":71,buffer:151,lodash:105}],66:[function(require,module,exports){"use strict";function MultiSigInput(input,pubkeys,threshold,signatures){Input.apply(this,arguments);var self=this;pubkeys=pubkeys||input.publicKeys,threshold=threshold||input.threshold,signatures=signatures||input.signatures,this.publicKeys=_.sortBy(pubkeys,function(publicKey){return publicKey.toString("hex")}),$.checkState(Script.buildMultisigOut(this.publicKeys,threshold).equals(this.output.script),"Provided public keys don't match to the provided output script"),this.publicKeyIndex={},_.each(this.publicKeys,function(publicKey,index){self.publicKeyIndex[publicKey.toString()]=index}),this.threshold=threshold,this.signatures=signatures?this._deserializeSignatures(signatures):new Array(this.publicKeys.length)}var _=require("lodash"),inherits=require("inherits"),Input=(require("../transaction"),require("./input")),Output=require("../output"),$=require("../../util/preconditions"),Script=require("../../script"),Signature=require("../../crypto/signature"),Sighash=require("../sighash"),BufferUtil=(require("../../publickey"),require("../../util/buffer")),TransactionSignature=require("../signature");inherits(MultiSigInput,Input),MultiSigInput.prototype.toObject=function(){var obj=Input.prototype.toObject.apply(this,arguments);return obj.threshold=this.threshold,obj.publicKeys=_.map(this.publicKeys,function(publicKey){return publicKey.toString()}),obj.signatures=this._serializeSignatures(),obj},MultiSigInput.prototype._deserializeSignatures=function(signatures){return _.map(signatures,function(signature){if(signature)return new TransactionSignature(signature)})},MultiSigInput.prototype._serializeSignatures=function(){return _.map(this.signatures,function(signature){if(signature)return signature.toObject()})},MultiSigInput.prototype.getSignatures=function(transaction,privateKey,index,sigtype){$.checkState(this.output instanceof Output),sigtype=sigtype||Signature.SIGHASH_ALL;var self=this,results=[];return _.each(this.publicKeys,function(publicKey){publicKey.toString()===privateKey.publicKey.toString()&&results.push(new TransactionSignature({publicKey:privateKey.publicKey,prevTxId:self.prevTxId,outputIndex:self.outputIndex,inputIndex:index,signature:Sighash.sign(transaction,privateKey,sigtype,index,self.output.script),sigtype:sigtype}))}),results},MultiSigInput.prototype.addSignature=function(transaction,signature){return $.checkState(!this.isFullySigned(),"All needed signatures have already been added"),$.checkArgument(!_.isUndefined(this.publicKeyIndex[signature.publicKey.toString()]),"Signature has no matching public key"),$.checkState(this.isValidSignature(transaction,signature)),this.signatures[this.publicKeyIndex[signature.publicKey.toString()]]=signature,this._updateScript(),this},MultiSigInput.prototype._updateScript=function(){return this.setScript(Script.buildMultisigIn(this.publicKeys,this.threshold,this._createSignatures())),this},MultiSigInput.prototype._createSignatures=function(){return _.map(_.filter(this.signatures,function(signature){return!_.isUndefined(signature)}),function(signature){return BufferUtil.concat([signature.signature.toDER(),BufferUtil.integerAsSingleByteBuffer(signature.sigtype)])})},MultiSigInput.prototype.clearSignatures=function(){this.signatures=new Array(this.publicKeys.length),this._updateScript()},MultiSigInput.prototype.isFullySigned=function(){return this.countSignatures()===this.threshold},MultiSigInput.prototype.countMissingSignatures=function(){return this.threshold-this.countSignatures()},MultiSigInput.prototype.countSignatures=function(){return _.reduce(this.signatures,function(sum,signature){return sum+!!signature},0)},MultiSigInput.prototype.publicKeysWithoutSignature=function(){var self=this;return _.filter(this.publicKeys,function(publicKey){return!self.signatures[self.publicKeyIndex[publicKey.toString()]]})},MultiSigInput.prototype.isValidSignature=function(transaction,signature){return signature.signature.nhashtype=signature.sigtype,Sighash.verify(transaction,signature.signature,signature.publicKey,signature.inputIndex,this.output.script)},MultiSigInput.normalizeSignatures=function(transaction,input,inputIndex,signatures,publicKeys){return publicKeys.map(function(pubKey){var signatureMatch=null;return signatures=signatures.filter(function(signatureBuffer){if(signatureMatch)return!0;var signature=new TransactionSignature({signature:Signature.fromTxFormat(signatureBuffer),publicKey:pubKey,prevTxId:input.prevTxId,outputIndex:input.outputIndex,inputIndex:inputIndex,sigtype:Signature.SIGHASH_ALL});signature.signature.nhashtype=signature.sigtype;var isMatch=Sighash.verify(transaction,signature.signature,signature.publicKey,signature.inputIndex,input.output.script);return!isMatch||(signatureMatch=signature,!1)}),signatureMatch?signatureMatch:null})},MultiSigInput.OPCODES_SIZE=1,MultiSigInput.SIGNATURE_SIZE=73,MultiSigInput.prototype._estimateSize=function(){return MultiSigInput.OPCODES_SIZE+this.threshold*MultiSigInput.SIGNATURE_SIZE},module.exports=MultiSigInput},{"../../crypto/signature":45,"../../publickey":59,"../../script":60,"../../util/buffer":77,"../../util/preconditions":79,"../output":70,"../sighash":71,"../signature":72,"../transaction":73,"./input":65,inherits:104,lodash:105}],67:[function(require,module,exports){"use strict";function MultiSigScriptHashInput(input,pubkeys,threshold,signatures){Input.apply(this,arguments);var self=this;pubkeys=pubkeys||input.publicKeys,threshold=threshold||input.threshold,signatures=signatures||input.signatures,this.publicKeys=_.sortBy(pubkeys,function(publicKey){return publicKey.toString("hex")}),this.redeemScript=Script.buildMultisigOut(this.publicKeys,threshold),$.checkState(Script.buildScriptHashOut(this.redeemScript).equals(this.output.script),"Provided public keys don't hash to the provided output"),this.publicKeyIndex={},_.each(this.publicKeys,function(publicKey,index){self.publicKeyIndex[publicKey.toString()]=index}),this.threshold=threshold,this.signatures=signatures?this._deserializeSignatures(signatures):new Array(this.publicKeys.length)}var _=require("lodash"),inherits=require("inherits"),Input=require("./input"),Output=require("../output"),$=require("../../util/preconditions"),Script=require("../../script"),Signature=require("../../crypto/signature"),Sighash=require("../sighash"),BufferUtil=(require("../../publickey"),require("../../util/buffer")),TransactionSignature=require("../signature");inherits(MultiSigScriptHashInput,Input),MultiSigScriptHashInput.prototype.toObject=function(){var obj=Input.prototype.toObject.apply(this,arguments);return obj.threshold=this.threshold,obj.publicKeys=_.map(this.publicKeys,function(publicKey){return publicKey.toString()}),obj.signatures=this._serializeSignatures(),obj},MultiSigScriptHashInput.prototype._deserializeSignatures=function(signatures){return _.map(signatures,function(signature){if(signature)return new TransactionSignature(signature)})},MultiSigScriptHashInput.prototype._serializeSignatures=function(){return _.map(this.signatures,function(signature){if(signature)return signature.toObject()})},MultiSigScriptHashInput.prototype.getSignatures=function(transaction,privateKey,index,sigtype){$.checkState(this.output instanceof Output),sigtype=sigtype||Signature.SIGHASH_ALL;var self=this,results=[];return _.each(this.publicKeys,function(publicKey){publicKey.toString()===privateKey.publicKey.toString()&&results.push(new TransactionSignature({publicKey:privateKey.publicKey,prevTxId:self.prevTxId,outputIndex:self.outputIndex,inputIndex:index,signature:Sighash.sign(transaction,privateKey,sigtype,index,self.redeemScript),sigtype:sigtype}))}),results},MultiSigScriptHashInput.prototype.addSignature=function(transaction,signature){return $.checkState(!this.isFullySigned(),"All needed signatures have already been added"),$.checkArgument(!_.isUndefined(this.publicKeyIndex[signature.publicKey.toString()]),"Signature has no matching public key"),$.checkState(this.isValidSignature(transaction,signature)),this.signatures[this.publicKeyIndex[signature.publicKey.toString()]]=signature,this._updateScript(),this},MultiSigScriptHashInput.prototype._updateScript=function(){return this.setScript(Script.buildP2SHMultisigIn(this.publicKeys,this.threshold,this._createSignatures(),{cachedMultisig:this.redeemScript})),this},MultiSigScriptHashInput.prototype._createSignatures=function(){return _.map(_.filter(this.signatures,function(signature){return!_.isUndefined(signature)}),function(signature){return BufferUtil.concat([signature.signature.toDER(),BufferUtil.integerAsSingleByteBuffer(signature.sigtype)])})},MultiSigScriptHashInput.prototype.clearSignatures=function(){this.signatures=new Array(this.publicKeys.length),this._updateScript()},MultiSigScriptHashInput.prototype.isFullySigned=function(){return this.countSignatures()===this.threshold},MultiSigScriptHashInput.prototype.countMissingSignatures=function(){return this.threshold-this.countSignatures()},MultiSigScriptHashInput.prototype.countSignatures=function(){return _.reduce(this.signatures,function(sum,signature){return sum+!!signature},0)},MultiSigScriptHashInput.prototype.publicKeysWithoutSignature=function(){var self=this;return _.filter(this.publicKeys,function(publicKey){return!self.signatures[self.publicKeyIndex[publicKey.toString()]]})},MultiSigScriptHashInput.prototype.isValidSignature=function(transaction,signature){return signature.signature.nhashtype=signature.sigtype,Sighash.verify(transaction,signature.signature,signature.publicKey,signature.inputIndex,this.redeemScript)},MultiSigScriptHashInput.OPCODES_SIZE=7,MultiSigScriptHashInput.SIGNATURE_SIZE=74,MultiSigScriptHashInput.PUBKEY_SIZE=34,MultiSigScriptHashInput.prototype._estimateSize=function(){return MultiSigScriptHashInput.OPCODES_SIZE+this.threshold*MultiSigScriptHashInput.SIGNATURE_SIZE+this.publicKeys.length*MultiSigScriptHashInput.PUBKEY_SIZE},module.exports=MultiSigScriptHashInput},{"../../crypto/signature":45,"../../publickey":59,"../../script":60,"../../util/buffer":77,"../../util/preconditions":79,"../output":70,"../sighash":71,"../signature":72,"./input":65,inherits:104,lodash:105}],68:[function(require,module,exports){"use strict";function PublicKeyInput(){Input.apply(this,arguments)}var inherits=require("inherits"),$=require("../../util/preconditions"),Input=(require("../../util/buffer"),require("./input")),Output=require("../output"),Sighash=require("../sighash"),Script=require("../../script"),Signature=require("../../crypto/signature"),TransactionSignature=require("../signature");inherits(PublicKeyInput,Input),PublicKeyInput.prototype.getSignatures=function(transaction,privateKey,index,sigtype){$.checkState(this.output instanceof Output),sigtype=sigtype||Signature.SIGHASH_ALL;var publicKey=privateKey.toPublicKey();return publicKey.toString()===this.output.script.getPublicKey().toString("hex")?[new TransactionSignature({publicKey:publicKey,prevTxId:this.prevTxId,outputIndex:this.outputIndex,inputIndex:index,signature:Sighash.sign(transaction,privateKey,sigtype,index,this.output.script),sigtype:sigtype})]:[]},PublicKeyInput.prototype.addSignature=function(transaction,signature){return $.checkState(this.isValidSignature(transaction,signature),"Signature is invalid"),this.setScript(Script.buildPublicKeyIn(signature.signature.toDER(),signature.sigtype)),this},PublicKeyInput.prototype.clearSignatures=function(){return this.setScript(Script.empty()),this},PublicKeyInput.prototype.isFullySigned=function(){return this.script.isPublicKeyIn()},PublicKeyInput.SCRIPT_MAX_SIZE=73,PublicKeyInput.prototype._estimateSize=function(){return PublicKeyInput.SCRIPT_MAX_SIZE},module.exports=PublicKeyInput},{"../../crypto/signature":45,"../../script":60,"../../util/buffer":77,"../../util/preconditions":79,"../output":70,"../sighash":71,"../signature":72,"./input":65,inherits:104}],69:[function(require,module,exports){"use strict";function PublicKeyHashInput(){Input.apply(this,arguments)}var inherits=require("inherits"),$=require("../../util/preconditions"),BufferUtil=require("../../util/buffer"),Hash=require("../../crypto/hash"),Input=require("./input"),Output=require("../output"),Sighash=require("../sighash"),Script=require("../../script"),Signature=require("../../crypto/signature"),TransactionSignature=require("../signature");inherits(PublicKeyHashInput,Input),PublicKeyHashInput.prototype.getSignatures=function(transaction,privateKey,index,sigtype,hashData){return $.checkState(this.output instanceof Output),hashData=hashData||Hash.sha256ripemd160(privateKey.publicKey.toBuffer()),sigtype=sigtype||Signature.SIGHASH_ALL,BufferUtil.equals(hashData,this.output.script.getPublicKeyHash())?[new TransactionSignature({publicKey:privateKey.publicKey,prevTxId:this.prevTxId,outputIndex:this.outputIndex,inputIndex:index,signature:Sighash.sign(transaction,privateKey,sigtype,index,this.output.script),sigtype:sigtype})]:[]},PublicKeyHashInput.prototype.addSignature=function(transaction,signature){return $.checkState(this.isValidSignature(transaction,signature),"Signature is invalid"),this.setScript(Script.buildPublicKeyHashIn(signature.publicKey,signature.signature.toDER(),signature.sigtype)),this},PublicKeyHashInput.prototype.clearSignatures=function(){return this.setScript(Script.empty()),this},PublicKeyHashInput.prototype.isFullySigned=function(){return this.script.isPublicKeyHashIn()},PublicKeyHashInput.SCRIPT_MAX_SIZE=107,PublicKeyHashInput.prototype._estimateSize=function(){return PublicKeyHashInput.SCRIPT_MAX_SIZE},module.exports=PublicKeyHashInput},{"../../crypto/hash":42,"../../crypto/signature":45,"../../script":60,"../../util/buffer":77,"../../util/preconditions":79,"../output":70,"../sighash":71,"../signature":72,"./input":65,inherits:104}],70:[function(require,module,exports){"use strict";function Output(args){if(!(this instanceof Output))return new Output(args);if(!_.isObject(args))throw new TypeError("Unrecognized argument for Output");if(this.satoshis=args.satoshis,bufferUtil.isBuffer(args.script))this._scriptBuffer=args.script;else{var script;script=_.isString(args.script)&&JSUtil.isHexa(args.script)?new buffer.Buffer(args.script,"hex"):args.script,this.setScript(script)}}var _=require("lodash"),BN=require("../crypto/bn"),buffer=require("buffer"),bufferUtil=require("../util/buffer"),JSUtil=require("../util/js"),BufferWriter=require("../encoding/bufferwriter"),Script=require("../script"),$=require("../util/preconditions"),errors=require("../errors"),MAX_SAFE_INTEGER=9007199254740991;Object.defineProperty(Output.prototype,"script",{configurable:!1,enumerable:!0,get:function(){return this._script?this._script:(this.setScriptFromBuffer(this._scriptBuffer),this._script)}}),Object.defineProperty(Output.prototype,"satoshis",{configurable:!1,enumerable:!0,get:function(){return this._satoshis},set:function(num){num instanceof BN?(this._satoshisBN=num,this._satoshis=num.toNumber()):_.isString(num)?(this._satoshis=parseInt(num),this._satoshisBN=BN.fromNumber(this._satoshis)):($.checkArgument(JSUtil.isNaturalNumber(num),"Output satoshis is not a natural number"),this._satoshisBN=BN.fromNumber(num),this._satoshis=num),$.checkState(JSUtil.isNaturalNumber(this._satoshis),"Output satoshis is not a natural number")}}),Output.prototype.invalidSatoshis=function(){return this._satoshis>MAX_SAFE_INTEGER?"transaction txout satoshis greater than max safe integer":this._satoshis!==this._satoshisBN.toNumber()?"transaction txout satoshis has corrupted value":this._satoshis<0&&"transaction txout negative"},Output.prototype.toObject=Output.prototype.toJSON=function(){var obj={satoshis:this.satoshis};return obj.script=this._scriptBuffer.toString("hex"),obj},Output.fromObject=function(data){return new Output(data)},Output.prototype.setScriptFromBuffer=function(buffer){this._scriptBuffer=buffer;try{this._script=Script.fromBuffer(this._scriptBuffer),this._script._isOutput=!0}catch(e){if(!(e instanceof errors.Script.InvalidBuffer))throw e;this._script=null}},Output.prototype.setScript=function(script){if(script instanceof Script)this._scriptBuffer=script.toBuffer(),this._script=script,this._script._isOutput=!0;else if(_.isString(script))this._script=Script.fromString(script),this._scriptBuffer=this._script.toBuffer(),this._script._isOutput=!0;else{if(!bufferUtil.isBuffer(script))throw new TypeError("Invalid argument type: script");this.setScriptFromBuffer(script)}return this},Output.prototype.inspect=function(){var scriptStr;return scriptStr=this.script?this.script.inspect():this._scriptBuffer.toString("hex"),"<Output ("+this.satoshis+" sats) "+scriptStr+">"},Output.fromBufferReader=function(br){var obj={};obj.satoshis=br.readUInt64LEBN();var size=br.readVarintNum();return 0!==size?obj.script=br.read(size):obj.script=new buffer.Buffer([]),new Output(obj)},Output.prototype.toBufferWriter=function(writer){writer||(writer=new BufferWriter),writer.writeUInt64LEBN(this._satoshisBN);var script=this._scriptBuffer;return writer.writeVarintNum(script.length),writer.write(script),writer},module.exports=Output},{"../crypto/bn":40,"../encoding/bufferwriter":49,"../errors":51,"../script":60,"../util/buffer":77,"../util/js":78,"../util/preconditions":79,buffer:151,lodash:105}],71:[function(require,module,exports){(function(Buffer){"use strict";function sign(transaction,privateKey,sighashType,inputIndex,subscript){var hashbuf=sighash(transaction,sighashType,inputIndex,subscript),sig=ECDSA.sign(hashbuf,privateKey,"little").set({nhashtype:sighashType});return sig}function verify(transaction,signature,publicKey,inputIndex,subscript){$.checkArgument(!_.isUndefined(transaction)),$.checkArgument(!_.isUndefined(signature)&&!_.isUndefined(signature.nhashtype));var hashbuf=sighash(transaction,signature.nhashtype,inputIndex,subscript);return ECDSA.verify(hashbuf,signature,publicKey,"little")}var buffer=require("buffer"),Signature=require("../crypto/signature"),Script=require("../script"),Output=require("./output"),BufferReader=require("../encoding/bufferreader"),BufferWriter=require("../encoding/bufferwriter"),BN=require("../crypto/bn"),Hash=require("../crypto/hash"),ECDSA=require("../crypto/ecdsa"),$=require("../util/preconditions"),_=require("lodash"),SIGHASH_SINGLE_BUG="0000000000000000000000000000000000000000000000000000000000000001",BITS_64_ON="ffffffffffffffff",sighash=function(transaction,sighashType,inputNumber,subscript){var i,Transaction=require("./transaction"),Input=require("./input"),txcopy=Transaction.shallowCopy(transaction);for(subscript=new Script(subscript),subscript.removeCodeseparators(),i=0;i<txcopy.inputs.length;i++)txcopy.inputs[i]=new Input(txcopy.inputs[i]).setScript(Script.empty());if(txcopy.inputs[inputNumber]=new Input(txcopy.inputs[inputNumber]).setScript(subscript),(31&sighashType)===Signature.SIGHASH_NONE||(31&sighashType)===Signature.SIGHASH_SINGLE)for(i=0;i<txcopy.inputs.length;i++)i!==inputNumber&&(txcopy.inputs[i].sequenceNumber=0);if((31&sighashType)===Signature.SIGHASH_NONE)txcopy.outputs=[];else if((31&sighashType)===Signature.SIGHASH_SINGLE){if(inputNumber>=txcopy.outputs.length)return new Buffer(SIGHASH_SINGLE_BUG,"hex");for(txcopy.outputs.length=inputNumber+1,i=0;i<inputNumber;i++)txcopy.outputs[i]=new Output({satoshis:BN.fromBuffer(new buffer.Buffer(BITS_64_ON,"hex")),script:Script.empty()})}sighashType&Signature.SIGHASH_ANYONECANPAY&&(txcopy.inputs=[txcopy.inputs[inputNumber]]);var buf=(new BufferWriter).write(txcopy.toBuffer()).writeInt32LE(sighashType).toBuffer(),ret=Hash.sha256sha256(buf);return ret=new BufferReader(ret).readReverse()};module.exports={sighash:sighash,sign:sign,verify:verify}}).call(this,require("buffer").Buffer)},{"../crypto/bn":40,"../crypto/ecdsa":41,"../crypto/hash":42,"../crypto/signature":45,"../encoding/bufferreader":48,"../encoding/bufferwriter":49,"../script":60,"../util/preconditions":79,"./input":64,"./output":70,"./transaction":73,buffer:151,lodash:105}],72:[function(require,module,exports){(function(Buffer){"use strict";function TransactionSignature(arg){if(!(this instanceof TransactionSignature))return new TransactionSignature(arg);if(arg instanceof TransactionSignature)return arg;if(_.isObject(arg))return this._fromObject(arg);throw new errors.InvalidArgument("TransactionSignatures must be instantiated from an object")}var _=require("lodash"),$=require("../util/preconditions"),inherits=require("inherits"),BufferUtil=require("../util/buffer"),JSUtil=require("../util/js"),PublicKey=require("../publickey"),errors=require("../errors"),Signature=require("../crypto/signature");inherits(TransactionSignature,Signature),TransactionSignature.prototype._fromObject=function(arg){return this._checkObjectArgs(arg),this.publicKey=new PublicKey(arg.publicKey),this.prevTxId=BufferUtil.isBuffer(arg.prevTxId)?arg.prevTxId:new Buffer(arg.prevTxId,"hex"),this.outputIndex=arg.outputIndex,this.inputIndex=arg.inputIndex,this.signature=arg.signature instanceof Signature?arg.signature:BufferUtil.isBuffer(arg.signature)?Signature.fromBuffer(arg.signature):Signature.fromString(arg.signature),this.sigtype=arg.sigtype,this},TransactionSignature.prototype._checkObjectArgs=function(arg){$.checkArgument(PublicKey(arg.publicKey),"publicKey"),$.checkArgument(!_.isUndefined(arg.inputIndex),"inputIndex"),$.checkArgument(!_.isUndefined(arg.outputIndex),"outputIndex"),$.checkState(_.isNumber(arg.inputIndex),"inputIndex must be a number"),$.checkState(_.isNumber(arg.outputIndex),"outputIndex must be a number"),$.checkArgument(arg.signature,"signature"),$.checkArgument(arg.prevTxId,"prevTxId"),$.checkState(arg.signature instanceof Signature||BufferUtil.isBuffer(arg.signature)||JSUtil.isHexa(arg.signature),"signature must be a buffer or hexa value"),$.checkState(BufferUtil.isBuffer(arg.prevTxId)||JSUtil.isHexa(arg.prevTxId),"prevTxId must be a buffer or hexa value"),$.checkArgument(arg.sigtype,"sigtype"),$.checkState(_.isNumber(arg.sigtype),"sigtype must be a number")},TransactionSignature.prototype.toObject=TransactionSignature.prototype.toJSON=function(){return{publicKey:this.publicKey.toString(),prevTxId:this.prevTxId.toString("hex"),outputIndex:this.outputIndex,inputIndex:this.inputIndex,signature:this.signature.toString(),sigtype:this.sigtype}},TransactionSignature.fromObject=function(object){return $.checkArgument(object),new TransactionSignature(object)},module.exports=TransactionSignature}).call(this,require("buffer").Buffer)},{"../crypto/signature":45,"../errors":51,"../publickey":59,"../util/buffer":77,"../util/js":78,"../util/preconditions":79,buffer:151,inherits:104,lodash:105}],73:[function(require,module,exports){(function(Buffer){"use strict";function Transaction(serialized){if(!(this instanceof Transaction))return new Transaction(serialized);if(this.inputs=[],this.outputs=[],this._inputAmount=void 0,this._outputAmount=void 0,serialized){if(serialized instanceof Transaction)return Transaction.shallowCopy(serialized);if(JSUtil.isHexa(serialized))this.fromString(serialized);else if(BufferUtil.isBuffer(serialized))this.fromBuffer(serialized);else{if(!_.isObject(serialized))throw new errors.InvalidArgument("Must provide an object or string to deserialize a transaction");this.fromObject(serialized)}}else this._newTransaction()}var _=require("lodash"),$=require("../util/preconditions"),buffer=require("buffer"),compare=Buffer.compare||require("buffer-compare"),errors=require("../errors"),BufferUtil=require("../util/buffer"),JSUtil=require("../util/js"),BufferReader=require("../encoding/bufferreader"),BufferWriter=require("../encoding/bufferwriter"),Hash=require("../crypto/hash"),Signature=require("../crypto/signature"),Sighash=require("./sighash"),Address=require("../address"),UnspentOutput=require("./unspentoutput"),Input=require("./input"),PublicKeyHashInput=Input.PublicKeyHash,PublicKeyInput=Input.PublicKey,MultiSigScriptHashInput=Input.MultiSigScriptHash,MultiSigInput=Input.MultiSig,Output=require("./output"),Script=require("../script"),PrivateKey=require("../privatekey"),BN=require("../crypto/bn"),CURRENT_VERSION=1,DEFAULT_NLOCKTIME=0,MAX_BLOCK_SIZE=1e6;Transaction.DUST_AMOUNT=546,Transaction.FEE_SECURITY_MARGIN=15,Transaction.MAX_MONEY=21e14,Transaction.NLOCKTIME_BLOCKHEIGHT_LIMIT=5e8,Transaction.NLOCKTIME_MAX_VALUE=4294967295,Transaction.FEE_PER_KB=1e4,Transaction.CHANGE_OUTPUT_MAX_SIZE=62,Transaction.MAXIMUM_EXTRA_SIZE=26,Transaction.shallowCopy=function(transaction){var copy=new Transaction(transaction.toBuffer());return copy};var hashProperty={configurable:!1,enumerable:!0,get:function(){return new BufferReader(this._getHash()).readReverse().toString("hex")}};Object.defineProperty(Transaction.prototype,"hash",hashProperty),Object.defineProperty(Transaction.prototype,"id",hashProperty);var ioProperty={configurable:!1,enumerable:!0,get:function(){return this._getInputAmount()}};Object.defineProperty(Transaction.prototype,"inputAmount",ioProperty),ioProperty.get=function(){
return this._getOutputAmount()},Object.defineProperty(Transaction.prototype,"outputAmount",ioProperty),Transaction.prototype._getHash=function(){return Hash.sha256sha256(this.toBuffer())},Transaction.prototype.serialize=function(unsafe){return!0===unsafe||unsafe&&unsafe.disableAll?this.uncheckedSerialize():this.checkedSerialize(unsafe)},Transaction.prototype.uncheckedSerialize=Transaction.prototype.toString=function(){return this.toBuffer().toString("hex")},Transaction.prototype.checkedSerialize=function(opts){var serializationError=this.getSerializationError(opts);if(serializationError)throw serializationError.message+=" Use Transaction#uncheckedSerialize if you want to skip security checks. See http://bitcore.io/guide/transaction.html#Serialization for more info.",serializationError;return this.uncheckedSerialize()},Transaction.prototype.invalidSatoshis=function(){for(var invalid=!1,i=0;i<this.outputs.length;i++)this.outputs[i].invalidSatoshis()&&(invalid=!0);return invalid},Transaction.prototype.getSerializationError=function(opts){if(opts=opts||{},this.invalidSatoshis())return new errors.Transaction.InvalidSatoshis;var unspentError,unspent=this._getUnspentValue();return unspent<0?opts.disableMoreOutputThanInput||(unspentError=new errors.Transaction.InvalidOutputAmountSum):unspentError=this._hasFeeError(opts,unspent),unspentError||this._hasDustOutputs(opts)||this._isMissingSignatures(opts)},Transaction.prototype._hasFeeError=function(opts,unspent){if(!_.isUndefined(this._fee)&&this._fee!==unspent)return new errors.Transaction.FeeError.Different("Unspent value is "+unspent+" but specified fee is "+this._fee);if(!opts.disableLargeFees){var maximumFee=Math.floor(Transaction.FEE_SECURITY_MARGIN*this._estimateFee());if(unspent>maximumFee)return this._missingChange()?new errors.Transaction.ChangeAddressMissing("Fee is too large and no change address was provided"):new errors.Transaction.FeeError.TooLarge("expected less than "+maximumFee+" but got "+unspent)}if(!opts.disableSmallFees){var minimumFee=Math.ceil(this._estimateFee()/Transaction.FEE_SECURITY_MARGIN);if(unspent<minimumFee)return new errors.Transaction.FeeError.TooSmall("expected more than "+minimumFee+" but got "+unspent)}},Transaction.prototype._missingChange=function(){return!this._changeScript},Transaction.prototype._hasDustOutputs=function(opts){if(!opts.disableDustOutputs){var index,output;for(index in this.outputs)if(output=this.outputs[index],output.satoshis<Transaction.DUST_AMOUNT&&!output.script.isDataOut())return new errors.Transaction.DustOutputs}},Transaction.prototype._isMissingSignatures=function(opts){if(!opts.disableIsFullySigned)return this.isFullySigned()?void 0:new errors.Transaction.MissingSignatures},Transaction.prototype.inspect=function(){return"<Transaction: "+this.uncheckedSerialize()+">"},Transaction.prototype.toBuffer=function(){var writer=new BufferWriter;return this.toBufferWriter(writer).toBuffer()},Transaction.prototype.toBufferWriter=function(writer){return writer.writeUInt32LE(this.version),writer.writeVarintNum(this.inputs.length),_.each(this.inputs,function(input){input.toBufferWriter(writer)}),writer.writeVarintNum(this.outputs.length),_.each(this.outputs,function(output){output.toBufferWriter(writer)}),writer.writeUInt32LE(this.nLockTime),writer},Transaction.prototype.fromBuffer=function(buffer){var reader=new BufferReader(buffer);return this.fromBufferReader(reader)},Transaction.prototype.fromBufferReader=function(reader){$.checkArgument(!reader.finished(),"No transaction data received");var i,sizeTxIns,sizeTxOuts;for(this.version=reader.readUInt32LE(),sizeTxIns=reader.readVarintNum(),i=0;i<sizeTxIns;i++){var input=Input.fromBufferReader(reader);this.inputs.push(input)}for(sizeTxOuts=reader.readVarintNum(),i=0;i<sizeTxOuts;i++)this.outputs.push(Output.fromBufferReader(reader));return this.nLockTime=reader.readUInt32LE(),this},Transaction.prototype.toObject=Transaction.prototype.toJSON=function(){var inputs=[];this.inputs.forEach(function(input){inputs.push(input.toObject())});var outputs=[];this.outputs.forEach(function(output){outputs.push(output.toObject())});var obj={hash:this.hash,version:this.version,inputs:inputs,outputs:outputs,nLockTime:this.nLockTime};return this._changeScript&&(obj.changeScript=this._changeScript.toString()),_.isUndefined(this._changeIndex)||(obj.changeIndex=this._changeIndex),_.isUndefined(this._fee)||(obj.fee=this._fee),obj},Transaction.prototype.fromObject=function(arg){$.checkArgument(_.isObject(arg)||arg instanceof Transaction);var transaction,self=this;return transaction=arg instanceof Transaction?transaction.toObject():arg,_.each(transaction.inputs,function(input){if(!input.output||!input.output.script)return void self.uncheckedAddInput(new Input(input));var txin,script=new Script(input.output.script);if(script.isPublicKeyHashOut())txin=new Input.PublicKeyHash(input);else if(script.isScriptHashOut()&&input.publicKeys&&input.threshold)txin=new Input.MultiSigScriptHash(input,input.publicKeys,input.threshold,input.signatures);else{if(!script.isPublicKeyOut())throw new errors.Transaction.Input.UnsupportedScript(input.output.script);txin=new Input.PublicKey(input)}self.addInput(txin)}),_.each(transaction.outputs,function(output){self.addOutput(new Output(output))}),transaction.changeIndex&&(this._changeIndex=transaction.changeIndex),transaction.changeScript&&(this._changeScript=new Script(transaction.changeScript)),transaction.fee&&(this._fee=transaction.fee),this.nLockTime=transaction.nLockTime,this.version=transaction.version,this._checkConsistency(arg),this},Transaction.prototype._checkConsistency=function(arg){_.isUndefined(this._changeIndex)||($.checkState(this._changeScript),$.checkState(this.outputs[this._changeIndex]),$.checkState(this.outputs[this._changeIndex].script.toString()===this._changeScript.toString())),arg&&arg.hash&&$.checkState(arg.hash===this.hash,"Hash in object does not match transaction hash")},Transaction.prototype.lockUntilDate=function(time){if($.checkArgument(time),_.isNumber(time)&&time<Transaction.NLOCKTIME_BLOCKHEIGHT_LIMIT)throw new errors.Transaction.LockTimeTooEarly;_.isDate(time)&&(time=time.getTime()/1e3);for(var i=0;i<this.inputs.length;i++)this.inputs[i].sequenceNumber===Input.DEFAULT_SEQNUMBER&&(this.inputs[i].sequenceNumber=Input.DEFAULT_LOCKTIME_SEQNUMBER);return this.nLockTime=time,this},Transaction.prototype.lockUntilBlockHeight=function(height){if($.checkArgument(_.isNumber(height)),height>=Transaction.NLOCKTIME_BLOCKHEIGHT_LIMIT)throw new errors.Transaction.BlockHeightTooHigh;if(height<0)throw new errors.Transaction.NLockTimeOutOfRange;for(var i=0;i<this.inputs.length;i++)this.inputs[i].sequenceNumber===Input.DEFAULT_SEQNUMBER&&(this.inputs[i].sequenceNumber=Input.DEFAULT_LOCKTIME_SEQNUMBER);return this.nLockTime=height,this},Transaction.prototype.getLockTime=function(){return this.nLockTime?this.nLockTime<Transaction.NLOCKTIME_BLOCKHEIGHT_LIMIT?this.nLockTime:new Date(1e3*this.nLockTime):null},Transaction.prototype.fromString=function(string){this.fromBuffer(new buffer.Buffer(string,"hex"))},Transaction.prototype._newTransaction=function(){this.version=CURRENT_VERSION,this.nLockTime=DEFAULT_NLOCKTIME},Transaction.prototype.from=function(utxo,pubkeys,threshold){if(_.isArray(utxo)){var self=this;return _.each(utxo,function(utxo){self.from(utxo,pubkeys,threshold)}),this}var exists=_.any(this.inputs,function(input){return input.prevTxId.toString("hex")===utxo.txId&&input.outputIndex===utxo.outputIndex});return exists?this:(pubkeys&&threshold?this._fromMultisigUtxo(utxo,pubkeys,threshold):this._fromNonP2SH(utxo),this)},Transaction.prototype._fromNonP2SH=function(utxo){var clazz;utxo=new UnspentOutput(utxo),clazz=utxo.script.isPublicKeyHashOut()?PublicKeyHashInput:utxo.script.isPublicKeyOut()?PublicKeyInput:Input,this.addInput(new clazz({output:new Output({script:utxo.script,satoshis:utxo.satoshis}),prevTxId:utxo.txId,outputIndex:utxo.outputIndex,script:Script.empty()}))},Transaction.prototype._fromMultisigUtxo=function(utxo,pubkeys,threshold){$.checkArgument(threshold<=pubkeys.length,"Number of required signatures must be greater than the number of public keys");var clazz;if(utxo=new UnspentOutput(utxo),utxo.script.isMultisigOut())clazz=MultiSigInput;else{if(!utxo.script.isScriptHashOut())throw new Error("@TODO");clazz=MultiSigScriptHashInput}this.addInput(new clazz({output:new Output({script:utxo.script,satoshis:utxo.satoshis}),prevTxId:utxo.txId,outputIndex:utxo.outputIndex,script:Script.empty()},pubkeys,threshold))},Transaction.prototype.addInput=function(input,outputScript,satoshis){if($.checkArgumentType(input,Input,"input"),!input.output&&(_.isUndefined(outputScript)||_.isUndefined(satoshis)))throw new errors.Transaction.NeedMoreInfo("Need information about the UTXO script and satoshis");return input.output||!outputScript||_.isUndefined(satoshis)||(outputScript=outputScript instanceof Script?outputScript:new Script(outputScript),$.checkArgumentType(satoshis,"number","satoshis"),input.output=new Output({script:outputScript,satoshis:satoshis})),this.uncheckedAddInput(input)},Transaction.prototype.uncheckedAddInput=function(input){return $.checkArgumentType(input,Input,"input"),this.inputs.push(input),this._inputAmount=void 0,this._updateChangeOutput(),this},Transaction.prototype.hasAllUtxoInfo=function(){return _.all(this.inputs.map(function(input){return!!input.output}))},Transaction.prototype.fee=function(amount){return $.checkArgument(_.isNumber(amount),"amount must be a number"),this._fee=amount,this._updateChangeOutput(),this},Transaction.prototype.feePerKb=function(amount){return $.checkArgument(_.isNumber(amount),"amount must be a number"),this._feePerKb=amount,this._updateChangeOutput(),this},Transaction.prototype.change=function(address){return $.checkArgument(address,"address is required"),this._changeScript=Script.fromAddress(address),this._updateChangeOutput(),this},Transaction.prototype.getChangeOutput=function(){return _.isUndefined(this._changeIndex)?null:this.outputs[this._changeIndex]},Transaction.prototype.to=function(address,amount){if(_.isArray(address)){var self=this;return _.each(address,function(to){self.to(to.address,to.satoshis)}),this}return $.checkArgument(JSUtil.isNaturalNumber(amount),"Amount is expected to be a positive integer"),this.addOutput(new Output({script:Script(new Address(address)),satoshis:amount})),this},Transaction.prototype.addData=function(value){return this.addOutput(new Output({script:Script.buildDataOut(value),satoshis:0})),this},Transaction.prototype.addOutput=function(output){return $.checkArgumentType(output,Output,"output"),this._addOutput(output),this._updateChangeOutput(),this},Transaction.prototype.clearOutputs=function(){return this.outputs=[],this._clearSignatures(),this._outputAmount=void 0,this._changeIndex=void 0,this._updateChangeOutput(),this},Transaction.prototype._addOutput=function(output){this.outputs.push(output),this._outputAmount=void 0},Transaction.prototype._getOutputAmount=function(){if(_.isUndefined(this._outputAmount)){var self=this;this._outputAmount=0,_.each(this.outputs,function(output){self._outputAmount+=output.satoshis})}return this._outputAmount},Transaction.prototype._getInputAmount=function(){if(_.isUndefined(this._inputAmount)){var self=this;this._inputAmount=0,_.each(this.inputs,function(input){if(_.isUndefined(input.output))throw new errors.Transaction.Input.MissingPreviousOutput;self._inputAmount+=input.output.satoshis})}return this._inputAmount},Transaction.prototype._updateChangeOutput=function(){if(this._changeScript){this._clearSignatures(),_.isUndefined(this._changeIndex)||this._removeOutput(this._changeIndex);var available=this._getUnspentValue(),fee=this.getFee(),changeAmount=available-fee;changeAmount>0?(this._changeIndex=this.outputs.length,this._addOutput(new Output({script:this._changeScript,satoshis:changeAmount}))):this._changeIndex=void 0}},Transaction.prototype.getFee=function(){return this.isCoinbase()?0:_.isUndefined(this._fee)?this._changeScript?this._estimateFee():this._getUnspentValue():this._fee},Transaction.prototype._estimateFee=function(){var estimatedSize=this._estimateSize(),available=this._getUnspentValue();return Transaction._estimateFee(estimatedSize,available,this._feePerKb)},Transaction.prototype._getUnspentValue=function(){return this._getInputAmount()-this._getOutputAmount()},Transaction.prototype._clearSignatures=function(){_.each(this.inputs,function(input){input.clearSignatures()})},Transaction._estimateFee=function(size,amountAvailable,feePerKb){var fee=Math.ceil(size/1e3)*(feePerKb||Transaction.FEE_PER_KB);return amountAvailable>fee&&(size+=Transaction.CHANGE_OUTPUT_MAX_SIZE),Math.ceil(size/1e3)*(feePerKb||Transaction.FEE_PER_KB)},Transaction.prototype._estimateSize=function(){var result=Transaction.MAXIMUM_EXTRA_SIZE;return _.each(this.inputs,function(input){result+=input._estimateSize()}),_.each(this.outputs,function(output){result+=output.script.toBuffer().length+9}),result},Transaction.prototype._removeOutput=function(index){var output=this.outputs[index];this.outputs=_.without(this.outputs,output),this._outputAmount=void 0},Transaction.prototype.removeOutput=function(index){this._removeOutput(index),this._updateChangeOutput()},Transaction.prototype.sort=function(){return this.sortInputs(function(inputs){var copy=Array.prototype.concat.apply([],inputs);return copy.sort(function(first,second){return compare(first.prevTxId,second.prevTxId)||first.outputIndex-second.outputIndex}),copy}),this.sortOutputs(function(outputs){var copy=Array.prototype.concat.apply([],outputs);return copy.sort(function(first,second){return first.satoshis-second.satoshis||compare(first.script.toBuffer(),second.script.toBuffer())}),copy}),this},Transaction.prototype.shuffleOutputs=function(){return this.sortOutputs(_.shuffle)},Transaction.prototype.sortOutputs=function(sortingFunction){var outs=sortingFunction(this.outputs);return this._newOutputOrder(outs)},Transaction.prototype.sortInputs=function(sortingFunction){return this.inputs=sortingFunction(this.inputs),this._clearSignatures(),this},Transaction.prototype._newOutputOrder=function(newOutputs){var isInvalidSorting=this.outputs.length!==newOutputs.length||0!==_.difference(this.outputs,newOutputs).length;if(isInvalidSorting)throw new errors.Transaction.InvalidSorting;if(!_.isUndefined(this._changeIndex)){var changeOutput=this.outputs[this._changeIndex];this._changeIndex=_.findIndex(newOutputs,changeOutput)}return this.outputs=newOutputs,this},Transaction.prototype.removeInput=function(txId,outputIndex){var index;if(index=!outputIndex&&_.isNumber(txId)?txId:_.findIndex(this.inputs,function(input){return input.prevTxId.toString("hex")===txId&&input.outputIndex===outputIndex}),index<0||index>=this.inputs.length)throw new errors.Transaction.InvalidIndex(index,this.inputs.length);var input=this.inputs[index];this.inputs=_.without(this.inputs,input),this._inputAmount=void 0,this._updateChangeOutput()},Transaction.prototype.sign=function(privateKey,sigtype){$.checkState(this.hasAllUtxoInfo());var self=this;return _.isArray(privateKey)?(_.each(privateKey,function(privateKey){self.sign(privateKey,sigtype)}),this):(_.each(this.getSignatures(privateKey,sigtype),function(signature){self.applySignature(signature)}),this)},Transaction.prototype.getSignatures=function(privKey,sigtype){privKey=new PrivateKey(privKey),sigtype=sigtype||Signature.SIGHASH_ALL;var transaction=this,results=[],hashData=Hash.sha256ripemd160(privKey.publicKey.toBuffer());return _.each(this.inputs,function(input,index){_.each(input.getSignatures(transaction,privKey,index,sigtype,hashData),function(signature){results.push(signature)})}),results},Transaction.prototype.applySignature=function(signature){return this.inputs[signature.inputIndex].addSignature(this,signature),this},Transaction.prototype.isFullySigned=function(){return _.each(this.inputs,function(input){if(input.isFullySigned===Input.prototype.isFullySigned)throw new errors.Transaction.UnableToVerifySignature("Unrecognized script kind, or not enough information to execute script.This usually happens when creating a transaction from a serialized transaction")}),_.all(_.map(this.inputs,function(input){return input.isFullySigned()}))},Transaction.prototype.isValidSignature=function(signature){var self=this;if(this.inputs[signature.inputIndex].isValidSignature===Input.prototype.isValidSignature)throw new errors.Transaction.UnableToVerifySignature("Unrecognized script kind, or not enough information to execute script.This usually happens when creating a transaction from a serialized transaction");return this.inputs[signature.inputIndex].isValidSignature(self,signature)},Transaction.prototype.verifySignature=function(sig,pubkey,nin,subscript){return Sighash.verify(this,sig,pubkey,nin,subscript)},Transaction.prototype.verify=function(){if(0===this.inputs.length)return"transaction txins empty";if(0===this.outputs.length)return"transaction txouts empty";for(var valueoutbn=new BN(0),i=0;i<this.outputs.length;i++){var txout=this.outputs[i];if(txout.invalidSatoshis())return"transaction txout "+i+" satoshis is invalid";if(txout._satoshisBN.gt(new BN(Transaction.MAX_MONEY,10)))return"transaction txout "+i+" greater than MAX_MONEY";if(valueoutbn=valueoutbn.add(txout._satoshisBN),valueoutbn.gt(new BN(Transaction.MAX_MONEY)))return"transaction txout "+i+" total output greater than MAX_MONEY"}if(this.toBuffer().length>MAX_BLOCK_SIZE)return"transaction over the maximum block size";var txinmap={};for(i=0;i<this.inputs.length;i++){var txin=this.inputs[i],inputid=txin.prevTxId+":"+txin.outputIndex;if(!_.isUndefined(txinmap[inputid]))return"transaction input "+i+" duplicate input";txinmap[inputid]=!0}var isCoinbase=this.isCoinbase();if(isCoinbase){var buf=this.inputs[0]._scriptBuffer;if(buf.length<2||buf.length>100)return"coinbase transaction script size invalid"}else for(i=0;i<this.inputs.length;i++)if(this.inputs[i].isNull())return"transaction input "+i+" has null input";return!0},Transaction.prototype.isCoinbase=function(){return 1===this.inputs.length&&this.inputs[0].isNull()},Transaction.prototype.isRBF=function(){for(var i=0;i<this.inputs.length;i++){var input=this.inputs[i];if(input.sequenceNumber<Input.MAXINT-1)return!0}return!1},Transaction.prototype.enableRBF=function(){for(var i=0;i<this.inputs.length;i++){var input=this.inputs[i];input.sequenceNumber>=Input.MAXINT-1&&(input.sequenceNumber=Input.DEFAULT_RBF_SEQNUMBER)}return this},module.exports=Transaction}).call(this,require("buffer").Buffer)},{"../address":35,"../crypto/bn":40,"../crypto/hash":42,"../crypto/signature":45,"../encoding/bufferreader":48,"../encoding/bufferwriter":49,"../errors":51,"../privatekey":58,"../script":60,"../util/buffer":77,"../util/js":78,"../util/preconditions":79,"./input":64,"./output":70,"./sighash":71,"./unspentoutput":74,buffer:151,"buffer-compare":82,lodash:105}],74:[function(require,module,exports){"use strict";function UnspentOutput(data){if(!(this instanceof UnspentOutput))return new UnspentOutput(data);$.checkArgument(_.isObject(data),"Must provide an object from where to extract data");var address=data.address?new Address(data.address):void 0,txId=data.txid?data.txid:data.txId;if(!txId||!JSUtil.isHexaString(txId)||txId.length>64)throw new Error("Invalid TXID in object",data);var outputIndex=_.isUndefined(data.vout)?data.outputIndex:data.vout;if(!_.isNumber(outputIndex))throw new Error("Invalid outputIndex, received "+outputIndex);$.checkArgument(!_.isUndefined(data.scriptPubKey)||!_.isUndefined(data.script),"Must provide the scriptPubKey for that output!");var script=new Script(data.scriptPubKey||data.script);$.checkArgument(!_.isUndefined(data.amount)||!_.isUndefined(data.satoshis),"Must provide an amount for the output");var amount=_.isUndefined(data.amount)?data.satoshis:new Unit.fromBTC(data.amount).toSatoshis();$.checkArgument(_.isNumber(amount),"Amount must be a number"),JSUtil.defineImmutable(this,{address:address,txId:txId,outputIndex:outputIndex,script:script,satoshis:amount})}var _=require("lodash"),$=require("../util/preconditions"),JSUtil=require("../util/js"),Script=require("../script"),Address=require("../address"),Unit=require("../unit");UnspentOutput.prototype.inspect=function(){return"<UnspentOutput: "+this.txId+":"+this.outputIndex+", satoshis: "+this.satoshis+", address: "+this.address+">"},UnspentOutput.prototype.toString=function(){return this.txId+":"+this.outputIndex},UnspentOutput.fromObject=function(data){return new UnspentOutput(data)},UnspentOutput.prototype.toObject=UnspentOutput.prototype.toJSON=function(){return{address:this.address?this.address.toString():void 0,txid:this.txId,vout:this.outputIndex,scriptPubKey:this.script.toBuffer().toString("hex"),amount:Unit.fromSatoshis(this.satoshis).toBTC()}},module.exports=UnspentOutput},{"../address":35,"../script":60,"../unit":75,"../util/js":78,"../util/preconditions":79,lodash:105}],75:[function(require,module,exports){"use strict";function Unit(amount,code){if(!(this instanceof Unit))return new Unit(amount,code);if(_.isNumber(code)){if(code<=0)throw new errors.Unit.InvalidRate(code);amount/=code,code=Unit.BTC}this._value=this._from(amount,code);var self=this,defineAccesor=function(key){Object.defineProperty(self,key,{get:function(){return self.to(key)},enumerable:!0})};Object.keys(UNITS).forEach(defineAccesor)}var _=require("lodash"),errors=require("./errors"),$=require("./util/preconditions"),UNITS={BTC:[1e8,8],mBTC:[1e5,5],uBTC:[100,2],bits:[100,2],satoshis:[1,0]};Object.keys(UNITS).forEach(function(key){Unit[key]=key}),Unit.fromObject=function(data){return $.checkArgument(_.isObject(data),"Argument is expected to be an object"),new Unit(data.amount,data.code)},Unit.fromBTC=function(amount){return new Unit(amount,Unit.BTC)},Unit.fromMillis=Unit.fromMilis=function(amount){return new Unit(amount,Unit.mBTC)},Unit.fromMicros=Unit.fromBits=function(amount){return new Unit(amount,Unit.bits)},Unit.fromSatoshis=function(amount){return new Unit(amount,Unit.satoshis)},Unit.fromFiat=function(amount,rate){return new Unit(amount,rate)},Unit.prototype._from=function(amount,code){if(!UNITS[code])throw new errors.Unit.UnknownCode(code);return parseInt((amount*UNITS[code][0]).toFixed())},Unit.prototype.to=function(code){if(_.isNumber(code)){if(code<=0)throw new errors.Unit.InvalidRate(code);return parseFloat((this.BTC*code).toFixed(2))}if(!UNITS[code])throw new errors.Unit.UnknownCode(code);var value=this._value/UNITS[code][0];return parseFloat(value.toFixed(UNITS[code][1]))},Unit.prototype.toBTC=function(){return this.to(Unit.BTC)},Unit.prototype.toMillis=Unit.prototype.toMilis=function(){return this.to(Unit.mBTC)},Unit.prototype.toMicros=Unit.prototype.toBits=function(){return this.to(Unit.bits)},Unit.prototype.toSatoshis=function(){return this.to(Unit.satoshis)},Unit.prototype.atRate=function(rate){return this.to(rate)},Unit.prototype.toString=function(){return this.satoshis+" satoshis"},Unit.prototype.toObject=Unit.prototype.toJSON=function(){return{amount:this.BTC,code:Unit.BTC}},Unit.prototype.inspect=function(){return"<Unit: "+this.toString()+">"},module.exports=Unit},{"./errors":51,"./util/preconditions":79,lodash:105}],76:[function(require,module,exports){"use strict";var _=require("lodash"),URL=require("url"),Address=require("./address"),Unit=require("./unit"),URI=function(data,knownParams){if(!(this instanceof URI))return new URI(data,knownParams);if(this.extras={},this.knownParams=knownParams||[],this.address=this.network=this.amount=this.message=null,"string"==typeof data){var params=URI.parse(data);params.amount&&(params.amount=this._parseAmount(params.amount)),this._fromObject(params)}else{if("object"!=typeof data)throw new TypeError("Unrecognized data format.");this._fromObject(data)}};URI.fromString=function(str){if("string"!=typeof str)throw new TypeError("Expected a string");return new URI(str)},URI.fromObject=function(json){return new URI(json)},URI.isValid=function(arg,knownParams){try{new URI(arg,knownParams)}catch(err){return!1}return!0},URI.parse=function(uri){var info=URL.parse(uri,!0);if("bitcoin:"!==info.protocol)throw new TypeError("Invalid bitcoin URI");var group=/[^:]*:\/?\/?([^?]*)/.exec(uri);return info.query.address=group&&group[1]||void 0,info.query},URI.Members=["address","amount","message","label","r"],URI.prototype._fromObject=function(obj){if(!Address.isValid(obj.address))throw new TypeError("Invalid bitcoin address");this.address=new Address(obj.address),this.network=this.address.network,this.amount=obj.amount;for(var key in obj)if("address"!==key&&"amount"!==key){if(/^req-/.exec(key)&&this.knownParams.indexOf(key)===-1)throw Error("Unknown required argument "+key);var destination=URI.Members.indexOf(key)>-1?this:this.extras;destination[key]=obj[key]}},URI.prototype._parseAmount=function(amount){if(amount=Number(amount),isNaN(amount))throw new TypeError("Invalid amount");return Unit.fromBTC(amount).toSatoshis()},URI.prototype.toObject=URI.prototype.toJSON=function(){for(var json={},i=0;i<URI.Members.length;i++){var m=URI.Members[i];this.hasOwnProperty(m)&&"undefined"!=typeof this[m]&&(json[m]=this[m].toString())}return _.extend(json,this.extras),json},URI.prototype.toString=function(){var query={};return this.amount&&(query.amount=Unit.fromSatoshis(this.amount).toBTC()),this.message&&(query.message=this.message),this.label&&(query.label=this.label),this.r&&(query.r=this.r),_.extend(query,this.extras),URL.format({protocol:"bitcoin:",host:this.address,query:query})},URI.prototype.inspect=function(){return"<URI: "+this.toString()+">"},module.exports=URI},{"./address":35,"./unit":75,lodash:105,url:413}],77:[function(require,module,exports){(function(Buffer){"use strict";function equals(a,b){if(a.length!==b.length)return!1;for(var length=a.length,i=0;i<length;i++)if(a[i]!==b[i])return!1;return!0}var buffer=require("buffer"),assert=require("assert"),js=require("./js"),$=require("./preconditions");module.exports={fill:function(buffer,value){$.checkArgumentType(buffer,"Buffer","buffer"),$.checkArgumentType(value,"number","value");for(var length=buffer.length,i=0;i<length;i++)buffer[i]=value;return buffer},copy:function(original){var buffer=new Buffer(original.length);return original.copy(buffer),buffer},isBuffer:function(arg){return buffer.Buffer.isBuffer(arg)||arg instanceof Uint8Array},emptyBuffer:function(bytes){$.checkArgumentType(bytes,"number","bytes");for(var result=new buffer.Buffer(bytes),i=0;i<bytes;i++)result.write("\0",i);return result},concat:buffer.Buffer.concat,equals:equals,equal:equals,integerAsSingleByteBuffer:function(integer){return $.checkArgumentType(integer,"number","integer"),new buffer.Buffer([255&integer])},integerAsBuffer:function(integer){$.checkArgumentType(integer,"number","integer");var bytes=[];return bytes.push(integer>>24&255),bytes.push(integer>>16&255),bytes.push(integer>>8&255),bytes.push(255&integer),new Buffer(bytes)},integerFromBuffer:function(buffer){return $.checkArgumentType(buffer,"Buffer","buffer"),buffer[0]<<24|buffer[1]<<16|buffer[2]<<8|buffer[3]},integerFromSingleByteBuffer:function(buffer){return $.checkArgumentType(buffer,"Buffer","buffer"),buffer[0]},bufferToHex:function(buffer){return $.checkArgumentType(buffer,"Buffer","buffer"),buffer.toString("hex")},reverse:function(param){for(var ret=new buffer.Buffer(param.length),i=0;i<param.length;i++)ret[i]=param[param.length-i-1];return ret},hexToBuffer:function(string){return assert(js.isHexa(string)),new buffer.Buffer(string,"hex")}},module.exports.NULL_HASH=module.exports.fill(new Buffer(32),0),module.exports.EMPTY_BUFFER=new Buffer(0)}).call(this,require("buffer").Buffer)},{"./js":78,"./preconditions":79,assert:25,buffer:151}],78:[function(require,module,exports){"use strict";var _=require("lodash"),isHexa=function(value){return!!_.isString(value)&&/^[0-9a-fA-F]+$/.test(value)};module.exports={isValidJSON:function(arg){var parsed;if(!_.isString(arg))return!1;try{parsed=JSON.parse(arg)}catch(e){return!1}return"object"==typeof parsed},isHexa:isHexa,isHexaString:isHexa,cloneArray:function(array){return[].concat(array)},defineImmutable:function(target,values){return Object.keys(values).forEach(function(key){Object.defineProperty(target,key,{configurable:!1,enumerable:!0,value:values[key]})}),target},isNaturalNumber:function(value){return"number"==typeof value&&isFinite(value)&&Math.floor(value)===value&&value>=0}}},{lodash:105}],79:[function(require,module,exports){"use strict";var errors=require("../errors"),_=require("lodash");module.exports={checkState:function(condition,message){if(!condition)throw new errors.InvalidState(message)},checkArgument:function(condition,argumentName,message,docsPath){if(!condition)throw new errors.InvalidArgument(argumentName,message,docsPath)},checkArgumentType:function(argument,type,argumentName){if(argumentName=argumentName||"(unknown name)",_.isString(type)){if("Buffer"===type){var BufferUtil=require("./buffer");if(!BufferUtil.isBuffer(argument))throw new errors.InvalidArgumentType(argument,type,argumentName)}else if(typeof argument!==type)throw new errors.InvalidArgumentType(argument,type,argumentName)}else if(!(argument instanceof type))throw new errors.InvalidArgumentType(argument,type.name,argumentName)}}},{"../errors":51,"./buffer":77,lodash:105}],80:[function(require,module,exports){!function(module,exports){"use strict";function assert(val,msg){if(!val)throw new Error(msg||"Assertion failed")}function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype,ctor.prototype=new TempCtor,ctor.prototype.constructor=ctor}function BN(number,base,endian){return null!==number&&"object"==typeof number&&Array.isArray(number.words)?number:(this.sign=!1,this.words=null,this.length=0,this.red=null,"le"!==base&&"be"!==base||(endian=base,base=10),void(null!==number&&this._init(number||0,base||10,endian||"be")))}function parseHex(str,start,end){for(var r=0,len=Math.min(str.length,end),i=start;i<len;i++){var c=str.charCodeAt(i)-48;r<<=4,r|=c>=49&&c<=54?c-49+10:c>=17&&c<=22?c-17+10:15&c}return r}function parseBase(str,start,end,mul){for(var r=0,len=Math.min(str.length,end),i=start;i<len;i++){var c=str.charCodeAt(i)-48;r*=mul,r+=c>=49?c-49+10:c>=17?c-17+10:c}return r}function MPrime(name,p){this.name=name,this.p=new BN(p,16),this.n=this.p.bitLength(),this.k=new BN(1).ishln(this.n).isub(this.p),this.tmp=this._tmp()}function K256(){MPrime.call(this,"k256","ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe fffffc2f")}function P224(){MPrime.call(this,"p224","ffffffff ffffffff ffffffff ffffffff 00000000 00000000 00000001")}function P192(){MPrime.call(this,"p192","ffffffff ffffffff ffffffff fffffffe ffffffff ffffffff")}function P25519(){MPrime.call(this,"25519","7fffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffed")}function Red(m){if("string"==typeof m){var prime=BN._prime(m);this.m=prime.p,this.prime=prime}else this.m=m,this.prime=null}function Mont(m){Red.call(this,m),this.shift=this.m.bitLength(),this.shift%26!==0&&(this.shift+=26-this.shift%26),this.r=new BN(1).ishln(this.shift),this.r2=this.imod(this.r.sqr()),this.rinv=this.r._invmp(this.m),this.minv=this.rinv.mul(this.r).isubn(1).div(this.m),this.minv.sign=!0,this.minv=this.minv.mod(this.r)}"object"==typeof module?module.exports=BN:exports.BN=BN,BN.BN=BN,BN.wordSize=26,BN.prototype._init=function(number,base,endian){if("number"==typeof number)return number<0&&(this.sign=!0,number=-number),void(number<67108864?(this.words=[67108863&number],this.length=1):number<4503599627370496?(this.words=[67108863&number,number/67108864&67108863],this.length=2):(assert(number<9007199254740992),this.words=[67108863&number,number/67108864&67108863,1],this.length=3));if("object"==typeof number)return this._initArray(number,base,endian);"hex"===base&&(base=16),assert(base===(0|base)&&base>=2&&base<=36),number=number.toString().replace(/\s+/g,"");
var start=0;"-"===number[0]&&start++,16===base?this._parseHex(number,start):this._parseBase(number,base,start),"-"===number[0]&&(this.sign=!0),this.strip()},BN.prototype._initArray=function(number,base,endian){if(assert("number"==typeof number.length),number.length<=0)return this.words=[0],this.length=1,this;this.length=Math.ceil(number.length/3),this.words=new Array(this.length);for(var i=0;i<this.length;i++)this.words[i]=0;var off=0;if("be"===endian)for(var i=number.length-1,j=0;i>=0;i-=3){var w=number[i]|number[i-1]<<8|number[i-2]<<16;this.words[j]|=w<<off&67108863,this.words[j+1]=w>>>26-off&67108863,off+=24,off>=26&&(off-=26,j++)}else if("le"===endian)for(var i=0,j=0;i<number.length;i+=3){var w=number[i]|number[i+1]<<8|number[i+2]<<16;this.words[j]|=w<<off&67108863,this.words[j+1]=w>>>26-off&67108863,off+=24,off>=26&&(off-=26,j++)}return this.strip()},BN.prototype._parseHex=function(number,start){this.length=Math.ceil((number.length-start)/6),this.words=new Array(this.length);for(var i=0;i<this.length;i++)this.words[i]=0;for(var off=0,i=number.length-6,j=0;i>=start;i-=6){var w=parseHex(number,i,i+6);this.words[j]|=w<<off&67108863,this.words[j+1]|=w>>>26-off&4194303,off+=24,off>=26&&(off-=26,j++)}if(i+6!==start){var w=parseHex(number,start,i+6);this.words[j]|=w<<off&67108863,this.words[j+1]|=w>>>26-off&4194303}this.strip()},BN.prototype._parseBase=function(number,base,start){this.words=[0],this.length=1;for(var limbLen=0,limbPow=1;limbPow<=67108863;limbPow*=base)limbLen++;limbLen--,limbPow=limbPow/base|0;for(var total=number.length-start,mod=total%limbLen,end=Math.min(total,total-mod)+start,word=0,i=start;i<end;i+=limbLen)word=parseBase(number,i,i+limbLen,base),this.imuln(limbPow),this.words[0]+word<67108864?this.words[0]+=word:this._iaddn(word);if(0!==mod){for(var pow=1,word=parseBase(number,i,number.length,base),i=0;i<mod;i++)pow*=base;this.imuln(pow),this.words[0]+word<67108864?this.words[0]+=word:this._iaddn(word)}},BN.prototype.copy=function(dest){dest.words=new Array(this.length);for(var i=0;i<this.length;i++)dest.words[i]=this.words[i];dest.length=this.length,dest.sign=this.sign,dest.red=this.red},BN.prototype.clone=function(){var r=new BN(null);return this.copy(r),r},BN.prototype.strip=function(){for(;this.length>1&&0===this.words[this.length-1];)this.length--;return this._normSign()},BN.prototype._normSign=function(){return 1===this.length&&0===this.words[0]&&(this.sign=!1),this},BN.prototype.inspect=function(){return(this.red?"<BN-R: ":"<BN: ")+this.toString(16)+">"};var zeros=["","0","00","000","0000","00000","000000","0000000","00000000","000000000","0000000000","00000000000","000000000000","0000000000000","00000000000000","000000000000000","0000000000000000","00000000000000000","000000000000000000","0000000000000000000","00000000000000000000","000000000000000000000","0000000000000000000000","00000000000000000000000","000000000000000000000000","0000000000000000000000000"],groupSizes=[0,0,25,16,12,11,10,9,8,8,7,7,7,7,6,6,6,6,6,6,6,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],groupBases=[0,0,33554432,43046721,16777216,48828125,60466176,40353607,16777216,43046721,1e7,19487171,35831808,62748517,7529536,11390625,16777216,24137569,34012224,47045881,64e6,4084101,5153632,6436343,7962624,9765625,11881376,14348907,17210368,20511149,243e5,28629151,33554432,39135393,45435424,52521875,60466176];BN.prototype.toString=function(base,padding){if(base=base||10,16===base||"hex"===base){for(var out="",off=0,padding=0|padding||1,carry=0,i=0;i<this.length;i++){var w=this.words[i],word=(16777215&(w<<off|carry)).toString(16);carry=w>>>24-off&16777215,out=0!==carry||i!==this.length-1?zeros[6-word.length]+word+out:word+out,off+=2,off>=26&&(off-=26,i--)}for(0!==carry&&(out=carry.toString(16)+out);out.length%padding!==0;)out="0"+out;return this.sign&&(out="-"+out),out}if(base===(0|base)&&base>=2&&base<=36){var groupSize=groupSizes[base],groupBase=groupBases[base],out="",c=this.clone();for(c.sign=!1;0!==c.cmpn(0);){var r=c.modn(groupBase).toString(base);c=c.idivn(groupBase),out=0!==c.cmpn(0)?zeros[groupSize-r.length]+r+out:r+out}return 0===this.cmpn(0)&&(out="0"+out),this.sign&&(out="-"+out),out}assert(!1,"Base should be between 2 and 36")},BN.prototype.toJSON=function(){return this.toString(16)},BN.prototype.toArray=function(){this.strip();var res=new Array(this.byteLength());res[0]=0;for(var q=this.clone(),i=0;0!==q.cmpn(0);i++){var b=q.andln(255);q.ishrn(8),res[res.length-i-1]=b}return res},Math.clz32?BN.prototype._countBits=function(w){return 32-Math.clz32(w)}:BN.prototype._countBits=function(w){var t=w,r=0;return t>=4096&&(r+=13,t>>>=13),t>=64&&(r+=7,t>>>=7),t>=8&&(r+=4,t>>>=4),t>=2&&(r+=2,t>>>=2),r+t},BN.prototype._zeroBits=function(w){if(0===w)return 26;var t=w,r=0;return 0===(8191&t)&&(r+=13,t>>>=13),0===(127&t)&&(r+=7,t>>>=7),0===(15&t)&&(r+=4,t>>>=4),0===(3&t)&&(r+=2,t>>>=2),0===(1&t)&&r++,r},BN.prototype.bitLength=function(){var hi=0,w=this.words[this.length-1],hi=this._countBits(w);return 26*(this.length-1)+hi},BN.prototype.zeroBits=function(){if(0===this.cmpn(0))return 0;for(var r=0,i=0;i<this.length;i++){var b=this._zeroBits(this.words[i]);if(r+=b,26!==b)break}return r},BN.prototype.byteLength=function(){return Math.ceil(this.bitLength()/8)},BN.prototype.neg=function(){if(0===this.cmpn(0))return this.clone();var r=this.clone();return r.sign=!this.sign,r},BN.prototype.ior=function(num){for(this.sign=this.sign||num.sign;this.length<num.length;)this.words[this.length++]=0;for(var i=0;i<num.length;i++)this.words[i]=this.words[i]|num.words[i];return this.strip()},BN.prototype.or=function(num){return this.length>num.length?this.clone().ior(num):num.clone().ior(this)},BN.prototype.iand=function(num){this.sign=this.sign&&num.sign;var b;b=this.length>num.length?num:this;for(var i=0;i<b.length;i++)this.words[i]=this.words[i]&num.words[i];return this.length=b.length,this.strip()},BN.prototype.and=function(num){return this.length>num.length?this.clone().iand(num):num.clone().iand(this)},BN.prototype.ixor=function(num){this.sign=this.sign||num.sign;var a,b;this.length>num.length?(a=this,b=num):(a=num,b=this);for(var i=0;i<b.length;i++)this.words[i]=a.words[i]^b.words[i];if(this!==a)for(;i<a.length;i++)this.words[i]=a.words[i];return this.length=a.length,this.strip()},BN.prototype.xor=function(num){return this.length>num.length?this.clone().ixor(num):num.clone().ixor(this)},BN.prototype.setn=function(bit,val){assert("number"==typeof bit&&bit>=0);for(var off=bit/26|0,wbit=bit%26;this.length<=off;)this.words[this.length++]=0;return val?this.words[off]=this.words[off]|1<<wbit:this.words[off]=this.words[off]&~(1<<wbit),this.strip()},BN.prototype.iadd=function(num){if(this.sign&&!num.sign){this.sign=!1;var r=this.isub(num);return this.sign=!this.sign,this._normSign()}if(!this.sign&&num.sign){num.sign=!1;var r=this.isub(num);return num.sign=!0,r._normSign()}var a,b;this.length>num.length?(a=this,b=num):(a=num,b=this);for(var carry=0,i=0;i<b.length;i++){var r=a.words[i]+b.words[i]+carry;this.words[i]=67108863&r,carry=r>>>26}for(;0!==carry&&i<a.length;i++){var r=a.words[i]+carry;this.words[i]=67108863&r,carry=r>>>26}if(this.length=a.length,0!==carry)this.words[this.length]=carry,this.length++;else if(a!==this)for(;i<a.length;i++)this.words[i]=a.words[i];return this},BN.prototype.add=function(num){if(num.sign&&!this.sign){num.sign=!1;var res=this.sub(num);return num.sign=!0,res}if(!num.sign&&this.sign){this.sign=!1;var res=num.sub(this);return this.sign=!0,res}return this.length>num.length?this.clone().iadd(num):num.clone().iadd(this)},BN.prototype.isub=function(num){if(num.sign){num.sign=!1;var r=this.iadd(num);return num.sign=!0,r._normSign()}if(this.sign)return this.sign=!1,this.iadd(num),this.sign=!0,this._normSign();var cmp=this.cmp(num);if(0===cmp)return this.sign=!1,this.length=1,this.words[0]=0,this;var a,b;cmp>0?(a=this,b=num):(a=num,b=this);for(var carry=0,i=0;i<b.length;i++){var r=a.words[i]-b.words[i]+carry;carry=r>>26,this.words[i]=67108863&r}for(;0!==carry&&i<a.length;i++){var r=a.words[i]+carry;carry=r>>26,this.words[i]=67108863&r}if(0===carry&&i<a.length&&a!==this)for(;i<a.length;i++)this.words[i]=a.words[i];return this.length=Math.max(this.length,i),a!==this&&(this.sign=!0),this.strip()},BN.prototype.sub=function(num){return this.clone().isub(num)},BN.prototype._smallMulTo=function(num,out){out.sign=num.sign!==this.sign,out.length=this.length+num.length;for(var carry=0,k=0;k<out.length-1;k++){for(var ncarry=carry>>>26,rword=67108863&carry,maxJ=Math.min(k,num.length-1),j=Math.max(0,k-this.length+1);j<=maxJ;j++){var i=k-j,a=0|this.words[i],b=0|num.words[j],r=a*b,lo=67108863&r;ncarry=ncarry+(r/67108864|0)|0,lo=lo+rword|0,rword=67108863&lo,ncarry=ncarry+(lo>>>26)|0}out.words[k]=rword,carry=ncarry}return 0!==carry?out.words[k]=carry:out.length--,out.strip()},BN.prototype._bigMulTo=function(num,out){out.sign=num.sign!==this.sign,out.length=this.length+num.length;for(var carry=0,hncarry=0,k=0;k<out.length-1;k++){var ncarry=hncarry;hncarry=0;for(var rword=67108863&carry,maxJ=Math.min(k,num.length-1),j=Math.max(0,k-this.length+1);j<=maxJ;j++){var i=k-j,a=0|this.words[i],b=0|num.words[j],r=a*b,lo=67108863&r;ncarry=ncarry+(r/67108864|0)|0,lo=lo+rword|0,rword=67108863&lo,ncarry=ncarry+(lo>>>26)|0,hncarry+=ncarry>>>26,ncarry&=67108863}out.words[k]=rword,carry=ncarry,ncarry=hncarry}return 0!==carry?out.words[k]=carry:out.length--,out.strip()},BN.prototype.mulTo=function(num,out){var res;return res=this.length+num.length<63?this._smallMulTo(num,out):this._bigMulTo(num,out)},BN.prototype.mul=function(num){var out=new BN(null);return out.words=new Array(this.length+num.length),this.mulTo(num,out)},BN.prototype.imul=function(num){if(0===this.cmpn(0)||0===num.cmpn(0))return this.words[0]=0,this.length=1,this;var tlen=this.length,nlen=num.length;this.sign=num.sign!==this.sign,this.length=this.length+num.length,this.words[this.length-1]=0;for(var k=this.length-2;k>=0;k--){for(var carry=0,rword=0,maxJ=Math.min(k,nlen-1),j=Math.max(0,k-tlen+1);j<=maxJ;j++){var i=k-j,a=this.words[i],b=num.words[j],r=a*b,lo=67108863&r;carry+=r/67108864|0,lo+=rword,rword=67108863&lo,carry+=lo>>>26}this.words[k]=rword,this.words[k+1]+=carry,carry=0}for(var carry=0,i=1;i<this.length;i++){var w=this.words[i]+carry;this.words[i]=67108863&w,carry=w>>>26}return this.strip()},BN.prototype.imuln=function(num){assert("number"==typeof num);for(var carry=0,i=0;i<this.length;i++){var w=this.words[i]*num,lo=(67108863&w)+(67108863&carry);carry>>=26,carry+=w/67108864|0,carry+=lo>>>26,this.words[i]=67108863&lo}return 0!==carry&&(this.words[i]=carry,this.length++),this},BN.prototype.sqr=function(){return this.mul(this)},BN.prototype.isqr=function(){return this.mul(this)},BN.prototype.ishln=function(bits){assert("number"==typeof bits&&bits>=0);var r=bits%26,s=(bits-r)/26,carryMask=67108863>>>26-r<<26-r;if(0!==r){for(var carry=0,i=0;i<this.length;i++){var newCarry=this.words[i]&carryMask,c=this.words[i]-newCarry<<r;this.words[i]=c|carry,carry=newCarry>>>26-r}carry&&(this.words[i]=carry,this.length++)}if(0!==s){for(var i=this.length-1;i>=0;i--)this.words[i+s]=this.words[i];for(var i=0;i<s;i++)this.words[i]=0;this.length+=s}return this.strip()},BN.prototype.ishrn=function(bits,hint,extended){assert("number"==typeof bits&&bits>=0);var h;h=hint?(hint-hint%26)/26:0;var r=bits%26,s=Math.min((bits-r)/26,this.length),mask=67108863^67108863>>>r<<r,maskedWords=extended;if(h-=s,h=Math.max(0,h),maskedWords){for(var i=0;i<s;i++)maskedWords.words[i]=this.words[i];maskedWords.length=s}if(0===s);else if(this.length>s){this.length-=s;for(var i=0;i<this.length;i++)this.words[i]=this.words[i+s]}else this.words[0]=0,this.length=1;for(var carry=0,i=this.length-1;i>=0&&(0!==carry||i>=h);i--){var word=this.words[i];this.words[i]=carry<<26-r|word>>>r,carry=word&mask}return maskedWords&&0!==carry&&(maskedWords.words[maskedWords.length++]=carry),0===this.length&&(this.words[0]=0,this.length=1),this.strip(),this},BN.prototype.shln=function(bits){return this.clone().ishln(bits)},BN.prototype.shrn=function(bits){return this.clone().ishrn(bits)},BN.prototype.testn=function(bit){assert("number"==typeof bit&&bit>=0);var r=bit%26,s=(bit-r)/26,q=1<<r;if(this.length<=s)return!1;var w=this.words[s];return!!(w&q)},BN.prototype.imaskn=function(bits){assert("number"==typeof bits&&bits>=0);var r=bits%26,s=(bits-r)/26;if(assert(!this.sign,"imaskn works only with positive numbers"),0!==r&&s++,this.length=Math.min(s,this.length),0!==r){var mask=67108863^67108863>>>r<<r;this.words[this.length-1]&=mask}return this.strip()},BN.prototype.maskn=function(bits){return this.clone().imaskn(bits)},BN.prototype.iaddn=function(num){return assert("number"==typeof num),num<0?this.isubn(-num):this.sign?1===this.length&&this.words[0]<num?(this.words[0]=num-this.words[0],this.sign=!1,this):(this.sign=!1,this.isubn(num),this.sign=!0,this):this._iaddn(num)},BN.prototype._iaddn=function(num){this.words[0]+=num;for(var i=0;i<this.length&&this.words[i]>=67108864;i++)this.words[i]-=67108864,i===this.length-1?this.words[i+1]=1:this.words[i+1]++;return this.length=Math.max(this.length,i+1),this},BN.prototype.isubn=function(num){if(assert("number"==typeof num),num<0)return this.iaddn(-num);if(this.sign)return this.sign=!1,this.iaddn(num),this.sign=!0,this;this.words[0]-=num;for(var i=0;i<this.length&&this.words[i]<0;i++)this.words[i]+=67108864,this.words[i+1]-=1;return this.strip()},BN.prototype.addn=function(num){return this.clone().iaddn(num)},BN.prototype.subn=function(num){return this.clone().isubn(num)},BN.prototype.iabs=function(){return this.sign=!1,this},BN.prototype.abs=function(){return this.clone().iabs()},BN.prototype._ishlnsubmul=function(num,mul,shift){var i,len=num.length+shift;if(this.words.length<len){for(var t=new Array(len),i=0;i<this.length;i++)t[i]=this.words[i];this.words=t}else i=this.length;for(this.length=Math.max(this.length,len);i<this.length;i++)this.words[i]=0;for(var carry=0,i=0;i<num.length;i++){var w=this.words[i+shift]+carry,right=num.words[i]*mul;w-=67108863&right,carry=(w>>26)-(right/67108864|0),this.words[i+shift]=67108863&w}for(;i<this.length-shift;i++){var w=this.words[i+shift]+carry;carry=w>>26,this.words[i+shift]=67108863&w}if(0===carry)return this.strip();assert(carry===-1),carry=0;for(var i=0;i<this.length;i++){var w=-this.words[i]+carry;carry=w>>26,this.words[i]=67108863&w}return this.sign=!0,this.strip()},BN.prototype._wordDiv=function(num,mode){var shift=this.length-num.length,a=this.clone(),b=num,bhi=b.words[b.length-1],bhiBits=this._countBits(bhi);shift=26-bhiBits,0!==shift&&(b=b.shln(shift),a.ishln(shift),bhi=b.words[b.length-1]);var q,m=a.length-b.length;if("mod"!==mode){q=new BN(null),q.length=m+1,q.words=new Array(q.length);for(var i=0;i<q.length;i++)q.words[i]=0}var diff=a.clone()._ishlnsubmul(b,1,m);diff.sign||(a=diff,q&&(q.words[m]=1));for(var j=m-1;j>=0;j--){var qj=67108864*a.words[b.length+j]+a.words[b.length+j-1];for(qj=Math.min(qj/bhi|0,67108863),a._ishlnsubmul(b,qj,j);a.sign;)qj--,a.sign=!1,a._ishlnsubmul(b,1,j),0!==a.cmpn(0)&&(a.sign=!a.sign);q&&(q.words[j]=qj)}return q&&q.strip(),a.strip(),"div"!==mode&&0!==shift&&a.ishrn(shift),{div:q?q:null,mod:a}},BN.prototype.divmod=function(num,mode){if(assert(0!==num.cmpn(0)),this.sign&&!num.sign){var div,mod,res=this.neg().divmod(num,mode);return"mod"!==mode&&(div=res.div.neg()),"div"!==mode&&(mod=0===res.mod.cmpn(0)?res.mod:num.sub(res.mod)),{div:div,mod:mod}}if(!this.sign&&num.sign){var div,res=this.divmod(num.neg(),mode);return"mod"!==mode&&(div=res.div.neg()),{div:div,mod:res.mod}}return this.sign&&num.sign?this.neg().divmod(num.neg(),mode):num.length>this.length||this.cmp(num)<0?{div:new BN(0),mod:this}:1===num.length?"div"===mode?{div:this.divn(num.words[0]),mod:null}:"mod"===mode?{div:null,mod:new BN(this.modn(num.words[0]))}:{div:this.divn(num.words[0]),mod:new BN(this.modn(num.words[0]))}:this._wordDiv(num,mode)},BN.prototype.div=function(num){return this.divmod(num,"div").div},BN.prototype.mod=function(num){return this.divmod(num,"mod").mod},BN.prototype.divRound=function(num){var dm=this.divmod(num);if(0===dm.mod.cmpn(0))return dm.div;var mod=dm.div.sign?dm.mod.isub(num):dm.mod,half=num.shrn(1),r2=num.andln(1),cmp=mod.cmp(half);return cmp<0||1===r2&&0===cmp?dm.div:dm.div.sign?dm.div.isubn(1):dm.div.iaddn(1)},BN.prototype.modn=function(num){assert(num<=67108863);for(var p=(1<<26)%num,acc=0,i=this.length-1;i>=0;i--)acc=(p*acc+this.words[i])%num;return acc},BN.prototype.idivn=function(num){assert(num<=67108863);for(var carry=0,i=this.length-1;i>=0;i--){var w=this.words[i]+67108864*carry;this.words[i]=w/num|0,carry=w%num}return this.strip()},BN.prototype.divn=function(num){return this.clone().idivn(num)},BN.prototype.egcd=function(p){assert(!p.sign),assert(0!==p.cmpn(0));var x=this,y=p.clone();x=x.sign?x.mod(p):x.clone();for(var A=new BN(1),B=new BN(0),C=new BN(0),D=new BN(1),g=0;x.isEven()&&y.isEven();)x.ishrn(1),y.ishrn(1),++g;for(var yp=y.clone(),xp=x.clone();0!==x.cmpn(0);){for(;x.isEven();)x.ishrn(1),A.isEven()&&B.isEven()?(A.ishrn(1),B.ishrn(1)):(A.iadd(yp).ishrn(1),B.isub(xp).ishrn(1));for(;y.isEven();)y.ishrn(1),C.isEven()&&D.isEven()?(C.ishrn(1),D.ishrn(1)):(C.iadd(yp).ishrn(1),D.isub(xp).ishrn(1));x.cmp(y)>=0?(x.isub(y),A.isub(C),B.isub(D)):(y.isub(x),C.isub(A),D.isub(B))}return{a:C,b:D,gcd:y.ishln(g)}},BN.prototype._invmp=function(p){assert(!p.sign),assert(0!==p.cmpn(0));var a=this,b=p.clone();a=a.sign?a.mod(p):a.clone();for(var x1=new BN(1),x2=new BN(0),delta=b.clone();a.cmpn(1)>0&&b.cmpn(1)>0;){for(;a.isEven();)a.ishrn(1),x1.isEven()?x1.ishrn(1):x1.iadd(delta).ishrn(1);for(;b.isEven();)b.ishrn(1),x2.isEven()?x2.ishrn(1):x2.iadd(delta).ishrn(1);a.cmp(b)>=0?(a.isub(b),x1.isub(x2)):(b.isub(a),x2.isub(x1))}return 0===a.cmpn(1)?x1:x2},BN.prototype.gcd=function(num){if(0===this.cmpn(0))return num.clone();if(0===num.cmpn(0))return this.clone();var a=this.clone(),b=num.clone();a.sign=!1,b.sign=!1;for(var shift=0;a.isEven()&&b.isEven();shift++)a.ishrn(1),b.ishrn(1);for(;;){for(;a.isEven();)a.ishrn(1);for(;b.isEven();)b.ishrn(1);var r=a.cmp(b);if(r<0){var t=a;a=b,b=t}else if(0===r||0===b.cmpn(1))break;a.isub(b)}return b.ishln(shift)},BN.prototype.invm=function(num){return this.egcd(num).a.mod(num)},BN.prototype.isEven=function(){return 0===(1&this.words[0])},BN.prototype.isOdd=function(){return 1===(1&this.words[0])},BN.prototype.andln=function(num){return this.words[0]&num},BN.prototype.bincn=function(bit){assert("number"==typeof bit);var r=bit%26,s=(bit-r)/26,q=1<<r;if(this.length<=s){for(var i=this.length;i<s+1;i++)this.words[i]=0;return this.words[s]|=q,this.length=s+1,this}for(var carry=q,i=s;0!==carry&&i<this.length;i++){var w=this.words[i];w+=carry,carry=w>>>26,w&=67108863,this.words[i]=w}return 0!==carry&&(this.words[i]=carry,this.length++),this},BN.prototype.cmpn=function(num){var sign=num<0;if(sign&&(num=-num),this.sign&&!sign)return-1;if(!this.sign&&sign)return 1;num&=67108863,this.strip();var res;if(this.length>1)res=1;else{var w=this.words[0];res=w===num?0:w<num?-1:1}return this.sign&&(res=-res),res},BN.prototype.cmp=function(num){if(this.sign&&!num.sign)return-1;if(!this.sign&&num.sign)return 1;var res=this.ucmp(num);return this.sign?-res:res},BN.prototype.ucmp=function(num){if(this.length>num.length)return 1;if(this.length<num.length)return-1;for(var res=0,i=this.length-1;i>=0;i--){var a=this.words[i],b=num.words[i];if(a!==b){a<b?res=-1:a>b&&(res=1);break}}return res},BN.red=function(num){return new Red(num)},BN.prototype.toRed=function(ctx){return assert(!this.red,"Already a number in reduction context"),assert(!this.sign,"red works only with positives"),ctx.convertTo(this)._forceRed(ctx)},BN.prototype.fromRed=function(){return assert(this.red,"fromRed works only with numbers in reduction context"),this.red.convertFrom(this)},BN.prototype._forceRed=function(ctx){return this.red=ctx,this},BN.prototype.forceRed=function(ctx){return assert(!this.red,"Already a number in reduction context"),this._forceRed(ctx)},BN.prototype.redAdd=function(num){return assert(this.red,"redAdd works only with red numbers"),this.red.add(this,num)},BN.prototype.redIAdd=function(num){return assert(this.red,"redIAdd works only with red numbers"),this.red.iadd(this,num)},BN.prototype.redSub=function(num){return assert(this.red,"redSub works only with red numbers"),this.red.sub(this,num)},BN.prototype.redISub=function(num){return assert(this.red,"redISub works only with red numbers"),this.red.isub(this,num)},BN.prototype.redShl=function(num){return assert(this.red,"redShl works only with red numbers"),this.red.shl(this,num)},BN.prototype.redMul=function(num){return assert(this.red,"redMul works only with red numbers"),this.red._verify2(this,num),this.red.mul(this,num)},BN.prototype.redIMul=function(num){return assert(this.red,"redMul works only with red numbers"),this.red._verify2(this,num),this.red.imul(this,num)},BN.prototype.redSqr=function(){return assert(this.red,"redSqr works only with red numbers"),this.red._verify1(this),this.red.sqr(this)},BN.prototype.redISqr=function(){return assert(this.red,"redISqr works only with red numbers"),this.red._verify1(this),this.red.isqr(this)},BN.prototype.redSqrt=function(){return assert(this.red,"redSqrt works only with red numbers"),this.red._verify1(this),this.red.sqrt(this)},BN.prototype.redInvm=function(){return assert(this.red,"redInvm works only with red numbers"),this.red._verify1(this),this.red.invm(this)},BN.prototype.redNeg=function(){return assert(this.red,"redNeg works only with red numbers"),this.red._verify1(this),this.red.neg(this)},BN.prototype.redPow=function(num){return assert(this.red&&!num.red,"redPow(normalNum)"),this.red._verify1(this),this.red.pow(this,num)};var primes={k256:null,p224:null,p192:null,p25519:null};MPrime.prototype._tmp=function(){var tmp=new BN(null);return tmp.words=new Array(Math.ceil(this.n/13)),tmp},MPrime.prototype.ireduce=function(num){var rlen,r=num;do this.split(r,this.tmp),r=this.imulK(r),r=r.iadd(this.tmp),rlen=r.bitLength();while(rlen>this.n);var cmp=rlen<this.n?-1:r.ucmp(this.p);return 0===cmp?(r.words[0]=0,r.length=1):cmp>0?r.isub(this.p):r.strip(),r},MPrime.prototype.split=function(input,out){input.ishrn(this.n,0,out)},MPrime.prototype.imulK=function(num){return num.imul(this.k)},inherits(K256,MPrime),K256.prototype.split=function(input,output){for(var mask=4194303,outLen=Math.min(input.length,9),i=0;i<outLen;i++)output.words[i]=input.words[i];if(output.length=outLen,input.length<=9)return input.words[0]=0,void(input.length=1);var prev=input.words[9];output.words[output.length++]=prev&mask;for(var i=10;i<input.length;i++){var next=input.words[i];input.words[i-10]=(next&mask)<<4|prev>>>22,prev=next}input.words[i-10]=prev>>>22,input.length-=9},K256.prototype.imulK=function(num){num.words[num.length]=0,num.words[num.length+1]=0,num.length+=2;for(var hi,lo=0,i=0;i<num.length;i++){var w=num.words[i];hi=64*w,lo+=977*w,hi+=lo/67108864|0,lo&=67108863,num.words[i]=lo,lo=hi}return 0===num.words[num.length-1]&&(num.length--,0===num.words[num.length-1]&&num.length--),num},inherits(P224,MPrime),inherits(P192,MPrime),inherits(P25519,MPrime),P25519.prototype.imulK=function(num){for(var carry=0,i=0;i<num.length;i++){var hi=19*num.words[i]+carry,lo=67108863&hi;hi>>>=26,num.words[i]=lo,carry=hi}return 0!==carry&&(num.words[num.length++]=carry),num},BN._prime=function prime(name){if(primes[name])return primes[name];var prime;if("k256"===name)prime=new K256;else if("p224"===name)prime=new P224;else if("p192"===name)prime=new P192;else{if("p25519"!==name)throw new Error("Unknown prime "+name);prime=new P25519}return primes[name]=prime,prime},Red.prototype._verify1=function(a){assert(!a.sign,"red works only with positives"),assert(a.red,"red works only with red numbers")},Red.prototype._verify2=function(a,b){assert(!a.sign&&!b.sign,"red works only with positives"),assert(a.red&&a.red===b.red,"red works only with red numbers")},Red.prototype.imod=function(a){return this.prime?this.prime.ireduce(a)._forceRed(this):a.mod(this.m)._forceRed(this)},Red.prototype.neg=function(a){var r=a.clone();return r.sign=!r.sign,r.iadd(this.m)._forceRed(this)},Red.prototype.add=function(a,b){this._verify2(a,b);var res=a.add(b);return res.cmp(this.m)>=0&&res.isub(this.m),res._forceRed(this)},Red.prototype.iadd=function(a,b){this._verify2(a,b);var res=a.iadd(b);return res.cmp(this.m)>=0&&res.isub(this.m),res},Red.prototype.sub=function(a,b){this._verify2(a,b);var res=a.sub(b);return res.cmpn(0)<0&&res.iadd(this.m),res._forceRed(this)},Red.prototype.isub=function(a,b){this._verify2(a,b);var res=a.isub(b);return res.cmpn(0)<0&&res.iadd(this.m),res},Red.prototype.shl=function(a,num){return this._verify1(a),this.imod(a.shln(num))},Red.prototype.imul=function(a,b){return this._verify2(a,b),this.imod(a.imul(b))},Red.prototype.mul=function(a,b){return this._verify2(a,b),this.imod(a.mul(b))},Red.prototype.isqr=function(a){return this.imul(a,a)},Red.prototype.sqr=function(a){return this.mul(a,a)},Red.prototype.sqrt=function(a){if(0===a.cmpn(0))return a.clone();var mod3=this.m.andln(3);if(assert(mod3%2===1),3===mod3){var pow=this.m.add(new BN(1)).ishrn(2),r=this.pow(a,pow);return r}for(var q=this.m.subn(1),s=0;0!==q.cmpn(0)&&0===q.andln(1);)s++,q.ishrn(1);assert(0!==q.cmpn(0));var one=new BN(1).toRed(this),nOne=one.redNeg(),lpow=this.m.subn(1).ishrn(1),z=this.m.bitLength();for(z=new BN(2*z*z).toRed(this);0!==this.pow(z,lpow).cmp(nOne);)z.redIAdd(nOne);for(var c=this.pow(z,q),r=this.pow(a,q.addn(1).ishrn(1)),t=this.pow(a,q),m=s;0!==t.cmp(one);){for(var tmp=t,i=0;0!==tmp.cmp(one);i++)tmp=tmp.redSqr();assert(i<m);var b=this.pow(c,new BN(1).ishln(m-i-1));r=r.redMul(b),c=b.redSqr(),t=t.redMul(c),m=i}return r},Red.prototype.invm=function(a){var inv=a._invmp(this.m);return inv.sign?(inv.sign=!1,this.imod(inv).redNeg()):this.imod(inv)},Red.prototype.pow=function(a,num){var w=[];if(0===num.cmpn(0))return new BN(1);for(var q=num.clone();0!==q.cmpn(0);)w.push(q.andln(1)),q.ishrn(1);for(var res=a,i=0;i<w.length&&0===w[i];i++,res=this.sqr(res));if(++i<w.length)for(var q=this.sqr(res);i<w.length;i++,q=this.sqr(q))0!==w[i]&&(res=this.mul(res,q));return res},Red.prototype.convertTo=function(num){return num.clone()},Red.prototype.convertFrom=function(num){var res=num.clone();return res.red=null,res},BN.mont=function(num){return new Mont(num)},inherits(Mont,Red),Mont.prototype.convertTo=function(num){return this.imod(num.shln(this.shift))},Mont.prototype.convertFrom=function(num){var r=this.imod(num.mul(this.rinv));return r.red=null,r},Mont.prototype.imul=function(a,b){if(0===a.cmpn(0)||0===b.cmpn(0))return a.words[0]=0,a.length=1,a;var t=a.imul(b),c=t.maskn(this.shift).mul(this.minv).imaskn(this.shift).mul(this.m),u=t.isub(c).ishrn(this.shift),res=u;return u.cmp(this.m)>=0?res=u.isub(this.m):u.cmpn(0)<0&&(res=u.iadd(this.m)),res._forceRed(this)},Mont.prototype.mul=function(a,b){if(0===a.cmpn(0)||0===b.cmpn(0))return new BN(0)._forceRed(this);var t=a.mul(b),c=t.maskn(this.shift).mul(this.minv).imaskn(this.shift).mul(this.m),u=t.isub(c).ishrn(this.shift),res=u;return u.cmp(this.m)>=0?res=u.isub(this.m):u.cmpn(0)<0&&(res=u.iadd(this.m)),res._forceRed(this)},Mont.prototype.invm=function(a){var res=this.imod(a._invmp(this.m).mul(this.r2));return res._forceRed(this)}}("undefined"==typeof module||module,this)},{}],81:[function(require,module,exports){function encode(buffer){if(0===buffer.length)return"";var i,j,digits=[0];for(i=0;i<buffer.length;i++){for(j=0;j<digits.length;j++)digits[j]<<=8;digits[0]+=buffer[i];var carry=0;for(j=0;j<digits.length;++j)digits[j]+=carry,carry=digits[j]/BASE|0,digits[j]%=BASE;for(;carry;)digits.push(carry%BASE),carry=carry/BASE|0}for(i=0;0===buffer[i]&&i<buffer.length-1;i++)digits.push(0);return digits.reverse().map(function(digit){return ALPHABET[digit]}).join("")}function decode(string){if(0===string.length)return[];var i,j,bytes=[0];for(i=0;i<string.length;i++){var c=string[i];if(!(c in ALPHABET_MAP))throw new Error("Non-base58 character");for(j=0;j<bytes.length;j++)bytes[j]*=BASE;bytes[0]+=ALPHABET_MAP[c];var carry=0;for(j=0;j<bytes.length;++j)bytes[j]+=carry,carry=bytes[j]>>8,bytes[j]&=255;for(;carry;)bytes.push(255&carry),carry>>=8}for(i=0;"1"===string[i]&&i<string.length-1;i++)bytes.push(0);return bytes.reverse()}for(var ALPHABET="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",ALPHABET_MAP={},i=0;i<ALPHABET.length;i++)ALPHABET_MAP[ALPHABET.charAt(i)]=i;var BASE=58;module.exports={encode:encode,decode:decode}},{}],82:[function(require,module,exports){module.exports=function(cmp,to){for(var c=0,i=0;i<cmp.length&&i!=to.length&&(c=cmp[i]<to[i]?-1:cmp[i]>to[i]?1:0,0==c);++i);return 0==c&&(to.length>cmp.length?c=-1:cmp.length>to.length&&(c=1)),c}},{}],83:[function(require,module,exports){"use strict";var elliptic=exports;elliptic.version=require("../package.json").version,elliptic.utils=require("./elliptic/utils"),elliptic.rand=require("brorand"),elliptic.hmacDRBG=require("./elliptic/hmac-drbg"),elliptic.curve=require("./elliptic/curve"),elliptic.curves=require("./elliptic/curves"),elliptic.ec=require("./elliptic/ec")},{"../package.json":103,"./elliptic/curve":86,"./elliptic/curves":89,"./elliptic/ec":90,"./elliptic/hmac-drbg":93,"./elliptic/utils":95,brorand:96}],84:[function(require,module,exports){"use strict";function BaseCurve(type,conf){this.type=type,this.p=new bn(conf.p,16),this.red=conf.prime?bn.red(conf.prime):bn.mont(this.p),this.zero=new bn(0).toRed(this.red),this.one=new bn(1).toRed(this.red),this.two=new bn(2).toRed(this.red),this.n=conf.n&&new bn(conf.n,16),this.g=conf.g&&this.pointFromJSON(conf.g,conf.gRed),this._wnafT1=new Array(4),this._wnafT2=new Array(4),this._wnafT3=new Array(4),this._wnafT4=new Array(4)}function BasePoint(curve,type){this.curve=curve,this.type=type,this.precomputed=null}var bn=require("bn.js"),elliptic=require("../../elliptic"),getNAF=elliptic.utils.getNAF,getJSF=elliptic.utils.getJSF,assert=elliptic.utils.assert;module.exports=BaseCurve,BaseCurve.prototype.point=function(){throw new Error("Not implemented")},BaseCurve.prototype.validate=function(){throw new Error("Not implemented")},BaseCurve.prototype._fixedNafMul=function(p,k){var doubles=p._getDoubles(),naf=getNAF(k,1),I=(1<<doubles.step+1)-(doubles.step%2===0?2:1);I/=3;for(var repr=[],j=0;j<naf.length;j+=doubles.step){for(var nafW=0,k=j+doubles.step-1;k>=j;k--)nafW=(nafW<<1)+naf[k];repr.push(nafW)}for(var a=this.jpoint(null,null,null),b=this.jpoint(null,null,null),i=I;i>0;i--){for(var j=0;j<repr.length;j++){var nafW=repr[j];nafW===i?b=b.mixedAdd(doubles.points[j]):nafW===-i&&(b=b.mixedAdd(doubles.points[j].neg()))}a=a.add(b)}return a.toP()},BaseCurve.prototype._wnafMul=function(p,k){var w=4,nafPoints=p._getNAFPoints(w);w=nafPoints.wnd;for(var wnd=nafPoints.points,naf=getNAF(k,w),acc=this.jpoint(null,null,null),i=naf.length-1;i>=0;i--){for(var k=0;i>=0&&0===naf[i];i--)k++;if(i>=0&&k++,acc=acc.dblp(k),i<0)break;var z=naf[i];assert(0!==z),acc="affine"===p.type?z>0?acc.mixedAdd(wnd[z-1>>1]):acc.mixedAdd(wnd[-z-1>>1].neg()):z>0?acc.add(wnd[z-1>>1]):acc.add(wnd[-z-1>>1].neg())}return"affine"===p.type?acc.toP():acc},BaseCurve.prototype._wnafMulAdd=function(defW,points,coeffs,len){for(var wndWidth=this._wnafT1,wnd=this._wnafT2,naf=this._wnafT3,max=0,i=0;i<len;i++){var p=points[i],nafPoints=p._getNAFPoints(defW);wndWidth[i]=nafPoints.wnd,wnd[i]=nafPoints.points}for(var i=len-1;i>=1;i-=2){var a=i-1,b=i;if(1===wndWidth[a]&&1===wndWidth[b]){var comb=[points[a],null,null,points[b]];0===points[a].y.cmp(points[b].y)?(comb[1]=points[a].add(points[b]),comb[2]=points[a].toJ().mixedAdd(points[b].neg())):0===points[a].y.cmp(points[b].y.redNeg())?(comb[1]=points[a].toJ().mixedAdd(points[b]),comb[2]=points[a].add(points[b].neg())):(comb[1]=points[a].toJ().mixedAdd(points[b]),comb[2]=points[a].toJ().mixedAdd(points[b].neg()));var index=[-3,-1,-5,-7,0,7,5,1,3],jsf=getJSF(coeffs[a],coeffs[b]);max=Math.max(jsf[0].length,max),naf[a]=new Array(max),naf[b]=new Array(max);for(var j=0;j<max;j++){var ja=0|jsf[0][j],jb=0|jsf[1][j];
naf[a][j]=index[3*(ja+1)+(jb+1)],naf[b][j]=0,wnd[a]=comb}}else naf[a]=getNAF(coeffs[a],wndWidth[a]),naf[b]=getNAF(coeffs[b],wndWidth[b]),max=Math.max(naf[a].length,max),max=Math.max(naf[b].length,max)}for(var acc=this.jpoint(null,null,null),tmp=this._wnafT4,i=max;i>=0;i--){for(var k=0;i>=0;){for(var zero=!0,j=0;j<len;j++)tmp[j]=0|naf[j][i],0!==tmp[j]&&(zero=!1);if(!zero)break;k++,i--}if(i>=0&&k++,acc=acc.dblp(k),i<0)break;for(var j=0;j<len;j++){var p,z=tmp[j];0!==z&&(z>0?p=wnd[j][z-1>>1]:z<0&&(p=wnd[j][-z-1>>1].neg()),acc="affine"===p.type?acc.mixedAdd(p):acc.add(p))}}for(var i=0;i<len;i++)wnd[i]=null;return acc.toP()},BaseCurve.BasePoint=BasePoint,BasePoint.prototype.validate=function(){return this.curve.validate(this)},BasePoint.prototype.precompute=function(power){if(this.precomputed)return this;var precomputed={doubles:null,naf:null,beta:null};return precomputed.naf=this._getNAFPoints(8),precomputed.doubles=this._getDoubles(4,power),precomputed.beta=this._getBeta(),this.precomputed=precomputed,this},BasePoint.prototype._getDoubles=function(step,power){if(this.precomputed&&this.precomputed.doubles)return this.precomputed.doubles;for(var doubles=[this],acc=this,i=0;i<power;i+=step){for(var j=0;j<step;j++)acc=acc.dbl();doubles.push(acc)}return{step:step,points:doubles}},BasePoint.prototype._getNAFPoints=function(wnd){if(this.precomputed&&this.precomputed.naf)return this.precomputed.naf;for(var res=[this],max=(1<<wnd)-1,dbl=1===max?null:this.dbl(),i=1;i<max;i++)res[i]=res[i-1].add(dbl);return{wnd:wnd,points:res}},BasePoint.prototype._getBeta=function(){return null},BasePoint.prototype.dblp=function(k){for(var r=this,i=0;i<k;i++)r=r.dbl();return r}},{"../../elliptic":83,"bn.js":80}],85:[function(require,module,exports){"use strict";function EdwardsCurve(conf){this.twisted=1!==(0|conf.a),this.mOneA=this.twisted&&(0|conf.a)===-1,this.extended=this.mOneA,Base.call(this,"edwards",conf),this.a=new bn(conf.a,16).mod(this.red.m).toRed(this.red),this.c=new bn(conf.c,16).toRed(this.red),this.c2=this.c.redSqr(),this.d=new bn(conf.d,16).toRed(this.red),this.dd=this.d.redAdd(this.d),assert(!this.twisted||0===this.c.fromRed().cmpn(1)),this.oneC=1===(0|conf.c)}function Point(curve,x,y,z,t){Base.BasePoint.call(this,curve,"projective"),null===x&&null===y&&null===z?(this.x=this.curve.zero,this.y=this.curve.one,this.z=this.curve.one,this.t=this.curve.zero,this.zOne=!0):(this.x=new bn(x,16),this.y=new bn(y,16),this.z=z?new bn(z,16):this.curve.one,this.t=t&&new bn(t,16),this.x.red||(this.x=this.x.toRed(this.curve.red)),this.y.red||(this.y=this.y.toRed(this.curve.red)),this.z.red||(this.z=this.z.toRed(this.curve.red)),this.t&&!this.t.red&&(this.t=this.t.toRed(this.curve.red)),this.zOne=this.z===this.curve.one,this.curve.extended&&!this.t&&(this.t=this.x.redMul(this.y),this.zOne||(this.t=this.t.redMul(this.z.redInvm()))))}var curve=require("../curve"),elliptic=require("../../elliptic"),bn=require("bn.js"),inherits=require("inherits"),Base=curve.base,assert=elliptic.utils.assert;inherits(EdwardsCurve,Base),module.exports=EdwardsCurve,EdwardsCurve.prototype._mulA=function(num){return this.mOneA?num.redNeg():this.a.redMul(num)},EdwardsCurve.prototype._mulC=function(num){return this.oneC?num:this.c.redMul(num)},EdwardsCurve.prototype.jpoint=function(x,y,z,t){return this.point(x,y,z,t)},EdwardsCurve.prototype.pointFromX=function(odd,x){x=new bn(x,16),x.red||(x=x.toRed(this.red));var x2=x.redSqr(),rhs=this.c2.redSub(this.a.redMul(x2)),lhs=this.one.redSub(this.c2.redMul(this.d).redMul(x2)),y=rhs.redMul(lhs.redInvm()).redSqrt(),isOdd=y.fromRed().isOdd();return(odd&&!isOdd||!odd&&isOdd)&&(y=y.redNeg()),this.point(x,y,curve.one)},EdwardsCurve.prototype.validate=function(point){if(point.isInfinity())return!0;point.normalize();var x2=point.x.redSqr(),y2=point.y.redSqr(),lhs=x2.redMul(this.a).redAdd(y2),rhs=this.c2.redMul(this.one.redAdd(this.d.redMul(x2).redMul(y2)));return 0===lhs.cmp(rhs)},inherits(Point,Base.BasePoint),EdwardsCurve.prototype.pointFromJSON=function(obj){return Point.fromJSON(this,obj)},EdwardsCurve.prototype.point=function(x,y,z,t){return new Point(this,x,y,z,t)},Point.fromJSON=function(curve,obj){return new Point(curve,obj[0],obj[1],obj[2])},Point.prototype.inspect=function(){return this.isInfinity()?"<EC Point Infinity>":"<EC Point x: "+this.x.fromRed().toString(16,2)+" y: "+this.y.fromRed().toString(16,2)+" z: "+this.z.fromRed().toString(16,2)+">"},Point.prototype.isInfinity=function(){return 0===this.x.cmpn(0)&&0===this.y.cmp(this.z)},Point.prototype._extDbl=function(){var a=this.x.redSqr(),b=this.y.redSqr(),c=this.z.redSqr();c=c.redIAdd(c);var d=this.curve._mulA(a),e=this.x.redAdd(this.y).redSqr().redISub(a).redISub(b),g=d.redAdd(b),f=g.redSub(c),h=d.redSub(b),nx=e.redMul(f),ny=g.redMul(h),nt=e.redMul(h),nz=f.redMul(g);return this.curve.point(nx,ny,nz,nt)},Point.prototype._projDbl=function(){var nx,ny,nz,b=this.x.redAdd(this.y).redSqr(),c=this.x.redSqr(),d=this.y.redSqr();if(this.curve.twisted){var e=this.curve._mulA(c),f=e.redAdd(d);if(this.zOne)nx=b.redSub(c).redSub(d).redMul(f.redSub(this.curve.two)),ny=f.redMul(e.redSub(d)),nz=f.redSqr().redSub(f).redSub(f);else{var h=this.z.redSqr(),j=f.redSub(h).redISub(h);nx=b.redSub(c).redISub(d).redMul(j),ny=f.redMul(e.redSub(d)),nz=f.redMul(j)}}else{var e=c.redAdd(d),h=this.curve._mulC(this.c.redMul(this.z)).redSqr(),j=e.redSub(h).redSub(h);nx=this.curve._mulC(b.redISub(e)).redMul(j),ny=this.curve._mulC(e).redMul(c.redISub(d)),nz=e.redMul(j)}return this.curve.point(nx,ny,nz)},Point.prototype.dbl=function(){return this.isInfinity()?this:this.curve.extended?this._extDbl():this._projDbl()},Point.prototype._extAdd=function(p){var a=this.y.redSub(this.x).redMul(p.y.redSub(p.x)),b=this.y.redAdd(this.x).redMul(p.y.redAdd(p.x)),c=this.t.redMul(this.curve.dd).redMul(p.t),d=this.z.redMul(p.z.redAdd(p.z)),e=b.redSub(a),f=d.redSub(c),g=d.redAdd(c),h=b.redAdd(a),nx=e.redMul(f),ny=g.redMul(h),nt=e.redMul(h),nz=f.redMul(g);return this.curve.point(nx,ny,nz,nt)},Point.prototype._projAdd=function(p){var ny,nz,a=this.z.redMul(p.z),b=a.redSqr(),c=this.x.redMul(p.x),d=this.y.redMul(p.y),e=this.curve.d.redMul(c).redMul(d),f=b.redSub(e),g=b.redAdd(e),tmp=this.x.redAdd(this.y).redMul(p.x.redAdd(p.y)).redISub(c).redISub(d),nx=a.redMul(f).redMul(tmp);return this.curve.twisted?(ny=a.redMul(g).redMul(d.redSub(this.curve._mulA(c))),nz=f.redMul(g)):(ny=a.redMul(g).redMul(d.redSub(c)),nz=this.curve._mulC(f).redMul(g)),this.curve.point(nx,ny,nz)},Point.prototype.add=function(p){return this.isInfinity()?p:p.isInfinity()?this:this.curve.extended?this._extAdd(p):this._projAdd(p)},Point.prototype.mul=function(k){return this.precomputed&&this.precomputed.doubles?this.curve._fixedNafMul(this,k):this.curve._wnafMul(this,k)},Point.prototype.mulAdd=function(k1,p,k2){return this.curve._wnafMulAdd(1,[this,p],[k1,k2],2)},Point.prototype.normalize=function(){if(this.zOne)return this;var zi=this.z.redInvm();return this.x=this.x.redMul(zi),this.y=this.y.redMul(zi),this.t&&(this.t=this.t.redMul(zi)),this.z=this.curve.one,this.zOne=!0,this},Point.prototype.neg=function(){return this.curve.point(this.x.redNeg(),this.y,this.z,this.t&&this.t.redNeg())},Point.prototype.getX=function(){return this.normalize(),this.x.fromRed()},Point.prototype.getY=function(){return this.normalize(),this.y.fromRed()},Point.prototype.toP=Point.prototype.normalize,Point.prototype.mixedAdd=Point.prototype.add},{"../../elliptic":83,"../curve":86,"bn.js":80,inherits:104}],86:[function(require,module,exports){"use strict";var curve=exports;curve.base=require("./base"),curve["short"]=require("./short"),curve.mont=require("./mont"),curve.edwards=require("./edwards")},{"./base":84,"./edwards":85,"./mont":87,"./short":88}],87:[function(require,module,exports){"use strict";function MontCurve(conf){Base.call(this,"mont",conf),this.a=new bn(conf.a,16).toRed(this.red),this.b=new bn(conf.b,16).toRed(this.red),this.i4=new bn(4).toRed(this.red).redInvm(),this.two=new bn(2).toRed(this.red),this.a24=this.i4.redMul(this.a.redAdd(this.two))}function Point(curve,x,z){Base.BasePoint.call(this,curve,"projective"),null===x&&null===z?(this.x=this.curve.one,this.z=this.curve.zero):(this.x=new bn(x,16),this.z=new bn(z,16),this.x.red||(this.x=this.x.toRed(this.curve.red)),this.z.red||(this.z=this.z.toRed(this.curve.red)))}var curve=require("../curve"),bn=require("bn.js"),inherits=require("inherits"),Base=curve.base;inherits(MontCurve,Base),module.exports=MontCurve,MontCurve.prototype.validate=function(point){var x=point.normalize().x,x2=x.redSqr(),rhs=x2.redMul(x).redAdd(x2.redMul(this.a)).redAdd(x),y=rhs.redSqrt();return 0===y.redSqr().cmp(rhs)},inherits(Point,Base.BasePoint),MontCurve.prototype.point=function(x,z){return new Point(this,x,z)},MontCurve.prototype.pointFromJSON=function(obj){return Point.fromJSON(this,obj)},Point.prototype.precompute=function(){},Point.fromJSON=function(curve,obj){return new Point(curve,obj[0],obj[1]||curve.one)},Point.prototype.inspect=function(){return this.isInfinity()?"<EC Point Infinity>":"<EC Point x: "+this.x.fromRed().toString(16,2)+" z: "+this.z.fromRed().toString(16,2)+">"},Point.prototype.isInfinity=function(){return 0===this.z.cmpn(0)},Point.prototype.dbl=function(){var a=this.x.redAdd(this.z),aa=a.redSqr(),b=this.x.redSub(this.z),bb=b.redSqr(),c=aa.redSub(bb),nx=aa.redMul(bb),nz=c.redMul(bb.redAdd(this.curve.a24.redMul(c)));return this.curve.point(nx,nz)},Point.prototype.add=function(){throw new Error("Not supported on Montgomery curve")},Point.prototype.diffAdd=function(p,diff){var a=this.x.redAdd(this.z),b=this.x.redSub(this.z),c=p.x.redAdd(p.z),d=p.x.redSub(p.z),da=d.redMul(a),cb=c.redMul(b),nx=diff.z.redMul(da.redAdd(cb).redSqr()),nz=diff.x.redMul(da.redISub(cb).redSqr());return this.curve.point(nx,nz)},Point.prototype.mul=function(k){for(var t=k.clone(),a=this,b=this.curve.point(null,null),c=this,bits=[];0!==t.cmpn(0);t.ishrn(1))bits.push(t.andln(1));for(var i=bits.length-1;i>=0;i--)0===bits[i]?(a=a.diffAdd(b,c),b=b.dbl()):(b=a.diffAdd(b,c),a=a.dbl());return b},Point.prototype.mulAdd=function(){throw new Error("Not supported on Montgomery curve")},Point.prototype.normalize=function(){return this.x=this.x.redMul(this.z.redInvm()),this.z=this.curve.one,this},Point.prototype.getX=function(){return this.normalize(),this.x.fromRed()}},{"../curve":86,"bn.js":80,inherits:104}],88:[function(require,module,exports){"use strict";function ShortCurve(conf){Base.call(this,"short",conf),this.a=new bn(conf.a,16).toRed(this.red),this.b=new bn(conf.b,16).toRed(this.red),this.tinv=this.two.redInvm(),this.zeroA=0===this.a.fromRed().cmpn(0),this.threeA=0===this.a.fromRed().sub(this.p).cmpn(-3),this.endo=this._getEndomorphism(conf),this._endoWnafT1=new Array(4),this._endoWnafT2=new Array(4)}function Point(curve,x,y,isRed){Base.BasePoint.call(this,curve,"affine"),null===x&&null===y?(this.x=null,this.y=null,this.inf=!0):(this.x=new bn(x,16),this.y=new bn(y,16),isRed&&(this.x.forceRed(this.curve.red),this.y.forceRed(this.curve.red)),this.x.red||(this.x=this.x.toRed(this.curve.red)),this.y.red||(this.y=this.y.toRed(this.curve.red)),this.inf=!1)}function JPoint(curve,x,y,z){Base.BasePoint.call(this,curve,"jacobian"),null===x&&null===y&&null===z?(this.x=this.curve.one,this.y=this.curve.one,this.z=new bn(0)):(this.x=new bn(x,16),this.y=new bn(y,16),this.z=new bn(z,16)),this.x.red||(this.x=this.x.toRed(this.curve.red)),this.y.red||(this.y=this.y.toRed(this.curve.red)),this.z.red||(this.z=this.z.toRed(this.curve.red)),this.zOne=this.z===this.curve.one}var curve=require("../curve"),elliptic=require("../../elliptic"),bn=require("bn.js"),inherits=require("inherits"),Base=curve.base,assert=elliptic.utils.assert;inherits(ShortCurve,Base),module.exports=ShortCurve,ShortCurve.prototype._getEndomorphism=function(conf){if(this.zeroA&&this.g&&this.n&&1===this.p.modn(3)){var beta,lambda;if(conf.beta)beta=new bn(conf.beta,16).toRed(this.red);else{var betas=this._getEndoRoots(this.p);beta=betas[0].cmp(betas[1])<0?betas[0]:betas[1],beta=beta.toRed(this.red)}if(conf.lambda)lambda=new bn(conf.lambda,16);else{var lambdas=this._getEndoRoots(this.n);0===this.g.mul(lambdas[0]).x.cmp(this.g.x.redMul(beta))?lambda=lambdas[0]:(lambda=lambdas[1],assert(0===this.g.mul(lambda).x.cmp(this.g.x.redMul(beta))))}var basis;return basis=conf.basis?conf.basis.map(function(vec){return{a:new bn(vec.a,16),b:new bn(vec.b,16)}}):this._getEndoBasis(lambda),{beta:beta,lambda:lambda,basis:basis}}},ShortCurve.prototype._getEndoRoots=function(num){var red=num===this.p?this.red:bn.mont(num),tinv=new bn(2).toRed(red).redInvm(),ntinv=tinv.redNeg(),s=new bn(3).toRed(red).redNeg().redSqrt().redMul(tinv),l1=ntinv.redAdd(s).fromRed(),l2=ntinv.redSub(s).fromRed();return[l1,l2]},ShortCurve.prototype._getEndoBasis=function(lambda){for(var a0,b0,a1,b1,a2,b2,prevR,r,x,aprxSqrt=this.n.shrn(Math.floor(this.n.bitLength()/2)),u=lambda,v=this.n.clone(),x1=new bn(1),y1=new bn(0),x2=new bn(0),y2=new bn(1),i=0;0!==u.cmpn(0);){var q=v.div(u);r=v.sub(q.mul(u)),x=x2.sub(q.mul(x1));var y=y2.sub(q.mul(y1));if(!a1&&r.cmp(aprxSqrt)<0)a0=prevR.neg(),b0=x1,a1=r.neg(),b1=x;else if(a1&&2===++i)break;prevR=r,v=u,u=r,x2=x1,x1=x,y2=y1,y1=y}a2=r.neg(),b2=x;var len1=a1.sqr().add(b1.sqr()),len2=a2.sqr().add(b2.sqr());return len2.cmp(len1)>=0&&(a2=a0,b2=b0),a1.sign&&(a1=a1.neg(),b1=b1.neg()),a2.sign&&(a2=a2.neg(),b2=b2.neg()),[{a:a1,b:b1},{a:a2,b:b2}]},ShortCurve.prototype._endoSplit=function(k){var basis=this.endo.basis,v1=basis[0],v2=basis[1],c1=v2.b.mul(k).divRound(this.n),c2=v1.b.neg().mul(k).divRound(this.n),p1=c1.mul(v1.a),p2=c2.mul(v2.a),q1=c1.mul(v1.b),q2=c2.mul(v2.b),k1=k.sub(p1).sub(p2),k2=q1.add(q2).neg();return{k1:k1,k2:k2}},ShortCurve.prototype.pointFromX=function(odd,x){x=new bn(x,16),x.red||(x=x.toRed(this.red));var y2=x.redSqr().redMul(x).redIAdd(x.redMul(this.a)).redIAdd(this.b),y=y2.redSqrt(),isOdd=y.fromRed().isOdd();return(odd&&!isOdd||!odd&&isOdd)&&(y=y.redNeg()),this.point(x,y)},ShortCurve.prototype.validate=function(point){if(point.inf)return!0;var x=point.x,y=point.y,ax=this.a.redMul(x),rhs=x.redSqr().redMul(x).redIAdd(ax).redIAdd(this.b);return 0===y.redSqr().redISub(rhs).cmpn(0)},ShortCurve.prototype._endoWnafMulAdd=function(points,coeffs){for(var npoints=this._endoWnafT1,ncoeffs=this._endoWnafT2,i=0;i<points.length;i++){var split=this._endoSplit(coeffs[i]),p=points[i],beta=p._getBeta();split.k1.sign&&(split.k1.sign=!split.k1.sign,p=p.neg(!0)),split.k2.sign&&(split.k2.sign=!split.k2.sign,beta=beta.neg(!0)),npoints[2*i]=p,npoints[2*i+1]=beta,ncoeffs[2*i]=split.k1,ncoeffs[2*i+1]=split.k2}for(var res=this._wnafMulAdd(1,npoints,ncoeffs,2*i),j=0;j<2*i;j++)npoints[j]=null,ncoeffs[j]=null;return res},inherits(Point,Base.BasePoint),ShortCurve.prototype.point=function(x,y,isRed){return new Point(this,x,y,isRed)},ShortCurve.prototype.pointFromJSON=function(obj,red){return Point.fromJSON(this,obj,red)},Point.prototype._getBeta=function(){if(this.curve.endo){var pre=this.precomputed;if(pre&&pre.beta)return pre.beta;var beta=this.curve.point(this.x.redMul(this.curve.endo.beta),this.y);if(pre){var curve=this.curve,endoMul=function(p){return curve.point(p.x.redMul(curve.endo.beta),p.y)};pre.beta=beta,beta.precomputed={beta:null,naf:pre.naf&&{wnd:pre.naf.wnd,points:pre.naf.points.map(endoMul)},doubles:pre.doubles&&{step:pre.doubles.step,points:pre.doubles.points.map(endoMul)}}}return beta}},Point.prototype.toJSON=function(){return this.precomputed?[this.x,this.y,this.precomputed&&{doubles:this.precomputed.doubles&&{step:this.precomputed.doubles.step,points:this.precomputed.doubles.points.slice(1)},naf:this.precomputed.naf&&{wnd:this.precomputed.naf.wnd,points:this.precomputed.naf.points.slice(1)}}]:[this.x,this.y]},Point.fromJSON=function(curve,obj,red){function obj2point(obj){return curve.point(obj[0],obj[1],red)}"string"==typeof obj&&(obj=JSON.parse(obj));var res=curve.point(obj[0],obj[1],red);if(!obj[2])return res;var pre=obj[2];return res.precomputed={beta:null,doubles:pre.doubles&&{step:pre.doubles.step,points:[res].concat(pre.doubles.points.map(obj2point))},naf:pre.naf&&{wnd:pre.naf.wnd,points:[res].concat(pre.naf.points.map(obj2point))}},res},Point.prototype.inspect=function(){return this.isInfinity()?"<EC Point Infinity>":"<EC Point x: "+this.x.fromRed().toString(16,2)+" y: "+this.y.fromRed().toString(16,2)+">"},Point.prototype.isInfinity=function(){return this.inf},Point.prototype.add=function(p){if(this.inf)return p;if(p.inf)return this;if(this.eq(p))return this.dbl();if(this.neg().eq(p))return this.curve.point(null,null);if(0===this.x.cmp(p.x))return this.curve.point(null,null);var c=this.y.redSub(p.y);0!==c.cmpn(0)&&(c=c.redMul(this.x.redSub(p.x).redInvm()));var nx=c.redSqr().redISub(this.x).redISub(p.x),ny=c.redMul(this.x.redSub(nx)).redISub(this.y);return this.curve.point(nx,ny)},Point.prototype.dbl=function(){if(this.inf)return this;var ys1=this.y.redAdd(this.y);if(0===ys1.cmpn(0))return this.curve.point(null,null);var a=this.curve.a,x2=this.x.redSqr(),dyinv=ys1.redInvm(),c=x2.redAdd(x2).redIAdd(x2).redIAdd(a).redMul(dyinv),nx=c.redSqr().redISub(this.x.redAdd(this.x)),ny=c.redMul(this.x.redSub(nx)).redISub(this.y);return this.curve.point(nx,ny)},Point.prototype.getX=function(){return this.x.fromRed()},Point.prototype.getY=function(){return this.y.fromRed()},Point.prototype.mul=function(k){return k=new bn(k,16),this.precomputed&&this.precomputed.doubles?this.curve._fixedNafMul(this,k):this.curve.endo?this.curve._endoWnafMulAdd([this],[k]):this.curve._wnafMul(this,k)},Point.prototype.mulAdd=function(k1,p2,k2){var points=[this,p2],coeffs=[k1,k2];return this.curve.endo?this.curve._endoWnafMulAdd(points,coeffs):this.curve._wnafMulAdd(1,points,coeffs,2)},Point.prototype.eq=function(p){return this===p||this.inf===p.inf&&(this.inf||0===this.x.cmp(p.x)&&0===this.y.cmp(p.y))},Point.prototype.neg=function(_precompute){if(this.inf)return this;var res=this.curve.point(this.x,this.y.redNeg());if(_precompute&&this.precomputed){var pre=this.precomputed,negate=function(p){return p.neg()};res.precomputed={naf:pre.naf&&{wnd:pre.naf.wnd,points:pre.naf.points.map(negate)},doubles:pre.doubles&&{step:pre.doubles.step,points:pre.doubles.points.map(negate)}}}return res},Point.prototype.toJ=function(){if(this.inf)return this.curve.jpoint(null,null,null);var res=this.curve.jpoint(this.x,this.y,this.curve.one);return res},inherits(JPoint,Base.BasePoint),ShortCurve.prototype.jpoint=function(x,y,z){return new JPoint(this,x,y,z)},JPoint.prototype.toP=function(){if(this.isInfinity())return this.curve.point(null,null);var zinv=this.z.redInvm(),zinv2=zinv.redSqr(),ax=this.x.redMul(zinv2),ay=this.y.redMul(zinv2).redMul(zinv);return this.curve.point(ax,ay)},JPoint.prototype.neg=function(){return this.curve.jpoint(this.x,this.y.redNeg(),this.z)},JPoint.prototype.add=function(p){if(this.isInfinity())return p;if(p.isInfinity())return this;var pz2=p.z.redSqr(),z2=this.z.redSqr(),u1=this.x.redMul(pz2),u2=p.x.redMul(z2),s1=this.y.redMul(pz2.redMul(p.z)),s2=p.y.redMul(z2.redMul(this.z)),h=u1.redSub(u2),r=s1.redSub(s2);if(0===h.cmpn(0))return 0!==r.cmpn(0)?this.curve.jpoint(null,null,null):this.dbl();var h2=h.redSqr(),h3=h2.redMul(h),v=u1.redMul(h2),nx=r.redSqr().redIAdd(h3).redISub(v).redISub(v),ny=r.redMul(v.redISub(nx)).redISub(s1.redMul(h3)),nz=this.z.redMul(p.z).redMul(h);return this.curve.jpoint(nx,ny,nz)},JPoint.prototype.mixedAdd=function(p){if(this.isInfinity())return p.toJ();if(p.isInfinity())return this;var z2=this.z.redSqr(),u1=this.x,u2=p.x.redMul(z2),s1=this.y,s2=p.y.redMul(z2).redMul(this.z),h=u1.redSub(u2),r=s1.redSub(s2);if(0===h.cmpn(0))return 0!==r.cmpn(0)?this.curve.jpoint(null,null,null):this.dbl();var h2=h.redSqr(),h3=h2.redMul(h),v=u1.redMul(h2),nx=r.redSqr().redIAdd(h3).redISub(v).redISub(v),ny=r.redMul(v.redISub(nx)).redISub(s1.redMul(h3)),nz=this.z.redMul(h);return this.curve.jpoint(nx,ny,nz)},JPoint.prototype.dblp=function(pow){if(0===pow)return this;if(this.isInfinity())return this;if(!pow)return this.dbl();if(this.curve.zeroA||this.curve.threeA){for(var r=this,i=0;i<pow;i++)r=r.dbl();return r}for(var a=this.curve.a,tinv=this.curve.tinv,jx=this.x,jy=this.y,jz=this.z,jz4=jz.redSqr().redSqr(),jyd=jy.redAdd(jy),i=0;i<pow;i++){var jx2=jx.redSqr(),jyd2=jyd.redSqr(),jyd4=jyd2.redSqr(),c=jx2.redAdd(jx2).redIAdd(jx2).redIAdd(a.redMul(jz4)),t1=jx.redMul(jyd2),nx=c.redSqr().redISub(t1.redAdd(t1)),t2=t1.redISub(nx),dny=c.redMul(t2);dny=dny.redIAdd(dny).redISub(jyd4);var nz=jyd.redMul(jz);i+1<pow&&(jz4=jz4.redMul(jyd4)),jx=nx,jz=nz,jyd=dny}return this.curve.jpoint(jx,jyd.redMul(tinv),jz)},JPoint.prototype.dbl=function(){return this.isInfinity()?this:this.curve.zeroA?this._zeroDbl():this.curve.threeA?this._threeDbl():this._dbl()},JPoint.prototype._zeroDbl=function(){var nx,ny,nz;if(this.zOne){var xx=this.x.redSqr(),yy=this.y.redSqr(),yyyy=yy.redSqr(),s=this.x.redAdd(yy).redSqr().redISub(xx).redISub(yyyy);s=s.redIAdd(s);var m=xx.redAdd(xx).redIAdd(xx),t=m.redSqr().redISub(s).redISub(s),yyyy8=yyyy.redIAdd(yyyy);yyyy8=yyyy8.redIAdd(yyyy8),yyyy8=yyyy8.redIAdd(yyyy8),nx=t,ny=m.redMul(s.redISub(t)).redISub(yyyy8),nz=this.y.redAdd(this.y)}else{var a=this.x.redSqr(),b=this.y.redSqr(),c=b.redSqr(),d=this.x.redAdd(b).redSqr().redISub(a).redISub(c);d=d.redIAdd(d);var e=a.redAdd(a).redIAdd(a),f=e.redSqr(),c8=c.redIAdd(c);c8=c8.redIAdd(c8),c8=c8.redIAdd(c8),nx=f.redISub(d).redISub(d),ny=e.redMul(d.redISub(nx)).redISub(c8),nz=this.y.redMul(this.z),nz=nz.redIAdd(nz)}return this.curve.jpoint(nx,ny,nz)},JPoint.prototype._threeDbl=function(){var nx,ny,nz;if(this.zOne){var xx=this.x.redSqr(),yy=this.y.redSqr(),yyyy=yy.redSqr(),s=this.x.redAdd(yy).redSqr().redISub(xx).redISub(yyyy);s=s.redIAdd(s);var m=xx.redAdd(xx).redIAdd(xx).redIAdd(this.curve.a),t=m.redSqr().redISub(s).redISub(s);nx=t;var yyyy8=yyyy.redIAdd(yyyy);yyyy8=yyyy8.redIAdd(yyyy8),yyyy8=yyyy8.redIAdd(yyyy8),ny=m.redMul(s.redISub(t)).redISub(yyyy8),nz=this.y.redAdd(this.y)}else{var delta=this.z.redSqr(),gamma=this.y.redSqr(),beta=this.x.redMul(gamma),alpha=this.x.redSub(delta).redMul(this.x.redAdd(delta));alpha=alpha.redAdd(alpha).redIAdd(alpha);var beta4=beta.redIAdd(beta);beta4=beta4.redIAdd(beta4);var beta8=beta4.redAdd(beta4);nx=alpha.redSqr().redISub(beta8),nz=this.y.redAdd(this.z).redSqr().redISub(gamma).redISub(delta);var ggamma8=gamma.redSqr();ggamma8=ggamma8.redIAdd(ggamma8),ggamma8=ggamma8.redIAdd(ggamma8),ggamma8=ggamma8.redIAdd(ggamma8),ny=alpha.redMul(beta4.redISub(nx)).redISub(ggamma8)}return this.curve.jpoint(nx,ny,nz)},JPoint.prototype._dbl=function(){var a=this.curve.a,jx=this.x,jy=this.y,jz=this.z,jz4=jz.redSqr().redSqr(),jx2=jx.redSqr(),jy2=jy.redSqr(),c=jx2.redAdd(jx2).redIAdd(jx2).redIAdd(a.redMul(jz4)),jxd4=jx.redAdd(jx);jxd4=jxd4.redIAdd(jxd4);var t1=jxd4.redMul(jy2),nx=c.redSqr().redISub(t1.redAdd(t1)),t2=t1.redISub(nx),jyd8=jy2.redSqr();jyd8=jyd8.redIAdd(jyd8),jyd8=jyd8.redIAdd(jyd8),jyd8=jyd8.redIAdd(jyd8);var ny=c.redMul(t2).redISub(jyd8),nz=jy.redAdd(jy).redMul(jz);return this.curve.jpoint(nx,ny,nz)},JPoint.prototype.trpl=function(){if(!this.curve.zeroA)return this.dbl().add(this);var xx=this.x.redSqr(),yy=this.y.redSqr(),zz=this.z.redSqr(),yyyy=yy.redSqr(),m=xx.redAdd(xx).redIAdd(xx),mm=m.redSqr(),e=this.x.redAdd(yy).redSqr().redISub(xx).redISub(yyyy);e=e.redIAdd(e),e=e.redAdd(e).redIAdd(e),e=e.redISub(mm);var ee=e.redSqr(),t=yyyy.redIAdd(yyyy);t=t.redIAdd(t),t=t.redIAdd(t),t=t.redIAdd(t);var u=m.redIAdd(e).redSqr().redISub(mm).redISub(ee).redISub(t),yyu4=yy.redMul(u);yyu4=yyu4.redIAdd(yyu4),yyu4=yyu4.redIAdd(yyu4);var nx=this.x.redMul(ee).redISub(yyu4);nx=nx.redIAdd(nx),nx=nx.redIAdd(nx);var ny=this.y.redMul(u.redMul(t.redISub(u)).redISub(e.redMul(ee)));ny=ny.redIAdd(ny),ny=ny.redIAdd(ny),ny=ny.redIAdd(ny);var nz=this.z.redAdd(e).redSqr().redISub(zz).redISub(ee);return this.curve.jpoint(nx,ny,nz)},JPoint.prototype.mul=function(k,kbase){return k=new bn(k,kbase),this.curve._wnafMul(this,k)},JPoint.prototype.eq=function(p){if("affine"===p.type)return this.eq(p.toJ());if(this===p)return!0;var z2=this.z.redSqr(),pz2=p.z.redSqr();if(0!==this.x.redMul(pz2).redISub(p.x.redMul(z2)).cmpn(0))return!1;var z3=z2.redMul(this.z),pz3=pz2.redMul(p.z);return 0===this.y.redMul(pz3).redISub(p.y.redMul(z3)).cmpn(0)},JPoint.prototype.inspect=function(){return this.isInfinity()?"<EC JPoint Infinity>":"<EC JPoint x: "+this.x.toString(16,2)+" y: "+this.y.toString(16,2)+" z: "+this.z.toString(16,2)+">"},JPoint.prototype.isInfinity=function(){return 0===this.z.cmpn(0)}},{"../../elliptic":83,"../curve":86,"bn.js":80,inherits:104}],89:[function(require,module,exports){"use strict";function PresetCurve(options){"short"===options.type?this.curve=new elliptic.curve["short"](options):"edwards"===options.type?this.curve=new elliptic.curve.edwards(options):this.curve=new elliptic.curve.mont(options),this.g=this.curve.g,this.n=this.curve.n,this.hash=options.hash,assert(this.g.validate(),"Invalid curve"),assert(this.g.mul(this.n).isInfinity(),"Invalid curve, G*N != O")}function defineCurve(name,options){Object.defineProperty(curves,name,{configurable:!0,enumerable:!0,get:function(){var curve=new PresetCurve(options);return Object.defineProperty(curves,name,{configurable:!0,enumerable:!0,value:curve}),curve}})}var curves=exports,hash=require("hash.js"),elliptic=require("../elliptic"),assert=elliptic.utils.assert;curves.PresetCurve=PresetCurve,defineCurve("p192",{type:"short",prime:"p192",p:"ffffffff ffffffff ffffffff fffffffe ffffffff ffffffff",a:"ffffffff ffffffff ffffffff fffffffe ffffffff fffffffc",b:"64210519 e59c80e7 0fa7e9ab 72243049 feb8deec c146b9b1",n:"ffffffff ffffffff ffffffff 99def836 146bc9b1 b4d22831",hash:hash.sha256,gRed:!1,g:["188da80e b03090f6 7cbf20eb 43a18800 f4ff0afd 82ff1012","07192b95 ffc8da78 631011ed 6b24cdd5 73f977a1 1e794811"]}),defineCurve("p224",{type:"short",prime:"p224",p:"ffffffff ffffffff ffffffff ffffffff 00000000 00000000 00000001",a:"ffffffff ffffffff ffffffff fffffffe ffffffff ffffffff fffffffe",b:"b4050a85 0c04b3ab f5413256 5044b0b7 d7bfd8ba 270b3943 2355ffb4",n:"ffffffff ffffffff ffffffff ffff16a2 e0b8f03e 13dd2945 5c5c2a3d",hash:hash.sha256,gRed:!1,g:["b70e0cbd 6bb4bf7f 321390b9 4a03c1d3 56c21122 343280d6 115c1d21","bd376388 b5f723fb 4c22dfe6 cd4375a0 5a074764 44d58199 85007e34"]}),defineCurve("p256",{type:"short",prime:null,p:"ffffffff 00000001 00000000 00000000 00000000 ffffffff ffffffff ffffffff",a:"ffffffff 00000001 00000000 00000000 00000000 ffffffff ffffffff fffffffc",b:"5ac635d8 aa3a93e7 b3ebbd55 769886bc 651d06b0 cc53b0f6 3bce3c3e 27d2604b",n:"ffffffff 00000000 ffffffff ffffffff bce6faad a7179e84 f3b9cac2 fc632551",hash:hash.sha256,gRed:!1,g:["6b17d1f2 e12c4247 f8bce6e5 63a440f2 77037d81 2deb33a0 f4a13945 d898c296","4fe342e2 fe1a7f9b 8ee7eb4a 7c0f9e16 2bce3357 6b315ece cbb64068 37bf51f5"]}),defineCurve("curve25519",{type:"mont",prime:"p25519",p:"7fffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffed",a:"76d06",b:"0",n:"1000000000000000 0000000000000000 14def9dea2f79cd6 5812631a5cf5d3ed",hash:hash.sha256,gRed:!1,g:["9"]}),defineCurve("ed25519",{type:"edwards",prime:"p25519",p:"7fffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffed",a:"-1",c:"1",d:"52036cee2b6ffe73 8cc740797779e898 00700a4d4141d8ab 75eb4dca135978a3",n:"1000000000000000 0000000000000000 14def9dea2f79cd6 5812631a5cf5d3ed",hash:hash.sha256,gRed:!1,g:["216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a","6666666666666666666666666666666666666666666666666666666666666658"]});var pre;try{pre=require("./precomputed/secp256k1")}catch(e){pre=void 0}defineCurve("secp256k1",{type:"short",prime:"k256",p:"ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe fffffc2f",a:"0",b:"7",n:"ffffffff ffffffff ffffffff fffffffe baaedce6 af48a03b bfd25e8c d0364141",h:"1",hash:hash.sha256,beta:"7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee",lambda:"5363ad4cc05c30e0a5261c028812645a122e22ea20816678df02967c1b23bd72",basis:[{a:"3086d221a7d46bcde86c90e49284eb15",b:"-e4437ed6010e88286f547fa90abfe4c3"},{a:"114ca50f7a8e2f3f657c1108d9d44cfd8",b:"3086d221a7d46bcde86c90e49284eb15"}],gRed:!1,g:["79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798","483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8",pre]})},{"../elliptic":83,"./precomputed/secp256k1":94,"hash.js":97}],90:[function(require,module,exports){"use strict";function EC(options){return this instanceof EC?("string"==typeof options&&(assert(elliptic.curves.hasOwnProperty(options),"Unknown curve "+options),options=elliptic.curves[options]),options instanceof elliptic.curves.PresetCurve&&(options={curve:options}),this.curve=options.curve.curve,this.n=this.curve.n,this.nh=this.n.shrn(1),this.g=this.curve.g,this.g=options.curve.g,this.g.precompute(options.curve.n.bitLength()+1),void(this.hash=options.hash||options.curve.hash)):new EC(options)}var bn=require("bn.js"),elliptic=require("../../elliptic"),utils=elliptic.utils,assert=utils.assert,KeyPair=require("./key"),Signature=require("./signature");module.exports=EC,EC.prototype.keyPair=function(options){return new KeyPair(this,options)},EC.prototype.keyFromPrivate=function(priv,enc){return KeyPair.fromPrivate(this,priv,enc)},EC.prototype.keyFromPublic=function(pub,enc){return KeyPair.fromPublic(this,pub,enc)},EC.prototype.genKeyPair=function(options){options||(options={});for(var drbg=new elliptic.hmacDRBG({hash:this.hash,pers:options.pers,entropy:options.entropy||elliptic.rand(this.hash.hmacStrength),nonce:this.n.toArray()}),bytes=this.n.byteLength(),ns2=this.n.sub(new bn(2));;){var priv=new bn(drbg.generate(bytes));if(!(priv.cmp(ns2)>0))return priv.iaddn(1),this.keyFromPrivate(priv)}},EC.prototype._truncateToN=function(msg,truncOnly){var delta=8*msg.byteLength()-this.n.bitLength();return delta>0&&(msg=msg.shrn(delta)),!truncOnly&&msg.cmp(this.n)>=0?msg.sub(this.n):msg},EC.prototype.sign=function(msg,key,enc,options){"object"==typeof enc&&(options=enc,enc=null),options||(options={}),key=this.keyFromPrivate(key,enc),msg=this._truncateToN(new bn(msg,16));for(var bytes=this.n.byteLength(),bkey=key.getPrivate().toArray(),i=bkey.length;i<21;i++)bkey.unshift(0);for(var nonce=msg.toArray(),i=nonce.length;i<bytes;i++)nonce.unshift(0);for(var drbg=new elliptic.hmacDRBG({hash:this.hash,entropy:bkey,nonce:nonce}),ns1=this.n.sub(new bn(1));;){var k=new bn(drbg.generate(this.n.byteLength()));if(k=this._truncateToN(k,!0),!(k.cmpn(1)<=0||k.cmp(ns1)>=0)){var kp=this.g.mul(k);if(!kp.isInfinity()){var r=kp.getX().mod(this.n);if(0!==r.cmpn(0)){var s=k.invm(this.n).mul(r.mul(key.getPrivate()).iadd(msg)).mod(this.n);if(0!==s.cmpn(0))return options.canonical&&s.cmp(this.nh)>0&&(s=this.n.sub(s)),new Signature({r:r,s:s})}}}}},EC.prototype.verify=function(msg,signature,key,enc){msg=this._truncateToN(new bn(msg,16)),key=this.keyFromPublic(key,enc),signature=new Signature(signature,"hex");var r=signature.r,s=signature.s;if(r.cmpn(1)<0||r.cmp(this.n)>=0)return!1;if(s.cmpn(1)<0||s.cmp(this.n)>=0)return!1;var sinv=s.invm(this.n),u1=sinv.mul(msg).mod(this.n),u2=sinv.mul(r).mod(this.n),p=this.g.mulAdd(u1,key.getPublic(),u2);return!p.isInfinity()&&0===p.getX().mod(this.n).cmp(r)}},{"../../elliptic":83,"./key":91,"./signature":92,"bn.js":80}],91:[function(require,module,exports){"use strict";function KeyPair(ec,options){this.ec=ec,this.priv=null,this.pub=null,options.priv&&this._importPrivate(options.priv,options.privEnc),options.pub&&this._importPublic(options.pub,options.pubEnc)}var bn=require("bn.js"),elliptic=require("../../elliptic"),utils=elliptic.utils;module.exports=KeyPair,KeyPair.fromPublic=function(ec,pub,enc){return pub instanceof KeyPair?pub:new KeyPair(ec,{pub:pub,pubEnc:enc})},KeyPair.fromPrivate=function(ec,priv,enc){return priv instanceof KeyPair?priv:new KeyPair(ec,{priv:priv,privEnc:enc})},KeyPair.prototype.validate=function(){var pub=this.getPublic();return pub.isInfinity()?{result:!1,reason:"Invalid public key"}:pub.validate()?pub.mul(this.ec.curve.n).isInfinity()?{result:!0,reason:null}:{result:!1,reason:"Public key * N != O"
}:{result:!1,reason:"Public key is not a point"}},KeyPair.prototype.getPublic=function(compact,enc){if(this.pub||(this.pub=this.ec.g.mul(this.priv)),"string"==typeof compact&&(enc=compact,compact=null),!enc)return this.pub;for(var len=this.ec.curve.p.byteLength(),x=this.pub.getX().toArray(),i=x.length;i<len;i++)x.unshift(0);var res;if("mont"!==this.ec.curve.type)if(compact)res=[this.pub.getY().isEven()?2:3].concat(x);else{for(var y=this.pub.getY().toArray(),i=y.length;i<len;i++)y.unshift(0);var res=[4].concat(x,y)}else res=x;return utils.encode(res,enc)},KeyPair.prototype.getPrivate=function(enc){return"hex"===enc?this.priv.toString(16,2):this.priv},KeyPair.prototype._importPrivate=function(key,enc){this.priv=new bn(key,enc||16),this.priv=this.priv.mod(this.ec.curve.n)},KeyPair.prototype._importPublic=function(key,enc){return key.x||key.y?void(this.pub=this.ec.curve.point(key.x,key.y)):(key=utils.toArray(key,enc),"mont"!==this.ec.curve.type?this._importPublicShort(key):this._importPublicMont(key))},KeyPair.prototype._importPublicShort=function(key){var len=this.ec.curve.p.byteLength();4===key[0]&&key.length-1===2*len?this.pub=this.ec.curve.point(key.slice(1,1+len),key.slice(1+len,1+2*len)):2!==key[0]&&3!==key[0]||key.length-1!==len||(this.pub=this.ec.curve.pointFromX(3===key[0],key.slice(1,1+len)))},KeyPair.prototype._importPublicMont=function(key){this.pub=this.ec.curve.point(key,1)},KeyPair.prototype.derive=function(pub){return pub.mul(this.priv).getX()},KeyPair.prototype.sign=function(msg){return this.ec.sign(msg,this)},KeyPair.prototype.verify=function(msg,signature){return this.ec.verify(msg,signature,this)},KeyPair.prototype.inspect=function(){return"<Key priv: "+(this.priv&&this.priv.toString(16,2))+" pub: "+(this.pub&&this.pub.inspect())+" >"}},{"../../elliptic":83,"bn.js":80}],92:[function(require,module,exports){"use strict";function Signature(options,enc){return options instanceof Signature?options:void(this._importDER(options,enc)||(assert(options.r&&options.s,"Signature without r or s"),this.r=new bn(options.r,16),this.s=new bn(options.s,16)))}var bn=require("bn.js"),elliptic=require("../../elliptic"),utils=elliptic.utils,assert=utils.assert;module.exports=Signature,Signature.prototype._importDER=function(data,enc){if(data=utils.toArray(data,enc),data.length<6||48!==data[0]||2!==data[2])return!1;var total=data[1];if(1+total>data.length)return!1;var rlen=data[3];if(rlen>=128)return!1;if(4+rlen+2>=data.length)return!1;if(2!==data[4+rlen])return!1;var slen=data[5+rlen];return!(slen>=128)&&(!(4+rlen+2+slen>data.length)&&(this.r=new bn(data.slice(4,4+rlen)),this.s=new bn(data.slice(4+rlen+2,4+rlen+2+slen)),!0))},Signature.prototype.toDER=function(enc){var r=this.r.toArray(),s=this.s.toArray();128&r[0]&&(r=[0].concat(r)),128&s[0]&&(s=[0].concat(s));var total=r.length+s.length+4,res=[48,total,2,r.length];return res=res.concat(r,[2,s.length],s),utils.encode(res,enc)}},{"../../elliptic":83,"bn.js":80}],93:[function(require,module,exports){"use strict";function HmacDRBG(options){if(!(this instanceof HmacDRBG))return new HmacDRBG(options);this.hash=options.hash,this.predResist=!!options.predResist,this.outLen=this.hash.outSize,this.minEntropy=options.minEntropy||this.hash.hmacStrength,this.reseed=null,this.reseedInterval=null,this.K=null,this.V=null;var entropy=utils.toArray(options.entropy,options.entropyEnc),nonce=utils.toArray(options.nonce,options.nonceEnc),pers=utils.toArray(options.pers,options.persEnc);assert(entropy.length>=this.minEntropy/8,"Not enough entropy. Minimum is: "+this.minEntropy+" bits"),this._init(entropy,nonce,pers)}var hash=require("hash.js"),elliptic=require("../elliptic"),utils=elliptic.utils,assert=utils.assert;module.exports=HmacDRBG,HmacDRBG.prototype._init=function(entropy,nonce,pers){var seed=entropy.concat(nonce).concat(pers);this.K=new Array(this.outLen/8),this.V=new Array(this.outLen/8);for(var i=0;i<this.V.length;i++)this.K[i]=0,this.V[i]=1;this._update(seed),this.reseed=1,this.reseedInterval=281474976710656},HmacDRBG.prototype._hmac=function(){return new hash.hmac(this.hash,this.K)},HmacDRBG.prototype._update=function(seed){var kmac=this._hmac().update(this.V).update([0]);seed&&(kmac=kmac.update(seed)),this.K=kmac.digest(),this.V=this._hmac().update(this.V).digest(),seed&&(this.K=this._hmac().update(this.V).update([1]).update(seed).digest(),this.V=this._hmac().update(this.V).digest())},HmacDRBG.prototype.reseed=function(entropy,entropyEnc,add,addEnc){"string"!=typeof entropyEnc&&(addEnc=add,add=entropyEnc,entropyEnc=null),entropy=utils.toBuffer(entropy,entropyEnc),add=utils.toBuffer(add,addEnc),assert(entropy.length>=this.minEntropy/8,"Not enough entropy. Minimum is: "+this.minEntropy+" bits"),this._update(entropy.concat(add||[])),this.reseed=1},HmacDRBG.prototype.generate=function(len,enc,add,addEnc){if(this.reseed>this.reseedInterval)throw new Error("Reseed is required");"string"!=typeof enc&&(addEnc=add,add=enc,enc=null),add&&(add=utils.toArray(add,addEnc),this._update(add));for(var temp=[];temp.length<len;)this.V=this._hmac().update(this.V).digest(),temp=temp.concat(this.V);var res=temp.slice(0,len);return this._update(add),this.reseed++,utils.encode(res,enc)}},{"../elliptic":83,"hash.js":97}],94:[function(require,module,exports){module.exports={doubles:{step:4,points:[["e60fce93b59e9ec53011aabc21c23e97b2a31369b87a5ae9c44ee89e2a6dec0a","f7e3507399e595929db99f34f57937101296891e44d23f0be1f32cce69616821"],["8282263212c609d9ea2a6e3e172de238d8c39cabd5ac1ca10646e23fd5f51508","11f8a8098557dfe45e8256e830b60ace62d613ac2f7b17bed31b6eaff6e26caf"],["175e159f728b865a72f99cc6c6fc846de0b93833fd2222ed73fce5b551e5b739","d3506e0d9e3c79eba4ef97a51ff71f5eacb5955add24345c6efa6ffee9fed695"],["363d90d447b00c9c99ceac05b6262ee053441c7e55552ffe526bad8f83ff4640","4e273adfc732221953b445397f3363145b9a89008199ecb62003c7f3bee9de9"],["8b4b5f165df3c2be8c6244b5b745638843e4a781a15bcd1b69f79a55dffdf80c","4aad0a6f68d308b4b3fbd7813ab0da04f9e336546162ee56b3eff0c65fd4fd36"],["723cbaa6e5db996d6bf771c00bd548c7b700dbffa6c0e77bcb6115925232fcda","96e867b5595cc498a921137488824d6e2660a0653779494801dc069d9eb39f5f"],["eebfa4d493bebf98ba5feec812c2d3b50947961237a919839a533eca0e7dd7fa","5d9a8ca3970ef0f269ee7edaf178089d9ae4cdc3a711f712ddfd4fdae1de8999"],["100f44da696e71672791d0a09b7bde459f1215a29b3c03bfefd7835b39a48db0","cdd9e13192a00b772ec8f3300c090666b7ff4a18ff5195ac0fbd5cd62bc65a09"],["e1031be262c7ed1b1dc9227a4a04c017a77f8d4464f3b3852c8acde6e534fd2d","9d7061928940405e6bb6a4176597535af292dd419e1ced79a44f18f29456a00d"],["feea6cae46d55b530ac2839f143bd7ec5cf8b266a41d6af52d5e688d9094696d","e57c6b6c97dce1bab06e4e12bf3ecd5c981c8957cc41442d3155debf18090088"],["da67a91d91049cdcb367be4be6ffca3cfeed657d808583de33fa978bc1ec6cb1","9bacaa35481642bc41f463f7ec9780e5dec7adc508f740a17e9ea8e27a68be1d"],["53904faa0b334cdda6e000935ef22151ec08d0f7bb11069f57545ccc1a37b7c0","5bc087d0bc80106d88c9eccac20d3c1c13999981e14434699dcb096b022771c8"],["8e7bcd0bd35983a7719cca7764ca906779b53a043a9b8bcaeff959f43ad86047","10b7770b2a3da4b3940310420ca9514579e88e2e47fd68b3ea10047e8460372a"],["385eed34c1cdff21e6d0818689b81bde71a7f4f18397e6690a841e1599c43862","283bebc3e8ea23f56701de19e9ebf4576b304eec2086dc8cc0458fe5542e5453"],["6f9d9b803ecf191637c73a4413dfa180fddf84a5947fbc9c606ed86c3fac3a7","7c80c68e603059ba69b8e2a30e45c4d47ea4dd2f5c281002d86890603a842160"],["3322d401243c4e2582a2147c104d6ecbf774d163db0f5e5313b7e0e742d0e6bd","56e70797e9664ef5bfb019bc4ddaf9b72805f63ea2873af624f3a2e96c28b2a0"],["85672c7d2de0b7da2bd1770d89665868741b3f9af7643397721d74d28134ab83","7c481b9b5b43b2eb6374049bfa62c2e5e77f17fcc5298f44c8e3094f790313a6"],["948bf809b1988a46b06c9f1919413b10f9226c60f668832ffd959af60c82a0a","53a562856dcb6646dc6b74c5d1c3418c6d4dff08c97cd2bed4cb7f88d8c8e589"],["6260ce7f461801c34f067ce0f02873a8f1b0e44dfc69752accecd819f38fd8e8","bc2da82b6fa5b571a7f09049776a1ef7ecd292238051c198c1a84e95b2b4ae17"],["e5037de0afc1d8d43d8348414bbf4103043ec8f575bfdc432953cc8d2037fa2d","4571534baa94d3b5f9f98d09fb990bddbd5f5b03ec481f10e0e5dc841d755bda"],["e06372b0f4a207adf5ea905e8f1771b4e7e8dbd1c6a6c5b725866a0ae4fce725","7a908974bce18cfe12a27bb2ad5a488cd7484a7787104870b27034f94eee31dd"],["213c7a715cd5d45358d0bbf9dc0ce02204b10bdde2a3f58540ad6908d0559754","4b6dad0b5ae462507013ad06245ba190bb4850f5f36a7eeddff2c27534b458f2"],["4e7c272a7af4b34e8dbb9352a5419a87e2838c70adc62cddf0cc3a3b08fbd53c","17749c766c9d0b18e16fd09f6def681b530b9614bff7dd33e0b3941817dcaae6"],["fea74e3dbe778b1b10f238ad61686aa5c76e3db2be43057632427e2840fb27b6","6e0568db9b0b13297cf674deccb6af93126b596b973f7b77701d3db7f23cb96f"],["76e64113f677cf0e10a2570d599968d31544e179b760432952c02a4417bdde39","c90ddf8dee4e95cf577066d70681f0d35e2a33d2b56d2032b4b1752d1901ac01"],["c738c56b03b2abe1e8281baa743f8f9a8f7cc643df26cbee3ab150242bcbb891","893fb578951ad2537f718f2eacbfbbbb82314eef7880cfe917e735d9699a84c3"],["d895626548b65b81e264c7637c972877d1d72e5f3a925014372e9f6588f6c14b","febfaa38f2bc7eae728ec60818c340eb03428d632bb067e179363ed75d7d991f"],["b8da94032a957518eb0f6433571e8761ceffc73693e84edd49150a564f676e03","2804dfa44805a1e4d7c99cc9762808b092cc584d95ff3b511488e4e74efdf6e7"],["e80fea14441fb33a7d8adab9475d7fab2019effb5156a792f1a11778e3c0df5d","eed1de7f638e00771e89768ca3ca94472d155e80af322ea9fcb4291b6ac9ec78"],["a301697bdfcd704313ba48e51d567543f2a182031efd6915ddc07bbcc4e16070","7370f91cfb67e4f5081809fa25d40f9b1735dbf7c0a11a130c0d1a041e177ea1"],["90ad85b389d6b936463f9d0512678de208cc330b11307fffab7ac63e3fb04ed4","e507a3620a38261affdcbd9427222b839aefabe1582894d991d4d48cb6ef150"],["8f68b9d2f63b5f339239c1ad981f162ee88c5678723ea3351b7b444c9ec4c0da","662a9f2dba063986de1d90c2b6be215dbbea2cfe95510bfdf23cbf79501fff82"],["e4f3fb0176af85d65ff99ff9198c36091f48e86503681e3e6686fd5053231e11","1e63633ad0ef4f1c1661a6d0ea02b7286cc7e74ec951d1c9822c38576feb73bc"],["8c00fa9b18ebf331eb961537a45a4266c7034f2f0d4e1d0716fb6eae20eae29e","efa47267fea521a1a9dc343a3736c974c2fadafa81e36c54e7d2a4c66702414b"],["e7a26ce69dd4829f3e10cec0a9e98ed3143d084f308b92c0997fddfc60cb3e41","2a758e300fa7984b471b006a1aafbb18d0a6b2c0420e83e20e8a9421cf2cfd51"],["b6459e0ee3662ec8d23540c223bcbdc571cbcb967d79424f3cf29eb3de6b80ef","67c876d06f3e06de1dadf16e5661db3c4b3ae6d48e35b2ff30bf0b61a71ba45"],["d68a80c8280bb840793234aa118f06231d6f1fc67e73c5a5deda0f5b496943e8","db8ba9fff4b586d00c4b1f9177b0e28b5b0e7b8f7845295a294c84266b133120"],["324aed7df65c804252dc0270907a30b09612aeb973449cea4095980fc28d3d5d","648a365774b61f2ff130c0c35aec1f4f19213b0c7e332843967224af96ab7c84"],["4df9c14919cde61f6d51dfdbe5fee5dceec4143ba8d1ca888e8bd373fd054c96","35ec51092d8728050974c23a1d85d4b5d506cdc288490192ebac06cad10d5d"],["9c3919a84a474870faed8a9c1cc66021523489054d7f0308cbfc99c8ac1f98cd","ddb84f0f4a4ddd57584f044bf260e641905326f76c64c8e6be7e5e03d4fc599d"],["6057170b1dd12fdf8de05f281d8e06bb91e1493a8b91d4cc5a21382120a959e5","9a1af0b26a6a4807add9a2daf71df262465152bc3ee24c65e899be932385a2a8"],["a576df8e23a08411421439a4518da31880cef0fba7d4df12b1a6973eecb94266","40a6bf20e76640b2c92b97afe58cd82c432e10a7f514d9f3ee8be11ae1b28ec8"],["7778a78c28dec3e30a05fe9629de8c38bb30d1f5cf9a3a208f763889be58ad71","34626d9ab5a5b22ff7098e12f2ff580087b38411ff24ac563b513fc1fd9f43ac"],["928955ee637a84463729fd30e7afd2ed5f96274e5ad7e5cb09eda9c06d903ac","c25621003d3f42a827b78a13093a95eeac3d26efa8a8d83fc5180e935bcd091f"],["85d0fef3ec6db109399064f3a0e3b2855645b4a907ad354527aae75163d82751","1f03648413a38c0be29d496e582cf5663e8751e96877331582c237a24eb1f962"],["ff2b0dce97eece97c1c9b6041798b85dfdfb6d8882da20308f5404824526087e","493d13fef524ba188af4c4dc54d07936c7b7ed6fb90e2ceb2c951e01f0c29907"],["827fbbe4b1e880ea9ed2b2e6301b212b57f1ee148cd6dd28780e5e2cf856e241","c60f9c923c727b0b71bef2c67d1d12687ff7a63186903166d605b68baec293ec"],["eaa649f21f51bdbae7be4ae34ce6e5217a58fdce7f47f9aa7f3b58fa2120e2b3","be3279ed5bbbb03ac69a80f89879aa5a01a6b965f13f7e59d47a5305ba5ad93d"],["e4a42d43c5cf169d9391df6decf42ee541b6d8f0c9a137401e23632dda34d24f","4d9f92e716d1c73526fc99ccfb8ad34ce886eedfa8d8e4f13a7f7131deba9414"],["1ec80fef360cbdd954160fadab352b6b92b53576a88fea4947173b9d4300bf19","aeefe93756b5340d2f3a4958a7abbf5e0146e77f6295a07b671cdc1cc107cefd"],["146a778c04670c2f91b00af4680dfa8bce3490717d58ba889ddb5928366642be","b318e0ec3354028add669827f9d4b2870aaa971d2f7e5ed1d0b297483d83efd0"],["fa50c0f61d22e5f07e3acebb1aa07b128d0012209a28b9776d76a8793180eef9","6b84c6922397eba9b72cd2872281a68a5e683293a57a213b38cd8d7d3f4f2811"],["da1d61d0ca721a11b1a5bf6b7d88e8421a288ab5d5bba5220e53d32b5f067ec2","8157f55a7c99306c79c0766161c91e2966a73899d279b48a655fba0f1ad836f1"],["a8e282ff0c9706907215ff98e8fd416615311de0446f1e062a73b0610d064e13","7f97355b8db81c09abfb7f3c5b2515888b679a3e50dd6bd6cef7c73111f4cc0c"],["174a53b9c9a285872d39e56e6913cab15d59b1fa512508c022f382de8319497c","ccc9dc37abfc9c1657b4155f2c47f9e6646b3a1d8cb9854383da13ac079afa73"],["959396981943785c3d3e57edf5018cdbe039e730e4918b3d884fdff09475b7ba","2e7e552888c331dd8ba0386a4b9cd6849c653f64c8709385e9b8abf87524f2fd"],["d2a63a50ae401e56d645a1153b109a8fcca0a43d561fba2dbb51340c9d82b151","e82d86fb6443fcb7565aee58b2948220a70f750af484ca52d4142174dcf89405"],["64587e2335471eb890ee7896d7cfdc866bacbdbd3839317b3436f9b45617e073","d99fcdd5bf6902e2ae96dd6447c299a185b90a39133aeab358299e5e9faf6589"],["8481bde0e4e4d885b3a546d3e549de042f0aa6cea250e7fd358d6c86dd45e458","38ee7b8cba5404dd84a25bf39cecb2ca900a79c42b262e556d64b1b59779057e"],["13464a57a78102aa62b6979ae817f4637ffcfed3c4b1ce30bcd6303f6caf666b","69be159004614580ef7e433453ccb0ca48f300a81d0942e13f495a907f6ecc27"],["bc4a9df5b713fe2e9aef430bcc1dc97a0cd9ccede2f28588cada3a0d2d83f366","d3a81ca6e785c06383937adf4b798caa6e8a9fbfa547b16d758d666581f33c1"],["8c28a97bf8298bc0d23d8c749452a32e694b65e30a9472a3954ab30fe5324caa","40a30463a3305193378fedf31f7cc0eb7ae784f0451cb9459e71dc73cbef9482"],["8ea9666139527a8c1dd94ce4f071fd23c8b350c5a4bb33748c4ba111faccae0","620efabbc8ee2782e24e7c0cfb95c5d735b783be9cf0f8e955af34a30e62b945"],["dd3625faef5ba06074669716bbd3788d89bdde815959968092f76cc4eb9a9787","7a188fa3520e30d461da2501045731ca941461982883395937f68d00c644a573"],["f710d79d9eb962297e4f6232b40e8f7feb2bc63814614d692c12de752408221e","ea98e67232d3b3295d3b535532115ccac8612c721851617526ae47a9c77bfc82"]]},naf:{wnd:7,points:[["f9308a019258c31049344f85f89d5229b531c845836f99b08601f113bce036f9","388f7b0f632de8140fe337e62a37f3566500a99934c2231b6cb9fd7584b8e672"],["2f8bde4d1a07209355b4a7250a5c5128e88b84bddc619ab7cba8d569b240efe4","d8ac222636e5e3d6d4dba9dda6c9c426f788271bab0d6840dca87d3aa6ac62d6"],["5cbdf0646e5db4eaa398f365f2ea7a0e3d419b7e0330e39ce92bddedcac4f9bc","6aebca40ba255960a3178d6d861a54dba813d0b813fde7b5a5082628087264da"],["acd484e2f0c7f65309ad178a9f559abde09796974c57e714c35f110dfc27ccbe","cc338921b0a7d9fd64380971763b61e9add888a4375f8e0f05cc262ac64f9c37"],["774ae7f858a9411e5ef4246b70c65aac5649980be5c17891bbec17895da008cb","d984a032eb6b5e190243dd56d7b7b365372db1e2dff9d6a8301d74c9c953c61b"],["f28773c2d975288bc7d1d205c3748651b075fbc6610e58cddeeddf8f19405aa8","ab0902e8d880a89758212eb65cdaf473a1a06da521fa91f29b5cb52db03ed81"],["d7924d4f7d43ea965a465ae3095ff41131e5946f3c85f79e44adbcf8e27e080e","581e2872a86c72a683842ec228cc6defea40af2bd896d3a5c504dc9ff6a26b58"],["defdea4cdb677750a420fee807eacf21eb9898ae79b9768766e4faa04a2d4a34","4211ab0694635168e997b0ead2a93daeced1f4a04a95c0f6cfb199f69e56eb77"],["2b4ea0a797a443d293ef5cff444f4979f06acfebd7e86d277475656138385b6c","85e89bc037945d93b343083b5a1c86131a01f60c50269763b570c854e5c09b7a"],["352bbf4a4cdd12564f93fa332ce333301d9ad40271f8107181340aef25be59d5","321eb4075348f534d59c18259dda3e1f4a1b3b2e71b1039c67bd3d8bcf81998c"],["2fa2104d6b38d11b0230010559879124e42ab8dfeff5ff29dc9cdadd4ecacc3f","2de1068295dd865b64569335bd5dd80181d70ecfc882648423ba76b532b7d67"],["9248279b09b4d68dab21a9b066edda83263c3d84e09572e269ca0cd7f5453714","73016f7bf234aade5d1aa71bdea2b1ff3fc0de2a887912ffe54a32ce97cb3402"],["daed4f2be3a8bf278e70132fb0beb7522f570e144bf615c07e996d443dee8729","a69dce4a7d6c98e8d4a1aca87ef8d7003f83c230f3afa726ab40e52290be1c55"],["c44d12c7065d812e8acf28d7cbb19f9011ecd9e9fdf281b0e6a3b5e87d22e7db","2119a460ce326cdc76c45926c982fdac0e106e861edf61c5a039063f0e0e6482"],["6a245bf6dc698504c89a20cfded60853152b695336c28063b61c65cbd269e6b4","e022cf42c2bd4a708b3f5126f16a24ad8b33ba48d0423b6efd5e6348100d8a82"],["1697ffa6fd9de627c077e3d2fe541084ce13300b0bec1146f95ae57f0d0bd6a5","b9c398f186806f5d27561506e4557433a2cf15009e498ae7adee9d63d01b2396"],["605bdb019981718b986d0f07e834cb0d9deb8360ffb7f61df982345ef27a7479","2972d2de4f8d20681a78d93ec96fe23c26bfae84fb14db43b01e1e9056b8c49"],["62d14dab4150bf497402fdc45a215e10dcb01c354959b10cfe31c7e9d87ff33d","80fc06bd8cc5b01098088a1950eed0db01aa132967ab472235f5642483b25eaf"],["80c60ad0040f27dade5b4b06c408e56b2c50e9f56b9b8b425e555c2f86308b6f","1c38303f1cc5c30f26e66bad7fe72f70a65eed4cbe7024eb1aa01f56430bd57a"],["7a9375ad6167ad54aa74c6348cc54d344cc5dc9487d847049d5eabb0fa03c8fb","d0e3fa9eca8726909559e0d79269046bdc59ea10c70ce2b02d499ec224dc7f7"],["d528ecd9b696b54c907a9ed045447a79bb408ec39b68df504bb51f459bc3ffc9","eecf41253136e5f99966f21881fd656ebc4345405c520dbc063465b521409933"],["49370a4b5f43412ea25f514e8ecdad05266115e4a7ecb1387231808f8b45963","758f3f41afd6ed428b3081b0512fd62a54c3f3afbb5b6764b653052a12949c9a"],["77f230936ee88cbbd73df930d64702ef881d811e0e1498e2f1c13eb1fc345d74","958ef42a7886b6400a08266e9ba1b37896c95330d97077cbbe8eb3c7671c60d6"],["f2dac991cc4ce4b9ea44887e5c7c0bce58c80074ab9d4dbaeb28531b7739f530","e0dedc9b3b2f8dad4da1f32dec2531df9eb5fbeb0598e4fd1a117dba703a3c37"],["463b3d9f662621fb1b4be8fbbe2520125a216cdfc9dae3debcba4850c690d45b","5ed430d78c296c3543114306dd8622d7c622e27c970a1de31cb377b01af7307e"],["f16f804244e46e2a09232d4aff3b59976b98fac14328a2d1a32496b49998f247","cedabd9b82203f7e13d206fcdf4e33d92a6c53c26e5cce26d6579962c4e31df6"],["caf754272dc84563b0352b7a14311af55d245315ace27c65369e15f7151d41d1","cb474660ef35f5f2a41b643fa5e460575f4fa9b7962232a5c32f908318a04476"],["2600ca4b282cb986f85d0f1709979d8b44a09c07cb86d7c124497bc86f082120","4119b88753c15bd6a693b03fcddbb45d5ac6be74ab5f0ef44b0be9475a7e4b40"],["7635ca72d7e8432c338ec53cd12220bc01c48685e24f7dc8c602a7746998e435","91b649609489d613d1d5e590f78e6d74ecfc061d57048bad9e76f302c5b9c61"],["754e3239f325570cdbbf4a87deee8a66b7f2b33479d468fbc1a50743bf56cc18","673fb86e5bda30fb3cd0ed304ea49a023ee33d0197a695d0c5d98093c536683"],["e3e6bd1071a1e96aff57859c82d570f0330800661d1c952f9fe2694691d9b9e8","59c9e0bba394e76f40c0aa58379a3cb6a5a2283993e90c4167002af4920e37f5"],["186b483d056a033826ae73d88f732985c4ccb1f32ba35f4b4cc47fdcf04aa6eb","3b952d32c67cf77e2e17446e204180ab21fb8090895138b4a4a797f86e80888b"],["df9d70a6b9876ce544c98561f4be4f725442e6d2b737d9c91a8321724ce0963f","55eb2dafd84d6ccd5f862b785dc39d4ab157222720ef9da217b8c45cf2ba2417"],["5edd5cc23c51e87a497ca815d5dce0f8ab52554f849ed8995de64c5f34ce7143","efae9c8dbc14130661e8cec030c89ad0c13c66c0d17a2905cdc706ab7399a868"],["290798c2b6476830da12fe02287e9e777aa3fba1c355b17a722d362f84614fba","e38da76dcd440621988d00bcf79af25d5b29c094db2a23146d003afd41943e7a"],["af3c423a95d9f5b3054754efa150ac39cd29552fe360257362dfdecef4053b45","f98a3fd831eb2b749a93b0e6f35cfb40c8cd5aa667a15581bc2feded498fd9c6"],["766dbb24d134e745cccaa28c99bf274906bb66b26dcf98df8d2fed50d884249a","744b1152eacbe5e38dcc887980da38b897584a65fa06cedd2c924f97cbac5996"],["59dbf46f8c94759ba21277c33784f41645f7b44f6c596a58ce92e666191abe3e","c534ad44175fbc300f4ea6ce648309a042ce739a7919798cd85e216c4a307f6e"],["f13ada95103c4537305e691e74e9a4a8dd647e711a95e73cb62dc6018cfd87b8","e13817b44ee14de663bf4bc808341f326949e21a6a75c2570778419bdaf5733d"],["7754b4fa0e8aced06d4167a2c59cca4cda1869c06ebadfb6488550015a88522c","30e93e864e669d82224b967c3020b8fa8d1e4e350b6cbcc537a48b57841163a2"],["948dcadf5990e048aa3874d46abef9d701858f95de8041d2a6828c99e2262519","e491a42537f6e597d5d28a3224b1bc25df9154efbd2ef1d2cbba2cae5347d57e"],["7962414450c76c1689c7b48f8202ec37fb224cf5ac0bfa1570328a8a3d7c77ab","100b610ec4ffb4760d5c1fc133ef6f6b12507a051f04ac5760afa5b29db83437"],["3514087834964b54b15b160644d915485a16977225b8847bb0dd085137ec47ca","ef0afbb2056205448e1652c48e8127fc6039e77c15c2378b7e7d15a0de293311"],["d3cc30ad6b483e4bc79ce2c9dd8bc54993e947eb8df787b442943d3f7b527eaf","8b378a22d827278d89c5e9be8f9508ae3c2ad46290358630afb34db04eede0a4"],["1624d84780732860ce1c78fcbfefe08b2b29823db913f6493975ba0ff4847610","68651cf9b6da903e0914448c6cd9d4ca896878f5282be4c8cc06e2a404078575"],["733ce80da955a8a26902c95633e62a985192474b5af207da6df7b4fd5fc61cd4","f5435a2bd2badf7d485a4d8b8db9fcce3e1ef8e0201e4578c54673bc1dc5ea1d"],["15d9441254945064cf1a1c33bbd3b49f8966c5092171e699ef258dfab81c045c","d56eb30b69463e7234f5137b73b84177434800bacebfc685fc37bbe9efe4070d"],["a1d0fcf2ec9de675b612136e5ce70d271c21417c9d2b8aaaac138599d0717940","edd77f50bcb5a3cab2e90737309667f2641462a54070f3d519212d39c197a629"],["e22fbe15c0af8ccc5780c0735f84dbe9a790badee8245c06c7ca37331cb36980","a855babad5cd60c88b430a69f53a1a7a38289154964799be43d06d77d31da06"],["311091dd9860e8e20ee13473c1155f5f69635e394704eaa74009452246cfa9b3","66db656f87d1f04fffd1f04788c06830871ec5a64feee685bd80f0b1286d8374"],["34c1fd04d301be89b31c0442d3e6ac24883928b45a9340781867d4232ec2dbdf","9414685e97b1b5954bd46f730174136d57f1ceeb487443dc5321857ba73abee"],["f219ea5d6b54701c1c14de5b557eb42a8d13f3abbcd08affcc2a5e6b049b8d63","4cb95957e83d40b0f73af4544cccf6b1f4b08d3c07b27fb8d8c2962a400766d1"],["d7b8740f74a8fbaab1f683db8f45de26543a5490bca627087236912469a0b448","fa77968128d9c92ee1010f337ad4717eff15db5ed3c049b3411e0315eaa4593b"],["32d31c222f8f6f0ef86f7c98d3a3335ead5bcd32abdd94289fe4d3091aa824bf","5f3032f5892156e39ccd3d7915b9e1da2e6dac9e6f26e961118d14b8462e1661"],["7461f371914ab32671045a155d9831ea8793d77cd59592c4340f86cbc18347b5","8ec0ba238b96bec0cbdddcae0aa442542eee1ff50c986ea6b39847b3cc092ff6"],["ee079adb1df1860074356a25aa38206a6d716b2c3e67453d287698bad7b2b2d6","8dc2412aafe3be5c4c5f37e0ecc5f9f6a446989af04c4e25ebaac479ec1c8c1e"],["16ec93e447ec83f0467b18302ee620f7e65de331874c9dc72bfd8616ba9da6b5","5e4631150e62fb40d0e8c2a7ca5804a39d58186a50e497139626778e25b0674d"],["eaa5f980c245f6f038978290afa70b6bd8855897f98b6aa485b96065d537bd99","f65f5d3e292c2e0819a528391c994624d784869d7e6ea67fb18041024edc07dc"],["78c9407544ac132692ee1910a02439958ae04877151342ea96c4b6b35a49f51","f3e0319169eb9b85d5404795539a5e68fa1fbd583c064d2462b675f194a3ddb4"],["494f4be219a1a77016dcd838431aea0001cdc8ae7a6fc688726578d9702857a5","42242a969283a5f339ba7f075e36ba2af925ce30d767ed6e55f4b031880d562c"],["a598a8030da6d86c6bc7f2f5144ea549d28211ea58faa70ebf4c1e665c1fe9b5","204b5d6f84822c307e4b4a7140737aec23fc63b65b35f86a10026dbd2d864e6b"],["c41916365abb2b5d09192f5f2dbeafec208f020f12570a184dbadc3e58595997","4f14351d0087efa49d245b328984989d5caf9450f34bfc0ed16e96b58fa9913"],["841d6063a586fa475a724604da03bc5b92a2e0d2e0a36acfe4c73a5514742881","73867f59c0659e81904f9a1c7543698e62562d6744c169ce7a36de01a8d6154"],["5e95bb399a6971d376026947f89bde2f282b33810928be4ded112ac4d70e20d5","39f23f366809085beebfc71181313775a99c9aed7d8ba38b161384c746012865"],["36e4641a53948fd476c39f8a99fd974e5ec07564b5315d8bf99471bca0ef2f66","d2424b1b1abe4eb8164227b085c9aa9456ea13493fd563e06fd51cf5694c78fc"],["336581ea7bfbbb290c191a2f507a41cf5643842170e914faeab27c2c579f726","ead12168595fe1be99252129b6e56b3391f7ab1410cd1e0ef3dcdcabd2fda224"],["8ab89816dadfd6b6a1f2634fcf00ec8403781025ed6890c4849742706bd43ede","6fdcef09f2f6d0a044e654aef624136f503d459c3e89845858a47a9129cdd24e"],["1e33f1a746c9c5778133344d9299fcaa20b0938e8acff2544bb40284b8c5fb94","60660257dd11b3aa9c8ed618d24edff2306d320f1d03010e33a7d2057f3b3b6"],["85b7c1dcb3cec1b7ee7f30ded79dd20a0ed1f4cc18cbcfcfa410361fd8f08f31","3d98a9cdd026dd43f39048f25a8847f4fcafad1895d7a633c6fed3c35e999511"],["29df9fbd8d9e46509275f4b125d6d45d7fbe9a3b878a7af872a2800661ac5f51","b4c4fe99c775a606e2d8862179139ffda61dc861c019e55cd2876eb2a27d84b"],["a0b1cae06b0a847a3fea6e671aaf8adfdfe58ca2f768105c8082b2e449fce252","ae434102edde0958ec4b19d917a6a28e6b72da1834aff0e650f049503a296cf2"],["4e8ceafb9b3e9a136dc7ff67e840295b499dfb3b2133e4ba113f2e4c0e121e5","cf2174118c8b6d7a4b48f6d534ce5c79422c086a63460502b827ce62a326683c"],["d24a44e047e19b6f5afb81c7ca2f69080a5076689a010919f42725c2b789a33b","6fb8d5591b466f8fc63db50f1c0f1c69013f996887b8244d2cdec417afea8fa3"],["ea01606a7a6c9cdd249fdfcfacb99584001edd28abbab77b5104e98e8e3b35d4","322af4908c7312b0cfbfe369f7a7b3cdb7d4494bc2823700cfd652188a3ea98d"],["af8addbf2b661c8a6c6328655eb96651252007d8c5ea31be4ad196de8ce2131f","6749e67c029b85f52a034eafd096836b2520818680e26ac8f3dfbcdb71749700"],["e3ae1974566ca06cc516d47e0fb165a674a3dabcfca15e722f0e3450f45889","2aeabe7e4531510116217f07bf4d07300de97e4874f81f533420a72eeb0bd6a4"],["591ee355313d99721cf6993ffed1e3e301993ff3ed258802075ea8ced397e246","b0ea558a113c30bea60fc4775460c7901ff0b053d25ca2bdeee98f1a4be5d196"],["11396d55fda54c49f19aa97318d8da61fa8584e47b084945077cf03255b52984","998c74a8cd45ac01289d5833a7beb4744ff536b01b257be4c5767bea93ea57a4"],["3c5d2a1ba39c5a1790000738c9e0c40b8dcdfd5468754b6405540157e017aa7a","b2284279995a34e2f9d4de7396fc18b80f9b8b9fdd270f6661f79ca4c81bd257"],["cc8704b8a60a0defa3a99a7299f2e9c3fbc395afb04ac078425ef8a1793cc030","bdd46039feed17881d1e0862db347f8cf395b74fc4bcdc4e940b74e3ac1f1b13"],["c533e4f7ea8555aacd9777ac5cad29b97dd4defccc53ee7ea204119b2889b197","6f0a256bc5efdf429a2fb6242f1a43a2d9b925bb4a4b3a26bb8e0f45eb596096"],["c14f8f2ccb27d6f109f6d08d03cc96a69ba8c34eec07bbcf566d48e33da6593","c359d6923bb398f7fd4473e16fe1c28475b740dd098075e6c0e8649113dc3a38"],["a6cbc3046bc6a450bac24789fa17115a4c9739ed75f8f21ce441f72e0b90e6ef","21ae7f4680e889bb130619e2c0f95a360ceb573c70603139862afd617fa9b9f"],["347d6d9a02c48927ebfb86c1359b1caf130a3c0267d11ce6344b39f99d43cc38","60ea7f61a353524d1c987f6ecec92f086d565ab687870cb12689ff1e31c74448"],["da6545d2181db8d983f7dcb375ef5866d47c67b1bf31c8cf855ef7437b72656a","49b96715ab6878a79e78f07ce5680c5d6673051b4935bd897fea824b77dc208a"],["c40747cc9d012cb1a13b8148309c6de7ec25d6945d657146b9d5994b8feb1111","5ca560753be2a12fc6de6caf2cb489565db936156b9514e1bb5e83037e0fa2d4"],["4e42c8ec82c99798ccf3a610be870e78338c7f713348bd34c8203ef4037f3502","7571d74ee5e0fb92a7a8b33a07783341a5492144cc54bcc40a94473693606437"],["3775ab7089bc6af823aba2e1af70b236d251cadb0c86743287522a1b3b0dedea","be52d107bcfa09d8bcb9736a828cfa7fac8db17bf7a76a2c42ad961409018cf7"],["cee31cbf7e34ec379d94fb814d3d775ad954595d1314ba8846959e3e82f74e26","8fd64a14c06b589c26b947ae2bcf6bfa0149ef0be14ed4d80f448a01c43b1c6d"],["b4f9eaea09b6917619f6ea6a4eb5464efddb58fd45b1ebefcdc1a01d08b47986","39e5c9925b5a54b07433a4f18c61726f8bb131c012ca542eb24a8ac07200682a"],["d4263dfc3d2df923a0179a48966d30ce84e2515afc3dccc1b77907792ebcc60e","62dfaf07a0f78feb30e30d6295853ce189e127760ad6cf7fae164e122a208d54"],["48457524820fa65a4f8d35eb6930857c0032acc0a4a2de422233eeda897612c4","25a748ab367979d98733c38a1fa1c2e7dc6cc07db2d60a9ae7a76aaa49bd0f77"],["dfeeef1881101f2cb11644f3a2afdfc2045e19919152923f367a1767c11cceda","ecfb7056cf1de042f9420bab396793c0c390bde74b4bbdff16a83ae09a9a7517"],["6d7ef6b17543f8373c573f44e1f389835d89bcbc6062ced36c82df83b8fae859","cd450ec335438986dfefa10c57fea9bcc521a0959b2d80bbf74b190dca712d10"],["e75605d59102a5a2684500d3b991f2e3f3c88b93225547035af25af66e04541f","f5c54754a8f71ee540b9b48728473e314f729ac5308b06938360990e2bfad125"],["eb98660f4c4dfaa06a2be453d5020bc99a0c2e60abe388457dd43fefb1ed620c","6cb9a8876d9cb8520609af3add26cd20a0a7cd8a9411131ce85f44100099223e"],["13e87b027d8514d35939f2e6892b19922154596941888336dc3563e3b8dba942","fef5a3c68059a6dec5d624114bf1e91aac2b9da568d6abeb2570d55646b8adf1"],["ee163026e9fd6fe017c38f06a5be6fc125424b371ce2708e7bf4491691e5764a","1acb250f255dd61c43d94ccc670d0f58f49ae3fa15b96623e5430da0ad6c62b2"],["b268f5ef9ad51e4d78de3a750c2dc89b1e626d43505867999932e5db33af3d80","5f310d4b3c99b9ebb19f77d41c1dee018cf0d34fd4191614003e945a1216e423"],["ff07f3118a9df035e9fad85eb6c7bfe42b02f01ca99ceea3bf7ffdba93c4750d","438136d603e858a3a5c440c38eccbaddc1d2942114e2eddd4740d098ced1f0d8"],["8d8b9855c7c052a34146fd20ffb658bea4b9f69e0d825ebec16e8c3ce2b526a1","cdb559eedc2d79f926baf44fb84ea4d44bcf50fee51d7ceb30e2e7f463036758"],["52db0b5384dfbf05bfa9d472d7ae26dfe4b851ceca91b1eba54263180da32b63","c3b997d050ee5d423ebaf66a6db9f57b3180c902875679de924b69d84a7b375"],["e62f9490d3d51da6395efd24e80919cc7d0f29c3f3fa48c6fff543becbd43352","6d89ad7ba4876b0b22c2ca280c682862f342c8591f1daf5170e07bfd9ccafa7d"],["7f30ea2476b399b4957509c88f77d0191afa2ff5cb7b14fd6d8e7d65aaab1193","ca5ef7d4b231c94c3b15389a5f6311e9daff7bb67b103e9880ef4bff637acaec"],["5098ff1e1d9f14fb46a210fada6c903fef0fb7b4a1dd1d9ac60a0361800b7a00","9731141d81fc8f8084d37c6e7542006b3ee1b40d60dfe5362a5b132fd17ddc0"],["32b78c7de9ee512a72895be6b9cbefa6e2f3c4ccce445c96b9f2c81e2778ad58","ee1849f513df71e32efc3896ee28260c73bb80547ae2275ba497237794c8753c"],["e2cb74fddc8e9fbcd076eef2a7c72b0ce37d50f08269dfc074b581550547a4f7","d3aa2ed71c9dd2247a62df062736eb0baddea9e36122d2be8641abcb005cc4a4"],["8438447566d4d7bedadc299496ab357426009a35f235cb141be0d99cd10ae3a8","c4e1020916980a4da5d01ac5e6ad330734ef0d7906631c4f2390426b2edd791f"],["4162d488b89402039b584c6fc6c308870587d9c46f660b878ab65c82c711d67e","67163e903236289f776f22c25fb8a3afc1732f2b84b4e95dbda47ae5a0852649"],["3fad3fa84caf0f34f0f89bfd2dcf54fc175d767aec3e50684f3ba4a4bf5f683d","cd1bc7cb6cc407bb2f0ca647c718a730cf71872e7d0d2a53fa20efcdfe61826"],["674f2600a3007a00568c1a7ce05d0816c1fb84bf1370798f1c69532faeb1a86b","299d21f9413f33b3edf43b257004580b70db57da0b182259e09eecc69e0d38a5"],["d32f4da54ade74abb81b815ad1fb3b263d82d6c692714bcff87d29bd5ee9f08f","f9429e738b8e53b968e99016c059707782e14f4535359d582fc416910b3eea87"],["30e4e670435385556e593657135845d36fbb6931f72b08cb1ed954f1e3ce3ff6","462f9bce619898638499350113bbc9b10a878d35da70740dc695a559eb88db7b"],["be2062003c51cc3004682904330e4dee7f3dcd10b01e580bf1971b04d4cad297","62188bc49d61e5428573d48a74e1c655b1c61090905682a0d5558ed72dccb9bc"],["93144423ace3451ed29e0fb9ac2af211cb6e84a601df5993c419859fff5df04a","7c10dfb164c3425f5c71a3f9d7992038f1065224f72bb9d1d902a6d13037b47c"],["b015f8044f5fcbdcf21ca26d6c34fb8197829205c7b7d2a7cb66418c157b112c","ab8c1e086d04e813744a655b2df8d5f83b3cdc6faa3088c1d3aea1454e3a1d5f"],["d5e9e1da649d97d89e4868117a465a3a4f8a18de57a140d36b3f2af341a21b52","4cb04437f391ed73111a13cc1d4dd0db1693465c2240480d8955e8592f27447a"],["d3ae41047dd7ca065dbf8ed77b992439983005cd72e16d6f996a5316d36966bb","bd1aeb21ad22ebb22a10f0303417c6d964f8cdd7df0aca614b10dc14d125ac46"],["463e2763d885f958fc66cdd22800f0a487197d0a82e377b49f80af87c897b065","bfefacdb0e5d0fd7df3a311a94de062b26b80c61fbc97508b79992671ef7ca7f"],["7985fdfd127c0567c6f53ec1bb63ec3158e597c40bfe747c83cddfc910641917","603c12daf3d9862ef2b25fe1de289aed24ed291e0ec6708703a5bd567f32ed03"],["74a1ad6b5f76e39db2dd249410eac7f99e74c59cb83d2d0ed5ff1543da7703e9","cc6157ef18c9c63cd6193d83631bbea0093e0968942e8c33d5737fd790e0db08"],["30682a50703375f602d416664ba19b7fc9bab42c72747463a71d0896b22f6da3","553e04f6b018b4fa6c8f39e7f311d3176290d0e0f19ca73f17714d9977a22ff8"],["9e2158f0d7c0d5f26c3791efefa79597654e7a2b2464f52b1ee6c1347769ef57","712fcdd1b9053f09003a3481fa7762e9ffd7c8ef35a38509e2fbf2629008373"],["176e26989a43c9cfeba4029c202538c28172e566e3c4fce7322857f3be327d66","ed8cc9d04b29eb877d270b4878dc43c19aefd31f4eee09ee7b47834c1fa4b1c3"],["75d46efea3771e6e68abb89a13ad747ecf1892393dfc4f1b7004788c50374da8","9852390a99507679fd0b86fd2b39a868d7efc22151346e1a3ca4726586a6bed8"],["809a20c67d64900ffb698c4c825f6d5f2310fb0451c869345b7319f645605721","9e994980d9917e22b76b061927fa04143d096ccc54963e6a5ebfa5f3f8e286c1"],["1b38903a43f7f114ed4500b4eac7083fdefece1cf29c63528d563446f972c180","4036edc931a60ae889353f77fd53de4a2708b26b6f5da72ad3394119daf408f9"]]}}},{}],95:[function(require,module,exports){"use strict";function toArray(msg,enc){if(Array.isArray(msg))return msg.slice();if(!msg)return[];var res=[];if("string"!=typeof msg){for(var i=0;i<msg.length;i++)res[i]=0|msg[i];return res}if(enc){if("hex"===enc){msg=msg.replace(/[^a-z0-9]+/gi,""),msg.length%2!==0&&(msg="0"+msg);for(var i=0;i<msg.length;i+=2)res.push(parseInt(msg[i]+msg[i+1],16))}}else for(var i=0;i<msg.length;i++){var c=msg.charCodeAt(i),hi=c>>8,lo=255&c;hi?res.push(hi,lo):res.push(lo)}return res}function zero2(word){return 1===word.length?"0"+word:word}function toHex(msg){
for(var res="",i=0;i<msg.length;i++)res+=zero2(msg[i].toString(16));return res}function getNAF(num,w){for(var naf=[],ws=1<<w+1,k=num.clone();k.cmpn(1)>=0;){var z;if(k.isOdd()){var mod=k.andln(ws-1);z=mod>(ws>>1)-1?(ws>>1)-mod:mod,k.isubn(z)}else z=0;naf.push(z);for(var shift=0!==k.cmpn(0)&&0===k.andln(ws-1)?w+1:1,i=1;i<shift;i++)naf.push(0);k.ishrn(shift)}return naf}function getJSF(k1,k2){var jsf=[[],[]];k1=k1.clone(),k2=k2.clone();for(var d1=0,d2=0;k1.cmpn(-d1)>0||k2.cmpn(-d2)>0;){var m14=k1.andln(3)+d1&3,m24=k2.andln(3)+d2&3;3===m14&&(m14=-1),3===m24&&(m24=-1);var u1;if(0===(1&m14))u1=0;else{var m8=k1.andln(7)+d1&7;u1=3!==m8&&5!==m8||2!==m24?m14:-m14}jsf[0].push(u1);var u2;if(0===(1&m24))u2=0;else{var m8=k2.andln(7)+d2&7;u2=3!==m8&&5!==m8||2!==m14?m24:-m24}jsf[1].push(u2),2*d1===u1+1&&(d1=1-d1),2*d2===u2+1&&(d2=1-d2),k1.ishrn(1),k2.ishrn(1)}return jsf}var utils=exports;utils.assert=function(val,msg){if(!val)throw new Error(msg||"Assertion failed")},utils.toArray=toArray,utils.zero2=zero2,utils.toHex=toHex,utils.encode=function(arr,enc){return"hex"===enc?toHex(arr):arr},utils.getNAF=getNAF,utils.getJSF=getJSF},{}],96:[function(require,module,exports){function Rand(rand){this.rand=rand}var r;if(module.exports=function(len){return r||(r=new Rand(null)),r.generate(len)},module.exports.Rand=Rand,Rand.prototype.generate=function(len){return this._rand(len)},"object"==typeof window)window.crypto&&window.crypto.getRandomValues?Rand.prototype._rand=function(n){var arr=new Uint8Array(n);return window.crypto.getRandomValues(arr),arr}:window.msCrypto&&window.msCrypto.getRandomValues?Rand.prototype._rand=function(n){var arr=new Uint8Array(n);return window.msCrypto.getRandomValues(arr),arr}:Rand.prototype._rand=function(){throw new Error("Not implemented yet")};else try{var crypto=require("crypto");Rand.prototype._rand=function(n){return crypto.randomBytes(n)}}catch(e){Rand.prototype._rand=function(n){for(var res=new Uint8Array(n),i=0;i<res.length;i++)res[i]=this.rand.getByte();return res}}},{}],97:[function(require,module,exports){var hash=exports;hash.utils=require("./hash/utils"),hash.common=require("./hash/common"),hash.sha=require("./hash/sha"),hash.ripemd=require("./hash/ripemd"),hash.hmac=require("./hash/hmac"),hash.sha1=hash.sha.sha1,hash.sha256=hash.sha.sha256,hash.sha224=hash.sha.sha224,hash.sha384=hash.sha.sha384,hash.sha512=hash.sha.sha512,hash.ripemd160=hash.ripemd.ripemd160},{"./hash/common":98,"./hash/hmac":99,"./hash/ripemd":100,"./hash/sha":101,"./hash/utils":102}],98:[function(require,module,exports){function BlockHash(){this.pending=null,this.pendingTotal=0,this.blockSize=this.constructor.blockSize,this.outSize=this.constructor.outSize,this.hmacStrength=this.constructor.hmacStrength,this.padLength=this.constructor.padLength/8,this.endian="big",this._delta8=this.blockSize/8,this._delta32=this.blockSize/32}var hash=require("../hash"),utils=hash.utils,assert=utils.assert;exports.BlockHash=BlockHash,BlockHash.prototype.update=function(msg,enc){if(msg=utils.toArray(msg,enc),this.pending?this.pending=this.pending.concat(msg):this.pending=msg,this.pendingTotal+=msg.length,this.pending.length>=this._delta8){msg=this.pending;var r=msg.length%this._delta8;this.pending=msg.slice(msg.length-r,msg.length),0===this.pending.length&&(this.pending=null),msg=utils.join32(msg,0,msg.length-r,this.endian);for(var i=0;i<msg.length;i+=this._delta32)this._update(msg,i,i+this._delta32)}return this},BlockHash.prototype.digest=function(enc){return this.update(this._pad()),assert(null===this.pending),this._digest(enc)},BlockHash.prototype._pad=function(){var len=this.pendingTotal,bytes=this._delta8,k=bytes-(len+this.padLength)%bytes,res=new Array(k+this.padLength);res[0]=128;for(var i=1;i<k;i++)res[i]=0;if(len<<=3,"big"===this.endian){for(var t=8;t<this.padLength;t++)res[i++]=0;res[i++]=0,res[i++]=0,res[i++]=0,res[i++]=0,res[i++]=len>>>24&255,res[i++]=len>>>16&255,res[i++]=len>>>8&255,res[i++]=255&len}else{res[i++]=255&len,res[i++]=len>>>8&255,res[i++]=len>>>16&255,res[i++]=len>>>24&255,res[i++]=0,res[i++]=0,res[i++]=0,res[i++]=0;for(var t=8;t<this.padLength;t++)res[i++]=0}return res}},{"../hash":97}],99:[function(require,module,exports){function Hmac(hash,key,enc){return this instanceof Hmac?(this.Hash=hash,this.blockSize=hash.blockSize/8,this.outSize=hash.outSize/8,this.inner=null,this.outer=null,void this._init(utils.toArray(key,enc))):new Hmac(hash,key,enc)}var hash=require("../hash"),utils=hash.utils,assert=utils.assert;module.exports=Hmac,Hmac.prototype._init=function(key){key.length>this.blockSize&&(key=(new this.Hash).update(key).digest()),assert(key.length<=this.blockSize);for(var i=key.length;i<this.blockSize;i++)key.push(0);for(var i=0;i<key.length;i++)key[i]^=54;this.inner=(new this.Hash).update(key);for(var i=0;i<key.length;i++)key[i]^=106;this.outer=(new this.Hash).update(key)},Hmac.prototype.update=function(msg,enc){return this.inner.update(msg,enc),this},Hmac.prototype.digest=function(enc){return this.outer.update(this.inner.digest()),this.outer.digest(enc)}},{"../hash":97}],100:[function(require,module,exports){function RIPEMD160(){return this instanceof RIPEMD160?(BlockHash.call(this),this.h=[1732584193,4023233417,2562383102,271733878,3285377520],void(this.endian="little")):new RIPEMD160}function f(j,x,y,z){return j<=15?x^y^z:j<=31?x&y|~x&z:j<=47?(x|~y)^z:j<=63?x&z|y&~z:x^(y|~z)}function K(j){return j<=15?0:j<=31?1518500249:j<=47?1859775393:j<=63?2400959708:2840853838}function Kh(j){return j<=15?1352829926:j<=31?1548603684:j<=47?1836072691:j<=63?2053994217:0}var hash=require("../hash"),utils=hash.utils,rotl32=utils.rotl32,sum32=utils.sum32,sum32_3=utils.sum32_3,sum32_4=utils.sum32_4,BlockHash=hash.common.BlockHash;utils.inherits(RIPEMD160,BlockHash),exports.ripemd160=RIPEMD160,RIPEMD160.blockSize=512,RIPEMD160.outSize=160,RIPEMD160.hmacStrength=192,RIPEMD160.padLength=64,RIPEMD160.prototype._update=function(msg,start){for(var A=this.h[0],B=this.h[1],C=this.h[2],D=this.h[3],E=this.h[4],Ah=A,Bh=B,Ch=C,Dh=D,Eh=E,j=0;j<80;j++){var T=sum32(rotl32(sum32_4(A,f(j,B,C,D),msg[r[j]+start],K(j)),s[j]),E);A=E,E=D,D=rotl32(C,10),C=B,B=T,T=sum32(rotl32(sum32_4(Ah,f(79-j,Bh,Ch,Dh),msg[rh[j]+start],Kh(j)),sh[j]),Eh),Ah=Eh,Eh=Dh,Dh=rotl32(Ch,10),Ch=Bh,Bh=T}T=sum32_3(this.h[1],C,Dh),this.h[1]=sum32_3(this.h[2],D,Eh),this.h[2]=sum32_3(this.h[3],E,Ah),this.h[3]=sum32_3(this.h[4],A,Bh),this.h[4]=sum32_3(this.h[0],B,Ch),this.h[0]=T},RIPEMD160.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h,"little"):utils.split32(this.h,"little")};var r=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13],rh=[5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11],s=[11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6],sh=[8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]},{"../hash":97}],101:[function(require,module,exports){function SHA256(){return this instanceof SHA256?(BlockHash.call(this),this.h=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],this.k=sha256_K,void(this.W=new Array(64))):new SHA256}function SHA224(){return this instanceof SHA224?(SHA256.call(this),void(this.h=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428])):new SHA224}function SHA512(){return this instanceof SHA512?(BlockHash.call(this),this.h=[1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209],this.k=sha512_K,void(this.W=new Array(160))):new SHA512}function SHA384(){return this instanceof SHA384?(SHA512.call(this),void(this.h=[3418070365,3238371032,1654270250,914150663,2438529370,812702999,355462360,4144912697,1731405415,4290775857,2394180231,1750603025,3675008525,1694076839,1203062813,3204075428])):new SHA384}function SHA1(){return this instanceof SHA1?(BlockHash.call(this),this.h=[1732584193,4023233417,2562383102,271733878,3285377520],void(this.W=new Array(80))):new SHA1}function ch32(x,y,z){return x&y^~x&z}function maj32(x,y,z){return x&y^x&z^y&z}function p32(x,y,z){return x^y^z}function s0_256(x){return rotr32(x,2)^rotr32(x,13)^rotr32(x,22)}function s1_256(x){return rotr32(x,6)^rotr32(x,11)^rotr32(x,25)}function g0_256(x){return rotr32(x,7)^rotr32(x,18)^x>>>3}function g1_256(x){return rotr32(x,17)^rotr32(x,19)^x>>>10}function ft_1(s,x,y,z){return 0===s?ch32(x,y,z):1===s||3===s?p32(x,y,z):2===s?maj32(x,y,z):void 0}function ch64_hi(xh,xl,yh,yl,zh,zl){var r=xh&yh^~xh&zh;return r<0&&(r+=4294967296),r}function ch64_lo(xh,xl,yh,yl,zh,zl){var r=xl&yl^~xl&zl;return r<0&&(r+=4294967296),r}function maj64_hi(xh,xl,yh,yl,zh,zl){var r=xh&yh^xh&zh^yh&zh;return r<0&&(r+=4294967296),r}function maj64_lo(xh,xl,yh,yl,zh,zl){var r=xl&yl^xl&zl^yl&zl;return r<0&&(r+=4294967296),r}function s0_512_hi(xh,xl){var c0_hi=rotr64_hi(xh,xl,28),c1_hi=rotr64_hi(xl,xh,2),c2_hi=rotr64_hi(xl,xh,7),r=c0_hi^c1_hi^c2_hi;return r<0&&(r+=4294967296),r}function s0_512_lo(xh,xl){var c0_lo=rotr64_lo(xh,xl,28),c1_lo=rotr64_lo(xl,xh,2),c2_lo=rotr64_lo(xl,xh,7),r=c0_lo^c1_lo^c2_lo;return r<0&&(r+=4294967296),r}function s1_512_hi(xh,xl){var c0_hi=rotr64_hi(xh,xl,14),c1_hi=rotr64_hi(xh,xl,18),c2_hi=rotr64_hi(xl,xh,9),r=c0_hi^c1_hi^c2_hi;return r<0&&(r+=4294967296),r}function s1_512_lo(xh,xl){var c0_lo=rotr64_lo(xh,xl,14),c1_lo=rotr64_lo(xh,xl,18),c2_lo=rotr64_lo(xl,xh,9),r=c0_lo^c1_lo^c2_lo;return r<0&&(r+=4294967296),r}function g0_512_hi(xh,xl){var c0_hi=rotr64_hi(xh,xl,1),c1_hi=rotr64_hi(xh,xl,8),c2_hi=shr64_hi(xh,xl,7),r=c0_hi^c1_hi^c2_hi;return r<0&&(r+=4294967296),r}function g0_512_lo(xh,xl){var c0_lo=rotr64_lo(xh,xl,1),c1_lo=rotr64_lo(xh,xl,8),c2_lo=shr64_lo(xh,xl,7),r=c0_lo^c1_lo^c2_lo;return r<0&&(r+=4294967296),r}function g1_512_hi(xh,xl){var c0_hi=rotr64_hi(xh,xl,19),c1_hi=rotr64_hi(xl,xh,29),c2_hi=shr64_hi(xh,xl,6),r=c0_hi^c1_hi^c2_hi;return r<0&&(r+=4294967296),r}function g1_512_lo(xh,xl){var c0_lo=rotr64_lo(xh,xl,19),c1_lo=rotr64_lo(xl,xh,29),c2_lo=shr64_lo(xh,xl,6),r=c0_lo^c1_lo^c2_lo;return r<0&&(r+=4294967296),r}var hash=require("../hash"),utils=hash.utils,assert=utils.assert,rotr32=utils.rotr32,rotl32=utils.rotl32,sum32=utils.sum32,sum32_4=utils.sum32_4,sum32_5=utils.sum32_5,rotr64_hi=utils.rotr64_hi,rotr64_lo=utils.rotr64_lo,shr64_hi=utils.shr64_hi,shr64_lo=utils.shr64_lo,sum64=utils.sum64,sum64_hi=utils.sum64_hi,sum64_lo=utils.sum64_lo,sum64_4_hi=utils.sum64_4_hi,sum64_4_lo=utils.sum64_4_lo,sum64_5_hi=utils.sum64_5_hi,sum64_5_lo=utils.sum64_5_lo,BlockHash=hash.common.BlockHash,sha256_K=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],sha512_K=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591],sha1_K=[1518500249,1859775393,2400959708,3395469782];utils.inherits(SHA256,BlockHash),exports.sha256=SHA256,SHA256.blockSize=512,SHA256.outSize=256,SHA256.hmacStrength=192,SHA256.padLength=64,SHA256.prototype._update=function(msg,start){for(var W=this.W,i=0;i<16;i++)W[i]=msg[start+i];for(;i<W.length;i++)W[i]=sum32_4(g1_256(W[i-2]),W[i-7],g0_256(W[i-15]),W[i-16]);var a=this.h[0],b=this.h[1],c=this.h[2],d=this.h[3],e=this.h[4],f=this.h[5],g=this.h[6],h=this.h[7];assert(this.k.length===W.length);for(var i=0;i<W.length;i++){var T1=sum32_5(h,s1_256(e),ch32(e,f,g),this.k[i],W[i]),T2=sum32(s0_256(a),maj32(a,b,c));h=g,g=f,f=e,e=sum32(d,T1),d=c,c=b,b=a,a=sum32(T1,T2)}this.h[0]=sum32(this.h[0],a),this.h[1]=sum32(this.h[1],b),this.h[2]=sum32(this.h[2],c),this.h[3]=sum32(this.h[3],d),this.h[4]=sum32(this.h[4],e),this.h[5]=sum32(this.h[5],f),this.h[6]=sum32(this.h[6],g),this.h[7]=sum32(this.h[7],h)},SHA256.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h,"big"):utils.split32(this.h,"big")},utils.inherits(SHA224,SHA256),exports.sha224=SHA224,SHA224.blockSize=512,SHA224.outSize=224,SHA224.hmacStrength=192,SHA224.padLength=64,SHA224.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h.slice(0,7),"big"):utils.split32(this.h.slice(0,7),"big")},utils.inherits(SHA512,BlockHash),exports.sha512=SHA512,SHA512.blockSize=1024,SHA512.outSize=512,SHA512.hmacStrength=192,SHA512.padLength=128,SHA512.prototype._prepareBlock=function(msg,start){for(var W=this.W,i=0;i<32;i++)W[i]=msg[start+i];for(;i<W.length;i+=2){var c0_hi=g1_512_hi(W[i-4],W[i-3]),c0_lo=g1_512_lo(W[i-4],W[i-3]),c1_hi=W[i-14],c1_lo=W[i-13],c2_hi=g0_512_hi(W[i-30],W[i-29]),c2_lo=g0_512_lo(W[i-30],W[i-29]),c3_hi=W[i-32],c3_lo=W[i-31];W[i]=sum64_4_hi(c0_hi,c0_lo,c1_hi,c1_lo,c2_hi,c2_lo,c3_hi,c3_lo),W[i+1]=sum64_4_lo(c0_hi,c0_lo,c1_hi,c1_lo,c2_hi,c2_lo,c3_hi,c3_lo)}},SHA512.prototype._update=function(msg,start){this._prepareBlock(msg,start);var W=this.W,ah=this.h[0],al=this.h[1],bh=this.h[2],bl=this.h[3],ch=this.h[4],cl=this.h[5],dh=this.h[6],dl=this.h[7],eh=this.h[8],el=this.h[9],fh=this.h[10],fl=this.h[11],gh=this.h[12],gl=this.h[13],hh=this.h[14],hl=this.h[15];assert(this.k.length===W.length);for(var i=0;i<W.length;i+=2){var c0_hi=hh,c0_lo=hl,c1_hi=s1_512_hi(eh,el),c1_lo=s1_512_lo(eh,el),c2_hi=ch64_hi(eh,el,fh,fl,gh,gl),c2_lo=ch64_lo(eh,el,fh,fl,gh,gl),c3_hi=this.k[i],c3_lo=this.k[i+1],c4_hi=W[i],c4_lo=W[i+1],T1_hi=sum64_5_hi(c0_hi,c0_lo,c1_hi,c1_lo,c2_hi,c2_lo,c3_hi,c3_lo,c4_hi,c4_lo),T1_lo=sum64_5_lo(c0_hi,c0_lo,c1_hi,c1_lo,c2_hi,c2_lo,c3_hi,c3_lo,c4_hi,c4_lo),c0_hi=s0_512_hi(ah,al),c0_lo=s0_512_lo(ah,al),c1_hi=maj64_hi(ah,al,bh,bl,ch,cl),c1_lo=maj64_lo(ah,al,bh,bl,ch,cl),T2_hi=sum64_hi(c0_hi,c0_lo,c1_hi,c1_lo),T2_lo=sum64_lo(c0_hi,c0_lo,c1_hi,c1_lo);hh=gh,hl=gl,gh=fh,gl=fl,fh=eh,fl=el,eh=sum64_hi(dh,dl,T1_hi,T1_lo),el=sum64_lo(dl,dl,T1_hi,T1_lo),dh=ch,dl=cl,ch=bh,cl=bl,bh=ah,bl=al,ah=sum64_hi(T1_hi,T1_lo,T2_hi,T2_lo),al=sum64_lo(T1_hi,T1_lo,T2_hi,T2_lo)}sum64(this.h,0,ah,al),sum64(this.h,2,bh,bl),sum64(this.h,4,ch,cl),sum64(this.h,6,dh,dl),sum64(this.h,8,eh,el),sum64(this.h,10,fh,fl),sum64(this.h,12,gh,gl),sum64(this.h,14,hh,hl)},SHA512.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h,"big"):utils.split32(this.h,"big")},utils.inherits(SHA384,SHA512),exports.sha384=SHA384,SHA384.blockSize=1024,SHA384.outSize=384,SHA384.hmacStrength=192,SHA384.padLength=128,SHA384.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h.slice(0,12),"big"):utils.split32(this.h.slice(0,12),"big")},utils.inherits(SHA1,BlockHash),exports.sha1=SHA1,SHA1.blockSize=512,SHA1.outSize=160,SHA1.hmacStrength=80,SHA1.padLength=64,SHA1.prototype._update=function(msg,start){for(var W=this.W,i=0;i<16;i++)W[i]=msg[start+i];for(;i<W.length;i++)W[i]=rotl32(W[i-3]^W[i-8]^W[i-14]^W[i-16],1);for(var a=this.h[0],b=this.h[1],c=this.h[2],d=this.h[3],e=this.h[4],i=0;i<W.length;i++){var s=~~(i/20),t=sum32_5(rotl32(a,5),ft_1(s,b,c,d),e,W[i],sha1_K[s]);e=d,d=c,c=rotl32(b,30),b=a,a=t}this.h[0]=sum32(this.h[0],a),this.h[1]=sum32(this.h[1],b),this.h[2]=sum32(this.h[2],c),this.h[3]=sum32(this.h[3],d),this.h[4]=sum32(this.h[4],e)},SHA1.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h,"big"):utils.split32(this.h,"big")}},{"../hash":97}],102:[function(require,module,exports){function toArray(msg,enc){if(Array.isArray(msg))return msg.slice();if(!msg)return[];var res=[];if("string"==typeof msg)if(enc){if("hex"===enc){msg=msg.replace(/[^a-z0-9]+/gi,""),msg.length%2!==0&&(msg="0"+msg);for(var i=0;i<msg.length;i+=2)res.push(parseInt(msg[i]+msg[i+1],16))}}else for(var i=0;i<msg.length;i++){var c=msg.charCodeAt(i),hi=c>>8,lo=255&c;hi?res.push(hi,lo):res.push(lo)}else for(var i=0;i<msg.length;i++)res[i]=0|msg[i];return res}function toHex(msg){for(var res="",i=0;i<msg.length;i++)res+=zero2(msg[i].toString(16));return res}function htonl(w){var res=w>>>24|w>>>8&65280|w<<8&16711680|(255&w)<<24;return res>>>0}function toHex32(msg,endian){for(var res="",i=0;i<msg.length;i++){var w=msg[i];"little"===endian&&(w=htonl(w)),res+=zero8(w.toString(16))}return res}function zero2(word){return 1===word.length?"0"+word:word}function zero8(word){return 7===word.length?"0"+word:6===word.length?"00"+word:5===word.length?"000"+word:4===word.length?"0000"+word:3===word.length?"00000"+word:2===word.length?"000000"+word:1===word.length?"0000000"+word:word}function join32(msg,start,end,endian){var len=end-start;assert(len%4===0);for(var res=new Array(len/4),i=0,k=start;i<res.length;i++,k+=4){var w;w="big"===endian?msg[k]<<24|msg[k+1]<<16|msg[k+2]<<8|msg[k+3]:msg[k+3]<<24|msg[k+2]<<16|msg[k+1]<<8|msg[k],res[i]=w>>>0}return res}function split32(msg,endian){for(var res=new Array(4*msg.length),i=0,k=0;i<msg.length;i++,k+=4){var m=msg[i];"big"===endian?(res[k]=m>>>24,res[k+1]=m>>>16&255,res[k+2]=m>>>8&255,res[k+3]=255&m):(res[k+3]=m>>>24,res[k+2]=m>>>16&255,res[k+1]=m>>>8&255,res[k]=255&m)}return res}function rotr32(w,b){return w>>>b|w<<32-b}function rotl32(w,b){return w<<b|w>>>32-b}function sum32(a,b){return a+b>>>0}function sum32_3(a,b,c){return a+b+c>>>0}function sum32_4(a,b,c,d){return a+b+c+d>>>0}function sum32_5(a,b,c,d,e){return a+b+c+d+e>>>0}function assert(cond,msg){if(!cond)throw new Error(msg||"Assertion failed")}function sum64(buf,pos,ah,al){var bh=buf[pos],bl=buf[pos+1],lo=al+bl>>>0,hi=(lo<al?1:0)+ah+bh;buf[pos]=hi>>>0,buf[pos+1]=lo}function sum64_hi(ah,al,bh,bl){var lo=al+bl>>>0,hi=(lo<al?1:0)+ah+bh;return hi>>>0}function sum64_lo(ah,al,bh,bl){var lo=al+bl;return lo>>>0}function sum64_4_hi(ah,al,bh,bl,ch,cl,dh,dl){var carry=0,lo=al;lo=lo+bl>>>0,carry+=lo<al?1:0,lo=lo+cl>>>0,carry+=lo<cl?1:0,lo=lo+dl>>>0,carry+=lo<dl?1:0;var hi=ah+bh+ch+dh+carry;return hi>>>0}function sum64_4_lo(ah,al,bh,bl,ch,cl,dh,dl){var lo=al+bl+cl+dl;return lo>>>0}function sum64_5_hi(ah,al,bh,bl,ch,cl,dh,dl,eh,el){var carry=0,lo=al;lo=lo+bl>>>0,carry+=lo<al?1:0,lo=lo+cl>>>0,carry+=lo<cl?1:0,lo=lo+dl>>>0,carry+=lo<dl?1:0,lo=lo+el>>>0,carry+=lo<el?1:0;var hi=ah+bh+ch+dh+eh+carry;return hi>>>0}function sum64_5_lo(ah,al,bh,bl,ch,cl,dh,dl,eh,el){var lo=al+bl+cl+dl+el;return lo>>>0}function rotr64_hi(ah,al,num){var r=al<<32-num|ah>>>num;return r>>>0}function rotr64_lo(ah,al,num){var r=ah<<32-num|al>>>num;return r>>>0}function shr64_hi(ah,al,num){return ah>>>num}function shr64_lo(ah,al,num){var r=ah<<32-num|al>>>num;return r>>>0}var utils=exports,inherits=require("inherits");utils.toArray=toArray,utils.toHex=toHex,utils.htonl=htonl,utils.toHex32=toHex32,utils.zero2=zero2,utils.zero8=zero8,utils.join32=join32,utils.split32=split32,utils.rotr32=rotr32,utils.rotl32=rotl32,utils.sum32=sum32,utils.sum32_3=sum32_3,utils.sum32_4=sum32_4,utils.sum32_5=sum32_5,utils.assert=assert,utils.inherits=inherits,exports.sum64=sum64,exports.sum64_hi=sum64_hi,exports.sum64_lo=sum64_lo,exports.sum64_4_hi=sum64_4_hi,exports.sum64_4_lo=sum64_4_lo,exports.sum64_5_hi=sum64_5_hi,exports.sum64_5_lo=sum64_5_lo,exports.rotr64_hi=rotr64_hi,exports.rotr64_lo=rotr64_lo,exports.shr64_hi=shr64_hi,exports.shr64_lo=shr64_lo},{inherits:104}],103:[function(require,module,exports){module.exports={_args:[["elliptic@https://registry.npmjs.org/elliptic/-/elliptic-3.0.3.tgz","/home/zhangchongyang/code/hdWallet/trustnote-wallet/node_modules/bitcore-lib"]],_from:"elliptic@=3.0.3",_id:"elliptic@3.0.3",_inCache:!0,_location:"/bitcore-lib/elliptic",_phantomChildren:{inherits:"2.0.1"},_requested:{name:"elliptic",raw:"elliptic@https://registry.npmjs.org/elliptic/-/elliptic-3.0.3.tgz",rawSpec:"https://registry.npmjs.org/elliptic/-/elliptic-3.0.3.tgz",scope:null,spec:"https://registry.npmjs.org/elliptic/-/elliptic-3.0.3.tgz",type:"remote"},_requiredBy:["/bitcore-lib"],_resolved:"https://registry.npmjs.org/elliptic/-/elliptic-3.0.3.tgz",_shasum:"865c9b420bfbe55006b9f969f97a0d2c44966595",_shrinkwrap:null,_spec:"elliptic@https://registry.npmjs.org/elliptic/-/elliptic-3.0.3.tgz",_where:"/home/zhangchongyang/code/hdWallet/trustnote-wallet/node_modules/bitcore-lib",author:{email:"fedor@indutny.com",name:"Fedor Indutny"},bugs:{url:"https://github.com/indutny/elliptic/issues"},dependencies:{"bn.js":"^2.0.0",brorand:"^1.0.1","hash.js":"^1.0.0",inherits:"^2.0.1"},description:"EC cryptography",devDependencies:{browserify:"^3.44.2",jscs:"^1.11.3",jshint:"^2.6.0",mocha:"^2.1.0","uglify-js":"^2.4.13"},homepage:"https://github.com/indutny/elliptic",keywords:["EC","Elliptic","curve","Cryptography"],license:"MIT",main:"lib/elliptic.js",name:"elliptic",optionalDependencies:{},readme:"# Elliptic [![Build Status](https://secure.travis-ci.org/indutny/elliptic.png)](http://travis-ci.org/indutny/elliptic)\n\nFast elliptic-curve cryptography in a plain javascript implementation.\n\nNOTE: Please take a look at http://safecurves.cr.yp.to/ before choosing a curve\nfor your cryptography operations.\n\n## Incentive\n\nECC is much slower than regular RSA cryptography, the JS implementations are\neven more slower.\n\n## Benchmarks\n\n```bash\n$ node benchmarks/index.js\nBenchmarking: sign\nelliptic#sign x 262 ops/sec 0.51% (177 runs sampled)\neccjs#sign x 55.91 ops/sec 0.90% (144 runs sampled)\n------------------------\nFastest is elliptic#sign\n========================\nBenchmarking: verify\nelliptic#verify x 113 ops/sec 0.50% (166 runs sampled)\neccjs#verify x 48.56 ops/sec 0.36% (125 runs sampled)\n------------------------\nFastest is elliptic#verify\n========================\nBenchmarking: gen\nelliptic#gen x 294 ops/sec 0.43% (176 runs sampled)\neccjs#gen x 62.25 ops/sec 0.63% (129 runs sampled)\n------------------------\nFastest is elliptic#gen\n========================\nBenchmarking: ecdh\nelliptic#ecdh x 136 ops/sec 0.85% (156 runs sampled)\n------------------------\nFastest is elliptic#ecdh\n========================\n```\n\n## API\n\n### ECDSA\n\n```javascript\nvar EC = require('elliptic').ec;\n\n// Create and initialize EC context\n// (better do it once and reuse it)\nvar ec = new EC('secp256k1');\n\n// Generate keys\nvar key = ec.genKeyPair();\n\n// Sign message (must be an array, or it'll be treated as a hex sequence)\nvar msg = [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ];\nvar signature = key.sign(msg);\n\n// Export DER encoded signature in Array\nvar derSign = signature.toDER();\n\n// Verify signature\nconsole.log(key.verify(msg, derSign));\n```\n\n### ECDH\n\n```javascript\n// Generate keys\nvar key1 = ec.genKeyPair();\nvar key2 = ec.genKeyPair();\n\nvar shared1 = key1.derive(key2.getPublic());\nvar shared2 = key2.derive(key1.getPublic());\n\nconsole.log('Both shared secrets are BN instances');\nconsole.log(shared1.toString(16));\nconsole.log(shared2.toString(16));\n```\n\nNOTE: `.derive()` returns a [BN][1] instance.\n\n## Supported curves\n\nElliptic.js support following curve types:\n\n* Short Weierstrass\n* Montgomery\n* Edwards\n* Twisted Edwards\n\nFollowing curve 'presets' are embedded into the library:\n\n* `secp256k1`\n* `p192`\n* `p224`\n* `p256`\n* `curve25519`\n* `ed25519`\n\nNOTE: That `curve25519` could not be used for ECDSA, use `ed25519` instead.\n\n### Implementation details\n\nECDSA is using deterministic `k` value generation as per [RFC6979][0]. Most of\nthe curve operations are performed on non-affine coordinates (either projective\nor extended), various windowing techniques are used for different cases.\n\nAll operations are performed in reduction context using [bn.js][1], hashing is\nprovided by [hash.js][2]\n\n### Related projects\n\n* [eccrypto][3]: isomorphic implementation of ECDSA, ECDH and ECIES for both\n  browserify and node (uses `elliptic` for browser and [secp256k1-node][4] for\n  node)\n\n#### LICENSE\n\nThis software is licensed under the MIT License.\n\nCopyright Fedor Indutny, 2014.\n\nPermission is hereby granted, free of charge, to any person obtaining a\ncopy of this software and associated documentation files (the\n\"Software\"), to deal in the Software without restriction, including\nwithout limitation the rights to use, copy, modify, merge, publish,\ndistribute, sublicense, and/or sell copies of the Software, and to permit\npersons to whom the Software is furnished to do so, subject to the\nfollowing conditions:\n\nThe above copyright notice and this permission notice shall be included\nin all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\nOR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\nMERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\nNO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\nDAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\nOTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\nUSE OR OTHER DEALINGS IN THE SOFTWARE.\n\n[0]: http://tools.ietf.org/html/rfc6979\n[1]: https://github.com/indutny/bn.js\n[2]: https://github.com/indutny/hash.js\n[3]: https://github.com/bitchan/eccrypto\n[4]: https://github.com/wanderer/secp256k1-node\n",readmeFilename:"README.md",repository:{type:"git",url:"git+ssh://git@github.com/indutny/elliptic.git"},scripts:{test:"make lint && mocha --reporter=spec test/*-test.js"},version:"3.0.3"}},{}],104:[function(require,module,exports){"function"==typeof Object.create?module.exports=function(ctor,superCtor){ctor.super_=superCtor,ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:!1,writable:!0,configurable:!0}})}:module.exports=function(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype,ctor.prototype=new TempCtor,ctor.prototype.constructor=ctor}},{}],105:[function(require,module,exports){(function(global){(function(){function baseCompareAscending(value,other){if(value!==other){var valIsNull=null===value,valIsUndef=value===undefined,valIsReflexive=value===value,othIsNull=null===other,othIsUndef=other===undefined,othIsReflexive=other===other;if(value>other&&!othIsNull||!valIsReflexive||valIsNull&&!othIsUndef&&othIsReflexive||valIsUndef&&othIsReflexive)return 1;if(value<other&&!valIsNull||!othIsReflexive||othIsNull&&!valIsUndef&&valIsReflexive||othIsUndef&&valIsReflexive)return-1}return 0}function baseFindIndex(array,predicate,fromRight){for(var length=array.length,index=fromRight?length:-1;fromRight?index--:++index<length;)if(predicate(array[index],index,array))return index;return-1}function baseIndexOf(array,value,fromIndex){if(value!==value)return indexOfNaN(array,fromIndex);for(var index=fromIndex-1,length=array.length;++index<length;)if(array[index]===value)return index;return-1}function baseIsFunction(value){return"function"==typeof value||!1}function baseToString(value){return null==value?"":value+""}function charsLeftIndex(string,chars){for(var index=-1,length=string.length;++index<length&&chars.indexOf(string.charAt(index))>-1;);return index}function charsRightIndex(string,chars){for(var index=string.length;index--&&chars.indexOf(string.charAt(index))>-1;);return index}function compareAscending(object,other){return baseCompareAscending(object.criteria,other.criteria)||object.index-other.index}function compareMultiple(object,other,orders){for(var index=-1,objCriteria=object.criteria,othCriteria=other.criteria,length=objCriteria.length,ordersLength=orders.length;++index<length;){var result=baseCompareAscending(objCriteria[index],othCriteria[index]);if(result){if(index>=ordersLength)return result;var order=orders[index];return result*("asc"===order||order===!0?1:-1)}}return object.index-other.index}function deburrLetter(letter){return deburredLetters[letter]}function escapeHtmlChar(chr){return htmlEscapes[chr]}function escapeRegExpChar(chr,leadingChar,whitespaceChar){return leadingChar?chr=regexpEscapes[chr]:whitespaceChar&&(chr=stringEscapes[chr]),"\\"+chr}function escapeStringChar(chr){return"\\"+stringEscapes[chr]}function indexOfNaN(array,fromIndex,fromRight){for(var length=array.length,index=fromIndex+(fromRight?0:-1);fromRight?index--:++index<length;){var other=array[index];if(other!==other)return index}return-1}function isObjectLike(value){return!!value&&"object"==typeof value}function isSpace(charCode){return charCode<=160&&charCode>=9&&charCode<=13||32==charCode||160==charCode||5760==charCode||6158==charCode||charCode>=8192&&(charCode<=8202||8232==charCode||8233==charCode||8239==charCode||8287==charCode||12288==charCode||65279==charCode)}function replaceHolders(array,placeholder){for(var index=-1,length=array.length,resIndex=-1,result=[];++index<length;)array[index]===placeholder&&(array[index]=PLACEHOLDER,result[++resIndex]=index);return result}function sortedUniq(array,iteratee){for(var seen,index=-1,length=array.length,resIndex=-1,result=[];++index<length;){var value=array[index],computed=iteratee?iteratee(value,index,array):value;index&&seen===computed||(seen=computed,result[++resIndex]=value)}return result}function trimmedLeftIndex(string){for(var index=-1,length=string.length;++index<length&&isSpace(string.charCodeAt(index)););return index}function trimmedRightIndex(string){for(var index=string.length;index--&&isSpace(string.charCodeAt(index)););return index}function unescapeHtmlChar(chr){return htmlUnescapes[chr]}function runInContext(context){function lodash(value){if(isObjectLike(value)&&!isArray(value)&&!(value instanceof LazyWrapper)){if(value instanceof LodashWrapper)return value;if(hasOwnProperty.call(value,"__chain__")&&hasOwnProperty.call(value,"__wrapped__"))return wrapperClone(value)}return new LodashWrapper(value)}function baseLodash(){}
function LodashWrapper(value,chainAll,actions){this.__wrapped__=value,this.__actions__=actions||[],this.__chain__=!!chainAll}function LazyWrapper(value){this.__wrapped__=value,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=POSITIVE_INFINITY,this.__views__=[]}function lazyClone(){var result=new LazyWrapper(this.__wrapped__);return result.__actions__=arrayCopy(this.__actions__),result.__dir__=this.__dir__,result.__filtered__=this.__filtered__,result.__iteratees__=arrayCopy(this.__iteratees__),result.__takeCount__=this.__takeCount__,result.__views__=arrayCopy(this.__views__),result}function lazyReverse(){if(this.__filtered__){var result=new LazyWrapper(this);result.__dir__=-1,result.__filtered__=!0}else result=this.clone(),result.__dir__*=-1;return result}function lazyValue(){var array=this.__wrapped__.value(),dir=this.__dir__,isArr=isArray(array),isRight=dir<0,arrLength=isArr?array.length:0,view=getView(0,arrLength,this.__views__),start=view.start,end=view.end,length=end-start,index=isRight?end:start-1,iteratees=this.__iteratees__,iterLength=iteratees.length,resIndex=0,takeCount=nativeMin(length,this.__takeCount__);if(!isArr||arrLength<LARGE_ARRAY_SIZE||arrLength==length&&takeCount==length)return baseWrapperValue(isRight&&isArr?array.reverse():array,this.__actions__);var result=[];outer:for(;length--&&resIndex<takeCount;){index+=dir;for(var iterIndex=-1,value=array[index];++iterIndex<iterLength;){var data=iteratees[iterIndex],iteratee=data.iteratee,type=data.type,computed=iteratee(value);if(type==LAZY_MAP_FLAG)value=computed;else if(!computed){if(type==LAZY_FILTER_FLAG)continue outer;break outer}}result[resIndex++]=value}return result}function MapCache(){this.__data__={}}function mapDelete(key){return this.has(key)&&delete this.__data__[key]}function mapGet(key){return"__proto__"==key?undefined:this.__data__[key]}function mapHas(key){return"__proto__"!=key&&hasOwnProperty.call(this.__data__,key)}function mapSet(key,value){return"__proto__"!=key&&(this.__data__[key]=value),this}function SetCache(values){var length=values?values.length:0;for(this.data={hash:nativeCreate(null),set:new Set};length--;)this.push(values[length])}function cacheIndexOf(cache,value){var data=cache.data,result="string"==typeof value||isObject(value)?data.set.has(value):data.hash[value];return result?0:-1}function cachePush(value){var data=this.data;"string"==typeof value||isObject(value)?data.set.add(value):data.hash[value]=!0}function arrayConcat(array,other){for(var index=-1,length=array.length,othIndex=-1,othLength=other.length,result=Array(length+othLength);++index<length;)result[index]=array[index];for(;++othIndex<othLength;)result[index++]=other[othIndex];return result}function arrayCopy(source,array){var index=-1,length=source.length;for(array||(array=Array(length));++index<length;)array[index]=source[index];return array}function arrayEach(array,iteratee){for(var index=-1,length=array.length;++index<length&&iteratee(array[index],index,array)!==!1;);return array}function arrayEachRight(array,iteratee){for(var length=array.length;length--&&iteratee(array[length],length,array)!==!1;);return array}function arrayEvery(array,predicate){for(var index=-1,length=array.length;++index<length;)if(!predicate(array[index],index,array))return!1;return!0}function arrayExtremum(array,iteratee,comparator,exValue){for(var index=-1,length=array.length,computed=exValue,result=computed;++index<length;){var value=array[index],current=+iteratee(value);comparator(current,computed)&&(computed=current,result=value)}return result}function arrayFilter(array,predicate){for(var index=-1,length=array.length,resIndex=-1,result=[];++index<length;){var value=array[index];predicate(value,index,array)&&(result[++resIndex]=value)}return result}function arrayMap(array,iteratee){for(var index=-1,length=array.length,result=Array(length);++index<length;)result[index]=iteratee(array[index],index,array);return result}function arrayPush(array,values){for(var index=-1,length=values.length,offset=array.length;++index<length;)array[offset+index]=values[index];return array}function arrayReduce(array,iteratee,accumulator,initFromArray){var index=-1,length=array.length;for(initFromArray&&length&&(accumulator=array[++index]);++index<length;)accumulator=iteratee(accumulator,array[index],index,array);return accumulator}function arrayReduceRight(array,iteratee,accumulator,initFromArray){var length=array.length;for(initFromArray&&length&&(accumulator=array[--length]);length--;)accumulator=iteratee(accumulator,array[length],length,array);return accumulator}function arraySome(array,predicate){for(var index=-1,length=array.length;++index<length;)if(predicate(array[index],index,array))return!0;return!1}function arraySum(array,iteratee){for(var length=array.length,result=0;length--;)result+=+iteratee(array[length])||0;return result}function assignDefaults(objectValue,sourceValue){return objectValue===undefined?sourceValue:objectValue}function assignOwnDefaults(objectValue,sourceValue,key,object){return objectValue!==undefined&&hasOwnProperty.call(object,key)?objectValue:sourceValue}function assignWith(object,source,customizer){for(var index=-1,props=keys(source),length=props.length;++index<length;){var key=props[index],value=object[key],result=customizer(value,source[key],key,object,source);(result===result?result===value:value!==value)&&(value!==undefined||key in object)||(object[key]=result)}return object}function baseAssign(object,source){return null==source?object:baseCopy(source,keys(source),object)}function baseAt(collection,props){for(var index=-1,isNil=null==collection,isArr=!isNil&&isArrayLike(collection),length=isArr?collection.length:0,propsLength=props.length,result=Array(propsLength);++index<propsLength;){var key=props[index];isArr?result[index]=isIndex(key,length)?collection[key]:undefined:result[index]=isNil?undefined:collection[key]}return result}function baseCopy(source,props,object){object||(object={});for(var index=-1,length=props.length;++index<length;){var key=props[index];object[key]=source[key]}return object}function baseCallback(func,thisArg,argCount){var type=typeof func;return"function"==type?thisArg===undefined?func:bindCallback(func,thisArg,argCount):null==func?identity:"object"==type?baseMatches(func):thisArg===undefined?property(func):baseMatchesProperty(func,thisArg)}function baseClone(value,isDeep,customizer,key,object,stackA,stackB){var result;if(customizer&&(result=object?customizer(value,key,object):customizer(value)),result!==undefined)return result;if(!isObject(value))return value;var isArr=isArray(value);if(isArr){if(result=initCloneArray(value),!isDeep)return arrayCopy(value,result)}else{var tag=objToString.call(value),isFunc=tag==funcTag;if(tag!=objectTag&&tag!=argsTag&&(!isFunc||object))return cloneableTags[tag]?initCloneByTag(value,tag,isDeep):object?value:{};if(result=initCloneObject(isFunc?{}:value),!isDeep)return baseAssign(result,value)}stackA||(stackA=[]),stackB||(stackB=[]);for(var length=stackA.length;length--;)if(stackA[length]==value)return stackB[length];return stackA.push(value),stackB.push(result),(isArr?arrayEach:baseForOwn)(value,function(subValue,key){result[key]=baseClone(subValue,isDeep,customizer,key,value,stackA,stackB)}),result}function baseDelay(func,wait,args){if("function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);return setTimeout(function(){func.apply(undefined,args)},wait)}function baseDifference(array,values){var length=array?array.length:0,result=[];if(!length)return result;var index=-1,indexOf=getIndexOf(),isCommon=indexOf==baseIndexOf,cache=isCommon&&values.length>=LARGE_ARRAY_SIZE?createCache(values):null,valuesLength=values.length;cache&&(indexOf=cacheIndexOf,isCommon=!1,values=cache);outer:for(;++index<length;){var value=array[index];if(isCommon&&value===value){for(var valuesIndex=valuesLength;valuesIndex--;)if(values[valuesIndex]===value)continue outer;result.push(value)}else indexOf(values,value,0)<0&&result.push(value)}return result}function baseEvery(collection,predicate){var result=!0;return baseEach(collection,function(value,index,collection){return result=!!predicate(value,index,collection)}),result}function baseExtremum(collection,iteratee,comparator,exValue){var computed=exValue,result=computed;return baseEach(collection,function(value,index,collection){var current=+iteratee(value,index,collection);(comparator(current,computed)||current===exValue&&current===result)&&(computed=current,result=value)}),result}function baseFill(array,value,start,end){var length=array.length;for(start=null==start?0:+start||0,start<0&&(start=-start>length?0:length+start),end=end===undefined||end>length?length:+end||0,end<0&&(end+=length),length=start>end?0:end>>>0,start>>>=0;start<length;)array[start++]=value;return array}function baseFilter(collection,predicate){var result=[];return baseEach(collection,function(value,index,collection){predicate(value,index,collection)&&result.push(value)}),result}function baseFind(collection,predicate,eachFunc,retKey){var result;return eachFunc(collection,function(value,key,collection){if(predicate(value,key,collection))return result=retKey?key:value,!1}),result}function baseFlatten(array,isDeep,isStrict,result){result||(result=[]);for(var index=-1,length=array.length;++index<length;){var value=array[index];isObjectLike(value)&&isArrayLike(value)&&(isStrict||isArray(value)||isArguments(value))?isDeep?baseFlatten(value,isDeep,isStrict,result):arrayPush(result,value):isStrict||(result[result.length]=value)}return result}function baseForIn(object,iteratee){return baseFor(object,iteratee,keysIn)}function baseForOwn(object,iteratee){return baseFor(object,iteratee,keys)}function baseForOwnRight(object,iteratee){return baseForRight(object,iteratee,keys)}function baseFunctions(object,props){for(var index=-1,length=props.length,resIndex=-1,result=[];++index<length;){var key=props[index];isFunction(object[key])&&(result[++resIndex]=key)}return result}function baseGet(object,path,pathKey){if(null!=object){pathKey!==undefined&&pathKey in toObject(object)&&(path=[pathKey]);for(var index=0,length=path.length;null!=object&&index<length;)object=object[path[index++]];return index&&index==length?object:undefined}}function baseIsEqual(value,other,customizer,isLoose,stackA,stackB){return value===other||(null==value||null==other||!isObject(value)&&!isObjectLike(other)?value!==value&&other!==other:baseIsEqualDeep(value,other,baseIsEqual,customizer,isLoose,stackA,stackB))}function baseIsEqualDeep(object,other,equalFunc,customizer,isLoose,stackA,stackB){var objIsArr=isArray(object),othIsArr=isArray(other),objTag=arrayTag,othTag=arrayTag;objIsArr||(objTag=objToString.call(object),objTag==argsTag?objTag=objectTag:objTag!=objectTag&&(objIsArr=isTypedArray(object))),othIsArr||(othTag=objToString.call(other),othTag==argsTag?othTag=objectTag:othTag!=objectTag&&(othIsArr=isTypedArray(other)));var objIsObj=objTag==objectTag,othIsObj=othTag==objectTag,isSameTag=objTag==othTag;if(isSameTag&&!objIsArr&&!objIsObj)return equalByTag(object,other,objTag);if(!isLoose){var objIsWrapped=objIsObj&&hasOwnProperty.call(object,"__wrapped__"),othIsWrapped=othIsObj&&hasOwnProperty.call(other,"__wrapped__");if(objIsWrapped||othIsWrapped)return equalFunc(objIsWrapped?object.value():object,othIsWrapped?other.value():other,customizer,isLoose,stackA,stackB)}if(!isSameTag)return!1;stackA||(stackA=[]),stackB||(stackB=[]);for(var length=stackA.length;length--;)if(stackA[length]==object)return stackB[length]==other;stackA.push(object),stackB.push(other);var result=(objIsArr?equalArrays:equalObjects)(object,other,equalFunc,customizer,isLoose,stackA,stackB);return stackA.pop(),stackB.pop(),result}function baseIsMatch(object,matchData,customizer){var index=matchData.length,length=index,noCustomizer=!customizer;if(null==object)return!length;for(object=toObject(object);index--;){var data=matchData[index];if(noCustomizer&&data[2]?data[1]!==object[data[0]]:!(data[0]in object))return!1}for(;++index<length;){data=matchData[index];var key=data[0],objValue=object[key],srcValue=data[1];if(noCustomizer&&data[2]){if(objValue===undefined&&!(key in object))return!1}else{var result=customizer?customizer(objValue,srcValue,key):undefined;if(!(result===undefined?baseIsEqual(srcValue,objValue,customizer,!0):result))return!1}}return!0}function baseMap(collection,iteratee){var index=-1,result=isArrayLike(collection)?Array(collection.length):[];return baseEach(collection,function(value,key,collection){result[++index]=iteratee(value,key,collection)}),result}function baseMatches(source){var matchData=getMatchData(source);if(1==matchData.length&&matchData[0][2]){var key=matchData[0][0],value=matchData[0][1];return function(object){return null!=object&&(object[key]===value&&(value!==undefined||key in toObject(object)))}}return function(object){return baseIsMatch(object,matchData)}}function baseMatchesProperty(path,srcValue){var isArr=isArray(path),isCommon=isKey(path)&&isStrictComparable(srcValue),pathKey=path+"";return path=toPath(path),function(object){if(null==object)return!1;var key=pathKey;if(object=toObject(object),(isArr||!isCommon)&&!(key in object)){if(object=1==path.length?object:baseGet(object,baseSlice(path,0,-1)),null==object)return!1;key=last(path),object=toObject(object)}return object[key]===srcValue?srcValue!==undefined||key in object:baseIsEqual(srcValue,object[key],undefined,!0)}}function baseMerge(object,source,customizer,stackA,stackB){if(!isObject(object))return object;var isSrcArr=isArrayLike(source)&&(isArray(source)||isTypedArray(source)),props=isSrcArr?undefined:keys(source);return arrayEach(props||source,function(srcValue,key){if(props&&(key=srcValue,srcValue=source[key]),isObjectLike(srcValue))stackA||(stackA=[]),stackB||(stackB=[]),baseMergeDeep(object,source,key,baseMerge,customizer,stackA,stackB);else{var value=object[key],result=customizer?customizer(value,srcValue,key,object,source):undefined,isCommon=result===undefined;isCommon&&(result=srcValue),result===undefined&&(!isSrcArr||key in object)||!isCommon&&(result===result?result===value:value!==value)||(object[key]=result)}}),object}function baseMergeDeep(object,source,key,mergeFunc,customizer,stackA,stackB){for(var length=stackA.length,srcValue=source[key];length--;)if(stackA[length]==srcValue)return void(object[key]=stackB[length]);var value=object[key],result=customizer?customizer(value,srcValue,key,object,source):undefined,isCommon=result===undefined;isCommon&&(result=srcValue,isArrayLike(srcValue)&&(isArray(srcValue)||isTypedArray(srcValue))?result=isArray(value)?value:isArrayLike(value)?arrayCopy(value):[]:isPlainObject(srcValue)||isArguments(srcValue)?result=isArguments(value)?toPlainObject(value):isPlainObject(value)?value:{}:isCommon=!1),stackA.push(srcValue),stackB.push(result),isCommon?object[key]=mergeFunc(result,srcValue,customizer,stackA,stackB):(result===result?result!==value:value===value)&&(object[key]=result)}function baseProperty(key){return function(object){return null==object?undefined:object[key]}}function basePropertyDeep(path){var pathKey=path+"";return path=toPath(path),function(object){return baseGet(object,path,pathKey)}}function basePullAt(array,indexes){for(var length=array?indexes.length:0;length--;){var index=indexes[length];if(index!=previous&&isIndex(index)){var previous=index;splice.call(array,index,1)}}return array}function baseRandom(min,max){return min+nativeFloor(nativeRandom()*(max-min+1))}function baseReduce(collection,iteratee,accumulator,initFromCollection,eachFunc){return eachFunc(collection,function(value,index,collection){accumulator=initFromCollection?(initFromCollection=!1,value):iteratee(accumulator,value,index,collection)}),accumulator}function baseSlice(array,start,end){var index=-1,length=array.length;start=null==start?0:+start||0,start<0&&(start=-start>length?0:length+start),end=end===undefined||end>length?length:+end||0,end<0&&(end+=length),length=start>end?0:end-start>>>0,start>>>=0;for(var result=Array(length);++index<length;)result[index]=array[index+start];return result}function baseSome(collection,predicate){var result;return baseEach(collection,function(value,index,collection){return result=predicate(value,index,collection),!result}),!!result}function baseSortBy(array,comparer){var length=array.length;for(array.sort(comparer);length--;)array[length]=array[length].value;return array}function baseSortByOrder(collection,iteratees,orders){var callback=getCallback(),index=-1;iteratees=arrayMap(iteratees,function(iteratee){return callback(iteratee)});var result=baseMap(collection,function(value){var criteria=arrayMap(iteratees,function(iteratee){return iteratee(value)});return{criteria:criteria,index:++index,value:value}});return baseSortBy(result,function(object,other){return compareMultiple(object,other,orders)})}function baseSum(collection,iteratee){var result=0;return baseEach(collection,function(value,index,collection){result+=+iteratee(value,index,collection)||0}),result}function baseUniq(array,iteratee){var index=-1,indexOf=getIndexOf(),length=array.length,isCommon=indexOf==baseIndexOf,isLarge=isCommon&&length>=LARGE_ARRAY_SIZE,seen=isLarge?createCache():null,result=[];seen?(indexOf=cacheIndexOf,isCommon=!1):(isLarge=!1,seen=iteratee?[]:result);outer:for(;++index<length;){var value=array[index],computed=iteratee?iteratee(value,index,array):value;if(isCommon&&value===value){for(var seenIndex=seen.length;seenIndex--;)if(seen[seenIndex]===computed)continue outer;iteratee&&seen.push(computed),result.push(value)}else indexOf(seen,computed,0)<0&&((iteratee||isLarge)&&seen.push(computed),result.push(value))}return result}function baseValues(object,props){for(var index=-1,length=props.length,result=Array(length);++index<length;)result[index]=object[props[index]];return result}function baseWhile(array,predicate,isDrop,fromRight){for(var length=array.length,index=fromRight?length:-1;(fromRight?index--:++index<length)&&predicate(array[index],index,array););return isDrop?baseSlice(array,fromRight?0:index,fromRight?index+1:length):baseSlice(array,fromRight?index+1:0,fromRight?length:index)}function baseWrapperValue(value,actions){var result=value;result instanceof LazyWrapper&&(result=result.value());for(var index=-1,length=actions.length;++index<length;){var action=actions[index];result=action.func.apply(action.thisArg,arrayPush([result],action.args))}return result}function binaryIndex(array,value,retHighest){var low=0,high=array?array.length:low;if("number"==typeof value&&value===value&&high<=HALF_MAX_ARRAY_LENGTH){for(;low<high;){var mid=low+high>>>1,computed=array[mid];(retHighest?computed<=value:computed<value)&&null!==computed?low=mid+1:high=mid}return high}return binaryIndexBy(array,value,identity,retHighest)}function binaryIndexBy(array,value,iteratee,retHighest){value=iteratee(value);for(var low=0,high=array?array.length:0,valIsNaN=value!==value,valIsNull=null===value,valIsUndef=value===undefined;low<high;){var mid=nativeFloor((low+high)/2),computed=iteratee(array[mid]),isDef=computed!==undefined,isReflexive=computed===computed;if(valIsNaN)var setLow=isReflexive||retHighest;else setLow=valIsNull?isReflexive&&isDef&&(retHighest||null!=computed):valIsUndef?isReflexive&&(retHighest||isDef):null!=computed&&(retHighest?computed<=value:computed<value);setLow?low=mid+1:high=mid}return nativeMin(high,MAX_ARRAY_INDEX)}function bindCallback(func,thisArg,argCount){if("function"!=typeof func)return identity;if(thisArg===undefined)return func;switch(argCount){case 1:return function(value){return func.call(thisArg,value)};case 3:return function(value,index,collection){return func.call(thisArg,value,index,collection)};case 4:return function(accumulator,value,index,collection){return func.call(thisArg,accumulator,value,index,collection)};case 5:return function(value,other,key,object,source){return func.call(thisArg,value,other,key,object,source)}}return function(){return func.apply(thisArg,arguments)}}function bufferClone(buffer){var result=new ArrayBuffer(buffer.byteLength),view=new Uint8Array(result);return view.set(new Uint8Array(buffer)),result}function composeArgs(args,partials,holders){for(var holdersLength=holders.length,argsIndex=-1,argsLength=nativeMax(args.length-holdersLength,0),leftIndex=-1,leftLength=partials.length,result=Array(leftLength+argsLength);++leftIndex<leftLength;)result[leftIndex]=partials[leftIndex];for(;++argsIndex<holdersLength;)result[holders[argsIndex]]=args[argsIndex];for(;argsLength--;)result[leftIndex++]=args[argsIndex++];return result}function composeArgsRight(args,partials,holders){for(var holdersIndex=-1,holdersLength=holders.length,argsIndex=-1,argsLength=nativeMax(args.length-holdersLength,0),rightIndex=-1,rightLength=partials.length,result=Array(argsLength+rightLength);++argsIndex<argsLength;)result[argsIndex]=args[argsIndex];for(var offset=argsIndex;++rightIndex<rightLength;)result[offset+rightIndex]=partials[rightIndex];for(;++holdersIndex<holdersLength;)result[offset+holders[holdersIndex]]=args[argsIndex++];return result}function createAggregator(setter,initializer){return function(collection,iteratee,thisArg){var result=initializer?initializer():{};if(iteratee=getCallback(iteratee,thisArg,3),isArray(collection))for(var index=-1,length=collection.length;++index<length;){var value=collection[index];setter(result,value,iteratee(value,index,collection),collection)}else baseEach(collection,function(value,key,collection){setter(result,value,iteratee(value,key,collection),collection)});return result}}function createAssigner(assigner){return restParam(function(object,sources){var index=-1,length=null==object?0:sources.length,customizer=length>2?sources[length-2]:undefined,guard=length>2?sources[2]:undefined,thisArg=length>1?sources[length-1]:undefined;for("function"==typeof customizer?(customizer=bindCallback(customizer,thisArg,5),length-=2):(customizer="function"==typeof thisArg?thisArg:undefined,length-=customizer?1:0),guard&&isIterateeCall(sources[0],sources[1],guard)&&(customizer=length<3?undefined:customizer,length=1);++index<length;){var source=sources[index];source&&assigner(object,source,customizer)}return object})}function createBaseEach(eachFunc,fromRight){return function(collection,iteratee){var length=collection?getLength(collection):0;if(!isLength(length))return eachFunc(collection,iteratee);for(var index=fromRight?length:-1,iterable=toObject(collection);(fromRight?index--:++index<length)&&iteratee(iterable[index],index,iterable)!==!1;);return collection}}function createBaseFor(fromRight){return function(object,iteratee,keysFunc){for(var iterable=toObject(object),props=keysFunc(object),length=props.length,index=fromRight?length:-1;fromRight?index--:++index<length;){var key=props[index];if(iteratee(iterable[key],key,iterable)===!1)break}return object}}function createBindWrapper(func,thisArg){function wrapper(){var fn=this&&this!==root&&this instanceof wrapper?Ctor:func;return fn.apply(thisArg,arguments)}var Ctor=createCtorWrapper(func);return wrapper}function createCache(values){return nativeCreate&&Set?new SetCache(values):null}function createCompounder(callback){return function(string){for(var index=-1,array=words(deburr(string)),length=array.length,result="";++index<length;)result=callback(result,array[index],index);return result}}function createCtorWrapper(Ctor){return function(){var args=arguments;switch(args.length){case 0:return new Ctor;case 1:return new Ctor(args[0]);case 2:return new Ctor(args[0],args[1]);case 3:return new Ctor(args[0],args[1],args[2]);case 4:return new Ctor(args[0],args[1],args[2],args[3]);case 5:return new Ctor(args[0],args[1],args[2],args[3],args[4]);case 6:return new Ctor(args[0],args[1],args[2],args[3],args[4],args[5]);case 7:return new Ctor(args[0],args[1],args[2],args[3],args[4],args[5],args[6])}var thisBinding=baseCreate(Ctor.prototype),result=Ctor.apply(thisBinding,args);return isObject(result)?result:thisBinding}}function createCurry(flag){function curryFunc(func,arity,guard){guard&&isIterateeCall(func,arity,guard)&&(arity=undefined);var result=createWrapper(func,flag,undefined,undefined,undefined,undefined,undefined,arity);return result.placeholder=curryFunc.placeholder,result}return curryFunc}function createDefaults(assigner,customizer){return restParam(function(args){var object=args[0];return null==object?object:(args.push(customizer),assigner.apply(undefined,args))})}function createExtremum(comparator,exValue){return function(collection,iteratee,thisArg){if(thisArg&&isIterateeCall(collection,iteratee,thisArg)&&(iteratee=undefined),iteratee=getCallback(iteratee,thisArg,3),1==iteratee.length){collection=isArray(collection)?collection:toIterable(collection);var result=arrayExtremum(collection,iteratee,comparator,exValue);if(!collection.length||result!==exValue)return result}return baseExtremum(collection,iteratee,comparator,exValue)}}function createFind(eachFunc,fromRight){return function(collection,predicate,thisArg){if(predicate=getCallback(predicate,thisArg,3),isArray(collection)){var index=baseFindIndex(collection,predicate,fromRight);return index>-1?collection[index]:undefined}return baseFind(collection,predicate,eachFunc)}}function createFindIndex(fromRight){return function(array,predicate,thisArg){return array&&array.length?(predicate=getCallback(predicate,thisArg,3),baseFindIndex(array,predicate,fromRight)):-1}}function createFindKey(objectFunc){return function(object,predicate,thisArg){return predicate=getCallback(predicate,thisArg,3),baseFind(object,predicate,objectFunc,!0)}}function createFlow(fromRight){return function(){for(var wrapper,length=arguments.length,index=fromRight?length:-1,leftIndex=0,funcs=Array(length);fromRight?index--:++index<length;){var func=funcs[leftIndex++]=arguments[index];if("function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);!wrapper&&LodashWrapper.prototype.thru&&"wrapper"==getFuncName(func)&&(wrapper=new LodashWrapper([],(!0)))}for(index=wrapper?-1:length;++index<length;){func=funcs[index];var funcName=getFuncName(func),data="wrapper"==funcName?getData(func):undefined;wrapper=data&&isLaziable(data[0])&&data[1]==(ARY_FLAG|CURRY_FLAG|PARTIAL_FLAG|REARG_FLAG)&&!data[4].length&&1==data[9]?wrapper[getFuncName(data[0])].apply(wrapper,data[3]):1==func.length&&isLaziable(func)?wrapper[funcName]():wrapper.thru(func)}return function(){var args=arguments,value=args[0];if(wrapper&&1==args.length&&isArray(value)&&value.length>=LARGE_ARRAY_SIZE)return wrapper.plant(value).value();for(var index=0,result=length?funcs[index].apply(this,args):value;++index<length;)result=funcs[index].call(this,result);return result}}}function createForEach(arrayFunc,eachFunc){return function(collection,iteratee,thisArg){return"function"==typeof iteratee&&thisArg===undefined&&isArray(collection)?arrayFunc(collection,iteratee):eachFunc(collection,bindCallback(iteratee,thisArg,3))}}function createForIn(objectFunc){return function(object,iteratee,thisArg){return"function"==typeof iteratee&&thisArg===undefined||(iteratee=bindCallback(iteratee,thisArg,3)),objectFunc(object,iteratee,keysIn)}}function createForOwn(objectFunc){return function(object,iteratee,thisArg){return"function"==typeof iteratee&&thisArg===undefined||(iteratee=bindCallback(iteratee,thisArg,3)),objectFunc(object,iteratee)}}function createObjectMapper(isMapKeys){return function(object,iteratee,thisArg){var result={};return iteratee=getCallback(iteratee,thisArg,3),baseForOwn(object,function(value,key,object){var mapped=iteratee(value,key,object);key=isMapKeys?mapped:key,value=isMapKeys?value:mapped,result[key]=value}),result}}function createPadDir(fromRight){return function(string,length,chars){return string=baseToString(string),(fromRight?string:"")+createPadding(string,length,chars)+(fromRight?"":string)}}function createPartial(flag){var partialFunc=restParam(function(func,partials){var holders=replaceHolders(partials,partialFunc.placeholder);return createWrapper(func,flag,undefined,partials,holders)});return partialFunc}function createReduce(arrayFunc,eachFunc){return function(collection,iteratee,accumulator,thisArg){var initFromArray=arguments.length<3;return"function"==typeof iteratee&&thisArg===undefined&&isArray(collection)?arrayFunc(collection,iteratee,accumulator,initFromArray):baseReduce(collection,getCallback(iteratee,thisArg,4),accumulator,initFromArray,eachFunc)}}function createHybridWrapper(func,bitmask,thisArg,partials,holders,partialsRight,holdersRight,argPos,ary,arity){function wrapper(){for(var length=arguments.length,index=length,args=Array(length);index--;)args[index]=arguments[index];if(partials&&(args=composeArgs(args,partials,holders)),partialsRight&&(args=composeArgsRight(args,partialsRight,holdersRight)),isCurry||isCurryRight){var placeholder=wrapper.placeholder,argsHolders=replaceHolders(args,placeholder);if(length-=argsHolders.length,length<arity){var newArgPos=argPos?arrayCopy(argPos):undefined,newArity=nativeMax(arity-length,0),newsHolders=isCurry?argsHolders:undefined,newHoldersRight=isCurry?undefined:argsHolders,newPartials=isCurry?args:undefined,newPartialsRight=isCurry?undefined:args;bitmask|=isCurry?PARTIAL_FLAG:PARTIAL_RIGHT_FLAG,bitmask&=~(isCurry?PARTIAL_RIGHT_FLAG:PARTIAL_FLAG),isCurryBound||(bitmask&=~(BIND_FLAG|BIND_KEY_FLAG));var newData=[func,bitmask,thisArg,newPartials,newsHolders,newPartialsRight,newHoldersRight,newArgPos,ary,newArity],result=createHybridWrapper.apply(undefined,newData);return isLaziable(func)&&setData(result,newData),result.placeholder=placeholder,result}}var thisBinding=isBind?thisArg:this,fn=isBindKey?thisBinding[func]:func;return argPos&&(args=reorder(args,argPos)),isAry&&ary<args.length&&(args.length=ary),this&&this!==root&&this instanceof wrapper&&(fn=Ctor||createCtorWrapper(func)),fn.apply(thisBinding,args)}var isAry=bitmask&ARY_FLAG,isBind=bitmask&BIND_FLAG,isBindKey=bitmask&BIND_KEY_FLAG,isCurry=bitmask&CURRY_FLAG,isCurryBound=bitmask&CURRY_BOUND_FLAG,isCurryRight=bitmask&CURRY_RIGHT_FLAG,Ctor=isBindKey?undefined:createCtorWrapper(func);return wrapper}function createPadding(string,length,chars){var strLength=string.length;if(length=+length,strLength>=length||!nativeIsFinite(length))return"";var padLength=length-strLength;return chars=null==chars?" ":chars+"",repeat(chars,nativeCeil(padLength/chars.length)).slice(0,padLength)}function createPartialWrapper(func,bitmask,thisArg,partials){function wrapper(){for(var argsIndex=-1,argsLength=arguments.length,leftIndex=-1,leftLength=partials.length,args=Array(leftLength+argsLength);++leftIndex<leftLength;)args[leftIndex]=partials[leftIndex];for(;argsLength--;)args[leftIndex++]=arguments[++argsIndex];var fn=this&&this!==root&&this instanceof wrapper?Ctor:func;return fn.apply(isBind?thisArg:this,args)}var isBind=bitmask&BIND_FLAG,Ctor=createCtorWrapper(func);return wrapper}function createRound(methodName){var func=Math[methodName];return function(number,precision){return precision=precision===undefined?0:+precision||0,precision?(precision=pow(10,precision),func(number*precision)/precision):func(number)}}function createSortedIndex(retHighest){return function(array,value,iteratee,thisArg){var callback=getCallback(iteratee);return null==iteratee&&callback===baseCallback?binaryIndex(array,value,retHighest):binaryIndexBy(array,value,callback(iteratee,thisArg,1),retHighest)}}function createWrapper(func,bitmask,thisArg,partials,holders,argPos,ary,arity){var isBindKey=bitmask&BIND_KEY_FLAG;if(!isBindKey&&"function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);var length=partials?partials.length:0;if(length||(bitmask&=~(PARTIAL_FLAG|PARTIAL_RIGHT_FLAG),partials=holders=undefined),length-=holders?holders.length:0,bitmask&PARTIAL_RIGHT_FLAG){var partialsRight=partials,holdersRight=holders;partials=holders=undefined}var data=isBindKey?undefined:getData(func),newData=[func,bitmask,thisArg,partials,holders,partialsRight,holdersRight,argPos,ary,arity];if(data&&(mergeData(newData,data),bitmask=newData[1],arity=newData[9]),
newData[9]=null==arity?isBindKey?0:func.length:nativeMax(arity-length,0)||0,bitmask==BIND_FLAG)var result=createBindWrapper(newData[0],newData[2]);else result=bitmask!=PARTIAL_FLAG&&bitmask!=(BIND_FLAG|PARTIAL_FLAG)||newData[4].length?createHybridWrapper.apply(undefined,newData):createPartialWrapper.apply(undefined,newData);var setter=data?baseSetData:setData;return setter(result,newData)}function equalArrays(array,other,equalFunc,customizer,isLoose,stackA,stackB){var index=-1,arrLength=array.length,othLength=other.length;if(arrLength!=othLength&&!(isLoose&&othLength>arrLength))return!1;for(;++index<arrLength;){var arrValue=array[index],othValue=other[index],result=customizer?customizer(isLoose?othValue:arrValue,isLoose?arrValue:othValue,index):undefined;if(result!==undefined){if(result)continue;return!1}if(isLoose){if(!arraySome(other,function(othValue){return arrValue===othValue||equalFunc(arrValue,othValue,customizer,isLoose,stackA,stackB)}))return!1}else if(arrValue!==othValue&&!equalFunc(arrValue,othValue,customizer,isLoose,stackA,stackB))return!1}return!0}function equalByTag(object,other,tag){switch(tag){case boolTag:case dateTag:return+object==+other;case errorTag:return object.name==other.name&&object.message==other.message;case numberTag:return object!=+object?other!=+other:object==+other;case regexpTag:case stringTag:return object==other+""}return!1}function equalObjects(object,other,equalFunc,customizer,isLoose,stackA,stackB){var objProps=keys(object),objLength=objProps.length,othProps=keys(other),othLength=othProps.length;if(objLength!=othLength&&!isLoose)return!1;for(var index=objLength;index--;){var key=objProps[index];if(!(isLoose?key in other:hasOwnProperty.call(other,key)))return!1}for(var skipCtor=isLoose;++index<objLength;){key=objProps[index];var objValue=object[key],othValue=other[key],result=customizer?customizer(isLoose?othValue:objValue,isLoose?objValue:othValue,key):undefined;if(!(result===undefined?equalFunc(objValue,othValue,customizer,isLoose,stackA,stackB):result))return!1;skipCtor||(skipCtor="constructor"==key)}if(!skipCtor){var objCtor=object.constructor,othCtor=other.constructor;if(objCtor!=othCtor&&"constructor"in object&&"constructor"in other&&!("function"==typeof objCtor&&objCtor instanceof objCtor&&"function"==typeof othCtor&&othCtor instanceof othCtor))return!1}return!0}function getCallback(func,thisArg,argCount){var result=lodash.callback||callback;return result=result===callback?baseCallback:result,argCount?result(func,thisArg,argCount):result}function getFuncName(func){for(var result=func.name,array=realNames[result],length=array?array.length:0;length--;){var data=array[length],otherFunc=data.func;if(null==otherFunc||otherFunc==func)return data.name}return result}function getIndexOf(collection,target,fromIndex){var result=lodash.indexOf||indexOf;return result=result===indexOf?baseIndexOf:result,collection?result(collection,target,fromIndex):result}function getMatchData(object){for(var result=pairs(object),length=result.length;length--;)result[length][2]=isStrictComparable(result[length][1]);return result}function getNative(object,key){var value=null==object?undefined:object[key];return isNative(value)?value:undefined}function getView(start,end,transforms){for(var index=-1,length=transforms.length;++index<length;){var data=transforms[index],size=data.size;switch(data.type){case"drop":start+=size;break;case"dropRight":end-=size;break;case"take":end=nativeMin(end,start+size);break;case"takeRight":start=nativeMax(start,end-size)}}return{start:start,end:end}}function initCloneArray(array){var length=array.length,result=new array.constructor(length);return length&&"string"==typeof array[0]&&hasOwnProperty.call(array,"index")&&(result.index=array.index,result.input=array.input),result}function initCloneObject(object){var Ctor=object.constructor;return"function"==typeof Ctor&&Ctor instanceof Ctor||(Ctor=Object),new Ctor}function initCloneByTag(object,tag,isDeep){var Ctor=object.constructor;switch(tag){case arrayBufferTag:return bufferClone(object);case boolTag:case dateTag:return new Ctor((+object));case float32Tag:case float64Tag:case int8Tag:case int16Tag:case int32Tag:case uint8Tag:case uint8ClampedTag:case uint16Tag:case uint32Tag:var buffer=object.buffer;return new Ctor(isDeep?bufferClone(buffer):buffer,object.byteOffset,object.length);case numberTag:case stringTag:return new Ctor(object);case regexpTag:var result=new Ctor(object.source,reFlags.exec(object));result.lastIndex=object.lastIndex}return result}function invokePath(object,path,args){null==object||isKey(path,object)||(path=toPath(path),object=1==path.length?object:baseGet(object,baseSlice(path,0,-1)),path=last(path));var func=null==object?object:object[path];return null==func?undefined:func.apply(object,args)}function isArrayLike(value){return null!=value&&isLength(getLength(value))}function isIndex(value,length){return value="number"==typeof value||reIsUint.test(value)?+value:-1,length=null==length?MAX_SAFE_INTEGER:length,value>-1&&value%1==0&&value<length}function isIterateeCall(value,index,object){if(!isObject(object))return!1;var type=typeof index;if("number"==type?isArrayLike(object)&&isIndex(index,object.length):"string"==type&&index in object){var other=object[index];return value===value?value===other:other!==other}return!1}function isKey(value,object){var type=typeof value;if("string"==type&&reIsPlainProp.test(value)||"number"==type)return!0;if(isArray(value))return!1;var result=!reIsDeepProp.test(value);return result||null!=object&&value in toObject(object)}function isLaziable(func){var funcName=getFuncName(func);if(!(funcName in LazyWrapper.prototype))return!1;var other=lodash[funcName];if(func===other)return!0;var data=getData(other);return!!data&&func===data[0]}function isLength(value){return"number"==typeof value&&value>-1&&value%1==0&&value<=MAX_SAFE_INTEGER}function isStrictComparable(value){return value===value&&!isObject(value)}function mergeData(data,source){var bitmask=data[1],srcBitmask=source[1],newBitmask=bitmask|srcBitmask,isCommon=newBitmask<ARY_FLAG,isCombo=srcBitmask==ARY_FLAG&&bitmask==CURRY_FLAG||srcBitmask==ARY_FLAG&&bitmask==REARG_FLAG&&data[7].length<=source[8]||srcBitmask==(ARY_FLAG|REARG_FLAG)&&bitmask==CURRY_FLAG;if(!isCommon&&!isCombo)return data;srcBitmask&BIND_FLAG&&(data[2]=source[2],newBitmask|=bitmask&BIND_FLAG?0:CURRY_BOUND_FLAG);var value=source[3];if(value){var partials=data[3];data[3]=partials?composeArgs(partials,value,source[4]):arrayCopy(value),data[4]=partials?replaceHolders(data[3],PLACEHOLDER):arrayCopy(source[4])}return value=source[5],value&&(partials=data[5],data[5]=partials?composeArgsRight(partials,value,source[6]):arrayCopy(value),data[6]=partials?replaceHolders(data[5],PLACEHOLDER):arrayCopy(source[6])),value=source[7],value&&(data[7]=arrayCopy(value)),srcBitmask&ARY_FLAG&&(data[8]=null==data[8]?source[8]:nativeMin(data[8],source[8])),null==data[9]&&(data[9]=source[9]),data[0]=source[0],data[1]=newBitmask,data}function mergeDefaults(objectValue,sourceValue){return objectValue===undefined?sourceValue:merge(objectValue,sourceValue,mergeDefaults)}function pickByArray(object,props){object=toObject(object);for(var index=-1,length=props.length,result={};++index<length;){var key=props[index];key in object&&(result[key]=object[key])}return result}function pickByCallback(object,predicate){var result={};return baseForIn(object,function(value,key,object){predicate(value,key,object)&&(result[key]=value)}),result}function reorder(array,indexes){for(var arrLength=array.length,length=nativeMin(indexes.length,arrLength),oldArray=arrayCopy(array);length--;){var index=indexes[length];array[length]=isIndex(index,arrLength)?oldArray[index]:undefined}return array}function shimKeys(object){for(var props=keysIn(object),propsLength=props.length,length=propsLength&&object.length,allowIndexes=!!length&&isLength(length)&&(isArray(object)||isArguments(object)),index=-1,result=[];++index<propsLength;){var key=props[index];(allowIndexes&&isIndex(key,length)||hasOwnProperty.call(object,key))&&result.push(key)}return result}function toIterable(value){return null==value?[]:isArrayLike(value)?isObject(value)?value:Object(value):values(value)}function toObject(value){return isObject(value)?value:Object(value)}function toPath(value){if(isArray(value))return value;var result=[];return baseToString(value).replace(rePropName,function(match,number,quote,string){result.push(quote?string.replace(reEscapeChar,"$1"):number||match)}),result}function wrapperClone(wrapper){return wrapper instanceof LazyWrapper?wrapper.clone():new LodashWrapper(wrapper.__wrapped__,wrapper.__chain__,arrayCopy(wrapper.__actions__))}function chunk(array,size,guard){size=(guard?isIterateeCall(array,size,guard):null==size)?1:nativeMax(nativeFloor(size)||1,1);for(var index=0,length=array?array.length:0,resIndex=-1,result=Array(nativeCeil(length/size));index<length;)result[++resIndex]=baseSlice(array,index,index+=size);return result}function compact(array){for(var index=-1,length=array?array.length:0,resIndex=-1,result=[];++index<length;){var value=array[index];value&&(result[++resIndex]=value)}return result}function drop(array,n,guard){var length=array?array.length:0;return length?((guard?isIterateeCall(array,n,guard):null==n)&&(n=1),baseSlice(array,n<0?0:n)):[]}function dropRight(array,n,guard){var length=array?array.length:0;return length?((guard?isIterateeCall(array,n,guard):null==n)&&(n=1),n=length-(+n||0),baseSlice(array,0,n<0?0:n)):[]}function dropRightWhile(array,predicate,thisArg){return array&&array.length?baseWhile(array,getCallback(predicate,thisArg,3),!0,!0):[]}function dropWhile(array,predicate,thisArg){return array&&array.length?baseWhile(array,getCallback(predicate,thisArg,3),!0):[]}function fill(array,value,start,end){var length=array?array.length:0;return length?(start&&"number"!=typeof start&&isIterateeCall(array,value,start)&&(start=0,end=length),baseFill(array,value,start,end)):[]}function first(array){return array?array[0]:undefined}function flatten(array,isDeep,guard){var length=array?array.length:0;return guard&&isIterateeCall(array,isDeep,guard)&&(isDeep=!1),length?baseFlatten(array,isDeep):[]}function flattenDeep(array){var length=array?array.length:0;return length?baseFlatten(array,!0):[]}function indexOf(array,value,fromIndex){var length=array?array.length:0;if(!length)return-1;if("number"==typeof fromIndex)fromIndex=fromIndex<0?nativeMax(length+fromIndex,0):fromIndex;else if(fromIndex){var index=binaryIndex(array,value);return index<length&&(value===value?value===array[index]:array[index]!==array[index])?index:-1}return baseIndexOf(array,value,fromIndex||0)}function initial(array){return dropRight(array,1)}function last(array){var length=array?array.length:0;return length?array[length-1]:undefined}function lastIndexOf(array,value,fromIndex){var length=array?array.length:0;if(!length)return-1;var index=length;if("number"==typeof fromIndex)index=(fromIndex<0?nativeMax(length+fromIndex,0):nativeMin(fromIndex||0,length-1))+1;else if(fromIndex){index=binaryIndex(array,value,!0)-1;var other=array[index];return(value===value?value===other:other!==other)?index:-1}if(value!==value)return indexOfNaN(array,index,!0);for(;index--;)if(array[index]===value)return index;return-1}function pull(){var args=arguments,array=args[0];if(!array||!array.length)return array;for(var index=0,indexOf=getIndexOf(),length=args.length;++index<length;)for(var fromIndex=0,value=args[index];(fromIndex=indexOf(array,value,fromIndex))>-1;)splice.call(array,fromIndex,1);return array}function remove(array,predicate,thisArg){var result=[];if(!array||!array.length)return result;var index=-1,indexes=[],length=array.length;for(predicate=getCallback(predicate,thisArg,3);++index<length;){var value=array[index];predicate(value,index,array)&&(result.push(value),indexes.push(index))}return basePullAt(array,indexes),result}function rest(array){return drop(array,1)}function slice(array,start,end){var length=array?array.length:0;return length?(end&&"number"!=typeof end&&isIterateeCall(array,start,end)&&(start=0,end=length),baseSlice(array,start,end)):[]}function take(array,n,guard){var length=array?array.length:0;return length?((guard?isIterateeCall(array,n,guard):null==n)&&(n=1),baseSlice(array,0,n<0?0:n)):[]}function takeRight(array,n,guard){var length=array?array.length:0;return length?((guard?isIterateeCall(array,n,guard):null==n)&&(n=1),n=length-(+n||0),baseSlice(array,n<0?0:n)):[]}function takeRightWhile(array,predicate,thisArg){return array&&array.length?baseWhile(array,getCallback(predicate,thisArg,3),!1,!0):[]}function takeWhile(array,predicate,thisArg){return array&&array.length?baseWhile(array,getCallback(predicate,thisArg,3)):[]}function uniq(array,isSorted,iteratee,thisArg){var length=array?array.length:0;if(!length)return[];null!=isSorted&&"boolean"!=typeof isSorted&&(thisArg=iteratee,iteratee=isIterateeCall(array,isSorted,thisArg)?undefined:isSorted,isSorted=!1);var callback=getCallback();return null==iteratee&&callback===baseCallback||(iteratee=callback(iteratee,thisArg,3)),isSorted&&getIndexOf()==baseIndexOf?sortedUniq(array,iteratee):baseUniq(array,iteratee)}function unzip(array){if(!array||!array.length)return[];var index=-1,length=0;array=arrayFilter(array,function(group){if(isArrayLike(group))return length=nativeMax(group.length,length),!0});for(var result=Array(length);++index<length;)result[index]=arrayMap(array,baseProperty(index));return result}function unzipWith(array,iteratee,thisArg){var length=array?array.length:0;if(!length)return[];var result=unzip(array);return null==iteratee?result:(iteratee=bindCallback(iteratee,thisArg,4),arrayMap(result,function(group){return arrayReduce(group,iteratee,undefined,!0)}))}function xor(){for(var index=-1,length=arguments.length;++index<length;){var array=arguments[index];if(isArrayLike(array))var result=result?arrayPush(baseDifference(result,array),baseDifference(array,result)):array}return result?baseUniq(result):[]}function zipObject(props,values){var index=-1,length=props?props.length:0,result={};for(!length||values||isArray(props[0])||(values=[]);++index<length;){var key=props[index];values?result[key]=values[index]:key&&(result[key[0]]=key[1])}return result}function chain(value){var result=lodash(value);return result.__chain__=!0,result}function tap(value,interceptor,thisArg){return interceptor.call(thisArg,value),value}function thru(value,interceptor,thisArg){return interceptor.call(thisArg,value)}function wrapperChain(){return chain(this)}function wrapperCommit(){return new LodashWrapper(this.value(),this.__chain__)}function wrapperPlant(value){for(var result,parent=this;parent instanceof baseLodash;){var clone=wrapperClone(parent);result?previous.__wrapped__=clone:result=clone;var previous=clone;parent=parent.__wrapped__}return previous.__wrapped__=value,result}function wrapperReverse(){var value=this.__wrapped__,interceptor=function(value){return wrapped&&wrapped.__dir__<0?value:value.reverse()};if(value instanceof LazyWrapper){var wrapped=value;return this.__actions__.length&&(wrapped=new LazyWrapper(this)),wrapped=wrapped.reverse(),wrapped.__actions__.push({func:thru,args:[interceptor],thisArg:undefined}),new LodashWrapper(wrapped,this.__chain__)}return this.thru(interceptor)}function wrapperToString(){return this.value()+""}function wrapperValue(){return baseWrapperValue(this.__wrapped__,this.__actions__)}function every(collection,predicate,thisArg){var func=isArray(collection)?arrayEvery:baseEvery;return thisArg&&isIterateeCall(collection,predicate,thisArg)&&(predicate=undefined),"function"==typeof predicate&&thisArg===undefined||(predicate=getCallback(predicate,thisArg,3)),func(collection,predicate)}function filter(collection,predicate,thisArg){var func=isArray(collection)?arrayFilter:baseFilter;return predicate=getCallback(predicate,thisArg,3),func(collection,predicate)}function findWhere(collection,source){return find(collection,baseMatches(source))}function includes(collection,target,fromIndex,guard){var length=collection?getLength(collection):0;return isLength(length)||(collection=values(collection),length=collection.length),fromIndex="number"!=typeof fromIndex||guard&&isIterateeCall(target,fromIndex,guard)?0:fromIndex<0?nativeMax(length+fromIndex,0):fromIndex||0,"string"==typeof collection||!isArray(collection)&&isString(collection)?fromIndex<=length&&collection.indexOf(target,fromIndex)>-1:!!length&&getIndexOf(collection,target,fromIndex)>-1}function map(collection,iteratee,thisArg){var func=isArray(collection)?arrayMap:baseMap;return iteratee=getCallback(iteratee,thisArg,3),func(collection,iteratee)}function pluck(collection,path){return map(collection,property(path))}function reject(collection,predicate,thisArg){var func=isArray(collection)?arrayFilter:baseFilter;return predicate=getCallback(predicate,thisArg,3),func(collection,function(value,index,collection){return!predicate(value,index,collection)})}function sample(collection,n,guard){if(guard?isIterateeCall(collection,n,guard):null==n){collection=toIterable(collection);var length=collection.length;return length>0?collection[baseRandom(0,length-1)]:undefined}var index=-1,result=toArray(collection),length=result.length,lastIndex=length-1;for(n=nativeMin(n<0?0:+n||0,length);++index<n;){var rand=baseRandom(index,lastIndex),value=result[rand];result[rand]=result[index],result[index]=value}return result.length=n,result}function shuffle(collection){return sample(collection,POSITIVE_INFINITY)}function size(collection){var length=collection?getLength(collection):0;return isLength(length)?length:keys(collection).length}function some(collection,predicate,thisArg){var func=isArray(collection)?arraySome:baseSome;return thisArg&&isIterateeCall(collection,predicate,thisArg)&&(predicate=undefined),"function"==typeof predicate&&thisArg===undefined||(predicate=getCallback(predicate,thisArg,3)),func(collection,predicate)}function sortBy(collection,iteratee,thisArg){if(null==collection)return[];thisArg&&isIterateeCall(collection,iteratee,thisArg)&&(iteratee=undefined);var index=-1;iteratee=getCallback(iteratee,thisArg,3);var result=baseMap(collection,function(value,key,collection){return{criteria:iteratee(value,key,collection),index:++index,value:value}});return baseSortBy(result,compareAscending)}function sortByOrder(collection,iteratees,orders,guard){return null==collection?[]:(guard&&isIterateeCall(iteratees,orders,guard)&&(orders=undefined),isArray(iteratees)||(iteratees=null==iteratees?[]:[iteratees]),isArray(orders)||(orders=null==orders?[]:[orders]),baseSortByOrder(collection,iteratees,orders))}function where(collection,source){return filter(collection,baseMatches(source))}function after(n,func){if("function"!=typeof func){if("function"!=typeof n)throw new TypeError(FUNC_ERROR_TEXT);var temp=n;n=func,func=temp}return n=nativeIsFinite(n=+n)?n:0,function(){if(--n<1)return func.apply(this,arguments)}}function ary(func,n,guard){return guard&&isIterateeCall(func,n,guard)&&(n=undefined),n=func&&null==n?func.length:nativeMax(+n||0,0),createWrapper(func,ARY_FLAG,undefined,undefined,undefined,undefined,n)}function before(n,func){var result;if("function"!=typeof func){if("function"!=typeof n)throw new TypeError(FUNC_ERROR_TEXT);var temp=n;n=func,func=temp}return function(){return--n>0&&(result=func.apply(this,arguments)),n<=1&&(func=undefined),result}}function debounce(func,wait,options){function cancel(){timeoutId&&clearTimeout(timeoutId),maxTimeoutId&&clearTimeout(maxTimeoutId),lastCalled=0,maxTimeoutId=timeoutId=trailingCall=undefined}function complete(isCalled,id){id&&clearTimeout(id),maxTimeoutId=timeoutId=trailingCall=undefined,isCalled&&(lastCalled=now(),result=func.apply(thisArg,args),timeoutId||maxTimeoutId||(args=thisArg=undefined))}function delayed(){var remaining=wait-(now()-stamp);remaining<=0||remaining>wait?complete(trailingCall,maxTimeoutId):timeoutId=setTimeout(delayed,remaining)}function maxDelayed(){complete(trailing,timeoutId)}function debounced(){if(args=arguments,stamp=now(),thisArg=this,trailingCall=trailing&&(timeoutId||!leading),maxWait===!1)var leadingCall=leading&&!timeoutId;else{maxTimeoutId||leading||(lastCalled=stamp);var remaining=maxWait-(stamp-lastCalled),isCalled=remaining<=0||remaining>maxWait;isCalled?(maxTimeoutId&&(maxTimeoutId=clearTimeout(maxTimeoutId)),lastCalled=stamp,result=func.apply(thisArg,args)):maxTimeoutId||(maxTimeoutId=setTimeout(maxDelayed,remaining))}return isCalled&&timeoutId?timeoutId=clearTimeout(timeoutId):timeoutId||wait===maxWait||(timeoutId=setTimeout(delayed,wait)),leadingCall&&(isCalled=!0,result=func.apply(thisArg,args)),!isCalled||timeoutId||maxTimeoutId||(args=thisArg=undefined),result}var args,maxTimeoutId,result,stamp,thisArg,timeoutId,trailingCall,lastCalled=0,maxWait=!1,trailing=!0;if("function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);if(wait=wait<0?0:+wait||0,options===!0){var leading=!0;trailing=!1}else isObject(options)&&(leading=!!options.leading,maxWait="maxWait"in options&&nativeMax(+options.maxWait||0,wait),trailing="trailing"in options?!!options.trailing:trailing);return debounced.cancel=cancel,debounced}function memoize(func,resolver){if("function"!=typeof func||resolver&&"function"!=typeof resolver)throw new TypeError(FUNC_ERROR_TEXT);var memoized=function(){var args=arguments,key=resolver?resolver.apply(this,args):args[0],cache=memoized.cache;if(cache.has(key))return cache.get(key);var result=func.apply(this,args);return memoized.cache=cache.set(key,result),result};return memoized.cache=new memoize.Cache,memoized}function negate(predicate){if("function"!=typeof predicate)throw new TypeError(FUNC_ERROR_TEXT);return function(){return!predicate.apply(this,arguments)}}function once(func){return before(2,func)}function restParam(func,start){if("function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);return start=nativeMax(start===undefined?func.length-1:+start||0,0),function(){for(var args=arguments,index=-1,length=nativeMax(args.length-start,0),rest=Array(length);++index<length;)rest[index]=args[start+index];switch(start){case 0:return func.call(this,rest);case 1:return func.call(this,args[0],rest);case 2:return func.call(this,args[0],args[1],rest)}var otherArgs=Array(start+1);for(index=-1;++index<start;)otherArgs[index]=args[index];return otherArgs[start]=rest,func.apply(this,otherArgs)}}function spread(func){if("function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);return function(array){return func.apply(this,array)}}function throttle(func,wait,options){var leading=!0,trailing=!0;if("function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);return options===!1?leading=!1:isObject(options)&&(leading="leading"in options?!!options.leading:leading,trailing="trailing"in options?!!options.trailing:trailing),debounce(func,wait,{leading:leading,maxWait:+wait,trailing:trailing})}function wrap(value,wrapper){return wrapper=null==wrapper?identity:wrapper,createWrapper(wrapper,PARTIAL_FLAG,undefined,[value],[])}function clone(value,isDeep,customizer,thisArg){return isDeep&&"boolean"!=typeof isDeep&&isIterateeCall(value,isDeep,customizer)?isDeep=!1:"function"==typeof isDeep&&(thisArg=customizer,customizer=isDeep,isDeep=!1),"function"==typeof customizer?baseClone(value,isDeep,bindCallback(customizer,thisArg,1)):baseClone(value,isDeep)}function cloneDeep(value,customizer,thisArg){return"function"==typeof customizer?baseClone(value,!0,bindCallback(customizer,thisArg,1)):baseClone(value,!0)}function gt(value,other){return value>other}function gte(value,other){return value>=other}function isArguments(value){return isObjectLike(value)&&isArrayLike(value)&&hasOwnProperty.call(value,"callee")&&!propertyIsEnumerable.call(value,"callee")}function isBoolean(value){return value===!0||value===!1||isObjectLike(value)&&objToString.call(value)==boolTag}function isDate(value){return isObjectLike(value)&&objToString.call(value)==dateTag}function isElement(value){return!!value&&1===value.nodeType&&isObjectLike(value)&&!isPlainObject(value)}function isEmpty(value){return null==value||(isArrayLike(value)&&(isArray(value)||isString(value)||isArguments(value)||isObjectLike(value)&&isFunction(value.splice))?!value.length:!keys(value).length)}function isEqual(value,other,customizer,thisArg){customizer="function"==typeof customizer?bindCallback(customizer,thisArg,3):undefined;var result=customizer?customizer(value,other):undefined;return result===undefined?baseIsEqual(value,other,customizer):!!result}function isError(value){return isObjectLike(value)&&"string"==typeof value.message&&objToString.call(value)==errorTag}function isFinite(value){return"number"==typeof value&&nativeIsFinite(value)}function isFunction(value){return isObject(value)&&objToString.call(value)==funcTag}function isObject(value){var type=typeof value;return!!value&&("object"==type||"function"==type)}function isMatch(object,source,customizer,thisArg){return customizer="function"==typeof customizer?bindCallback(customizer,thisArg,3):undefined,baseIsMatch(object,getMatchData(source),customizer)}function isNaN(value){return isNumber(value)&&value!=+value}function isNative(value){return null!=value&&(isFunction(value)?reIsNative.test(fnToString.call(value)):isObjectLike(value)&&reIsHostCtor.test(value))}function isNull(value){return null===value}function isNumber(value){return"number"==typeof value||isObjectLike(value)&&objToString.call(value)==numberTag}function isPlainObject(value){var Ctor;if(!isObjectLike(value)||objToString.call(value)!=objectTag||isArguments(value)||!hasOwnProperty.call(value,"constructor")&&(Ctor=value.constructor,"function"==typeof Ctor&&!(Ctor instanceof Ctor)))return!1;var result;return baseForIn(value,function(subValue,key){result=key}),result===undefined||hasOwnProperty.call(value,result)}function isRegExp(value){return isObject(value)&&objToString.call(value)==regexpTag}function isString(value){return"string"==typeof value||isObjectLike(value)&&objToString.call(value)==stringTag}function isTypedArray(value){return isObjectLike(value)&&isLength(value.length)&&!!typedArrayTags[objToString.call(value)]}function isUndefined(value){return value===undefined}function lt(value,other){return value<other}function lte(value,other){return value<=other}function toArray(value){var length=value?getLength(value):0;return isLength(length)?length?arrayCopy(value):[]:values(value)}function toPlainObject(value){return baseCopy(value,keysIn(value))}function create(prototype,properties,guard){var result=baseCreate(prototype);return guard&&isIterateeCall(prototype,properties,guard)&&(properties=undefined),properties?baseAssign(result,properties):result}function functions(object){return baseFunctions(object,keysIn(object))}function get(object,path,defaultValue){var result=null==object?undefined:baseGet(object,toPath(path),path+"");return result===undefined?defaultValue:result}function has(object,path){if(null==object)return!1;var result=hasOwnProperty.call(object,path);if(!result&&!isKey(path)){if(path=toPath(path),object=1==path.length?object:baseGet(object,baseSlice(path,0,-1)),null==object)return!1;path=last(path),result=hasOwnProperty.call(object,path)}return result||isLength(object.length)&&isIndex(path,object.length)&&(isArray(object)||isArguments(object))}function invert(object,multiValue,guard){guard&&isIterateeCall(object,multiValue,guard)&&(multiValue=undefined);for(var index=-1,props=keys(object),length=props.length,result={};++index<length;){var key=props[index],value=object[key];multiValue?hasOwnProperty.call(result,value)?result[value].push(key):result[value]=[key]:result[value]=key}return result}function keysIn(object){if(null==object)return[];isObject(object)||(object=Object(object));var length=object.length;length=length&&isLength(length)&&(isArray(object)||isArguments(object))&&length||0;for(var Ctor=object.constructor,index=-1,isProto="function"==typeof Ctor&&Ctor.prototype===object,result=Array(length),skipIndexes=length>0;++index<length;)result[index]=index+"";for(var key in object)skipIndexes&&isIndex(key,length)||"constructor"==key&&(isProto||!hasOwnProperty.call(object,key))||result.push(key);return result}function pairs(object){object=toObject(object);for(var index=-1,props=keys(object),length=props.length,result=Array(length);++index<length;){var key=props[index];result[index]=[key,object[key]]}return result}function result(object,path,defaultValue){var result=null==object?undefined:object[path];return result===undefined&&(null==object||isKey(path,object)||(path=toPath(path),object=1==path.length?object:baseGet(object,baseSlice(path,0,-1)),result=null==object?undefined:object[last(path)]),result=result===undefined?defaultValue:result),isFunction(result)?result.call(object):result}function set(object,path,value){if(null==object)return object;var pathKey=path+"";path=null!=object[pathKey]||isKey(path,object)?[pathKey]:toPath(path);for(var index=-1,length=path.length,lastIndex=length-1,nested=object;null!=nested&&++index<length;){var key=path[index];isObject(nested)&&(index==lastIndex?nested[key]=value:null==nested[key]&&(nested[key]=isIndex(path[index+1])?[]:{})),nested=nested[key]}return object}function transform(object,iteratee,accumulator,thisArg){var isArr=isArray(object)||isTypedArray(object);if(iteratee=getCallback(iteratee,thisArg,4),null==accumulator)if(isArr||isObject(object)){var Ctor=object.constructor;accumulator=isArr?isArray(object)?new Ctor:[]:baseCreate(isFunction(Ctor)?Ctor.prototype:undefined)}else accumulator={};return(isArr?arrayEach:baseForOwn)(object,function(value,index,object){return iteratee(accumulator,value,index,object)}),accumulator}function values(object){return baseValues(object,keys(object))}function valuesIn(object){return baseValues(object,keysIn(object))}function inRange(value,start,end){return start=+start||0,end===undefined?(end=start,start=0):end=+end||0,value>=nativeMin(start,end)&&value<nativeMax(start,end)}function random(min,max,floating){floating&&isIterateeCall(min,max,floating)&&(max=floating=undefined);var noMin=null==min,noMax=null==max;if(null==floating&&(noMax&&"boolean"==typeof min?(floating=min,min=1):"boolean"==typeof max&&(floating=max,noMax=!0)),noMin&&noMax&&(max=1,noMax=!1),min=+min||0,noMax?(max=min,min=0):max=+max||0,floating||min%1||max%1){var rand=nativeRandom();return nativeMin(min+rand*(max-min+parseFloat("1e-"+((rand+"").length-1))),max)}return baseRandom(min,max)}function capitalize(string){return string=baseToString(string),string&&string.charAt(0).toUpperCase()+string.slice(1)}function deburr(string){return string=baseToString(string),string&&string.replace(reLatin1,deburrLetter).replace(reComboMark,"")}function endsWith(string,target,position){string=baseToString(string),target+="";var length=string.length;return position=position===undefined?length:nativeMin(position<0?0:+position||0,length),position-=target.length,position>=0&&string.indexOf(target,position)==position}function escape(string){return string=baseToString(string),string&&reHasUnescapedHtml.test(string)?string.replace(reUnescapedHtml,escapeHtmlChar):string}function escapeRegExp(string){return string=baseToString(string),string&&reHasRegExpChars.test(string)?string.replace(reRegExpChars,escapeRegExpChar):string||"(?:)"}function pad(string,length,chars){string=baseToString(string),length=+length;var strLength=string.length;if(strLength>=length||!nativeIsFinite(length))return string;var mid=(length-strLength)/2,leftLength=nativeFloor(mid),rightLength=nativeCeil(mid);return chars=createPadding("",rightLength,chars),chars.slice(0,leftLength)+string+chars}function parseInt(string,radix,guard){return(guard?isIterateeCall(string,radix,guard):null==radix)?radix=0:radix&&(radix=+radix),string=trim(string),nativeParseInt(string,radix||(reHasHexPrefix.test(string)?16:10))}function repeat(string,n){var result="";if(string=baseToString(string),n=+n,n<1||!string||!nativeIsFinite(n))return result;do n%2&&(result+=string),n=nativeFloor(n/2),
string+=string;while(n);return result}function startsWith(string,target,position){return string=baseToString(string),position=null==position?0:nativeMin(position<0?0:+position||0,string.length),string.lastIndexOf(target,position)==position}function template(string,options,otherOptions){var settings=lodash.templateSettings;otherOptions&&isIterateeCall(string,options,otherOptions)&&(options=otherOptions=undefined),string=baseToString(string),options=assignWith(baseAssign({},otherOptions||options),settings,assignOwnDefaults);var isEscaping,isEvaluating,imports=assignWith(baseAssign({},options.imports),settings.imports,assignOwnDefaults),importsKeys=keys(imports),importsValues=baseValues(imports,importsKeys),index=0,interpolate=options.interpolate||reNoMatch,source="__p += '",reDelimiters=RegExp((options.escape||reNoMatch).source+"|"+interpolate.source+"|"+(interpolate===reInterpolate?reEsTemplate:reNoMatch).source+"|"+(options.evaluate||reNoMatch).source+"|$","g"),sourceURL="//# sourceURL="+("sourceURL"in options?options.sourceURL:"lodash.templateSources["+ ++templateCounter+"]")+"\n";string.replace(reDelimiters,function(match,escapeValue,interpolateValue,esTemplateValue,evaluateValue,offset){return interpolateValue||(interpolateValue=esTemplateValue),source+=string.slice(index,offset).replace(reUnescapedString,escapeStringChar),escapeValue&&(isEscaping=!0,source+="' +\n__e("+escapeValue+") +\n'"),evaluateValue&&(isEvaluating=!0,source+="';\n"+evaluateValue+";\n__p += '"),interpolateValue&&(source+="' +\n((__t = ("+interpolateValue+")) == null ? '' : __t) +\n'"),index=offset+match.length,match}),source+="';\n";var variable=options.variable;variable||(source="with (obj) {\n"+source+"\n}\n"),source=(isEvaluating?source.replace(reEmptyStringLeading,""):source).replace(reEmptyStringMiddle,"$1").replace(reEmptyStringTrailing,"$1;"),source="function("+(variable||"obj")+") {\n"+(variable?"":"obj || (obj = {});\n")+"var __t, __p = ''"+(isEscaping?", __e = _.escape":"")+(isEvaluating?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+source+"return __p\n}";var result=attempt(function(){return Function(importsKeys,sourceURL+"return "+source).apply(undefined,importsValues)});if(result.source=source,isError(result))throw result;return result}function trim(string,chars,guard){var value=string;return(string=baseToString(string))?(guard?isIterateeCall(value,chars,guard):null==chars)?string.slice(trimmedLeftIndex(string),trimmedRightIndex(string)+1):(chars+="",string.slice(charsLeftIndex(string,chars),charsRightIndex(string,chars)+1)):string}function trimLeft(string,chars,guard){var value=string;return string=baseToString(string),string?(guard?isIterateeCall(value,chars,guard):null==chars)?string.slice(trimmedLeftIndex(string)):string.slice(charsLeftIndex(string,chars+"")):string}function trimRight(string,chars,guard){var value=string;return string=baseToString(string),string?(guard?isIterateeCall(value,chars,guard):null==chars)?string.slice(0,trimmedRightIndex(string)+1):string.slice(0,charsRightIndex(string,chars+"")+1):string}function trunc(string,options,guard){guard&&isIterateeCall(string,options,guard)&&(options=undefined);var length=DEFAULT_TRUNC_LENGTH,omission=DEFAULT_TRUNC_OMISSION;if(null!=options)if(isObject(options)){var separator="separator"in options?options.separator:separator;length="length"in options?+options.length||0:length,omission="omission"in options?baseToString(options.omission):omission}else length=+options||0;if(string=baseToString(string),length>=string.length)return string;var end=length-omission.length;if(end<1)return omission;var result=string.slice(0,end);if(null==separator)return result+omission;if(isRegExp(separator)){if(string.slice(end).search(separator)){var match,newEnd,substring=string.slice(0,end);for(separator.global||(separator=RegExp(separator.source,(reFlags.exec(separator)||"")+"g")),separator.lastIndex=0;match=separator.exec(substring);)newEnd=match.index;result=result.slice(0,null==newEnd?end:newEnd)}}else if(string.indexOf(separator,end)!=end){var index=result.lastIndexOf(separator);index>-1&&(result=result.slice(0,index))}return result+omission}function unescape(string){return string=baseToString(string),string&&reHasEscapedHtml.test(string)?string.replace(reEscapedHtml,unescapeHtmlChar):string}function words(string,pattern,guard){return guard&&isIterateeCall(string,pattern,guard)&&(pattern=undefined),string=baseToString(string),string.match(pattern||reWords)||[]}function callback(func,thisArg,guard){return guard&&isIterateeCall(func,thisArg,guard)&&(thisArg=undefined),isObjectLike(func)?matches(func):baseCallback(func,thisArg)}function constant(value){return function(){return value}}function identity(value){return value}function matches(source){return baseMatches(baseClone(source,!0))}function matchesProperty(path,srcValue){return baseMatchesProperty(path,baseClone(srcValue,!0))}function mixin(object,source,options){if(null==options){var isObj=isObject(source),props=isObj?keys(source):undefined,methodNames=props&&props.length?baseFunctions(source,props):undefined;(methodNames?methodNames.length:isObj)||(methodNames=!1,options=source,source=object,object=this)}methodNames||(methodNames=baseFunctions(source,keys(source)));var chain=!0,index=-1,isFunc=isFunction(object),length=methodNames.length;options===!1?chain=!1:isObject(options)&&"chain"in options&&(chain=options.chain);for(;++index<length;){var methodName=methodNames[index],func=source[methodName];object[methodName]=func,isFunc&&(object.prototype[methodName]=function(func){return function(){var chainAll=this.__chain__;if(chain||chainAll){var result=object(this.__wrapped__),actions=result.__actions__=arrayCopy(this.__actions__);return actions.push({func:func,args:arguments,thisArg:object}),result.__chain__=chainAll,result}return func.apply(object,arrayPush([this.value()],arguments))}}(func))}return object}function noConflict(){return root._=oldDash,this}function noop(){}function property(path){return isKey(path)?baseProperty(path):basePropertyDeep(path)}function propertyOf(object){return function(path){return baseGet(object,toPath(path),path+"")}}function range(start,end,step){step&&isIterateeCall(start,end,step)&&(end=step=undefined),start=+start||0,step=null==step?1:+step||0,null==end?(end=start,start=0):end=+end||0;for(var index=-1,length=nativeMax(nativeCeil((end-start)/(step||1)),0),result=Array(length);++index<length;)result[index]=start,start+=step;return result}function times(n,iteratee,thisArg){if(n=nativeFloor(n),n<1||!nativeIsFinite(n))return[];var index=-1,result=Array(nativeMin(n,MAX_ARRAY_LENGTH));for(iteratee=bindCallback(iteratee,thisArg,1);++index<n;)index<MAX_ARRAY_LENGTH?result[index]=iteratee(index):iteratee(index);return result}function uniqueId(prefix){var id=++idCounter;return baseToString(prefix)+id}function add(augend,addend){return(+augend||0)+(+addend||0)}function sum(collection,iteratee,thisArg){return thisArg&&isIterateeCall(collection,iteratee,thisArg)&&(iteratee=undefined),iteratee=getCallback(iteratee,thisArg,3),1==iteratee.length?arraySum(isArray(collection)?collection:toIterable(collection),iteratee):baseSum(collection,iteratee)}context=context?_.defaults(root.Object(),context,_.pick(root,contextProps)):root;var Array=context.Array,Date=context.Date,Error=context.Error,Function=context.Function,Math=context.Math,Number=context.Number,Object=context.Object,RegExp=context.RegExp,String=context.String,TypeError=context.TypeError,arrayProto=Array.prototype,objectProto=Object.prototype,stringProto=String.prototype,fnToString=Function.prototype.toString,hasOwnProperty=objectProto.hasOwnProperty,idCounter=0,objToString=objectProto.toString,oldDash=root._,reIsNative=RegExp("^"+fnToString.call(hasOwnProperty).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),ArrayBuffer=context.ArrayBuffer,clearTimeout=context.clearTimeout,parseFloat=context.parseFloat,pow=Math.pow,propertyIsEnumerable=objectProto.propertyIsEnumerable,Set=getNative(context,"Set"),setTimeout=context.setTimeout,splice=arrayProto.splice,Uint8Array=context.Uint8Array,WeakMap=getNative(context,"WeakMap"),nativeCeil=Math.ceil,nativeCreate=getNative(Object,"create"),nativeFloor=Math.floor,nativeIsArray=getNative(Array,"isArray"),nativeIsFinite=context.isFinite,nativeKeys=getNative(Object,"keys"),nativeMax=Math.max,nativeMin=Math.min,nativeNow=getNative(Date,"now"),nativeParseInt=context.parseInt,nativeRandom=Math.random,NEGATIVE_INFINITY=Number.NEGATIVE_INFINITY,POSITIVE_INFINITY=Number.POSITIVE_INFINITY,MAX_ARRAY_LENGTH=4294967295,MAX_ARRAY_INDEX=MAX_ARRAY_LENGTH-1,HALF_MAX_ARRAY_LENGTH=MAX_ARRAY_LENGTH>>>1,MAX_SAFE_INTEGER=9007199254740991,metaMap=WeakMap&&new WeakMap,realNames={};lodash.support={};lodash.templateSettings={escape:reEscape,evaluate:reEvaluate,interpolate:reInterpolate,variable:"",imports:{_:lodash}};var baseCreate=function(){function object(){}return function(prototype){if(isObject(prototype)){object.prototype=prototype;var result=new object;object.prototype=undefined}return result||{}}}(),baseEach=createBaseEach(baseForOwn),baseEachRight=createBaseEach(baseForOwnRight,!0),baseFor=createBaseFor(),baseForRight=createBaseFor(!0),baseSetData=metaMap?function(func,data){return metaMap.set(func,data),func}:identity,getData=metaMap?function(func){return metaMap.get(func)}:noop,getLength=baseProperty("length"),setData=function(){var count=0,lastCalled=0;return function(key,value){var stamp=now(),remaining=HOT_SPAN-(stamp-lastCalled);if(lastCalled=stamp,remaining>0){if(++count>=HOT_COUNT)return key}else count=0;return baseSetData(key,value)}}(),difference=restParam(function(array,values){return isObjectLike(array)&&isArrayLike(array)?baseDifference(array,baseFlatten(values,!1,!0)):[]}),findIndex=createFindIndex(),findLastIndex=createFindIndex(!0),intersection=restParam(function(arrays){for(var othLength=arrays.length,othIndex=othLength,caches=Array(length),indexOf=getIndexOf(),isCommon=indexOf==baseIndexOf,result=[];othIndex--;){var value=arrays[othIndex]=isArrayLike(value=arrays[othIndex])?value:[];caches[othIndex]=isCommon&&value.length>=120?createCache(othIndex&&value):null}var array=arrays[0],index=-1,length=array?array.length:0,seen=caches[0];outer:for(;++index<length;)if(value=array[index],(seen?cacheIndexOf(seen,value):indexOf(result,value,0))<0){for(var othIndex=othLength;--othIndex;){var cache=caches[othIndex];if((cache?cacheIndexOf(cache,value):indexOf(arrays[othIndex],value,0))<0)continue outer}seen&&seen.push(value),result.push(value)}return result}),pullAt=restParam(function(array,indexes){indexes=baseFlatten(indexes);var result=baseAt(array,indexes);return basePullAt(array,indexes.sort(baseCompareAscending)),result}),sortedIndex=createSortedIndex(),sortedLastIndex=createSortedIndex(!0),union=restParam(function(arrays){return baseUniq(baseFlatten(arrays,!1,!0))}),without=restParam(function(array,values){return isArrayLike(array)?baseDifference(array,values):[]}),zip=restParam(unzip),zipWith=restParam(function(arrays){var length=arrays.length,iteratee=length>2?arrays[length-2]:undefined,thisArg=length>1?arrays[length-1]:undefined;return length>2&&"function"==typeof iteratee?length-=2:(iteratee=length>1&&"function"==typeof thisArg?(--length,thisArg):undefined,thisArg=undefined),arrays.length=length,unzipWith(arrays,iteratee,thisArg)}),wrapperConcat=restParam(function(values){return values=baseFlatten(values),this.thru(function(array){return arrayConcat(isArray(array)?array:[toObject(array)],values)})}),at=restParam(function(collection,props){return baseAt(collection,baseFlatten(props))}),countBy=createAggregator(function(result,value,key){hasOwnProperty.call(result,key)?++result[key]:result[key]=1}),find=createFind(baseEach),findLast=createFind(baseEachRight,!0),forEach=createForEach(arrayEach,baseEach),forEachRight=createForEach(arrayEachRight,baseEachRight),groupBy=createAggregator(function(result,value,key){hasOwnProperty.call(result,key)?result[key].push(value):result[key]=[value]}),indexBy=createAggregator(function(result,value,key){result[key]=value}),invoke=restParam(function(collection,path,args){var index=-1,isFunc="function"==typeof path,isProp=isKey(path),result=isArrayLike(collection)?Array(collection.length):[];return baseEach(collection,function(value){var func=isFunc?path:isProp&&null!=value?value[path]:undefined;result[++index]=func?func.apply(value,args):invokePath(value,path,args)}),result}),partition=createAggregator(function(result,value,key){result[key?0:1].push(value)},function(){return[[],[]]}),reduce=createReduce(arrayReduce,baseEach),reduceRight=createReduce(arrayReduceRight,baseEachRight),sortByAll=restParam(function(collection,iteratees){if(null==collection)return[];var guard=iteratees[2];return guard&&isIterateeCall(iteratees[0],iteratees[1],guard)&&(iteratees.length=1),baseSortByOrder(collection,baseFlatten(iteratees),[])}),now=nativeNow||function(){return(new Date).getTime()},bind=restParam(function(func,thisArg,partials){var bitmask=BIND_FLAG;if(partials.length){var holders=replaceHolders(partials,bind.placeholder);bitmask|=PARTIAL_FLAG}return createWrapper(func,bitmask,thisArg,partials,holders)}),bindAll=restParam(function(object,methodNames){methodNames=methodNames.length?baseFlatten(methodNames):functions(object);for(var index=-1,length=methodNames.length;++index<length;){var key=methodNames[index];object[key]=createWrapper(object[key],BIND_FLAG,object)}return object}),bindKey=restParam(function(object,key,partials){var bitmask=BIND_FLAG|BIND_KEY_FLAG;if(partials.length){var holders=replaceHolders(partials,bindKey.placeholder);bitmask|=PARTIAL_FLAG}return createWrapper(key,bitmask,object,partials,holders)}),curry=createCurry(CURRY_FLAG),curryRight=createCurry(CURRY_RIGHT_FLAG),defer=restParam(function(func,args){return baseDelay(func,1,args)}),delay=restParam(function(func,wait,args){return baseDelay(func,wait,args)}),flow=createFlow(),flowRight=createFlow(!0),modArgs=restParam(function(func,transforms){if(transforms=baseFlatten(transforms),"function"!=typeof func||!arrayEvery(transforms,baseIsFunction))throw new TypeError(FUNC_ERROR_TEXT);var length=transforms.length;return restParam(function(args){for(var index=nativeMin(args.length,length);index--;)args[index]=transforms[index](args[index]);return func.apply(this,args)})}),partial=createPartial(PARTIAL_FLAG),partialRight=createPartial(PARTIAL_RIGHT_FLAG),rearg=restParam(function(func,indexes){return createWrapper(func,REARG_FLAG,undefined,undefined,undefined,baseFlatten(indexes))}),isArray=nativeIsArray||function(value){return isObjectLike(value)&&isLength(value.length)&&objToString.call(value)==arrayTag},merge=createAssigner(baseMerge),assign=createAssigner(function(object,source,customizer){return customizer?assignWith(object,source,customizer):baseAssign(object,source)}),defaults=createDefaults(assign,assignDefaults),defaultsDeep=createDefaults(merge,mergeDefaults),findKey=createFindKey(baseForOwn),findLastKey=createFindKey(baseForOwnRight),forIn=createForIn(baseFor),forInRight=createForIn(baseForRight),forOwn=createForOwn(baseForOwn),forOwnRight=createForOwn(baseForOwnRight),keys=nativeKeys?function(object){var Ctor=null==object?undefined:object.constructor;return"function"==typeof Ctor&&Ctor.prototype===object||"function"!=typeof object&&isArrayLike(object)?shimKeys(object):isObject(object)?nativeKeys(object):[]}:shimKeys,mapKeys=createObjectMapper(!0),mapValues=createObjectMapper(),omit=restParam(function(object,props){if(null==object)return{};if("function"!=typeof props[0]){var props=arrayMap(baseFlatten(props),String);return pickByArray(object,baseDifference(keysIn(object),props))}var predicate=bindCallback(props[0],props[1],3);return pickByCallback(object,function(value,key,object){return!predicate(value,key,object)})}),pick=restParam(function(object,props){return null==object?{}:"function"==typeof props[0]?pickByCallback(object,bindCallback(props[0],props[1],3)):pickByArray(object,baseFlatten(props))}),camelCase=createCompounder(function(result,word,index){return word=word.toLowerCase(),result+(index?word.charAt(0).toUpperCase()+word.slice(1):word)}),kebabCase=createCompounder(function(result,word,index){return result+(index?"-":"")+word.toLowerCase()}),padLeft=createPadDir(),padRight=createPadDir(!0),snakeCase=createCompounder(function(result,word,index){return result+(index?"_":"")+word.toLowerCase()}),startCase=createCompounder(function(result,word,index){return result+(index?" ":"")+(word.charAt(0).toUpperCase()+word.slice(1))}),attempt=restParam(function(func,args){try{return func.apply(undefined,args)}catch(e){return isError(e)?e:new Error(e)}}),method=restParam(function(path,args){return function(object){return invokePath(object,path,args)}}),methodOf=restParam(function(object,args){return function(path){return invokePath(object,path,args)}}),ceil=createRound("ceil"),floor=createRound("floor"),max=createExtremum(gt,NEGATIVE_INFINITY),min=createExtremum(lt,POSITIVE_INFINITY),round=createRound("round");return lodash.prototype=baseLodash.prototype,LodashWrapper.prototype=baseCreate(baseLodash.prototype),LodashWrapper.prototype.constructor=LodashWrapper,LazyWrapper.prototype=baseCreate(baseLodash.prototype),LazyWrapper.prototype.constructor=LazyWrapper,MapCache.prototype["delete"]=mapDelete,MapCache.prototype.get=mapGet,MapCache.prototype.has=mapHas,MapCache.prototype.set=mapSet,SetCache.prototype.push=cachePush,memoize.Cache=MapCache,lodash.after=after,lodash.ary=ary,lodash.assign=assign,lodash.at=at,lodash.before=before,lodash.bind=bind,lodash.bindAll=bindAll,lodash.bindKey=bindKey,lodash.callback=callback,lodash.chain=chain,lodash.chunk=chunk,lodash.compact=compact,lodash.constant=constant,lodash.countBy=countBy,lodash.create=create,lodash.curry=curry,lodash.curryRight=curryRight,lodash.debounce=debounce,lodash.defaults=defaults,lodash.defaultsDeep=defaultsDeep,lodash.defer=defer,lodash.delay=delay,lodash.difference=difference,lodash.drop=drop,lodash.dropRight=dropRight,lodash.dropRightWhile=dropRightWhile,lodash.dropWhile=dropWhile,lodash.fill=fill,lodash.filter=filter,lodash.flatten=flatten,lodash.flattenDeep=flattenDeep,lodash.flow=flow,lodash.flowRight=flowRight,lodash.forEach=forEach,lodash.forEachRight=forEachRight,lodash.forIn=forIn,lodash.forInRight=forInRight,lodash.forOwn=forOwn,lodash.forOwnRight=forOwnRight,lodash.functions=functions,lodash.groupBy=groupBy,lodash.indexBy=indexBy,lodash.initial=initial,lodash.intersection=intersection,lodash.invert=invert,lodash.invoke=invoke,lodash.keys=keys,lodash.keysIn=keysIn,lodash.map=map,lodash.mapKeys=mapKeys,lodash.mapValues=mapValues,lodash.matches=matches,lodash.matchesProperty=matchesProperty,lodash.memoize=memoize,lodash.merge=merge,lodash.method=method,lodash.methodOf=methodOf,lodash.mixin=mixin,lodash.modArgs=modArgs,lodash.negate=negate,lodash.omit=omit,lodash.once=once,lodash.pairs=pairs,lodash.partial=partial,lodash.partialRight=partialRight,lodash.partition=partition,lodash.pick=pick,lodash.pluck=pluck,lodash.property=property,lodash.propertyOf=propertyOf,lodash.pull=pull,lodash.pullAt=pullAt,lodash.range=range,lodash.rearg=rearg,lodash.reject=reject,lodash.remove=remove,lodash.rest=rest,lodash.restParam=restParam,lodash.set=set,lodash.shuffle=shuffle,lodash.slice=slice,lodash.sortBy=sortBy,lodash.sortByAll=sortByAll,lodash.sortByOrder=sortByOrder,lodash.spread=spread,lodash.take=take,lodash.takeRight=takeRight,lodash.takeRightWhile=takeRightWhile,lodash.takeWhile=takeWhile,lodash.tap=tap,lodash.throttle=throttle,lodash.thru=thru,lodash.times=times,lodash.toArray=toArray,lodash.toPlainObject=toPlainObject,lodash.transform=transform,lodash.union=union,lodash.uniq=uniq,lodash.unzip=unzip,lodash.unzipWith=unzipWith,lodash.values=values,lodash.valuesIn=valuesIn,lodash.where=where,lodash.without=without,lodash.wrap=wrap,lodash.xor=xor,lodash.zip=zip,lodash.zipObject=zipObject,lodash.zipWith=zipWith,lodash.backflow=flowRight,lodash.collect=map,lodash.compose=flowRight,lodash.each=forEach,lodash.eachRight=forEachRight,lodash.extend=assign,lodash.iteratee=callback,lodash.methods=functions,lodash.object=zipObject,lodash.select=filter,lodash.tail=rest,lodash.unique=uniq,mixin(lodash,lodash),lodash.add=add,lodash.attempt=attempt,lodash.camelCase=camelCase,lodash.capitalize=capitalize,lodash.ceil=ceil,lodash.clone=clone,lodash.cloneDeep=cloneDeep,lodash.deburr=deburr,lodash.endsWith=endsWith,lodash.escape=escape,lodash.escapeRegExp=escapeRegExp,lodash.every=every,lodash.find=find,lodash.findIndex=findIndex,lodash.findKey=findKey,lodash.findLast=findLast,lodash.findLastIndex=findLastIndex,lodash.findLastKey=findLastKey,lodash.findWhere=findWhere,lodash.first=first,lodash.floor=floor,lodash.get=get,lodash.gt=gt,lodash.gte=gte,lodash.has=has,lodash.identity=identity,lodash.includes=includes,lodash.indexOf=indexOf,lodash.inRange=inRange,lodash.isArguments=isArguments,lodash.isArray=isArray,lodash.isBoolean=isBoolean,lodash.isDate=isDate,lodash.isElement=isElement,lodash.isEmpty=isEmpty,lodash.isEqual=isEqual,lodash.isError=isError,lodash.isFinite=isFinite,lodash.isFunction=isFunction,lodash.isMatch=isMatch,lodash.isNaN=isNaN,lodash.isNative=isNative,lodash.isNull=isNull,lodash.isNumber=isNumber,lodash.isObject=isObject,lodash.isPlainObject=isPlainObject,lodash.isRegExp=isRegExp,lodash.isString=isString,lodash.isTypedArray=isTypedArray,lodash.isUndefined=isUndefined,lodash.kebabCase=kebabCase,lodash.last=last,lodash.lastIndexOf=lastIndexOf,lodash.lt=lt,lodash.lte=lte,lodash.max=max,lodash.min=min,lodash.noConflict=noConflict,lodash.noop=noop,lodash.now=now,lodash.pad=pad,lodash.padLeft=padLeft,lodash.padRight=padRight,lodash.parseInt=parseInt,lodash.random=random,lodash.reduce=reduce,lodash.reduceRight=reduceRight,lodash.repeat=repeat,lodash.result=result,lodash.round=round,lodash.runInContext=runInContext,lodash.size=size,lodash.snakeCase=snakeCase,lodash.some=some,lodash.sortedIndex=sortedIndex,lodash.sortedLastIndex=sortedLastIndex,lodash.startCase=startCase,lodash.startsWith=startsWith,lodash.sum=sum,lodash.template=template,lodash.trim=trim,lodash.trimLeft=trimLeft,lodash.trimRight=trimRight,lodash.trunc=trunc,lodash.unescape=unescape,lodash.uniqueId=uniqueId,lodash.words=words,lodash.all=every,lodash.any=some,lodash.contains=includes,lodash.eq=isEqual,lodash.detect=find,lodash.foldl=reduce,lodash.foldr=reduceRight,lodash.head=first,lodash.include=includes,lodash.inject=reduce,mixin(lodash,function(){var source={};return baseForOwn(lodash,function(func,methodName){lodash.prototype[methodName]||(source[methodName]=func)}),source}(),!1),lodash.sample=sample,lodash.prototype.sample=function(n){return this.__chain__||null!=n?this.thru(function(value){return sample(value,n)}):sample(this.value())},lodash.VERSION=VERSION,arrayEach(["bind","bindKey","curry","curryRight","partial","partialRight"],function(methodName){lodash[methodName].placeholder=lodash}),arrayEach(["drop","take"],function(methodName,index){LazyWrapper.prototype[methodName]=function(n){var filtered=this.__filtered__;if(filtered&&!index)return new LazyWrapper(this);n=null==n?1:nativeMax(nativeFloor(n)||0,0);var result=this.clone();return filtered?result.__takeCount__=nativeMin(result.__takeCount__,n):result.__views__.push({size:n,type:methodName+(result.__dir__<0?"Right":"")}),result},LazyWrapper.prototype[methodName+"Right"]=function(n){return this.reverse()[methodName](n).reverse()}}),arrayEach(["filter","map","takeWhile"],function(methodName,index){var type=index+1,isFilter=type!=LAZY_MAP_FLAG;LazyWrapper.prototype[methodName]=function(iteratee,thisArg){var result=this.clone();return result.__iteratees__.push({iteratee:getCallback(iteratee,thisArg,1),type:type}),result.__filtered__=result.__filtered__||isFilter,result}}),arrayEach(["first","last"],function(methodName,index){var takeName="take"+(index?"Right":"");LazyWrapper.prototype[methodName]=function(){return this[takeName](1).value()[0]}}),arrayEach(["initial","rest"],function(methodName,index){var dropName="drop"+(index?"":"Right");LazyWrapper.prototype[methodName]=function(){return this.__filtered__?new LazyWrapper(this):this[dropName](1)}}),arrayEach(["pluck","where"],function(methodName,index){var operationName=index?"filter":"map",createCallback=index?baseMatches:property;LazyWrapper.prototype[methodName]=function(value){return this[operationName](createCallback(value))}}),LazyWrapper.prototype.compact=function(){return this.filter(identity)},LazyWrapper.prototype.reject=function(predicate,thisArg){return predicate=getCallback(predicate,thisArg,1),this.filter(function(value){return!predicate(value)})},LazyWrapper.prototype.slice=function(start,end){start=null==start?0:+start||0;var result=this;return result.__filtered__&&(start>0||end<0)?new LazyWrapper(result):(start<0?result=result.takeRight(-start):start&&(result=result.drop(start)),end!==undefined&&(end=+end||0,result=end<0?result.dropRight(-end):result.take(end-start)),result)},LazyWrapper.prototype.takeRightWhile=function(predicate,thisArg){return this.reverse().takeWhile(predicate,thisArg).reverse()},LazyWrapper.prototype.toArray=function(){return this.take(POSITIVE_INFINITY)},baseForOwn(LazyWrapper.prototype,function(func,methodName){var checkIteratee=/^(?:filter|map|reject)|While$/.test(methodName),retUnwrapped=/^(?:first|last)$/.test(methodName),lodashFunc=lodash[retUnwrapped?"take"+("last"==methodName?"Right":""):methodName];lodashFunc&&(lodash.prototype[methodName]=function(){var args=retUnwrapped?[1]:arguments,chainAll=this.__chain__,value=this.__wrapped__,isHybrid=!!this.__actions__.length,isLazy=value instanceof LazyWrapper,iteratee=args[0],useLazy=isLazy||isArray(value);useLazy&&checkIteratee&&"function"==typeof iteratee&&1!=iteratee.length&&(isLazy=useLazy=!1);var interceptor=function(value){return retUnwrapped&&chainAll?lodashFunc(value,1)[0]:lodashFunc.apply(undefined,arrayPush([value],args))},action={func:thru,args:[interceptor],thisArg:undefined},onlyLazy=isLazy&&!isHybrid;if(retUnwrapped&&!chainAll)return onlyLazy?(value=value.clone(),value.__actions__.push(action),func.call(value)):lodashFunc.call(undefined,this.value())[0];if(!retUnwrapped&&useLazy){value=onlyLazy?value:new LazyWrapper(this);var result=func.apply(value,args);return result.__actions__.push(action),new LodashWrapper(result,chainAll)}return this.thru(interceptor)})}),arrayEach(["join","pop","push","replace","shift","sort","splice","split","unshift"],function(methodName){var func=(/^(?:replace|split)$/.test(methodName)?stringProto:arrayProto)[methodName],chainName=/^(?:push|sort|unshift)$/.test(methodName)?"tap":"thru",retUnwrapped=/^(?:join|pop|replace|shift)$/.test(methodName);lodash.prototype[methodName]=function(){var args=arguments;return retUnwrapped&&!this.__chain__?func.apply(this.value(),args):this[chainName](function(value){return func.apply(value,args)})}}),baseForOwn(LazyWrapper.prototype,function(func,methodName){var lodashFunc=lodash[methodName];if(lodashFunc){var key=lodashFunc.name,names=realNames[key]||(realNames[key]=[]);names.push({name:methodName,func:lodashFunc})}}),realNames[createHybridWrapper(undefined,BIND_KEY_FLAG).name]=[{name:"wrapper",func:undefined}],LazyWrapper.prototype.clone=lazyClone,LazyWrapper.prototype.reverse=lazyReverse,LazyWrapper.prototype.value=lazyValue,lodash.prototype.chain=wrapperChain,lodash.prototype.commit=wrapperCommit,lodash.prototype.concat=wrapperConcat,lodash.prototype.plant=wrapperPlant,lodash.prototype.reverse=wrapperReverse,lodash.prototype.toString=wrapperToString,lodash.prototype.run=lodash.prototype.toJSON=lodash.prototype.valueOf=lodash.prototype.value=wrapperValue,lodash.prototype.collect=lodash.prototype.map,lodash.prototype.head=lodash.prototype.first,lodash.prototype.select=lodash.prototype.filter,lodash.prototype.tail=lodash.prototype.rest,lodash}var undefined,VERSION="3.10.1",BIND_FLAG=1,BIND_KEY_FLAG=2,CURRY_BOUND_FLAG=4,CURRY_FLAG=8,CURRY_RIGHT_FLAG=16,PARTIAL_FLAG=32,PARTIAL_RIGHT_FLAG=64,ARY_FLAG=128,REARG_FLAG=256,DEFAULT_TRUNC_LENGTH=30,DEFAULT_TRUNC_OMISSION="...",HOT_COUNT=150,HOT_SPAN=16,LARGE_ARRAY_SIZE=200,LAZY_FILTER_FLAG=1,LAZY_MAP_FLAG=2,FUNC_ERROR_TEXT="Expected a function",PLACEHOLDER="__lodash_placeholder__",argsTag="[object Arguments]",arrayTag="[object Array]",boolTag="[object Boolean]",dateTag="[object Date]",errorTag="[object Error]",funcTag="[object Function]",mapTag="[object Map]",numberTag="[object Number]",objectTag="[object Object]",regexpTag="[object RegExp]",setTag="[object Set]",stringTag="[object String]",weakMapTag="[object WeakMap]",arrayBufferTag="[object ArrayBuffer]",float32Tag="[object Float32Array]",float64Tag="[object Float64Array]",int8Tag="[object Int8Array]",int16Tag="[object Int16Array]",int32Tag="[object Int32Array]",uint8Tag="[object Uint8Array]",uint8ClampedTag="[object Uint8ClampedArray]",uint16Tag="[object Uint16Array]",uint32Tag="[object Uint32Array]",reEmptyStringLeading=/\b__p \+= '';/g,reEmptyStringMiddle=/\b(__p \+=) '' \+/g,reEmptyStringTrailing=/(__e\(.*?\)|\b__t\)) \+\n'';/g,reEscapedHtml=/&(?:amp|lt|gt|quot|#39|#96);/g,reUnescapedHtml=/[&<>"'`]/g,reHasEscapedHtml=RegExp(reEscapedHtml.source),reHasUnescapedHtml=RegExp(reUnescapedHtml.source),reEscape=/<%-([\s\S]+?)%>/g,reEvaluate=/<%([\s\S]+?)%>/g,reInterpolate=/<%=([\s\S]+?)%>/g,reIsDeepProp=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\n\\]|\\.)*?\1)\]/,reIsPlainProp=/^\w*$/,rePropName=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\n\\]|\\.)*?)\2)\]/g,reRegExpChars=/^[:!,]|[\\^$.*+?()[\]{}|\/]|(^[0-9a-fA-Fnrtuvx])|([\n\r\u2028\u2029])/g,reHasRegExpChars=RegExp(reRegExpChars.source),reComboMark=/[\u0300-\u036f\ufe20-\ufe23]/g,reEscapeChar=/\\(\\)?/g,reEsTemplate=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,reFlags=/\w*$/,reHasHexPrefix=/^0[xX]/,reIsHostCtor=/^\[object .+?Constructor\]$/,reIsUint=/^\d+$/,reLatin1=/[\xc0-\xd6\xd8-\xde\xdf-\xf6\xf8-\xff]/g,reNoMatch=/($^)/,reUnescapedString=/['\n\r\u2028\u2029\\]/g,reWords=function(){var upper="[A-Z\\xc0-\\xd6\\xd8-\\xde]",lower="[a-z\\xdf-\\xf6\\xf8-\\xff]+";return RegExp(upper+"+(?="+upper+lower+")|"+upper+"?"+lower+"|"+upper+"+|[0-9]+","g")}(),contextProps=["Array","ArrayBuffer","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Math","Number","Object","RegExp","Set","String","_","clearTimeout","isFinite","parseFloat","parseInt","setTimeout","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap"],templateCounter=-1,typedArrayTags={};typedArrayTags[float32Tag]=typedArrayTags[float64Tag]=typedArrayTags[int8Tag]=typedArrayTags[int16Tag]=typedArrayTags[int32Tag]=typedArrayTags[uint8Tag]=typedArrayTags[uint8ClampedTag]=typedArrayTags[uint16Tag]=typedArrayTags[uint32Tag]=!0,typedArrayTags[argsTag]=typedArrayTags[arrayTag]=typedArrayTags[arrayBufferTag]=typedArrayTags[boolTag]=typedArrayTags[dateTag]=typedArrayTags[errorTag]=typedArrayTags[funcTag]=typedArrayTags[mapTag]=typedArrayTags[numberTag]=typedArrayTags[objectTag]=typedArrayTags[regexpTag]=typedArrayTags[setTag]=typedArrayTags[stringTag]=typedArrayTags[weakMapTag]=!1;var cloneableTags={};cloneableTags[argsTag]=cloneableTags[arrayTag]=cloneableTags[arrayBufferTag]=cloneableTags[boolTag]=cloneableTags[dateTag]=cloneableTags[float32Tag]=cloneableTags[float64Tag]=cloneableTags[int8Tag]=cloneableTags[int16Tag]=cloneableTags[int32Tag]=cloneableTags[numberTag]=cloneableTags[objectTag]=cloneableTags[regexpTag]=cloneableTags[stringTag]=cloneableTags[uint8Tag]=cloneableTags[uint8ClampedTag]=cloneableTags[uint16Tag]=cloneableTags[uint32Tag]=!0,cloneableTags[errorTag]=cloneableTags[funcTag]=cloneableTags[mapTag]=cloneableTags[setTag]=cloneableTags[weakMapTag]=!1;var deburredLetters={"":"A","":"A","":"A","":"A","":"A","":"A","":"a","":"a","":"a","":"a","":"a","":"a","":"C","":"c","":"D","":"d","":"E","":"E","":"E","":"E","":"e","":"e","":"e",
"":"e","":"I","":"I","":"I","":"I","":"i","":"i","":"i","":"i","":"N","":"n","":"O","":"O","":"O","":"O","":"O","":"O","":"o","":"o","":"o","":"o","":"o","":"o","":"U","":"U","":"U","":"U","":"u","":"u","":"u","":"u","":"Y","":"y","":"y","":"Ae","":"ae","":"Th","":"th","":"ss"},htmlEscapes={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","`":"&#96;"},htmlUnescapes={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#96;":"`"},objectTypes={"function":!0,object:!0},regexpEscapes={0:"x30",1:"x31",2:"x32",3:"x33",4:"x34",5:"x35",6:"x36",7:"x37",8:"x38",9:"x39",A:"x41",B:"x42",C:"x43",D:"x44",E:"x45",F:"x46",a:"x61",b:"x62",c:"x63",d:"x64",e:"x65",f:"x66",n:"x6e",r:"x72",t:"x74",u:"x75",v:"x76",x:"x78"},stringEscapes={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},freeExports=objectTypes[typeof exports]&&exports&&!exports.nodeType&&exports,freeModule=objectTypes[typeof module]&&module&&!module.nodeType&&module,freeGlobal=freeExports&&freeModule&&"object"==typeof global&&global&&global.Object&&global,freeSelf=objectTypes[typeof self]&&self&&self.Object&&self,freeWindow=objectTypes[typeof window]&&window&&window.Object&&window,moduleExports=freeModule&&freeModule.exports===freeExports&&freeExports,root=freeGlobal||freeWindow!==(this&&this.window)&&freeWindow||freeSelf||this,_=runInContext();"function"==typeof define&&"object"==typeof define.amd&&define.amd?(root._=_,define(function(){return _})):freeExports&&freeModule?moduleExports?(freeModule.exports=_)._=_:freeExports._=_:root._=_}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],106:[function(require,module,exports){module.exports={_args:[["bitcore-lib@^0.13.14","/home/zhangchongyang/code/hdWallet/trustnote-wallet"]],_from:"bitcore-lib@>=0.13.14 <0.14.0",_id:"bitcore-lib@0.13.19",_inCache:!0,_installable:!0,_location:"/bitcore-lib",_nodeVersion:"4.4.5",_npmOperationalInternal:{host:"packages-12-west.internal.npmjs.com",tmp:"tmp/bitcore-lib-0.13.19.tgz_1470850061596_0.2146058666985482"},_npmUser:{email:"braydon@bitpay.com",name:"braydonf"},_npmVersion:"2.15.5",_phantomChildren:{},_requested:{name:"bitcore-lib",raw:"bitcore-lib@^0.13.14",rawSpec:"^0.13.14",scope:null,spec:">=0.13.14 <0.14.0",type:"range"},_requiredBy:["/","/bitcore-mnemonic"],_resolved:"https://registry.npmjs.org/bitcore-lib/-/bitcore-lib-0.13.19.tgz",_shasum:"48af1e9bda10067c1ab16263472b5add2000f3dc",_shrinkwrap:{dependencies:{"bn.js":{from:"bn.js@=2.0.4",resolved:"https://registry.npmjs.org/bn.js/-/bn.js-2.0.4.tgz",version:"2.0.4"},bs58:{from:"bs58@=2.0.0",resolved:"https://registry.npmjs.org/bs58/-/bs58-2.0.0.tgz",version:"2.0.0"},"buffer-compare":{from:"buffer-compare@=1.0.0",resolved:"https://registry.npmjs.org/buffer-compare/-/buffer-compare-1.0.0.tgz",version:"1.0.0"},elliptic:{dependencies:{brorand:{from:"brorand@^1.0.1",resolved:"https://registry.npmjs.org/brorand/-/brorand-1.0.5.tgz",version:"1.0.5"},"hash.js":{from:"hash.js@=1.0.3",resolved:"https://registry.npmjs.org/hash.js/-/hash.js-1.0.3.tgz",version:"1.0.3"}},from:"elliptic@=3.0.3",resolved:"https://registry.npmjs.org/elliptic/-/elliptic-3.0.3.tgz",version:"3.0.3"},inherits:{from:"inherits@=2.0.1",resolved:"https://registry.npmjs.org/inherits/-/inherits-2.0.1.tgz",version:"2.0.1"},lodash:{from:"lodash@=3.10.1",resolved:"https://registry.npmjs.org/lodash/-/lodash-3.10.1.tgz",version:"3.10.1"}},name:"bitcore",version:"0.13.18"},_spec:"bitcore-lib@^0.13.14",_where:"/home/zhangchongyang/code/hdWallet/trustnote-wallet",author:{email:"dev@bitpay.com",name:"BitPay"},browser:{request:"browser-request"},bugs:{url:"https://github.com/bitpay/bitcore-lib/issues"},contributors:[{email:"bitcoin@dcousens.com",name:"Daniel Cousens"},{email:"eordano@gmail.com",name:"Esteban Ordano"},{email:"gordon@bitpay.com",name:"Gordon Hall"},{email:"jgarzik@bitpay.com",name:"Jeff Garzik"},{email:"kyle@kyledrake.net",name:"Kyle Drake"},{email:"manuelaraoz@gmail.com",name:"Manuel Araoz"},{email:"ematiu@gmail.com",name:"Matias Alejo Garcia"},{email:"ryanxcharles@gmail.com",name:"Ryan X. Charles"},{email:"moon@justmoon.net",name:"Stefan Thomas"},{email:"stephen@bitpay.com",name:"Stephen Pair"},{email:"luwei.here@gmail.com",name:"Wei Lu"}],dependencies:{"bn.js":"=2.0.4",bs58:"=2.0.0","buffer-compare":"=1.0.0",elliptic:"=3.0.3",inherits:"=2.0.1",lodash:"=3.10.1"},description:"A pure and powerful JavaScript Bitcoin library.",devDependencies:{"bitcore-build":"github:bitpay/bitcore-build",brfs:"^1.2.0",chai:"^1.10.0",gulp:"^3.8.10",sinon:"^1.13.0"},directories:{},dist:{shasum:"48af1e9bda10067c1ab16263472b5add2000f3dc",tarball:"https://registry.npmjs.org/bitcore-lib/-/bitcore-lib-0.13.19.tgz"},gitHead:"9517864f14d09700f3fd02ff61173003c0280774",homepage:"https://github.com/bitpay/bitcore-lib#readme",keywords:["bitcoin","transaction","address","p2p","ecies","cryptocurrency","blockchain","payment","bip21","bip32","bip37","bip69","bip70","multisig"],license:"MIT",main:"index.js",maintainers:[{email:"braydon@bitpay.com",name:"braydonf"},{email:"gabegattis@gmail.com",name:"gabegattis"},{email:"stephen@pairhome.net",name:"gasteve"},{email:"patrick@bitpay.com",name:"patrickbitpay"}],name:"bitcore-lib",optionalDependencies:{},readme:"ERROR: No README data found!",repository:{type:"git",url:"git+https://github.com/bitpay/bitcore-lib.git"},scripts:{build:"gulp",coverage:"gulp coverage",lint:"gulp lint",test:"gulp test"},version:"0.13.19"}},{}],107:[function(require,module,exports){module.exports=require("./lib/mnemonic")},{"./lib/mnemonic":109}],108:[function(require,module,exports){"use strict";var spec={name:"Mnemonic",message:"Internal Error on bitcore-mnemonic module {0}",errors:[{name:"InvalidEntropy",message:"Entropy length must be an even multiple of 11 bits: {0}"},{name:"UnknownWordlist",message:"Could not detect the used word list: {0}"},{name:"InvalidMnemonic",message:"Mnemonic string is invalid: {0}"}]};module.exports=require("bitcore-lib").errors.extend(spec)},{"bitcore-lib":34}],109:[function(require,module,exports){(function(Buffer){"use strict";var bitcore=require("bitcore-lib"),BN=bitcore.crypto.BN,unorm=require("unorm"),_=bitcore.deps._,pbkdf2=require("./pbkdf2"),errors=require("./errors"),Hash=bitcore.crypto.Hash,Random=bitcore.crypto.Random,$=bitcore.util.preconditions,Mnemonic=function(data,wordlist){if(!(this instanceof Mnemonic))return new Mnemonic(data,wordlist);_.isArray(data)&&(wordlist=data,data=null);var ent,phrase,seed;if(Buffer.isBuffer(data))seed=data;else if(_.isString(data))phrase=unorm.nfkd(data);else if(_.isNumber(data))ent=data;else if(data)throw new bitcore.errors.InvalidArgument("data","Must be a Buffer, a string or an integer");if(ent=ent||128,wordlist=wordlist||Mnemonic._getDictionary(phrase),phrase&&!wordlist)throw new errors.UnknownWordlist(phrase);if(wordlist=wordlist||Mnemonic.Words.ENGLISH,seed&&(phrase=Mnemonic._entropy2mnemonic(seed,wordlist)),phrase&&!Mnemonic.isValid(phrase,wordlist))throw new errors.InvalidMnemonic(phrase);if(ent%32!==0||ent<128)throw new bitcore.errors.InvalidArgument("ENT","Values must be ENT > 128 and ENT % 32 == 0");phrase=phrase||Mnemonic._mnemonic(ent,wordlist),Object.defineProperty(this,"wordlist",{configurable:!1,value:wordlist}),Object.defineProperty(this,"phrase",{configurable:!1,value:phrase})};Mnemonic.Words=require("./words"),Mnemonic.isValid=function(mnemonic,wordlist){if(mnemonic=unorm.nfkd(mnemonic),wordlist=wordlist||Mnemonic._getDictionary(mnemonic),!wordlist)return!1;for(var words=mnemonic.split(" "),bin="",i=0;i<words.length;i++){var ind=wordlist.indexOf(words[i]);if(ind<0)return!1;bin+=("00000000000"+ind.toString(2)).slice(-11)}var cs=bin.length/33,hash_bits=bin.slice(-cs),nonhash_bits=bin.slice(0,bin.length-cs),buf=new Buffer(nonhash_bits.length/8);for(i=0;i<nonhash_bits.length/8;i++)buf.writeUInt8(parseInt(bin.slice(8*i,8*(i+1)),2),i);var expected_hash_bits=Mnemonic._entropyChecksum(buf);return expected_hash_bits===hash_bits},Mnemonic._belongsToWordlist=function(mnemonic,wordlist){for(var words=unorm.nfkd(mnemonic).split(" "),i=0;i<words.length;i++){var ind=wordlist.indexOf(words[i]);if(ind<0)return!1}return!0},Mnemonic._getDictionary=function(mnemonic){if(!mnemonic)return null;for(var dicts=Object.keys(Mnemonic.Words),i=0;i<dicts.length;i++){var key=dicts[i];if(Mnemonic._belongsToWordlist(mnemonic,Mnemonic.Words[key]))return Mnemonic.Words[key]}return null},Mnemonic.prototype.toSeed=function(passphrase){return passphrase=passphrase||"",pbkdf2(unorm.nfkd(this.phrase),unorm.nfkd("mnemonic"+passphrase),2048,64)},Mnemonic.fromSeed=function(seed,wordlist){return $.checkArgument(Buffer.isBuffer(seed),"seed must be a Buffer."),$.checkArgument(_.isArray(wordlist)||_.isString(wordlist),"wordlist must be a string or an array."),new Mnemonic(seed,wordlist)},Mnemonic.prototype.toHDPrivateKey=function(passphrase,network){var seed=this.toSeed(passphrase);return bitcore.HDPrivateKey.fromSeed(seed,network)},Mnemonic.prototype.toString=function(){return this.phrase},Mnemonic.prototype.inspect=function(){return"<Mnemonic: "+this.toString()+" >"},Mnemonic._mnemonic=function(ENT,wordlist){var buf=Random.getRandomBuffer(ENT/8);return Mnemonic._entropy2mnemonic(buf,wordlist)},Mnemonic._entropy2mnemonic=function(entropy,wordlist){for(var bin="",i=0;i<entropy.length;i++)bin+=("00000000"+entropy[i].toString(2)).slice(-8);if(bin+=Mnemonic._entropyChecksum(entropy),bin.length%11!==0)throw new errors.InvalidEntropy(bin);var mnemonic=[];for(i=0;i<bin.length/11;i++){var wi=parseInt(bin.slice(11*i,11*(i+1)),2);mnemonic.push(wordlist[wi])}var ret;return ret=wordlist===Mnemonic.Words.JAPANESE?mnemonic.join(""):mnemonic.join(" ")},Mnemonic._entropyChecksum=function(entropy){for(var hash=Hash.sha256(entropy),bits=8*entropy.length,cs=bits/32,hashbits=new BN(hash.toString("hex"),16).toString(2);hashbits.length%256!==0;)hashbits="0"+hashbits;var checksum=hashbits.slice(0,cs);return checksum},module.exports=Mnemonic}).call(this,require("buffer").Buffer)},{"./errors":108,"./pbkdf2":110,"./words":114,"bitcore-lib":34,buffer:151,unorm:412}],110:[function(require,module,exports){(function(Buffer){"use strict";function pbkdf2(key,salt,iterations,dkLen){var hLen=64;if(dkLen>(Math.pow(2,32)-1)*hLen)throw Error("Requested key length too long");if("string"!=typeof key&&!Buffer.isBuffer(key))throw new TypeError("key must a string or Buffer");if("string"!=typeof salt&&!Buffer.isBuffer(salt))throw new TypeError("salt must a string or Buffer");"string"==typeof key&&(key=new Buffer(key)),"string"==typeof salt&&(salt=new Buffer(salt));var DK=new Buffer(dkLen),U=new Buffer(hLen),T=new Buffer(hLen),block1=new Buffer(salt.length+4),l=Math.ceil(dkLen/hLen),r=dkLen-(l-1)*hLen;salt.copy(block1,0,0,salt.length);for(var i=1;i<=l;i++){block1[salt.length+0]=i>>24&255,block1[salt.length+1]=i>>16&255,block1[salt.length+2]=i>>8&255,block1[salt.length+3]=i>>0&255,U=crypto.createHmac("sha512",key).update(block1).digest(),U.copy(T,0,0,hLen);for(var j=1;j<iterations;j++){U=crypto.createHmac("sha512",key).update(U).digest();for(var k=0;k<hLen;k++)T[k]^=U[k]}var destPos=(i-1)*hLen,len=i===l?r:hLen;T.copy(DK,destPos,0,len)}return DK}var crypto=require("crypto");module.exports=pbkdf2}).call(this,require("buffer").Buffer)},{buffer:151,crypto:181}],111:[function(require,module,exports){"use strict";var chinese=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""];module.exports=chinese},{}],112:[function(require,module,exports){"use strict";var english=["abandon","ability","able","about","above","absent","absorb","abstract","absurd","abuse","access","accident","account","accuse","achieve","acid","acoustic","acquire","across","act","action","actor","actress","actual","adapt","add","addict","address","adjust","admit","adult","advance","advice","aerobic","affair","afford","afraid","again","age","agent","agree","ahead","aim","air","airport","aisle","alarm","album","alcohol","alert","alien","all","alley","allow","almost","alone","alpha","already","also","alter","always","amateur","amazing","among","amount","amused","analyst","anchor","ancient","anger","angle","angry","animal","ankle","announce","annual","another","answer","antenna","antique","anxiety","any","apart","apology","appear","apple","approve","april","arch","arctic","area","arena","argue","arm","armed","armor","army","around","arrange","arrest","arrive","arrow","art","artefact","artist","artwork","ask","aspect","assault","asset","assist","assume","asthma","athlete","atom","attack","attend","attitude","attract","auction","audit","august","aunt","author","auto","autumn","average","avocado","avoid","awake","aware","away","awesome","awful","awkward","axis","baby","bachelor","bacon","badge","bag","balance","balcony","ball","bamboo","banana","banner","bar","barely","bargain","barrel","base","basic","basket","battle","beach","bean","beauty","because","become","beef","before","begin","behave","behind","believe","below","belt","bench","benefit","best","betray","better","between","beyond","bicycle","bid","bike","bind","biology","bird","birth","bitter","black","blade","blame","blanket","blast","bleak","bless","blind","blood","blossom","blouse","blue","blur","blush","board","boat","body","boil","bomb","bone","bonus","book","boost","border","boring","borrow","boss","bottom","bounce","box","boy","bracket","brain","brand","brass","brave","bread","breeze","brick","bridge","brief","bright","bring","brisk","broccoli","broken","bronze","broom","brother","brown","brush","bubble","buddy","budget","buffalo","build","bulb","bulk","bullet","bundle","bunker","burden","burger","burst","bus","business","busy","butter","buyer","buzz","cabbage","cabin","cable","cactus","cage","cake","call","calm","camera","camp","can","canal","cancel","candy","cannon","canoe","canvas","canyon","capable","capital","captain","car","carbon","card","cargo","carpet","carry","cart","case","cash","casino","castle","casual","cat","catalog","catch","category","cattle","caught","cause","caution","cave","ceiling","celery","cement","census","century","cereal","certain","chair","chalk","champion","change","chaos","chapter","charge","chase","chat","cheap","check","cheese","chef","cherry","chest","chicken","chief","child","chimney","choice","choose","chronic","chuckle","chunk","churn","cigar","cinnamon","circle","citizen","city","civil","claim","clap","clarify","claw","clay","clean","clerk","clever","click","client","cliff","climb","clinic","clip","clock","clog","close","cloth","cloud","clown","club","clump","cluster","clutch","coach","coast","coconut","code","coffee","coil","coin","collect","color","column","combine","come","comfort","comic","common","company","concert","conduct","confirm","congress","connect","consider","control","convince","cook","cool","copper","copy","coral","core","corn","correct","cost","cotton","couch","country","couple","course","cousin","cover","coyote","crack","cradle","craft","cram","crane","crash","crater","crawl","crazy","cream","credit","creek","crew","cricket","crime","crisp","critic","crop","cross","crouch","crowd","crucial","cruel","cruise","crumble","crunch","crush","cry","crystal","cube","culture","cup","cupboard","curious","current","curtain","curve","cushion","custom","cute","cycle","dad","damage","damp","dance","danger","daring","dash","daughter","dawn","day","deal","debate","debris","decade","december","decide","decline","decorate","decrease","deer","defense","define","defy","degree","delay","deliver","demand","demise","denial","dentist","deny","depart","depend","deposit","depth","deputy","derive","describe","desert","design","desk","despair","destroy","detail","detect","develop","device","devote","diagram","dial","diamond","diary","dice","diesel","diet","differ","digital","dignity","dilemma","dinner","dinosaur","direct","dirt","disagree","discover","disease","dish","dismiss","disorder","display","distance","divert","divide","divorce","dizzy","doctor","document","dog","doll","dolphin","domain","donate","donkey","donor","door","dose","double","dove","draft","dragon","drama","drastic","draw","dream","dress","drift","drill","drink","drip","drive","drop","drum","dry","duck","dumb","dune","during","dust","dutch","duty","dwarf","dynamic","eager","eagle","early","earn","earth","easily","east","easy","echo","ecology","economy","edge","edit","educate","effort","egg","eight","either","elbow","elder","electric","elegant","element","elephant","elevator","elite","else","embark","embody","embrace","emerge","emotion","employ","empower","empty","enable","enact","end","endless","endorse","enemy","energy","enforce","engage","engine","enhance","enjoy","enlist","enough","enrich","enroll","ensure","enter","entire","entry","envelope","episode","equal","equip","era","erase","erode","erosion","error","erupt","escape","essay","essence","estate","eternal","ethics","evidence","evil","evoke","evolve","exact","example","excess","exchange","excite","exclude","excuse","execute","exercise","exhaust","exhibit","exile","exist","exit","exotic","expand","expect","expire","explain","expose","express","extend","extra","eye","eyebrow","fabric","face","faculty","fade","faint","faith","fall","false","fame","family","famous","fan","fancy","fantasy","farm","fashion","fat","fatal","father","fatigue","fault","favorite","feature","february","federal","fee","feed","feel","female","fence","festival","fetch","fever","few","fiber","fiction","field","figure","file","film","filter","final","find","fine","finger","finish","fire","firm","first","fiscal","fish","fit","fitness","fix","flag","flame","flash","flat","flavor","flee","flight","flip","float","flock","floor","flower","fluid","flush","fly","foam","focus","fog","foil","fold","follow","food","foot","force","forest","forget","fork","fortune","forum","forward","fossil","foster","found","fox","fragile","frame","frequent","fresh","friend","fringe","frog","front","frost","frown","frozen","fruit","fuel","fun","funny","furnace","fury","future","gadget","gain","galaxy","gallery","game","gap","garage","garbage","garden","garlic","garment","gas","gasp","gate","gather","gauge","gaze","general","genius","genre","gentle","genuine","gesture","ghost","giant","gift","giggle","ginger","giraffe","girl","give","glad","glance","glare","glass","glide","glimpse","globe","gloom","glory","glove","glow","glue","goat","goddess","gold","good","goose","gorilla","gospel","gossip","govern","gown","grab","grace","grain","grant","grape","grass","gravity","great","green","grid","grief","grit","grocery","group","grow","grunt","guard","guess","guide","guilt","guitar","gun","gym","habit","hair","half","hammer","hamster","hand","happy","harbor","hard","harsh","harvest","hat","have","hawk","hazard","head","health","heart","heavy","hedgehog","height","hello","helmet","help","hen","hero","hidden","high","hill","hint","hip","hire","history","hobby","hockey","hold","hole","holiday","hollow","home","honey","hood","hope","horn","horror","horse","hospital","host","hotel","hour","hover","hub","huge","human","humble","humor","hundred","hungry","hunt","hurdle","hurry","hurt","husband","hybrid","ice","icon","idea","identify","idle","ignore","ill","illegal","illness","image","imitate","immense","immune","impact","impose","improve","impulse","inch","include","income","increase","index","indicate","indoor","industry","infant","inflict","inform","inhale","inherit","initial","inject","injury","inmate","inner","innocent","input","inquiry","insane","insect","inside","inspire","install","intact","interest","into","invest","invite","involve","iron","island","isolate","issue","item","ivory","jacket","jaguar","jar","jazz","jealous","jeans","jelly","jewel","job","join","joke","journey","joy","judge","juice","jump","jungle","junior","junk","just","kangaroo","keen","keep","ketchup","key","kick","kid","kidney","kind","kingdom","kiss","kit","kitchen","kite","kitten","kiwi","knee","knife","knock","know","lab","label","labor","ladder","lady","lake","lamp","language","laptop","large","later","latin","laugh","laundry","lava","law","lawn","lawsuit","layer","lazy","leader","leaf","learn","leave","lecture","left","leg","legal","legend","leisure","lemon","lend","length","lens","leopard","lesson","letter","level","liar","liberty","library","license","life","lift","light","like","limb","limit","link","lion","liquid","list","little","live","lizard","load","loan","lobster","local","lock","logic","lonely","long","loop","lottery","loud","lounge","love","loyal","lucky","luggage","lumber","lunar","lunch","luxury","lyrics","machine","mad","magic","magnet","maid","mail","main","major","make","mammal","man","manage","mandate","mango","mansion","manual","maple","marble","march","margin","marine","market","marriage","mask","mass","master","match","material","math","matrix","matter","maximum","maze","meadow","mean","measure","meat","mechanic","medal","media","melody","melt","member","memory","mention","menu","mercy","merge","merit","merry","mesh","message","metal","method","middle","midnight","milk","million","mimic","mind","minimum","minor","minute","miracle","mirror","misery","miss","mistake","mix","mixed","mixture","mobile","model","modify","mom","moment","monitor","monkey","monster","month","moon","moral","more","morning","mosquito","mother","motion","motor","mountain","mouse","move","movie","much","muffin","mule","multiply","muscle","museum","mushroom","music","must","mutual","myself","mystery","myth","naive","name","napkin","narrow","nasty","nation","nature","near","neck","need","negative","neglect","neither","nephew","nerve","nest","net","network","neutral","never","news","next","nice","night","noble","noise","nominee","noodle","normal","north","nose","notable","note","nothing","notice","novel","now","nuclear","number","nurse","nut","oak","obey","object","oblige","obscure","observe","obtain","obvious","occur","ocean","october","odor","off","offer","office","often","oil","okay","old","olive","olympic","omit","once","one","onion","online","only","open","opera","opinion","oppose","option","orange","orbit","orchard","order","ordinary","organ","orient","original","orphan","ostrich","other","outdoor","outer","output","outside","oval","oven","over","own","owner","oxygen","oyster","ozone","pact","paddle","page","pair","palace","palm","panda","panel","panic","panther","paper","parade","parent","park","parrot","party","pass","patch","path","patient","patrol","pattern","pause","pave","payment","peace","peanut","pear","peasant","pelican","pen","penalty","pencil","people","pepper","perfect","permit","person","pet","phone","photo","phrase","physical","piano","picnic","picture","piece","pig","pigeon","pill","pilot","pink","pioneer","pipe","pistol","pitch","pizza","place","planet","plastic","plate","play","please","pledge","pluck","plug","plunge","poem","poet","point","polar","pole","police","pond","pony","pool","popular","portion","position","possible","post","potato","pottery","poverty","powder","power","practice","praise","predict","prefer","prepare","present","pretty","prevent","price","pride","primary","print","priority","prison","private","prize","problem","process","produce","profit","program","project","promote","proof","property","prosper","protect","proud","provide","public","pudding","pull","pulp","pulse","pumpkin","punch","pupil","puppy","purchase","purity","purpose","purse","push","put","puzzle","pyramid","quality","quantum","quarter","question","quick","quit","quiz","quote","rabbit","raccoon","race","rack","radar","radio","rail","rain","raise","rally","ramp","ranch","random","range","rapid","rare","rate","rather","raven","raw","razor","ready","real","reason","rebel","rebuild","recall","receive","recipe","record","recycle","reduce","reflect","reform","refuse","region","regret","regular","reject","relax","release","relief","rely","remain","remember","remind","remove","render","renew","rent","reopen","repair","repeat","replace","report","require","rescue","resemble","resist","resource","response","result","retire","retreat","return","reunion","reveal","review","reward","rhythm","rib","ribbon","rice","rich","ride","ridge","rifle","right","rigid","ring","riot","ripple","risk","ritual","rival","river","road","roast","robot","robust","rocket","romance","roof","rookie","room","rose","rotate","rough","round","route","royal","rubber","rude","rug","rule","run","runway","rural","sad","saddle","sadness","safe","sail","salad","salmon","salon","salt","salute","same","sample","sand","satisfy","satoshi","sauce","sausage","save","say","scale","scan","scare","scatter","scene","scheme","school","science","scissors","scorpion","scout","scrap","screen","script","scrub","sea","search","season","seat","second","secret","section","security","seed","seek","segment","select","sell","seminar","senior","sense","sentence","series","service","session","settle","setup","seven","shadow","shaft","shallow","share","shed","shell","sheriff","shield","shift","shine","ship","shiver","shock","shoe","shoot","shop","short","shoulder","shove","shrimp","shrug","shuffle","shy","sibling","sick","side","siege","sight","sign","silent","silk","silly","silver","similar","simple","since","sing","siren","sister","situate","six","size","skate","sketch","ski","skill","skin","skirt","skull","slab","slam","sleep","slender","slice","slide","slight","slim","slogan","slot","slow","slush","small","smart","smile","smoke","smooth","snack","snake","snap","sniff","snow","soap","soccer","social","sock","soda","soft","solar","soldier","solid","solution","solve","someone","song","soon","sorry","sort","soul","sound","soup","source","south","space","spare","spatial","spawn","speak","special","speed","spell","spend","sphere","spice","spider","spike","spin","spirit","split","spoil","sponsor","spoon","sport","spot","spray","spread","spring","spy","square","squeeze","squirrel","stable","stadium","staff","stage","stairs","stamp","stand","start","state","stay","steak","steel","stem","step","stereo","stick","still","sting","stock","stomach","stone","stool","story","stove","strategy","street","strike","strong","struggle","student","stuff","stumble","style","subject","submit","subway","success","such","sudden","suffer","sugar","suggest","suit","summer","sun","sunny","sunset","super","supply","supreme","sure","surface","surge","surprise","surround","survey","suspect","sustain","swallow","swamp","swap","swarm","swear","sweet","swift","swim","swing","switch","sword","symbol","symptom","syrup","system","table","tackle","tag","tail","talent","talk","tank","tape","target","task","taste","tattoo","taxi","teach","team","tell","ten","tenant","tennis","tent","term","test","text","thank","that","theme","then","theory","there","they","thing","this","thought","three","thrive","throw","thumb","thunder","ticket","tide","tiger","tilt","timber","time","tiny","tip","tired","tissue","title","toast","tobacco","today","toddler","toe","together","toilet","token","tomato","tomorrow","tone","tongue","tonight","tool","tooth","top","topic","topple","torch","tornado","tortoise","toss","total","tourist","toward","tower","town","toy","track","trade","traffic","tragic","train","transfer","trap","trash","travel","tray","treat","tree","trend","trial","tribe","trick","trigger","trim","trip","trophy","trouble","truck","true","truly","trumpet","trust","truth","try","tube","tuition","tumble","tuna","tunnel","turkey","turn","turtle","twelve","twenty","twice","twin","twist","two","type","typical","ugly","umbrella","unable","unaware","uncle","uncover","under","undo","unfair","unfold","unhappy","uniform","unique","unit","universe","unknown","unlock","until","unusual","unveil","update","upgrade","uphold","upon","upper","upset","urban","urge","usage","use","used","useful","useless","usual","utility","vacant","vacuum","vague","valid","valley","valve","van","vanish","vapor","various","vast","vault","vehicle","velvet","vendor","venture","venue","verb","verify","version","very","vessel","veteran","viable","vibrant","vicious","victory","video","view","village","vintage","violin","virtual","virus","visa","visit","visual","vital","vivid","vocal","voice","void","volcano","volume","vote","voyage","wage","wagon","wait","walk","wall","walnut","want","warfare","warm","warrior","wash","wasp","waste","water","wave","way","wealth","weapon","wear","weasel","weather","web","wedding","weekend","weird","welcome","west","wet","whale","what","wheat","wheel","when","where","whip","whisper","wide","width","wife","wild","will","win","window","wine","wing","wink","winner","winter","wire","wisdom","wise","wish","witness","wolf","woman","wonder","wood","wool","word","work","world","worry","worth","wrap","wreck","wrestle","wrist","write","wrong","yard","year","yellow","you","young","youth","zebra","zero","zone","zoo"];
module.exports=english},{}],113:[function(require,module,exports){"use string";var french=["abaisser","abandon","abdiquer","abeille","abolir","aborder","aboutir","aboyer","abrasif","abreuver","abriter","abroger","abrupt","absence","absolu","absurde","abusif","abyssal","academie","acajou","acarien","accabler","accepter","acclamer","accolade","accroche","accuser","acerbe","achat","acheter","aciduler","acier","acompte","acquerir","acronyme","acteur","actif","actuel","adepte","adequat","adhesif","adjectif","adjuger","admettre","admirer","adopter","adorer","adoucir","adresse","adroit","adulte","adverbe","aerer","aeronef","affaire","affecter","affiche","affreux","affubler","agacer","agencer","agile","agiter","agrafer","agreable","agrume","aider","aiguille","ailier","aimable","aisance","ajouter","ajuster","alarmer","alchimie","alerte","algebre","algue","aliener","aliment","alleger","alliage","allouer","allumer","alourdir","alpaga","altesse","alveole","amateur","ambigu","ambre","amenager","amertume","amidon","amiral","amorcer","amour","amovible","amphibie","ampleur","amusant","analyse","anaphore","anarchie","anatomie","ancien","aneantir","angle","angoisse","anguleux","animal","annexer","annonce","annuel","anodin","anomalie","anonyme","anormal","antenne","antidote","anxieux","apaiser","aperitif","aplanir","apologie","appareil","appeler","apporter","appuyer","aquarium","aqueduc","arbitre","arbuste","ardeur","ardoise","argent","arlequin","armature","armement","armoire","armure","arpenter","arracher","arriver","arroser","arsenic","arteriel","article","aspect","asphalte","aspirer","assaut","asservir","assiette","associer","assurer","asticot","astre","astuce","atelier","atome","atrium","atroce","attaque","attentif","attirer","attraper","aubaine","auberge","audace","audible","augurer","aurore","automne","autruche","avaler","avancer","avarice","avenir","averse","aveugle","aviateur","avide","avion","aviser","avoine","avouer","avril","axial","axiome","badge","bafouer","bagage","baguette","baignade","balancer","balcon","baleine","balisage","bambin","bancaire","bandage","banlieue","banniere","banquier","barbier","baril","baron","barque","barrage","bassin","bastion","bataille","bateau","batterie","baudrier","bavarder","belette","belier","belote","benefice","berceau","berger","berline","bermuda","besace","besogne","betail","beurre","biberon","bicycle","bidule","bijou","bilan","bilingue","billard","binaire","biologie","biopsie","biotype","biscuit","bison","bistouri","bitume","bizarre","blafard","blague","blanchir","blessant","blinder","blond","bloquer","blouson","bobard","bobine","boire","boiser","bolide","bonbon","bondir","bonheur","bonifier","bonus","bordure","borne","botte","boucle","boueux","bougie","boulon","bouquin","bourse","boussole","boutique","boxeur","branche","brasier","brave","brebis","breche","breuvage","bricoler","brigade","brillant","brioche","brique","brochure","broder","bronzer","brousse","broyeur","brume","brusque","brutal","bruyant","buffle","buisson","bulletin","bureau","burin","bustier","butiner","butoir","buvable","buvette","cabanon","cabine","cachette","cadeau","cadre","cafeine","caillou","caisson","calculer","calepin","calibre","calmer","calomnie","calvaire","camarade","camera","camion","campagne","canal","caneton","canon","cantine","canular","capable","caporal","caprice","capsule","capter","capuche","carabine","carbone","caresser","caribou","carnage","carotte","carreau","carton","cascade","casier","casque","cassure","causer","caution","cavalier","caverne","caviar","cedille","ceinture","celeste","cellule","cendrier","censurer","central","cercle","cerebral","cerise","cerner","cerveau","cesser","chagrin","chaise","chaleur","chambre","chance","chapitre","charbon","chasseur","chaton","chausson","chavirer","chemise","chenille","chequier","chercher","cheval","chien","chiffre","chignon","chimere","chiot","chlorure","chocolat","choisir","chose","chouette","chrome","chute","cigare","cigogne","cimenter","cinema","cintrer","circuler","cirer","cirque","citerne","citoyen","citron","civil","clairon","clameur","claquer","classe","clavier","client","cligner","climat","clivage","cloche","clonage","cloporte","cobalt","cobra","cocasse","cocotier","coder","codifier","coffre","cogner","cohesion","coiffer","coincer","colere","colibri","colline","colmater","colonel","combat","comedie","commande","compact","concert","conduire","confier","congeler","connoter","consonne","contact","convexe","copain","copie","corail","corbeau","cordage","corniche","corpus","correct","cortege","cosmique","costume","coton","coude","coupure","courage","couteau","couvrir","coyote","crabe","crainte","cravate","crayon","creature","crediter","cremeux","creuser","crevette","cribler","crier","cristal","critere","croire","croquer","crotale","crucial","cruel","crypter","cubique","cueillir","cuillere","cuisine","cuivre","culminer","cultiver","cumuler","cupide","curatif","curseur","cyanure","cycle","cylindre","cynique","daigner","damier","danger","danseur","dauphin","debattre","debiter","deborder","debrider","debutant","decaler","decembre","dechirer","decider","declarer","decorer","decrire","decupler","dedale","deductif","deesse","defensif","defiler","defrayer","degager","degivrer","deglutir","degrafer","dejeuner","delice","deloger","demander","demeurer","demolir","denicher","denouer","dentelle","denuder","depart","depenser","dephaser","deplacer","deposer","deranger","derober","desastre","descente","desert","designer","desobeir","dessiner","destrier","detacher","detester","detourer","detresse","devancer","devenir","deviner","devoir","diable","dialogue","diamant","dicter","differer","digerer","digital","digne","diluer","dimanche","diminuer","dioxyde","directif","diriger","discuter","disposer","dissiper","distance","divertir","diviser","docile","docteur","dogme","doigt","domaine","domicile","dompter","donateur","donjon","donner","dopamine","dortoir","dorure","dosage","doseur","dossier","dotation","douanier","double","douceur","douter","doyen","dragon","draper","dresser","dribbler","droiture","duperie","duplexe","durable","durcir","dynastie","eblouir","ecarter","echarpe","echelle","eclairer","eclipse","eclore","ecluse","ecole","economie","ecorce","ecouter","ecraser","ecremer","ecrivain","ecrou","ecume","ecureuil","edifier","eduquer","effacer","effectif","effigie","effort","effrayer","effusion","egaliser","egarer","ejecter","elaborer","elargir","electron","elegant","elephant","eleve","eligible","elitisme","eloge","elucider","eluder","emballer","embellir","embryon","emeraude","emission","emmener","emotion","emouvoir","empereur","employer","emporter","emprise","emulsion","encadrer","enchere","enclave","encoche","endiguer","endosser","endroit","enduire","energie","enfance","enfermer","enfouir","engager","engin","englober","enigme","enjamber","enjeu","enlever","ennemi","ennuyeux","enrichir","enrobage","enseigne","entasser","entendre","entier","entourer","entraver","enumerer","envahir","enviable","envoyer","enzyme","eolien","epaissir","epargne","epatant","epaule","epicerie","epidemie","epier","epilogue","epine","episode","epitaphe","epoque","epreuve","eprouver","epuisant","equerre","equipe","eriger","erosion","erreur","eruption","escalier","espadon","espece","espiegle","espoir","esprit","esquiver","essayer","essence","essieu","essorer","estime","estomac","estrade","etagere","etaler","etanche","etatique","eteindre","etendoir","eternel","ethanol","ethique","ethnie","etirer","etoffer","etoile","etonnant","etourdir","etrange","etroit","etude","euphorie","evaluer","evasion","eventail","evidence","eviter","evolutif","evoquer","exact","exagerer","exaucer","exceller","excitant","exclusif","excuse","executer","exemple","exercer","exhaler","exhorter","exigence","exiler","exister","exotique","expedier","explorer","exposer","exprimer","exquis","extensif","extraire","exulter","fable","fabuleux","facette","facile","facture","faiblir","falaise","fameux","famille","farceur","farfelu","farine","farouche","fasciner","fatal","fatigue","faucon","fautif","faveur","favori","febrile","feconder","federer","felin","femme","femur","fendoir","feodal","fermer","feroce","ferveur","festival","feuille","feutre","fevrier","fiasco","ficeler","fictif","fidele","figure","filature","filetage","filiere","filleul","filmer","filou","filtrer","financer","finir","fiole","firme","fissure","fixer","flairer","flamme","flasque","flatteur","fleau","fleche","fleur","flexion","flocon","flore","fluctuer","fluide","fluvial","folie","fonderie","fongible","fontaine","forcer","forgeron","formuler","fortune","fossile","foudre","fougere","fouiller","foulure","fourmi","fragile","fraise","franchir","frapper","frayeur","fregate","freiner","frelon","fremir","frenesie","frere","friable","friction","frisson","frivole","froid","fromage","frontal","frotter","fruit","fugitif","fuite","fureur","furieux","furtif","fusion","futur","gagner","galaxie","galerie","gambader","garantir","gardien","garnir","garrigue","gazelle","gazon","geant","gelatine","gelule","gendarme","general","genie","genou","gentil","geologie","geometre","geranium","germe","gestuel","geyser","gibier","gicler","girafe","givre","glace","glaive","glisser","globe","gloire","glorieux","golfeur","gomme","gonfler","gorge","gorille","goudron","gouffre","goulot","goupille","gourmand","goutte","graduel","graffiti","graine","grand","grappin","gratuit","gravir","grenat","griffure","griller","grimper","grogner","gronder","grotte","groupe","gruger","grutier","gruyere","guepard","guerrier","guide","guimauve","guitare","gustatif","gymnaste","gyrostat","habitude","hachoir","halte","hameau","hangar","hanneton","haricot","harmonie","harpon","hasard","helium","hematome","herbe","herisson","hermine","heron","hesiter","heureux","hiberner","hibou","hilarant","histoire","hiver","homard","hommage","homogene","honneur","honorer","honteux","horde","horizon","horloge","hormone","horrible","houleux","housse","hublot","huileux","humain","humble","humide","humour","hurler","hydromel","hygiene","hymne","hypnose","idylle","ignorer","iguane","illicite","illusion","image","imbiber","imiter","immense","immobile","immuable","impact","imperial","implorer","imposer","imprimer","imputer","incarner","incendie","incident","incliner","incolore","indexer","indice","inductif","inedit","ineptie","inexact","infini","infliger","informer","infusion","ingerer","inhaler","inhiber","injecter","injure","innocent","inoculer","inonder","inscrire","insecte","insigne","insolite","inspirer","instinct","insulter","intact","intense","intime","intrigue","intuitif","inutile","invasion","inventer","inviter","invoquer","ironique","irradier","irreel","irriter","isoler","ivoire","ivresse","jaguar","jaillir","jambe","janvier","jardin","jauger","jaune","javelot","jetable","jeton","jeudi","jeunesse","joindre","joncher","jongler","joueur","jouissif","journal","jovial","joyau","joyeux","jubiler","jugement","junior","jupon","juriste","justice","juteux","juvenile","kayak","kimono","kiosque","label","labial","labourer","lacerer","lactose","lagune","laine","laisser","laitier","lambeau","lamelle","lampe","lanceur","langage","lanterne","lapin","largeur","larme","laurier","lavabo","lavoir","lecture","legal","leger","legume","lessive","lettre","levier","lexique","lezard","liasse","liberer","libre","licence","licorne","liege","lievre","ligature","ligoter","ligue","limer","limite","limonade","limpide","lineaire","lingot","lionceau","liquide","lisiere","lister","lithium","litige","littoral","livreur","logique","lointain","loisir","lombric","loterie","louer","lourd","loutre","louve","loyal","lubie","lucide","lucratif","lueur","lugubre","luisant","lumiere","lunaire","lundi","luron","lutter","luxueux","machine","magasin","magenta","magique","maigre","maillon","maintien","mairie","maison","majorer","malaxer","malefice","malheur","malice","mallette","mammouth","mandater","maniable","manquant","manteau","manuel","marathon","marbre","marchand","mardi","maritime","marqueur","marron","marteler","mascotte","massif","materiel","matiere","matraque","maudire","maussade","mauve","maximal","mechant","meconnu","medaille","medecin","mediter","meduse","meilleur","melange","melodie","membre","memoire","menacer","mener","menhir","mensonge","mentor","mercredi","merite","merle","messager","mesure","metal","meteore","methode","metier","meuble","miauler","microbe","miette","mignon","migrer","milieu","million","mimique","mince","mineral","minimal","minorer","minute","miracle","miroiter","missile","mixte","mobile","moderne","moelleux","mondial","moniteur","monnaie","monotone","monstre","montagne","monument","moqueur","morceau","morsure","mortier","moteur","motif","mouche","moufle","moulin","mousson","mouton","mouvant","multiple","munition","muraille","murene","murmure","muscle","museum","musicien","mutation","muter","mutuel","myriade","myrtille","mystere","mythique","nageur","nappe","narquois","narrer","natation","nation","nature","naufrage","nautique","navire","nebuleux","nectar","nefaste","negation","negliger","negocier","neige","nerveux","nettoyer","neurone","neutron","neveu","niche","nickel","nitrate","niveau","noble","nocif","nocturne","noirceur","noisette","nomade","nombreux","nommer","normatif","notable","notifier","notoire","nourrir","nouveau","novateur","novembre","novice","nuage","nuancer","nuire","nuisible","numero","nuptial","nuque","nutritif","obeir","objectif","obliger","obscur","observer","obstacle","obtenir","obturer","occasion","occuper","ocean","octobre","octroyer","octupler","oculaire","odeur","odorant","offenser","officier","offrir","ogive","oiseau","oisillon","olfactif","olivier","ombrage","omettre","onctueux","onduler","onereux","onirique","opale","opaque","operer","opinion","opportun","opprimer","opter","optique","orageux","orange","orbite","ordonner","oreille","organe","orgueil","orifice","ornement","orque","ortie","osciller","osmose","ossature","otarie","ouragan","ourson","outil","outrager","ouvrage","ovation","oxyde","oxygene","ozone","paisible","palace","palmares","palourde","palper","panache","panda","pangolin","paniquer","panneau","panorama","pantalon","papaye","papier","papoter","papyrus","paradoxe","parcelle","paresse","parfumer","parler","parole","parrain","parsemer","partager","parure","parvenir","passion","pasteque","paternel","patience","patron","pavillon","pavoiser","payer","paysage","peigne","peintre","pelage","pelican","pelle","pelouse","peluche","pendule","penetrer","penible","pensif","penurie","pepite","peplum","perdrix","perforer","periode","permuter","perplexe","persil","perte","peser","petale","petit","petrir","peuple","pharaon","phobie","phoque","photon","phrase","physique","piano","pictural","piece","pierre","pieuvre","pilote","pinceau","pipette","piquer","pirogue","piscine","piston","pivoter","pixel","pizza","placard","plafond","plaisir","planer","plaque","plastron","plateau","pleurer","plexus","pliage","plomb","plonger","pluie","plumage","pochette","poesie","poete","pointe","poirier","poisson","poivre","polaire","policier","pollen","polygone","pommade","pompier","ponctuel","ponderer","poney","portique","position","posseder","posture","potager","poteau","potion","pouce","poulain","poumon","pourpre","poussin","pouvoir","prairie","pratique","precieux","predire","prefixe","prelude","prenom","presence","pretexte","prevoir","primitif","prince","prison","priver","probleme","proceder","prodige","profond","progres","proie","projeter","prologue","promener","propre","prospere","proteger","prouesse","proverbe","prudence","pruneau","psychose","public","puceron","puiser","pulpe","pulsar","punaise","punitif","pupitre","purifier","puzzle","pyramide","quasar","querelle","question","quietude","quitter","quotient","racine","raconter","radieux","ragondin","raideur","raisin","ralentir","rallonge","ramasser","rapide","rasage","ratisser","ravager","ravin","rayonner","reactif","reagir","realiser","reanimer","recevoir","reciter","reclamer","recolter","recruter","reculer","recycler","rediger","redouter","refaire","reflexe","reformer","refrain","refuge","regalien","region","reglage","regulier","reiterer","rejeter","rejouer","relatif","relever","relief","remarque","remede","remise","remonter","remplir","remuer","renard","renfort","renifler","renoncer","rentrer","renvoi","replier","reporter","reprise","reptile","requin","reserve","resineux","resoudre","respect","rester","resultat","retablir","retenir","reticule","retomber","retracer","reunion","reussir","revanche","revivre","revolte","revulsif","richesse","rideau","rieur","rigide","rigoler","rincer","riposter","risible","risque","rituel","rival","riviere","rocheux","romance","rompre","ronce","rondin","roseau","rosier","rotatif","rotor","rotule","rouge","rouille","rouleau","routine","royaume","ruban","rubis","ruche","ruelle","rugueux","ruiner","ruisseau","ruser","rustique","rythme","sabler","saboter","sabre","sacoche","safari","sagesse","saisir","salade","salive","salon","saluer","samedi","sanction","sanglier","sarcasme","sardine","saturer","saugrenu","saumon","sauter","sauvage","savant","savonner","scalpel","scandale","scelerat","scenario","sceptre","schema","science","scinder","score","scrutin","sculpter","seance","secable","secher","secouer","secreter","sedatif","seduire","seigneur","sejour","selectif","semaine","sembler","semence","seminal","senateur","sensible","sentence","separer","sequence","serein","sergent","serieux","serrure","serum","service","sesame","sevir","sevrage","sextuple","sideral","siecle","sieger","siffler","sigle","signal","silence","silicium","simple","sincere","sinistre","siphon","sirop","sismique","situer","skier","social","socle","sodium","soigneux","soldat","soleil","solitude","soluble","sombre","sommeil","somnoler","sonde","songeur","sonnette","sonore","sorcier","sortir","sosie","sottise","soucieux","soudure","souffle","soulever","soupape","source","soutirer","souvenir","spacieux","spatial","special","sphere","spiral","stable","station","sternum","stimulus","stipuler","strict","studieux","stupeur","styliste","sublime","substrat","subtil","subvenir","succes","sucre","suffixe","suggerer","suiveur","sulfate","superbe","supplier","surface","suricate","surmener","surprise","sursaut","survie","suspect","syllabe","symbole","symetrie","synapse","syntaxe","systeme","tabac","tablier","tactile","tailler","talent","talisman","talonner","tambour","tamiser","tangible","tapis","taquiner","tarder","tarif","tartine","tasse","tatami","tatouage","taupe","taureau","taxer","temoin","temporel","tenaille","tendre","teneur","tenir","tension","terminer","terne","terrible","tetine","texte","theme","theorie","therapie","thorax","tibia","tiede","timide","tirelire","tiroir","tissu","titane","titre","tituber","toboggan","tolerant","tomate","tonique","tonneau","toponyme","torche","tordre","tornade","torpille","torrent","torse","tortue","totem","toucher","tournage","tousser","toxine","traction","trafic","tragique","trahir","train","trancher","travail","trefle","tremper","tresor","treuil","triage","tribunal","tricoter","trilogie","triomphe","tripler","triturer","trivial","trombone","tronc","tropical","troupeau","tuile","tulipe","tumulte","tunnel","turbine","tuteur","tutoyer","tuyau","tympan","typhon","typique","tyran","ubuesque","ultime","ultrason","unanime","unifier","union","unique","unitaire","univers","uranium","urbain","urticant","usage","usine","usuel","usure","utile","utopie","vacarme","vaccin","vagabond","vague","vaillant","vaincre","vaisseau","valable","valise","vallon","valve","vampire","vanille","vapeur","varier","vaseux","vassal","vaste","vecteur","vedette","vegetal","vehicule","veinard","veloce","vendredi","venerer","venger","venimeux","ventouse","verdure","verin","vernir","verrou","verser","vertu","veston","veteran","vetuste","vexant","vexer","viaduc","viande","victoire","vidange","video","vignette","vigueur","vilain","village","vinaigre","violon","vipere","virement","virtuose","virus","visage","viseur","vision","visqueux","visuel","vital","vitesse","viticole","vitrine","vivace","vivipare","vocation","voguer","voile","voisin","voiture","volaille","volcan","voltiger","volume","vorace","vortex","voter","vouloir","voyage","voyelle","wagon","xenon","yacht","zebre","zenith","zeste","zoologie"];module.exports=french},{}],114:[function(require,module,exports){module.exports={CHINESE:require("./chinese"),ENGLISH:require("./english"),FRENCH:require("./french"),JAPANESE:require("./japanese"),SPANISH:require("./spanish")}},{"./chinese":111,"./english":112,"./french":113,"./japanese":115,"./spanish":116}],115:[function(require,module,exports){"use strict";var japanese=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""];
module.exports=japanese},{}],116:[function(require,module,exports){"use strict";var spanish=["abaco","abdomen","abeja","abierto","abogado","abono","aborto","abrazo","abrir","abuelo","abuso","acabar","academia","acceso","accion","aceite","acelga","acento","aceptar","acido","aclarar","acne","acoger","acoso","activo","acto","actriz","actuar","acudir","acuerdo","acusar","adicto","admitir","adoptar","adorno","aduana","adulto","aereo","afectar","aficion","afinar","afirmar","agil","agitar","agonia","agosto","agotar","agregar","agrio","agua","agudo","aguila","aguja","ahogo","ahorro","aire","aislar","ajedrez","ajeno","ajuste","alacran","alambre","alarma","alba","album","alcalde","aldea","alegre","alejar","alerta","aleta","alfiler","alga","algodon","aliado","aliento","alivio","alma","almeja","almibar","altar","alteza","altivo","alto","altura","alumno","alzar","amable","amante","amapola","amargo","amasar","ambar","ambito","ameno","amigo","amistad","amor","amparo","amplio","ancho","anciano","ancla","andar","anden","anemia","angulo","anillo","animo","anis","anotar","antena","antiguo","antojo","anual","anular","anuncio","anadir","anejo","ano","apagar","aparato","apetito","apio","aplicar","apodo","aporte","apoyo","aprender","aprobar","apuesta","apuro","arado","arana","arar","arbitro","arbol","arbusto","archivo","arco","arder","ardilla","arduo","area","arido","aries","armonia","arnes","aroma","arpa","arpon","arreglo","arroz","arruga","arte","artista","asa","asado","asalto","ascenso","asegurar","aseo","asesor","asiento","asilo","asistir","asno","asombro","aspero","astilla","astro","astuto","asumir","asunto","atajo","ataque","atar","atento","ateo","atico","atleta","atomo","atraer","atroz","atun","audaz","audio","auge","aula","aumento","ausente","autor","aval","avance","avaro","ave","avellana","avena","avestruz","avion","aviso","ayer","ayuda","ayuno","azafran","azar","azote","azucar","azufre","azul","baba","babor","bache","bahia","baile","bajar","balanza","balcon","balde","bambu","banco","banda","bano","barba","barco","barniz","barro","bascula","baston","basura","batalla","bateria","batir","batuta","baul","bazar","bebe","bebida","bello","besar","beso","bestia","bicho","bien","bingo","blanco","bloque","blusa","boa","bobina","bobo","boca","bocina","boda","bodega","boina","bola","bolero","bolsa","bomba","bondad","bonito","bono","bonsai","borde","borrar","bosque","bote","botin","boveda","bozal","bravo","brazo","brecha","breve","brillo","brinco","brisa","broca","broma","bronce","brote","bruja","brusco","bruto","buceo","bucle","bueno","buey","bufanda","bufon","buho","buitre","bulto","burbuja","burla","burro","buscar","butaca","buzon","caballo","cabeza","cabina","cabra","cacao","cadaver","cadena","caer","cafe","caida","caiman","caja","cajon","cal","calamar","calcio","caldo","calidad","calle","calma","calor","calvo","cama","cambio","camello","camino","campo","cancer","candil","canela","canguro","canica","canto","cana","canon","caoba","caos","capaz","capitan","capote","captar","capucha","cara","carbon","carcel","careta","carga","carino","carne","carpeta","carro","carta","casa","casco","casero","caspa","castor","catorce","catre","caudal","causa","cazo","cebolla","ceder","cedro","celda","celebre","celoso","celula","cemento","ceniza","centro","cerca","cerdo","cereza","cero","cerrar","certeza","cesped","cetro","chacal","chaleco","champu","chancla","chapa","charla","chico","chiste","chivo","choque","choza","chuleta","chupar","ciclon","ciego","cielo","cien","cierto","cifra","cigarro","cima","cinco","cine","cinta","cipres","circo","ciruela","cisne","cita","ciudad","clamor","clan","claro","clase","clave","cliente","clima","clinica","cobre","coccion","cochino","cocina","coco","codigo","codo","cofre","coger","cohete","cojin","cojo","cola","colcha","colegio","colgar","colina","collar","colmo","columna","combate","comer","comida","comodo","compra","conde","conejo","conga","conocer","consejo","contar","copa","copia","corazon","corbata","corcho","cordon","corona","correr","coser","cosmos","costa","craneo","crater","crear","crecer","creido","crema","cria","crimen","cripta","crisis","cromo","cronica","croqueta","crudo","cruz","cuadro","cuarto","cuatro","cubo","cubrir","cuchara","cuello","cuento","cuerda","cuesta","cueva","cuidar","culebra","culpa","culto","cumbre","cumplir","cuna","cuneta","cuota","cupon","cupula","curar","curioso","curso","curva","cutis","dama","danza","dar","dardo","datil","deber","debil","decada","decir","dedo","defensa","definir","dejar","delfin","delgado","delito","demora","denso","dental","deporte","derecho","derrota","desayuno","deseo","desfile","desnudo","destino","desvio","detalle","detener","deuda","dia","diablo","diadema","diamante","diana","diario","dibujo","dictar","diente","dieta","diez","dificil","digno","dilema","diluir","dinero","directo","dirigir","disco","diseno","disfraz","diva","divino","doble","doce","dolor","domingo","don","donar","dorado","dormir","dorso","dos","dosis","dragon","droga","ducha","duda","duelo","dueno","dulce","duo","duque","durar","dureza","duro","ebano","ebrio","echar","eco","ecuador","edad","edicion","edificio","editor","educar","efecto","eficaz","eje","ejemplo","elefante","elegir","elemento","elevar","elipse","elite","elixir","elogio","eludir","embudo","emitir","emocion","empate","empeno","empleo","empresa","enano","encargo","enchufe","encia","enemigo","enero","enfado","enfermo","engano","enigma","enlace","enorme","enredo","ensayo","ensenar","entero","entrar","envase","envio","epoca","equipo","erizo","escala","escena","escolar","escribir","escudo","esencia","esfera","esfuerzo","espada","espejo","espia","esposa","espuma","esqui","estar","este","estilo","estufa","etapa","eterno","etica","etnia","evadir","evaluar","evento","evitar","exacto","examen","exceso","excusa","exento","exigir","exilio","existir","exito","experto","explicar","exponer","extremo","fabrica","fabula","fachada","facil","factor","faena","faja","falda","fallo","falso","faltar","fama","familia","famoso","faraon","farmacia","farol","farsa","fase","fatiga","fauna","favor","fax","febrero","fecha","feliz","feo","feria","feroz","fertil","fervor","festin","fiable","fianza","fiar","fibra","ficcion","ficha","fideo","fiebre","fiel","fiera","fiesta","figura","fijar","fijo","fila","filete","filial","filtro","fin","finca","fingir","finito","firma","flaco","flauta","flecha","flor","flota","fluir","flujo","fluor","fobia","foca","fogata","fogon","folio","folleto","fondo","forma","forro","fortuna","forzar","fosa","foto","fracaso","fragil","franja","frase","fraude","freir","freno","fresa","frio","frito","fruta","fuego","fuente","fuerza","fuga","fumar","funcion","funda","furgon","furia","fusil","futbol","futuro","gacela","gafas","gaita","gajo","gala","galeria","gallo","gamba","ganar","gancho","ganga","ganso","garaje","garza","gasolina","gastar","gato","gavilan","gemelo","gemir","gen","genero","genio","gente","geranio","gerente","germen","gesto","gigante","gimnasio","girar","giro","glaciar","globo","gloria","gol","golfo","goloso","golpe","goma","gordo","gorila","gorra","gota","goteo","gozar","grada","grafico","grano","grasa","gratis","grave","grieta","grillo","gripe","gris","grito","grosor","grua","grueso","grumo","grupo","guante","guapo","guardia","guerra","guia","guino","guion","guiso","guitarra","gusano","gustar","haber","habil","hablar","hacer","hacha","hada","hallar","hamaca","harina","haz","hazana","hebilla","hebra","hecho","helado","helio","hembra","herir","hermano","heroe","hervir","hielo","hierro","higado","higiene","hijo","himno","historia","hocico","hogar","hoguera","hoja","hombre","hongo","honor","honra","hora","hormiga","horno","hostil","hoyo","hueco","huelga","huerta","hueso","huevo","huida","huir","humano","humedo","humilde","humo","hundir","huracan","hurto","icono","ideal","idioma","idolo","iglesia","iglu","igual","ilegal","ilusion","imagen","iman","imitar","impar","imperio","imponer","impulso","incapaz","indice","inerte","infiel","informe","ingenio","inicio","inmenso","inmune","innato","insecto","instante","interes","intimo","intuir","inutil","invierno","ira","iris","ironia","isla","islote","jabali","jabon","jamon","jarabe","jardin","jarra","jaula","jazmin","jefe","jeringa","jinete","jornada","joroba","joven","joya","juerga","jueves","juez","jugador","jugo","juguete","juicio","junco","jungla","junio","juntar","jupiter","jurar","justo","juvenil","juzgar","kilo","koala","labio","lacio","lacra","lado","ladron","lagarto","lagrima","laguna","laico","lamer","lamina","lampara","lana","lancha","langosta","lanza","lapiz","largo","larva","lastima","lata","latex","latir","laurel","lavar","lazo","leal","leccion","leche","lector","leer","legion","legumbre","lejano","lengua","lento","lena","leon","leopardo","lesion","letal","letra","leve","leyenda","libertad","libro","licor","lider","lidiar","lienzo","liga","ligero","lima","limite","limon","limpio","lince","lindo","linea","lingote","lino","linterna","liquido","liso","lista","litera","litio","litro","llaga","llama","llanto","llave","llegar","llenar","llevar","llorar","llover","lluvia","lobo","locion","loco","locura","logica","logro","lombriz","lomo","lonja","lote","lucha","lucir","lugar","lujo","luna","lunes","lupa","lustro","luto","luz","maceta","macho","madera","madre","maduro","maestro","mafia","magia","mago","maiz","maldad","maleta","malla","malo","mama","mambo","mamut","manco","mando","manejar","manga","maniqui","manjar","mano","manso","manta","manana","mapa","maquina","mar","marco","marea","marfil","margen","marido","marmol","marron","martes","marzo","masa","mascara","masivo","matar","materia","matiz","matriz","maximo","mayor","mazorca","mecha","medalla","medio","medula","mejilla","mejor","melena","melon","memoria","menor","mensaje","mente","menu","mercado","merengue","merito","mes","meson","meta","meter","metodo","metro","mezcla","miedo","miel","miembro","miga","mil","milagro","militar","millon","mimo","mina","minero","minimo","minuto","miope","mirar","misa","miseria","misil","mismo","mitad","mito","mochila","mocion","moda","modelo","moho","mojar","molde","moler","molino","momento","momia","monarca","moneda","monja","monto","mono","morada","morder","moreno","morir","morro","morsa","mortal","mosca","mostrar","motivo","mover","movil","mozo","mucho","mudar","mueble","muela","muerte","muestra","mugre","mujer","mula","muleta","multa","mundo","muneca","mural","muro","musculo","museo","musgo","musica","muslo","nacar","nacion","nadar","naipe","naranja","nariz","narrar","nasal","natal","nativo","natural","nausea","naval","nave","navidad","necio","nectar","negar","negocio","negro","neon","nervio","neto","neutro","nevar","nevera","nicho","nido","niebla","nieto","ninez","nino","nitido","nivel","nobleza","noche","nomina","noria","norma","norte","nota","noticia","novato","novela","novio","nube","nuca","nucleo","nudillo","nudo","nuera","nueve","nuez","nulo","numero","nutria","oasis","obeso","obispo","objeto","obra","obrero","observar","obtener","obvio","oca","ocaso","oceano","ochenta","ocho","ocio","ocre","octavo","octubre","oculto","ocupar","ocurrir","odiar","odio","odisea","oeste","ofensa","oferta","oficio","ofrecer","ogro","oido","oir","ojo","ola","oleada","olfato","olivo","olla","olmo","olor","olvido","ombligo","onda","onza","opaco","opcion","opera","opinar","oponer","optar","optica","opuesto","oracion","orador","oral","orbita","orca","orden","oreja","organo","orgia","orgullo","oriente","origen","orilla","oro","orquesta","oruga","osadia","oscuro","osezno","oso","ostra","otono","otro","oveja","ovulo","oxido","oxigeno","oyente","ozono","pacto","padre","paella","pagina","pago","pais","pajaro","palabra","palco","paleta","palido","palma","paloma","palpar","pan","panal","panico","pantera","panuelo","papa","papel","papilla","paquete","parar","parcela","pared","parir","paro","parpado","parque","parrafo","parte","pasar","paseo","pasion","paso","pasta","pata","patio","patria","pausa","pauta","pavo","payaso","peaton","pecado","pecera","pecho","pedal","pedir","pegar","peine","pelar","peldano","pelea","peligro","pellejo","pelo","peluca","pena","pensar","penon","peon","peor","pepino","pequeno","pera","percha","perder","pereza","perfil","perico","perla","permiso","perro","persona","pesa","pesca","pesimo","pestana","petalo","petroleo","pez","pezuna","picar","pichon","pie","piedra","pierna","pieza","pijama","pilar","piloto","pimienta","pino","pintor","pinza","pina","piojo","pipa","pirata","pisar","piscina","piso","pista","piton","pizca","placa","plan","plata","playa","plaza","pleito","pleno","plomo","pluma","plural","pobre","poco","poder","podio","poema","poesia","poeta","polen","policia","pollo","polvo","pomada","pomelo","pomo","pompa","poner","porcion","portal","posada","poseer","posible","poste","potencia","potro","pozo","prado","precoz","pregunta","premio","prensa","preso","previo","primo","principe","prision","privar","proa","probar","proceso","producto","proeza","profesor","programa","prole","promesa","pronto","propio","proximo","prueba","publico","puchero","pudor","pueblo","puerta","puesto","pulga","pulir","pulmon","pulpo","pulso","puma","punto","punal","puno","pupa","pupila","pure","quedar","queja","quemar","querer","queso","quieto","quimica","quince","quitar","rabano","rabia","rabo","racion","radical","raiz","rama","rampa","rancho","rango","rapaz","rapido","rapto","rasgo","raspa","rato","rayo","raza","razon","reaccion","realidad","rebano","rebote","recaer","receta","rechazo","recoger","recreo","recto","recurso","red","redondo","reducir","reflejo","reforma","refran","refugio","regalo","regir","regla","regreso","rehen","reino","reir","reja","relato","relevo","relieve","relleno","reloj","remar","remedio","remo","rencor","rendir","renta","reparto","repetir","reposo","reptil","res","rescate","resina","respeto","resto","resumen","retiro","retorno","retrato","reunir","reves","revista","rey","rezar","rico","riego","rienda","riesgo","rifa","rigido","rigor","rincon","rinon","rio","riqueza","risa","ritmo","rito","rizo","roble","roce","rociar","rodar","rodeo","rodilla","roer","rojizo","rojo","romero","romper","ron","ronco","ronda","ropa","ropero","rosa","rosca","rostro","rotar","rubi","rubor","rudo","rueda","rugir","ruido","ruina","ruleta","rulo","rumbo","rumor","ruptura","ruta","rutina","sabado","saber","sabio","sable","sacar","sagaz","sagrado","sala","saldo","salero","salir","salmon","salon","salsa","salto","salud","salvar","samba","sancion","sandia","sanear","sangre","sanidad","sano","santo","sapo","saque","sardina","sarten","sastre","satan","sauna","saxofon","seccion","seco","secreto","secta","sed","seguir","seis","sello","selva","semana","semilla","senda","sensor","senal","senor","separar","sepia","sequia","ser","serie","sermon","servir","sesenta","sesion","seta","setenta","severo","sexo","sexto","sidra","siesta","siete","siglo","signo","silaba","silbar","silencio","silla","simbolo","simio","sirena","sistema","sitio","situar","sobre","socio","sodio","sol","solapa","soldado","soledad","solido","soltar","solucion","sombra","sondeo","sonido","sonoro","sonrisa","sopa","soplar","soporte","sordo","sorpresa","sorteo","sosten","sotano","suave","subir","suceso","sudor","suegra","suelo","sueno","suerte","sufrir","sujeto","sultan","sumar","superar","suplir","suponer","supremo","sur","surco","sureno","surgir","susto","sutil","tabaco","tabique","tabla","tabu","taco","tacto","tajo","talar","talco","talento","talla","talon","tamano","tambor","tango","tanque","tapa","tapete","tapia","tapon","taquilla","tarde","tarea","tarifa","tarjeta","tarot","tarro","tarta","tatuaje","tauro","taza","tazon","teatro","techo","tecla","tecnica","tejado","tejer","tejido","tela","telefono","tema","temor","templo","tenaz","tender","tener","tenis","tenso","teoria","terapia","terco","termino","ternura","terror","tesis","tesoro","testigo","tetera","texto","tez","tibio","tiburon","tiempo","tienda","tierra","tieso","tigre","tijera","tilde","timbre","timido","timo","tinta","tio","tipico","tipo","tira","tiron","titan","titere","titulo","tiza","toalla","tobillo","tocar","tocino","todo","toga","toldo","tomar","tono","tonto","topar","tope","toque","torax","torero","tormenta","torneo","toro","torpedo","torre","torso","tortuga","tos","tosco","toser","toxico","trabajo","tractor","traer","trafico","trago","traje","tramo","trance","trato","trauma","trazar","trebol","tregua","treinta","tren","trepar","tres","tribu","trigo","tripa","triste","triunfo","trofeo","trompa","tronco","tropa","trote","trozo","truco","trueno","trufa","tuberia","tubo","tuerto","tumba","tumor","tunel","tunica","turbina","turismo","turno","tutor","ubicar","ulcera","umbral","unidad","unir","universo","uno","untar","una","urbano","urbe","urgente","urna","usar","usuario","util","utopia","uva","vaca","vacio","vacuna","vagar","vago","vaina","vajilla","vale","valido","valle","valor","valvula","vampiro","vara","variar","varon","vaso","vecino","vector","vehiculo","veinte","vejez","vela","velero","veloz","vena","vencer","venda","veneno","vengar","venir","venta","venus","ver","verano","verbo","verde","vereda","verja","verso","verter","via","viaje","vibrar","vicio","victima","vida","video","vidrio","viejo","viernes","vigor","vil","villa","vinagre","vino","vinedo","violin","viral","virgo","virtud","visor","vispera","vista","vitamina","viudo","vivaz","vivero","vivir","vivo","volcan","volumen","volver","voraz","votar","voto","voz","vuelo","vulgar","yacer","yate","yegua","yema","yerno","yeso","yodo","yoga","yogur","zafiro","zanja","zapato","zarza","zona","zorro","zumo","zurdo"];module.exports=spanish},{}],117:[function(require,module,exports){!function(module,exports){"use strict";function assert(val,msg){if(!val)throw new Error(msg||"Assertion failed")}function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype,ctor.prototype=new TempCtor,ctor.prototype.constructor=ctor}function BN(number,base,endian){return BN.isBN(number)?number:(this.negative=0,this.words=null,this.length=0,this.red=null,void(null!==number&&("le"!==base&&"be"!==base||(endian=base,base=10),this._init(number||0,base||10,endian||"be"))))}function parseHex(str,start,end){for(var r=0,len=Math.min(str.length,end),i=start;i<len;i++){var c=str.charCodeAt(i)-48;r<<=4,r|=c>=49&&c<=54?c-49+10:c>=17&&c<=22?c-17+10:15&c}return r}function parseBase(str,start,end,mul){for(var r=0,len=Math.min(str.length,end),i=start;i<len;i++){var c=str.charCodeAt(i)-48;r*=mul,r+=c>=49?c-49+10:c>=17?c-17+10:c}return r}function toBitArray(num){for(var w=new Array(num.bitLength()),bit=0;bit<w.length;bit++){var off=bit/26|0,wbit=bit%26;w[bit]=(num.words[off]&1<<wbit)>>>wbit}return w}function smallMulTo(self,num,out){out.negative=num.negative^self.negative;var len=self.length+num.length|0;out.length=len,len=len-1|0;var a=0|self.words[0],b=0|num.words[0],r=a*b,lo=67108863&r,carry=r/67108864|0;out.words[0]=lo;for(var k=1;k<len;k++){for(var ncarry=carry>>>26,rword=67108863&carry,maxJ=Math.min(k,num.length-1),j=Math.max(0,k-self.length+1);j<=maxJ;j++){var i=k-j|0;a=0|self.words[i],b=0|num.words[j],r=a*b+rword,ncarry+=r/67108864|0,rword=67108863&r}out.words[k]=0|rword,carry=0|ncarry}return 0!==carry?out.words[k]=0|carry:out.length--,out.strip()}function bigMulTo(self,num,out){out.negative=num.negative^self.negative,out.length=self.length+num.length;for(var carry=0,hncarry=0,k=0;k<out.length-1;k++){var ncarry=hncarry;hncarry=0;for(var rword=67108863&carry,maxJ=Math.min(k,num.length-1),j=Math.max(0,k-self.length+1);j<=maxJ;j++){var i=k-j,a=0|self.words[i],b=0|num.words[j],r=a*b,lo=67108863&r;ncarry=ncarry+(r/67108864|0)|0,lo=lo+rword|0,rword=67108863&lo,ncarry=ncarry+(lo>>>26)|0,hncarry+=ncarry>>>26,ncarry&=67108863}out.words[k]=rword,carry=ncarry,ncarry=hncarry}return 0!==carry?out.words[k]=carry:out.length--,out.strip()}function jumboMulTo(self,num,out){var fftm=new FFTM;return fftm.mulp(self,num,out)}function FFTM(x,y){this.x=x,this.y=y}function MPrime(name,p){this.name=name,this.p=new BN(p,16),this.n=this.p.bitLength(),this.k=new BN(1).iushln(this.n).isub(this.p),this.tmp=this._tmp()}function K256(){MPrime.call(this,"k256","ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe fffffc2f")}function P224(){MPrime.call(this,"p224","ffffffff ffffffff ffffffff ffffffff 00000000 00000000 00000001")}function P192(){MPrime.call(this,"p192","ffffffff ffffffff ffffffff fffffffe ffffffff ffffffff")}function P25519(){MPrime.call(this,"25519","7fffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffed")}function Red(m){if("string"==typeof m){var prime=BN._prime(m);this.m=prime.p,this.prime=prime}else assert(m.gtn(1),"modulus must be greater than 1"),this.m=m,this.prime=null}function Mont(m){Red.call(this,m),this.shift=this.m.bitLength(),this.shift%26!==0&&(this.shift+=26-this.shift%26),this.r=new BN(1).iushln(this.shift),this.r2=this.imod(this.r.sqr()),this.rinv=this.r._invmp(this.m),this.minv=this.rinv.mul(this.r).isubn(1).div(this.m),this.minv=this.minv.umod(this.r),this.minv=this.r.sub(this.minv)}"object"==typeof module?module.exports=BN:exports.BN=BN,BN.BN=BN,BN.wordSize=26;var Buffer;try{Buffer=require("buffer").Buffer}catch(e){}BN.isBN=function(num){return num instanceof BN||null!==num&&"object"==typeof num&&num.constructor.wordSize===BN.wordSize&&Array.isArray(num.words)},BN.max=function(left,right){return left.cmp(right)>0?left:right},BN.min=function(left,right){return left.cmp(right)<0?left:right},BN.prototype._init=function(number,base,endian){if("number"==typeof number)return this._initNumber(number,base,endian);if("object"==typeof number)return this._initArray(number,base,endian);"hex"===base&&(base=16),assert(base===(0|base)&&base>=2&&base<=36),number=number.toString().replace(/\s+/g,"");var start=0;"-"===number[0]&&start++,16===base?this._parseHex(number,start):this._parseBase(number,base,start),"-"===number[0]&&(this.negative=1),this.strip(),"le"===endian&&this._initArray(this.toArray(),base,endian)},BN.prototype._initNumber=function(number,base,endian){number<0&&(this.negative=1,number=-number),number<67108864?(this.words=[67108863&number],this.length=1):number<4503599627370496?(this.words=[67108863&number,number/67108864&67108863],this.length=2):(assert(number<9007199254740992),this.words=[67108863&number,number/67108864&67108863,1],this.length=3),"le"===endian&&this._initArray(this.toArray(),base,endian)},BN.prototype._initArray=function(number,base,endian){if(assert("number"==typeof number.length),number.length<=0)return this.words=[0],this.length=1,this;this.length=Math.ceil(number.length/3),this.words=new Array(this.length);for(var i=0;i<this.length;i++)this.words[i]=0;var j,w,off=0;if("be"===endian)for(i=number.length-1,j=0;i>=0;i-=3)w=number[i]|number[i-1]<<8|number[i-2]<<16,this.words[j]|=w<<off&67108863,this.words[j+1]=w>>>26-off&67108863,off+=24,off>=26&&(off-=26,j++);else if("le"===endian)for(i=0,j=0;i<number.length;i+=3)w=number[i]|number[i+1]<<8|number[i+2]<<16,this.words[j]|=w<<off&67108863,this.words[j+1]=w>>>26-off&67108863,off+=24,off>=26&&(off-=26,j++);return this.strip()},BN.prototype._parseHex=function(number,start){this.length=Math.ceil((number.length-start)/6),this.words=new Array(this.length);for(var i=0;i<this.length;i++)this.words[i]=0;var j,w,off=0;for(i=number.length-6,j=0;i>=start;i-=6)w=parseHex(number,i,i+6),this.words[j]|=w<<off&67108863,this.words[j+1]|=w>>>26-off&4194303,off+=24,off>=26&&(off-=26,j++);i+6!==start&&(w=parseHex(number,start,i+6),this.words[j]|=w<<off&67108863,this.words[j+1]|=w>>>26-off&4194303),this.strip()},BN.prototype._parseBase=function(number,base,start){this.words=[0],this.length=1;for(var limbLen=0,limbPow=1;limbPow<=67108863;limbPow*=base)limbLen++;limbLen--,limbPow=limbPow/base|0;for(var total=number.length-start,mod=total%limbLen,end=Math.min(total,total-mod)+start,word=0,i=start;i<end;i+=limbLen)word=parseBase(number,i,i+limbLen,base),this.imuln(limbPow),this.words[0]+word<67108864?this.words[0]+=word:this._iaddn(word);if(0!==mod){var pow=1;for(word=parseBase(number,i,number.length,base),i=0;i<mod;i++)pow*=base;this.imuln(pow),this.words[0]+word<67108864?this.words[0]+=word:this._iaddn(word)}},BN.prototype.copy=function(dest){dest.words=new Array(this.length);for(var i=0;i<this.length;i++)dest.words[i]=this.words[i];dest.length=this.length,dest.negative=this.negative,dest.red=this.red},BN.prototype.clone=function(){var r=new BN(null);return this.copy(r),r},BN.prototype._expand=function(size){for(;this.length<size;)this.words[this.length++]=0;return this},BN.prototype.strip=function(){for(;this.length>1&&0===this.words[this.length-1];)this.length--;return this._normSign()},BN.prototype._normSign=function(){return 1===this.length&&0===this.words[0]&&(this.negative=0),this},BN.prototype.inspect=function(){return(this.red?"<BN-R: ":"<BN: ")+this.toString(16)+">"};var zeros=["","0","00","000","0000","00000","000000","0000000","00000000","000000000","0000000000","00000000000","000000000000","0000000000000","00000000000000","000000000000000","0000000000000000","00000000000000000","000000000000000000","0000000000000000000","00000000000000000000","000000000000000000000","0000000000000000000000","00000000000000000000000","000000000000000000000000","0000000000000000000000000"],groupSizes=[0,0,25,16,12,11,10,9,8,8,7,7,7,7,6,6,6,6,6,6,6,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],groupBases=[0,0,33554432,43046721,16777216,48828125,60466176,40353607,16777216,43046721,1e7,19487171,35831808,62748517,7529536,11390625,16777216,24137569,34012224,47045881,64e6,4084101,5153632,6436343,7962624,9765625,11881376,14348907,17210368,20511149,243e5,28629151,33554432,39135393,45435424,52521875,60466176];BN.prototype.toString=function(base,padding){base=base||10,padding=0|padding||1;var out;if(16===base||"hex"===base){out="";for(var off=0,carry=0,i=0;i<this.length;i++){var w=this.words[i],word=(16777215&(w<<off|carry)).toString(16);carry=w>>>24-off&16777215,out=0!==carry||i!==this.length-1?zeros[6-word.length]+word+out:word+out,off+=2,off>=26&&(off-=26,i--)}for(0!==carry&&(out=carry.toString(16)+out);out.length%padding!==0;)out="0"+out;return 0!==this.negative&&(out="-"+out),out}if(base===(0|base)&&base>=2&&base<=36){var groupSize=groupSizes[base],groupBase=groupBases[base];out="";var c=this.clone();for(c.negative=0;!c.isZero();){var r=c.modn(groupBase).toString(base);c=c.idivn(groupBase),out=c.isZero()?r+out:zeros[groupSize-r.length]+r+out}for(this.isZero()&&(out="0"+out);out.length%padding!==0;)out="0"+out;return 0!==this.negative&&(out="-"+out),out}assert(!1,"Base should be between 2 and 36")},BN.prototype.toNumber=function(){var ret=this.words[0];return 2===this.length?ret+=67108864*this.words[1]:3===this.length&&1===this.words[2]?ret+=4503599627370496+67108864*this.words[1]:this.length>2&&assert(!1,"Number can only safely store up to 53 bits"),0!==this.negative?-ret:ret},BN.prototype.toJSON=function(){return this.toString(16)},BN.prototype.toBuffer=function(endian,length){return assert("undefined"!=typeof Buffer),this.toArrayLike(Buffer,endian,length)},BN.prototype.toArray=function(endian,length){return this.toArrayLike(Array,endian,length)},BN.prototype.toArrayLike=function(ArrayType,endian,length){var byteLength=this.byteLength(),reqLength=length||Math.max(1,byteLength);assert(byteLength<=reqLength,"byte array longer than desired length"),assert(reqLength>0,"Requested array length <= 0"),this.strip();var b,i,littleEndian="le"===endian,res=new ArrayType(reqLength),q=this.clone();if(littleEndian){for(i=0;!q.isZero();i++)b=q.andln(255),q.iushrn(8),res[i]=b;for(;i<reqLength;i++)res[i]=0}else{for(i=0;i<reqLength-byteLength;i++)res[i]=0;for(i=0;!q.isZero();i++)b=q.andln(255),q.iushrn(8),res[reqLength-i-1]=b}return res},Math.clz32?BN.prototype._countBits=function(w){return 32-Math.clz32(w)}:BN.prototype._countBits=function(w){var t=w,r=0;return t>=4096&&(r+=13,t>>>=13),t>=64&&(r+=7,t>>>=7),t>=8&&(r+=4,t>>>=4),t>=2&&(r+=2,t>>>=2),r+t},BN.prototype._zeroBits=function(w){if(0===w)return 26;var t=w,r=0;return 0===(8191&t)&&(r+=13,t>>>=13),0===(127&t)&&(r+=7,t>>>=7),0===(15&t)&&(r+=4,t>>>=4),0===(3&t)&&(r+=2,t>>>=2),0===(1&t)&&r++,r},BN.prototype.bitLength=function(){var w=this.words[this.length-1],hi=this._countBits(w);return 26*(this.length-1)+hi},BN.prototype.zeroBits=function(){if(this.isZero())return 0;for(var r=0,i=0;i<this.length;i++){var b=this._zeroBits(this.words[i]);if(r+=b,26!==b)break}return r},BN.prototype.byteLength=function(){return Math.ceil(this.bitLength()/8)},BN.prototype.toTwos=function(width){return 0!==this.negative?this.abs().inotn(width).iaddn(1):this.clone()},BN.prototype.fromTwos=function(width){return this.testn(width-1)?this.notn(width).iaddn(1).ineg():this.clone()},BN.prototype.isNeg=function(){return 0!==this.negative},BN.prototype.neg=function(){return this.clone().ineg()},BN.prototype.ineg=function(){return this.isZero()||(this.negative^=1),this},BN.prototype.iuor=function(num){for(;this.length<num.length;)this.words[this.length++]=0;for(var i=0;i<num.length;i++)this.words[i]=this.words[i]|num.words[i];return this.strip()},BN.prototype.ior=function(num){return assert(0===(this.negative|num.negative)),this.iuor(num)},BN.prototype.or=function(num){return this.length>num.length?this.clone().ior(num):num.clone().ior(this)},BN.prototype.uor=function(num){return this.length>num.length?this.clone().iuor(num):num.clone().iuor(this)},BN.prototype.iuand=function(num){var b;b=this.length>num.length?num:this;for(var i=0;i<b.length;i++)this.words[i]=this.words[i]&num.words[i];return this.length=b.length,this.strip()},BN.prototype.iand=function(num){return assert(0===(this.negative|num.negative)),this.iuand(num)},BN.prototype.and=function(num){return this.length>num.length?this.clone().iand(num):num.clone().iand(this)},BN.prototype.uand=function(num){return this.length>num.length?this.clone().iuand(num):num.clone().iuand(this)},BN.prototype.iuxor=function(num){var a,b;this.length>num.length?(a=this,b=num):(a=num,b=this);for(var i=0;i<b.length;i++)this.words[i]=a.words[i]^b.words[i];if(this!==a)for(;i<a.length;i++)this.words[i]=a.words[i];return this.length=a.length,this.strip()},BN.prototype.ixor=function(num){return assert(0===(this.negative|num.negative)),this.iuxor(num)},BN.prototype.xor=function(num){return this.length>num.length?this.clone().ixor(num):num.clone().ixor(this)},BN.prototype.uxor=function(num){return this.length>num.length?this.clone().iuxor(num):num.clone().iuxor(this)},BN.prototype.inotn=function(width){assert("number"==typeof width&&width>=0);var bytesNeeded=0|Math.ceil(width/26),bitsLeft=width%26;this._expand(bytesNeeded),bitsLeft>0&&bytesNeeded--;for(var i=0;i<bytesNeeded;i++)this.words[i]=67108863&~this.words[i];return bitsLeft>0&&(this.words[i]=~this.words[i]&67108863>>26-bitsLeft),this.strip()},BN.prototype.notn=function(width){return this.clone().inotn(width)},BN.prototype.setn=function(bit,val){assert("number"==typeof bit&&bit>=0);var off=bit/26|0,wbit=bit%26;return this._expand(off+1),val?this.words[off]=this.words[off]|1<<wbit:this.words[off]=this.words[off]&~(1<<wbit),this.strip()},BN.prototype.iadd=function(num){var r;if(0!==this.negative&&0===num.negative)return this.negative=0,r=this.isub(num),this.negative^=1,this._normSign();if(0===this.negative&&0!==num.negative)return num.negative=0,r=this.isub(num),num.negative=1,r._normSign();var a,b;this.length>num.length?(a=this,b=num):(a=num,b=this);for(var carry=0,i=0;i<b.length;i++)r=(0|a.words[i])+(0|b.words[i])+carry,this.words[i]=67108863&r,carry=r>>>26;for(;0!==carry&&i<a.length;i++)r=(0|a.words[i])+carry,this.words[i]=67108863&r,carry=r>>>26;if(this.length=a.length,0!==carry)this.words[this.length]=carry,this.length++;else if(a!==this)for(;i<a.length;i++)this.words[i]=a.words[i];
return this},BN.prototype.add=function(num){var res;return 0!==num.negative&&0===this.negative?(num.negative=0,res=this.sub(num),num.negative^=1,res):0===num.negative&&0!==this.negative?(this.negative=0,res=num.sub(this),this.negative=1,res):this.length>num.length?this.clone().iadd(num):num.clone().iadd(this)},BN.prototype.isub=function(num){if(0!==num.negative){num.negative=0;var r=this.iadd(num);return num.negative=1,r._normSign()}if(0!==this.negative)return this.negative=0,this.iadd(num),this.negative=1,this._normSign();var cmp=this.cmp(num);if(0===cmp)return this.negative=0,this.length=1,this.words[0]=0,this;var a,b;cmp>0?(a=this,b=num):(a=num,b=this);for(var carry=0,i=0;i<b.length;i++)r=(0|a.words[i])-(0|b.words[i])+carry,carry=r>>26,this.words[i]=67108863&r;for(;0!==carry&&i<a.length;i++)r=(0|a.words[i])+carry,carry=r>>26,this.words[i]=67108863&r;if(0===carry&&i<a.length&&a!==this)for(;i<a.length;i++)this.words[i]=a.words[i];return this.length=Math.max(this.length,i),a!==this&&(this.negative=1),this.strip()},BN.prototype.sub=function(num){return this.clone().isub(num)};var comb10MulTo=function(self,num,out){var lo,mid,hi,a=self.words,b=num.words,o=out.words,c=0,a0=0|a[0],al0=8191&a0,ah0=a0>>>13,a1=0|a[1],al1=8191&a1,ah1=a1>>>13,a2=0|a[2],al2=8191&a2,ah2=a2>>>13,a3=0|a[3],al3=8191&a3,ah3=a3>>>13,a4=0|a[4],al4=8191&a4,ah4=a4>>>13,a5=0|a[5],al5=8191&a5,ah5=a5>>>13,a6=0|a[6],al6=8191&a6,ah6=a6>>>13,a7=0|a[7],al7=8191&a7,ah7=a7>>>13,a8=0|a[8],al8=8191&a8,ah8=a8>>>13,a9=0|a[9],al9=8191&a9,ah9=a9>>>13,b0=0|b[0],bl0=8191&b0,bh0=b0>>>13,b1=0|b[1],bl1=8191&b1,bh1=b1>>>13,b2=0|b[2],bl2=8191&b2,bh2=b2>>>13,b3=0|b[3],bl3=8191&b3,bh3=b3>>>13,b4=0|b[4],bl4=8191&b4,bh4=b4>>>13,b5=0|b[5],bl5=8191&b5,bh5=b5>>>13,b6=0|b[6],bl6=8191&b6,bh6=b6>>>13,b7=0|b[7],bl7=8191&b7,bh7=b7>>>13,b8=0|b[8],bl8=8191&b8,bh8=b8>>>13,b9=0|b[9],bl9=8191&b9,bh9=b9>>>13;out.negative=self.negative^num.negative,out.length=19,lo=Math.imul(al0,bl0),mid=Math.imul(al0,bh0),mid=mid+Math.imul(ah0,bl0)|0,hi=Math.imul(ah0,bh0);var w0=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w0>>>26)|0,w0&=67108863,lo=Math.imul(al1,bl0),mid=Math.imul(al1,bh0),mid=mid+Math.imul(ah1,bl0)|0,hi=Math.imul(ah1,bh0),lo=lo+Math.imul(al0,bl1)|0,mid=mid+Math.imul(al0,bh1)|0,mid=mid+Math.imul(ah0,bl1)|0,hi=hi+Math.imul(ah0,bh1)|0;var w1=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w1>>>26)|0,w1&=67108863,lo=Math.imul(al2,bl0),mid=Math.imul(al2,bh0),mid=mid+Math.imul(ah2,bl0)|0,hi=Math.imul(ah2,bh0),lo=lo+Math.imul(al1,bl1)|0,mid=mid+Math.imul(al1,bh1)|0,mid=mid+Math.imul(ah1,bl1)|0,hi=hi+Math.imul(ah1,bh1)|0,lo=lo+Math.imul(al0,bl2)|0,mid=mid+Math.imul(al0,bh2)|0,mid=mid+Math.imul(ah0,bl2)|0,hi=hi+Math.imul(ah0,bh2)|0;var w2=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w2>>>26)|0,w2&=67108863,lo=Math.imul(al3,bl0),mid=Math.imul(al3,bh0),mid=mid+Math.imul(ah3,bl0)|0,hi=Math.imul(ah3,bh0),lo=lo+Math.imul(al2,bl1)|0,mid=mid+Math.imul(al2,bh1)|0,mid=mid+Math.imul(ah2,bl1)|0,hi=hi+Math.imul(ah2,bh1)|0,lo=lo+Math.imul(al1,bl2)|0,mid=mid+Math.imul(al1,bh2)|0,mid=mid+Math.imul(ah1,bl2)|0,hi=hi+Math.imul(ah1,bh2)|0,lo=lo+Math.imul(al0,bl3)|0,mid=mid+Math.imul(al0,bh3)|0,mid=mid+Math.imul(ah0,bl3)|0,hi=hi+Math.imul(ah0,bh3)|0;var w3=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w3>>>26)|0,w3&=67108863,lo=Math.imul(al4,bl0),mid=Math.imul(al4,bh0),mid=mid+Math.imul(ah4,bl0)|0,hi=Math.imul(ah4,bh0),lo=lo+Math.imul(al3,bl1)|0,mid=mid+Math.imul(al3,bh1)|0,mid=mid+Math.imul(ah3,bl1)|0,hi=hi+Math.imul(ah3,bh1)|0,lo=lo+Math.imul(al2,bl2)|0,mid=mid+Math.imul(al2,bh2)|0,mid=mid+Math.imul(ah2,bl2)|0,hi=hi+Math.imul(ah2,bh2)|0,lo=lo+Math.imul(al1,bl3)|0,mid=mid+Math.imul(al1,bh3)|0,mid=mid+Math.imul(ah1,bl3)|0,hi=hi+Math.imul(ah1,bh3)|0,lo=lo+Math.imul(al0,bl4)|0,mid=mid+Math.imul(al0,bh4)|0,mid=mid+Math.imul(ah0,bl4)|0,hi=hi+Math.imul(ah0,bh4)|0;var w4=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w4>>>26)|0,w4&=67108863,lo=Math.imul(al5,bl0),mid=Math.imul(al5,bh0),mid=mid+Math.imul(ah5,bl0)|0,hi=Math.imul(ah5,bh0),lo=lo+Math.imul(al4,bl1)|0,mid=mid+Math.imul(al4,bh1)|0,mid=mid+Math.imul(ah4,bl1)|0,hi=hi+Math.imul(ah4,bh1)|0,lo=lo+Math.imul(al3,bl2)|0,mid=mid+Math.imul(al3,bh2)|0,mid=mid+Math.imul(ah3,bl2)|0,hi=hi+Math.imul(ah3,bh2)|0,lo=lo+Math.imul(al2,bl3)|0,mid=mid+Math.imul(al2,bh3)|0,mid=mid+Math.imul(ah2,bl3)|0,hi=hi+Math.imul(ah2,bh3)|0,lo=lo+Math.imul(al1,bl4)|0,mid=mid+Math.imul(al1,bh4)|0,mid=mid+Math.imul(ah1,bl4)|0,hi=hi+Math.imul(ah1,bh4)|0,lo=lo+Math.imul(al0,bl5)|0,mid=mid+Math.imul(al0,bh5)|0,mid=mid+Math.imul(ah0,bl5)|0,hi=hi+Math.imul(ah0,bh5)|0;var w5=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w5>>>26)|0,w5&=67108863,lo=Math.imul(al6,bl0),mid=Math.imul(al6,bh0),mid=mid+Math.imul(ah6,bl0)|0,hi=Math.imul(ah6,bh0),lo=lo+Math.imul(al5,bl1)|0,mid=mid+Math.imul(al5,bh1)|0,mid=mid+Math.imul(ah5,bl1)|0,hi=hi+Math.imul(ah5,bh1)|0,lo=lo+Math.imul(al4,bl2)|0,mid=mid+Math.imul(al4,bh2)|0,mid=mid+Math.imul(ah4,bl2)|0,hi=hi+Math.imul(ah4,bh2)|0,lo=lo+Math.imul(al3,bl3)|0,mid=mid+Math.imul(al3,bh3)|0,mid=mid+Math.imul(ah3,bl3)|0,hi=hi+Math.imul(ah3,bh3)|0,lo=lo+Math.imul(al2,bl4)|0,mid=mid+Math.imul(al2,bh4)|0,mid=mid+Math.imul(ah2,bl4)|0,hi=hi+Math.imul(ah2,bh4)|0,lo=lo+Math.imul(al1,bl5)|0,mid=mid+Math.imul(al1,bh5)|0,mid=mid+Math.imul(ah1,bl5)|0,hi=hi+Math.imul(ah1,bh5)|0,lo=lo+Math.imul(al0,bl6)|0,mid=mid+Math.imul(al0,bh6)|0,mid=mid+Math.imul(ah0,bl6)|0,hi=hi+Math.imul(ah0,bh6)|0;var w6=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w6>>>26)|0,w6&=67108863,lo=Math.imul(al7,bl0),mid=Math.imul(al7,bh0),mid=mid+Math.imul(ah7,bl0)|0,hi=Math.imul(ah7,bh0),lo=lo+Math.imul(al6,bl1)|0,mid=mid+Math.imul(al6,bh1)|0,mid=mid+Math.imul(ah6,bl1)|0,hi=hi+Math.imul(ah6,bh1)|0,lo=lo+Math.imul(al5,bl2)|0,mid=mid+Math.imul(al5,bh2)|0,mid=mid+Math.imul(ah5,bl2)|0,hi=hi+Math.imul(ah5,bh2)|0,lo=lo+Math.imul(al4,bl3)|0,mid=mid+Math.imul(al4,bh3)|0,mid=mid+Math.imul(ah4,bl3)|0,hi=hi+Math.imul(ah4,bh3)|0,lo=lo+Math.imul(al3,bl4)|0,mid=mid+Math.imul(al3,bh4)|0,mid=mid+Math.imul(ah3,bl4)|0,hi=hi+Math.imul(ah3,bh4)|0,lo=lo+Math.imul(al2,bl5)|0,mid=mid+Math.imul(al2,bh5)|0,mid=mid+Math.imul(ah2,bl5)|0,hi=hi+Math.imul(ah2,bh5)|0,lo=lo+Math.imul(al1,bl6)|0,mid=mid+Math.imul(al1,bh6)|0,mid=mid+Math.imul(ah1,bl6)|0,hi=hi+Math.imul(ah1,bh6)|0,lo=lo+Math.imul(al0,bl7)|0,mid=mid+Math.imul(al0,bh7)|0,mid=mid+Math.imul(ah0,bl7)|0,hi=hi+Math.imul(ah0,bh7)|0;var w7=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w7>>>26)|0,w7&=67108863,lo=Math.imul(al8,bl0),mid=Math.imul(al8,bh0),mid=mid+Math.imul(ah8,bl0)|0,hi=Math.imul(ah8,bh0),lo=lo+Math.imul(al7,bl1)|0,mid=mid+Math.imul(al7,bh1)|0,mid=mid+Math.imul(ah7,bl1)|0,hi=hi+Math.imul(ah7,bh1)|0,lo=lo+Math.imul(al6,bl2)|0,mid=mid+Math.imul(al6,bh2)|0,mid=mid+Math.imul(ah6,bl2)|0,hi=hi+Math.imul(ah6,bh2)|0,lo=lo+Math.imul(al5,bl3)|0,mid=mid+Math.imul(al5,bh3)|0,mid=mid+Math.imul(ah5,bl3)|0,hi=hi+Math.imul(ah5,bh3)|0,lo=lo+Math.imul(al4,bl4)|0,mid=mid+Math.imul(al4,bh4)|0,mid=mid+Math.imul(ah4,bl4)|0,hi=hi+Math.imul(ah4,bh4)|0,lo=lo+Math.imul(al3,bl5)|0,mid=mid+Math.imul(al3,bh5)|0,mid=mid+Math.imul(ah3,bl5)|0,hi=hi+Math.imul(ah3,bh5)|0,lo=lo+Math.imul(al2,bl6)|0,mid=mid+Math.imul(al2,bh6)|0,mid=mid+Math.imul(ah2,bl6)|0,hi=hi+Math.imul(ah2,bh6)|0,lo=lo+Math.imul(al1,bl7)|0,mid=mid+Math.imul(al1,bh7)|0,mid=mid+Math.imul(ah1,bl7)|0,hi=hi+Math.imul(ah1,bh7)|0,lo=lo+Math.imul(al0,bl8)|0,mid=mid+Math.imul(al0,bh8)|0,mid=mid+Math.imul(ah0,bl8)|0,hi=hi+Math.imul(ah0,bh8)|0;var w8=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w8>>>26)|0,w8&=67108863,lo=Math.imul(al9,bl0),mid=Math.imul(al9,bh0),mid=mid+Math.imul(ah9,bl0)|0,hi=Math.imul(ah9,bh0),lo=lo+Math.imul(al8,bl1)|0,mid=mid+Math.imul(al8,bh1)|0,mid=mid+Math.imul(ah8,bl1)|0,hi=hi+Math.imul(ah8,bh1)|0,lo=lo+Math.imul(al7,bl2)|0,mid=mid+Math.imul(al7,bh2)|0,mid=mid+Math.imul(ah7,bl2)|0,hi=hi+Math.imul(ah7,bh2)|0,lo=lo+Math.imul(al6,bl3)|0,mid=mid+Math.imul(al6,bh3)|0,mid=mid+Math.imul(ah6,bl3)|0,hi=hi+Math.imul(ah6,bh3)|0,lo=lo+Math.imul(al5,bl4)|0,mid=mid+Math.imul(al5,bh4)|0,mid=mid+Math.imul(ah5,bl4)|0,hi=hi+Math.imul(ah5,bh4)|0,lo=lo+Math.imul(al4,bl5)|0,mid=mid+Math.imul(al4,bh5)|0,mid=mid+Math.imul(ah4,bl5)|0,hi=hi+Math.imul(ah4,bh5)|0,lo=lo+Math.imul(al3,bl6)|0,mid=mid+Math.imul(al3,bh6)|0,mid=mid+Math.imul(ah3,bl6)|0,hi=hi+Math.imul(ah3,bh6)|0,lo=lo+Math.imul(al2,bl7)|0,mid=mid+Math.imul(al2,bh7)|0,mid=mid+Math.imul(ah2,bl7)|0,hi=hi+Math.imul(ah2,bh7)|0,lo=lo+Math.imul(al1,bl8)|0,mid=mid+Math.imul(al1,bh8)|0,mid=mid+Math.imul(ah1,bl8)|0,hi=hi+Math.imul(ah1,bh8)|0,lo=lo+Math.imul(al0,bl9)|0,mid=mid+Math.imul(al0,bh9)|0,mid=mid+Math.imul(ah0,bl9)|0,hi=hi+Math.imul(ah0,bh9)|0;var w9=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w9>>>26)|0,w9&=67108863,lo=Math.imul(al9,bl1),mid=Math.imul(al9,bh1),mid=mid+Math.imul(ah9,bl1)|0,hi=Math.imul(ah9,bh1),lo=lo+Math.imul(al8,bl2)|0,mid=mid+Math.imul(al8,bh2)|0,mid=mid+Math.imul(ah8,bl2)|0,hi=hi+Math.imul(ah8,bh2)|0,lo=lo+Math.imul(al7,bl3)|0,mid=mid+Math.imul(al7,bh3)|0,mid=mid+Math.imul(ah7,bl3)|0,hi=hi+Math.imul(ah7,bh3)|0,lo=lo+Math.imul(al6,bl4)|0,mid=mid+Math.imul(al6,bh4)|0,mid=mid+Math.imul(ah6,bl4)|0,hi=hi+Math.imul(ah6,bh4)|0,lo=lo+Math.imul(al5,bl5)|0,mid=mid+Math.imul(al5,bh5)|0,mid=mid+Math.imul(ah5,bl5)|0,hi=hi+Math.imul(ah5,bh5)|0,lo=lo+Math.imul(al4,bl6)|0,mid=mid+Math.imul(al4,bh6)|0,mid=mid+Math.imul(ah4,bl6)|0,hi=hi+Math.imul(ah4,bh6)|0,lo=lo+Math.imul(al3,bl7)|0,mid=mid+Math.imul(al3,bh7)|0,mid=mid+Math.imul(ah3,bl7)|0,hi=hi+Math.imul(ah3,bh7)|0,lo=lo+Math.imul(al2,bl8)|0,mid=mid+Math.imul(al2,bh8)|0,mid=mid+Math.imul(ah2,bl8)|0,hi=hi+Math.imul(ah2,bh8)|0,lo=lo+Math.imul(al1,bl9)|0,mid=mid+Math.imul(al1,bh9)|0,mid=mid+Math.imul(ah1,bl9)|0,hi=hi+Math.imul(ah1,bh9)|0;var w10=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w10>>>26)|0,w10&=67108863,lo=Math.imul(al9,bl2),mid=Math.imul(al9,bh2),mid=mid+Math.imul(ah9,bl2)|0,hi=Math.imul(ah9,bh2),lo=lo+Math.imul(al8,bl3)|0,mid=mid+Math.imul(al8,bh3)|0,mid=mid+Math.imul(ah8,bl3)|0,hi=hi+Math.imul(ah8,bh3)|0,lo=lo+Math.imul(al7,bl4)|0,mid=mid+Math.imul(al7,bh4)|0,mid=mid+Math.imul(ah7,bl4)|0,hi=hi+Math.imul(ah7,bh4)|0,lo=lo+Math.imul(al6,bl5)|0,mid=mid+Math.imul(al6,bh5)|0,mid=mid+Math.imul(ah6,bl5)|0,hi=hi+Math.imul(ah6,bh5)|0,lo=lo+Math.imul(al5,bl6)|0,mid=mid+Math.imul(al5,bh6)|0,mid=mid+Math.imul(ah5,bl6)|0,hi=hi+Math.imul(ah5,bh6)|0,lo=lo+Math.imul(al4,bl7)|0,mid=mid+Math.imul(al4,bh7)|0,mid=mid+Math.imul(ah4,bl7)|0,hi=hi+Math.imul(ah4,bh7)|0,lo=lo+Math.imul(al3,bl8)|0,mid=mid+Math.imul(al3,bh8)|0,mid=mid+Math.imul(ah3,bl8)|0,hi=hi+Math.imul(ah3,bh8)|0,lo=lo+Math.imul(al2,bl9)|0,mid=mid+Math.imul(al2,bh9)|0,mid=mid+Math.imul(ah2,bl9)|0,hi=hi+Math.imul(ah2,bh9)|0;var w11=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w11>>>26)|0,w11&=67108863,lo=Math.imul(al9,bl3),mid=Math.imul(al9,bh3),mid=mid+Math.imul(ah9,bl3)|0,hi=Math.imul(ah9,bh3),lo=lo+Math.imul(al8,bl4)|0,mid=mid+Math.imul(al8,bh4)|0,mid=mid+Math.imul(ah8,bl4)|0,hi=hi+Math.imul(ah8,bh4)|0,lo=lo+Math.imul(al7,bl5)|0,mid=mid+Math.imul(al7,bh5)|0,mid=mid+Math.imul(ah7,bl5)|0,hi=hi+Math.imul(ah7,bh5)|0,lo=lo+Math.imul(al6,bl6)|0,mid=mid+Math.imul(al6,bh6)|0,mid=mid+Math.imul(ah6,bl6)|0,hi=hi+Math.imul(ah6,bh6)|0,lo=lo+Math.imul(al5,bl7)|0,mid=mid+Math.imul(al5,bh7)|0,mid=mid+Math.imul(ah5,bl7)|0,hi=hi+Math.imul(ah5,bh7)|0,lo=lo+Math.imul(al4,bl8)|0,mid=mid+Math.imul(al4,bh8)|0,mid=mid+Math.imul(ah4,bl8)|0,hi=hi+Math.imul(ah4,bh8)|0,lo=lo+Math.imul(al3,bl9)|0,mid=mid+Math.imul(al3,bh9)|0,mid=mid+Math.imul(ah3,bl9)|0,hi=hi+Math.imul(ah3,bh9)|0;var w12=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w12>>>26)|0,w12&=67108863,lo=Math.imul(al9,bl4),mid=Math.imul(al9,bh4),mid=mid+Math.imul(ah9,bl4)|0,hi=Math.imul(ah9,bh4),lo=lo+Math.imul(al8,bl5)|0,mid=mid+Math.imul(al8,bh5)|0,mid=mid+Math.imul(ah8,bl5)|0,hi=hi+Math.imul(ah8,bh5)|0,lo=lo+Math.imul(al7,bl6)|0,mid=mid+Math.imul(al7,bh6)|0,mid=mid+Math.imul(ah7,bl6)|0,hi=hi+Math.imul(ah7,bh6)|0,lo=lo+Math.imul(al6,bl7)|0,mid=mid+Math.imul(al6,bh7)|0,mid=mid+Math.imul(ah6,bl7)|0,hi=hi+Math.imul(ah6,bh7)|0,lo=lo+Math.imul(al5,bl8)|0,mid=mid+Math.imul(al5,bh8)|0,mid=mid+Math.imul(ah5,bl8)|0,hi=hi+Math.imul(ah5,bh8)|0,lo=lo+Math.imul(al4,bl9)|0,mid=mid+Math.imul(al4,bh9)|0,mid=mid+Math.imul(ah4,bl9)|0,hi=hi+Math.imul(ah4,bh9)|0;var w13=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w13>>>26)|0,w13&=67108863,lo=Math.imul(al9,bl5),mid=Math.imul(al9,bh5),mid=mid+Math.imul(ah9,bl5)|0,hi=Math.imul(ah9,bh5),lo=lo+Math.imul(al8,bl6)|0,mid=mid+Math.imul(al8,bh6)|0,mid=mid+Math.imul(ah8,bl6)|0,hi=hi+Math.imul(ah8,bh6)|0,lo=lo+Math.imul(al7,bl7)|0,mid=mid+Math.imul(al7,bh7)|0,mid=mid+Math.imul(ah7,bl7)|0,hi=hi+Math.imul(ah7,bh7)|0,lo=lo+Math.imul(al6,bl8)|0,mid=mid+Math.imul(al6,bh8)|0,mid=mid+Math.imul(ah6,bl8)|0,hi=hi+Math.imul(ah6,bh8)|0,lo=lo+Math.imul(al5,bl9)|0,mid=mid+Math.imul(al5,bh9)|0,mid=mid+Math.imul(ah5,bl9)|0,hi=hi+Math.imul(ah5,bh9)|0;var w14=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w14>>>26)|0,w14&=67108863,lo=Math.imul(al9,bl6),mid=Math.imul(al9,bh6),mid=mid+Math.imul(ah9,bl6)|0,hi=Math.imul(ah9,bh6),lo=lo+Math.imul(al8,bl7)|0,mid=mid+Math.imul(al8,bh7)|0,mid=mid+Math.imul(ah8,bl7)|0,hi=hi+Math.imul(ah8,bh7)|0,lo=lo+Math.imul(al7,bl8)|0,mid=mid+Math.imul(al7,bh8)|0,mid=mid+Math.imul(ah7,bl8)|0,hi=hi+Math.imul(ah7,bh8)|0,lo=lo+Math.imul(al6,bl9)|0,mid=mid+Math.imul(al6,bh9)|0,mid=mid+Math.imul(ah6,bl9)|0,hi=hi+Math.imul(ah6,bh9)|0;var w15=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w15>>>26)|0,w15&=67108863,lo=Math.imul(al9,bl7),mid=Math.imul(al9,bh7),mid=mid+Math.imul(ah9,bl7)|0,hi=Math.imul(ah9,bh7),lo=lo+Math.imul(al8,bl8)|0,mid=mid+Math.imul(al8,bh8)|0,mid=mid+Math.imul(ah8,bl8)|0,hi=hi+Math.imul(ah8,bh8)|0,lo=lo+Math.imul(al7,bl9)|0,mid=mid+Math.imul(al7,bh9)|0,mid=mid+Math.imul(ah7,bl9)|0,hi=hi+Math.imul(ah7,bh9)|0;var w16=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w16>>>26)|0,w16&=67108863,lo=Math.imul(al9,bl8),mid=Math.imul(al9,bh8),mid=mid+Math.imul(ah9,bl8)|0,hi=Math.imul(ah9,bh8),lo=lo+Math.imul(al8,bl9)|0,mid=mid+Math.imul(al8,bh9)|0,mid=mid+Math.imul(ah8,bl9)|0,hi=hi+Math.imul(ah8,bh9)|0;var w17=(c+lo|0)+((8191&mid)<<13)|0;c=(hi+(mid>>>13)|0)+(w17>>>26)|0,w17&=67108863,lo=Math.imul(al9,bl9),mid=Math.imul(al9,bh9),mid=mid+Math.imul(ah9,bl9)|0,hi=Math.imul(ah9,bh9);var w18=(c+lo|0)+((8191&mid)<<13)|0;return c=(hi+(mid>>>13)|0)+(w18>>>26)|0,w18&=67108863,o[0]=w0,o[1]=w1,o[2]=w2,o[3]=w3,o[4]=w4,o[5]=w5,o[6]=w6,o[7]=w7,o[8]=w8,o[9]=w9,o[10]=w10,o[11]=w11,o[12]=w12,o[13]=w13,o[14]=w14,o[15]=w15,o[16]=w16,o[17]=w17,o[18]=w18,0!==c&&(o[19]=c,out.length++),out};Math.imul||(comb10MulTo=smallMulTo),BN.prototype.mulTo=function(num,out){var res,len=this.length+num.length;return res=10===this.length&&10===num.length?comb10MulTo(this,num,out):len<63?smallMulTo(this,num,out):len<1024?bigMulTo(this,num,out):jumboMulTo(this,num,out)},FFTM.prototype.makeRBT=function(N){for(var t=new Array(N),l=BN.prototype._countBits(N)-1,i=0;i<N;i++)t[i]=this.revBin(i,l,N);return t},FFTM.prototype.revBin=function(x,l,N){if(0===x||x===N-1)return x;for(var rb=0,i=0;i<l;i++)rb|=(1&x)<<l-i-1,x>>=1;return rb},FFTM.prototype.permute=function(rbt,rws,iws,rtws,itws,N){for(var i=0;i<N;i++)rtws[i]=rws[rbt[i]],itws[i]=iws[rbt[i]]},FFTM.prototype.transform=function(rws,iws,rtws,itws,N,rbt){this.permute(rbt,rws,iws,rtws,itws,N);for(var s=1;s<N;s<<=1)for(var l=s<<1,rtwdf=Math.cos(2*Math.PI/l),itwdf=Math.sin(2*Math.PI/l),p=0;p<N;p+=l)for(var rtwdf_=rtwdf,itwdf_=itwdf,j=0;j<s;j++){var re=rtws[p+j],ie=itws[p+j],ro=rtws[p+j+s],io=itws[p+j+s],rx=rtwdf_*ro-itwdf_*io;io=rtwdf_*io+itwdf_*ro,ro=rx,rtws[p+j]=re+ro,itws[p+j]=ie+io,rtws[p+j+s]=re-ro,itws[p+j+s]=ie-io,j!==l&&(rx=rtwdf*rtwdf_-itwdf*itwdf_,itwdf_=rtwdf*itwdf_+itwdf*rtwdf_,rtwdf_=rx)}},FFTM.prototype.guessLen13b=function(n,m){var N=1|Math.max(m,n),odd=1&N,i=0;for(N=N/2|0;N;N>>>=1)i++;return 1<<i+1+odd},FFTM.prototype.conjugate=function(rws,iws,N){if(!(N<=1))for(var i=0;i<N/2;i++){var t=rws[i];rws[i]=rws[N-i-1],rws[N-i-1]=t,t=iws[i],iws[i]=-iws[N-i-1],iws[N-i-1]=-t}},FFTM.prototype.normalize13b=function(ws,N){for(var carry=0,i=0;i<N/2;i++){var w=8192*Math.round(ws[2*i+1]/N)+Math.round(ws[2*i]/N)+carry;ws[i]=67108863&w,carry=w<67108864?0:w/67108864|0}return ws},FFTM.prototype.convert13b=function(ws,len,rws,N){for(var carry=0,i=0;i<len;i++)carry+=0|ws[i],rws[2*i]=8191&carry,carry>>>=13,rws[2*i+1]=8191&carry,carry>>>=13;for(i=2*len;i<N;++i)rws[i]=0;assert(0===carry),assert(0===(carry&-8192))},FFTM.prototype.stub=function(N){for(var ph=new Array(N),i=0;i<N;i++)ph[i]=0;return ph},FFTM.prototype.mulp=function(x,y,out){var N=2*this.guessLen13b(x.length,y.length),rbt=this.makeRBT(N),_=this.stub(N),rws=new Array(N),rwst=new Array(N),iwst=new Array(N),nrws=new Array(N),nrwst=new Array(N),niwst=new Array(N),rmws=out.words;rmws.length=N,this.convert13b(x.words,x.length,rws,N),this.convert13b(y.words,y.length,nrws,N),this.transform(rws,_,rwst,iwst,N,rbt),this.transform(nrws,_,nrwst,niwst,N,rbt);for(var i=0;i<N;i++){var rx=rwst[i]*nrwst[i]-iwst[i]*niwst[i];iwst[i]=rwst[i]*niwst[i]+iwst[i]*nrwst[i],rwst[i]=rx}return this.conjugate(rwst,iwst,N),this.transform(rwst,iwst,rmws,_,N,rbt),this.conjugate(rmws,_,N),this.normalize13b(rmws,N),out.negative=x.negative^y.negative,out.length=x.length+y.length,out.strip()},BN.prototype.mul=function(num){var out=new BN(null);return out.words=new Array(this.length+num.length),this.mulTo(num,out)},BN.prototype.mulf=function(num){var out=new BN(null);return out.words=new Array(this.length+num.length),jumboMulTo(this,num,out)},BN.prototype.imul=function(num){return this.clone().mulTo(num,this)},BN.prototype.imuln=function(num){assert("number"==typeof num),assert(num<67108864);for(var carry=0,i=0;i<this.length;i++){var w=(0|this.words[i])*num,lo=(67108863&w)+(67108863&carry);carry>>=26,carry+=w/67108864|0,carry+=lo>>>26,this.words[i]=67108863&lo}return 0!==carry&&(this.words[i]=carry,this.length++),this},BN.prototype.muln=function(num){return this.clone().imuln(num)},BN.prototype.sqr=function(){return this.mul(this)},BN.prototype.isqr=function(){return this.imul(this.clone())},BN.prototype.pow=function(num){var w=toBitArray(num);if(0===w.length)return new BN(1);for(var res=this,i=0;i<w.length&&0===w[i];i++,res=res.sqr());if(++i<w.length)for(var q=res.sqr();i<w.length;i++,q=q.sqr())0!==w[i]&&(res=res.mul(q));return res},BN.prototype.iushln=function(bits){assert("number"==typeof bits&&bits>=0);var i,r=bits%26,s=(bits-r)/26,carryMask=67108863>>>26-r<<26-r;if(0!==r){var carry=0;for(i=0;i<this.length;i++){var newCarry=this.words[i]&carryMask,c=(0|this.words[i])-newCarry<<r;this.words[i]=c|carry,carry=newCarry>>>26-r}carry&&(this.words[i]=carry,this.length++)}if(0!==s){for(i=this.length-1;i>=0;i--)this.words[i+s]=this.words[i];for(i=0;i<s;i++)this.words[i]=0;this.length+=s}return this.strip()},BN.prototype.ishln=function(bits){return assert(0===this.negative),this.iushln(bits)},BN.prototype.iushrn=function(bits,hint,extended){assert("number"==typeof bits&&bits>=0);var h;h=hint?(hint-hint%26)/26:0;var r=bits%26,s=Math.min((bits-r)/26,this.length),mask=67108863^67108863>>>r<<r,maskedWords=extended;if(h-=s,h=Math.max(0,h),maskedWords){for(var i=0;i<s;i++)maskedWords.words[i]=this.words[i];maskedWords.length=s}if(0===s);else if(this.length>s)for(this.length-=s,i=0;i<this.length;i++)this.words[i]=this.words[i+s];else this.words[0]=0,this.length=1;var carry=0;for(i=this.length-1;i>=0&&(0!==carry||i>=h);i--){var word=0|this.words[i];this.words[i]=carry<<26-r|word>>>r,carry=word&mask}return maskedWords&&0!==carry&&(maskedWords.words[maskedWords.length++]=carry),0===this.length&&(this.words[0]=0,this.length=1),this.strip()},BN.prototype.ishrn=function(bits,hint,extended){return assert(0===this.negative),this.iushrn(bits,hint,extended)},BN.prototype.shln=function(bits){return this.clone().ishln(bits)},BN.prototype.ushln=function(bits){return this.clone().iushln(bits)},BN.prototype.shrn=function(bits){return this.clone().ishrn(bits)},BN.prototype.ushrn=function(bits){return this.clone().iushrn(bits)},BN.prototype.testn=function(bit){assert("number"==typeof bit&&bit>=0);var r=bit%26,s=(bit-r)/26,q=1<<r;if(this.length<=s)return!1;var w=this.words[s];return!!(w&q)},BN.prototype.imaskn=function(bits){assert("number"==typeof bits&&bits>=0);var r=bits%26,s=(bits-r)/26;if(assert(0===this.negative,"imaskn works only with positive numbers"),this.length<=s)return this;if(0!==r&&s++,this.length=Math.min(s,this.length),0!==r){var mask=67108863^67108863>>>r<<r;this.words[this.length-1]&=mask}return this.strip()},BN.prototype.maskn=function(bits){return this.clone().imaskn(bits)},BN.prototype.iaddn=function(num){return assert("number"==typeof num),assert(num<67108864),num<0?this.isubn(-num):0!==this.negative?1===this.length&&(0|this.words[0])<num?(this.words[0]=num-(0|this.words[0]),this.negative=0,this):(this.negative=0,this.isubn(num),this.negative=1,this):this._iaddn(num)},BN.prototype._iaddn=function(num){this.words[0]+=num;for(var i=0;i<this.length&&this.words[i]>=67108864;i++)this.words[i]-=67108864,i===this.length-1?this.words[i+1]=1:this.words[i+1]++;return this.length=Math.max(this.length,i+1),this},BN.prototype.isubn=function(num){if(assert("number"==typeof num),assert(num<67108864),num<0)return this.iaddn(-num);if(0!==this.negative)return this.negative=0,this.iaddn(num),this.negative=1,this;if(this.words[0]-=num,1===this.length&&this.words[0]<0)this.words[0]=-this.words[0],this.negative=1;else for(var i=0;i<this.length&&this.words[i]<0;i++)this.words[i]+=67108864,this.words[i+1]-=1;return this.strip()},BN.prototype.addn=function(num){return this.clone().iaddn(num)},BN.prototype.subn=function(num){return this.clone().isubn(num)},BN.prototype.iabs=function(){return this.negative=0,this},BN.prototype.abs=function(){return this.clone().iabs()},BN.prototype._ishlnsubmul=function(num,mul,shift){var i,len=num.length+shift;this._expand(len);var w,carry=0;for(i=0;i<num.length;i++){w=(0|this.words[i+shift])+carry;var right=(0|num.words[i])*mul;w-=67108863&right,carry=(w>>26)-(right/67108864|0),this.words[i+shift]=67108863&w}for(;i<this.length-shift;i++)w=(0|this.words[i+shift])+carry,carry=w>>26,this.words[i+shift]=67108863&w;if(0===carry)return this.strip();for(assert(carry===-1),carry=0,i=0;i<this.length;i++)w=-(0|this.words[i])+carry,carry=w>>26,this.words[i]=67108863&w;return this.negative=1,this.strip()},BN.prototype._wordDiv=function(num,mode){var shift=this.length-num.length,a=this.clone(),b=num,bhi=0|b.words[b.length-1],bhiBits=this._countBits(bhi);shift=26-bhiBits,0!==shift&&(b=b.ushln(shift),a.iushln(shift),bhi=0|b.words[b.length-1]);var q,m=a.length-b.length;if("mod"!==mode){q=new BN(null),q.length=m+1,q.words=new Array(q.length);for(var i=0;i<q.length;i++)q.words[i]=0}var diff=a.clone()._ishlnsubmul(b,1,m);0===diff.negative&&(a=diff,q&&(q.words[m]=1));for(var j=m-1;j>=0;j--){var qj=67108864*(0|a.words[b.length+j])+(0|a.words[b.length+j-1]);for(qj=Math.min(qj/bhi|0,67108863),a._ishlnsubmul(b,qj,j);0!==a.negative;)qj--,a.negative=0,a._ishlnsubmul(b,1,j),a.isZero()||(a.negative^=1);q&&(q.words[j]=qj)}return q&&q.strip(),a.strip(),"div"!==mode&&0!==shift&&a.iushrn(shift),{div:q||null,mod:a}},BN.prototype.divmod=function(num,mode,positive){if(assert(!num.isZero()),this.isZero())return{div:new BN(0),mod:new BN(0)};var div,mod,res;return 0!==this.negative&&0===num.negative?(res=this.neg().divmod(num,mode),"mod"!==mode&&(div=res.div.neg()),"div"!==mode&&(mod=res.mod.neg(),positive&&0!==mod.negative&&mod.iadd(num)),{div:div,mod:mod}):0===this.negative&&0!==num.negative?(res=this.divmod(num.neg(),mode),"mod"!==mode&&(div=res.div.neg()),{div:div,mod:res.mod}):0!==(this.negative&num.negative)?(res=this.neg().divmod(num.neg(),mode),"div"!==mode&&(mod=res.mod.neg(),positive&&0!==mod.negative&&mod.isub(num)),{div:res.div,mod:mod}):num.length>this.length||this.cmp(num)<0?{div:new BN(0),mod:this}:1===num.length?"div"===mode?{div:this.divn(num.words[0]),mod:null}:"mod"===mode?{div:null,mod:new BN(this.modn(num.words[0]))}:{div:this.divn(num.words[0]),mod:new BN(this.modn(num.words[0]))}:this._wordDiv(num,mode)},BN.prototype.div=function(num){return this.divmod(num,"div",!1).div},BN.prototype.mod=function(num){return this.divmod(num,"mod",!1).mod},BN.prototype.umod=function(num){return this.divmod(num,"mod",!0).mod},BN.prototype.divRound=function(num){var dm=this.divmod(num);if(dm.mod.isZero())return dm.div;var mod=0!==dm.div.negative?dm.mod.isub(num):dm.mod,half=num.ushrn(1),r2=num.andln(1),cmp=mod.cmp(half);return cmp<0||1===r2&&0===cmp?dm.div:0!==dm.div.negative?dm.div.isubn(1):dm.div.iaddn(1)},BN.prototype.modn=function(num){assert(num<=67108863);for(var p=(1<<26)%num,acc=0,i=this.length-1;i>=0;i--)acc=(p*acc+(0|this.words[i]))%num;return acc},BN.prototype.idivn=function(num){assert(num<=67108863);for(var carry=0,i=this.length-1;i>=0;i--){var w=(0|this.words[i])+67108864*carry;this.words[i]=w/num|0,carry=w%num}return this.strip()},BN.prototype.divn=function(num){return this.clone().idivn(num)},BN.prototype.egcd=function(p){assert(0===p.negative),assert(!p.isZero());var x=this,y=p.clone();x=0!==x.negative?x.umod(p):x.clone();for(var A=new BN(1),B=new BN(0),C=new BN(0),D=new BN(1),g=0;x.isEven()&&y.isEven();)x.iushrn(1),y.iushrn(1),++g;for(var yp=y.clone(),xp=x.clone();!x.isZero();){for(var i=0,im=1;0===(x.words[0]&im)&&i<26;++i,im<<=1);if(i>0)for(x.iushrn(i);i-- >0;)(A.isOdd()||B.isOdd())&&(A.iadd(yp),B.isub(xp)),A.iushrn(1),B.iushrn(1);for(var j=0,jm=1;0===(y.words[0]&jm)&&j<26;++j,jm<<=1);if(j>0)for(y.iushrn(j);j-- >0;)(C.isOdd()||D.isOdd())&&(C.iadd(yp),D.isub(xp)),C.iushrn(1),D.iushrn(1);x.cmp(y)>=0?(x.isub(y),A.isub(C),B.isub(D)):(y.isub(x),C.isub(A),D.isub(B))}return{a:C,b:D,gcd:y.iushln(g)}},BN.prototype._invmp=function(p){assert(0===p.negative),assert(!p.isZero());var a=this,b=p.clone();a=0!==a.negative?a.umod(p):a.clone();for(var x1=new BN(1),x2=new BN(0),delta=b.clone();a.cmpn(1)>0&&b.cmpn(1)>0;){for(var i=0,im=1;0===(a.words[0]&im)&&i<26;++i,im<<=1);if(i>0)for(a.iushrn(i);i-- >0;)x1.isOdd()&&x1.iadd(delta),x1.iushrn(1);for(var j=0,jm=1;0===(b.words[0]&jm)&&j<26;++j,jm<<=1);if(j>0)for(b.iushrn(j);j-- >0;)x2.isOdd()&&x2.iadd(delta),x2.iushrn(1);a.cmp(b)>=0?(a.isub(b),x1.isub(x2)):(b.isub(a),x2.isub(x1))}var res;return res=0===a.cmpn(1)?x1:x2,res.cmpn(0)<0&&res.iadd(p),res},BN.prototype.gcd=function(num){if(this.isZero())return num.abs();if(num.isZero())return this.abs();var a=this.clone(),b=num.clone();a.negative=0,b.negative=0;for(var shift=0;a.isEven()&&b.isEven();shift++)a.iushrn(1),b.iushrn(1);for(;;){for(;a.isEven();)a.iushrn(1);for(;b.isEven();)b.iushrn(1);var r=a.cmp(b);if(r<0){var t=a;a=b,b=t}else if(0===r||0===b.cmpn(1))break;a.isub(b)}return b.iushln(shift)},BN.prototype.invm=function(num){return this.egcd(num).a.umod(num)},BN.prototype.isEven=function(){return 0===(1&this.words[0])},BN.prototype.isOdd=function(){return 1===(1&this.words[0])},BN.prototype.andln=function(num){return this.words[0]&num},BN.prototype.bincn=function(bit){assert("number"==typeof bit);var r=bit%26,s=(bit-r)/26,q=1<<r;if(this.length<=s)return this._expand(s+1),this.words[s]|=q,this;for(var carry=q,i=s;0!==carry&&i<this.length;i++){var w=0|this.words[i];w+=carry,carry=w>>>26,w&=67108863,this.words[i]=w}return 0!==carry&&(this.words[i]=carry,this.length++),this},BN.prototype.isZero=function(){return 1===this.length&&0===this.words[0]},BN.prototype.cmpn=function(num){var negative=num<0;if(0!==this.negative&&!negative)return-1;if(0===this.negative&&negative)return 1;this.strip();var res;if(this.length>1)res=1;else{negative&&(num=-num),assert(num<=67108863,"Number is too big");var w=0|this.words[0];res=w===num?0:w<num?-1:1}return 0!==this.negative?0|-res:res},BN.prototype.cmp=function(num){if(0!==this.negative&&0===num.negative)return-1;if(0===this.negative&&0!==num.negative)return 1;var res=this.ucmp(num);return 0!==this.negative?0|-res:res},BN.prototype.ucmp=function(num){if(this.length>num.length)return 1;if(this.length<num.length)return-1;for(var res=0,i=this.length-1;i>=0;i--){var a=0|this.words[i],b=0|num.words[i];if(a!==b){a<b?res=-1:a>b&&(res=1);break}}return res},BN.prototype.gtn=function(num){return 1===this.cmpn(num)},BN.prototype.gt=function(num){return 1===this.cmp(num)},BN.prototype.gten=function(num){return this.cmpn(num)>=0},BN.prototype.gte=function(num){return this.cmp(num)>=0},BN.prototype.ltn=function(num){return this.cmpn(num)===-1},BN.prototype.lt=function(num){return this.cmp(num)===-1},BN.prototype.lten=function(num){return this.cmpn(num)<=0},BN.prototype.lte=function(num){return this.cmp(num)<=0},BN.prototype.eqn=function(num){return 0===this.cmpn(num)},BN.prototype.eq=function(num){return 0===this.cmp(num)},BN.red=function(num){return new Red(num)},BN.prototype.toRed=function(ctx){return assert(!this.red,"Already a number in reduction context"),assert(0===this.negative,"red works only with positives"),ctx.convertTo(this)._forceRed(ctx)},BN.prototype.fromRed=function(){return assert(this.red,"fromRed works only with numbers in reduction context"),this.red.convertFrom(this)},BN.prototype._forceRed=function(ctx){return this.red=ctx,this},BN.prototype.forceRed=function(ctx){return assert(!this.red,"Already a number in reduction context"),this._forceRed(ctx)},BN.prototype.redAdd=function(num){return assert(this.red,"redAdd works only with red numbers"),this.red.add(this,num)},BN.prototype.redIAdd=function(num){return assert(this.red,"redIAdd works only with red numbers"),this.red.iadd(this,num)},BN.prototype.redSub=function(num){return assert(this.red,"redSub works only with red numbers"),this.red.sub(this,num)},BN.prototype.redISub=function(num){return assert(this.red,"redISub works only with red numbers"),this.red.isub(this,num)},BN.prototype.redShl=function(num){return assert(this.red,"redShl works only with red numbers"),this.red.shl(this,num)},BN.prototype.redMul=function(num){return assert(this.red,"redMul works only with red numbers"),this.red._verify2(this,num),this.red.mul(this,num)},BN.prototype.redIMul=function(num){return assert(this.red,"redMul works only with red numbers"),this.red._verify2(this,num),this.red.imul(this,num)},BN.prototype.redSqr=function(){return assert(this.red,"redSqr works only with red numbers"),this.red._verify1(this),this.red.sqr(this)},BN.prototype.redISqr=function(){return assert(this.red,"redISqr works only with red numbers"),this.red._verify1(this),this.red.isqr(this)},BN.prototype.redSqrt=function(){return assert(this.red,"redSqrt works only with red numbers"),this.red._verify1(this),this.red.sqrt(this)},BN.prototype.redInvm=function(){return assert(this.red,"redInvm works only with red numbers"),this.red._verify1(this),this.red.invm(this)},BN.prototype.redNeg=function(){return assert(this.red,"redNeg works only with red numbers"),this.red._verify1(this),this.red.neg(this)},BN.prototype.redPow=function(num){return assert(this.red&&!num.red,"redPow(normalNum)"),this.red._verify1(this),this.red.pow(this,num)};var primes={k256:null,p224:null,p192:null,p25519:null};MPrime.prototype._tmp=function(){var tmp=new BN(null);return tmp.words=new Array(Math.ceil(this.n/13)),tmp},MPrime.prototype.ireduce=function(num){var rlen,r=num;do this.split(r,this.tmp),r=this.imulK(r),r=r.iadd(this.tmp),rlen=r.bitLength();while(rlen>this.n);var cmp=rlen<this.n?-1:r.ucmp(this.p);return 0===cmp?(r.words[0]=0,r.length=1):cmp>0?r.isub(this.p):r.strip(),r},MPrime.prototype.split=function(input,out){input.iushrn(this.n,0,out)},MPrime.prototype.imulK=function(num){return num.imul(this.k)},inherits(K256,MPrime),K256.prototype.split=function(input,output){for(var mask=4194303,outLen=Math.min(input.length,9),i=0;i<outLen;i++)output.words[i]=input.words[i];if(output.length=outLen,input.length<=9)return input.words[0]=0,void(input.length=1);var prev=input.words[9];for(output.words[output.length++]=prev&mask,i=10;i<input.length;i++){var next=0|input.words[i];input.words[i-10]=(next&mask)<<4|prev>>>22,prev=next}prev>>>=22,input.words[i-10]=prev,
0===prev&&input.length>10?input.length-=10:input.length-=9},K256.prototype.imulK=function(num){num.words[num.length]=0,num.words[num.length+1]=0,num.length+=2;for(var lo=0,i=0;i<num.length;i++){var w=0|num.words[i];lo+=977*w,num.words[i]=67108863&lo,lo=64*w+(lo/67108864|0)}return 0===num.words[num.length-1]&&(num.length--,0===num.words[num.length-1]&&num.length--),num},inherits(P224,MPrime),inherits(P192,MPrime),inherits(P25519,MPrime),P25519.prototype.imulK=function(num){for(var carry=0,i=0;i<num.length;i++){var hi=19*(0|num.words[i])+carry,lo=67108863&hi;hi>>>=26,num.words[i]=lo,carry=hi}return 0!==carry&&(num.words[num.length++]=carry),num},BN._prime=function prime(name){if(primes[name])return primes[name];var prime;if("k256"===name)prime=new K256;else if("p224"===name)prime=new P224;else if("p192"===name)prime=new P192;else{if("p25519"!==name)throw new Error("Unknown prime "+name);prime=new P25519}return primes[name]=prime,prime},Red.prototype._verify1=function(a){assert(0===a.negative,"red works only with positives"),assert(a.red,"red works only with red numbers")},Red.prototype._verify2=function(a,b){assert(0===(a.negative|b.negative),"red works only with positives"),assert(a.red&&a.red===b.red,"red works only with red numbers")},Red.prototype.imod=function(a){return this.prime?this.prime.ireduce(a)._forceRed(this):a.umod(this.m)._forceRed(this)},Red.prototype.neg=function(a){return a.isZero()?a.clone():this.m.sub(a)._forceRed(this)},Red.prototype.add=function(a,b){this._verify2(a,b);var res=a.add(b);return res.cmp(this.m)>=0&&res.isub(this.m),res._forceRed(this)},Red.prototype.iadd=function(a,b){this._verify2(a,b);var res=a.iadd(b);return res.cmp(this.m)>=0&&res.isub(this.m),res},Red.prototype.sub=function(a,b){this._verify2(a,b);var res=a.sub(b);return res.cmpn(0)<0&&res.iadd(this.m),res._forceRed(this)},Red.prototype.isub=function(a,b){this._verify2(a,b);var res=a.isub(b);return res.cmpn(0)<0&&res.iadd(this.m),res},Red.prototype.shl=function(a,num){return this._verify1(a),this.imod(a.ushln(num))},Red.prototype.imul=function(a,b){return this._verify2(a,b),this.imod(a.imul(b))},Red.prototype.mul=function(a,b){return this._verify2(a,b),this.imod(a.mul(b))},Red.prototype.isqr=function(a){return this.imul(a,a.clone())},Red.prototype.sqr=function(a){return this.mul(a,a)},Red.prototype.sqrt=function(a){if(a.isZero())return a.clone();var mod3=this.m.andln(3);if(assert(mod3%2===1),3===mod3){var pow=this.m.add(new BN(1)).iushrn(2);return this.pow(a,pow)}for(var q=this.m.subn(1),s=0;!q.isZero()&&0===q.andln(1);)s++,q.iushrn(1);assert(!q.isZero());var one=new BN(1).toRed(this),nOne=one.redNeg(),lpow=this.m.subn(1).iushrn(1),z=this.m.bitLength();for(z=new BN(2*z*z).toRed(this);0!==this.pow(z,lpow).cmp(nOne);)z.redIAdd(nOne);for(var c=this.pow(z,q),r=this.pow(a,q.addn(1).iushrn(1)),t=this.pow(a,q),m=s;0!==t.cmp(one);){for(var tmp=t,i=0;0!==tmp.cmp(one);i++)tmp=tmp.redSqr();assert(i<m);var b=this.pow(c,new BN(1).iushln(m-i-1));r=r.redMul(b),c=b.redSqr(),t=t.redMul(c),m=i}return r},Red.prototype.invm=function(a){var inv=a._invmp(this.m);return 0!==inv.negative?(inv.negative=0,this.imod(inv).redNeg()):this.imod(inv)},Red.prototype.pow=function(a,num){if(num.isZero())return new BN(1).toRed(this);if(0===num.cmpn(1))return a.clone();var windowSize=4,wnd=new Array(1<<windowSize);wnd[0]=new BN(1).toRed(this),wnd[1]=a;for(var i=2;i<wnd.length;i++)wnd[i]=this.mul(wnd[i-1],a);var res=wnd[0],current=0,currentLen=0,start=num.bitLength()%26;for(0===start&&(start=26),i=num.length-1;i>=0;i--){for(var word=num.words[i],j=start-1;j>=0;j--){var bit=word>>j&1;res!==wnd[0]&&(res=this.sqr(res)),0!==bit||0!==current?(current<<=1,current|=bit,currentLen++,(currentLen===windowSize||0===i&&0===j)&&(res=this.mul(res,wnd[current]),currentLen=0,current=0)):currentLen=0}start=26}return res},Red.prototype.convertTo=function(num){var r=num.umod(this.m);return r===num?r.clone():r},Red.prototype.convertFrom=function(num){var res=num.clone();return res.red=null,res},BN.mont=function(num){return new Mont(num)},inherits(Mont,Red),Mont.prototype.convertTo=function(num){return this.imod(num.ushln(this.shift))},Mont.prototype.convertFrom=function(num){var r=this.imod(num.mul(this.rinv));return r.red=null,r},Mont.prototype.imul=function(a,b){if(a.isZero()||b.isZero())return a.words[0]=0,a.length=1,a;var t=a.imul(b),c=t.maskn(this.shift).mul(this.minv).imaskn(this.shift).mul(this.m),u=t.isub(c).iushrn(this.shift),res=u;return u.cmp(this.m)>=0?res=u.isub(this.m):u.cmpn(0)<0&&(res=u.iadd(this.m)),res._forceRed(this)},Mont.prototype.mul=function(a,b){if(a.isZero()||b.isZero())return new BN(0)._forceRed(this);var t=a.mul(b),c=t.maskn(this.shift).mul(this.minv).imaskn(this.shift).mul(this.m),u=t.isub(c).iushrn(this.shift),res=u;return u.cmp(this.m)>=0?res=u.isub(this.m):u.cmpn(0)<0&&(res=u.iadd(this.m)),res._forceRed(this)},Mont.prototype.invm=function(a){var res=this.imod(a._invmp(this.m).mul(this.r2));return res._forceRed(this)}}("undefined"==typeof module||module,this)},{buffer:119}],118:[function(require,module,exports){function Rand(rand){this.rand=rand}var r;if(module.exports=function(len){return r||(r=new Rand(null)),r.generate(len)},module.exports.Rand=Rand,Rand.prototype.generate=function(len){return this._rand(len)},Rand.prototype._rand=function(n){if(this.rand.getBytes)return this.rand.getBytes(n);for(var res=new Uint8Array(n),i=0;i<res.length;i++)res[i]=this.rand.getByte();return res},"object"==typeof self)self.crypto&&self.crypto.getRandomValues?Rand.prototype._rand=function(n){var arr=new Uint8Array(n);return self.crypto.getRandomValues(arr),arr}:self.msCrypto&&self.msCrypto.getRandomValues?Rand.prototype._rand=function(n){var arr=new Uint8Array(n);return self.msCrypto.getRandomValues(arr),arr}:"object"==typeof window&&(Rand.prototype._rand=function(){throw new Error("Not implemented yet")});else try{var crypto=require("crypto");if("function"!=typeof crypto.randomBytes)throw new Error("Not supported");Rand.prototype._rand=function(n){return crypto.randomBytes(n)}}catch(e){}},{crypto:119}],119:[function(require,module,exports){},{}],120:[function(require,module,exports){function asUInt32Array(buf){Buffer.isBuffer(buf)||(buf=Buffer.from(buf));for(var len=buf.length/4|0,out=new Array(len),i=0;i<len;i++)out[i]=buf.readUInt32BE(4*i);return out}function scrubVec(v){for(var i=0;i<v.length;v++)v[i]=0}function cryptBlock(M,keySchedule,SUB_MIX,SBOX,nRounds){for(var t0,t1,t2,t3,SUB_MIX0=SUB_MIX[0],SUB_MIX1=SUB_MIX[1],SUB_MIX2=SUB_MIX[2],SUB_MIX3=SUB_MIX[3],s0=M[0]^keySchedule[0],s1=M[1]^keySchedule[1],s2=M[2]^keySchedule[2],s3=M[3]^keySchedule[3],ksRow=4,round=1;round<nRounds;round++)t0=SUB_MIX0[s0>>>24]^SUB_MIX1[s1>>>16&255]^SUB_MIX2[s2>>>8&255]^SUB_MIX3[255&s3]^keySchedule[ksRow++],t1=SUB_MIX0[s1>>>24]^SUB_MIX1[s2>>>16&255]^SUB_MIX2[s3>>>8&255]^SUB_MIX3[255&s0]^keySchedule[ksRow++],t2=SUB_MIX0[s2>>>24]^SUB_MIX1[s3>>>16&255]^SUB_MIX2[s0>>>8&255]^SUB_MIX3[255&s1]^keySchedule[ksRow++],t3=SUB_MIX0[s3>>>24]^SUB_MIX1[s0>>>16&255]^SUB_MIX2[s1>>>8&255]^SUB_MIX3[255&s2]^keySchedule[ksRow++],s0=t0,s1=t1,s2=t2,s3=t3;return t0=(SBOX[s0>>>24]<<24|SBOX[s1>>>16&255]<<16|SBOX[s2>>>8&255]<<8|SBOX[255&s3])^keySchedule[ksRow++],t1=(SBOX[s1>>>24]<<24|SBOX[s2>>>16&255]<<16|SBOX[s3>>>8&255]<<8|SBOX[255&s0])^keySchedule[ksRow++],t2=(SBOX[s2>>>24]<<24|SBOX[s3>>>16&255]<<16|SBOX[s0>>>8&255]<<8|SBOX[255&s1])^keySchedule[ksRow++],t3=(SBOX[s3>>>24]<<24|SBOX[s0>>>16&255]<<16|SBOX[s1>>>8&255]<<8|SBOX[255&s2])^keySchedule[ksRow++],t0>>>=0,t1>>>=0,t2>>>=0,t3>>>=0,[t0,t1,t2,t3]}function AES(key){this._key=asUInt32Array(key),this._reset()}var Buffer=require("safe-buffer").Buffer,RCON=[0,1,2,4,8,16,32,64,128,27,54],G=function(){for(var d=new Array(256),j=0;j<256;j++)j<128?d[j]=j<<1:d[j]=j<<1^283;for(var SBOX=[],INV_SBOX=[],SUB_MIX=[[],[],[],[]],INV_SUB_MIX=[[],[],[],[]],x=0,xi=0,i=0;i<256;++i){var sx=xi^xi<<1^xi<<2^xi<<3^xi<<4;sx=sx>>>8^255&sx^99,SBOX[x]=sx,INV_SBOX[sx]=x;var x2=d[x],x4=d[x2],x8=d[x4],t=257*d[sx]^16843008*sx;SUB_MIX[0][x]=t<<24|t>>>8,SUB_MIX[1][x]=t<<16|t>>>16,SUB_MIX[2][x]=t<<8|t>>>24,SUB_MIX[3][x]=t,t=16843009*x8^65537*x4^257*x2^16843008*x,INV_SUB_MIX[0][sx]=t<<24|t>>>8,INV_SUB_MIX[1][sx]=t<<16|t>>>16,INV_SUB_MIX[2][sx]=t<<8|t>>>24,INV_SUB_MIX[3][sx]=t,0===x?x=xi=1:(x=x2^d[d[d[x8^x2]]],xi^=d[d[xi]])}return{SBOX:SBOX,INV_SBOX:INV_SBOX,SUB_MIX:SUB_MIX,INV_SUB_MIX:INV_SUB_MIX}}();AES.blockSize=16,AES.keySize=32,AES.prototype.blockSize=AES.blockSize,AES.prototype.keySize=AES.keySize,AES.prototype._reset=function(){for(var keyWords=this._key,keySize=keyWords.length,nRounds=keySize+6,ksRows=4*(nRounds+1),keySchedule=[],k=0;k<keySize;k++)keySchedule[k]=keyWords[k];for(k=keySize;k<ksRows;k++){var t=keySchedule[k-1];k%keySize===0?(t=t<<8|t>>>24,t=G.SBOX[t>>>24]<<24|G.SBOX[t>>>16&255]<<16|G.SBOX[t>>>8&255]<<8|G.SBOX[255&t],t^=RCON[k/keySize|0]<<24):keySize>6&&k%keySize===4&&(t=G.SBOX[t>>>24]<<24|G.SBOX[t>>>16&255]<<16|G.SBOX[t>>>8&255]<<8|G.SBOX[255&t]),keySchedule[k]=keySchedule[k-keySize]^t}for(var invKeySchedule=[],ik=0;ik<ksRows;ik++){var ksR=ksRows-ik,tt=keySchedule[ksR-(ik%4?0:4)];ik<4||ksR<=4?invKeySchedule[ik]=tt:invKeySchedule[ik]=G.INV_SUB_MIX[0][G.SBOX[tt>>>24]]^G.INV_SUB_MIX[1][G.SBOX[tt>>>16&255]]^G.INV_SUB_MIX[2][G.SBOX[tt>>>8&255]]^G.INV_SUB_MIX[3][G.SBOX[255&tt]]}this._nRounds=nRounds,this._keySchedule=keySchedule,this._invKeySchedule=invKeySchedule},AES.prototype.encryptBlockRaw=function(M){return M=asUInt32Array(M),cryptBlock(M,this._keySchedule,G.SUB_MIX,G.SBOX,this._nRounds)},AES.prototype.encryptBlock=function(M){var out=this.encryptBlockRaw(M),buf=Buffer.allocUnsafe(16);return buf.writeUInt32BE(out[0],0),buf.writeUInt32BE(out[1],4),buf.writeUInt32BE(out[2],8),buf.writeUInt32BE(out[3],12),buf},AES.prototype.decryptBlock=function(M){M=asUInt32Array(M);var m1=M[1];M[1]=M[3],M[3]=m1;var out=cryptBlock(M,this._invKeySchedule,G.INV_SUB_MIX,G.INV_SBOX,this._nRounds),buf=Buffer.allocUnsafe(16);return buf.writeUInt32BE(out[0],0),buf.writeUInt32BE(out[3],4),buf.writeUInt32BE(out[2],8),buf.writeUInt32BE(out[1],12),buf},AES.prototype.scrub=function(){scrubVec(this._keySchedule),scrubVec(this._invKeySchedule),scrubVec(this._key)},module.exports.AES=AES},{"safe-buffer":323}],121:[function(require,module,exports){function xorTest(a,b){var out=0;a.length!==b.length&&out++;for(var len=Math.min(a.length,b.length),i=0;i<len;++i)out+=a[i]^b[i];return out}function calcIv(self,iv,ck){if(12===iv.length)return self._finID=Buffer.concat([iv,Buffer.from([0,0,0,1])]),Buffer.concat([iv,Buffer.from([0,0,0,2])]);var ghash=new GHASH(ck),len=iv.length,toPad=len%16;ghash.update(iv),toPad&&(toPad=16-toPad,ghash.update(Buffer.alloc(toPad,0))),ghash.update(Buffer.alloc(8,0));var ivBits=8*len,tail=Buffer.alloc(8);tail.writeUIntBE(ivBits,0,8),ghash.update(tail),self._finID=ghash.state;var out=Buffer.from(self._finID);return incr32(out),out}function StreamCipher(mode,key,iv,decrypt){Transform.call(this);var h=Buffer.alloc(4,0);this._cipher=new aes.AES(key);var ck=this._cipher.encryptBlock(h);this._ghash=new GHASH(ck),iv=calcIv(this,iv,ck),this._prev=Buffer.from(iv),this._cache=Buffer.allocUnsafe(0),this._secCache=Buffer.allocUnsafe(0),this._decrypt=decrypt,this._alen=0,this._len=0,this._mode=mode,this._authTag=null,this._called=!1}var aes=require("./aes"),Buffer=require("safe-buffer").Buffer,Transform=require("cipher-base"),inherits=require("inherits"),GHASH=require("./ghash"),xor=require("buffer-xor"),incr32=require("./incr32");inherits(StreamCipher,Transform),StreamCipher.prototype._update=function(chunk){if(!this._called&&this._alen){var rump=16-this._alen%16;rump<16&&(rump=Buffer.alloc(rump,0),this._ghash.update(rump))}this._called=!0;var out=this._mode.encrypt(this,chunk);return this._decrypt?this._ghash.update(chunk):this._ghash.update(out),this._len+=chunk.length,out},StreamCipher.prototype._final=function(){if(this._decrypt&&!this._authTag)throw new Error("Unsupported state or unable to authenticate data");var tag=xor(this._ghash["final"](8*this._alen,8*this._len),this._cipher.encryptBlock(this._finID));if(this._decrypt&&xorTest(tag,this._authTag))throw new Error("Unsupported state or unable to authenticate data");this._authTag=tag,this._cipher.scrub()},StreamCipher.prototype.getAuthTag=function(){if(this._decrypt||!Buffer.isBuffer(this._authTag))throw new Error("Attempting to get auth tag in unsupported state");return this._authTag},StreamCipher.prototype.setAuthTag=function(tag){if(!this._decrypt)throw new Error("Attempting to set auth tag in unsupported state");this._authTag=tag},StreamCipher.prototype.setAAD=function(buf){if(this._called)throw new Error("Attempting to set AAD in unsupported state");this._ghash.update(buf),this._alen+=buf.length},module.exports=StreamCipher},{"./aes":120,"./ghash":125,"./incr32":126,"buffer-xor":150,"cipher-base":152,inherits:233,"safe-buffer":323}],122:[function(require,module,exports){function getCiphers(){return Object.keys(modes)}var ciphers=require("./encrypter"),deciphers=require("./decrypter"),modes=require("./modes/list.json");exports.createCipher=exports.Cipher=ciphers.createCipher,exports.createCipheriv=exports.Cipheriv=ciphers.createCipheriv,exports.createDecipher=exports.Decipher=deciphers.createDecipher,exports.createDecipheriv=exports.Decipheriv=deciphers.createDecipheriv,exports.listCiphers=exports.getCiphers=getCiphers},{"./decrypter":123,"./encrypter":124,"./modes/list.json":134}],123:[function(require,module,exports){function Decipher(mode,key,iv){Transform.call(this),this._cache=new Splitter,this._last=void 0,this._cipher=new aes.AES(key),this._prev=Buffer.from(iv),this._mode=mode,this._autopadding=!0}function Splitter(){this.cache=Buffer.allocUnsafe(0)}function unpad(last){var padded=last[15];if(padded<1||padded>16)throw new Error("unable to decrypt data");for(var i=-1;++i<padded;)if(last[i+(16-padded)]!==padded)throw new Error("unable to decrypt data");if(16!==padded)return last.slice(0,16-padded)}function createDecipheriv(suite,password,iv){var config=MODES[suite.toLowerCase()];if(!config)throw new TypeError("invalid suite type");if("string"==typeof iv&&(iv=Buffer.from(iv)),"GCM"!==config.mode&&iv.length!==config.iv)throw new TypeError("invalid iv length "+iv.length);if("string"==typeof password&&(password=Buffer.from(password)),password.length!==config.key/8)throw new TypeError("invalid key length "+password.length);return"stream"===config.type?new StreamCipher(config.module,password,iv,(!0)):"auth"===config.type?new AuthCipher(config.module,password,iv,(!0)):new Decipher(config.module,password,iv)}function createDecipher(suite,password){var config=MODES[suite.toLowerCase()];if(!config)throw new TypeError("invalid suite type");var keys=ebtk(password,!1,config.key,config.iv);return createDecipheriv(suite,keys.key,keys.iv)}var AuthCipher=require("./authCipher"),Buffer=require("safe-buffer").Buffer,MODES=require("./modes"),StreamCipher=require("./streamCipher"),Transform=require("cipher-base"),aes=require("./aes"),ebtk=require("evp_bytestokey"),inherits=require("inherits");inherits(Decipher,Transform),Decipher.prototype._update=function(data){this._cache.add(data);for(var chunk,thing,out=[];chunk=this._cache.get(this._autopadding);)thing=this._mode.decrypt(this,chunk),out.push(thing);return Buffer.concat(out)},Decipher.prototype._final=function(){var chunk=this._cache.flush();if(this._autopadding)return unpad(this._mode.decrypt(this,chunk));if(chunk)throw new Error("data not multiple of block length")},Decipher.prototype.setAutoPadding=function(setTo){return this._autopadding=!!setTo,this},Splitter.prototype.add=function(data){this.cache=Buffer.concat([this.cache,data])},Splitter.prototype.get=function(autoPadding){var out;if(autoPadding){if(this.cache.length>16)return out=this.cache.slice(0,16),this.cache=this.cache.slice(16),out}else if(this.cache.length>=16)return out=this.cache.slice(0,16),this.cache=this.cache.slice(16),out;return null},Splitter.prototype.flush=function(){if(this.cache.length)return this.cache},exports.createDecipher=createDecipher,exports.createDecipheriv=createDecipheriv},{"./aes":120,"./authCipher":121,"./modes":133,"./streamCipher":136,"cipher-base":152,evp_bytestokey:216,inherits:233,"safe-buffer":323}],124:[function(require,module,exports){function Cipher(mode,key,iv){Transform.call(this),this._cache=new Splitter,this._cipher=new aes.AES(key),this._prev=Buffer.from(iv),this._mode=mode,this._autopadding=!0}function Splitter(){this.cache=Buffer.allocUnsafe(0)}function createCipheriv(suite,password,iv){var config=MODES[suite.toLowerCase()];if(!config)throw new TypeError("invalid suite type");if("string"==typeof password&&(password=Buffer.from(password)),password.length!==config.key/8)throw new TypeError("invalid key length "+password.length);if("string"==typeof iv&&(iv=Buffer.from(iv)),"GCM"!==config.mode&&iv.length!==config.iv)throw new TypeError("invalid iv length "+iv.length);return"stream"===config.type?new StreamCipher(config.module,password,iv):"auth"===config.type?new AuthCipher(config.module,password,iv):new Cipher(config.module,password,iv)}function createCipher(suite,password){var config=MODES[suite.toLowerCase()];if(!config)throw new TypeError("invalid suite type");var keys=ebtk(password,!1,config.key,config.iv);return createCipheriv(suite,keys.key,keys.iv)}var MODES=require("./modes"),AuthCipher=require("./authCipher"),Buffer=require("safe-buffer").Buffer,StreamCipher=require("./streamCipher"),Transform=require("cipher-base"),aes=require("./aes"),ebtk=require("evp_bytestokey"),inherits=require("inherits");inherits(Cipher,Transform),Cipher.prototype._update=function(data){this._cache.add(data);for(var chunk,thing,out=[];chunk=this._cache.get();)thing=this._mode.encrypt(this,chunk),out.push(thing);return Buffer.concat(out)};var PADDING=Buffer.alloc(16,16);Cipher.prototype._final=function(){var chunk=this._cache.flush();if(this._autopadding)return chunk=this._mode.encrypt(this,chunk),this._cipher.scrub(),chunk;if(!chunk.equals(PADDING))throw this._cipher.scrub(),new Error("data not multiple of block length")},Cipher.prototype.setAutoPadding=function(setTo){return this._autopadding=!!setTo,this},Splitter.prototype.add=function(data){this.cache=Buffer.concat([this.cache,data])},Splitter.prototype.get=function(){if(this.cache.length>15){var out=this.cache.slice(0,16);return this.cache=this.cache.slice(16),out}return null},Splitter.prototype.flush=function(){for(var len=16-this.cache.length,padBuff=Buffer.allocUnsafe(len),i=-1;++i<len;)padBuff.writeUInt8(len,i);return Buffer.concat([this.cache,padBuff])},exports.createCipheriv=createCipheriv,exports.createCipher=createCipher},{"./aes":120,"./authCipher":121,"./modes":133,"./streamCipher":136,"cipher-base":152,evp_bytestokey:216,inherits:233,"safe-buffer":323}],125:[function(require,module,exports){function toArray(buf){return[buf.readUInt32BE(0),buf.readUInt32BE(4),buf.readUInt32BE(8),buf.readUInt32BE(12)]}function fromArray(out){var buf=Buffer.allocUnsafe(16);return buf.writeUInt32BE(out[0]>>>0,0),buf.writeUInt32BE(out[1]>>>0,4),buf.writeUInt32BE(out[2]>>>0,8),buf.writeUInt32BE(out[3]>>>0,12),buf}function GHASH(key){this.h=key,this.state=Buffer.alloc(16,0),this.cache=Buffer.allocUnsafe(0)}var Buffer=require("safe-buffer").Buffer,ZEROES=Buffer.alloc(16,0);GHASH.prototype.ghash=function(block){for(var i=-1;++i<block.length;)this.state[i]^=block[i];this._multiply()},GHASH.prototype._multiply=function(){for(var j,xi,lsbVi,Vi=toArray(this.h),Zi=[0,0,0,0],i=-1;++i<128;){for(xi=0!==(this.state[~~(i/8)]&1<<7-i%8),xi&&(Zi[0]^=Vi[0],Zi[1]^=Vi[1],Zi[2]^=Vi[2],Zi[3]^=Vi[3]),lsbVi=0!==(1&Vi[3]),j=3;j>0;j--)Vi[j]=Vi[j]>>>1|(1&Vi[j-1])<<31;Vi[0]=Vi[0]>>>1,lsbVi&&(Vi[0]=Vi[0]^225<<24)}this.state=fromArray(Zi)},GHASH.prototype.update=function(buf){this.cache=Buffer.concat([this.cache,buf]);for(var chunk;this.cache.length>=16;)chunk=this.cache.slice(0,16),this.cache=this.cache.slice(16),this.ghash(chunk)},GHASH.prototype["final"]=function(abl,bl){return this.cache.length&&this.ghash(Buffer.concat([this.cache,ZEROES],16)),this.ghash(fromArray([0,abl,0,bl])),this.state},module.exports=GHASH},{"safe-buffer":323}],126:[function(require,module,exports){function incr32(iv){for(var item,len=iv.length;len--;){if(item=iv.readUInt8(len),255!==item){item++,iv.writeUInt8(item,len);break}iv.writeUInt8(0,len)}}module.exports=incr32},{}],127:[function(require,module,exports){var xor=require("buffer-xor");exports.encrypt=function(self,block){var data=xor(block,self._prev);return self._prev=self._cipher.encryptBlock(data),self._prev},exports.decrypt=function(self,block){var pad=self._prev;self._prev=block;var out=self._cipher.decryptBlock(block);return xor(out,pad)}},{"buffer-xor":150}],128:[function(require,module,exports){function encryptStart(self,data,decrypt){var len=data.length,out=xor(data,self._cache);return self._cache=self._cache.slice(len),self._prev=Buffer.concat([self._prev,decrypt?data:out]),out}var Buffer=require("safe-buffer").Buffer,xor=require("buffer-xor");exports.encrypt=function(self,data,decrypt){for(var len,out=Buffer.allocUnsafe(0);data.length;){if(0===self._cache.length&&(self._cache=self._cipher.encryptBlock(self._prev),self._prev=Buffer.allocUnsafe(0)),!(self._cache.length<=data.length)){out=Buffer.concat([out,encryptStart(self,data,decrypt)]);break}len=self._cache.length,out=Buffer.concat([out,encryptStart(self,data.slice(0,len),decrypt)]),data=data.slice(len)}return out}},{"buffer-xor":150,"safe-buffer":323}],129:[function(require,module,exports){function encryptByte(self,byteParam,decrypt){for(var pad,bit,value,i=-1,len=8,out=0;++i<len;)pad=self._cipher.encryptBlock(self._prev),bit=byteParam&1<<7-i?128:0,value=pad[0]^bit,out+=(128&value)>>i%8,self._prev=shiftIn(self._prev,decrypt?bit:value);return out}function shiftIn(buffer,value){var len=buffer.length,i=-1,out=Buffer.allocUnsafe(buffer.length);for(buffer=Buffer.concat([buffer,Buffer.from([value])]);++i<len;)out[i]=buffer[i]<<1|buffer[i+1]>>7;return out}var Buffer=require("safe-buffer").Buffer;exports.encrypt=function(self,chunk,decrypt){for(var len=chunk.length,out=Buffer.allocUnsafe(len),i=-1;++i<len;)out[i]=encryptByte(self,chunk[i],decrypt);return out}},{"safe-buffer":323}],130:[function(require,module,exports){function encryptByte(self,byteParam,decrypt){var pad=self._cipher.encryptBlock(self._prev),out=pad[0]^byteParam;return self._prev=Buffer.concat([self._prev.slice(1),Buffer.from([decrypt?byteParam:out])]),out}var Buffer=require("safe-buffer").Buffer;exports.encrypt=function(self,chunk,decrypt){for(var len=chunk.length,out=Buffer.allocUnsafe(len),i=-1;++i<len;)out[i]=encryptByte(self,chunk[i],decrypt);return out}},{"safe-buffer":323}],131:[function(require,module,exports){function getBlock(self){var out=self._cipher.encryptBlockRaw(self._prev);return incr32(self._prev),out}var xor=require("buffer-xor"),Buffer=require("safe-buffer").Buffer,incr32=require("../incr32"),blockSize=16;exports.encrypt=function(self,chunk){var chunkNum=Math.ceil(chunk.length/blockSize),start=self._cache.length;self._cache=Buffer.concat([self._cache,Buffer.allocUnsafe(chunkNum*blockSize)]);for(var i=0;i<chunkNum;i++){var out=getBlock(self),offset=start+i*blockSize;self._cache.writeUInt32BE(out[0],offset+0),self._cache.writeUInt32BE(out[1],offset+4),self._cache.writeUInt32BE(out[2],offset+8),self._cache.writeUInt32BE(out[3],offset+12)}var pad=self._cache.slice(0,chunk.length);return self._cache=self._cache.slice(chunk.length),xor(chunk,pad)}},{"../incr32":126,"buffer-xor":150,"safe-buffer":323}],132:[function(require,module,exports){exports.encrypt=function(self,block){return self._cipher.encryptBlock(block)},exports.decrypt=function(self,block){return self._cipher.decryptBlock(block)}},{}],133:[function(require,module,exports){var modeModules={ECB:require("./ecb"),CBC:require("./cbc"),CFB:require("./cfb"),CFB8:require("./cfb8"),CFB1:require("./cfb1"),OFB:require("./ofb"),CTR:require("./ctr"),GCM:require("./ctr")},modes=require("./list.json");for(var key in modes)modes[key].module=modeModules[modes[key].mode];module.exports=modes},{"./cbc":127,"./cfb":128,"./cfb1":129,"./cfb8":130,"./ctr":131,"./ecb":132,"./list.json":134,"./ofb":135}],134:[function(require,module,exports){module.exports={"aes-128-ecb":{cipher:"AES",key:128,iv:0,mode:"ECB",type:"block"},"aes-192-ecb":{cipher:"AES",key:192,iv:0,mode:"ECB",type:"block"},"aes-256-ecb":{cipher:"AES",key:256,iv:0,mode:"ECB",type:"block"},"aes-128-cbc":{cipher:"AES",key:128,iv:16,mode:"CBC",type:"block"},"aes-192-cbc":{cipher:"AES",key:192,iv:16,mode:"CBC",type:"block"},"aes-256-cbc":{cipher:"AES",key:256,iv:16,mode:"CBC",type:"block"},aes128:{cipher:"AES",key:128,iv:16,mode:"CBC",type:"block"},aes192:{cipher:"AES",key:192,iv:16,mode:"CBC",type:"block"},aes256:{cipher:"AES",key:256,iv:16,mode:"CBC",type:"block"},"aes-128-cfb":{cipher:"AES",key:128,iv:16,mode:"CFB",type:"stream"},"aes-192-cfb":{cipher:"AES",key:192,iv:16,mode:"CFB",type:"stream"},"aes-256-cfb":{cipher:"AES",key:256,iv:16,mode:"CFB",type:"stream"},"aes-128-cfb8":{cipher:"AES",key:128,iv:16,mode:"CFB8",type:"stream"},"aes-192-cfb8":{cipher:"AES",key:192,iv:16,mode:"CFB8",type:"stream"},"aes-256-cfb8":{cipher:"AES",key:256,iv:16,mode:"CFB8",type:"stream"},"aes-128-cfb1":{cipher:"AES",key:128,iv:16,mode:"CFB1",type:"stream"},"aes-192-cfb1":{cipher:"AES",key:192,iv:16,mode:"CFB1",type:"stream"},"aes-256-cfb1":{cipher:"AES",key:256,iv:16,mode:"CFB1",type:"stream"},"aes-128-ofb":{cipher:"AES",key:128,iv:16,mode:"OFB",type:"stream"},"aes-192-ofb":{cipher:"AES",key:192,iv:16,mode:"OFB",type:"stream"},"aes-256-ofb":{cipher:"AES",key:256,iv:16,mode:"OFB",type:"stream"},"aes-128-ctr":{cipher:"AES",key:128,iv:16,mode:"CTR",type:"stream"},"aes-192-ctr":{cipher:"AES",key:192,iv:16,mode:"CTR",type:"stream"},"aes-256-ctr":{cipher:"AES",key:256,iv:16,mode:"CTR",type:"stream"},"aes-128-gcm":{cipher:"AES",key:128,iv:12,mode:"GCM",type:"auth"},"aes-192-gcm":{cipher:"AES",key:192,iv:12,mode:"GCM",type:"auth"},"aes-256-gcm":{cipher:"AES",key:256,iv:12,mode:"GCM",type:"auth"}}},{}],135:[function(require,module,exports){(function(Buffer){function getBlock(self){return self._prev=self._cipher.encryptBlock(self._prev),self._prev}var xor=require("buffer-xor");exports.encrypt=function(self,chunk){for(;self._cache.length<chunk.length;)self._cache=Buffer.concat([self._cache,getBlock(self)]);var pad=self._cache.slice(0,chunk.length);return self._cache=self._cache.slice(chunk.length),xor(chunk,pad)}}).call(this,require("buffer").Buffer)},{buffer:151,"buffer-xor":150}],136:[function(require,module,exports){function StreamCipher(mode,key,iv,decrypt){Transform.call(this),this._cipher=new aes.AES(key),this._prev=Buffer.from(iv),this._cache=Buffer.allocUnsafe(0),this._secCache=Buffer.allocUnsafe(0),this._decrypt=decrypt,this._mode=mode}var aes=require("./aes"),Buffer=require("safe-buffer").Buffer,Transform=require("cipher-base"),inherits=require("inherits");inherits(StreamCipher,Transform),StreamCipher.prototype._update=function(chunk){return this._mode.encrypt(this,chunk,this._decrypt)},StreamCipher.prototype._final=function(){this._cipher.scrub()},module.exports=StreamCipher},{"./aes":120,"cipher-base":152,inherits:233,"safe-buffer":323}],137:[function(require,module,exports){function createCipher(suite,password){suite=suite.toLowerCase();var keyLen,ivLen;if(aesModes[suite])keyLen=aesModes[suite].key,ivLen=aesModes[suite].iv;else{if(!desModes[suite])throw new TypeError("invalid suite type");keyLen=8*desModes[suite].key,ivLen=desModes[suite].iv}var keys=ebtk(password,!1,keyLen,ivLen);return createCipheriv(suite,keys.key,keys.iv)}function createDecipher(suite,password){suite=suite.toLowerCase();var keyLen,ivLen;if(aesModes[suite])keyLen=aesModes[suite].key,ivLen=aesModes[suite].iv;else{if(!desModes[suite])throw new TypeError("invalid suite type");keyLen=8*desModes[suite].key,ivLen=desModes[suite].iv}var keys=ebtk(password,!1,keyLen,ivLen);return createDecipheriv(suite,keys.key,keys.iv)}function createCipheriv(suite,key,iv){if(suite=suite.toLowerCase(),aesModes[suite])return aes.createCipheriv(suite,key,iv);if(desModes[suite])return new DES({key:key,iv:iv,mode:suite});throw new TypeError("invalid suite type")}function createDecipheriv(suite,key,iv){if(suite=suite.toLowerCase(),aesModes[suite])return aes.createDecipheriv(suite,key,iv);if(desModes[suite])return new DES({key:key,iv:iv,mode:suite,decrypt:!0});throw new TypeError("invalid suite type")}function getCiphers(){return Object.keys(desModes).concat(aes.getCiphers())}var DES=require("browserify-des"),aes=require("browserify-aes/browser"),aesModes=require("browserify-aes/modes"),desModes=require("browserify-des/modes"),ebtk=require("evp_bytestokey");exports.createCipher=exports.Cipher=createCipher,exports.createCipheriv=exports.Cipheriv=createCipheriv,exports.createDecipher=exports.Decipher=createDecipher,exports.createDecipheriv=exports.Decipheriv=createDecipheriv,exports.listCiphers=exports.getCiphers=getCiphers},{"browserify-aes/browser":122,"browserify-aes/modes":133,"browserify-des":138,"browserify-des/modes":139,evp_bytestokey:216}],138:[function(require,module,exports){(function(Buffer){function DES(opts){CipherBase.call(this);var type,modeName=opts.mode.toLowerCase(),mode=modes[modeName];type=opts.decrypt?"decrypt":"encrypt";var key=opts.key;"des-ede"!==modeName&&"des-ede-cbc"!==modeName||(key=Buffer.concat([key,key.slice(0,8)]));var iv=opts.iv;this._des=mode.create({key:key,iv:iv,type:type})}var CipherBase=require("cipher-base"),des=require("des.js"),inherits=require("inherits"),modes={"des-ede3-cbc":des.CBC.instantiate(des.EDE),"des-ede3":des.EDE,"des-ede-cbc":des.CBC.instantiate(des.EDE),"des-ede":des.EDE,"des-cbc":des.CBC.instantiate(des.DES),"des-ecb":des.DES};modes.des=modes["des-cbc"],modes.des3=modes["des-ede3-cbc"],module.exports=DES,inherits(DES,CipherBase),DES.prototype._update=function(data){return new Buffer(this._des.update(data))},DES.prototype._final=function(){return new Buffer(this._des["final"]())}}).call(this,require("buffer").Buffer)},{buffer:151,"cipher-base":152,"des.js":182,inherits:233}],139:[function(require,module,exports){exports["des-ecb"]={key:8,iv:0},exports["des-cbc"]=exports.des={key:8,iv:8},exports["des-ede3-cbc"]=exports.des3={key:24,iv:8},exports["des-ede3"]={key:24,iv:0},exports["des-ede-cbc"]={key:16,iv:8},exports["des-ede"]={key:16,iv:0}},{}],140:[function(require,module,exports){(function(Buffer){function blind(priv){var r=getr(priv),blinder=r.toRed(bn.mont(priv.modulus)).redPow(new bn(priv.publicExponent)).fromRed();return{blinder:blinder,unblinder:r.invm(priv.modulus)}}function crt(msg,priv){var blinds=blind(priv),len=priv.modulus.byteLength(),blinded=(bn.mont(priv.modulus),new bn(msg).mul(blinds.blinder).umod(priv.modulus)),c1=blinded.toRed(bn.mont(priv.prime1)),c2=blinded.toRed(bn.mont(priv.prime2)),qinv=priv.coefficient,p=priv.prime1,q=priv.prime2,m1=c1.redPow(priv.exponent1),m2=c2.redPow(priv.exponent2);m1=m1.fromRed(),m2=m2.fromRed();var h=m1.isub(m2).imul(qinv).umod(p);return h.imul(q),m2.iadd(h),new Buffer(m2.imul(blinds.unblinder).umod(priv.modulus).toArray(!1,len))}function getr(priv){for(var len=priv.modulus.byteLength(),r=new bn(randomBytes(len));r.cmp(priv.modulus)>=0||!r.umod(priv.prime1)||!r.umod(priv.prime2);)r=new bn(randomBytes(len));return r}var bn=require("bn.js"),randomBytes=require("randombytes");module.exports=crt,crt.getr=getr}).call(this,require("buffer").Buffer)},{"bn.js":117,buffer:151,randombytes:320}],141:[function(require,module,exports){module.exports=require("./browser/algorithms.json")},{"./browser/algorithms.json":142}],142:[function(require,module,exports){module.exports={sha224WithRSAEncryption:{sign:"rsa",hash:"sha224",id:"302d300d06096086480165030402040500041c"},"RSA-SHA224":{sign:"ecdsa/rsa",hash:"sha224",id:"302d300d06096086480165030402040500041c"},sha256WithRSAEncryption:{sign:"rsa",hash:"sha256",id:"3031300d060960864801650304020105000420"},"RSA-SHA256":{sign:"ecdsa/rsa",hash:"sha256",
id:"3031300d060960864801650304020105000420"},sha384WithRSAEncryption:{sign:"rsa",hash:"sha384",id:"3041300d060960864801650304020205000430"},"RSA-SHA384":{sign:"ecdsa/rsa",hash:"sha384",id:"3041300d060960864801650304020205000430"},sha512WithRSAEncryption:{sign:"rsa",hash:"sha512",id:"3051300d060960864801650304020305000440"},"RSA-SHA512":{sign:"ecdsa/rsa",hash:"sha512",id:"3051300d060960864801650304020305000440"},"RSA-SHA1":{sign:"rsa",hash:"sha1",id:"3021300906052b0e03021a05000414"},"ecdsa-with-SHA1":{sign:"ecdsa",hash:"sha1",id:""},sha256:{sign:"ecdsa",hash:"sha256",id:""},sha224:{sign:"ecdsa",hash:"sha224",id:""},sha384:{sign:"ecdsa",hash:"sha384",id:""},sha512:{sign:"ecdsa",hash:"sha512",id:""},"DSA-SHA":{sign:"dsa",hash:"sha1",id:""},"DSA-SHA1":{sign:"dsa",hash:"sha1",id:""},DSA:{sign:"dsa",hash:"sha1",id:""},"DSA-WITH-SHA224":{sign:"dsa",hash:"sha224",id:""},"DSA-SHA224":{sign:"dsa",hash:"sha224",id:""},"DSA-WITH-SHA256":{sign:"dsa",hash:"sha256",id:""},"DSA-SHA256":{sign:"dsa",hash:"sha256",id:""},"DSA-WITH-SHA384":{sign:"dsa",hash:"sha384",id:""},"DSA-SHA384":{sign:"dsa",hash:"sha384",id:""},"DSA-WITH-SHA512":{sign:"dsa",hash:"sha512",id:""},"DSA-SHA512":{sign:"dsa",hash:"sha512",id:""},"DSA-RIPEMD160":{sign:"dsa",hash:"rmd160",id:""},ripemd160WithRSA:{sign:"rsa",hash:"rmd160",id:"3021300906052b2403020105000414"},"RSA-RIPEMD160":{sign:"rsa",hash:"rmd160",id:"3021300906052b2403020105000414"},md5WithRSAEncryption:{sign:"rsa",hash:"md5",id:"3020300c06082a864886f70d020505000410"},"RSA-MD5":{sign:"rsa",hash:"md5",id:"3020300c06082a864886f70d020505000410"}}},{}],143:[function(require,module,exports){module.exports={"1.3.132.0.10":"secp256k1","1.3.132.0.33":"p224","1.2.840.10045.3.1.1":"p192","1.2.840.10045.3.1.7":"p256","1.3.132.0.34":"p384","1.3.132.0.35":"p521"}},{}],144:[function(require,module,exports){(function(Buffer){function Sign(algorithm){stream.Writable.call(this);var data=algorithms[algorithm];if(!data)throw new Error("Unknown message digest");this._hashType=data.hash,this._hash=createHash(data.hash),this._tag=data.id,this._signType=data.sign}function Verify(algorithm){stream.Writable.call(this);var data=algorithms[algorithm];if(!data)throw new Error("Unknown message digest");this._hash=createHash(data.hash),this._tag=data.id,this._signType=data.sign}function createSign(algorithm){return new Sign(algorithm)}function createVerify(algorithm){return new Verify(algorithm)}var createHash=require("create-hash"),stream=require("stream"),inherits=require("inherits"),sign=require("./sign"),verify=require("./verify"),algorithms=require("./algorithms.json");Object.keys(algorithms).forEach(function(key){algorithms[key].id=new Buffer(algorithms[key].id,"hex"),algorithms[key.toLowerCase()]=algorithms[key]}),inherits(Sign,stream.Writable),Sign.prototype._write=function(data,_,done){this._hash.update(data),done()},Sign.prototype.update=function(data,enc){return"string"==typeof data&&(data=new Buffer(data,enc)),this._hash.update(data),this},Sign.prototype.sign=function(key,enc){this.end();var hash=this._hash.digest(),sig=sign(hash,key,this._hashType,this._signType,this._tag);return enc?sig.toString(enc):sig},inherits(Verify,stream.Writable),Verify.prototype._write=function(data,_,done){this._hash.update(data),done()},Verify.prototype.update=function(data,enc){return"string"==typeof data&&(data=new Buffer(data,enc)),this._hash.update(data),this},Verify.prototype.verify=function(key,sig,enc){"string"==typeof sig&&(sig=new Buffer(sig,enc)),this.end();var hash=this._hash.digest();return verify(sig,hash,key,this._signType,this._tag)},module.exports={Sign:createSign,Verify:createVerify,createSign:createSign,createVerify:createVerify}}).call(this,require("buffer").Buffer)},{"./algorithms.json":142,"./sign":145,"./verify":146,buffer:151,"create-hash":177,inherits:233,stream:345}],145:[function(require,module,exports){(function(Buffer){function sign(hash,key,hashType,signType,tag){var priv=parseKeys(key);if(priv.curve){if("ecdsa"!==signType&&"ecdsa/rsa"!==signType)throw new Error("wrong private key type");return ecSign(hash,priv)}if("dsa"===priv.type){if("dsa"!==signType)throw new Error("wrong private key type");return dsaSign(hash,priv,hashType)}if("rsa"!==signType&&"ecdsa/rsa"!==signType)throw new Error("wrong private key type");hash=Buffer.concat([tag,hash]);for(var len=priv.modulus.byteLength(),pad=[0,1];hash.length+pad.length+1<len;)pad.push(255);pad.push(0);for(var i=-1;++i<hash.length;)pad.push(hash[i]);var out=crt(pad,priv);return out}function ecSign(hash,priv){var curveId=curves[priv.curve.join(".")];if(!curveId)throw new Error("unknown curve "+priv.curve.join("."));var curve=new EC(curveId),key=curve.keyFromPrivate(priv.privateKey),out=key.sign(hash);return new Buffer(out.toDER())}function dsaSign(hash,priv,algo){for(var k,x=priv.params.priv_key,p=priv.params.p,q=priv.params.q,g=priv.params.g,r=new BN(0),H=bits2int(hash,q).mod(q),s=!1,kv=getKey(x,q,hash,algo);s===!1;)k=makeKey(q,kv,algo),r=makeR(g,k,p,q),s=k.invm(q).imul(H.add(x.mul(r))).mod(q),0===s.cmpn(0)&&(s=!1,r=new BN(0));return toDER(r,s)}function toDER(r,s){r=r.toArray(),s=s.toArray(),128&r[0]&&(r=[0].concat(r)),128&s[0]&&(s=[0].concat(s));var total=r.length+s.length+4,res=[48,total,2,r.length];return res=res.concat(r,[2,s.length],s),new Buffer(res)}function getKey(x,q,hash,algo){if(x=new Buffer(x.toArray()),x.length<q.byteLength()){var zeros=new Buffer(q.byteLength()-x.length);zeros.fill(0),x=Buffer.concat([zeros,x])}var hlen=hash.length,hbits=bits2octets(hash,q),v=new Buffer(hlen);v.fill(1);var k=new Buffer(hlen);return k.fill(0),k=createHmac(algo,k).update(v).update(new Buffer([0])).update(x).update(hbits).digest(),v=createHmac(algo,k).update(v).digest(),k=createHmac(algo,k).update(v).update(new Buffer([1])).update(x).update(hbits).digest(),v=createHmac(algo,k).update(v).digest(),{k:k,v:v}}function bits2int(obits,q){var bits=new BN(obits),shift=(obits.length<<3)-q.bitLength();return shift>0&&bits.ishrn(shift),bits}function bits2octets(bits,q){bits=bits2int(bits,q),bits=bits.mod(q);var out=new Buffer(bits.toArray());if(out.length<q.byteLength()){var zeros=new Buffer(q.byteLength()-out.length);zeros.fill(0),out=Buffer.concat([zeros,out])}return out}function makeKey(q,kv,algo){var t,k;do{for(t=new Buffer(0);8*t.length<q.bitLength();)kv.v=createHmac(algo,kv.k).update(kv.v).digest(),t=Buffer.concat([t,kv.v]);k=bits2int(t,q),kv.k=createHmac(algo,kv.k).update(kv.v).update(new Buffer([0])).digest(),kv.v=createHmac(algo,kv.k).update(kv.v).digest()}while(k.cmp(q)!==-1);return k}function makeR(g,k,p,q){return g.toRed(BN.mont(p)).redPow(k).fromRed().mod(q)}var createHmac=require("create-hmac"),crt=require("browserify-rsa"),EC=require("elliptic").ec,BN=require("bn.js"),parseKeys=require("parse-asn1"),curves=require("./curves.json");module.exports=sign,module.exports.getKey=getKey,module.exports.makeKey=makeKey}).call(this,require("buffer").Buffer)},{"./curves.json":143,"bn.js":117,"browserify-rsa":140,buffer:151,"create-hmac":179,elliptic:199,"parse-asn1":297}],146:[function(require,module,exports){(function(Buffer){function verify(sig,hash,key,signType,tag){var pub=parseKeys(key);if("ec"===pub.type){if("ecdsa"!==signType&&"ecdsa/rsa"!==signType)throw new Error("wrong public key type");return ecVerify(sig,hash,pub)}if("dsa"===pub.type){if("dsa"!==signType)throw new Error("wrong public key type");return dsaVerify(sig,hash,pub)}if("rsa"!==signType&&"ecdsa/rsa"!==signType)throw new Error("wrong public key type");hash=Buffer.concat([tag,hash]);for(var len=pub.modulus.byteLength(),pad=[1],padNum=0;hash.length+pad.length+2<len;)pad.push(255),padNum++;pad.push(0);for(var i=-1;++i<hash.length;)pad.push(hash[i]);pad=new Buffer(pad);var red=BN.mont(pub.modulus);sig=new BN(sig).toRed(red),sig=sig.redPow(new BN(pub.publicExponent)),sig=new Buffer(sig.fromRed().toArray());var out=padNum<8?1:0;for(len=Math.min(sig.length,pad.length),sig.length!==pad.length&&(out=1),i=-1;++i<len;)out|=sig[i]^pad[i];return 0===out}function ecVerify(sig,hash,pub){var curveId=curves[pub.data.algorithm.curve.join(".")];if(!curveId)throw new Error("unknown curve "+pub.data.algorithm.curve.join("."));var curve=new EC(curveId),pubkey=pub.data.subjectPrivateKey.data;return curve.verify(hash,sig,pubkey)}function dsaVerify(sig,hash,pub){var p=pub.data.p,q=pub.data.q,g=pub.data.g,y=pub.data.pub_key,unpacked=parseKeys.signature.decode(sig,"der"),s=unpacked.s,r=unpacked.r;checkValue(s,q),checkValue(r,q);var montp=BN.mont(p),w=s.invm(q),v=g.toRed(montp).redPow(new BN(hash).mul(w).mod(q)).fromRed().mul(y.toRed(montp).redPow(r.mul(w).mod(q)).fromRed()).mod(p).mod(q);return 0===v.cmp(r)}function checkValue(b,q){if(b.cmpn(0)<=0)throw new Error("invalid sig");if(b.cmp(q)>=q)throw new Error("invalid sig")}var BN=require("bn.js"),EC=require("elliptic").ec,parseKeys=require("parse-asn1"),curves=require("./curves.json");module.exports=verify}).call(this,require("buffer").Buffer)},{"./curves.json":143,"bn.js":117,buffer:151,elliptic:199,"parse-asn1":297}],147:[function(require,module,exports){arguments[4][119][0].apply(exports,arguments)},{dup:119}],148:[function(require,module,exports){"use strict";function _normalizeEncoding(enc){if(!enc)return"utf8";for(var retried;;)switch(enc){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return enc;default:if(retried)return;enc=(""+enc).toLowerCase(),retried=!0}}function normalizeEncoding(enc){var nenc=_normalizeEncoding(enc);if("string"!=typeof nenc&&(Buffer.isEncoding===isEncoding||!isEncoding(enc)))throw new Error("Unknown encoding: "+enc);return nenc||enc}function StringDecoder(encoding){this.encoding=normalizeEncoding(encoding);var nb;switch(this.encoding){case"utf16le":this.text=utf16Text,this.end=utf16End,nb=4;break;case"utf8":this.fillLast=utf8FillLast,nb=4;break;case"base64":this.text=base64Text,this.end=base64End,nb=3;break;default:return this.write=simpleWrite,void(this.end=simpleEnd)}this.lastNeed=0,this.lastTotal=0,this.lastChar=Buffer.allocUnsafe(nb)}function utf8CheckByte(byte){return byte<=127?0:byte>>5===6?2:byte>>4===14?3:byte>>3===30?4:byte>>6===2?-1:-2}function utf8CheckIncomplete(self,buf,i){var j=buf.length-1;if(j<i)return 0;var nb=utf8CheckByte(buf[j]);return nb>=0?(nb>0&&(self.lastNeed=nb-1),nb):--j<i||nb===-2?0:(nb=utf8CheckByte(buf[j]),nb>=0?(nb>0&&(self.lastNeed=nb-2),nb):--j<i||nb===-2?0:(nb=utf8CheckByte(buf[j]),nb>=0?(nb>0&&(2===nb?nb=0:self.lastNeed=nb-3),nb):0))}function utf8CheckExtraBytes(self,buf,p){if(128!==(192&buf[0]))return self.lastNeed=0,"";if(self.lastNeed>1&&buf.length>1){if(128!==(192&buf[1]))return self.lastNeed=1,"";if(self.lastNeed>2&&buf.length>2&&128!==(192&buf[2]))return self.lastNeed=2,""}}function utf8FillLast(buf){var p=this.lastTotal-this.lastNeed,r=utf8CheckExtraBytes(this,buf,p);return void 0!==r?r:this.lastNeed<=buf.length?(buf.copy(this.lastChar,p,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(buf.copy(this.lastChar,p,0,buf.length),void(this.lastNeed-=buf.length))}function utf8Text(buf,i){var total=utf8CheckIncomplete(this,buf,i);if(!this.lastNeed)return buf.toString("utf8",i);this.lastTotal=total;var end=buf.length-(total-this.lastNeed);return buf.copy(this.lastChar,0,end),buf.toString("utf8",i,end)}function utf8End(buf){var r=buf&&buf.length?this.write(buf):"";return this.lastNeed?r+"":r}function utf16Text(buf,i){if((buf.length-i)%2===0){var r=buf.toString("utf16le",i);if(r){var c=r.charCodeAt(r.length-1);if(c>=55296&&c<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=buf[buf.length-2],this.lastChar[1]=buf[buf.length-1],r.slice(0,-1)}return r}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=buf[buf.length-1],buf.toString("utf16le",i,buf.length-1)}function utf16End(buf){var r=buf&&buf.length?this.write(buf):"";if(this.lastNeed){var end=this.lastTotal-this.lastNeed;return r+this.lastChar.toString("utf16le",0,end)}return r}function base64Text(buf,i){var n=(buf.length-i)%3;return 0===n?buf.toString("base64",i):(this.lastNeed=3-n,this.lastTotal=3,1===n?this.lastChar[0]=buf[buf.length-1]:(this.lastChar[0]=buf[buf.length-2],this.lastChar[1]=buf[buf.length-1]),buf.toString("base64",i,buf.length-n))}function base64End(buf){var r=buf&&buf.length?this.write(buf):"";return this.lastNeed?r+this.lastChar.toString("base64",0,3-this.lastNeed):r}function simpleWrite(buf){return buf.toString(this.encoding)}function simpleEnd(buf){return buf&&buf.length?this.write(buf):""}var Buffer=require("safe-buffer").Buffer,isEncoding=Buffer.isEncoding||function(encoding){switch(encoding=""+encoding,encoding&&encoding.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};exports.StringDecoder=StringDecoder,StringDecoder.prototype.write=function(buf){if(0===buf.length)return"";var r,i;if(this.lastNeed){if(r=this.fillLast(buf),void 0===r)return"";i=this.lastNeed,this.lastNeed=0}else i=0;return i<buf.length?r?r+this.text(buf,i):this.text(buf,i):r||""},StringDecoder.prototype.end=utf8End,StringDecoder.prototype.text=utf8Text,StringDecoder.prototype.fillLast=function(buf){return this.lastNeed<=buf.length?(buf.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(buf.copy(this.lastChar,this.lastTotal-this.lastNeed,0,buf.length),void(this.lastNeed-=buf.length))}},{"safe-buffer":323}],149:[function(require,module,exports){function encode(buffer){if(0===buffer.length)return"";var i,j,digits=[0];for(i=0;i<buffer.length;i++){for(j=0;j<digits.length;j++)digits[j]<<=8;digits[0]+=buffer[i];var carry=0;for(j=0;j<digits.length;++j)digits[j]+=carry,carry=digits[j]/BASE|0,digits[j]%=BASE;for(;carry;)digits.push(carry%BASE),carry=carry/BASE|0}for(i=0;0===buffer[i]&&i<buffer.length-1;i++)digits.push(0);for(var stringOutput="",i=digits.length-1;i>=0;i--)stringOutput+=ALPHABET[digits[i]];return stringOutput}function decode(string){if(0===string.length)return[];var i,j,bytes=[0];for(i=0;i<string.length;i++){var c=string[i];if(!(c in ALPHABET_MAP))throw new Error("Non-base58 character");for(j=0;j<bytes.length;j++)bytes[j]*=BASE;bytes[0]+=ALPHABET_MAP[c];var carry=0;for(j=0;j<bytes.length;++j)bytes[j]+=carry,carry=bytes[j]>>8,bytes[j]&=255;for(;carry;)bytes.push(255&carry),carry>>=8}for(i=0;"1"===string[i]&&i<string.length-1;i++)bytes.push(0);return bytes.reverse()}for(var ALPHABET="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",ALPHABET_MAP={},i=0;i<ALPHABET.length;i++)ALPHABET_MAP[ALPHABET.charAt(i)]=i;var BASE=58;module.exports={encode:encode,decode:decode}},{}],150:[function(require,module,exports){(function(Buffer){module.exports=function(a,b){for(var length=Math.min(a.length,b.length),buffer=new Buffer(length),i=0;i<length;++i)buffer[i]=a[i]^b[i];return buffer}}).call(this,require("buffer").Buffer)},{buffer:151}],151:[function(require,module,exports){"use strict";function typedArraySupport(){try{var arr=new Uint8Array(1);return arr.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===arr.foo()}catch(e){return!1}}function createBuffer(length){if(length>K_MAX_LENGTH)throw new RangeError("Invalid typed array length");var buf=new Uint8Array(length);return buf.__proto__=Buffer.prototype,buf}function Buffer(arg,encodingOrOffset,length){if("number"==typeof arg){if("string"==typeof encodingOrOffset)throw new Error("If encoding is specified then the first argument must be a string");return allocUnsafe(arg)}return from(arg,encodingOrOffset,length)}function from(value,encodingOrOffset,length){if("number"==typeof value)throw new TypeError('"value" argument must not be a number');return isArrayBuffer(value)||value&&isArrayBuffer(value.buffer)?fromArrayBuffer(value,encodingOrOffset,length):"string"==typeof value?fromString(value,encodingOrOffset):fromObject(value)}function assertSize(size){if("number"!=typeof size)throw new TypeError('"size" argument must be of type number');if(size<0)throw new RangeError('"size" argument must not be negative')}function alloc(size,fill,encoding){return assertSize(size),size<=0?createBuffer(size):void 0!==fill?"string"==typeof encoding?createBuffer(size).fill(fill,encoding):createBuffer(size).fill(fill):createBuffer(size)}function allocUnsafe(size){return assertSize(size),createBuffer(size<0?0:0|checked(size))}function fromString(string,encoding){if("string"==typeof encoding&&""!==encoding||(encoding="utf8"),!Buffer.isEncoding(encoding))throw new TypeError("Unknown encoding: "+encoding);var length=0|byteLength(string,encoding),buf=createBuffer(length),actual=buf.write(string,encoding);return actual!==length&&(buf=buf.slice(0,actual)),buf}function fromArrayLike(array){for(var length=array.length<0?0:0|checked(array.length),buf=createBuffer(length),i=0;i<length;i+=1)buf[i]=255&array[i];return buf}function fromArrayBuffer(array,byteOffset,length){if(byteOffset<0||array.byteLength<byteOffset)throw new RangeError('"offset" is outside of buffer bounds');if(array.byteLength<byteOffset+(length||0))throw new RangeError('"length" is outside of buffer bounds');var buf;return buf=void 0===byteOffset&&void 0===length?new Uint8Array(array):void 0===length?new Uint8Array(array,byteOffset):new Uint8Array(array,byteOffset,length),buf.__proto__=Buffer.prototype,buf}function fromObject(obj){if(Buffer.isBuffer(obj)){var len=0|checked(obj.length),buf=createBuffer(len);return 0===buf.length?buf:(obj.copy(buf,0,0,len),buf)}if(obj){if(ArrayBuffer.isView(obj)||"length"in obj)return"number"!=typeof obj.length||numberIsNaN(obj.length)?createBuffer(0):fromArrayLike(obj);if("Buffer"===obj.type&&Array.isArray(obj.data))return fromArrayLike(obj.data)}throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object.")}function checked(length){if(length>=K_MAX_LENGTH)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+K_MAX_LENGTH.toString(16)+" bytes");return 0|length}function SlowBuffer(length){return+length!=length&&(length=0),Buffer.alloc(+length)}function byteLength(string,encoding){if(Buffer.isBuffer(string))return string.length;if(ArrayBuffer.isView(string)||isArrayBuffer(string))return string.byteLength;"string"!=typeof string&&(string=""+string);var len=string.length;if(0===len)return 0;for(var loweredCase=!1;;)switch(encoding){case"ascii":case"latin1":case"binary":return len;case"utf8":case"utf-8":case void 0:return utf8ToBytes(string).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*len;case"hex":return len>>>1;case"base64":return base64ToBytes(string).length;default:if(loweredCase)return utf8ToBytes(string).length;encoding=(""+encoding).toLowerCase(),loweredCase=!0}}function slowToString(encoding,start,end){var loweredCase=!1;if((void 0===start||start<0)&&(start=0),start>this.length)return"";if((void 0===end||end>this.length)&&(end=this.length),end<=0)return"";if(end>>>=0,start>>>=0,end<=start)return"";for(encoding||(encoding="utf8");;)switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"latin1":case"binary":return latin1Slice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase(),loweredCase=!0}}function swap(b,n,m){var i=b[n];b[n]=b[m],b[m]=i}function bidirectionalIndexOf(buffer,val,byteOffset,encoding,dir){if(0===buffer.length)return-1;if("string"==typeof byteOffset?(encoding=byteOffset,byteOffset=0):byteOffset>2147483647?byteOffset=2147483647:byteOffset<-2147483648&&(byteOffset=-2147483648),byteOffset=+byteOffset,numberIsNaN(byteOffset)&&(byteOffset=dir?0:buffer.length-1),byteOffset<0&&(byteOffset=buffer.length+byteOffset),byteOffset>=buffer.length){if(dir)return-1;byteOffset=buffer.length-1}else if(byteOffset<0){if(!dir)return-1;byteOffset=0}if("string"==typeof val&&(val=Buffer.from(val,encoding)),Buffer.isBuffer(val))return 0===val.length?-1:arrayIndexOf(buffer,val,byteOffset,encoding,dir);if("number"==typeof val)return val=255&val,"function"==typeof Uint8Array.prototype.indexOf?dir?Uint8Array.prototype.indexOf.call(buffer,val,byteOffset):Uint8Array.prototype.lastIndexOf.call(buffer,val,byteOffset):arrayIndexOf(buffer,[val],byteOffset,encoding,dir);throw new TypeError("val must be string, number or Buffer")}function arrayIndexOf(arr,val,byteOffset,encoding,dir){function read(buf,i){return 1===indexSize?buf[i]:buf.readUInt16BE(i*indexSize)}var indexSize=1,arrLength=arr.length,valLength=val.length;if(void 0!==encoding&&(encoding=String(encoding).toLowerCase(),"ucs2"===encoding||"ucs-2"===encoding||"utf16le"===encoding||"utf-16le"===encoding)){if(arr.length<2||val.length<2)return-1;indexSize=2,arrLength/=2,valLength/=2,byteOffset/=2}var i;if(dir){var foundIndex=-1;for(i=byteOffset;i<arrLength;i++)if(read(arr,i)===read(val,foundIndex===-1?0:i-foundIndex)){if(foundIndex===-1&&(foundIndex=i),i-foundIndex+1===valLength)return foundIndex*indexSize}else foundIndex!==-1&&(i-=i-foundIndex),foundIndex=-1}else for(byteOffset+valLength>arrLength&&(byteOffset=arrLength-valLength),i=byteOffset;i>=0;i--){for(var found=!0,j=0;j<valLength;j++)if(read(arr,i+j)!==read(val,j)){found=!1;break}if(found)return i}return-1}function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;length?(length=Number(length),length>remaining&&(length=remaining)):length=remaining;var strLen=string.length;length>strLen/2&&(length=strLen/2);for(var i=0;i<length;++i){var parsed=parseInt(string.substr(2*i,2),16);if(numberIsNaN(parsed))return i;buf[offset+i]=parsed}return i}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length)}function asciiWrite(buf,string,offset,length){return blitBuffer(asciiToBytes(string),buf,offset,length)}function latin1Write(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length)}function ucs2Write(buf,string,offset,length){return blitBuffer(utf16leToBytes(string,buf.length-offset),buf,offset,length)}function base64Slice(buf,start,end){return 0===start&&end===buf.length?base64.fromByteArray(buf):base64.fromByteArray(buf.slice(start,end))}function utf8Slice(buf,start,end){end=Math.min(buf.length,end);for(var res=[],i=start;i<end;){var firstByte=buf[i],codePoint=null,bytesPerSequence=firstByte>239?4:firstByte>223?3:firstByte>191?2:1;if(i+bytesPerSequence<=end){var secondByte,thirdByte,fourthByte,tempCodePoint;switch(bytesPerSequence){case 1:firstByte<128&&(codePoint=firstByte);break;case 2:secondByte=buf[i+1],128===(192&secondByte)&&(tempCodePoint=(31&firstByte)<<6|63&secondByte,tempCodePoint>127&&(codePoint=tempCodePoint));break;case 3:secondByte=buf[i+1],thirdByte=buf[i+2],128===(192&secondByte)&&128===(192&thirdByte)&&(tempCodePoint=(15&firstByte)<<12|(63&secondByte)<<6|63&thirdByte,tempCodePoint>2047&&(tempCodePoint<55296||tempCodePoint>57343)&&(codePoint=tempCodePoint));break;case 4:secondByte=buf[i+1],thirdByte=buf[i+2],fourthByte=buf[i+3],128===(192&secondByte)&&128===(192&thirdByte)&&128===(192&fourthByte)&&(tempCodePoint=(15&firstByte)<<18|(63&secondByte)<<12|(63&thirdByte)<<6|63&fourthByte,tempCodePoint>65535&&tempCodePoint<1114112&&(codePoint=tempCodePoint))}}null===codePoint?(codePoint=65533,bytesPerSequence=1):codePoint>65535&&(codePoint-=65536,res.push(codePoint>>>10&1023|55296),codePoint=56320|1023&codePoint),res.push(codePoint),i+=bytesPerSequence}return decodeCodePointsArray(res)}function decodeCodePointsArray(codePoints){var len=codePoints.length;if(len<=MAX_ARGUMENTS_LENGTH)return String.fromCharCode.apply(String,codePoints);for(var res="",i=0;i<len;)res+=String.fromCharCode.apply(String,codePoints.slice(i,i+=MAX_ARGUMENTS_LENGTH));return res}function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i)ret+=String.fromCharCode(127&buf[i]);return ret}function latin1Slice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i)ret+=String.fromCharCode(buf[i]);return ret}function hexSlice(buf,start,end){var len=buf.length;(!start||start<0)&&(start=0),(!end||end<0||end>len)&&(end=len);for(var out="",i=start;i<end;++i)out+=toHex(buf[i]);return out}function utf16leSlice(buf,start,end){for(var bytes=buf.slice(start,end),res="",i=0;i<bytes.length;i+=2)res+=String.fromCharCode(bytes[i]+256*bytes[i+1]);return res}function checkOffset(offset,ext,length){if(offset%1!==0||offset<0)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError('"buffer" argument must be a Buffer instance');if(value>max||value<min)throw new RangeError('"value" argument is out of bounds');if(offset+ext>buf.length)throw new RangeError("Index out of range")}function checkIEEE754(buf,value,offset,ext,max,min){if(offset+ext>buf.length)throw new RangeError("Index out of range");if(offset<0)throw new RangeError("Index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){return value=+value,offset>>>=0,noAssert||checkIEEE754(buf,value,offset,4,3.4028234663852886e38,-3.4028234663852886e38),ieee754.write(buf,value,offset,littleEndian,23,4),offset+4}function writeDouble(buf,value,offset,littleEndian,noAssert){return value=+value,offset>>>=0,noAssert||checkIEEE754(buf,value,offset,8,1.7976931348623157e308,-1.7976931348623157e308),ieee754.write(buf,value,offset,littleEndian,52,8),offset+8}function base64clean(str){if(str=str.split("=")[0],str=str.trim().replace(INVALID_BASE64_RE,""),str.length<2)return"";for(;str.length%4!==0;)str+="=";return str}function toHex(n){return n<16?"0"+n.toString(16):n.toString(16)}function utf8ToBytes(string,units){units=units||1/0;for(var codePoint,length=string.length,leadSurrogate=null,bytes=[],i=0;i<length;++i){if(codePoint=string.charCodeAt(i),codePoint>55295&&codePoint<57344){if(!leadSurrogate){if(codePoint>56319){(units-=3)>-1&&bytes.push(239,191,189);continue}if(i+1===length){(units-=3)>-1&&bytes.push(239,191,189);continue}leadSurrogate=codePoint;continue}if(codePoint<56320){(units-=3)>-1&&bytes.push(239,191,189),leadSurrogate=codePoint;continue}codePoint=(leadSurrogate-55296<<10|codePoint-56320)+65536}else leadSurrogate&&(units-=3)>-1&&bytes.push(239,191,189);if(leadSurrogate=null,codePoint<128){if((units-=1)<0)break;bytes.push(codePoint)}else if(codePoint<2048){if((units-=2)<0)break;bytes.push(codePoint>>6|192,63&codePoint|128)}else if(codePoint<65536){if((units-=3)<0)break;bytes.push(codePoint>>12|224,codePoint>>6&63|128,63&codePoint|128)}else{if(!(codePoint<1114112))throw new Error("Invalid code point");if((units-=4)<0)break;bytes.push(codePoint>>18|240,codePoint>>12&63|128,codePoint>>6&63|128,63&codePoint|128)}}return bytes}function asciiToBytes(str){for(var byteArray=[],i=0;i<str.length;++i)byteArray.push(255&str.charCodeAt(i));return byteArray}function utf16leToBytes(str,units){for(var c,hi,lo,byteArray=[],i=0;i<str.length&&!((units-=2)<0);++i)c=str.charCodeAt(i),hi=c>>8,lo=c%256,byteArray.push(lo),byteArray.push(hi);return byteArray}function base64ToBytes(str){return base64.toByteArray(base64clean(str))}function blitBuffer(src,dst,offset,length){for(var i=0;i<length&&!(i+offset>=dst.length||i>=src.length);++i)dst[i+offset]=src[i];return i}function isArrayBuffer(obj){return obj instanceof ArrayBuffer||null!=obj&&null!=obj.constructor&&"ArrayBuffer"===obj.constructor.name&&"number"==typeof obj.byteLength}function numberIsNaN(obj){return obj!==obj}var base64=require("base64-js"),ieee754=require("ieee754");exports.Buffer=Buffer,exports.SlowBuffer=SlowBuffer,exports.INSPECT_MAX_BYTES=50;var K_MAX_LENGTH=2147483647;exports.kMaxLength=K_MAX_LENGTH,Buffer.TYPED_ARRAY_SUPPORT=typedArraySupport(),Buffer.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(Buffer.prototype,"parent",{get:function(){if(this instanceof Buffer)return this.buffer}}),Object.defineProperty(Buffer.prototype,"offset",{get:function(){if(this instanceof Buffer)return this.byteOffset}}),"undefined"!=typeof Symbol&&Symbol.species&&Buffer[Symbol.species]===Buffer&&Object.defineProperty(Buffer,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),Buffer.poolSize=8192,Buffer.from=function(value,encodingOrOffset,length){return from(value,encodingOrOffset,length)},Buffer.prototype.__proto__=Uint8Array.prototype,Buffer.__proto__=Uint8Array,Buffer.alloc=function(size,fill,encoding){return alloc(size,fill,encoding)},Buffer.allocUnsafe=function(size){return allocUnsafe(size)},Buffer.allocUnsafeSlow=function(size){return allocUnsafe(size)},Buffer.isBuffer=function(b){return null!=b&&b._isBuffer===!0},Buffer.compare=function(a,b){if(!Buffer.isBuffer(a)||!Buffer.isBuffer(b))throw new TypeError("Arguments must be Buffers");if(a===b)return 0;for(var x=a.length,y=b.length,i=0,len=Math.min(x,y);i<len;++i)if(a[i]!==b[i]){x=a[i],y=b[i];break}return x<y?-1:y<x?1:0},Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(list,length){if(!Array.isArray(list))throw new TypeError('"list" argument must be an Array of Buffers');if(0===list.length)return Buffer.alloc(0);var i;if(void 0===length)for(length=0,i=0;i<list.length;++i)length+=list[i].length;var buffer=Buffer.allocUnsafe(length),pos=0;for(i=0;i<list.length;++i){var buf=list[i];if(ArrayBuffer.isView(buf)&&(buf=Buffer.from(buf)),!Buffer.isBuffer(buf))throw new TypeError('"list" argument must be an Array of Buffers');buf.copy(buffer,pos),pos+=buf.length}return buffer},Buffer.byteLength=byteLength,Buffer.prototype._isBuffer=!0,Buffer.prototype.swap16=function(){var len=this.length;if(len%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var i=0;i<len;i+=2)swap(this,i,i+1);return this},Buffer.prototype.swap32=function(){var len=this.length;if(len%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var i=0;i<len;i+=4)swap(this,i,i+3),swap(this,i+1,i+2);return this},Buffer.prototype.swap64=function(){var len=this.length;if(len%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var i=0;i<len;i+=8)swap(this,i,i+7),swap(this,i+1,i+6),swap(this,i+2,i+5),swap(this,i+3,i+4);return this},Buffer.prototype.toString=function(){var length=this.length;return 0===length?"":0===arguments.length?utf8Slice(this,0,length):slowToString.apply(this,arguments)},Buffer.prototype.toLocaleString=Buffer.prototype.toString,Buffer.prototype.equals=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return this===b||0===Buffer.compare(this,b)},Buffer.prototype.inspect=function(){var str="",max=exports.INSPECT_MAX_BYTES;return this.length>0&&(str=this.toString("hex",0,max).match(/.{2}/g).join(" "),this.length>max&&(str+=" ... ")),"<Buffer "+str+">"},Buffer.prototype.compare=function(target,start,end,thisStart,thisEnd){if(!Buffer.isBuffer(target))throw new TypeError("Argument must be a Buffer");if(void 0===start&&(start=0),void 0===end&&(end=target?target.length:0),void 0===thisStart&&(thisStart=0),void 0===thisEnd&&(thisEnd=this.length),start<0||end>target.length||thisStart<0||thisEnd>this.length)throw new RangeError("out of range index");
if(thisStart>=thisEnd&&start>=end)return 0;if(thisStart>=thisEnd)return-1;if(start>=end)return 1;if(start>>>=0,end>>>=0,thisStart>>>=0,thisEnd>>>=0,this===target)return 0;for(var x=thisEnd-thisStart,y=end-start,len=Math.min(x,y),thisCopy=this.slice(thisStart,thisEnd),targetCopy=target.slice(start,end),i=0;i<len;++i)if(thisCopy[i]!==targetCopy[i]){x=thisCopy[i],y=targetCopy[i];break}return x<y?-1:y<x?1:0},Buffer.prototype.includes=function(val,byteOffset,encoding){return this.indexOf(val,byteOffset,encoding)!==-1},Buffer.prototype.indexOf=function(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,!0)},Buffer.prototype.lastIndexOf=function(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,!1)},Buffer.prototype.write=function(string,offset,length,encoding){if(void 0===offset)encoding="utf8",length=this.length,offset=0;else if(void 0===length&&"string"==typeof offset)encoding=offset,length=this.length,offset=0;else{if(!isFinite(offset))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");offset>>>=0,isFinite(length)?(length>>>=0,void 0===encoding&&(encoding="utf8")):(encoding=length,length=void 0)}var remaining=this.length-offset;if((void 0===length||length>remaining)&&(length=remaining),string.length>0&&(length<0||offset<0)||offset>this.length)throw new RangeError("Attempt to write outside buffer bounds");encoding||(encoding="utf8");for(var loweredCase=!1;;)switch(encoding){case"hex":return hexWrite(this,string,offset,length);case"utf8":case"utf-8":return utf8Write(this,string,offset,length);case"ascii":return asciiWrite(this,string,offset,length);case"latin1":case"binary":return latin1Write(this,string,offset,length);case"base64":return base64Write(this,string,offset,length);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(""+encoding).toLowerCase(),loweredCase=!0}},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var MAX_ARGUMENTS_LENGTH=4096;Buffer.prototype.slice=function(start,end){var len=this.length;start=~~start,end=void 0===end?len:~~end,start<0?(start+=len,start<0&&(start=0)):start>len&&(start=len),end<0?(end+=len,end<0&&(end=0)):end>len&&(end=len),end<start&&(end=start);var newBuf=this.subarray(start,end);return newBuf.__proto__=Buffer.prototype,newBuf},Buffer.prototype.readUIntLE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return val},Buffer.prototype.readUIntBE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset+--byteLength],mul=1;byteLength>0&&(mul*=256);)val+=this[offset+--byteLength]*mul;return val},Buffer.prototype.readUInt8=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,1,this.length),this[offset]},Buffer.prototype.readUInt16LE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,2,this.length),this[offset]|this[offset+1]<<8},Buffer.prototype.readUInt16BE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,2,this.length),this[offset]<<8|this[offset+1]},Buffer.prototype.readUInt32LE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+16777216*this[offset+3]},Buffer.prototype.readUInt32BE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),16777216*this[offset]+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])},Buffer.prototype.readIntLE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return mul*=128,val>=mul&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readIntBE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);for(var i=byteLength,mul=1,val=this[offset+--i];i>0&&(mul*=256);)val+=this[offset+--i]*mul;return mul*=128,val>=mul&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readInt8=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,1,this.length),128&this[offset]?(255-this[offset]+1)*-1:this[offset]},Buffer.prototype.readInt16LE=function(offset,noAssert){offset>>>=0,noAssert||checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt16BE=function(offset,noAssert){offset>>>=0,noAssert||checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt32LE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24},Buffer.prototype.readInt32BE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]},Buffer.prototype.readFloatLE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!0,23,4)},Buffer.prototype.readFloatBE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!1,23,4)},Buffer.prototype.readDoubleLE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!0,52,8)},Buffer.prototype.readDoubleBE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!1,52,8)},Buffer.prototype.writeUIntLE=function(value,offset,byteLength,noAssert){if(value=+value,offset>>>=0,byteLength>>>=0,!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0)}var mul=1,i=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUIntBE=function(value,offset,byteLength,noAssert){if(value=+value,offset>>>=0,byteLength>>>=0,!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0)}var i=byteLength-1,mul=1;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUInt8=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,1,255,0),this[offset]=255&value,offset+1},Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,65535,0),this[offset]=255&value,this[offset+1]=value>>>8,offset+2},Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,65535,0),this[offset]=value>>>8,this[offset+1]=255&value,offset+2},Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,4294967295,0),this[offset+3]=value>>>24,this[offset+2]=value>>>16,this[offset+1]=value>>>8,this[offset]=255&value,offset+4},Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,4294967295,0),this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value,offset+4},Buffer.prototype.writeIntLE=function(value,offset,byteLength,noAssert){if(value=+value,offset>>>=0,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=0,mul=1,sub=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)value<0&&0===sub&&0!==this[offset+i-1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeIntBE=function(value,offset,byteLength,noAssert){if(value=+value,offset>>>=0,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=byteLength-1,mul=1,sub=0;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)value<0&&0===sub&&0!==this[offset+i+1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeInt8=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,1,127,-128),value<0&&(value=255+value+1),this[offset]=255&value,offset+1},Buffer.prototype.writeInt16LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,32767,-32768),this[offset]=255&value,this[offset+1]=value>>>8,offset+2},Buffer.prototype.writeInt16BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,32767,-32768),this[offset]=value>>>8,this[offset+1]=255&value,offset+2},Buffer.prototype.writeInt32LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),this[offset]=255&value,this[offset+1]=value>>>8,this[offset+2]=value>>>16,this[offset+3]=value>>>24,offset+4},Buffer.prototype.writeInt32BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),value<0&&(value=4294967295+value+1),this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value,offset+4},Buffer.prototype.writeFloatLE=function(value,offset,noAssert){return writeFloat(this,value,offset,!0,noAssert)},Buffer.prototype.writeFloatBE=function(value,offset,noAssert){return writeFloat(this,value,offset,!1,noAssert)},Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){return writeDouble(this,value,offset,!0,noAssert)},Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){return writeDouble(this,value,offset,!1,noAssert)},Buffer.prototype.copy=function(target,targetStart,start,end){if(!Buffer.isBuffer(target))throw new TypeError("argument should be a Buffer");if(start||(start=0),end||0===end||(end=this.length),targetStart>=target.length&&(targetStart=target.length),targetStart||(targetStart=0),end>0&&end<start&&(end=start),end===start)return 0;if(0===target.length||0===this.length)return 0;if(targetStart<0)throw new RangeError("targetStart out of bounds");if(start<0||start>=this.length)throw new RangeError("Index out of range");if(end<0)throw new RangeError("sourceEnd out of bounds");end>this.length&&(end=this.length),target.length-targetStart<end-start&&(end=target.length-targetStart+start);var len=end-start;if(this===target&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(targetStart,start,end);else if(this===target&&start<targetStart&&targetStart<end)for(var i=len-1;i>=0;--i)target[i+targetStart]=this[i+start];else Uint8Array.prototype.set.call(target,this.subarray(start,end),targetStart);return len},Buffer.prototype.fill=function(val,start,end,encoding){if("string"==typeof val){if("string"==typeof start?(encoding=start,start=0,end=this.length):"string"==typeof end&&(encoding=end,end=this.length),void 0!==encoding&&"string"!=typeof encoding)throw new TypeError("encoding must be a string");if("string"==typeof encoding&&!Buffer.isEncoding(encoding))throw new TypeError("Unknown encoding: "+encoding);if(1===val.length){var code=val.charCodeAt(0);("utf8"===encoding&&code<128||"latin1"===encoding)&&(val=code)}}else"number"==typeof val&&(val=255&val);if(start<0||this.length<start||this.length<end)throw new RangeError("Out of range index");if(end<=start)return this;start>>>=0,end=void 0===end?this.length:end>>>0,val||(val=0);var i;if("number"==typeof val)for(i=start;i<end;++i)this[i]=val;else{var bytes=Buffer.isBuffer(val)?val:new Buffer(val,encoding),len=bytes.length;if(0===len)throw new TypeError('The value "'+val+'" is invalid for argument "value"');for(i=0;i<end-start;++i)this[i+start]=bytes[i%len]}return this};var INVALID_BASE64_RE=/[^+\/0-9A-Za-z-_]/g},{"base64-js":27,ieee754:231}],152:[function(require,module,exports){function CipherBase(hashMode){Transform.call(this),this.hashMode="string"==typeof hashMode,this.hashMode?this[hashMode]=this._finalOrDigest:this["final"]=this._finalOrDigest,this._final&&(this.__final=this._final,this._final=null),this._decoder=null,this._encoding=null}var Buffer=require("safe-buffer").Buffer,Transform=require("stream").Transform,StringDecoder=require("string_decoder").StringDecoder,inherits=require("inherits");inherits(CipherBase,Transform),CipherBase.prototype.update=function(data,inputEnc,outputEnc){"string"==typeof data&&(data=Buffer.from(data,inputEnc));var outData=this._update(data);return this.hashMode?this:(outputEnc&&(outData=this._toString(outData,outputEnc)),outData)},CipherBase.prototype.setAutoPadding=function(){},CipherBase.prototype.getAuthTag=function(){throw new Error("trying to get auth tag in unsupported state")},CipherBase.prototype.setAuthTag=function(){throw new Error("trying to set auth tag in unsupported state")},CipherBase.prototype.setAAD=function(){throw new Error("trying to set aad in unsupported state")},CipherBase.prototype._transform=function(data,_,next){var err;try{this.hashMode?this._update(data):this.push(this._update(data))}catch(e){err=e}finally{next(err)}},CipherBase.prototype._flush=function(done){var err;try{this.push(this.__final())}catch(e){err=e}done(err)},CipherBase.prototype._finalOrDigest=function(outputEnc){var outData=this.__final()||Buffer.alloc(0);return outputEnc&&(outData=this._toString(outData,outputEnc,!0)),outData},CipherBase.prototype._toString=function(value,enc,fin){if(this._decoder||(this._decoder=new StringDecoder(enc),this._encoding=enc),this._encoding!==enc)throw new Error("can't switch encodings");var out=this._decoder.write(value);return fin&&(out+=this._decoder.end()),out},module.exports=CipherBase},{inherits:233,"safe-buffer":323,stream:345,string_decoder:148}],153:[function(require,module,exports){(function(Buffer){function encode(payload,version){(Array.isArray(payload)||payload instanceof Uint8Array)&&(payload=new Buffer(payload));var buf;null!=version?("number"==typeof version&&(version=new Buffer([version])),buf=Buffer.concat([version,payload])):buf=payload;var checksum=sha256x2(buf).slice(0,4),result=Buffer.concat([buf,checksum]);return base58.encode(result)}function decode(base58str,version){var versionLength,arr=base58.decode(base58str),buf=new Buffer(arr);if(null==version)versionLength=0;else{"number"==typeof version&&(version=new Buffer([version])),versionLength=version.length;var versionCompare=buf.slice(0,versionLength);if(versionCompare.toString("hex")!==version.toString("hex"))throw new Error("Invalid version")}var checksum=buf.slice(-4),endPos=buf.length-4,bytes=buf.slice(0,endPos),newChecksum=sha256x2(bytes).slice(0,4);if(checksum.toString("hex")!==newChecksum.toString("hex"))throw new Error("Invalid checksum");return bytes.slice(versionLength)}function isValid(base58str,version){try{decode(base58str,version)}catch(e){return!1}return!0}function createEncoder(version){return function(payload){return encode(payload,version)}}function createDecoder(version){return function(base58str){return decode(base58str,version)}}function createValidator(version){return function(base58str){return isValid(base58str,version)}}function sha256x2(buffer){var sha=createHash("sha256").update(buffer).digest();return createHash("sha256").update(sha).digest()}var base58=require("bs58"),createHash=require("create-hash");module.exports={encode:encode,decode:decode,isValid:isValid,createEncoder:createEncoder,createDecoder:createDecoder,createValidator:createValidator}}).call(this,require("buffer").Buffer)},{bs58:149,buffer:151,"create-hash":177}],154:[function(require,module,exports){require("../modules/web.immediate"),module.exports=require("../modules/_core").setImmediate},{"../modules/_core":158,"../modules/web.immediate":174}],155:[function(require,module,exports){module.exports=function(it){if("function"!=typeof it)throw TypeError(it+" is not a function!");return it}},{}],156:[function(require,module,exports){var isObject=require("./_is-object");module.exports=function(it){if(!isObject(it))throw TypeError(it+" is not an object!");return it}},{"./_is-object":169}],157:[function(require,module,exports){var toString={}.toString;module.exports=function(it){return toString.call(it).slice(8,-1)}},{}],158:[function(require,module,exports){var core=module.exports={version:"2.3.0"};"number"==typeof __e&&(__e=core)},{}],159:[function(require,module,exports){var aFunction=require("./_a-function");module.exports=function(fn,that,length){if(aFunction(fn),void 0===that)return fn;switch(length){case 1:return function(a){return fn.call(that,a)};case 2:return function(a,b){return fn.call(that,a,b)};case 3:return function(a,b,c){return fn.call(that,a,b,c)}}return function(){return fn.apply(that,arguments)}}},{"./_a-function":155}],160:[function(require,module,exports){module.exports=!require("./_fails")(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},{"./_fails":163}],161:[function(require,module,exports){var isObject=require("./_is-object"),document=require("./_global").document,is=isObject(document)&&isObject(document.createElement);module.exports=function(it){return is?document.createElement(it):{}}},{"./_global":164,"./_is-object":169}],162:[function(require,module,exports){var global=require("./_global"),core=require("./_core"),ctx=require("./_ctx"),hide=require("./_hide"),PROTOTYPE="prototype",$export=function(type,name,source){var key,own,out,IS_FORCED=type&$export.F,IS_GLOBAL=type&$export.G,IS_STATIC=type&$export.S,IS_PROTO=type&$export.P,IS_BIND=type&$export.B,IS_WRAP=type&$export.W,exports=IS_GLOBAL?core:core[name]||(core[name]={}),expProto=exports[PROTOTYPE],target=IS_GLOBAL?global:IS_STATIC?global[name]:(global[name]||{})[PROTOTYPE];IS_GLOBAL&&(source=name);for(key in source)own=!IS_FORCED&&target&&void 0!==target[key],own&&key in exports||(out=own?target[key]:source[key],exports[key]=IS_GLOBAL&&"function"!=typeof target[key]?source[key]:IS_BIND&&own?ctx(out,global):IS_WRAP&&target[key]==out?function(C){var F=function(a,b,c){if(this instanceof C){switch(arguments.length){case 0:return new C;case 1:return new C(a);case 2:return new C(a,b)}return new C(a,b,c)}return C.apply(this,arguments)};return F[PROTOTYPE]=C[PROTOTYPE],F}(out):IS_PROTO&&"function"==typeof out?ctx(Function.call,out):out,IS_PROTO&&((exports.virtual||(exports.virtual={}))[key]=out,type&$export.R&&expProto&&!expProto[key]&&hide(expProto,key,out)))};$export.F=1,$export.G=2,$export.S=4,$export.P=8,$export.B=16,$export.W=32,$export.U=64,$export.R=128,module.exports=$export},{"./_core":158,"./_ctx":159,"./_global":164,"./_hide":165}],163:[function(require,module,exports){module.exports=function(exec){try{return!!exec()}catch(e){return!0}}},{}],164:[function(require,module,exports){var global=module.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=global)},{}],165:[function(require,module,exports){var dP=require("./_object-dp"),createDesc=require("./_property-desc");module.exports=require("./_descriptors")?function(object,key,value){return dP.f(object,key,createDesc(1,value))}:function(object,key,value){return object[key]=value,object}},{"./_descriptors":160,"./_object-dp":170,"./_property-desc":171}],166:[function(require,module,exports){module.exports=require("./_global").document&&document.documentElement},{"./_global":164}],167:[function(require,module,exports){module.exports=!require("./_descriptors")&&!require("./_fails")(function(){return 7!=Object.defineProperty(require("./_dom-create")("div"),"a",{get:function(){return 7}}).a})},{"./_descriptors":160,"./_dom-create":161,"./_fails":163}],168:[function(require,module,exports){module.exports=function(fn,args,that){var un=void 0===that;switch(args.length){case 0:return un?fn():fn.call(that);case 1:return un?fn(args[0]):fn.call(that,args[0]);case 2:return un?fn(args[0],args[1]):fn.call(that,args[0],args[1]);case 3:return un?fn(args[0],args[1],args[2]):fn.call(that,args[0],args[1],args[2]);case 4:return un?fn(args[0],args[1],args[2],args[3]):fn.call(that,args[0],args[1],args[2],args[3])}return fn.apply(that,args)}},{}],169:[function(require,module,exports){module.exports=function(it){return"object"==typeof it?null!==it:"function"==typeof it}},{}],170:[function(require,module,exports){var anObject=require("./_an-object"),IE8_DOM_DEFINE=require("./_ie8-dom-define"),toPrimitive=require("./_to-primitive"),dP=Object.defineProperty;exports.f=require("./_descriptors")?Object.defineProperty:function(O,P,Attributes){if(anObject(O),P=toPrimitive(P,!0),anObject(Attributes),IE8_DOM_DEFINE)try{return dP(O,P,Attributes)}catch(e){}if("get"in Attributes||"set"in Attributes)throw TypeError("Accessors not supported!");return"value"in Attributes&&(O[P]=Attributes.value),O}},{"./_an-object":156,"./_descriptors":160,"./_ie8-dom-define":167,"./_to-primitive":173}],171:[function(require,module,exports){module.exports=function(bitmap,value){return{enumerable:!(1&bitmap),configurable:!(2&bitmap),writable:!(4&bitmap),value:value}}},{}],172:[function(require,module,exports){var defer,channel,port,ctx=require("./_ctx"),invoke=require("./_invoke"),html=require("./_html"),cel=require("./_dom-create"),global=require("./_global"),process=global.process,setTask=global.setImmediate,clearTask=global.clearImmediate,MessageChannel=global.MessageChannel,counter=0,queue={},ONREADYSTATECHANGE="onreadystatechange",run=function(){var id=+this;if(queue.hasOwnProperty(id)){var fn=queue[id];delete queue[id],fn()}},listener=function(event){run.call(event.data)};setTask&&clearTask||(setTask=function(fn){for(var args=[],i=1;arguments.length>i;)args.push(arguments[i++]);return queue[++counter]=function(){invoke("function"==typeof fn?fn:Function(fn),args)},defer(counter),counter},clearTask=function(id){delete queue[id]},"process"==require("./_cof")(process)?defer=function(id){process.nextTick(ctx(run,id,1))}:MessageChannel?(channel=new MessageChannel,port=channel.port2,channel.port1.onmessage=listener,defer=ctx(port.postMessage,port,1)):global.addEventListener&&"function"==typeof postMessage&&!global.importScripts?(defer=function(id){global.postMessage(id+"","*")},global.addEventListener("message",listener,!1)):defer=ONREADYSTATECHANGE in cel("script")?function(id){html.appendChild(cel("script"))[ONREADYSTATECHANGE]=function(){html.removeChild(this),run.call(id)}}:function(id){setTimeout(ctx(run,id,1),0)}),module.exports={set:setTask,clear:clearTask}},{"./_cof":157,"./_ctx":159,"./_dom-create":161,"./_global":164,"./_html":166,"./_invoke":168}],173:[function(require,module,exports){var isObject=require("./_is-object");module.exports=function(it,S){if(!isObject(it))return it;var fn,val;if(S&&"function"==typeof(fn=it.toString)&&!isObject(val=fn.call(it)))return val;if("function"==typeof(fn=it.valueOf)&&!isObject(val=fn.call(it)))return val;if(!S&&"function"==typeof(fn=it.toString)&&!isObject(val=fn.call(it)))return val;throw TypeError("Can't convert object to primitive value")}},{"./_is-object":169}],174:[function(require,module,exports){var $export=require("./_export"),$task=require("./_task");$export($export.G+$export.B,{setImmediate:$task.set,clearImmediate:$task.clear})},{"./_export":162,"./_task":172}],175:[function(require,module,exports){(function(Buffer){function isArray(arg){return Array.isArray?Array.isArray(arg):"[object Array]"===objectToString(arg)}function isBoolean(arg){return"boolean"==typeof arg}function isNull(arg){return null===arg}function isNullOrUndefined(arg){return null==arg}function isNumber(arg){return"number"==typeof arg}function isString(arg){return"string"==typeof arg}function isSymbol(arg){return"symbol"==typeof arg}function isUndefined(arg){return void 0===arg}function isRegExp(re){return"[object RegExp]"===objectToString(re)}function isObject(arg){return"object"==typeof arg&&null!==arg}function isDate(d){return"[object Date]"===objectToString(d)}function isError(e){return"[object Error]"===objectToString(e)||e instanceof Error}function isFunction(arg){return"function"==typeof arg}function isPrimitive(arg){return null===arg||"boolean"==typeof arg||"number"==typeof arg||"string"==typeof arg||"symbol"==typeof arg||"undefined"==typeof arg}function objectToString(o){return Object.prototype.toString.call(o)}exports.isArray=isArray,exports.isBoolean=isBoolean,exports.isNull=isNull,exports.isNullOrUndefined=isNullOrUndefined,exports.isNumber=isNumber,exports.isString=isString,exports.isSymbol=isSymbol,exports.isUndefined=isUndefined,exports.isRegExp=isRegExp,exports.isObject=isObject,exports.isDate=isDate,exports.isError=isError,exports.isFunction=isFunction,exports.isPrimitive=isPrimitive,exports.isBuffer=Buffer.isBuffer}).call(this,{isBuffer:require("../../is-buffer/index.js")})},{"../../is-buffer/index.js":234}],176:[function(require,module,exports){(function(Buffer){function ECDH(curve){this.curveType=aliases[curve],this.curveType||(this.curveType={name:curve}),this.curve=new elliptic.ec(this.curveType.name),this.keys=void 0}function formatReturnValue(bn,enc,len){Array.isArray(bn)||(bn=bn.toArray());var buf=new Buffer(bn);if(len&&buf.length<len){var zeros=new Buffer(len-buf.length);zeros.fill(0),buf=Buffer.concat([zeros,buf])}return enc?buf.toString(enc):buf}var elliptic=require("elliptic"),BN=require("bn.js");module.exports=function(curve){return new ECDH(curve)};var aliases={secp256k1:{name:"secp256k1",byteLength:32},secp224r1:{name:"p224",byteLength:28},prime256v1:{name:"p256",byteLength:32},prime192v1:{name:"p192",byteLength:24},ed25519:{name:"ed25519",byteLength:32},secp384r1:{name:"p384",byteLength:48},secp521r1:{name:"p521",byteLength:66}};aliases.p224=aliases.secp224r1,aliases.p256=aliases.secp256r1=aliases.prime256v1,aliases.p192=aliases.secp192r1=aliases.prime192v1,aliases.p384=aliases.secp384r1,aliases.p521=aliases.secp521r1,ECDH.prototype.generateKeys=function(enc,format){return this.keys=this.curve.genKeyPair(),this.getPublicKey(enc,format)},ECDH.prototype.computeSecret=function(other,inenc,enc){inenc=inenc||"utf8",Buffer.isBuffer(other)||(other=new Buffer(other,inenc));var otherPub=this.curve.keyFromPublic(other).getPublic(),out=otherPub.mul(this.keys.getPrivate()).getX();return formatReturnValue(out,enc,this.curveType.byteLength)},ECDH.prototype.getPublicKey=function(enc,format){var key=this.keys.getPublic("compressed"===format,!0);return"hybrid"===format&&(key[key.length-1]%2?key[0]=7:key[0]=6),formatReturnValue(key,enc)},ECDH.prototype.getPrivateKey=function(enc){return formatReturnValue(this.keys.getPrivate(),enc)},ECDH.prototype.setPublicKey=function(pub,enc){return enc=enc||"utf8",Buffer.isBuffer(pub)||(pub=new Buffer(pub,enc)),this.keys._importPublic(pub),this},ECDH.prototype.setPrivateKey=function(priv,enc){enc=enc||"utf8",Buffer.isBuffer(priv)||(priv=new Buffer(priv,enc));var _priv=new BN(priv);return _priv=_priv.toString(16),this.keys=this.curve.genKeyPair(),this.keys._importPrivate(_priv),this}}).call(this,require("buffer").Buffer)},{"bn.js":117,buffer:151,elliptic:199}],177:[function(require,module,exports){"use strict";function Hash(hash){Base.call(this,"digest"),this._hash=hash}var inherits=require("inherits"),MD5=require("md5.js"),RIPEMD160=require("ripemd160"),sha=require("sha.js"),Base=require("cipher-base");inherits(Hash,Base),Hash.prototype._update=function(data){this._hash.update(data)},Hash.prototype._final=function(){return this._hash.digest()},module.exports=function(alg){return alg=alg.toLowerCase(),"md5"===alg?new MD5:"rmd160"===alg||"ripemd160"===alg?new RIPEMD160:new Hash(sha(alg))}},{"cipher-base":152,inherits:233,"md5.js":272,ripemd160:322,"sha.js":337}],178:[function(require,module,exports){var MD5=require("md5.js");module.exports=function(buffer){return(new MD5).update(buffer).digest()}},{"md5.js":272}],179:[function(require,module,exports){"use strict";function Hmac(alg,key){Base.call(this,"digest"),"string"==typeof key&&(key=Buffer.from(key));var blocksize="sha512"===alg||"sha384"===alg?128:64;if(this._alg=alg,this._key=key,key.length>blocksize){var hash="rmd160"===alg?new RIPEMD160:sha(alg);key=hash.update(key).digest()}else key.length<blocksize&&(key=Buffer.concat([key,ZEROS],blocksize));for(var ipad=this._ipad=Buffer.allocUnsafe(blocksize),opad=this._opad=Buffer.allocUnsafe(blocksize),i=0;i<blocksize;i++)ipad[i]=54^key[i],opad[i]=92^key[i];this._hash="rmd160"===alg?new RIPEMD160:sha(alg),this._hash.update(ipad)}var inherits=require("inherits"),Legacy=require("./legacy"),Base=require("cipher-base"),Buffer=require("safe-buffer").Buffer,md5=require("create-hash/md5"),RIPEMD160=require("ripemd160"),sha=require("sha.js"),ZEROS=Buffer.alloc(128);inherits(Hmac,Base),Hmac.prototype._update=function(data){this._hash.update(data)},Hmac.prototype._final=function(){var h=this._hash.digest(),hash="rmd160"===this._alg?new RIPEMD160:sha(this._alg);return hash.update(this._opad).update(h).digest()},module.exports=function(alg,key){return alg=alg.toLowerCase(),"rmd160"===alg||"ripemd160"===alg?new Hmac("rmd160",key):"md5"===alg?new Legacy(md5,key):new Hmac(alg,key)}},{"./legacy":180,"cipher-base":152,"create-hash/md5":178,inherits:233,ripemd160:322,"safe-buffer":323,"sha.js":337}],180:[function(require,module,exports){"use strict";function Hmac(alg,key){Base.call(this,"digest"),"string"==typeof key&&(key=Buffer.from(key)),this._alg=alg,this._key=key,key.length>blocksize?key=alg(key):key.length<blocksize&&(key=Buffer.concat([key,ZEROS],blocksize));for(var ipad=this._ipad=Buffer.allocUnsafe(blocksize),opad=this._opad=Buffer.allocUnsafe(blocksize),i=0;i<blocksize;i++)ipad[i]=54^key[i],opad[i]=92^key[i];this._hash=[ipad]}var inherits=require("inherits"),Buffer=require("safe-buffer").Buffer,Base=require("cipher-base"),ZEROS=Buffer.alloc(128),blocksize=64;inherits(Hmac,Base),Hmac.prototype._update=function(data){this._hash.push(data)},Hmac.prototype._final=function(){var h=this._alg(Buffer.concat(this._hash));return this._alg(Buffer.concat([this._opad,h]))},module.exports=Hmac},{"cipher-base":152,inherits:233,"safe-buffer":323}],181:[function(require,module,exports){"use strict";exports.randomBytes=exports.rng=exports.pseudoRandomBytes=exports.prng=require("randombytes"),exports.createHash=exports.Hash=require("create-hash"),exports.createHmac=exports.Hmac=require("create-hmac");var algos=require("browserify-sign/algos"),algoKeys=Object.keys(algos),hashes=["sha1","sha224","sha256","sha384","sha512","md5","rmd160"].concat(algoKeys);exports.getHashes=function(){return hashes};var p=require("pbkdf2");exports.pbkdf2=p.pbkdf2,exports.pbkdf2Sync=p.pbkdf2Sync;var aes=require("browserify-cipher");exports.Cipher=aes.Cipher,exports.createCipher=aes.createCipher,exports.Cipheriv=aes.Cipheriv,exports.createCipheriv=aes.createCipheriv,exports.Decipher=aes.Decipher,exports.createDecipher=aes.createDecipher,exports.Decipheriv=aes.Decipheriv,exports.createDecipheriv=aes.createDecipheriv,exports.getCiphers=aes.getCiphers,exports.listCiphers=aes.listCiphers;var dh=require("diffie-hellman");exports.DiffieHellmanGroup=dh.DiffieHellmanGroup,exports.createDiffieHellmanGroup=dh.createDiffieHellmanGroup,exports.getDiffieHellman=dh.getDiffieHellman,exports.createDiffieHellman=dh.createDiffieHellman,exports.DiffieHellman=dh.DiffieHellman;var sign=require("browserify-sign");exports.createSign=sign.createSign,exports.Sign=sign.Sign,exports.createVerify=sign.createVerify,exports.Verify=sign.Verify,exports.createECDH=require("create-ecdh");var publicEncrypt=require("public-encrypt");exports.publicEncrypt=publicEncrypt.publicEncrypt,
exports.privateEncrypt=publicEncrypt.privateEncrypt,exports.publicDecrypt=publicEncrypt.publicDecrypt,exports.privateDecrypt=publicEncrypt.privateDecrypt;var rf=require("randomfill");exports.randomFill=rf.randomFill,exports.randomFillSync=rf.randomFillSync,exports.createCredentials=function(){throw new Error(["sorry, createCredentials is not implemented yet","we accept pull requests","https://github.com/crypto-browserify/crypto-browserify"].join("\n"))},exports.constants={DH_CHECK_P_NOT_SAFE_PRIME:2,DH_CHECK_P_NOT_PRIME:1,DH_UNABLE_TO_CHECK_GENERATOR:4,DH_NOT_SUITABLE_GENERATOR:8,NPN_ENABLED:1,ALPN_ENABLED:1,RSA_PKCS1_PADDING:1,RSA_SSLV23_PADDING:2,RSA_NO_PADDING:3,RSA_PKCS1_OAEP_PADDING:4,RSA_X931_PADDING:5,RSA_PKCS1_PSS_PADDING:6,POINT_CONVERSION_COMPRESSED:2,POINT_CONVERSION_UNCOMPRESSED:4,POINT_CONVERSION_HYBRID:6}},{"browserify-cipher":137,"browserify-sign":144,"browserify-sign/algos":141,"create-ecdh":176,"create-hash":177,"create-hmac":179,"diffie-hellman":188,pbkdf2:298,"public-encrypt":310,randombytes:320,randomfill:321}],182:[function(require,module,exports){"use strict";exports.utils=require("./des/utils"),exports.Cipher=require("./des/cipher"),exports.DES=require("./des/des"),exports.CBC=require("./des/cbc"),exports.EDE=require("./des/ede")},{"./des/cbc":183,"./des/cipher":184,"./des/des":185,"./des/ede":186,"./des/utils":187}],183:[function(require,module,exports){"use strict";function CBCState(iv){assert.equal(iv.length,8,"Invalid IV length"),this.iv=new Array(8);for(var i=0;i<this.iv.length;i++)this.iv[i]=iv[i]}function instantiate(Base){function CBC(options){Base.call(this,options),this._cbcInit()}inherits(CBC,Base);for(var keys=Object.keys(proto),i=0;i<keys.length;i++){var key=keys[i];CBC.prototype[key]=proto[key]}return CBC.create=function(options){return new CBC(options)},CBC}var assert=require("minimalistic-assert"),inherits=require("inherits"),proto={};exports.instantiate=instantiate,proto._cbcInit=function(){var state=new CBCState(this.options.iv);this._cbcState=state},proto._update=function(inp,inOff,out,outOff){var state=this._cbcState,superProto=this.constructor.super_.prototype,iv=state.iv;if("encrypt"===this.type){for(var i=0;i<this.blockSize;i++)iv[i]^=inp[inOff+i];superProto._update.call(this,iv,0,out,outOff);for(var i=0;i<this.blockSize;i++)iv[i]=out[outOff+i]}else{superProto._update.call(this,inp,inOff,out,outOff);for(var i=0;i<this.blockSize;i++)out[outOff+i]^=iv[i];for(var i=0;i<this.blockSize;i++)iv[i]=inp[inOff+i]}}},{inherits:233,"minimalistic-assert":274}],184:[function(require,module,exports){"use strict";function Cipher(options){this.options=options,this.type=this.options.type,this.blockSize=8,this._init(),this.buffer=new Array(this.blockSize),this.bufferOff=0}var assert=require("minimalistic-assert");module.exports=Cipher,Cipher.prototype._init=function(){},Cipher.prototype.update=function(data){return 0===data.length?[]:"decrypt"===this.type?this._updateDecrypt(data):this._updateEncrypt(data)},Cipher.prototype._buffer=function(data,off){for(var min=Math.min(this.buffer.length-this.bufferOff,data.length-off),i=0;i<min;i++)this.buffer[this.bufferOff+i]=data[off+i];return this.bufferOff+=min,min},Cipher.prototype._flushBuffer=function(out,off){return this._update(this.buffer,0,out,off),this.bufferOff=0,this.blockSize},Cipher.prototype._updateEncrypt=function(data){var inputOff=0,outputOff=0,count=(this.bufferOff+data.length)/this.blockSize|0,out=new Array(count*this.blockSize);0!==this.bufferOff&&(inputOff+=this._buffer(data,inputOff),this.bufferOff===this.buffer.length&&(outputOff+=this._flushBuffer(out,outputOff)));for(var max=data.length-(data.length-inputOff)%this.blockSize;inputOff<max;inputOff+=this.blockSize)this._update(data,inputOff,out,outputOff),outputOff+=this.blockSize;for(;inputOff<data.length;inputOff++,this.bufferOff++)this.buffer[this.bufferOff]=data[inputOff];return out},Cipher.prototype._updateDecrypt=function(data){for(var inputOff=0,outputOff=0,count=Math.ceil((this.bufferOff+data.length)/this.blockSize)-1,out=new Array(count*this.blockSize);count>0;count--)inputOff+=this._buffer(data,inputOff),outputOff+=this._flushBuffer(out,outputOff);return inputOff+=this._buffer(data,inputOff),out},Cipher.prototype["final"]=function(buffer){var first;buffer&&(first=this.update(buffer));var last;return last="encrypt"===this.type?this._finalEncrypt():this._finalDecrypt(),first?first.concat(last):last},Cipher.prototype._pad=function(buffer,off){if(0===off)return!1;for(;off<buffer.length;)buffer[off++]=0;return!0},Cipher.prototype._finalEncrypt=function(){if(!this._pad(this.buffer,this.bufferOff))return[];var out=new Array(this.blockSize);return this._update(this.buffer,0,out,0),out},Cipher.prototype._unpad=function(buffer){return buffer},Cipher.prototype._finalDecrypt=function(){assert.equal(this.bufferOff,this.blockSize,"Not enough data to decrypt");var out=new Array(this.blockSize);return this._flushBuffer(out,0),this._unpad(out)}},{"minimalistic-assert":274}],185:[function(require,module,exports){"use strict";function DESState(){this.tmp=new Array(2),this.keys=null}function DES(options){Cipher.call(this,options);var state=new DESState;this._desState=state,this.deriveKeys(state,options.key)}var assert=require("minimalistic-assert"),inherits=require("inherits"),des=require("../des"),utils=des.utils,Cipher=des.Cipher;inherits(DES,Cipher),module.exports=DES,DES.create=function(options){return new DES(options)};var shiftTable=[1,1,2,2,2,2,2,2,1,2,2,2,2,2,2,1];DES.prototype.deriveKeys=function(state,key){state.keys=new Array(32),assert.equal(key.length,this.blockSize,"Invalid key length");var kL=utils.readUInt32BE(key,0),kR=utils.readUInt32BE(key,4);utils.pc1(kL,kR,state.tmp,0),kL=state.tmp[0],kR=state.tmp[1];for(var i=0;i<state.keys.length;i+=2){var shift=shiftTable[i>>>1];kL=utils.r28shl(kL,shift),kR=utils.r28shl(kR,shift),utils.pc2(kL,kR,state.keys,i)}},DES.prototype._update=function(inp,inOff,out,outOff){var state=this._desState,l=utils.readUInt32BE(inp,inOff),r=utils.readUInt32BE(inp,inOff+4);utils.ip(l,r,state.tmp,0),l=state.tmp[0],r=state.tmp[1],"encrypt"===this.type?this._encrypt(state,l,r,state.tmp,0):this._decrypt(state,l,r,state.tmp,0),l=state.tmp[0],r=state.tmp[1],utils.writeUInt32BE(out,l,outOff),utils.writeUInt32BE(out,r,outOff+4)},DES.prototype._pad=function(buffer,off){for(var value=buffer.length-off,i=off;i<buffer.length;i++)buffer[i]=value;return!0},DES.prototype._unpad=function(buffer){for(var pad=buffer[buffer.length-1],i=buffer.length-pad;i<buffer.length;i++)assert.equal(buffer[i],pad);return buffer.slice(0,buffer.length-pad)},DES.prototype._encrypt=function(state,lStart,rStart,out,off){for(var l=lStart,r=rStart,i=0;i<state.keys.length;i+=2){var keyL=state.keys[i],keyR=state.keys[i+1];utils.expand(r,state.tmp,0),keyL^=state.tmp[0],keyR^=state.tmp[1];var s=utils.substitute(keyL,keyR),f=utils.permute(s),t=r;r=(l^f)>>>0,l=t}utils.rip(r,l,out,off)},DES.prototype._decrypt=function(state,lStart,rStart,out,off){for(var l=rStart,r=lStart,i=state.keys.length-2;i>=0;i-=2){var keyL=state.keys[i],keyR=state.keys[i+1];utils.expand(l,state.tmp,0),keyL^=state.tmp[0],keyR^=state.tmp[1];var s=utils.substitute(keyL,keyR),f=utils.permute(s),t=l;l=(r^f)>>>0,r=t}utils.rip(l,r,out,off)}},{"../des":182,inherits:233,"minimalistic-assert":274}],186:[function(require,module,exports){"use strict";function EDEState(type,key){assert.equal(key.length,24,"Invalid key length");var k1=key.slice(0,8),k2=key.slice(8,16),k3=key.slice(16,24);"encrypt"===type?this.ciphers=[DES.create({type:"encrypt",key:k1}),DES.create({type:"decrypt",key:k2}),DES.create({type:"encrypt",key:k3})]:this.ciphers=[DES.create({type:"decrypt",key:k3}),DES.create({type:"encrypt",key:k2}),DES.create({type:"decrypt",key:k1})]}function EDE(options){Cipher.call(this,options);var state=new EDEState(this.type,this.options.key);this._edeState=state}var assert=require("minimalistic-assert"),inherits=require("inherits"),des=require("../des"),Cipher=des.Cipher,DES=des.DES;inherits(EDE,Cipher),module.exports=EDE,EDE.create=function(options){return new EDE(options)},EDE.prototype._update=function(inp,inOff,out,outOff){var state=this._edeState;state.ciphers[0]._update(inp,inOff,out,outOff),state.ciphers[1]._update(out,outOff,out,outOff),state.ciphers[2]._update(out,outOff,out,outOff)},EDE.prototype._pad=DES.prototype._pad,EDE.prototype._unpad=DES.prototype._unpad},{"../des":182,inherits:233,"minimalistic-assert":274}],187:[function(require,module,exports){"use strict";exports.readUInt32BE=function(bytes,off){var res=bytes[0+off]<<24|bytes[1+off]<<16|bytes[2+off]<<8|bytes[3+off];return res>>>0},exports.writeUInt32BE=function(bytes,value,off){bytes[0+off]=value>>>24,bytes[1+off]=value>>>16&255,bytes[2+off]=value>>>8&255,bytes[3+off]=255&value},exports.ip=function(inL,inR,out,off){for(var outL=0,outR=0,i=6;i>=0;i-=2){for(var j=0;j<=24;j+=8)outL<<=1,outL|=inR>>>j+i&1;for(var j=0;j<=24;j+=8)outL<<=1,outL|=inL>>>j+i&1}for(var i=6;i>=0;i-=2){for(var j=1;j<=25;j+=8)outR<<=1,outR|=inR>>>j+i&1;for(var j=1;j<=25;j+=8)outR<<=1,outR|=inL>>>j+i&1}out[off+0]=outL>>>0,out[off+1]=outR>>>0},exports.rip=function(inL,inR,out,off){for(var outL=0,outR=0,i=0;i<4;i++)for(var j=24;j>=0;j-=8)outL<<=1,outL|=inR>>>j+i&1,outL<<=1,outL|=inL>>>j+i&1;for(var i=4;i<8;i++)for(var j=24;j>=0;j-=8)outR<<=1,outR|=inR>>>j+i&1,outR<<=1,outR|=inL>>>j+i&1;out[off+0]=outL>>>0,out[off+1]=outR>>>0},exports.pc1=function(inL,inR,out,off){for(var outL=0,outR=0,i=7;i>=5;i--){for(var j=0;j<=24;j+=8)outL<<=1,outL|=inR>>j+i&1;for(var j=0;j<=24;j+=8)outL<<=1,outL|=inL>>j+i&1}for(var j=0;j<=24;j+=8)outL<<=1,outL|=inR>>j+i&1;for(var i=1;i<=3;i++){for(var j=0;j<=24;j+=8)outR<<=1,outR|=inR>>j+i&1;for(var j=0;j<=24;j+=8)outR<<=1,outR|=inL>>j+i&1}for(var j=0;j<=24;j+=8)outR<<=1,outR|=inL>>j+i&1;out[off+0]=outL>>>0,out[off+1]=outR>>>0},exports.r28shl=function(num,shift){return num<<shift&268435455|num>>>28-shift};var pc2table=[14,11,17,4,27,23,25,0,13,22,7,18,5,9,16,24,2,20,12,21,1,8,15,26,15,4,25,19,9,1,26,16,5,11,23,8,12,7,17,0,22,3,10,14,6,20,27,24];exports.pc2=function(inL,inR,out,off){for(var outL=0,outR=0,len=pc2table.length>>>1,i=0;i<len;i++)outL<<=1,outL|=inL>>>pc2table[i]&1;for(var i=len;i<pc2table.length;i++)outR<<=1,outR|=inR>>>pc2table[i]&1;out[off+0]=outL>>>0,out[off+1]=outR>>>0},exports.expand=function(r,out,off){var outL=0,outR=0;outL=(1&r)<<5|r>>>27;for(var i=23;i>=15;i-=4)outL<<=6,outL|=r>>>i&63;for(var i=11;i>=3;i-=4)outR|=r>>>i&63,outR<<=6;outR|=(31&r)<<1|r>>>31,out[off+0]=outL>>>0,out[off+1]=outR>>>0};var sTable=[14,0,4,15,13,7,1,4,2,14,15,2,11,13,8,1,3,10,10,6,6,12,12,11,5,9,9,5,0,3,7,8,4,15,1,12,14,8,8,2,13,4,6,9,2,1,11,7,15,5,12,11,9,3,7,14,3,10,10,0,5,6,0,13,15,3,1,13,8,4,14,7,6,15,11,2,3,8,4,14,9,12,7,0,2,1,13,10,12,6,0,9,5,11,10,5,0,13,14,8,7,10,11,1,10,3,4,15,13,4,1,2,5,11,8,6,12,7,6,12,9,0,3,5,2,14,15,9,10,13,0,7,9,0,14,9,6,3,3,4,15,6,5,10,1,2,13,8,12,5,7,14,11,12,4,11,2,15,8,1,13,1,6,10,4,13,9,0,8,6,15,9,3,8,0,7,11,4,1,15,2,14,12,3,5,11,10,5,14,2,7,12,7,13,13,8,14,11,3,5,0,6,6,15,9,0,10,3,1,4,2,7,8,2,5,12,11,1,12,10,4,14,15,9,10,3,6,15,9,0,0,6,12,10,11,1,7,13,13,8,15,9,1,4,3,5,14,11,5,12,2,7,8,2,4,14,2,14,12,11,4,2,1,12,7,4,10,7,11,13,6,1,8,5,5,0,3,15,15,10,13,3,0,9,14,8,9,6,4,11,2,8,1,12,11,7,10,1,13,14,7,2,8,13,15,6,9,15,12,0,5,9,6,10,3,4,0,5,14,3,12,10,1,15,10,4,15,2,9,7,2,12,6,9,8,5,0,6,13,1,3,13,4,14,14,0,7,11,5,3,11,8,9,4,14,3,15,2,5,12,2,9,8,5,12,15,3,10,7,11,0,14,4,1,10,7,1,6,13,0,11,8,6,13,4,13,11,0,2,11,14,7,15,4,0,9,8,1,13,10,3,14,12,3,9,5,7,12,5,2,10,15,6,8,1,6,1,6,4,11,11,13,13,8,12,1,3,4,7,10,14,7,10,9,15,5,6,0,8,15,0,14,5,2,9,3,2,12,13,1,2,15,8,13,4,8,6,10,15,3,11,7,1,4,10,12,9,5,3,6,14,11,5,0,0,14,12,9,7,2,7,2,11,1,4,14,1,7,9,4,12,10,14,8,2,13,0,15,6,12,10,9,13,0,15,3,3,5,5,6,8,11];exports.substitute=function(inL,inR){for(var out=0,i=0;i<4;i++){var b=inL>>>18-6*i&63,sb=sTable[64*i+b];out<<=4,out|=sb}for(var i=0;i<4;i++){var b=inR>>>18-6*i&63,sb=sTable[256+64*i+b];out<<=4,out|=sb}return out>>>0};var permuteTable=[16,25,12,11,3,20,4,15,31,17,9,6,27,14,1,22,30,24,8,18,0,5,29,23,13,19,2,26,10,21,28,7];exports.permute=function(num){for(var out=0,i=0;i<permuteTable.length;i++)out<<=1,out|=num>>>permuteTable[i]&1;return out>>>0},exports.padSplit=function(num,size,group){for(var str=num.toString(2);str.length<size;)str="0"+str;for(var out=[],i=0;i<size;i+=group)out.push(str.slice(i,i+group));return out.join(" ")}},{}],188:[function(require,module,exports){(function(Buffer){function getDiffieHellman(mod){var prime=new Buffer(primes[mod].prime,"hex"),gen=new Buffer(primes[mod].gen,"hex");return new DH(prime,gen)}function createDiffieHellman(prime,enc,generator,genc){return Buffer.isBuffer(enc)||void 0===ENCODINGS[enc]?createDiffieHellman(prime,"binary",enc,generator):(enc=enc||"binary",genc=genc||"binary",generator=generator||new Buffer([2]),Buffer.isBuffer(generator)||(generator=new Buffer(generator,genc)),"number"==typeof prime?new DH(generatePrime(prime,generator),generator,(!0)):(Buffer.isBuffer(prime)||(prime=new Buffer(prime,enc)),new DH(prime,generator,(!0))))}var generatePrime=require("./lib/generatePrime"),primes=require("./lib/primes.json"),DH=require("./lib/dh"),ENCODINGS={binary:!0,hex:!0,base64:!0};exports.DiffieHellmanGroup=exports.createDiffieHellmanGroup=exports.getDiffieHellman=getDiffieHellman,exports.createDiffieHellman=exports.DiffieHellman=createDiffieHellman}).call(this,require("buffer").Buffer)},{"./lib/dh":189,"./lib/generatePrime":190,"./lib/primes.json":191,buffer:151}],189:[function(require,module,exports){(function(Buffer){function setPublicKey(pub,enc){return enc=enc||"utf8",Buffer.isBuffer(pub)||(pub=new Buffer(pub,enc)),this._pub=new BN(pub),this}function setPrivateKey(priv,enc){return enc=enc||"utf8",Buffer.isBuffer(priv)||(priv=new Buffer(priv,enc)),this._priv=new BN(priv),this}function checkPrime(prime,generator){var gen=generator.toString("hex"),hex=[gen,prime.toString(16)].join("_");if(hex in primeCache)return primeCache[hex];var error=0;if(prime.isEven()||!primes.simpleSieve||!primes.fermatTest(prime)||!millerRabin.test(prime))return error+=1,error+="02"===gen||"05"===gen?8:4,primeCache[hex]=error,error;millerRabin.test(prime.shrn(1))||(error+=2);var rem;switch(gen){case"02":prime.mod(TWENTYFOUR).cmp(ELEVEN)&&(error+=8);break;case"05":rem=prime.mod(TEN),rem.cmp(THREE)&&rem.cmp(SEVEN)&&(error+=8);break;default:error+=4}return primeCache[hex]=error,error}function DH(prime,generator,malleable){this.setGenerator(generator),this.__prime=new BN(prime),this._prime=BN.mont(this.__prime),this._primeLen=prime.length,this._pub=void 0,this._priv=void 0,this._primeCode=void 0,malleable?(this.setPublicKey=setPublicKey,this.setPrivateKey=setPrivateKey):this._primeCode=8}function formatReturnValue(bn,enc){var buf=new Buffer(bn.toArray());return enc?buf.toString(enc):buf}var BN=require("bn.js"),MillerRabin=require("miller-rabin"),millerRabin=new MillerRabin,TWENTYFOUR=new BN(24),ELEVEN=new BN(11),TEN=new BN(10),THREE=new BN(3),SEVEN=new BN(7),primes=require("./generatePrime"),randomBytes=require("randombytes");module.exports=DH;var primeCache={};Object.defineProperty(DH.prototype,"verifyError",{enumerable:!0,get:function(){return"number"!=typeof this._primeCode&&(this._primeCode=checkPrime(this.__prime,this.__gen)),this._primeCode}}),DH.prototype.generateKeys=function(){return this._priv||(this._priv=new BN(randomBytes(this._primeLen))),this._pub=this._gen.toRed(this._prime).redPow(this._priv).fromRed(),this.getPublicKey()},DH.prototype.computeSecret=function(other){other=new BN(other),other=other.toRed(this._prime);var secret=other.redPow(this._priv).fromRed(),out=new Buffer(secret.toArray()),prime=this.getPrime();if(out.length<prime.length){var front=new Buffer(prime.length-out.length);front.fill(0),out=Buffer.concat([front,out])}return out},DH.prototype.getPublicKey=function(enc){return formatReturnValue(this._pub,enc)},DH.prototype.getPrivateKey=function(enc){return formatReturnValue(this._priv,enc)},DH.prototype.getPrime=function(enc){return formatReturnValue(this.__prime,enc)},DH.prototype.getGenerator=function(enc){return formatReturnValue(this._gen,enc)},DH.prototype.setGenerator=function(gen,enc){return enc=enc||"utf8",Buffer.isBuffer(gen)||(gen=new Buffer(gen,enc)),this.__gen=gen,this._gen=new BN(gen),this}}).call(this,require("buffer").Buffer)},{"./generatePrime":190,"bn.js":117,buffer:151,"miller-rabin":273,randombytes:320}],190:[function(require,module,exports){function _getPrimes(){if(null!==primes)return primes;var limit=1048576,res=[];res[0]=2;for(var i=1,k=3;k<limit;k+=2){for(var sqrt=Math.ceil(Math.sqrt(k)),j=0;j<i&&res[j]<=sqrt&&k%res[j]!==0;j++);i!==j&&res[j]<=sqrt||(res[i++]=k)}return primes=res,res}function simpleSieve(p){for(var primes=_getPrimes(),i=0;i<primes.length;i++)if(0===p.modn(primes[i]))return 0===p.cmpn(primes[i]);return!0}function fermatTest(p){var red=BN.mont(p);return 0===TWO.toRed(red).redPow(p.subn(1)).fromRed().cmpn(1)}function findPrime(bits,gen){if(bits<16)return new BN(2===gen||5===gen?[140,123]:[140,39]);gen=new BN(gen);for(var num,n2;;){for(num=new BN(randomBytes(Math.ceil(bits/8)));num.bitLength()>bits;)num.ishrn(1);if(num.isEven()&&num.iadd(ONE),num.testn(1)||num.iadd(TWO),gen.cmp(TWO)){if(!gen.cmp(FIVE))for(;num.mod(TEN).cmp(THREE);)num.iadd(FOUR)}else for(;num.mod(TWENTYFOUR).cmp(ELEVEN);)num.iadd(FOUR);if(n2=num.shrn(1),simpleSieve(n2)&&simpleSieve(num)&&fermatTest(n2)&&fermatTest(num)&&millerRabin.test(n2)&&millerRabin.test(num))return num}}var randomBytes=require("randombytes");module.exports=findPrime,findPrime.simpleSieve=simpleSieve,findPrime.fermatTest=fermatTest;var BN=require("bn.js"),TWENTYFOUR=new BN(24),MillerRabin=require("miller-rabin"),millerRabin=new MillerRabin,ONE=new BN(1),TWO=new BN(2),FIVE=new BN(5),TEN=(new BN(16),new BN(8),new BN(10)),THREE=new BN(3),ELEVEN=(new BN(7),new BN(11)),FOUR=new BN(4),primes=(new BN(12),null)},{"bn.js":117,"miller-rabin":273,randombytes:320}],191:[function(require,module,exports){module.exports={modp1:{gen:"02",prime:"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a63a3620ffffffffffffffff"},modp2:{gen:"02",prime:"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece65381ffffffffffffffff"},modp5:{gen:"02",prime:"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca237327ffffffffffffffff"},modp14:{gen:"02",prime:"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca18217c32905e462e36ce3be39e772c180e86039b2783a2ec07a28fb5c55df06f4c52c9de2bcbf6955817183995497cea956ae515d2261898fa051015728e5a8aacaa68ffffffffffffffff"},modp15:{gen:"02",prime:"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca18217c32905e462e36ce3be39e772c180e86039b2783a2ec07a28fb5c55df06f4c52c9de2bcbf6955817183995497cea956ae515d2261898fa051015728e5a8aaac42dad33170d04507a33a85521abdf1cba64ecfb850458dbef0a8aea71575d060c7db3970f85a6e1e4c7abf5ae8cdb0933d71e8c94e04a25619dcee3d2261ad2ee6bf12ffa06d98a0864d87602733ec86a64521f2b18177b200cbbe117577a615d6c770988c0bad946e208e24fa074e5ab3143db5bfce0fd108e4b82d120a93ad2caffffffffffffffff"},modp16:{gen:"02",prime:"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca18217c32905e462e36ce3be39e772c180e86039b2783a2ec07a28fb5c55df06f4c52c9de2bcbf6955817183995497cea956ae515d2261898fa051015728e5a8aaac42dad33170d04507a33a85521abdf1cba64ecfb850458dbef0a8aea71575d060c7db3970f85a6e1e4c7abf5ae8cdb0933d71e8c94e04a25619dcee3d2261ad2ee6bf12ffa06d98a0864d87602733ec86a64521f2b18177b200cbbe117577a615d6c770988c0bad946e208e24fa074e5ab3143db5bfce0fd108e4b82d120a92108011a723c12a787e6d788719a10bdba5b2699c327186af4e23c1a946834b6150bda2583e9ca2ad44ce8dbbbc2db04de8ef92e8efc141fbecaa6287c59474e6bc05d99b2964fa090c3a2233ba186515be7ed1f612970cee2d7afb81bdd762170481cd0069127d5b05aa993b4ea988d8fddc186ffb7dc90a6c08f4df435c934063199ffffffffffffffff"},modp17:{gen:"02",prime:"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca18217c32905e462e36ce3be39e772c180e86039b2783a2ec07a28fb5c55df06f4c52c9de2bcbf6955817183995497cea956ae515d2261898fa051015728e5a8aaac42dad33170d04507a33a85521abdf1cba64ecfb850458dbef0a8aea71575d060c7db3970f85a6e1e4c7abf5ae8cdb0933d71e8c94e04a25619dcee3d2261ad2ee6bf12ffa06d98a0864d87602733ec86a64521f2b18177b200cbbe117577a615d6c770988c0bad946e208e24fa074e5ab3143db5bfce0fd108e4b82d120a92108011a723c12a787e6d788719a10bdba5b2699c327186af4e23c1a946834b6150bda2583e9ca2ad44ce8dbbbc2db04de8ef92e8efc141fbecaa6287c59474e6bc05d99b2964fa090c3a2233ba186515be7ed1f612970cee2d7afb81bdd762170481cd0069127d5b05aa993b4ea988d8fddc186ffb7dc90a6c08f4df435c93402849236c3fab4d27c7026c1d4dcb2602646dec9751e763dba37bdf8ff9406ad9e530ee5db382f413001aeb06a53ed9027d831179727b0865a8918da3edbebcf9b14ed44ce6cbaced4bb1bdb7f1447e6cc254b332051512bd7af426fb8f401378cd2bf5983ca01c64b92ecf032ea15d1721d03f482d7ce6e74fef6d55e702f46980c82b5a84031900b1c9e59e7c97fbec7e8f323a97a7e36cc88be0f1d45b7ff585ac54bd407b22b4154aacc8f6d7ebf48e1d814cc5ed20f8037e0a79715eef29be32806a1d58bb7c5da76f550aa3d8a1fbff0eb19ccb1a313d55cda56c9ec2ef29632387fe8d76e3c0468043e8f663f4860ee12bf2d5b0b7474d6e694f91e6dcc4024ffffffffffffffff"},modp18:{gen:"02",prime:"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca18217c32905e462e36ce3be39e772c180e86039b2783a2ec07a28fb5c55df06f4c52c9de2bcbf6955817183995497cea956ae515d2261898fa051015728e5a8aaac42dad33170d04507a33a85521abdf1cba64ecfb850458dbef0a8aea71575d060c7db3970f85a6e1e4c7abf5ae8cdb0933d71e8c94e04a25619dcee3d2261ad2ee6bf12ffa06d98a0864d87602733ec86a64521f2b18177b200cbbe117577a615d6c770988c0bad946e208e24fa074e5ab3143db5bfce0fd108e4b82d120a92108011a723c12a787e6d788719a10bdba5b2699c327186af4e23c1a946834b6150bda2583e9ca2ad44ce8dbbbc2db04de8ef92e8efc141fbecaa6287c59474e6bc05d99b2964fa090c3a2233ba186515be7ed1f612970cee2d7afb81bdd762170481cd0069127d5b05aa993b4ea988d8fddc186ffb7dc90a6c08f4df435c93402849236c3fab4d27c7026c1d4dcb2602646dec9751e763dba37bdf8ff9406ad9e530ee5db382f413001aeb06a53ed9027d831179727b0865a8918da3edbebcf9b14ed44ce6cbaced4bb1bdb7f1447e6cc254b332051512bd7af426fb8f401378cd2bf5983ca01c64b92ecf032ea15d1721d03f482d7ce6e74fef6d55e702f46980c82b5a84031900b1c9e59e7c97fbec7e8f323a97a7e36cc88be0f1d45b7ff585ac54bd407b22b4154aacc8f6d7ebf48e1d814cc5ed20f8037e0a79715eef29be32806a1d58bb7c5da76f550aa3d8a1fbff0eb19ccb1a313d55cda56c9ec2ef29632387fe8d76e3c0468043e8f663f4860ee12bf2d5b0b7474d6e694f91e6dbe115974a3926f12fee5e438777cb6a932df8cd8bec4d073b931ba3bc832b68d9dd300741fa7bf8afc47ed2576f6936ba424663aab639c5ae4f5683423b4742bf1c978238f16cbe39d652de3fdb8befc848ad922222e04a4037c0713eb57a81a23f0c73473fc646cea306b4bcbc8862f8385ddfa9d4b7fa2c087e879683303ed5bdd3a062b3cf5b3a278a66d2a13f83f44f82ddf310ee074ab6a364597e899a0255dc164f31cc50846851df9ab48195ded7ea1b1d510bd7ee74d73faf36bc31ecfa268359046f4eb879f924009438b481c6cd7889a002ed5ee382bc9190da6fc026e479558e4475677e9aa9e3050e2765694dfc81f56e880b96e7160c980dd98edd3dfffffffffffffffff"}}},{}],192:[function(require,module,exports){(function(Buffer){"use strict";function HmacDRBG(algo,entropy,nonce,pers){var info=hashInfo[algo];if(void 0===info)throw new Error("hash "+algo+" is not supported");this._algo=algo,this._securityStrength=info.securityStrength/8,this._outlen=info.outlen/8,this._reseedInterval=281474976710656,this._init(entropy,nonce,pers)}var createHmac=require("create-hmac"),hashInfo=require("./lib/hash-info.json"),ebuf=new Buffer(0),b0x00=new Buffer([0]),b0x01=new Buffer([1]);HmacDRBG.prototype._update=function(seed){var kmac=createHmac(this._algo,this._K).update(this._V).update(b0x00);seed&&kmac.update(seed),this._K=kmac.digest(),this._V=createHmac(this._algo,this._K).update(this._V).digest(),seed&&(this._K=createHmac(this._algo,this._K).update(this._V).update(b0x01).update(seed).digest(),this._V=createHmac(this._algo,this._K).update(this._V).digest())},HmacDRBG.prototype._init=function(entropy,nonce,pers){if(entropy.length<this._securityStrength)throw new Error("Not enough entropy");this._K=new Buffer(this._outlen),this._V=new Buffer(this._outlen);for(var i=0;i<this._K.length;++i)this._K[i]=0,this._V[i]=1;this._update(Buffer.concat([entropy,nonce,pers||ebuf])),this._reseed=1},HmacDRBG.prototype.reseed=function(entropy,add){if(entropy.length<this._securityStrength)throw new Error("Not enough entropy");this._update(Buffer.concat([entropy,add||ebuf])),this._reseed=1},HmacDRBG.prototype.generate=function(len,add){if(this._reseed>this._reseedInterval)throw new Error("Reseed is required");add&&0===add.length&&(add=void 0),add&&this._update(add);for(var temp=new Buffer(0);temp.length<len;)this._V=createHmac(this._algo,this._K).update(this._V).digest(),temp=Buffer.concat([temp,this._V]);return this._update(add),this._reseed+=1,temp.slice(0,len)},module.exports=HmacDRBG}).call(this,require("buffer").Buffer)},{"./lib/hash-info.json":193,buffer:151,"create-hmac":179}],193:[function(require,module,exports){module.exports={sha1:{securityStrength:128,outlen:160,seedlen:440},sha224:{securityStrength:192,outlen:224,seedlen:440},sha256:{securityStrength:256,outlen:256,seedlen:440},sha384:{securityStrength:256,outlen:384,seedlen:888},sha512:{securityStrength:256,outlen:512,seedlen:888}}},{}],194:[function(require,module,exports){function Curve(p,a,b,Gx,Gy,n,h){this.p=p,this.a=a,this.b=b,this.G=Point.fromAffine(this,Gx,Gy),this.n=n,this.h=h,this.infinity=new Point(this,null,null,BigInteger.ZERO),this.pOverFour=p.add(BigInteger.ONE).shiftRight(2),this.pLength=Math.floor((this.p.bitLength()+7)/8)}var assert=require("assert"),BigInteger=require("bigi"),Point=require("./point");Curve.prototype.pointFromX=function(isOdd,x){var alpha=x.pow(3).add(this.a.multiply(x)).add(this.b).mod(this.p),beta=alpha.modPow(this.pOverFour,this.p),y=beta;return beta.isEven()^!isOdd&&(y=this.p.subtract(y)),Point.fromAffine(this,x,y)},Curve.prototype.isInfinity=function(Q){return Q===this.infinity||0===Q.z.signum()&&0!==Q.y.signum()},Curve.prototype.isOnCurve=function(Q){if(this.isInfinity(Q))return!0;var x=Q.affineX,y=Q.affineY,a=this.a,b=this.b,p=this.p;if(x.signum()<0||x.compareTo(p)>=0)return!1;if(y.signum()<0||y.compareTo(p)>=0)return!1;var lhs=y.square().mod(p),rhs=x.pow(3).add(a.multiply(x)).add(b).mod(p);return lhs.equals(rhs)},Curve.prototype.validate=function(Q){assert(!this.isInfinity(Q),"Point is at infinity"),assert(this.isOnCurve(Q),"Point is not on the curve");var nQ=Q.multiply(this.n);return assert(this.isInfinity(nQ),"Point is not a scalar multiple of G"),!0},module.exports=Curve},{"./point":198,assert:25,bigi:30}],195:[function(require,module,exports){module.exports={secp128r1:{p:"fffffffdffffffffffffffffffffffff",a:"fffffffdfffffffffffffffffffffffc",b:"e87579c11079f43dd824993c2cee5ed3",n:"fffffffe0000000075a30d1b9038a115",h:"01",Gx:"161ff7528b899b2d0c28607ca52c5b86",Gy:"cf5ac8395bafeb13c02da292dded7a83"},secp160k1:{p:"fffffffffffffffffffffffffffffffeffffac73",a:"00",b:"07",n:"0100000000000000000001b8fa16dfab9aca16b6b3",h:"01",Gx:"3b4c382ce37aa192a4019e763036f4f5dd4d7ebb",Gy:"938cf935318fdced6bc28286531733c3f03c4fee"},secp160r1:{p:"ffffffffffffffffffffffffffffffff7fffffff",a:"ffffffffffffffffffffffffffffffff7ffffffc",b:"1c97befc54bd7a8b65acf89f81d4d4adc565fa45",n:"0100000000000000000001f4c8f927aed3ca752257",h:"01",Gx:"4a96b5688ef573284664698968c38bb913cbfc82",Gy:"23a628553168947d59dcc912042351377ac5fb32"},secp192k1:{p:"fffffffffffffffffffffffffffffffffffffffeffffee37",a:"00",b:"03",n:"fffffffffffffffffffffffe26f2fc170f69466a74defd8d",h:"01",Gx:"db4ff10ec057e9ae26b07d0280b7f4341da5d1b1eae06c7d",Gy:"9b2f2f6d9c5628a7844163d015be86344082aa88d95e2f9d"},secp192r1:{p:"fffffffffffffffffffffffffffffffeffffffffffffffff",a:"fffffffffffffffffffffffffffffffefffffffffffffffc",b:"64210519e59c80e70fa7e9ab72243049feb8deecc146b9b1",n:"ffffffffffffffffffffffff99def836146bc9b1b4d22831",h:"01",Gx:"188da80eb03090f67cbf20eb43a18800f4ff0afd82ff1012",Gy:"07192b95ffc8da78631011ed6b24cdd573f977a11e794811"},secp256k1:{p:"fffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f",a:"00",b:"07",n:"fffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141",h:"01",Gx:"79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798",Gy:"483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8"},secp256r1:{p:"ffffffff00000001000000000000000000000000ffffffffffffffffffffffff",a:"ffffffff00000001000000000000000000000000fffffffffffffffffffffffc",b:"5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b",n:"ffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551",h:"01",Gx:"6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296",Gy:"4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5"}}},{}],196:[function(require,module,exports){var Point=require("./point"),Curve=require("./curve"),getCurveByName=require("./names");module.exports={Curve:Curve,Point:Point,getCurveByName:getCurveByName}},{"./curve":194,"./names":197,"./point":198}],197:[function(require,module,exports){function getCurveByName(name){var curve=curves[name];if(!curve)return null;var p=new BigInteger(curve.p,16),a=new BigInteger(curve.a,16),b=new BigInteger(curve.b,16),n=new BigInteger(curve.n,16),h=new BigInteger(curve.h,16),Gx=new BigInteger(curve.Gx,16),Gy=new BigInteger(curve.Gy,16);return new Curve(p,a,b,Gx,Gy,n,h)}var BigInteger=require("bigi"),curves=require("./curves.json"),Curve=require("./curve");module.exports=getCurveByName},{"./curve":194,"./curves.json":195,bigi:30}],198:[function(require,module,exports){function Point(curve,x,y,z){assert.notStrictEqual(z,void 0,"Missing Z coordinate"),this.curve=curve,this.x=x,this.y=y,this.z=z,this._zInv=null,this.compressed=!0}var assert=require("assert"),Buffer=require("safe-buffer").Buffer,BigInteger=require("bigi"),THREE=BigInteger.valueOf(3);Object.defineProperty(Point.prototype,"zInv",{get:function(){return null===this._zInv&&(this._zInv=this.z.modInverse(this.curve.p)),this._zInv}}),Object.defineProperty(Point.prototype,"affineX",{get:function(){return this.x.multiply(this.zInv).mod(this.curve.p);
}}),Object.defineProperty(Point.prototype,"affineY",{get:function(){return this.y.multiply(this.zInv).mod(this.curve.p)}}),Point.fromAffine=function(curve,x,y){return new Point(curve,x,y,BigInteger.ONE)},Point.prototype.equals=function(other){if(other===this)return!0;if(this.curve.isInfinity(this))return this.curve.isInfinity(other);if(this.curve.isInfinity(other))return this.curve.isInfinity(this);var u=other.y.multiply(this.z).subtract(this.y.multiply(other.z)).mod(this.curve.p);if(0!==u.signum())return!1;var v=other.x.multiply(this.z).subtract(this.x.multiply(other.z)).mod(this.curve.p);return 0===v.signum()},Point.prototype.negate=function(){var y=this.curve.p.subtract(this.y);return new Point(this.curve,this.x,y,this.z)},Point.prototype.add=function(b){if(this.curve.isInfinity(this))return b;if(this.curve.isInfinity(b))return this;var x1=this.x,y1=this.y,x2=b.x,y2=b.y,u=y2.multiply(this.z).subtract(y1.multiply(b.z)).mod(this.curve.p),v=x2.multiply(this.z).subtract(x1.multiply(b.z)).mod(this.curve.p);if(0===v.signum())return 0===u.signum()?this.twice():this.curve.infinity;var v2=v.square(),v3=v2.multiply(v),x1v2=x1.multiply(v2),zu2=u.square().multiply(this.z),x3=zu2.subtract(x1v2.shiftLeft(1)).multiply(b.z).subtract(v3).multiply(v).mod(this.curve.p),y3=x1v2.multiply(THREE).multiply(u).subtract(y1.multiply(v3)).subtract(zu2.multiply(u)).multiply(b.z).add(u.multiply(v3)).mod(this.curve.p),z3=v3.multiply(this.z).multiply(b.z).mod(this.curve.p);return new Point(this.curve,x3,y3,z3)},Point.prototype.twice=function(){if(this.curve.isInfinity(this))return this;if(0===this.y.signum())return this.curve.infinity;var x1=this.x,y1=this.y,y1z1=y1.multiply(this.z).mod(this.curve.p),y1sqz1=y1z1.multiply(y1).mod(this.curve.p),a=this.curve.a,w=x1.square().multiply(THREE);0!==a.signum()&&(w=w.add(this.z.square().multiply(a))),w=w.mod(this.curve.p);var x3=w.square().subtract(x1.shiftLeft(3).multiply(y1sqz1)).shiftLeft(1).multiply(y1z1).mod(this.curve.p),y3=w.multiply(THREE).multiply(x1).subtract(y1sqz1.shiftLeft(1)).shiftLeft(2).multiply(y1sqz1).subtract(w.pow(3)).mod(this.curve.p),z3=y1z1.pow(3).shiftLeft(3).mod(this.curve.p);return new Point(this.curve,x3,y3,z3)},Point.prototype.multiply=function(k){if(this.curve.isInfinity(this))return this;if(0===k.signum())return this.curve.infinity;for(var e=k,h=e.multiply(THREE),neg=this.negate(),R=this,i=h.bitLength()-2;i>0;--i){var hBit=h.testBit(i),eBit=e.testBit(i);R=R.twice(),hBit!==eBit&&(R=R.add(hBit?this:neg))}return R},Point.prototype.multiplyTwo=function(j,x,k){for(var i=Math.max(j.bitLength(),k.bitLength())-1,R=this.curve.infinity,both=this.add(x);i>=0;){var jBit=j.testBit(i),kBit=k.testBit(i);R=R.twice(),jBit?R=kBit?R.add(both):R.add(this):kBit&&(R=R.add(x)),--i}return R},Point.prototype.getEncoded=function(compressed){if(null==compressed&&(compressed=this.compressed),this.curve.isInfinity(this))return Buffer.alloc(1,0);var buffer,x=this.affineX,y=this.affineY,byteLength=this.curve.pLength;return compressed?(buffer=Buffer.allocUnsafe(1+byteLength),buffer.writeUInt8(y.isEven()?2:3,0)):(buffer=Buffer.allocUnsafe(1+byteLength+byteLength),buffer.writeUInt8(4,0),y.toBuffer(byteLength).copy(buffer,1+byteLength)),x.toBuffer(byteLength).copy(buffer,1),buffer},Point.decodeFrom=function(curve,buffer){var Q,type=buffer.readUInt8(0),compressed=4!==type,byteLength=Math.floor((curve.p.bitLength()+7)/8),x=BigInteger.fromBuffer(buffer.slice(1,1+byteLength));if(compressed){assert.equal(buffer.length,byteLength+1,"Invalid sequence length"),assert(2===type||3===type,"Invalid sequence tag");var isOdd=3===type;Q=curve.pointFromX(isOdd,x)}else{assert.equal(buffer.length,1+byteLength+byteLength,"Invalid sequence length");var y=BigInteger.fromBuffer(buffer.slice(1+byteLength));Q=Point.fromAffine(curve,x,y)}return Q.compressed=compressed,Q},Point.prototype.toString=function(){return this.curve.isInfinity(this)?"(INFINITY)":"("+this.affineX.toString()+","+this.affineY.toString()+")"},module.exports=Point},{assert:25,bigi:30,"safe-buffer":323}],199:[function(require,module,exports){"use strict";var elliptic=exports;elliptic.version=require("../package.json").version,elliptic.utils=require("./elliptic/utils"),elliptic.rand=require("brorand"),elliptic.curve=require("./elliptic/curve"),elliptic.curves=require("./elliptic/curves"),elliptic.ec=require("./elliptic/ec"),elliptic.eddsa=require("./elliptic/eddsa")},{"../package.json":214,"./elliptic/curve":202,"./elliptic/curves":205,"./elliptic/ec":206,"./elliptic/eddsa":209,"./elliptic/utils":213,brorand:118}],200:[function(require,module,exports){"use strict";function BaseCurve(type,conf){this.type=type,this.p=new BN(conf.p,16),this.red=conf.prime?BN.red(conf.prime):BN.mont(this.p),this.zero=new BN(0).toRed(this.red),this.one=new BN(1).toRed(this.red),this.two=new BN(2).toRed(this.red),this.n=conf.n&&new BN(conf.n,16),this.g=conf.g&&this.pointFromJSON(conf.g,conf.gRed),this._wnafT1=new Array(4),this._wnafT2=new Array(4),this._wnafT3=new Array(4),this._wnafT4=new Array(4);var adjustCount=this.n&&this.p.div(this.n);!adjustCount||adjustCount.cmpn(100)>0?this.redN=null:(this._maxwellTrick=!0,this.redN=this.n.toRed(this.red))}function BasePoint(curve,type){this.curve=curve,this.type=type,this.precomputed=null}var BN=require("bn.js"),elliptic=require("../../elliptic"),utils=elliptic.utils,getNAF=utils.getNAF,getJSF=utils.getJSF,assert=utils.assert;module.exports=BaseCurve,BaseCurve.prototype.point=function(){throw new Error("Not implemented")},BaseCurve.prototype.validate=function(){throw new Error("Not implemented")},BaseCurve.prototype._fixedNafMul=function(p,k){assert(p.precomputed);var doubles=p._getDoubles(),naf=getNAF(k,1),I=(1<<doubles.step+1)-(doubles.step%2===0?2:1);I/=3;for(var repr=[],j=0;j<naf.length;j+=doubles.step){for(var nafW=0,k=j+doubles.step-1;k>=j;k--)nafW=(nafW<<1)+naf[k];repr.push(nafW)}for(var a=this.jpoint(null,null,null),b=this.jpoint(null,null,null),i=I;i>0;i--){for(var j=0;j<repr.length;j++){var nafW=repr[j];nafW===i?b=b.mixedAdd(doubles.points[j]):nafW===-i&&(b=b.mixedAdd(doubles.points[j].neg()))}a=a.add(b)}return a.toP()},BaseCurve.prototype._wnafMul=function(p,k){var w=4,nafPoints=p._getNAFPoints(w);w=nafPoints.wnd;for(var wnd=nafPoints.points,naf=getNAF(k,w),acc=this.jpoint(null,null,null),i=naf.length-1;i>=0;i--){for(var k=0;i>=0&&0===naf[i];i--)k++;if(i>=0&&k++,acc=acc.dblp(k),i<0)break;var z=naf[i];assert(0!==z),acc="affine"===p.type?z>0?acc.mixedAdd(wnd[z-1>>1]):acc.mixedAdd(wnd[-z-1>>1].neg()):z>0?acc.add(wnd[z-1>>1]):acc.add(wnd[-z-1>>1].neg())}return"affine"===p.type?acc.toP():acc},BaseCurve.prototype._wnafMulAdd=function(defW,points,coeffs,len,jacobianResult){for(var wndWidth=this._wnafT1,wnd=this._wnafT2,naf=this._wnafT3,max=0,i=0;i<len;i++){var p=points[i],nafPoints=p._getNAFPoints(defW);wndWidth[i]=nafPoints.wnd,wnd[i]=nafPoints.points}for(var i=len-1;i>=1;i-=2){var a=i-1,b=i;if(1===wndWidth[a]&&1===wndWidth[b]){var comb=[points[a],null,null,points[b]];0===points[a].y.cmp(points[b].y)?(comb[1]=points[a].add(points[b]),comb[2]=points[a].toJ().mixedAdd(points[b].neg())):0===points[a].y.cmp(points[b].y.redNeg())?(comb[1]=points[a].toJ().mixedAdd(points[b]),comb[2]=points[a].add(points[b].neg())):(comb[1]=points[a].toJ().mixedAdd(points[b]),comb[2]=points[a].toJ().mixedAdd(points[b].neg()));var index=[-3,-1,-5,-7,0,7,5,1,3],jsf=getJSF(coeffs[a],coeffs[b]);max=Math.max(jsf[0].length,max),naf[a]=new Array(max),naf[b]=new Array(max);for(var j=0;j<max;j++){var ja=0|jsf[0][j],jb=0|jsf[1][j];naf[a][j]=index[3*(ja+1)+(jb+1)],naf[b][j]=0,wnd[a]=comb}}else naf[a]=getNAF(coeffs[a],wndWidth[a]),naf[b]=getNAF(coeffs[b],wndWidth[b]),max=Math.max(naf[a].length,max),max=Math.max(naf[b].length,max)}for(var acc=this.jpoint(null,null,null),tmp=this._wnafT4,i=max;i>=0;i--){for(var k=0;i>=0;){for(var zero=!0,j=0;j<len;j++)tmp[j]=0|naf[j][i],0!==tmp[j]&&(zero=!1);if(!zero)break;k++,i--}if(i>=0&&k++,acc=acc.dblp(k),i<0)break;for(var j=0;j<len;j++){var p,z=tmp[j];0!==z&&(z>0?p=wnd[j][z-1>>1]:z<0&&(p=wnd[j][-z-1>>1].neg()),acc="affine"===p.type?acc.mixedAdd(p):acc.add(p))}}for(var i=0;i<len;i++)wnd[i]=null;return jacobianResult?acc:acc.toP()},BaseCurve.BasePoint=BasePoint,BasePoint.prototype.eq=function(){throw new Error("Not implemented")},BasePoint.prototype.validate=function(){return this.curve.validate(this)},BaseCurve.prototype.decodePoint=function(bytes,enc){bytes=utils.toArray(bytes,enc);var len=this.p.byteLength();if((4===bytes[0]||6===bytes[0]||7===bytes[0])&&bytes.length-1===2*len){6===bytes[0]?assert(bytes[bytes.length-1]%2===0):7===bytes[0]&&assert(bytes[bytes.length-1]%2===1);var res=this.point(bytes.slice(1,1+len),bytes.slice(1+len,1+2*len));return res}if((2===bytes[0]||3===bytes[0])&&bytes.length-1===len)return this.pointFromX(bytes.slice(1,1+len),3===bytes[0]);throw new Error("Unknown point format")},BasePoint.prototype.encodeCompressed=function(enc){return this.encode(enc,!0)},BasePoint.prototype._encode=function(compact){var len=this.curve.p.byteLength(),x=this.getX().toArray("be",len);return compact?[this.getY().isEven()?2:3].concat(x):[4].concat(x,this.getY().toArray("be",len))},BasePoint.prototype.encode=function(enc,compact){return utils.encode(this._encode(compact),enc)},BasePoint.prototype.precompute=function(power){if(this.precomputed)return this;var precomputed={doubles:null,naf:null,beta:null};return precomputed.naf=this._getNAFPoints(8),precomputed.doubles=this._getDoubles(4,power),precomputed.beta=this._getBeta(),this.precomputed=precomputed,this},BasePoint.prototype._hasDoubles=function(k){if(!this.precomputed)return!1;var doubles=this.precomputed.doubles;return!!doubles&&doubles.points.length>=Math.ceil((k.bitLength()+1)/doubles.step)},BasePoint.prototype._getDoubles=function(step,power){if(this.precomputed&&this.precomputed.doubles)return this.precomputed.doubles;for(var doubles=[this],acc=this,i=0;i<power;i+=step){for(var j=0;j<step;j++)acc=acc.dbl();doubles.push(acc)}return{step:step,points:doubles}},BasePoint.prototype._getNAFPoints=function(wnd){if(this.precomputed&&this.precomputed.naf)return this.precomputed.naf;for(var res=[this],max=(1<<wnd)-1,dbl=1===max?null:this.dbl(),i=1;i<max;i++)res[i]=res[i-1].add(dbl);return{wnd:wnd,points:res}},BasePoint.prototype._getBeta=function(){return null},BasePoint.prototype.dblp=function(k){for(var r=this,i=0;i<k;i++)r=r.dbl();return r}},{"../../elliptic":199,"bn.js":117}],201:[function(require,module,exports){"use strict";function EdwardsCurve(conf){this.twisted=1!==(0|conf.a),this.mOneA=this.twisted&&(0|conf.a)===-1,this.extended=this.mOneA,Base.call(this,"edwards",conf),this.a=new BN(conf.a,16).umod(this.red.m),this.a=this.a.toRed(this.red),this.c=new BN(conf.c,16).toRed(this.red),this.c2=this.c.redSqr(),this.d=new BN(conf.d,16).toRed(this.red),this.dd=this.d.redAdd(this.d),assert(!this.twisted||0===this.c.fromRed().cmpn(1)),this.oneC=1===(0|conf.c)}function Point(curve,x,y,z,t){Base.BasePoint.call(this,curve,"projective"),null===x&&null===y&&null===z?(this.x=this.curve.zero,this.y=this.curve.one,this.z=this.curve.one,this.t=this.curve.zero,this.zOne=!0):(this.x=new BN(x,16),this.y=new BN(y,16),this.z=z?new BN(z,16):this.curve.one,this.t=t&&new BN(t,16),this.x.red||(this.x=this.x.toRed(this.curve.red)),this.y.red||(this.y=this.y.toRed(this.curve.red)),this.z.red||(this.z=this.z.toRed(this.curve.red)),this.t&&!this.t.red&&(this.t=this.t.toRed(this.curve.red)),this.zOne=this.z===this.curve.one,this.curve.extended&&!this.t&&(this.t=this.x.redMul(this.y),this.zOne||(this.t=this.t.redMul(this.z.redInvm()))))}var curve=require("../curve"),elliptic=require("../../elliptic"),BN=require("bn.js"),inherits=require("inherits"),Base=curve.base,assert=elliptic.utils.assert;inherits(EdwardsCurve,Base),module.exports=EdwardsCurve,EdwardsCurve.prototype._mulA=function(num){return this.mOneA?num.redNeg():this.a.redMul(num)},EdwardsCurve.prototype._mulC=function(num){return this.oneC?num:this.c.redMul(num)},EdwardsCurve.prototype.jpoint=function(x,y,z,t){return this.point(x,y,z,t)},EdwardsCurve.prototype.pointFromX=function(x,odd){x=new BN(x,16),x.red||(x=x.toRed(this.red));var x2=x.redSqr(),rhs=this.c2.redSub(this.a.redMul(x2)),lhs=this.one.redSub(this.c2.redMul(this.d).redMul(x2)),y2=rhs.redMul(lhs.redInvm()),y=y2.redSqrt();if(0!==y.redSqr().redSub(y2).cmp(this.zero))throw new Error("invalid point");var isOdd=y.fromRed().isOdd();return(odd&&!isOdd||!odd&&isOdd)&&(y=y.redNeg()),this.point(x,y)},EdwardsCurve.prototype.pointFromY=function(y,odd){y=new BN(y,16),y.red||(y=y.toRed(this.red));var y2=y.redSqr(),lhs=y2.redSub(this.one),rhs=y2.redMul(this.d).redAdd(this.one),x2=lhs.redMul(rhs.redInvm());if(0===x2.cmp(this.zero)){if(odd)throw new Error("invalid point");return this.point(this.zero,y)}var x=x2.redSqrt();if(0!==x.redSqr().redSub(x2).cmp(this.zero))throw new Error("invalid point");return x.isOdd()!==odd&&(x=x.redNeg()),this.point(x,y)},EdwardsCurve.prototype.validate=function(point){if(point.isInfinity())return!0;point.normalize();var x2=point.x.redSqr(),y2=point.y.redSqr(),lhs=x2.redMul(this.a).redAdd(y2),rhs=this.c2.redMul(this.one.redAdd(this.d.redMul(x2).redMul(y2)));return 0===lhs.cmp(rhs)},inherits(Point,Base.BasePoint),EdwardsCurve.prototype.pointFromJSON=function(obj){return Point.fromJSON(this,obj)},EdwardsCurve.prototype.point=function(x,y,z,t){return new Point(this,x,y,z,t)},Point.fromJSON=function(curve,obj){return new Point(curve,obj[0],obj[1],obj[2])},Point.prototype.inspect=function(){return this.isInfinity()?"<EC Point Infinity>":"<EC Point x: "+this.x.fromRed().toString(16,2)+" y: "+this.y.fromRed().toString(16,2)+" z: "+this.z.fromRed().toString(16,2)+">"},Point.prototype.isInfinity=function(){return 0===this.x.cmpn(0)&&0===this.y.cmp(this.z)},Point.prototype._extDbl=function(){var a=this.x.redSqr(),b=this.y.redSqr(),c=this.z.redSqr();c=c.redIAdd(c);var d=this.curve._mulA(a),e=this.x.redAdd(this.y).redSqr().redISub(a).redISub(b),g=d.redAdd(b),f=g.redSub(c),h=d.redSub(b),nx=e.redMul(f),ny=g.redMul(h),nt=e.redMul(h),nz=f.redMul(g);return this.curve.point(nx,ny,nz,nt)},Point.prototype._projDbl=function(){var nx,ny,nz,b=this.x.redAdd(this.y).redSqr(),c=this.x.redSqr(),d=this.y.redSqr();if(this.curve.twisted){var e=this.curve._mulA(c),f=e.redAdd(d);if(this.zOne)nx=b.redSub(c).redSub(d).redMul(f.redSub(this.curve.two)),ny=f.redMul(e.redSub(d)),nz=f.redSqr().redSub(f).redSub(f);else{var h=this.z.redSqr(),j=f.redSub(h).redISub(h);nx=b.redSub(c).redISub(d).redMul(j),ny=f.redMul(e.redSub(d)),nz=f.redMul(j)}}else{var e=c.redAdd(d),h=this.curve._mulC(this.c.redMul(this.z)).redSqr(),j=e.redSub(h).redSub(h);nx=this.curve._mulC(b.redISub(e)).redMul(j),ny=this.curve._mulC(e).redMul(c.redISub(d)),nz=e.redMul(j)}return this.curve.point(nx,ny,nz)},Point.prototype.dbl=function(){return this.isInfinity()?this:this.curve.extended?this._extDbl():this._projDbl()},Point.prototype._extAdd=function(p){var a=this.y.redSub(this.x).redMul(p.y.redSub(p.x)),b=this.y.redAdd(this.x).redMul(p.y.redAdd(p.x)),c=this.t.redMul(this.curve.dd).redMul(p.t),d=this.z.redMul(p.z.redAdd(p.z)),e=b.redSub(a),f=d.redSub(c),g=d.redAdd(c),h=b.redAdd(a),nx=e.redMul(f),ny=g.redMul(h),nt=e.redMul(h),nz=f.redMul(g);return this.curve.point(nx,ny,nz,nt)},Point.prototype._projAdd=function(p){var ny,nz,a=this.z.redMul(p.z),b=a.redSqr(),c=this.x.redMul(p.x),d=this.y.redMul(p.y),e=this.curve.d.redMul(c).redMul(d),f=b.redSub(e),g=b.redAdd(e),tmp=this.x.redAdd(this.y).redMul(p.x.redAdd(p.y)).redISub(c).redISub(d),nx=a.redMul(f).redMul(tmp);return this.curve.twisted?(ny=a.redMul(g).redMul(d.redSub(this.curve._mulA(c))),nz=f.redMul(g)):(ny=a.redMul(g).redMul(d.redSub(c)),nz=this.curve._mulC(f).redMul(g)),this.curve.point(nx,ny,nz)},Point.prototype.add=function(p){return this.isInfinity()?p:p.isInfinity()?this:this.curve.extended?this._extAdd(p):this._projAdd(p)},Point.prototype.mul=function(k){return this._hasDoubles(k)?this.curve._fixedNafMul(this,k):this.curve._wnafMul(this,k)},Point.prototype.mulAdd=function(k1,p,k2){return this.curve._wnafMulAdd(1,[this,p],[k1,k2],2,!1)},Point.prototype.jmulAdd=function(k1,p,k2){return this.curve._wnafMulAdd(1,[this,p],[k1,k2],2,!0)},Point.prototype.normalize=function(){if(this.zOne)return this;var zi=this.z.redInvm();return this.x=this.x.redMul(zi),this.y=this.y.redMul(zi),this.t&&(this.t=this.t.redMul(zi)),this.z=this.curve.one,this.zOne=!0,this},Point.prototype.neg=function(){return this.curve.point(this.x.redNeg(),this.y,this.z,this.t&&this.t.redNeg())},Point.prototype.getX=function(){return this.normalize(),this.x.fromRed()},Point.prototype.getY=function(){return this.normalize(),this.y.fromRed()},Point.prototype.eq=function(other){return this===other||0===this.getX().cmp(other.getX())&&0===this.getY().cmp(other.getY())},Point.prototype.eqXToP=function(x){var rx=x.toRed(this.curve.red).redMul(this.z);if(0===this.x.cmp(rx))return!0;for(var xc=x.clone(),t=this.curve.redN.redMul(this.z);;){if(xc.iadd(this.curve.n),xc.cmp(this.curve.p)>=0)return!1;if(rx.redIAdd(t),0===this.x.cmp(rx))return!0}return!1},Point.prototype.toP=Point.prototype.normalize,Point.prototype.mixedAdd=Point.prototype.add},{"../../elliptic":199,"../curve":202,"bn.js":117,inherits:233}],202:[function(require,module,exports){arguments[4][86][0].apply(exports,arguments)},{"./base":200,"./edwards":201,"./mont":203,"./short":204,dup:86}],203:[function(require,module,exports){"use strict";function MontCurve(conf){Base.call(this,"mont",conf),this.a=new BN(conf.a,16).toRed(this.red),this.b=new BN(conf.b,16).toRed(this.red),this.i4=new BN(4).toRed(this.red).redInvm(),this.two=new BN(2).toRed(this.red),this.a24=this.i4.redMul(this.a.redAdd(this.two))}function Point(curve,x,z){Base.BasePoint.call(this,curve,"projective"),null===x&&null===z?(this.x=this.curve.one,this.z=this.curve.zero):(this.x=new BN(x,16),this.z=new BN(z,16),this.x.red||(this.x=this.x.toRed(this.curve.red)),this.z.red||(this.z=this.z.toRed(this.curve.red)))}var curve=require("../curve"),BN=require("bn.js"),inherits=require("inherits"),Base=curve.base,elliptic=require("../../elliptic"),utils=elliptic.utils;inherits(MontCurve,Base),module.exports=MontCurve,MontCurve.prototype.validate=function(point){var x=point.normalize().x,x2=x.redSqr(),rhs=x2.redMul(x).redAdd(x2.redMul(this.a)).redAdd(x),y=rhs.redSqrt();return 0===y.redSqr().cmp(rhs)},inherits(Point,Base.BasePoint),MontCurve.prototype.decodePoint=function(bytes,enc){return this.point(utils.toArray(bytes,enc),1)},MontCurve.prototype.point=function(x,z){return new Point(this,x,z)},MontCurve.prototype.pointFromJSON=function(obj){return Point.fromJSON(this,obj)},Point.prototype.precompute=function(){},Point.prototype._encode=function(){return this.getX().toArray("be",this.curve.p.byteLength())},Point.fromJSON=function(curve,obj){return new Point(curve,obj[0],obj[1]||curve.one)},Point.prototype.inspect=function(){return this.isInfinity()?"<EC Point Infinity>":"<EC Point x: "+this.x.fromRed().toString(16,2)+" z: "+this.z.fromRed().toString(16,2)+">"},Point.prototype.isInfinity=function(){return 0===this.z.cmpn(0)},Point.prototype.dbl=function(){var a=this.x.redAdd(this.z),aa=a.redSqr(),b=this.x.redSub(this.z),bb=b.redSqr(),c=aa.redSub(bb),nx=aa.redMul(bb),nz=c.redMul(bb.redAdd(this.curve.a24.redMul(c)));return this.curve.point(nx,nz)},Point.prototype.add=function(){throw new Error("Not supported on Montgomery curve")},Point.prototype.diffAdd=function(p,diff){var a=this.x.redAdd(this.z),b=this.x.redSub(this.z),c=p.x.redAdd(p.z),d=p.x.redSub(p.z),da=d.redMul(a),cb=c.redMul(b),nx=diff.z.redMul(da.redAdd(cb).redSqr()),nz=diff.x.redMul(da.redISub(cb).redSqr());return this.curve.point(nx,nz)},Point.prototype.mul=function(k){for(var t=k.clone(),a=this,b=this.curve.point(null,null),c=this,bits=[];0!==t.cmpn(0);t.iushrn(1))bits.push(t.andln(1));for(var i=bits.length-1;i>=0;i--)0===bits[i]?(a=a.diffAdd(b,c),b=b.dbl()):(b=a.diffAdd(b,c),a=a.dbl());return b},Point.prototype.mulAdd=function(){throw new Error("Not supported on Montgomery curve")},Point.prototype.jumlAdd=function(){throw new Error("Not supported on Montgomery curve")},Point.prototype.eq=function(other){return 0===this.getX().cmp(other.getX())},Point.prototype.normalize=function(){return this.x=this.x.redMul(this.z.redInvm()),this.z=this.curve.one,this},Point.prototype.getX=function(){return this.normalize(),this.x.fromRed()}},{"../../elliptic":199,"../curve":202,"bn.js":117,inherits:233}],204:[function(require,module,exports){"use strict";function ShortCurve(conf){Base.call(this,"short",conf),this.a=new BN(conf.a,16).toRed(this.red),this.b=new BN(conf.b,16).toRed(this.red),this.tinv=this.two.redInvm(),this.zeroA=0===this.a.fromRed().cmpn(0),this.threeA=0===this.a.fromRed().sub(this.p).cmpn(-3),this.endo=this._getEndomorphism(conf),this._endoWnafT1=new Array(4),this._endoWnafT2=new Array(4)}function Point(curve,x,y,isRed){Base.BasePoint.call(this,curve,"affine"),null===x&&null===y?(this.x=null,this.y=null,this.inf=!0):(this.x=new BN(x,16),this.y=new BN(y,16),isRed&&(this.x.forceRed(this.curve.red),this.y.forceRed(this.curve.red)),this.x.red||(this.x=this.x.toRed(this.curve.red)),this.y.red||(this.y=this.y.toRed(this.curve.red)),this.inf=!1)}function JPoint(curve,x,y,z){Base.BasePoint.call(this,curve,"jacobian"),null===x&&null===y&&null===z?(this.x=this.curve.one,this.y=this.curve.one,this.z=new BN(0)):(this.x=new BN(x,16),this.y=new BN(y,16),this.z=new BN(z,16)),this.x.red||(this.x=this.x.toRed(this.curve.red)),this.y.red||(this.y=this.y.toRed(this.curve.red)),this.z.red||(this.z=this.z.toRed(this.curve.red)),this.zOne=this.z===this.curve.one}var curve=require("../curve"),elliptic=require("../../elliptic"),BN=require("bn.js"),inherits=require("inherits"),Base=curve.base,assert=elliptic.utils.assert;inherits(ShortCurve,Base),module.exports=ShortCurve,ShortCurve.prototype._getEndomorphism=function(conf){if(this.zeroA&&this.g&&this.n&&1===this.p.modn(3)){var beta,lambda;if(conf.beta)beta=new BN(conf.beta,16).toRed(this.red);else{var betas=this._getEndoRoots(this.p);beta=betas[0].cmp(betas[1])<0?betas[0]:betas[1],beta=beta.toRed(this.red)}if(conf.lambda)lambda=new BN(conf.lambda,16);else{var lambdas=this._getEndoRoots(this.n);0===this.g.mul(lambdas[0]).x.cmp(this.g.x.redMul(beta))?lambda=lambdas[0]:(lambda=lambdas[1],assert(0===this.g.mul(lambda).x.cmp(this.g.x.redMul(beta))))}var basis;return basis=conf.basis?conf.basis.map(function(vec){return{a:new BN(vec.a,16),b:new BN(vec.b,16)}}):this._getEndoBasis(lambda),{beta:beta,lambda:lambda,basis:basis}}},ShortCurve.prototype._getEndoRoots=function(num){var red=num===this.p?this.red:BN.mont(num),tinv=new BN(2).toRed(red).redInvm(),ntinv=tinv.redNeg(),s=new BN(3).toRed(red).redNeg().redSqrt().redMul(tinv),l1=ntinv.redAdd(s).fromRed(),l2=ntinv.redSub(s).fromRed();return[l1,l2]},ShortCurve.prototype._getEndoBasis=function(lambda){for(var a0,b0,a1,b1,a2,b2,prevR,r,x,aprxSqrt=this.n.ushrn(Math.floor(this.n.bitLength()/2)),u=lambda,v=this.n.clone(),x1=new BN(1),y1=new BN(0),x2=new BN(0),y2=new BN(1),i=0;0!==u.cmpn(0);){var q=v.div(u);r=v.sub(q.mul(u)),x=x2.sub(q.mul(x1));var y=y2.sub(q.mul(y1));if(!a1&&r.cmp(aprxSqrt)<0)a0=prevR.neg(),b0=x1,a1=r.neg(),b1=x;else if(a1&&2===++i)break;prevR=r,v=u,u=r,x2=x1,x1=x,y2=y1,y1=y}a2=r.neg(),b2=x;var len1=a1.sqr().add(b1.sqr()),len2=a2.sqr().add(b2.sqr());return len2.cmp(len1)>=0&&(a2=a0,b2=b0),a1.negative&&(a1=a1.neg(),b1=b1.neg()),a2.negative&&(a2=a2.neg(),b2=b2.neg()),[{a:a1,b:b1},{a:a2,b:b2}]},ShortCurve.prototype._endoSplit=function(k){var basis=this.endo.basis,v1=basis[0],v2=basis[1],c1=v2.b.mul(k).divRound(this.n),c2=v1.b.neg().mul(k).divRound(this.n),p1=c1.mul(v1.a),p2=c2.mul(v2.a),q1=c1.mul(v1.b),q2=c2.mul(v2.b),k1=k.sub(p1).sub(p2),k2=q1.add(q2).neg();return{k1:k1,k2:k2}},ShortCurve.prototype.pointFromX=function(x,odd){x=new BN(x,16),x.red||(x=x.toRed(this.red));var y2=x.redSqr().redMul(x).redIAdd(x.redMul(this.a)).redIAdd(this.b),y=y2.redSqrt();if(0!==y.redSqr().redSub(y2).cmp(this.zero))throw new Error("invalid point");var isOdd=y.fromRed().isOdd();return(odd&&!isOdd||!odd&&isOdd)&&(y=y.redNeg()),this.point(x,y)},ShortCurve.prototype.validate=function(point){if(point.inf)return!0;var x=point.x,y=point.y,ax=this.a.redMul(x),rhs=x.redSqr().redMul(x).redIAdd(ax).redIAdd(this.b);return 0===y.redSqr().redISub(rhs).cmpn(0)},ShortCurve.prototype._endoWnafMulAdd=function(points,coeffs,jacobianResult){for(var npoints=this._endoWnafT1,ncoeffs=this._endoWnafT2,i=0;i<points.length;i++){var split=this._endoSplit(coeffs[i]),p=points[i],beta=p._getBeta();split.k1.negative&&(split.k1.ineg(),p=p.neg(!0)),split.k2.negative&&(split.k2.ineg(),beta=beta.neg(!0)),npoints[2*i]=p,npoints[2*i+1]=beta,ncoeffs[2*i]=split.k1,ncoeffs[2*i+1]=split.k2}for(var res=this._wnafMulAdd(1,npoints,ncoeffs,2*i,jacobianResult),j=0;j<2*i;j++)npoints[j]=null,ncoeffs[j]=null;return res},inherits(Point,Base.BasePoint),ShortCurve.prototype.point=function(x,y,isRed){return new Point(this,x,y,isRed)},ShortCurve.prototype.pointFromJSON=function(obj,red){return Point.fromJSON(this,obj,red)},Point.prototype._getBeta=function(){if(this.curve.endo){var pre=this.precomputed;if(pre&&pre.beta)return pre.beta;var beta=this.curve.point(this.x.redMul(this.curve.endo.beta),this.y);if(pre){var curve=this.curve,endoMul=function(p){return curve.point(p.x.redMul(curve.endo.beta),p.y)};pre.beta=beta,beta.precomputed={beta:null,naf:pre.naf&&{wnd:pre.naf.wnd,points:pre.naf.points.map(endoMul)},doubles:pre.doubles&&{step:pre.doubles.step,points:pre.doubles.points.map(endoMul)}}}return beta}},Point.prototype.toJSON=function(){return this.precomputed?[this.x,this.y,this.precomputed&&{doubles:this.precomputed.doubles&&{step:this.precomputed.doubles.step,points:this.precomputed.doubles.points.slice(1)},naf:this.precomputed.naf&&{wnd:this.precomputed.naf.wnd,points:this.precomputed.naf.points.slice(1)}}]:[this.x,this.y]},Point.fromJSON=function(curve,obj,red){function obj2point(obj){return curve.point(obj[0],obj[1],red)}"string"==typeof obj&&(obj=JSON.parse(obj));var res=curve.point(obj[0],obj[1],red);if(!obj[2])return res;var pre=obj[2];return res.precomputed={beta:null,doubles:pre.doubles&&{step:pre.doubles.step,points:[res].concat(pre.doubles.points.map(obj2point))},naf:pre.naf&&{wnd:pre.naf.wnd,points:[res].concat(pre.naf.points.map(obj2point))}},res},Point.prototype.inspect=function(){return this.isInfinity()?"<EC Point Infinity>":"<EC Point x: "+this.x.fromRed().toString(16,2)+" y: "+this.y.fromRed().toString(16,2)+">"},Point.prototype.isInfinity=function(){return this.inf},Point.prototype.add=function(p){if(this.inf)return p;if(p.inf)return this;if(this.eq(p))return this.dbl();if(this.neg().eq(p))return this.curve.point(null,null);if(0===this.x.cmp(p.x))return this.curve.point(null,null);var c=this.y.redSub(p.y);0!==c.cmpn(0)&&(c=c.redMul(this.x.redSub(p.x).redInvm()));var nx=c.redSqr().redISub(this.x).redISub(p.x),ny=c.redMul(this.x.redSub(nx)).redISub(this.y);return this.curve.point(nx,ny)},Point.prototype.dbl=function(){if(this.inf)return this;var ys1=this.y.redAdd(this.y);if(0===ys1.cmpn(0))return this.curve.point(null,null);var a=this.curve.a,x2=this.x.redSqr(),dyinv=ys1.redInvm(),c=x2.redAdd(x2).redIAdd(x2).redIAdd(a).redMul(dyinv),nx=c.redSqr().redISub(this.x.redAdd(this.x)),ny=c.redMul(this.x.redSub(nx)).redISub(this.y);return this.curve.point(nx,ny)},Point.prototype.getX=function(){return this.x.fromRed()},Point.prototype.getY=function(){return this.y.fromRed()},Point.prototype.mul=function(k){return k=new BN(k,16),this._hasDoubles(k)?this.curve._fixedNafMul(this,k):this.curve.endo?this.curve._endoWnafMulAdd([this],[k]):this.curve._wnafMul(this,k)},Point.prototype.mulAdd=function(k1,p2,k2){var points=[this,p2],coeffs=[k1,k2];return this.curve.endo?this.curve._endoWnafMulAdd(points,coeffs):this.curve._wnafMulAdd(1,points,coeffs,2)},Point.prototype.jmulAdd=function(k1,p2,k2){var points=[this,p2],coeffs=[k1,k2];return this.curve.endo?this.curve._endoWnafMulAdd(points,coeffs,!0):this.curve._wnafMulAdd(1,points,coeffs,2,!0)},Point.prototype.eq=function(p){return this===p||this.inf===p.inf&&(this.inf||0===this.x.cmp(p.x)&&0===this.y.cmp(p.y))},Point.prototype.neg=function(_precompute){if(this.inf)return this;var res=this.curve.point(this.x,this.y.redNeg());if(_precompute&&this.precomputed){var pre=this.precomputed,negate=function(p){return p.neg()};res.precomputed={naf:pre.naf&&{wnd:pre.naf.wnd,points:pre.naf.points.map(negate)},doubles:pre.doubles&&{step:pre.doubles.step,points:pre.doubles.points.map(negate)}}}return res},Point.prototype.toJ=function(){if(this.inf)return this.curve.jpoint(null,null,null);var res=this.curve.jpoint(this.x,this.y,this.curve.one);return res},inherits(JPoint,Base.BasePoint),ShortCurve.prototype.jpoint=function(x,y,z){return new JPoint(this,x,y,z)},JPoint.prototype.toP=function(){if(this.isInfinity())return this.curve.point(null,null);var zinv=this.z.redInvm(),zinv2=zinv.redSqr(),ax=this.x.redMul(zinv2),ay=this.y.redMul(zinv2).redMul(zinv);return this.curve.point(ax,ay)},JPoint.prototype.neg=function(){return this.curve.jpoint(this.x,this.y.redNeg(),this.z)},JPoint.prototype.add=function(p){if(this.isInfinity())return p;if(p.isInfinity())return this;var pz2=p.z.redSqr(),z2=this.z.redSqr(),u1=this.x.redMul(pz2),u2=p.x.redMul(z2),s1=this.y.redMul(pz2.redMul(p.z)),s2=p.y.redMul(z2.redMul(this.z)),h=u1.redSub(u2),r=s1.redSub(s2);if(0===h.cmpn(0))return 0!==r.cmpn(0)?this.curve.jpoint(null,null,null):this.dbl();var h2=h.redSqr(),h3=h2.redMul(h),v=u1.redMul(h2),nx=r.redSqr().redIAdd(h3).redISub(v).redISub(v),ny=r.redMul(v.redISub(nx)).redISub(s1.redMul(h3)),nz=this.z.redMul(p.z).redMul(h);return this.curve.jpoint(nx,ny,nz)},JPoint.prototype.mixedAdd=function(p){if(this.isInfinity())return p.toJ();if(p.isInfinity())return this;var z2=this.z.redSqr(),u1=this.x,u2=p.x.redMul(z2),s1=this.y,s2=p.y.redMul(z2).redMul(this.z),h=u1.redSub(u2),r=s1.redSub(s2);if(0===h.cmpn(0))return 0!==r.cmpn(0)?this.curve.jpoint(null,null,null):this.dbl();var h2=h.redSqr(),h3=h2.redMul(h),v=u1.redMul(h2),nx=r.redSqr().redIAdd(h3).redISub(v).redISub(v),ny=r.redMul(v.redISub(nx)).redISub(s1.redMul(h3)),nz=this.z.redMul(h);return this.curve.jpoint(nx,ny,nz)},JPoint.prototype.dblp=function(pow){if(0===pow)return this;if(this.isInfinity())return this;if(!pow)return this.dbl();if(this.curve.zeroA||this.curve.threeA){for(var r=this,i=0;i<pow;i++)r=r.dbl();return r}for(var a=this.curve.a,tinv=this.curve.tinv,jx=this.x,jy=this.y,jz=this.z,jz4=jz.redSqr().redSqr(),jyd=jy.redAdd(jy),i=0;i<pow;i++){var jx2=jx.redSqr(),jyd2=jyd.redSqr(),jyd4=jyd2.redSqr(),c=jx2.redAdd(jx2).redIAdd(jx2).redIAdd(a.redMul(jz4)),t1=jx.redMul(jyd2),nx=c.redSqr().redISub(t1.redAdd(t1)),t2=t1.redISub(nx),dny=c.redMul(t2);dny=dny.redIAdd(dny).redISub(jyd4);var nz=jyd.redMul(jz);i+1<pow&&(jz4=jz4.redMul(jyd4)),jx=nx,jz=nz,jyd=dny}return this.curve.jpoint(jx,jyd.redMul(tinv),jz)},JPoint.prototype.dbl=function(){return this.isInfinity()?this:this.curve.zeroA?this._zeroDbl():this.curve.threeA?this._threeDbl():this._dbl()},JPoint.prototype._zeroDbl=function(){var nx,ny,nz;if(this.zOne){var xx=this.x.redSqr(),yy=this.y.redSqr(),yyyy=yy.redSqr(),s=this.x.redAdd(yy).redSqr().redISub(xx).redISub(yyyy);s=s.redIAdd(s);var m=xx.redAdd(xx).redIAdd(xx),t=m.redSqr().redISub(s).redISub(s),yyyy8=yyyy.redIAdd(yyyy);yyyy8=yyyy8.redIAdd(yyyy8),yyyy8=yyyy8.redIAdd(yyyy8),nx=t,ny=m.redMul(s.redISub(t)).redISub(yyyy8),nz=this.y.redAdd(this.y)}else{var a=this.x.redSqr(),b=this.y.redSqr(),c=b.redSqr(),d=this.x.redAdd(b).redSqr().redISub(a).redISub(c);d=d.redIAdd(d);var e=a.redAdd(a).redIAdd(a),f=e.redSqr(),c8=c.redIAdd(c);c8=c8.redIAdd(c8),c8=c8.redIAdd(c8),nx=f.redISub(d).redISub(d),ny=e.redMul(d.redISub(nx)).redISub(c8),nz=this.y.redMul(this.z),nz=nz.redIAdd(nz)}return this.curve.jpoint(nx,ny,nz)},JPoint.prototype._threeDbl=function(){var nx,ny,nz;if(this.zOne){var xx=this.x.redSqr(),yy=this.y.redSqr(),yyyy=yy.redSqr(),s=this.x.redAdd(yy).redSqr().redISub(xx).redISub(yyyy);s=s.redIAdd(s);
var m=xx.redAdd(xx).redIAdd(xx).redIAdd(this.curve.a),t=m.redSqr().redISub(s).redISub(s);nx=t;var yyyy8=yyyy.redIAdd(yyyy);yyyy8=yyyy8.redIAdd(yyyy8),yyyy8=yyyy8.redIAdd(yyyy8),ny=m.redMul(s.redISub(t)).redISub(yyyy8),nz=this.y.redAdd(this.y)}else{var delta=this.z.redSqr(),gamma=this.y.redSqr(),beta=this.x.redMul(gamma),alpha=this.x.redSub(delta).redMul(this.x.redAdd(delta));alpha=alpha.redAdd(alpha).redIAdd(alpha);var beta4=beta.redIAdd(beta);beta4=beta4.redIAdd(beta4);var beta8=beta4.redAdd(beta4);nx=alpha.redSqr().redISub(beta8),nz=this.y.redAdd(this.z).redSqr().redISub(gamma).redISub(delta);var ggamma8=gamma.redSqr();ggamma8=ggamma8.redIAdd(ggamma8),ggamma8=ggamma8.redIAdd(ggamma8),ggamma8=ggamma8.redIAdd(ggamma8),ny=alpha.redMul(beta4.redISub(nx)).redISub(ggamma8)}return this.curve.jpoint(nx,ny,nz)},JPoint.prototype._dbl=function(){var a=this.curve.a,jx=this.x,jy=this.y,jz=this.z,jz4=jz.redSqr().redSqr(),jx2=jx.redSqr(),jy2=jy.redSqr(),c=jx2.redAdd(jx2).redIAdd(jx2).redIAdd(a.redMul(jz4)),jxd4=jx.redAdd(jx);jxd4=jxd4.redIAdd(jxd4);var t1=jxd4.redMul(jy2),nx=c.redSqr().redISub(t1.redAdd(t1)),t2=t1.redISub(nx),jyd8=jy2.redSqr();jyd8=jyd8.redIAdd(jyd8),jyd8=jyd8.redIAdd(jyd8),jyd8=jyd8.redIAdd(jyd8);var ny=c.redMul(t2).redISub(jyd8),nz=jy.redAdd(jy).redMul(jz);return this.curve.jpoint(nx,ny,nz)},JPoint.prototype.trpl=function(){if(!this.curve.zeroA)return this.dbl().add(this);var xx=this.x.redSqr(),yy=this.y.redSqr(),zz=this.z.redSqr(),yyyy=yy.redSqr(),m=xx.redAdd(xx).redIAdd(xx),mm=m.redSqr(),e=this.x.redAdd(yy).redSqr().redISub(xx).redISub(yyyy);e=e.redIAdd(e),e=e.redAdd(e).redIAdd(e),e=e.redISub(mm);var ee=e.redSqr(),t=yyyy.redIAdd(yyyy);t=t.redIAdd(t),t=t.redIAdd(t),t=t.redIAdd(t);var u=m.redIAdd(e).redSqr().redISub(mm).redISub(ee).redISub(t),yyu4=yy.redMul(u);yyu4=yyu4.redIAdd(yyu4),yyu4=yyu4.redIAdd(yyu4);var nx=this.x.redMul(ee).redISub(yyu4);nx=nx.redIAdd(nx),nx=nx.redIAdd(nx);var ny=this.y.redMul(u.redMul(t.redISub(u)).redISub(e.redMul(ee)));ny=ny.redIAdd(ny),ny=ny.redIAdd(ny),ny=ny.redIAdd(ny);var nz=this.z.redAdd(e).redSqr().redISub(zz).redISub(ee);return this.curve.jpoint(nx,ny,nz)},JPoint.prototype.mul=function(k,kbase){return k=new BN(k,kbase),this.curve._wnafMul(this,k)},JPoint.prototype.eq=function(p){if("affine"===p.type)return this.eq(p.toJ());if(this===p)return!0;var z2=this.z.redSqr(),pz2=p.z.redSqr();if(0!==this.x.redMul(pz2).redISub(p.x.redMul(z2)).cmpn(0))return!1;var z3=z2.redMul(this.z),pz3=pz2.redMul(p.z);return 0===this.y.redMul(pz3).redISub(p.y.redMul(z3)).cmpn(0)},JPoint.prototype.eqXToP=function(x){var zs=this.z.redSqr(),rx=x.toRed(this.curve.red).redMul(zs);if(0===this.x.cmp(rx))return!0;for(var xc=x.clone(),t=this.curve.redN.redMul(zs);;){if(xc.iadd(this.curve.n),xc.cmp(this.curve.p)>=0)return!1;if(rx.redIAdd(t),0===this.x.cmp(rx))return!0}return!1},JPoint.prototype.inspect=function(){return this.isInfinity()?"<EC JPoint Infinity>":"<EC JPoint x: "+this.x.toString(16,2)+" y: "+this.y.toString(16,2)+" z: "+this.z.toString(16,2)+">"},JPoint.prototype.isInfinity=function(){return 0===this.z.cmpn(0)}},{"../../elliptic":199,"../curve":202,"bn.js":117,inherits:233}],205:[function(require,module,exports){"use strict";function PresetCurve(options){"short"===options.type?this.curve=new elliptic.curve["short"](options):"edwards"===options.type?this.curve=new elliptic.curve.edwards(options):this.curve=new elliptic.curve.mont(options),this.g=this.curve.g,this.n=this.curve.n,this.hash=options.hash,assert(this.g.validate(),"Invalid curve"),assert(this.g.mul(this.n).isInfinity(),"Invalid curve, G*N != O")}function defineCurve(name,options){Object.defineProperty(curves,name,{configurable:!0,enumerable:!0,get:function(){var curve=new PresetCurve(options);return Object.defineProperty(curves,name,{configurable:!0,enumerable:!0,value:curve}),curve}})}var curves=exports,hash=require("hash.js"),elliptic=require("../elliptic"),assert=elliptic.utils.assert;curves.PresetCurve=PresetCurve,defineCurve("p192",{type:"short",prime:"p192",p:"ffffffff ffffffff ffffffff fffffffe ffffffff ffffffff",a:"ffffffff ffffffff ffffffff fffffffe ffffffff fffffffc",b:"64210519 e59c80e7 0fa7e9ab 72243049 feb8deec c146b9b1",n:"ffffffff ffffffff ffffffff 99def836 146bc9b1 b4d22831",hash:hash.sha256,gRed:!1,g:["188da80e b03090f6 7cbf20eb 43a18800 f4ff0afd 82ff1012","07192b95 ffc8da78 631011ed 6b24cdd5 73f977a1 1e794811"]}),defineCurve("p224",{type:"short",prime:"p224",p:"ffffffff ffffffff ffffffff ffffffff 00000000 00000000 00000001",a:"ffffffff ffffffff ffffffff fffffffe ffffffff ffffffff fffffffe",b:"b4050a85 0c04b3ab f5413256 5044b0b7 d7bfd8ba 270b3943 2355ffb4",n:"ffffffff ffffffff ffffffff ffff16a2 e0b8f03e 13dd2945 5c5c2a3d",hash:hash.sha256,gRed:!1,g:["b70e0cbd 6bb4bf7f 321390b9 4a03c1d3 56c21122 343280d6 115c1d21","bd376388 b5f723fb 4c22dfe6 cd4375a0 5a074764 44d58199 85007e34"]}),defineCurve("p256",{type:"short",prime:null,p:"ffffffff 00000001 00000000 00000000 00000000 ffffffff ffffffff ffffffff",a:"ffffffff 00000001 00000000 00000000 00000000 ffffffff ffffffff fffffffc",b:"5ac635d8 aa3a93e7 b3ebbd55 769886bc 651d06b0 cc53b0f6 3bce3c3e 27d2604b",n:"ffffffff 00000000 ffffffff ffffffff bce6faad a7179e84 f3b9cac2 fc632551",hash:hash.sha256,gRed:!1,g:["6b17d1f2 e12c4247 f8bce6e5 63a440f2 77037d81 2deb33a0 f4a13945 d898c296","4fe342e2 fe1a7f9b 8ee7eb4a 7c0f9e16 2bce3357 6b315ece cbb64068 37bf51f5"]}),defineCurve("p384",{type:"short",prime:null,p:"ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe ffffffff 00000000 00000000 ffffffff",a:"ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe ffffffff 00000000 00000000 fffffffc",b:"b3312fa7 e23ee7e4 988e056b e3f82d19 181d9c6e fe814112 0314088f 5013875a c656398d 8a2ed19d 2a85c8ed d3ec2aef",n:"ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff c7634d81 f4372ddf 581a0db2 48b0a77a ecec196a ccc52973",hash:hash.sha384,gRed:!1,g:["aa87ca22 be8b0537 8eb1c71e f320ad74 6e1d3b62 8ba79b98 59f741e0 82542a38 5502f25d bf55296c 3a545e38 72760ab7","3617de4a 96262c6f 5d9e98bf 9292dc29 f8f41dbd 289a147c e9da3113 b5f0b8c0 0a60b1ce 1d7e819d 7a431d7c 90ea0e5f"]}),defineCurve("p521",{type:"short",prime:null,p:"000001ff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff",a:"000001ff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffc",b:"00000051 953eb961 8e1c9a1f 929a21a0 b68540ee a2da725b 99b315f3 b8b48991 8ef109e1 56193951 ec7e937b 1652c0bd 3bb1bf07 3573df88 3d2c34f1 ef451fd4 6b503f00",n:"000001ff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffa 51868783 bf2f966b 7fcc0148 f709a5d0 3bb5c9b8 899c47ae bb6fb71e 91386409",hash:hash.sha512,gRed:!1,g:["000000c6 858e06b7 0404e9cd 9e3ecb66 2395b442 9c648139 053fb521 f828af60 6b4d3dba a14b5e77 efe75928 fe1dc127 a2ffa8de 3348b3c1 856a429b f97e7e31 c2e5bd66","00000118 39296a78 9a3bc004 5c8a5fb4 2c7d1bd9 98f54449 579b4468 17afbd17 273e662c 97ee7299 5ef42640 c550b901 3fad0761 353c7086 a272c240 88be9476 9fd16650"]}),defineCurve("curve25519",{type:"mont",prime:"p25519",p:"7fffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffed",a:"76d06",b:"1",n:"1000000000000000 0000000000000000 14def9dea2f79cd6 5812631a5cf5d3ed",hash:hash.sha256,gRed:!1,g:["9"]}),defineCurve("ed25519",{type:"edwards",prime:"p25519",p:"7fffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffed",a:"-1",c:"1",d:"52036cee2b6ffe73 8cc740797779e898 00700a4d4141d8ab 75eb4dca135978a3",n:"1000000000000000 0000000000000000 14def9dea2f79cd6 5812631a5cf5d3ed",hash:hash.sha256,gRed:!1,g:["216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a","6666666666666666666666666666666666666666666666666666666666666658"]});var pre;try{pre=require("./precomputed/secp256k1")}catch(e){pre=void 0}defineCurve("secp256k1",{type:"short",prime:"k256",p:"ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe fffffc2f",a:"0",b:"7",n:"ffffffff ffffffff ffffffff fffffffe baaedce6 af48a03b bfd25e8c d0364141",h:"1",hash:hash.sha256,beta:"7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee",lambda:"5363ad4cc05c30e0a5261c028812645a122e22ea20816678df02967c1b23bd72",basis:[{a:"3086d221a7d46bcde86c90e49284eb15",b:"-e4437ed6010e88286f547fa90abfe4c3"},{a:"114ca50f7a8e2f3f657c1108d9d44cfd8",b:"3086d221a7d46bcde86c90e49284eb15"}],gRed:!1,g:["79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798","483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8",pre]})},{"../elliptic":199,"./precomputed/secp256k1":212,"hash.js":218}],206:[function(require,module,exports){"use strict";function EC(options){return this instanceof EC?("string"==typeof options&&(assert(elliptic.curves.hasOwnProperty(options),"Unknown curve "+options),options=elliptic.curves[options]),options instanceof elliptic.curves.PresetCurve&&(options={curve:options}),this.curve=options.curve.curve,this.n=this.curve.n,this.nh=this.n.ushrn(1),this.g=this.curve.g,this.g=options.curve.g,this.g.precompute(options.curve.n.bitLength()+1),void(this.hash=options.hash||options.curve.hash)):new EC(options)}var BN=require("bn.js"),HmacDRBG=require("hmac-drbg"),elliptic=require("../../elliptic"),utils=elliptic.utils,assert=utils.assert,KeyPair=require("./key"),Signature=require("./signature");module.exports=EC,EC.prototype.keyPair=function(options){return new KeyPair(this,options)},EC.prototype.keyFromPrivate=function(priv,enc){return KeyPair.fromPrivate(this,priv,enc)},EC.prototype.keyFromPublic=function(pub,enc){return KeyPair.fromPublic(this,pub,enc)},EC.prototype.genKeyPair=function(options){options||(options={});for(var drbg=new HmacDRBG({hash:this.hash,pers:options.pers,persEnc:options.persEnc||"utf8",entropy:options.entropy||elliptic.rand(this.hash.hmacStrength),entropyEnc:options.entropy&&options.entropyEnc||"utf8",nonce:this.n.toArray()}),bytes=this.n.byteLength(),ns2=this.n.sub(new BN(2));;){var priv=new BN(drbg.generate(bytes));if(!(priv.cmp(ns2)>0))return priv.iaddn(1),this.keyFromPrivate(priv)}},EC.prototype._truncateToN=function(msg,truncOnly){var delta=8*msg.byteLength()-this.n.bitLength();return delta>0&&(msg=msg.ushrn(delta)),!truncOnly&&msg.cmp(this.n)>=0?msg.sub(this.n):msg},EC.prototype.sign=function(msg,key,enc,options){"object"==typeof enc&&(options=enc,enc=null),options||(options={}),key=this.keyFromPrivate(key,enc),msg=this._truncateToN(new BN(msg,16));for(var bytes=this.n.byteLength(),bkey=key.getPrivate().toArray("be",bytes),nonce=msg.toArray("be",bytes),drbg=new HmacDRBG({hash:this.hash,entropy:bkey,nonce:nonce,pers:options.pers,persEnc:options.persEnc||"utf8"}),ns1=this.n.sub(new BN(1)),iter=0;!0;iter++){var k=options.k?options.k(iter):new BN(drbg.generate(this.n.byteLength()));if(k=this._truncateToN(k,!0),!(k.cmpn(1)<=0||k.cmp(ns1)>=0)){var kp=this.g.mul(k);if(!kp.isInfinity()){var kpX=kp.getX(),r=kpX.umod(this.n);if(0!==r.cmpn(0)){var s=k.invm(this.n).mul(r.mul(key.getPrivate()).iadd(msg));if(s=s.umod(this.n),0!==s.cmpn(0)){var recoveryParam=(kp.getY().isOdd()?1:0)|(0!==kpX.cmp(r)?2:0);return options.canonical&&s.cmp(this.nh)>0&&(s=this.n.sub(s),recoveryParam^=1),new Signature({r:r,s:s,recoveryParam:recoveryParam})}}}}}},EC.prototype.verify=function(msg,signature,key,enc){msg=this._truncateToN(new BN(msg,16)),key=this.keyFromPublic(key,enc),signature=new Signature(signature,"hex");var r=signature.r,s=signature.s;if(r.cmpn(1)<0||r.cmp(this.n)>=0)return!1;if(s.cmpn(1)<0||s.cmp(this.n)>=0)return!1;var sinv=s.invm(this.n),u1=sinv.mul(msg).umod(this.n),u2=sinv.mul(r).umod(this.n);if(!this.curve._maxwellTrick){var p=this.g.mulAdd(u1,key.getPublic(),u2);return!p.isInfinity()&&0===p.getX().umod(this.n).cmp(r)}var p=this.g.jmulAdd(u1,key.getPublic(),u2);return!p.isInfinity()&&p.eqXToP(r)},EC.prototype.recoverPubKey=function(msg,signature,j,enc){assert((3&j)===j,"The recovery param is more than two bits"),signature=new Signature(signature,enc);var n=this.n,e=new BN(msg),r=signature.r,s=signature.s,isYOdd=1&j,isSecondKey=j>>1;if(r.cmp(this.curve.p.umod(this.curve.n))>=0&&isSecondKey)throw new Error("Unable to find sencond key candinate");r=isSecondKey?this.curve.pointFromX(r.add(this.curve.n),isYOdd):this.curve.pointFromX(r,isYOdd);var rInv=signature.r.invm(n),s1=n.sub(e).mul(rInv).umod(n),s2=s.mul(rInv).umod(n);return this.g.mulAdd(s1,r,s2)},EC.prototype.getKeyRecoveryParam=function(e,signature,Q,enc){if(signature=new Signature(signature,enc),null!==signature.recoveryParam)return signature.recoveryParam;for(var i=0;i<4;i++){var Qprime;try{Qprime=this.recoverPubKey(e,signature,i)}catch(e){continue}if(Qprime.eq(Q))return i}throw new Error("Unable to find valid recovery factor")}},{"../../elliptic":199,"./key":207,"./signature":208,"bn.js":117,"hmac-drbg":230}],207:[function(require,module,exports){"use strict";function KeyPair(ec,options){this.ec=ec,this.priv=null,this.pub=null,options.priv&&this._importPrivate(options.priv,options.privEnc),options.pub&&this._importPublic(options.pub,options.pubEnc)}var BN=require("bn.js"),elliptic=require("../../elliptic"),utils=elliptic.utils,assert=utils.assert;module.exports=KeyPair,KeyPair.fromPublic=function(ec,pub,enc){return pub instanceof KeyPair?pub:new KeyPair(ec,{pub:pub,pubEnc:enc})},KeyPair.fromPrivate=function(ec,priv,enc){return priv instanceof KeyPair?priv:new KeyPair(ec,{priv:priv,privEnc:enc})},KeyPair.prototype.validate=function(){var pub=this.getPublic();return pub.isInfinity()?{result:!1,reason:"Invalid public key"}:pub.validate()?pub.mul(this.ec.curve.n).isInfinity()?{result:!0,reason:null}:{result:!1,reason:"Public key * N != O"}:{result:!1,reason:"Public key is not a point"}},KeyPair.prototype.getPublic=function(compact,enc){return"string"==typeof compact&&(enc=compact,compact=null),this.pub||(this.pub=this.ec.g.mul(this.priv)),enc?this.pub.encode(enc,compact):this.pub},KeyPair.prototype.getPrivate=function(enc){return"hex"===enc?this.priv.toString(16,2):this.priv},KeyPair.prototype._importPrivate=function(key,enc){this.priv=new BN(key,enc||16),this.priv=this.priv.umod(this.ec.curve.n)},KeyPair.prototype._importPublic=function(key,enc){return key.x||key.y?("mont"===this.ec.curve.type?assert(key.x,"Need x coordinate"):"short"!==this.ec.curve.type&&"edwards"!==this.ec.curve.type||assert(key.x&&key.y,"Need both x and y coordinate"),void(this.pub=this.ec.curve.point(key.x,key.y))):void(this.pub=this.ec.curve.decodePoint(key,enc))},KeyPair.prototype.derive=function(pub){return pub.mul(this.priv).getX()},KeyPair.prototype.sign=function(msg,enc,options){return this.ec.sign(msg,this,enc,options)},KeyPair.prototype.verify=function(msg,signature){return this.ec.verify(msg,signature,this)},KeyPair.prototype.inspect=function(){return"<Key priv: "+(this.priv&&this.priv.toString(16,2))+" pub: "+(this.pub&&this.pub.inspect())+" >"}},{"../../elliptic":199,"bn.js":117}],208:[function(require,module,exports){"use strict";function Signature(options,enc){return options instanceof Signature?options:void(this._importDER(options,enc)||(assert(options.r&&options.s,"Signature without r or s"),this.r=new BN(options.r,16),this.s=new BN(options.s,16),void 0===options.recoveryParam?this.recoveryParam=null:this.recoveryParam=options.recoveryParam))}function Position(){this.place=0}function getLength(buf,p){var initial=buf[p.place++];if(!(128&initial))return initial;for(var octetLen=15&initial,val=0,i=0,off=p.place;i<octetLen;i++,off++)val<<=8,val|=buf[off];return p.place=off,val}function rmPadding(buf){for(var i=0,len=buf.length-1;!buf[i]&&!(128&buf[i+1])&&i<len;)i++;return 0===i?buf:buf.slice(i)}function constructLength(arr,len){if(len<128)return void arr.push(len);var octets=1+(Math.log(len)/Math.LN2>>>3);for(arr.push(128|octets);--octets;)arr.push(len>>>(octets<<3)&255);arr.push(len)}var BN=require("bn.js"),elliptic=require("../../elliptic"),utils=elliptic.utils,assert=utils.assert;module.exports=Signature,Signature.prototype._importDER=function(data,enc){data=utils.toArray(data,enc);var p=new Position;if(48!==data[p.place++])return!1;var len=getLength(data,p);if(len+p.place!==data.length)return!1;if(2!==data[p.place++])return!1;var rlen=getLength(data,p),r=data.slice(p.place,rlen+p.place);if(p.place+=rlen,2!==data[p.place++])return!1;var slen=getLength(data,p);if(data.length!==slen+p.place)return!1;var s=data.slice(p.place,slen+p.place);return 0===r[0]&&128&r[1]&&(r=r.slice(1)),0===s[0]&&128&s[1]&&(s=s.slice(1)),this.r=new BN(r),this.s=new BN(s),this.recoveryParam=null,!0},Signature.prototype.toDER=function(enc){var r=this.r.toArray(),s=this.s.toArray();for(128&r[0]&&(r=[0].concat(r)),128&s[0]&&(s=[0].concat(s)),r=rmPadding(r),s=rmPadding(s);!(s[0]||128&s[1]);)s=s.slice(1);var arr=[2];constructLength(arr,r.length),arr=arr.concat(r),arr.push(2),constructLength(arr,s.length);var backHalf=arr.concat(s),res=[48];return constructLength(res,backHalf.length),res=res.concat(backHalf),utils.encode(res,enc)}},{"../../elliptic":199,"bn.js":117}],209:[function(require,module,exports){"use strict";function EDDSA(curve){if(assert("ed25519"===curve,"only tested with ed25519 so far"),!(this instanceof EDDSA))return new EDDSA(curve);var curve=elliptic.curves[curve].curve;this.curve=curve,this.g=curve.g,this.g.precompute(curve.n.bitLength()+1),this.pointClass=curve.point().constructor,this.encodingLength=Math.ceil(curve.n.bitLength()/8),this.hash=hash.sha512}var hash=require("hash.js"),elliptic=require("../../elliptic"),utils=elliptic.utils,assert=utils.assert,parseBytes=utils.parseBytes,KeyPair=require("./key"),Signature=require("./signature");module.exports=EDDSA,EDDSA.prototype.sign=function(message,secret){message=parseBytes(message);var key=this.keyFromSecret(secret),r=this.hashInt(key.messagePrefix(),message),R=this.g.mul(r),Rencoded=this.encodePoint(R),s_=this.hashInt(Rencoded,key.pubBytes(),message).mul(key.priv()),S=r.add(s_).umod(this.curve.n);return this.makeSignature({R:R,S:S,Rencoded:Rencoded})},EDDSA.prototype.verify=function(message,sig,pub){message=parseBytes(message),sig=this.makeSignature(sig);var key=this.keyFromPublic(pub),h=this.hashInt(sig.Rencoded(),key.pubBytes(),message),SG=this.g.mul(sig.S()),RplusAh=sig.R().add(key.pub().mul(h));return RplusAh.eq(SG)},EDDSA.prototype.hashInt=function(){for(var hash=this.hash(),i=0;i<arguments.length;i++)hash.update(arguments[i]);return utils.intFromLE(hash.digest()).umod(this.curve.n)},EDDSA.prototype.keyFromPublic=function(pub){return KeyPair.fromPublic(this,pub)},EDDSA.prototype.keyFromSecret=function(secret){return KeyPair.fromSecret(this,secret)},EDDSA.prototype.makeSignature=function(sig){return sig instanceof Signature?sig:new Signature(this,sig)},EDDSA.prototype.encodePoint=function(point){var enc=point.getY().toArray("le",this.encodingLength);return enc[this.encodingLength-1]|=point.getX().isOdd()?128:0,enc},EDDSA.prototype.decodePoint=function(bytes){bytes=utils.parseBytes(bytes);var lastIx=bytes.length-1,normed=bytes.slice(0,lastIx).concat(bytes[lastIx]&-129),xIsOdd=0!==(128&bytes[lastIx]),y=utils.intFromLE(normed);return this.curve.pointFromY(y,xIsOdd)},EDDSA.prototype.encodeInt=function(num){return num.toArray("le",this.encodingLength)},EDDSA.prototype.decodeInt=function(bytes){return utils.intFromLE(bytes)},EDDSA.prototype.isPoint=function(val){return val instanceof this.pointClass}},{"../../elliptic":199,"./key":210,"./signature":211,"hash.js":218}],210:[function(require,module,exports){"use strict";function KeyPair(eddsa,params){this.eddsa=eddsa,this._secret=parseBytes(params.secret),eddsa.isPoint(params.pub)?this._pub=params.pub:this._pubBytes=parseBytes(params.pub)}var elliptic=require("../../elliptic"),utils=elliptic.utils,assert=utils.assert,parseBytes=utils.parseBytes,cachedProperty=utils.cachedProperty;KeyPair.fromPublic=function(eddsa,pub){return pub instanceof KeyPair?pub:new KeyPair(eddsa,{pub:pub})},KeyPair.fromSecret=function(eddsa,secret){return secret instanceof KeyPair?secret:new KeyPair(eddsa,{secret:secret})},KeyPair.prototype.secret=function(){return this._secret},cachedProperty(KeyPair,"pubBytes",function(){return this.eddsa.encodePoint(this.pub())}),cachedProperty(KeyPair,"pub",function(){return this._pubBytes?this.eddsa.decodePoint(this._pubBytes):this.eddsa.g.mul(this.priv())}),cachedProperty(KeyPair,"privBytes",function(){var eddsa=this.eddsa,hash=this.hash(),lastIx=eddsa.encodingLength-1,a=hash.slice(0,eddsa.encodingLength);return a[0]&=248,a[lastIx]&=127,a[lastIx]|=64,a}),cachedProperty(KeyPair,"priv",function(){return this.eddsa.decodeInt(this.privBytes())}),cachedProperty(KeyPair,"hash",function(){return this.eddsa.hash().update(this.secret()).digest()}),cachedProperty(KeyPair,"messagePrefix",function(){return this.hash().slice(this.eddsa.encodingLength)}),KeyPair.prototype.sign=function(message){return assert(this._secret,"KeyPair can only verify"),this.eddsa.sign(message,this)},KeyPair.prototype.verify=function(message,sig){return this.eddsa.verify(message,sig,this)},KeyPair.prototype.getSecret=function(enc){return assert(this._secret,"KeyPair is public only"),utils.encode(this.secret(),enc)},KeyPair.prototype.getPublic=function(enc){return utils.encode(this.pubBytes(),enc)},module.exports=KeyPair},{"../../elliptic":199}],211:[function(require,module,exports){"use strict";function Signature(eddsa,sig){this.eddsa=eddsa,"object"!=typeof sig&&(sig=parseBytes(sig)),Array.isArray(sig)&&(sig={R:sig.slice(0,eddsa.encodingLength),S:sig.slice(eddsa.encodingLength)}),assert(sig.R&&sig.S,"Signature without R or S"),eddsa.isPoint(sig.R)&&(this._R=sig.R),sig.S instanceof BN&&(this._S=sig.S),this._Rencoded=Array.isArray(sig.R)?sig.R:sig.Rencoded,this._Sencoded=Array.isArray(sig.S)?sig.S:sig.Sencoded}var BN=require("bn.js"),elliptic=require("../../elliptic"),utils=elliptic.utils,assert=utils.assert,cachedProperty=utils.cachedProperty,parseBytes=utils.parseBytes;cachedProperty(Signature,"S",function(){return this.eddsa.decodeInt(this.Sencoded())}),cachedProperty(Signature,"R",function(){return this.eddsa.decodePoint(this.Rencoded())}),cachedProperty(Signature,"Rencoded",function(){return this.eddsa.encodePoint(this.R())}),cachedProperty(Signature,"Sencoded",function(){return this.eddsa.encodeInt(this.S())}),Signature.prototype.toBytes=function(){return this.Rencoded().concat(this.Sencoded())},Signature.prototype.toHex=function(){return utils.encode(this.toBytes(),"hex").toUpperCase()},module.exports=Signature},{"../../elliptic":199,"bn.js":117}],212:[function(require,module,exports){arguments[4][94][0].apply(exports,arguments)},{dup:94}],213:[function(require,module,exports){"use strict";function getNAF(num,w){for(var naf=[],ws=1<<w+1,k=num.clone();k.cmpn(1)>=0;){var z;if(k.isOdd()){var mod=k.andln(ws-1);z=mod>(ws>>1)-1?(ws>>1)-mod:mod,k.isubn(z)}else z=0;naf.push(z);for(var shift=0!==k.cmpn(0)&&0===k.andln(ws-1)?w+1:1,i=1;i<shift;i++)naf.push(0);k.iushrn(shift)}return naf}function getJSF(k1,k2){var jsf=[[],[]];k1=k1.clone(),k2=k2.clone();for(var d1=0,d2=0;k1.cmpn(-d1)>0||k2.cmpn(-d2)>0;){var m14=k1.andln(3)+d1&3,m24=k2.andln(3)+d2&3;3===m14&&(m14=-1),3===m24&&(m24=-1);var u1;if(0===(1&m14))u1=0;else{var m8=k1.andln(7)+d1&7;u1=3!==m8&&5!==m8||2!==m24?m14:-m14}jsf[0].push(u1);var u2;if(0===(1&m24))u2=0;else{var m8=k2.andln(7)+d2&7;u2=3!==m8&&5!==m8||2!==m14?m24:-m24}jsf[1].push(u2),2*d1===u1+1&&(d1=1-d1),2*d2===u2+1&&(d2=1-d2),k1.iushrn(1),k2.iushrn(1)}return jsf}function cachedProperty(obj,name,computer){var key="_"+name;obj.prototype[name]=function(){return void 0!==this[key]?this[key]:this[key]=computer.call(this)}}function parseBytes(bytes){return"string"==typeof bytes?utils.toArray(bytes,"hex"):bytes}function intFromLE(bytes){return new BN(bytes,"hex","le")}var utils=exports,BN=require("bn.js"),minAssert=require("minimalistic-assert"),minUtils=require("minimalistic-crypto-utils");utils.assert=minAssert,utils.toArray=minUtils.toArray,utils.zero2=minUtils.zero2,utils.toHex=minUtils.toHex,utils.encode=minUtils.encode,utils.getNAF=getNAF,utils.getJSF=getJSF,utils.cachedProperty=cachedProperty,utils.parseBytes=parseBytes,utils.intFromLE=intFromLE},{"bn.js":117,"minimalistic-assert":274,"minimalistic-crypto-utils":275}],214:[function(require,module,exports){module.exports={_args:[["elliptic@^6.0.0","/home/zhangchongyang/code/hdWallet/trustnote-wallet/node_modules/browserify-sign"]],_from:"elliptic@>=6.0.0 <7.0.0",_id:"elliptic@6.4.0",_inCache:!0,_installable:!0,_location:"/elliptic",_nodeVersion:"7.0.0",_npmOperationalInternal:{host:"packages-18-east.internal.npmjs.com",tmp:"tmp/elliptic-6.4.0.tgz_1487798866428_0.30510620190761983"},_npmUser:{email:"fedor@indutny.com",name:"indutny"},_npmVersion:"3.10.8",_phantomChildren:{},_requested:{name:"elliptic",raw:"elliptic@^6.0.0",rawSpec:"^6.0.0",scope:null,spec:">=6.0.0 <7.0.0",type:"range"},_requiredBy:["/browserify-sign","/create-ecdh","/secp256k1"],_resolved:"https://registry.npmjs.org/elliptic/-/elliptic-6.4.0.tgz",_shasum:"cac9af8762c85836187003c8dfe193e5e2eae5df",_shrinkwrap:null,_spec:"elliptic@^6.0.0",_where:"/home/zhangchongyang/code/hdWallet/trustnote-wallet/node_modules/browserify-sign",author:{email:"fedor@indutny.com",name:"Fedor Indutny"},bugs:{url:"https://github.com/indutny/elliptic/issues"},dependencies:{"bn.js":"^4.4.0",brorand:"^1.0.1","hash.js":"^1.0.0","hmac-drbg":"^1.0.0",inherits:"^2.0.1","minimalistic-assert":"^1.0.0","minimalistic-crypto-utils":"^1.0.0"},description:"EC cryptography",devDependencies:{brfs:"^1.4.3",coveralls:"^2.11.3",grunt:"^0.4.5","grunt-browserify":"^5.0.0","grunt-cli":"^1.2.0","grunt-contrib-connect":"^1.0.0","grunt-contrib-copy":"^1.0.0","grunt-contrib-uglify":"^1.0.1","grunt-mocha-istanbul":"^3.0.1","grunt-saucelabs":"^8.6.2",istanbul:"^0.4.2",jscs:"^2.9.0",jshint:"^2.6.0",mocha:"^2.1.0"},directories:{},dist:{shasum:"cac9af8762c85836187003c8dfe193e5e2eae5df",tarball:"https://registry.npmjs.org/elliptic/-/elliptic-6.4.0.tgz"},files:["lib"],gitHead:"6b0d2b76caae91471649c8e21f0b1d3ba0f96090",homepage:"https://github.com/indutny/elliptic",keywords:["EC","Elliptic","curve","Cryptography"],license:"MIT",main:"lib/elliptic.js",maintainers:[{email:"fedor@indutny.com",name:"indutny"}],name:"elliptic",optionalDependencies:{},readme:"ERROR: No README data found!",repository:{type:"git",url:"git+ssh://git@github.com/indutny/elliptic.git"},scripts:{jscs:"jscs benchmarks/*.js lib/*.js lib/**/*.js lib/**/**/*.js test/index.js",jshint:"jscs benchmarks/*.js lib/*.js lib/**/*.js lib/**/**/*.js test/index.js",lint:"npm run jscs && npm run jshint",test:"npm run lint && npm run unit",unit:"istanbul test _mocha --reporter=spec test/index.js",version:"grunt dist && git add dist/"},version:"6.4.0"}},{}],215:[function(require,module,exports){function EventEmitter(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=objectCreate(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}function $getMaxListeners(that){return void 0===that._maxListeners?EventEmitter.defaultMaxListeners:that._maxListeners}function emitNone(handler,isFn,self){if(isFn)handler.call(self);else for(var len=handler.length,listeners=arrayClone(handler,len),i=0;i<len;++i)listeners[i].call(self)}function emitOne(handler,isFn,self,arg1){if(isFn)handler.call(self,arg1);else for(var len=handler.length,listeners=arrayClone(handler,len),i=0;i<len;++i)listeners[i].call(self,arg1)}function emitTwo(handler,isFn,self,arg1,arg2){if(isFn)handler.call(self,arg1,arg2);else for(var len=handler.length,listeners=arrayClone(handler,len),i=0;i<len;++i)listeners[i].call(self,arg1,arg2)}function emitThree(handler,isFn,self,arg1,arg2,arg3){if(isFn)handler.call(self,arg1,arg2,arg3);else for(var len=handler.length,listeners=arrayClone(handler,len),i=0;i<len;++i)listeners[i].call(self,arg1,arg2,arg3)}function emitMany(handler,isFn,self,args){if(isFn)handler.apply(self,args);else for(var len=handler.length,listeners=arrayClone(handler,len),i=0;i<len;++i)listeners[i].apply(self,args)}function _addListener(target,type,listener,prepend){var m,events,existing;if("function"!=typeof listener)throw new TypeError('"listener" argument must be a function');if(events=target._events,events?(events.newListener&&(target.emit("newListener",type,listener.listener?listener.listener:listener),events=target._events),existing=events[type]):(events=target._events=objectCreate(null),target._eventsCount=0),existing){if("function"==typeof existing?existing=events[type]=prepend?[listener,existing]:[existing,listener]:prepend?existing.unshift(listener):existing.push(listener),!existing.warned&&(m=$getMaxListeners(target),m&&m>0&&existing.length>m)){existing.warned=!0;var w=new Error("Possible EventEmitter memory leak detected. "+existing.length+' "'+String(type)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');w.name="MaxListenersExceededWarning",w.emitter=target,w.type=type,w.count=existing.length,"object"==typeof console&&console.warn&&console.warn("%s: %s",w.name,w.message)}}else existing=events[type]=listener,++target._eventsCount;return target}function onceWrapper(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var args=new Array(arguments.length),i=0;i<args.length;++i)args[i]=arguments[i];this.listener.apply(this.target,args)}}function _onceWrap(target,type,listener){var state={fired:!1,wrapFn:void 0,target:target,type:type,listener:listener},wrapped=bind.call(onceWrapper,state);return wrapped.listener=listener,state.wrapFn=wrapped,wrapped}function listenerCount(type){var events=this._events;if(events){var evlistener=events[type];if("function"==typeof evlistener)return 1;if(evlistener)return evlistener.length}return 0}function spliceOne(list,index){for(var i=index,k=i+1,n=list.length;k<n;i+=1,k+=1)list[i]=list[k];list.pop()}function arrayClone(arr,n){for(var copy=new Array(n),i=0;i<n;++i)copy[i]=arr[i];return copy}function unwrapListeners(arr){for(var ret=new Array(arr.length),i=0;i<ret.length;++i)ret[i]=arr[i].listener||arr[i];return ret}function objectCreatePolyfill(proto){var F=function(){};return F.prototype=proto,new F}function objectKeysPolyfill(obj){var keys=[];for(var k in obj)Object.prototype.hasOwnProperty.call(obj,k)&&keys.push(k);return k}function functionBindPolyfill(context){var fn=this;return function(){return fn.apply(context,arguments)}}var objectCreate=Object.create||objectCreatePolyfill,objectKeys=Object.keys||objectKeysPolyfill,bind=Function.prototype.bind||functionBindPolyfill;module.exports=EventEmitter,EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._maxListeners=void 0;var hasDefineProperty,defaultMaxListeners=10;try{var o={};Object.defineProperty&&Object.defineProperty(o,"x",{value:0}),hasDefineProperty=0===o.x}catch(err){hasDefineProperty=!1}hasDefineProperty?Object.defineProperty(EventEmitter,"defaultMaxListeners",{enumerable:!0,get:function(){return defaultMaxListeners},set:function(arg){if("number"!=typeof arg||arg<0||arg!==arg)throw new TypeError('"defaultMaxListeners" must be a positive number');defaultMaxListeners=arg}}):EventEmitter.defaultMaxListeners=defaultMaxListeners,EventEmitter.prototype.setMaxListeners=function(n){if("number"!=typeof n||n<0||isNaN(n))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=n,this},EventEmitter.prototype.getMaxListeners=function(){return $getMaxListeners(this)},EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,events,doError="error"===type;if(events=this._events)doError=doError&&null==events.error;else if(!doError)return!1;if(doError){if(arguments.length>1&&(er=arguments[1]),
er instanceof Error)throw er;var err=new Error('Unhandled "error" event. ('+er+")");throw err.context=er,err}if(handler=events[type],!handler)return!1;var isFn="function"==typeof handler;switch(len=arguments.length){case 1:emitNone(handler,isFn,this);break;case 2:emitOne(handler,isFn,this,arguments[1]);break;case 3:emitTwo(handler,isFn,this,arguments[1],arguments[2]);break;case 4:emitThree(handler,isFn,this,arguments[1],arguments[2],arguments[3]);break;default:for(args=new Array(len-1),i=1;i<len;i++)args[i-1]=arguments[i];emitMany(handler,isFn,this,args)}return!0},EventEmitter.prototype.addListener=function(type,listener){return _addListener(this,type,listener,!1)},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.prependListener=function(type,listener){return _addListener(this,type,listener,!0)},EventEmitter.prototype.once=function(type,listener){if("function"!=typeof listener)throw new TypeError('"listener" argument must be a function');return this.on(type,_onceWrap(this,type,listener)),this},EventEmitter.prototype.prependOnceListener=function(type,listener){if("function"!=typeof listener)throw new TypeError('"listener" argument must be a function');return this.prependListener(type,_onceWrap(this,type,listener)),this},EventEmitter.prototype.removeListener=function(type,listener){var list,events,position,i,originalListener;if("function"!=typeof listener)throw new TypeError('"listener" argument must be a function');if(events=this._events,!events)return this;if(list=events[type],!list)return this;if(list===listener||list.listener===listener)0===--this._eventsCount?this._events=objectCreate(null):(delete events[type],events.removeListener&&this.emit("removeListener",type,list.listener||listener));else if("function"!=typeof list){for(position=-1,i=list.length-1;i>=0;i--)if(list[i]===listener||list[i].listener===listener){originalListener=list[i].listener,position=i;break}if(position<0)return this;0===position?list.shift():spliceOne(list,position),1===list.length&&(events[type]=list[0]),events.removeListener&&this.emit("removeListener",type,originalListener||listener)}return this},EventEmitter.prototype.removeAllListeners=function(type){var listeners,events,i;if(events=this._events,!events)return this;if(!events.removeListener)return 0===arguments.length?(this._events=objectCreate(null),this._eventsCount=0):events[type]&&(0===--this._eventsCount?this._events=objectCreate(null):delete events[type]),this;if(0===arguments.length){var key,keys=objectKeys(events);for(i=0;i<keys.length;++i)key=keys[i],"removeListener"!==key&&this.removeAllListeners(key);return this.removeAllListeners("removeListener"),this._events=objectCreate(null),this._eventsCount=0,this}if(listeners=events[type],"function"==typeof listeners)this.removeListener(type,listeners);else if(listeners)for(i=listeners.length-1;i>=0;i--)this.removeListener(type,listeners[i]);return this},EventEmitter.prototype.listeners=function(type){var evlistener,ret,events=this._events;return events?(evlistener=events[type],ret=evlistener?"function"==typeof evlistener?[evlistener.listener||evlistener]:unwrapListeners(evlistener):[]):ret=[],ret},EventEmitter.listenerCount=function(emitter,type){return"function"==typeof emitter.listenerCount?emitter.listenerCount(type):listenerCount.call(emitter,type)},EventEmitter.prototype.listenerCount=listenerCount,EventEmitter.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]}},{}],216:[function(require,module,exports){function EVP_BytesToKey(password,salt,keyBits,ivLen){if(Buffer.isBuffer(password)||(password=Buffer.from(password,"binary")),salt&&(Buffer.isBuffer(salt)||(salt=Buffer.from(salt,"binary")),8!==salt.length))throw new RangeError("salt should be Buffer with 8 byte length");for(var keyLen=keyBits/8,key=Buffer.alloc(keyLen),iv=Buffer.alloc(ivLen||0),tmp=Buffer.alloc(0);keyLen>0||ivLen>0;){var hash=new MD5;hash.update(tmp),hash.update(password),salt&&hash.update(salt),tmp=hash.digest();var used=0;if(keyLen>0){var keyStart=key.length-keyLen;used=Math.min(keyLen,tmp.length),tmp.copy(key,keyStart,0,used),keyLen-=used}if(used<tmp.length&&ivLen>0){var ivStart=iv.length-ivLen,length=Math.min(ivLen,tmp.length-used);tmp.copy(iv,ivStart,used,used+length),ivLen-=length}}return tmp.fill(0),{key:key,iv:iv}}var Buffer=require("safe-buffer").Buffer,MD5=require("md5.js");module.exports=EVP_BytesToKey},{"md5.js":272,"safe-buffer":323}],217:[function(require,module,exports){"use strict";function throwIfNotStringOrBuffer(val,prefix){if(!Buffer.isBuffer(val)&&"string"!=typeof val)throw new TypeError(prefix+" must be a string or a buffer")}function HashBase(blockSize){Transform.call(this),this._block=Buffer.allocUnsafe(blockSize),this._blockSize=blockSize,this._blockOffset=0,this._length=[0,0,0,0],this._finalized=!1}var Buffer=require("safe-buffer").Buffer,Transform=require("stream").Transform,inherits=require("inherits");inherits(HashBase,Transform),HashBase.prototype._transform=function(chunk,encoding,callback){var error=null;try{this.update(chunk,encoding)}catch(err){error=err}callback(error)},HashBase.prototype._flush=function(callback){var error=null;try{this.push(this.digest())}catch(err){error=err}callback(error)},HashBase.prototype.update=function(data,encoding){if(throwIfNotStringOrBuffer(data,"Data"),this._finalized)throw new Error("Digest already called");Buffer.isBuffer(data)||(data=Buffer.from(data,encoding));for(var block=this._block,offset=0;this._blockOffset+data.length-offset>=this._blockSize;){for(var i=this._blockOffset;i<this._blockSize;)block[i++]=data[offset++];this._update(),this._blockOffset=0}for(;offset<data.length;)block[this._blockOffset++]=data[offset++];for(var j=0,carry=8*data.length;carry>0;++j)this._length[j]+=carry,carry=this._length[j]/4294967296|0,carry>0&&(this._length[j]-=4294967296*carry);return this},HashBase.prototype._update=function(){throw new Error("_update is not implemented")},HashBase.prototype.digest=function(encoding){if(this._finalized)throw new Error("Digest already called");this._finalized=!0;var digest=this._digest();void 0!==encoding&&(digest=digest.toString(encoding)),this._block.fill(0),this._blockOffset=0;for(var i=0;i<4;++i)this._length[i]=0;return digest},HashBase.prototype._digest=function(){throw new Error("_digest is not implemented")},module.exports=HashBase},{inherits:233,"safe-buffer":323,stream:345}],218:[function(require,module,exports){arguments[4][97][0].apply(exports,arguments)},{"./hash/common":219,"./hash/hmac":220,"./hash/ripemd":221,"./hash/sha":222,"./hash/utils":229,dup:97}],219:[function(require,module,exports){"use strict";function BlockHash(){this.pending=null,this.pendingTotal=0,this.blockSize=this.constructor.blockSize,this.outSize=this.constructor.outSize,this.hmacStrength=this.constructor.hmacStrength,this.padLength=this.constructor.padLength/8,this.endian="big",this._delta8=this.blockSize/8,this._delta32=this.blockSize/32}var utils=require("./utils"),assert=require("minimalistic-assert");exports.BlockHash=BlockHash,BlockHash.prototype.update=function(msg,enc){if(msg=utils.toArray(msg,enc),this.pending?this.pending=this.pending.concat(msg):this.pending=msg,this.pendingTotal+=msg.length,this.pending.length>=this._delta8){msg=this.pending;var r=msg.length%this._delta8;this.pending=msg.slice(msg.length-r,msg.length),0===this.pending.length&&(this.pending=null),msg=utils.join32(msg,0,msg.length-r,this.endian);for(var i=0;i<msg.length;i+=this._delta32)this._update(msg,i,i+this._delta32)}return this},BlockHash.prototype.digest=function(enc){return this.update(this._pad()),assert(null===this.pending),this._digest(enc)},BlockHash.prototype._pad=function(){var len=this.pendingTotal,bytes=this._delta8,k=bytes-(len+this.padLength)%bytes,res=new Array(k+this.padLength);res[0]=128;for(var i=1;i<k;i++)res[i]=0;if(len<<=3,"big"===this.endian){for(var t=8;t<this.padLength;t++)res[i++]=0;res[i++]=0,res[i++]=0,res[i++]=0,res[i++]=0,res[i++]=len>>>24&255,res[i++]=len>>>16&255,res[i++]=len>>>8&255,res[i++]=255&len}else for(res[i++]=255&len,res[i++]=len>>>8&255,res[i++]=len>>>16&255,res[i++]=len>>>24&255,res[i++]=0,res[i++]=0,res[i++]=0,res[i++]=0,t=8;t<this.padLength;t++)res[i++]=0;return res}},{"./utils":229,"minimalistic-assert":274}],220:[function(require,module,exports){"use strict";function Hmac(hash,key,enc){return this instanceof Hmac?(this.Hash=hash,this.blockSize=hash.blockSize/8,this.outSize=hash.outSize/8,this.inner=null,this.outer=null,void this._init(utils.toArray(key,enc))):new Hmac(hash,key,enc)}var utils=require("./utils"),assert=require("minimalistic-assert");module.exports=Hmac,Hmac.prototype._init=function(key){key.length>this.blockSize&&(key=(new this.Hash).update(key).digest()),assert(key.length<=this.blockSize);for(var i=key.length;i<this.blockSize;i++)key.push(0);for(i=0;i<key.length;i++)key[i]^=54;for(this.inner=(new this.Hash).update(key),i=0;i<key.length;i++)key[i]^=106;this.outer=(new this.Hash).update(key)},Hmac.prototype.update=function(msg,enc){return this.inner.update(msg,enc),this},Hmac.prototype.digest=function(enc){return this.outer.update(this.inner.digest()),this.outer.digest(enc)}},{"./utils":229,"minimalistic-assert":274}],221:[function(require,module,exports){"use strict";function RIPEMD160(){return this instanceof RIPEMD160?(BlockHash.call(this),this.h=[1732584193,4023233417,2562383102,271733878,3285377520],void(this.endian="little")):new RIPEMD160}function f(j,x,y,z){return j<=15?x^y^z:j<=31?x&y|~x&z:j<=47?(x|~y)^z:j<=63?x&z|y&~z:x^(y|~z)}function K(j){return j<=15?0:j<=31?1518500249:j<=47?1859775393:j<=63?2400959708:2840853838}function Kh(j){return j<=15?1352829926:j<=31?1548603684:j<=47?1836072691:j<=63?2053994217:0}var utils=require("./utils"),common=require("./common"),rotl32=utils.rotl32,sum32=utils.sum32,sum32_3=utils.sum32_3,sum32_4=utils.sum32_4,BlockHash=common.BlockHash;utils.inherits(RIPEMD160,BlockHash),exports.ripemd160=RIPEMD160,RIPEMD160.blockSize=512,RIPEMD160.outSize=160,RIPEMD160.hmacStrength=192,RIPEMD160.padLength=64,RIPEMD160.prototype._update=function(msg,start){for(var A=this.h[0],B=this.h[1],C=this.h[2],D=this.h[3],E=this.h[4],Ah=A,Bh=B,Ch=C,Dh=D,Eh=E,j=0;j<80;j++){var T=sum32(rotl32(sum32_4(A,f(j,B,C,D),msg[r[j]+start],K(j)),s[j]),E);A=E,E=D,D=rotl32(C,10),C=B,B=T,T=sum32(rotl32(sum32_4(Ah,f(79-j,Bh,Ch,Dh),msg[rh[j]+start],Kh(j)),sh[j]),Eh),Ah=Eh,Eh=Dh,Dh=rotl32(Ch,10),Ch=Bh,Bh=T}T=sum32_3(this.h[1],C,Dh),this.h[1]=sum32_3(this.h[2],D,Eh),this.h[2]=sum32_3(this.h[3],E,Ah),this.h[3]=sum32_3(this.h[4],A,Bh),this.h[4]=sum32_3(this.h[0],B,Ch),this.h[0]=T},RIPEMD160.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h,"little"):utils.split32(this.h,"little")};var r=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13],rh=[5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11],s=[11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6],sh=[8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]},{"./common":219,"./utils":229}],222:[function(require,module,exports){"use strict";exports.sha1=require("./sha/1"),exports.sha224=require("./sha/224"),exports.sha256=require("./sha/256"),exports.sha384=require("./sha/384"),exports.sha512=require("./sha/512")},{"./sha/1":223,"./sha/224":224,"./sha/256":225,"./sha/384":226,"./sha/512":227}],223:[function(require,module,exports){"use strict";function SHA1(){return this instanceof SHA1?(BlockHash.call(this),this.h=[1732584193,4023233417,2562383102,271733878,3285377520],void(this.W=new Array(80))):new SHA1}var utils=require("../utils"),common=require("../common"),shaCommon=require("./common"),rotl32=utils.rotl32,sum32=utils.sum32,sum32_5=utils.sum32_5,ft_1=shaCommon.ft_1,BlockHash=common.BlockHash,sha1_K=[1518500249,1859775393,2400959708,3395469782];utils.inherits(SHA1,BlockHash),module.exports=SHA1,SHA1.blockSize=512,SHA1.outSize=160,SHA1.hmacStrength=80,SHA1.padLength=64,SHA1.prototype._update=function(msg,start){for(var W=this.W,i=0;i<16;i++)W[i]=msg[start+i];for(;i<W.length;i++)W[i]=rotl32(W[i-3]^W[i-8]^W[i-14]^W[i-16],1);var a=this.h[0],b=this.h[1],c=this.h[2],d=this.h[3],e=this.h[4];for(i=0;i<W.length;i++){var s=~~(i/20),t=sum32_5(rotl32(a,5),ft_1(s,b,c,d),e,W[i],sha1_K[s]);e=d,d=c,c=rotl32(b,30),b=a,a=t}this.h[0]=sum32(this.h[0],a),this.h[1]=sum32(this.h[1],b),this.h[2]=sum32(this.h[2],c),this.h[3]=sum32(this.h[3],d),this.h[4]=sum32(this.h[4],e)},SHA1.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h,"big"):utils.split32(this.h,"big")}},{"../common":219,"../utils":229,"./common":228}],224:[function(require,module,exports){"use strict";function SHA224(){return this instanceof SHA224?(SHA256.call(this),void(this.h=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428])):new SHA224}var utils=require("../utils"),SHA256=require("./256");utils.inherits(SHA224,SHA256),module.exports=SHA224,SHA224.blockSize=512,SHA224.outSize=224,SHA224.hmacStrength=192,SHA224.padLength=64,SHA224.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h.slice(0,7),"big"):utils.split32(this.h.slice(0,7),"big")}},{"../utils":229,"./256":225}],225:[function(require,module,exports){"use strict";function SHA256(){return this instanceof SHA256?(BlockHash.call(this),this.h=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],this.k=sha256_K,void(this.W=new Array(64))):new SHA256}var utils=require("../utils"),common=require("../common"),shaCommon=require("./common"),assert=require("minimalistic-assert"),sum32=utils.sum32,sum32_4=utils.sum32_4,sum32_5=utils.sum32_5,ch32=shaCommon.ch32,maj32=shaCommon.maj32,s0_256=shaCommon.s0_256,s1_256=shaCommon.s1_256,g0_256=shaCommon.g0_256,g1_256=shaCommon.g1_256,BlockHash=common.BlockHash,sha256_K=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];utils.inherits(SHA256,BlockHash),module.exports=SHA256,SHA256.blockSize=512,SHA256.outSize=256,SHA256.hmacStrength=192,SHA256.padLength=64,SHA256.prototype._update=function(msg,start){for(var W=this.W,i=0;i<16;i++)W[i]=msg[start+i];for(;i<W.length;i++)W[i]=sum32_4(g1_256(W[i-2]),W[i-7],g0_256(W[i-15]),W[i-16]);var a=this.h[0],b=this.h[1],c=this.h[2],d=this.h[3],e=this.h[4],f=this.h[5],g=this.h[6],h=this.h[7];for(assert(this.k.length===W.length),i=0;i<W.length;i++){var T1=sum32_5(h,s1_256(e),ch32(e,f,g),this.k[i],W[i]),T2=sum32(s0_256(a),maj32(a,b,c));h=g,g=f,f=e,e=sum32(d,T1),d=c,c=b,b=a,a=sum32(T1,T2)}this.h[0]=sum32(this.h[0],a),this.h[1]=sum32(this.h[1],b),this.h[2]=sum32(this.h[2],c),this.h[3]=sum32(this.h[3],d),this.h[4]=sum32(this.h[4],e),this.h[5]=sum32(this.h[5],f),this.h[6]=sum32(this.h[6],g),this.h[7]=sum32(this.h[7],h)},SHA256.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h,"big"):utils.split32(this.h,"big")}},{"../common":219,"../utils":229,"./common":228,"minimalistic-assert":274}],226:[function(require,module,exports){"use strict";function SHA384(){return this instanceof SHA384?(SHA512.call(this),void(this.h=[3418070365,3238371032,1654270250,914150663,2438529370,812702999,355462360,4144912697,1731405415,4290775857,2394180231,1750603025,3675008525,1694076839,1203062813,3204075428])):new SHA384}var utils=require("../utils"),SHA512=require("./512");utils.inherits(SHA384,SHA512),module.exports=SHA384,SHA384.blockSize=1024,SHA384.outSize=384,SHA384.hmacStrength=192,SHA384.padLength=128,SHA384.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h.slice(0,12),"big"):utils.split32(this.h.slice(0,12),"big")}},{"../utils":229,"./512":227}],227:[function(require,module,exports){"use strict";function SHA512(){return this instanceof SHA512?(BlockHash.call(this),this.h=[1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209],this.k=sha512_K,void(this.W=new Array(160))):new SHA512}function ch64_hi(xh,xl,yh,yl,zh){var r=xh&yh^~xh&zh;return r<0&&(r+=4294967296),r}function ch64_lo(xh,xl,yh,yl,zh,zl){var r=xl&yl^~xl&zl;return r<0&&(r+=4294967296),r}function maj64_hi(xh,xl,yh,yl,zh){var r=xh&yh^xh&zh^yh&zh;return r<0&&(r+=4294967296),r}function maj64_lo(xh,xl,yh,yl,zh,zl){var r=xl&yl^xl&zl^yl&zl;return r<0&&(r+=4294967296),r}function s0_512_hi(xh,xl){var c0_hi=rotr64_hi(xh,xl,28),c1_hi=rotr64_hi(xl,xh,2),c2_hi=rotr64_hi(xl,xh,7),r=c0_hi^c1_hi^c2_hi;return r<0&&(r+=4294967296),r}function s0_512_lo(xh,xl){var c0_lo=rotr64_lo(xh,xl,28),c1_lo=rotr64_lo(xl,xh,2),c2_lo=rotr64_lo(xl,xh,7),r=c0_lo^c1_lo^c2_lo;return r<0&&(r+=4294967296),r}function s1_512_hi(xh,xl){var c0_hi=rotr64_hi(xh,xl,14),c1_hi=rotr64_hi(xh,xl,18),c2_hi=rotr64_hi(xl,xh,9),r=c0_hi^c1_hi^c2_hi;return r<0&&(r+=4294967296),r}function s1_512_lo(xh,xl){var c0_lo=rotr64_lo(xh,xl,14),c1_lo=rotr64_lo(xh,xl,18),c2_lo=rotr64_lo(xl,xh,9),r=c0_lo^c1_lo^c2_lo;return r<0&&(r+=4294967296),r}function g0_512_hi(xh,xl){var c0_hi=rotr64_hi(xh,xl,1),c1_hi=rotr64_hi(xh,xl,8),c2_hi=shr64_hi(xh,xl,7),r=c0_hi^c1_hi^c2_hi;return r<0&&(r+=4294967296),r}function g0_512_lo(xh,xl){var c0_lo=rotr64_lo(xh,xl,1),c1_lo=rotr64_lo(xh,xl,8),c2_lo=shr64_lo(xh,xl,7),r=c0_lo^c1_lo^c2_lo;return r<0&&(r+=4294967296),r}function g1_512_hi(xh,xl){var c0_hi=rotr64_hi(xh,xl,19),c1_hi=rotr64_hi(xl,xh,29),c2_hi=shr64_hi(xh,xl,6),r=c0_hi^c1_hi^c2_hi;return r<0&&(r+=4294967296),r}function g1_512_lo(xh,xl){var c0_lo=rotr64_lo(xh,xl,19),c1_lo=rotr64_lo(xl,xh,29),c2_lo=shr64_lo(xh,xl,6),r=c0_lo^c1_lo^c2_lo;return r<0&&(r+=4294967296),r}var utils=require("../utils"),common=require("../common"),assert=require("minimalistic-assert"),rotr64_hi=utils.rotr64_hi,rotr64_lo=utils.rotr64_lo,shr64_hi=utils.shr64_hi,shr64_lo=utils.shr64_lo,sum64=utils.sum64,sum64_hi=utils.sum64_hi,sum64_lo=utils.sum64_lo,sum64_4_hi=utils.sum64_4_hi,sum64_4_lo=utils.sum64_4_lo,sum64_5_hi=utils.sum64_5_hi,sum64_5_lo=utils.sum64_5_lo,BlockHash=common.BlockHash,sha512_K=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591];utils.inherits(SHA512,BlockHash),module.exports=SHA512,SHA512.blockSize=1024,SHA512.outSize=512,SHA512.hmacStrength=192,SHA512.padLength=128,SHA512.prototype._prepareBlock=function(msg,start){for(var W=this.W,i=0;i<32;i++)W[i]=msg[start+i];for(;i<W.length;i+=2){var c0_hi=g1_512_hi(W[i-4],W[i-3]),c0_lo=g1_512_lo(W[i-4],W[i-3]),c1_hi=W[i-14],c1_lo=W[i-13],c2_hi=g0_512_hi(W[i-30],W[i-29]),c2_lo=g0_512_lo(W[i-30],W[i-29]),c3_hi=W[i-32],c3_lo=W[i-31];W[i]=sum64_4_hi(c0_hi,c0_lo,c1_hi,c1_lo,c2_hi,c2_lo,c3_hi,c3_lo),W[i+1]=sum64_4_lo(c0_hi,c0_lo,c1_hi,c1_lo,c2_hi,c2_lo,c3_hi,c3_lo)}},SHA512.prototype._update=function(msg,start){this._prepareBlock(msg,start);var W=this.W,ah=this.h[0],al=this.h[1],bh=this.h[2],bl=this.h[3],ch=this.h[4],cl=this.h[5],dh=this.h[6],dl=this.h[7],eh=this.h[8],el=this.h[9],fh=this.h[10],fl=this.h[11],gh=this.h[12],gl=this.h[13],hh=this.h[14],hl=this.h[15];assert(this.k.length===W.length);for(var i=0;i<W.length;i+=2){var c0_hi=hh,c0_lo=hl,c1_hi=s1_512_hi(eh,el),c1_lo=s1_512_lo(eh,el),c2_hi=ch64_hi(eh,el,fh,fl,gh,gl),c2_lo=ch64_lo(eh,el,fh,fl,gh,gl),c3_hi=this.k[i],c3_lo=this.k[i+1],c4_hi=W[i],c4_lo=W[i+1],T1_hi=sum64_5_hi(c0_hi,c0_lo,c1_hi,c1_lo,c2_hi,c2_lo,c3_hi,c3_lo,c4_hi,c4_lo),T1_lo=sum64_5_lo(c0_hi,c0_lo,c1_hi,c1_lo,c2_hi,c2_lo,c3_hi,c3_lo,c4_hi,c4_lo);c0_hi=s0_512_hi(ah,al),c0_lo=s0_512_lo(ah,al),c1_hi=maj64_hi(ah,al,bh,bl,ch,cl),c1_lo=maj64_lo(ah,al,bh,bl,ch,cl);var T2_hi=sum64_hi(c0_hi,c0_lo,c1_hi,c1_lo),T2_lo=sum64_lo(c0_hi,c0_lo,c1_hi,c1_lo);hh=gh,hl=gl,gh=fh,gl=fl,fh=eh,fl=el,eh=sum64_hi(dh,dl,T1_hi,T1_lo),el=sum64_lo(dl,dl,T1_hi,T1_lo),dh=ch,dl=cl,ch=bh,cl=bl,bh=ah,bl=al,ah=sum64_hi(T1_hi,T1_lo,T2_hi,T2_lo),al=sum64_lo(T1_hi,T1_lo,T2_hi,T2_lo)}sum64(this.h,0,ah,al),sum64(this.h,2,bh,bl),sum64(this.h,4,ch,cl),sum64(this.h,6,dh,dl),sum64(this.h,8,eh,el),sum64(this.h,10,fh,fl),sum64(this.h,12,gh,gl),sum64(this.h,14,hh,hl)},SHA512.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h,"big"):utils.split32(this.h,"big")}},{"../common":219,"../utils":229,"minimalistic-assert":274}],228:[function(require,module,exports){"use strict";function ft_1(s,x,y,z){return 0===s?ch32(x,y,z):1===s||3===s?p32(x,y,z):2===s?maj32(x,y,z):void 0}function ch32(x,y,z){return x&y^~x&z}function maj32(x,y,z){return x&y^x&z^y&z}function p32(x,y,z){return x^y^z}function s0_256(x){return rotr32(x,2)^rotr32(x,13)^rotr32(x,22)}function s1_256(x){return rotr32(x,6)^rotr32(x,11)^rotr32(x,25)}function g0_256(x){return rotr32(x,7)^rotr32(x,18)^x>>>3}function g1_256(x){return rotr32(x,17)^rotr32(x,19)^x>>>10}var utils=require("../utils"),rotr32=utils.rotr32;exports.ft_1=ft_1,exports.ch32=ch32,exports.maj32=maj32,exports.p32=p32,exports.s0_256=s0_256,exports.s1_256=s1_256,exports.g0_256=g0_256,exports.g1_256=g1_256},{"../utils":229}],229:[function(require,module,exports){"use strict";function toArray(msg,enc){if(Array.isArray(msg))return msg.slice();if(!msg)return[];var res=[];if("string"==typeof msg)if(enc){if("hex"===enc)for(msg=msg.replace(/[^a-z0-9]+/gi,""),msg.length%2!==0&&(msg="0"+msg),i=0;i<msg.length;i+=2)res.push(parseInt(msg[i]+msg[i+1],16))}else for(var i=0;i<msg.length;i++){var c=msg.charCodeAt(i),hi=c>>8,lo=255&c;hi?res.push(hi,lo):res.push(lo)}else for(i=0;i<msg.length;i++)res[i]=0|msg[i];return res}function toHex(msg){for(var res="",i=0;i<msg.length;i++)res+=zero2(msg[i].toString(16));return res}function htonl(w){var res=w>>>24|w>>>8&65280|w<<8&16711680|(255&w)<<24;return res>>>0}function toHex32(msg,endian){for(var res="",i=0;i<msg.length;i++){var w=msg[i];"little"===endian&&(w=htonl(w)),res+=zero8(w.toString(16))}return res}function zero2(word){return 1===word.length?"0"+word:word}function zero8(word){return 7===word.length?"0"+word:6===word.length?"00"+word:5===word.length?"000"+word:4===word.length?"0000"+word:3===word.length?"00000"+word:2===word.length?"000000"+word:1===word.length?"0000000"+word:word}function join32(msg,start,end,endian){var len=end-start;assert(len%4===0);for(var res=new Array(len/4),i=0,k=start;i<res.length;i++,k+=4){var w;w="big"===endian?msg[k]<<24|msg[k+1]<<16|msg[k+2]<<8|msg[k+3]:msg[k+3]<<24|msg[k+2]<<16|msg[k+1]<<8|msg[k],res[i]=w>>>0}return res}function split32(msg,endian){for(var res=new Array(4*msg.length),i=0,k=0;i<msg.length;i++,k+=4){var m=msg[i];"big"===endian?(res[k]=m>>>24,res[k+1]=m>>>16&255,res[k+2]=m>>>8&255,res[k+3]=255&m):(res[k+3]=m>>>24,res[k+2]=m>>>16&255,res[k+1]=m>>>8&255,res[k]=255&m)}return res}function rotr32(w,b){return w>>>b|w<<32-b}function rotl32(w,b){return w<<b|w>>>32-b}function sum32(a,b){return a+b>>>0}function sum32_3(a,b,c){return a+b+c>>>0}function sum32_4(a,b,c,d){return a+b+c+d>>>0}function sum32_5(a,b,c,d,e){return a+b+c+d+e>>>0}function sum64(buf,pos,ah,al){var bh=buf[pos],bl=buf[pos+1],lo=al+bl>>>0,hi=(lo<al?1:0)+ah+bh;buf[pos]=hi>>>0,buf[pos+1]=lo}function sum64_hi(ah,al,bh,bl){var lo=al+bl>>>0,hi=(lo<al?1:0)+ah+bh;return hi>>>0}function sum64_lo(ah,al,bh,bl){var lo=al+bl;return lo>>>0}function sum64_4_hi(ah,al,bh,bl,ch,cl,dh,dl){var carry=0,lo=al;lo=lo+bl>>>0,carry+=lo<al?1:0,lo=lo+cl>>>0,carry+=lo<cl?1:0,lo=lo+dl>>>0,carry+=lo<dl?1:0;var hi=ah+bh+ch+dh+carry;return hi>>>0}function sum64_4_lo(ah,al,bh,bl,ch,cl,dh,dl){var lo=al+bl+cl+dl;return lo>>>0}function sum64_5_hi(ah,al,bh,bl,ch,cl,dh,dl,eh,el){var carry=0,lo=al;lo=lo+bl>>>0,carry+=lo<al?1:0,lo=lo+cl>>>0,carry+=lo<cl?1:0,lo=lo+dl>>>0,carry+=lo<dl?1:0,lo=lo+el>>>0,carry+=lo<el?1:0;var hi=ah+bh+ch+dh+eh+carry;return hi>>>0}function sum64_5_lo(ah,al,bh,bl,ch,cl,dh,dl,eh,el){var lo=al+bl+cl+dl+el;return lo>>>0}function rotr64_hi(ah,al,num){var r=al<<32-num|ah>>>num;return r>>>0}function rotr64_lo(ah,al,num){var r=ah<<32-num|al>>>num;return r>>>0}function shr64_hi(ah,al,num){return ah>>>num}function shr64_lo(ah,al,num){var r=ah<<32-num|al>>>num;return r>>>0}var assert=require("minimalistic-assert"),inherits=require("inherits");exports.inherits=inherits,exports.toArray=toArray,exports.toHex=toHex,exports.htonl=htonl,exports.toHex32=toHex32,exports.zero2=zero2,exports.zero8=zero8,exports.join32=join32,exports.split32=split32,exports.rotr32=rotr32,exports.rotl32=rotl32,exports.sum32=sum32,exports.sum32_3=sum32_3,exports.sum32_4=sum32_4,exports.sum32_5=sum32_5,exports.sum64=sum64,exports.sum64_hi=sum64_hi,exports.sum64_lo=sum64_lo,exports.sum64_4_hi=sum64_4_hi,exports.sum64_4_lo=sum64_4_lo,exports.sum64_5_hi=sum64_5_hi,exports.sum64_5_lo=sum64_5_lo,exports.rotr64_hi=rotr64_hi,exports.rotr64_lo=rotr64_lo,exports.shr64_hi=shr64_hi,exports.shr64_lo=shr64_lo},{inherits:233,"minimalistic-assert":274}],230:[function(require,module,exports){"use strict";function HmacDRBG(options){if(!(this instanceof HmacDRBG))return new HmacDRBG(options);this.hash=options.hash,this.predResist=!!options.predResist,this.outLen=this.hash.outSize,this.minEntropy=options.minEntropy||this.hash.hmacStrength,this._reseed=null,this.reseedInterval=null,this.K=null,this.V=null;var entropy=utils.toArray(options.entropy,options.entropyEnc||"hex"),nonce=utils.toArray(options.nonce,options.nonceEnc||"hex"),pers=utils.toArray(options.pers,options.persEnc||"hex");assert(entropy.length>=this.minEntropy/8,"Not enough entropy. Minimum is: "+this.minEntropy+" bits"),this._init(entropy,nonce,pers)}var hash=require("hash.js"),utils=require("minimalistic-crypto-utils"),assert=require("minimalistic-assert");module.exports=HmacDRBG,HmacDRBG.prototype._init=function(entropy,nonce,pers){var seed=entropy.concat(nonce).concat(pers);this.K=new Array(this.outLen/8),this.V=new Array(this.outLen/8);for(var i=0;i<this.V.length;i++)this.K[i]=0,this.V[i]=1;this._update(seed),this._reseed=1,this.reseedInterval=281474976710656},HmacDRBG.prototype._hmac=function(){return new hash.hmac(this.hash,this.K)},HmacDRBG.prototype._update=function(seed){var kmac=this._hmac().update(this.V).update([0]);seed&&(kmac=kmac.update(seed)),this.K=kmac.digest(),this.V=this._hmac().update(this.V).digest(),seed&&(this.K=this._hmac().update(this.V).update([1]).update(seed).digest(),this.V=this._hmac().update(this.V).digest())},HmacDRBG.prototype.reseed=function(entropy,entropyEnc,add,addEnc){"string"!=typeof entropyEnc&&(addEnc=add,add=entropyEnc,entropyEnc=null),entropy=utils.toArray(entropy,entropyEnc),add=utils.toArray(add,addEnc),assert(entropy.length>=this.minEntropy/8,"Not enough entropy. Minimum is: "+this.minEntropy+" bits"),this._update(entropy.concat(add||[])),this._reseed=1},HmacDRBG.prototype.generate=function(len,enc,add,addEnc){if(this._reseed>this.reseedInterval)throw new Error("Reseed is required");"string"!=typeof enc&&(addEnc=add,add=enc,enc=null),add&&(add=utils.toArray(add,addEnc||"hex"),this._update(add));for(var temp=[];temp.length<len;)this.V=this._hmac().update(this.V).digest(),temp=temp.concat(this.V);var res=temp.slice(0,len);return this._update(add),this._reseed++,utils.encode(res,enc)}},{"hash.js":218,"minimalistic-assert":274,"minimalistic-crypto-utils":275}],231:[function(require,module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;nBits>0;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;nBits>0;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?NaN:(s?-1:1)*(1/0);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=value<0||0===value&&1/value<0?1:0;for(value=Math.abs(value),isNaN(value)||value===1/0?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),value+=e+eBias>=1?rt/c:rt*Math.pow(2,1-eBias),value*c>=2&&(e++,c/=2),e+eBias>=eMax?(m=0,e=eMax):e+eBias>=1?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));mLen>=8;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;eLen>0;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s}},{}],232:[function(require,module,exports){(function(global){"use strict";function nextTick(){draining=!0;for(var i,oldQueue,len=queue.length;len;){for(oldQueue=queue,queue=[],i=-1;++i<len;)oldQueue[i]();len=queue.length}draining=!1}function immediate(task){1!==queue.push(task)||draining||scheduleDrain()}var scheduleDrain,Mutation=global.MutationObserver||global.WebKitMutationObserver;if(Mutation){var called=0,observer=new Mutation(nextTick),element=global.document.createTextNode("");observer.observe(element,{characterData:!0}),scheduleDrain=function(){element.data=called=++called%2}}else if(global.setImmediate||"undefined"==typeof global.MessageChannel)scheduleDrain="document"in global&&"onreadystatechange"in global.document.createElement("script")?function(){var scriptEl=global.document.createElement("script");scriptEl.onreadystatechange=function(){nextTick(),scriptEl.onreadystatechange=null,scriptEl.parentNode.removeChild(scriptEl),scriptEl=null},
global.document.documentElement.appendChild(scriptEl)}:function(){setTimeout(nextTick,0)};else{var channel=new global.MessageChannel;channel.port1.onmessage=nextTick,scheduleDrain=function(){channel.port2.postMessage(0)}}var draining,queue=[];module.exports=immediate}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],233:[function(require,module,exports){arguments[4][104][0].apply(exports,arguments)},{dup:104}],234:[function(require,module,exports){function isBuffer(obj){return!!obj.constructor&&"function"==typeof obj.constructor.isBuffer&&obj.constructor.isBuffer(obj)}function isSlowBuffer(obj){return"function"==typeof obj.readFloatLE&&"function"==typeof obj.slice&&isBuffer(obj.slice(0,0))}module.exports=function(obj){return null!=obj&&(isBuffer(obj)||isSlowBuffer(obj)||!!obj._isBuffer)}},{}],235:[function(require,module,exports){"use strict";var utils=require("./utils"),support=require("./support"),_keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";exports.encode=function(input){for(var chr1,chr2,chr3,enc1,enc2,enc3,enc4,output=[],i=0,len=input.length,remainingBytes=len,isArray="string"!==utils.getTypeOf(input);i<input.length;)remainingBytes=len-i,isArray?(chr1=input[i++],chr2=i<len?input[i++]:0,chr3=i<len?input[i++]:0):(chr1=input.charCodeAt(i++),chr2=i<len?input.charCodeAt(i++):0,chr3=i<len?input.charCodeAt(i++):0),enc1=chr1>>2,enc2=(3&chr1)<<4|chr2>>4,enc3=remainingBytes>1?(15&chr2)<<2|chr3>>6:64,enc4=remainingBytes>2?63&chr3:64,output.push(_keyStr.charAt(enc1)+_keyStr.charAt(enc2)+_keyStr.charAt(enc3)+_keyStr.charAt(enc4));return output.join("")},exports.decode=function(input){var chr1,chr2,chr3,enc1,enc2,enc3,enc4,i=0,resultIndex=0,dataUrlPrefix="data:";if(input.substr(0,dataUrlPrefix.length)===dataUrlPrefix)throw new Error("Invalid base64 input, it looks like a data url.");input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");var totalLength=3*input.length/4;if(input.charAt(input.length-1)===_keyStr.charAt(64)&&totalLength--,input.charAt(input.length-2)===_keyStr.charAt(64)&&totalLength--,totalLength%1!==0)throw new Error("Invalid base64 input, bad content length.");var output;for(output=support.uint8array?new Uint8Array(0|totalLength):new Array(0|totalLength);i<input.length;)enc1=_keyStr.indexOf(input.charAt(i++)),enc2=_keyStr.indexOf(input.charAt(i++)),enc3=_keyStr.indexOf(input.charAt(i++)),enc4=_keyStr.indexOf(input.charAt(i++)),chr1=enc1<<2|enc2>>4,chr2=(15&enc2)<<4|enc3>>2,chr3=(3&enc3)<<6|enc4,output[resultIndex++]=chr1,64!==enc3&&(output[resultIndex++]=chr2),64!==enc4&&(output[resultIndex++]=chr3);return output}},{"./support":264,"./utils":266}],236:[function(require,module,exports){"use strict";function CompressedObject(compressedSize,uncompressedSize,crc32,compression,data){this.compressedSize=compressedSize,this.uncompressedSize=uncompressedSize,this.crc32=crc32,this.compression=compression,this.compressedContent=data}var external=require("./external"),DataWorker=require("./stream/DataWorker"),DataLengthProbe=require("./stream/DataLengthProbe"),Crc32Probe=require("./stream/Crc32Probe"),DataLengthProbe=require("./stream/DataLengthProbe");CompressedObject.prototype={getContentWorker:function(){var worker=new DataWorker(external.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new DataLengthProbe("data_length")),that=this;return worker.on("end",function(){if(this.streamInfo.data_length!==that.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),worker},getCompressedWorker:function(){return new DataWorker(external.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},CompressedObject.createWorkerFrom=function(uncompressedWorker,compression,compressionOptions){return uncompressedWorker.pipe(new Crc32Probe).pipe(new DataLengthProbe("uncompressedSize")).pipe(compression.compressWorker(compressionOptions)).pipe(new DataLengthProbe("compressedSize")).withStreamInfo("compression",compression)},module.exports=CompressedObject},{"./external":240,"./stream/Crc32Probe":259,"./stream/DataLengthProbe":260,"./stream/DataWorker":261}],237:[function(require,module,exports){"use strict";var GenericWorker=require("./stream/GenericWorker");exports.STORE={magic:"\0\0",compressWorker:function(compressionOptions){return new GenericWorker("STORE compression")},uncompressWorker:function(){return new GenericWorker("STORE decompression")}},exports.DEFLATE=require("./flate")},{"./flate":241,"./stream/GenericWorker":262}],238:[function(require,module,exports){"use strict";function makeTable(){for(var c,table=[],n=0;n<256;n++){c=n;for(var k=0;k<8;k++)c=1&c?3988292384^c>>>1:c>>>1;table[n]=c}return table}function crc32(crc,buf,len,pos){var t=crcTable,end=pos+len;crc^=-1;for(var i=pos;i<end;i++)crc=crc>>>8^t[255&(crc^buf[i])];return crc^-1}function crc32str(crc,str,len,pos){var t=crcTable,end=pos+len;crc^=-1;for(var i=pos;i<end;i++)crc=crc>>>8^t[255&(crc^str.charCodeAt(i))];return crc^-1}var utils=require("./utils"),crcTable=makeTable();module.exports=function(input,crc){if("undefined"==typeof input||!input.length)return 0;var isArray="string"!==utils.getTypeOf(input);return isArray?crc32(0|crc,input,input.length,0):crc32str(0|crc,input,input.length,0)}},{"./utils":266}],239:[function(require,module,exports){"use strict";exports.base64=!1,exports.binary=!1,exports.dir=!1,exports.createFolders=!0,exports.date=null,exports.compression=null,exports.compressionOptions=null,exports.comment=null,exports.unixPermissions=null,exports.dosPermissions=null},{}],240:[function(require,module,exports){"use strict";var ES6Promise=null;ES6Promise="undefined"!=typeof Promise?Promise:require("lie"),module.exports={Promise:ES6Promise}},{lie:270}],241:[function(require,module,exports){"use strict";function FlateWorker(action,options){GenericWorker.call(this,"FlateWorker/"+action),this._pako=null,this._pakoAction=action,this._pakoOptions=options,this.meta={}}var USE_TYPEDARRAY="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array,pako=require("pako"),utils=require("./utils"),GenericWorker=require("./stream/GenericWorker"),ARRAY_TYPE=USE_TYPEDARRAY?"uint8array":"array";exports.magic="\b\0",utils.inherits(FlateWorker,GenericWorker),FlateWorker.prototype.processChunk=function(chunk){this.meta=chunk.meta,null===this._pako&&this._createPako(),this._pako.push(utils.transformTo(ARRAY_TYPE,chunk.data),!1)},FlateWorker.prototype.flush=function(){GenericWorker.prototype.flush.call(this),null===this._pako&&this._createPako(),this._pako.push([],!0)},FlateWorker.prototype.cleanUp=function(){GenericWorker.prototype.cleanUp.call(this),this._pako=null},FlateWorker.prototype._createPako=function(){this._pako=new pako[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var self=this;this._pako.onData=function(data){self.push({data:data,meta:self.meta})}},exports.compressWorker=function(compressionOptions){return new FlateWorker("Deflate",compressionOptions)},exports.uncompressWorker=function(){return new FlateWorker("Inflate",{})}},{"./stream/GenericWorker":262,"./utils":266,pako:277}],242:[function(require,module,exports){"use strict";function ZipFileWorker(streamFiles,comment,platform,encodeFileName){GenericWorker.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=comment,this.zipPlatform=platform,this.encodeFileName=encodeFileName,this.streamFiles=streamFiles,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}var utils=require("../utils"),GenericWorker=require("../stream/GenericWorker"),utf8=require("../utf8"),crc32=require("../crc32"),signature=require("../signature"),decToHex=function(dec,bytes){var i,hex="";for(i=0;i<bytes;i++)hex+=String.fromCharCode(255&dec),dec>>>=8;return hex},generateUnixExternalFileAttr=function(unixPermissions,isDir){var result=unixPermissions;return unixPermissions||(result=isDir?16893:33204),(65535&result)<<16},generateDosExternalFileAttr=function(dosPermissions,isDir){return 63&(dosPermissions||0)},generateZipParts=function(streamInfo,streamedContent,streamingEnded,offset,platform,encodeFileName){var dosTime,dosDate,file=streamInfo.file,compression=streamInfo.compression,useCustomEncoding=encodeFileName!==utf8.utf8encode,encodedFileName=utils.transformTo("string",encodeFileName(file.name)),utfEncodedFileName=utils.transformTo("string",utf8.utf8encode(file.name)),comment=file.comment,encodedComment=utils.transformTo("string",encodeFileName(comment)),utfEncodedComment=utils.transformTo("string",utf8.utf8encode(comment)),useUTF8ForFileName=utfEncodedFileName.length!==file.name.length,useUTF8ForComment=utfEncodedComment.length!==comment.length,extraFields="",unicodePathExtraField="",unicodeCommentExtraField="",dir=file.dir,date=file.date,dataInfo={crc32:0,compressedSize:0,uncompressedSize:0};streamedContent&&!streamingEnded||(dataInfo.crc32=streamInfo.crc32,dataInfo.compressedSize=streamInfo.compressedSize,dataInfo.uncompressedSize=streamInfo.uncompressedSize);var bitflag=0;streamedContent&&(bitflag|=8),useCustomEncoding||!useUTF8ForFileName&&!useUTF8ForComment||(bitflag|=2048);var extFileAttr=0,versionMadeBy=0;dir&&(extFileAttr|=16),"UNIX"===platform?(versionMadeBy=798,extFileAttr|=generateUnixExternalFileAttr(file.unixPermissions,dir)):(versionMadeBy=20,extFileAttr|=generateDosExternalFileAttr(file.dosPermissions,dir)),dosTime=date.getUTCHours(),dosTime<<=6,dosTime|=date.getUTCMinutes(),dosTime<<=5,dosTime|=date.getUTCSeconds()/2,dosDate=date.getUTCFullYear()-1980,dosDate<<=4,dosDate|=date.getUTCMonth()+1,dosDate<<=5,dosDate|=date.getUTCDate(),useUTF8ForFileName&&(unicodePathExtraField=decToHex(1,1)+decToHex(crc32(encodedFileName),4)+utfEncodedFileName,extraFields+="up"+decToHex(unicodePathExtraField.length,2)+unicodePathExtraField),useUTF8ForComment&&(unicodeCommentExtraField=decToHex(1,1)+decToHex(crc32(encodedComment),4)+utfEncodedComment,extraFields+="uc"+decToHex(unicodeCommentExtraField.length,2)+unicodeCommentExtraField);var header="";header+="\n\0",header+=decToHex(bitflag,2),header+=compression.magic,header+=decToHex(dosTime,2),header+=decToHex(dosDate,2),header+=decToHex(dataInfo.crc32,4),header+=decToHex(dataInfo.compressedSize,4),header+=decToHex(dataInfo.uncompressedSize,4),header+=decToHex(encodedFileName.length,2),header+=decToHex(extraFields.length,2);var fileRecord=signature.LOCAL_FILE_HEADER+header+encodedFileName+extraFields,dirRecord=signature.CENTRAL_FILE_HEADER+decToHex(versionMadeBy,2)+header+decToHex(encodedComment.length,2)+"\0\0\0\0"+decToHex(extFileAttr,4)+decToHex(offset,4)+encodedFileName+extraFields+encodedComment;return{fileRecord:fileRecord,dirRecord:dirRecord}},generateCentralDirectoryEnd=function(entriesCount,centralDirLength,localDirLength,comment,encodeFileName){var dirEnd="",encodedComment=utils.transformTo("string",encodeFileName(comment));return dirEnd=signature.CENTRAL_DIRECTORY_END+"\0\0\0\0"+decToHex(entriesCount,2)+decToHex(entriesCount,2)+decToHex(centralDirLength,4)+decToHex(localDirLength,4)+decToHex(encodedComment.length,2)+encodedComment},generateDataDescriptors=function(streamInfo){var descriptor="";return descriptor=signature.DATA_DESCRIPTOR+decToHex(streamInfo.crc32,4)+decToHex(streamInfo.compressedSize,4)+decToHex(streamInfo.uncompressedSize,4)};utils.inherits(ZipFileWorker,GenericWorker),ZipFileWorker.prototype.push=function(chunk){var currentFilePercent=chunk.meta.percent||0,entriesCount=this.entriesCount,remainingFiles=this._sources.length;this.accumulate?this.contentBuffer.push(chunk):(this.bytesWritten+=chunk.data.length,GenericWorker.prototype.push.call(this,{data:chunk.data,meta:{currentFile:this.currentFile,percent:entriesCount?(currentFilePercent+100*(entriesCount-remainingFiles-1))/entriesCount:100}}))},ZipFileWorker.prototype.openedSource=function(streamInfo){this.currentSourceOffset=this.bytesWritten,this.currentFile=streamInfo.file.name;var streamedContent=this.streamFiles&&!streamInfo.file.dir;if(streamedContent){var record=generateZipParts(streamInfo,streamedContent,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:record.fileRecord,meta:{percent:0}})}else this.accumulate=!0},ZipFileWorker.prototype.closedSource=function(streamInfo){this.accumulate=!1;var streamedContent=this.streamFiles&&!streamInfo.file.dir,record=generateZipParts(streamInfo,streamedContent,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(record.dirRecord),streamedContent)this.push({data:generateDataDescriptors(streamInfo),meta:{percent:100}});else for(this.push({data:record.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},ZipFileWorker.prototype.flush=function(){for(var localDirLength=this.bytesWritten,i=0;i<this.dirRecords.length;i++)this.push({data:this.dirRecords[i],meta:{percent:100}});var centralDirLength=this.bytesWritten-localDirLength,dirEnd=generateCentralDirectoryEnd(this.dirRecords.length,centralDirLength,localDirLength,this.zipComment,this.encodeFileName);this.push({data:dirEnd,meta:{percent:100}})},ZipFileWorker.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},ZipFileWorker.prototype.registerPrevious=function(previous){this._sources.push(previous);var self=this;return previous.on("data",function(chunk){self.processChunk(chunk)}),previous.on("end",function(){self.closedSource(self.previous.streamInfo),self._sources.length?self.prepareNextSource():self.end()}),previous.on("error",function(e){self.error(e)}),this},ZipFileWorker.prototype.resume=function(){return!!GenericWorker.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},ZipFileWorker.prototype.error=function(e){var sources=this._sources;if(!GenericWorker.prototype.error.call(this,e))return!1;for(var i=0;i<sources.length;i++)try{sources[i].error(e)}catch(e){}return!0},ZipFileWorker.prototype.lock=function(){GenericWorker.prototype.lock.call(this);for(var sources=this._sources,i=0;i<sources.length;i++)sources[i].lock()},module.exports=ZipFileWorker},{"../crc32":238,"../signature":257,"../stream/GenericWorker":262,"../utf8":265,"../utils":266}],243:[function(require,module,exports){"use strict";var compressions=require("../compressions"),ZipFileWorker=require("./ZipFileWorker"),getCompression=function(fileCompression,zipCompression){var compressionName=fileCompression||zipCompression,compression=compressions[compressionName];if(!compression)throw new Error(compressionName+" is not a valid compression method !");return compression};exports.generateWorker=function(zip,options,comment){var zipFileWorker=new ZipFileWorker(options.streamFiles,comment,options.platform,options.encodeFileName),entriesCount=0;try{zip.forEach(function(relativePath,file){entriesCount++;var compression=getCompression(file.options.compression,options.compression),compressionOptions=file.options.compressionOptions||options.compressionOptions||{},dir=file.dir,date=file.date;file._compressWorker(compression,compressionOptions).withStreamInfo("file",{name:relativePath,dir:dir,date:date,comment:file.comment||"",unixPermissions:file.unixPermissions,dosPermissions:file.dosPermissions}).pipe(zipFileWorker)}),zipFileWorker.entriesCount=entriesCount}catch(e){zipFileWorker.error(e)}return zipFileWorker}},{"../compressions":237,"./ZipFileWorker":242}],244:[function(require,module,exports){"use strict";function JSZip(){if(!(this instanceof JSZip))return new JSZip;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files={},this.comment=null,this.root="",this.clone=function(){var newObj=new JSZip;for(var i in this)"function"!=typeof this[i]&&(newObj[i]=this[i]);return newObj}}JSZip.prototype=require("./object"),JSZip.prototype.loadAsync=require("./load"),JSZip.support=require("./support"),JSZip.defaults=require("./defaults"),JSZip.version="3.1.5",JSZip.loadAsync=function(content,options){return(new JSZip).loadAsync(content,options)},JSZip.external=require("./external"),module.exports=JSZip},{"./defaults":239,"./external":240,"./load":245,"./object":249,"./support":264}],245:[function(require,module,exports){"use strict";function checkEntryCRC32(zipEntry){return new external.Promise(function(resolve,reject){var worker=zipEntry.decompressed.getContentWorker().pipe(new Crc32Probe);worker.on("error",function(e){reject(e)}).on("end",function(){worker.streamInfo.crc32!==zipEntry.decompressed.crc32?reject(new Error("Corrupted zip : CRC32 mismatch")):resolve()}).resume()})}var utils=require("./utils"),external=require("./external"),utf8=require("./utf8"),utils=require("./utils"),ZipEntries=require("./zipEntries"),Crc32Probe=require("./stream/Crc32Probe"),nodejsUtils=require("./nodejsUtils");module.exports=function(data,options){var zip=this;return options=utils.extend(options||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:utf8.utf8decode}),nodejsUtils.isNode&&nodejsUtils.isStream(data)?external.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):utils.prepareContent("the loaded zip file",data,!0,options.optimizedBinaryString,options.base64).then(function(data){var zipEntries=new ZipEntries(options);return zipEntries.load(data),zipEntries}).then(function(zipEntries){var promises=[external.Promise.resolve(zipEntries)],files=zipEntries.files;if(options.checkCRC32)for(var i=0;i<files.length;i++)promises.push(checkEntryCRC32(files[i]));return external.Promise.all(promises)}).then(function(results){for(var zipEntries=results.shift(),files=zipEntries.files,i=0;i<files.length;i++){var input=files[i];zip.file(input.fileNameStr,input.decompressed,{binary:!0,optimizedBinaryString:!0,date:input.date,dir:input.dir,comment:input.fileCommentStr.length?input.fileCommentStr:null,unixPermissions:input.unixPermissions,dosPermissions:input.dosPermissions,createFolders:options.createFolders})}return zipEntries.zipComment.length&&(zip.comment=zipEntries.zipComment),zip})}},{"./external":240,"./nodejsUtils":248,"./stream/Crc32Probe":259,"./utf8":265,"./utils":266,"./zipEntries":267}],246:[function(require,module,exports){"use strict";function NodejsStreamInputAdapter(filename,stream){GenericWorker.call(this,"Nodejs stream input adapter for "+filename),this._upstreamEnded=!1,this._bindStream(stream)}var utils=require("../utils"),GenericWorker=require("../stream/GenericWorker");utils.inherits(NodejsStreamInputAdapter,GenericWorker),NodejsStreamInputAdapter.prototype._bindStream=function(stream){var self=this;this._stream=stream,stream.pause(),stream.on("data",function(chunk){self.push({data:chunk,meta:{percent:0}})}).on("error",function(e){self.isPaused?this.generatedError=e:self.error(e)}).on("end",function(){self.isPaused?self._upstreamEnded=!0:self.end()})},NodejsStreamInputAdapter.prototype.pause=function(){return!!GenericWorker.prototype.pause.call(this)&&(this._stream.pause(),!0)},NodejsStreamInputAdapter.prototype.resume=function(){return!!GenericWorker.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},module.exports=NodejsStreamInputAdapter},{"../stream/GenericWorker":262,"../utils":266}],247:[function(require,module,exports){"use strict";function NodejsStreamOutputAdapter(helper,options,updateCb){Readable.call(this,options),this._helper=helper;var self=this;helper.on("data",function(data,meta){self.push(data)||self._helper.pause(),updateCb&&updateCb(meta)}).on("error",function(e){self.emit("error",e)}).on("end",function(){self.push(null)})}var Readable=require("readable-stream").Readable,utils=require("../utils");utils.inherits(NodejsStreamOutputAdapter,Readable),NodejsStreamOutputAdapter.prototype._read=function(){this._helper.resume()},module.exports=NodejsStreamOutputAdapter},{"../utils":266,"readable-stream":250}],248:[function(require,module,exports){(function(Buffer){"use strict";module.exports={isNode:"undefined"!=typeof Buffer,newBufferFrom:function(data,encoding){return new Buffer(data,encoding)},allocBuffer:function(size){return Buffer.alloc?Buffer.alloc(size):new Buffer(size)},isBuffer:function(b){return Buffer.isBuffer(b)},isStream:function(obj){return obj&&"function"==typeof obj.on&&"function"==typeof obj.pause&&"function"==typeof obj.resume}}}).call(this,require("buffer").Buffer)},{buffer:151}],249:[function(require,module,exports){"use strict";function isRegExp(object){return"[object RegExp]"===Object.prototype.toString.call(object)}var utf8=require("./utf8"),utils=require("./utils"),GenericWorker=require("./stream/GenericWorker"),StreamHelper=require("./stream/StreamHelper"),defaults=require("./defaults"),CompressedObject=require("./compressedObject"),ZipObject=require("./zipObject"),generate=require("./generate"),nodejsUtils=require("./nodejsUtils"),NodejsStreamInputAdapter=require("./nodejs/NodejsStreamInputAdapter"),fileAdd=function(name,data,originalOptions){var parent,dataType=utils.getTypeOf(data),o=utils.extend(originalOptions||{},defaults);o.date=o.date||new Date,null!==o.compression&&(o.compression=o.compression.toUpperCase()),"string"==typeof o.unixPermissions&&(o.unixPermissions=parseInt(o.unixPermissions,8)),o.unixPermissions&&16384&o.unixPermissions&&(o.dir=!0),o.dosPermissions&&16&o.dosPermissions&&(o.dir=!0),o.dir&&(name=forceTrailingSlash(name)),o.createFolders&&(parent=parentFolder(name))&&folderAdd.call(this,parent,!0);var isUnicodeString="string"===dataType&&o.binary===!1&&o.base64===!1;originalOptions&&"undefined"!=typeof originalOptions.binary||(o.binary=!isUnicodeString);var isCompressedEmpty=data instanceof CompressedObject&&0===data.uncompressedSize;(isCompressedEmpty||o.dir||!data||0===data.length)&&(o.base64=!1,o.binary=!0,data="",o.compression="STORE",dataType="string");var zipObjectContent=null;zipObjectContent=data instanceof CompressedObject||data instanceof GenericWorker?data:nodejsUtils.isNode&&nodejsUtils.isStream(data)?new NodejsStreamInputAdapter(name,data):utils.prepareContent(name,data,o.binary,o.optimizedBinaryString,o.base64);var object=new ZipObject(name,zipObjectContent,o);this.files[name]=object},parentFolder=function(path){"/"===path.slice(-1)&&(path=path.substring(0,path.length-1));var lastSlash=path.lastIndexOf("/");return lastSlash>0?path.substring(0,lastSlash):""},forceTrailingSlash=function(path){return"/"!==path.slice(-1)&&(path+="/"),path},folderAdd=function(name,createFolders){return createFolders="undefined"!=typeof createFolders?createFolders:defaults.createFolders,name=forceTrailingSlash(name),this.files[name]||fileAdd.call(this,name,null,{dir:!0,createFolders:createFolders}),this.files[name]},out={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(cb){var filename,relativePath,file;for(filename in this.files)this.files.hasOwnProperty(filename)&&(file=this.files[filename],relativePath=filename.slice(this.root.length,filename.length),relativePath&&filename.slice(0,this.root.length)===this.root&&cb(relativePath,file))},filter:function(search){var result=[];return this.forEach(function(relativePath,entry){search(relativePath,entry)&&result.push(entry)}),result},file:function(name,data,o){if(1===arguments.length){if(isRegExp(name)){var regexp=name;return this.filter(function(relativePath,file){return!file.dir&&regexp.test(relativePath)})}var obj=this.files[this.root+name];return obj&&!obj.dir?obj:null}return name=this.root+name,fileAdd.call(this,name,data,o),this},folder:function(arg){if(!arg)return this;if(isRegExp(arg))return this.filter(function(relativePath,file){return file.dir&&arg.test(relativePath)});var name=this.root+arg,newFolder=folderAdd.call(this,name),ret=this.clone();return ret.root=newFolder.name,ret},remove:function(name){name=this.root+name;var file=this.files[name];if(file||("/"!==name.slice(-1)&&(name+="/"),file=this.files[name]),file&&!file.dir)delete this.files[name];else for(var kids=this.filter(function(relativePath,file){return file.name.slice(0,name.length)===name}),i=0;i<kids.length;i++)delete this.files[kids[i].name];return this},generate:function(options){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(options){var worker,opts={};try{if(opts=utils.extend(options||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:utf8.utf8encode}),opts.type=opts.type.toLowerCase(),opts.compression=opts.compression.toUpperCase(),"binarystring"===opts.type&&(opts.type="string"),!opts.type)throw new Error("No output type specified.");utils.checkSupport(opts.type),"darwin"!==opts.platform&&"freebsd"!==opts.platform&&"linux"!==opts.platform&&"sunos"!==opts.platform||(opts.platform="UNIX"),"win32"===opts.platform&&(opts.platform="DOS");var comment=opts.comment||this.comment||"";worker=generate.generateWorker(this,opts,comment)}catch(e){worker=new GenericWorker("error"),worker.error(e)}return new StreamHelper(worker,opts.type||"string",opts.mimeType)},generateAsync:function(options,onUpdate){return this.generateInternalStream(options).accumulate(onUpdate)},generateNodeStream:function(options,onUpdate){return options=options||{},options.type||(options.type="nodebuffer"),this.generateInternalStream(options).toNodejsStream(onUpdate)}};module.exports=out},{"./compressedObject":236,"./defaults":239,"./generate":243,"./nodejs/NodejsStreamInputAdapter":246,"./nodejsUtils":248,"./stream/GenericWorker":262,"./stream/StreamHelper":263,"./utf8":265,"./utils":266,"./zipObject":269}],250:[function(require,module,exports){module.exports=require("stream")},{stream:345}],251:[function(require,module,exports){"use strict";function ArrayReader(data){DataReader.call(this,data);for(var i=0;i<this.data.length;i++)data[i]=255&data[i]}var DataReader=require("./DataReader"),utils=require("../utils");utils.inherits(ArrayReader,DataReader),ArrayReader.prototype.byteAt=function(i){return this.data[this.zero+i]},ArrayReader.prototype.lastIndexOfSignature=function(sig){for(var sig0=sig.charCodeAt(0),sig1=sig.charCodeAt(1),sig2=sig.charCodeAt(2),sig3=sig.charCodeAt(3),i=this.length-4;i>=0;--i)if(this.data[i]===sig0&&this.data[i+1]===sig1&&this.data[i+2]===sig2&&this.data[i+3]===sig3)return i-this.zero;return-1},ArrayReader.prototype.readAndCheckSignature=function(sig){var sig0=sig.charCodeAt(0),sig1=sig.charCodeAt(1),sig2=sig.charCodeAt(2),sig3=sig.charCodeAt(3),data=this.readData(4);return sig0===data[0]&&sig1===data[1]&&sig2===data[2]&&sig3===data[3]},ArrayReader.prototype.readData=function(size){if(this.checkOffset(size),0===size)return[];var result=this.data.slice(this.zero+this.index,this.zero+this.index+size);return this.index+=size,result},module.exports=ArrayReader},{"../utils":266,"./DataReader":252}],252:[function(require,module,exports){"use strict";function DataReader(data){this.data=data,this.length=data.length,this.index=0,this.zero=0}var utils=require("../utils");DataReader.prototype={checkOffset:function(offset){this.checkIndex(this.index+offset)},checkIndex:function(newIndex){if(this.length<this.zero+newIndex||newIndex<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+newIndex+"). Corrupted zip ?")},setIndex:function(newIndex){this.checkIndex(newIndex),this.index=newIndex},skip:function(n){this.setIndex(this.index+n)},byteAt:function(i){},readInt:function(size){var i,result=0;for(this.checkOffset(size),i=this.index+size-1;i>=this.index;i--)result=(result<<8)+this.byteAt(i);return this.index+=size,result},readString:function(size){return utils.transformTo("string",this.readData(size))},readData:function(size){},lastIndexOfSignature:function(sig){},readAndCheckSignature:function(sig){},readDate:function(){var dostime=this.readInt(4);return new Date(Date.UTC((dostime>>25&127)+1980,(dostime>>21&15)-1,dostime>>16&31,dostime>>11&31,dostime>>5&63,(31&dostime)<<1))}},module.exports=DataReader},{"../utils":266}],253:[function(require,module,exports){"use strict";function NodeBufferReader(data){Uint8ArrayReader.call(this,data)}var Uint8ArrayReader=require("./Uint8ArrayReader"),utils=require("../utils");utils.inherits(NodeBufferReader,Uint8ArrayReader),NodeBufferReader.prototype.readData=function(size){this.checkOffset(size);var result=this.data.slice(this.zero+this.index,this.zero+this.index+size);return this.index+=size,result},module.exports=NodeBufferReader},{"../utils":266,"./Uint8ArrayReader":255}],254:[function(require,module,exports){"use strict";function StringReader(data){DataReader.call(this,data)}var DataReader=require("./DataReader"),utils=require("../utils");utils.inherits(StringReader,DataReader),StringReader.prototype.byteAt=function(i){return this.data.charCodeAt(this.zero+i)},StringReader.prototype.lastIndexOfSignature=function(sig){return this.data.lastIndexOf(sig)-this.zero},StringReader.prototype.readAndCheckSignature=function(sig){var data=this.readData(4);return sig===data},StringReader.prototype.readData=function(size){this.checkOffset(size);var result=this.data.slice(this.zero+this.index,this.zero+this.index+size);return this.index+=size,result},module.exports=StringReader},{"../utils":266,"./DataReader":252}],255:[function(require,module,exports){"use strict";function Uint8ArrayReader(data){ArrayReader.call(this,data)}var ArrayReader=require("./ArrayReader"),utils=require("../utils");utils.inherits(Uint8ArrayReader,ArrayReader),Uint8ArrayReader.prototype.readData=function(size){if(this.checkOffset(size),0===size)return new Uint8Array(0);var result=this.data.subarray(this.zero+this.index,this.zero+this.index+size);return this.index+=size,result},module.exports=Uint8ArrayReader},{"../utils":266,"./ArrayReader":251}],256:[function(require,module,exports){"use strict";var utils=require("../utils"),support=require("../support"),ArrayReader=require("./ArrayReader"),StringReader=require("./StringReader"),NodeBufferReader=require("./NodeBufferReader"),Uint8ArrayReader=require("./Uint8ArrayReader");module.exports=function(data){var type=utils.getTypeOf(data);return utils.checkSupport(type),"string"!==type||support.uint8array?"nodebuffer"===type?new NodeBufferReader(data):support.uint8array?new Uint8ArrayReader(utils.transformTo("uint8array",data)):new ArrayReader(utils.transformTo("array",data)):new StringReader(data)}},{"../support":264,"../utils":266,"./ArrayReader":251,"./NodeBufferReader":253,"./StringReader":254,"./Uint8ArrayReader":255}],257:[function(require,module,exports){"use strict";exports.LOCAL_FILE_HEADER="PK",exports.CENTRAL_FILE_HEADER="PK",exports.CENTRAL_DIRECTORY_END="PK",exports.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK",exports.ZIP64_CENTRAL_DIRECTORY_END="PK",exports.DATA_DESCRIPTOR="PK\b"},{}],258:[function(require,module,exports){"use strict";function ConvertWorker(destType){GenericWorker.call(this,"ConvertWorker to "+destType),this.destType=destType}var GenericWorker=require("./GenericWorker"),utils=require("../utils");utils.inherits(ConvertWorker,GenericWorker),ConvertWorker.prototype.processChunk=function(chunk){this.push({data:utils.transformTo(this.destType,chunk.data),meta:chunk.meta})},module.exports=ConvertWorker},{"../utils":266,"./GenericWorker":262}],259:[function(require,module,exports){"use strict";function Crc32Probe(){GenericWorker.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}var GenericWorker=require("./GenericWorker"),crc32=require("../crc32"),utils=require("../utils");
utils.inherits(Crc32Probe,GenericWorker),Crc32Probe.prototype.processChunk=function(chunk){this.streamInfo.crc32=crc32(chunk.data,this.streamInfo.crc32||0),this.push(chunk)},module.exports=Crc32Probe},{"../crc32":238,"../utils":266,"./GenericWorker":262}],260:[function(require,module,exports){"use strict";function DataLengthProbe(propName){GenericWorker.call(this,"DataLengthProbe for "+propName),this.propName=propName,this.withStreamInfo(propName,0)}var utils=require("../utils"),GenericWorker=require("./GenericWorker");utils.inherits(DataLengthProbe,GenericWorker),DataLengthProbe.prototype.processChunk=function(chunk){if(chunk){var length=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=length+chunk.data.length}GenericWorker.prototype.processChunk.call(this,chunk)},module.exports=DataLengthProbe},{"../utils":266,"./GenericWorker":262}],261:[function(require,module,exports){"use strict";function DataWorker(dataP){GenericWorker.call(this,"DataWorker");var self=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,dataP.then(function(data){self.dataIsReady=!0,self.data=data,self.max=data&&data.length||0,self.type=utils.getTypeOf(data),self.isPaused||self._tickAndRepeat()},function(e){self.error(e)})}var utils=require("../utils"),GenericWorker=require("./GenericWorker"),DEFAULT_BLOCK_SIZE=16384;utils.inherits(DataWorker,GenericWorker),DataWorker.prototype.cleanUp=function(){GenericWorker.prototype.cleanUp.call(this),this.data=null},DataWorker.prototype.resume=function(){return!!GenericWorker.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,utils.delay(this._tickAndRepeat,[],this)),!0)},DataWorker.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(utils.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},DataWorker.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var size=DEFAULT_BLOCK_SIZE,data=null,nextIndex=Math.min(this.max,this.index+size);if(this.index>=this.max)return this.end();switch(this.type){case"string":data=this.data.substring(this.index,nextIndex);break;case"uint8array":data=this.data.subarray(this.index,nextIndex);break;case"array":case"nodebuffer":data=this.data.slice(this.index,nextIndex)}return this.index=nextIndex,this.push({data:data,meta:{percent:this.max?this.index/this.max*100:0}})},module.exports=DataWorker},{"../utils":266,"./GenericWorker":262}],262:[function(require,module,exports){"use strict";function GenericWorker(name){this.name=name||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}GenericWorker.prototype={push:function(chunk){this.emit("data",chunk)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(e){this.emit("error",e)}return!0},error:function(e){return!this.isFinished&&(this.isPaused?this.generatedError=e:(this.isFinished=!0,this.emit("error",e),this.previous&&this.previous.error(e),this.cleanUp()),!0)},on:function(name,listener){return this._listeners[name].push(listener),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(name,arg){if(this._listeners[name])for(var i=0;i<this._listeners[name].length;i++)this._listeners[name][i].call(this,arg)},pipe:function(next){return next.registerPrevious(this)},registerPrevious:function(previous){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=previous.streamInfo,this.mergeStreamInfo(),this.previous=previous;var self=this;return previous.on("data",function(chunk){self.processChunk(chunk)}),previous.on("end",function(){self.end()}),previous.on("error",function(e){self.error(e)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;this.isPaused=!1;var withError=!1;return this.generatedError&&(this.error(this.generatedError),withError=!0),this.previous&&this.previous.resume(),!withError},flush:function(){},processChunk:function(chunk){this.push(chunk)},withStreamInfo:function(key,value){return this.extraStreamInfo[key]=value,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var key in this.extraStreamInfo)this.extraStreamInfo.hasOwnProperty(key)&&(this.streamInfo[key]=this.extraStreamInfo[key])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var me="Worker "+this.name;return this.previous?this.previous+" -> "+me:me}},module.exports=GenericWorker},{}],263:[function(require,module,exports){(function(Buffer){"use strict";function transformZipOutput(type,content,mimeType){switch(type){case"blob":return utils.newBlob(utils.transformTo("arraybuffer",content),mimeType);case"base64":return base64.encode(content);default:return utils.transformTo(type,content)}}function concat(type,dataArray){var i,index=0,res=null,totalLength=0;for(i=0;i<dataArray.length;i++)totalLength+=dataArray[i].length;switch(type){case"string":return dataArray.join("");case"array":return Array.prototype.concat.apply([],dataArray);case"uint8array":for(res=new Uint8Array(totalLength),i=0;i<dataArray.length;i++)res.set(dataArray[i],index),index+=dataArray[i].length;return res;case"nodebuffer":return Buffer.concat(dataArray);default:throw new Error("concat : unsupported type '"+type+"'")}}function accumulate(helper,updateCallback){return new external.Promise(function(resolve,reject){var dataArray=[],chunkType=helper._internalType,resultType=helper._outputType,mimeType=helper._mimeType;helper.on("data",function(data,meta){dataArray.push(data),updateCallback&&updateCallback(meta)}).on("error",function(err){dataArray=[],reject(err)}).on("end",function(){try{var result=transformZipOutput(resultType,concat(chunkType,dataArray),mimeType);resolve(result)}catch(e){reject(e)}dataArray=[]}).resume()})}function StreamHelper(worker,outputType,mimeType){var internalType=outputType;switch(outputType){case"blob":case"arraybuffer":internalType="uint8array";break;case"base64":internalType="string"}try{this._internalType=internalType,this._outputType=outputType,this._mimeType=mimeType,utils.checkSupport(internalType),this._worker=worker.pipe(new ConvertWorker(internalType)),worker.lock()}catch(e){this._worker=new GenericWorker("error"),this._worker.error(e)}}var utils=require("../utils"),ConvertWorker=require("./ConvertWorker"),GenericWorker=require("./GenericWorker"),base64=require("../base64"),support=require("../support"),external=require("../external"),NodejsStreamOutputAdapter=null;if(support.nodestream)try{NodejsStreamOutputAdapter=require("../nodejs/NodejsStreamOutputAdapter")}catch(e){}StreamHelper.prototype={accumulate:function(updateCb){return accumulate(this,updateCb)},on:function(evt,fn){var self=this;return"data"===evt?this._worker.on(evt,function(chunk){fn.call(self,chunk.data,chunk.meta)}):this._worker.on(evt,function(){utils.delay(fn,arguments,self)}),this},resume:function(){return utils.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(updateCb){if(utils.checkSupport("nodestream"),"nodebuffer"!==this._outputType)throw new Error(this._outputType+" is not supported by this method");return new NodejsStreamOutputAdapter(this,{objectMode:"nodebuffer"!==this._outputType},updateCb)}},module.exports=StreamHelper}).call(this,require("buffer").Buffer)},{"../base64":235,"../external":240,"../nodejs/NodejsStreamOutputAdapter":247,"../support":264,"../utils":266,"./ConvertWorker":258,"./GenericWorker":262,buffer:151}],264:[function(require,module,exports){(function(Buffer){"use strict";if(exports.base64=!0,exports.array=!0,exports.string=!0,exports.arraybuffer="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array,exports.nodebuffer="undefined"!=typeof Buffer,exports.uint8array="undefined"!=typeof Uint8Array,"undefined"==typeof ArrayBuffer)exports.blob=!1;else{var buffer=new ArrayBuffer(0);try{exports.blob=0===new Blob([buffer],{type:"application/zip"}).size}catch(e){try{var Builder=self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder,builder=new Builder;builder.append(buffer),exports.blob=0===builder.getBlob("application/zip").size}catch(e){exports.blob=!1}}}try{exports.nodestream=!!require("readable-stream").Readable}catch(e){exports.nodestream=!1}}).call(this,require("buffer").Buffer)},{buffer:151,"readable-stream":250}],265:[function(require,module,exports){"use strict";function Utf8DecodeWorker(){GenericWorker.call(this,"utf-8 decode"),this.leftOver=null}function Utf8EncodeWorker(){GenericWorker.call(this,"utf-8 encode")}for(var utils=require("./utils"),support=require("./support"),nodejsUtils=require("./nodejsUtils"),GenericWorker=require("./stream/GenericWorker"),_utf8len=new Array(256),i=0;i<256;i++)_utf8len[i]=i>=252?6:i>=248?5:i>=240?4:i>=224?3:i>=192?2:1;_utf8len[254]=_utf8len[254]=1;var string2buf=function(str){var buf,c,c2,m_pos,i,str_len=str.length,buf_len=0;for(m_pos=0;m_pos<str_len;m_pos++)c=str.charCodeAt(m_pos),55296===(64512&c)&&m_pos+1<str_len&&(c2=str.charCodeAt(m_pos+1),56320===(64512&c2)&&(c=65536+(c-55296<<10)+(c2-56320),m_pos++)),buf_len+=c<128?1:c<2048?2:c<65536?3:4;for(buf=support.uint8array?new Uint8Array(buf_len):new Array(buf_len),i=0,m_pos=0;i<buf_len;m_pos++)c=str.charCodeAt(m_pos),55296===(64512&c)&&m_pos+1<str_len&&(c2=str.charCodeAt(m_pos+1),56320===(64512&c2)&&(c=65536+(c-55296<<10)+(c2-56320),m_pos++)),c<128?buf[i++]=c:c<2048?(buf[i++]=192|c>>>6,buf[i++]=128|63&c):c<65536?(buf[i++]=224|c>>>12,buf[i++]=128|c>>>6&63,buf[i++]=128|63&c):(buf[i++]=240|c>>>18,buf[i++]=128|c>>>12&63,buf[i++]=128|c>>>6&63,buf[i++]=128|63&c);return buf},utf8border=function(buf,max){var pos;for(max=max||buf.length,max>buf.length&&(max=buf.length),pos=max-1;pos>=0&&128===(192&buf[pos]);)pos--;return pos<0?max:0===pos?max:pos+_utf8len[buf[pos]]>max?pos:max},buf2string=function(buf){var i,out,c,c_len,len=buf.length,utf16buf=new Array(2*len);for(out=0,i=0;i<len;)if(c=buf[i++],c<128)utf16buf[out++]=c;else if(c_len=_utf8len[c],c_len>4)utf16buf[out++]=65533,i+=c_len-1;else{for(c&=2===c_len?31:3===c_len?15:7;c_len>1&&i<len;)c=c<<6|63&buf[i++],c_len--;c_len>1?utf16buf[out++]=65533:c<65536?utf16buf[out++]=c:(c-=65536,utf16buf[out++]=55296|c>>10&1023,utf16buf[out++]=56320|1023&c)}return utf16buf.length!==out&&(utf16buf.subarray?utf16buf=utf16buf.subarray(0,out):utf16buf.length=out),utils.applyFromCharCode(utf16buf)};exports.utf8encode=function(str){return support.nodebuffer?nodejsUtils.newBufferFrom(str,"utf-8"):string2buf(str)},exports.utf8decode=function(buf){return support.nodebuffer?utils.transformTo("nodebuffer",buf).toString("utf-8"):(buf=utils.transformTo(support.uint8array?"uint8array":"array",buf),buf2string(buf))},utils.inherits(Utf8DecodeWorker,GenericWorker),Utf8DecodeWorker.prototype.processChunk=function(chunk){var data=utils.transformTo(support.uint8array?"uint8array":"array",chunk.data);if(this.leftOver&&this.leftOver.length){if(support.uint8array){var previousData=data;data=new Uint8Array(previousData.length+this.leftOver.length),data.set(this.leftOver,0),data.set(previousData,this.leftOver.length)}else data=this.leftOver.concat(data);this.leftOver=null}var nextBoundary=utf8border(data),usableData=data;nextBoundary!==data.length&&(support.uint8array?(usableData=data.subarray(0,nextBoundary),this.leftOver=data.subarray(nextBoundary,data.length)):(usableData=data.slice(0,nextBoundary),this.leftOver=data.slice(nextBoundary,data.length))),this.push({data:exports.utf8decode(usableData),meta:chunk.meta})},Utf8DecodeWorker.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:exports.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},exports.Utf8DecodeWorker=Utf8DecodeWorker,utils.inherits(Utf8EncodeWorker,GenericWorker),Utf8EncodeWorker.prototype.processChunk=function(chunk){this.push({data:exports.utf8encode(chunk.data),meta:chunk.meta})},exports.Utf8EncodeWorker=Utf8EncodeWorker},{"./nodejsUtils":248,"./stream/GenericWorker":262,"./support":264,"./utils":266}],266:[function(require,module,exports){"use strict";function string2binary(str){var result=null;return result=support.uint8array?new Uint8Array(str.length):new Array(str.length),stringToArrayLike(str,result)}function identity(input){return input}function stringToArrayLike(str,array){for(var i=0;i<str.length;++i)array[i]=255&str.charCodeAt(i);return array}function arrayLikeToString(array){var chunk=65536,type=exports.getTypeOf(array),canUseApply=!0;if("uint8array"===type?canUseApply=arrayToStringHelper.applyCanBeUsed.uint8array:"nodebuffer"===type&&(canUseApply=arrayToStringHelper.applyCanBeUsed.nodebuffer),canUseApply)for(;chunk>1;)try{return arrayToStringHelper.stringifyByChunk(array,type,chunk)}catch(e){chunk=Math.floor(chunk/2)}return arrayToStringHelper.stringifyByChar(array)}function arrayLikeToArrayLike(arrayFrom,arrayTo){for(var i=0;i<arrayFrom.length;i++)arrayTo[i]=arrayFrom[i];return arrayTo}var support=require("./support"),base64=require("./base64"),nodejsUtils=require("./nodejsUtils"),setImmediate=require("core-js/library/fn/set-immediate"),external=require("./external");exports.newBlob=function(part,type){exports.checkSupport("blob");try{return new Blob([part],{type:type})}catch(e){try{var Builder=self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder,builder=new Builder;return builder.append(part),builder.getBlob(type)}catch(e){throw new Error("Bug : can't construct the Blob.")}}};var arrayToStringHelper={stringifyByChunk:function(array,type,chunk){var result=[],k=0,len=array.length;if(len<=chunk)return String.fromCharCode.apply(null,array);for(;k<len;)"array"===type||"nodebuffer"===type?result.push(String.fromCharCode.apply(null,array.slice(k,Math.min(k+chunk,len)))):result.push(String.fromCharCode.apply(null,array.subarray(k,Math.min(k+chunk,len)))),k+=chunk;return result.join("")},stringifyByChar:function(array){for(var resultStr="",i=0;i<array.length;i++)resultStr+=String.fromCharCode(array[i]);return resultStr},applyCanBeUsed:{uint8array:function(){try{return support.uint8array&&1===String.fromCharCode.apply(null,new Uint8Array(1)).length}catch(e){return!1}}(),nodebuffer:function(){try{return support.nodebuffer&&1===String.fromCharCode.apply(null,nodejsUtils.allocBuffer(1)).length}catch(e){return!1}}()}};exports.applyFromCharCode=arrayLikeToString;var transform={};transform.string={string:identity,array:function(input){return stringToArrayLike(input,new Array(input.length))},arraybuffer:function(input){return transform.string.uint8array(input).buffer},uint8array:function(input){return stringToArrayLike(input,new Uint8Array(input.length))},nodebuffer:function(input){return stringToArrayLike(input,nodejsUtils.allocBuffer(input.length))}},transform.array={string:arrayLikeToString,array:identity,arraybuffer:function(input){return new Uint8Array(input).buffer},uint8array:function(input){return new Uint8Array(input)},nodebuffer:function(input){return nodejsUtils.newBufferFrom(input)}},transform.arraybuffer={string:function(input){return arrayLikeToString(new Uint8Array(input))},array:function(input){return arrayLikeToArrayLike(new Uint8Array(input),new Array(input.byteLength))},arraybuffer:identity,uint8array:function(input){return new Uint8Array(input)},nodebuffer:function(input){return nodejsUtils.newBufferFrom(new Uint8Array(input))}},transform.uint8array={string:arrayLikeToString,array:function(input){return arrayLikeToArrayLike(input,new Array(input.length))},arraybuffer:function(input){return input.buffer},uint8array:identity,nodebuffer:function(input){return nodejsUtils.newBufferFrom(input)}},transform.nodebuffer={string:arrayLikeToString,array:function(input){return arrayLikeToArrayLike(input,new Array(input.length))},arraybuffer:function(input){return transform.nodebuffer.uint8array(input).buffer},uint8array:function(input){return arrayLikeToArrayLike(input,new Uint8Array(input.length))},nodebuffer:identity},exports.transformTo=function(outputType,input){if(input||(input=""),!outputType)return input;exports.checkSupport(outputType);var inputType=exports.getTypeOf(input),result=transform[inputType][outputType](input);return result},exports.getTypeOf=function(input){return"string"==typeof input?"string":"[object Array]"===Object.prototype.toString.call(input)?"array":support.nodebuffer&&nodejsUtils.isBuffer(input)?"nodebuffer":support.uint8array&&input instanceof Uint8Array?"uint8array":support.arraybuffer&&input instanceof ArrayBuffer?"arraybuffer":void 0},exports.checkSupport=function(type){var supported=support[type.toLowerCase()];if(!supported)throw new Error(type+" is not supported by this platform")},exports.MAX_VALUE_16BITS=65535,exports.MAX_VALUE_32BITS=-1,exports.pretty=function(str){var code,i,res="";for(i=0;i<(str||"").length;i++)code=str.charCodeAt(i),res+="\\x"+(code<16?"0":"")+code.toString(16).toUpperCase();return res},exports.delay=function(callback,args,self){setImmediate(function(){callback.apply(self||null,args||[])})},exports.inherits=function(ctor,superCtor){var Obj=function(){};Obj.prototype=superCtor.prototype,ctor.prototype=new Obj},exports.extend=function(){var i,attr,result={};for(i=0;i<arguments.length;i++)for(attr in arguments[i])arguments[i].hasOwnProperty(attr)&&"undefined"==typeof result[attr]&&(result[attr]=arguments[i][attr]);return result},exports.prepareContent=function(name,inputData,isBinary,isOptimizedBinaryString,isBase64){var promise=external.Promise.resolve(inputData).then(function(data){var isBlob=support.blob&&(data instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(data))!==-1);return isBlob&&"undefined"!=typeof FileReader?new external.Promise(function(resolve,reject){var reader=new FileReader;reader.onload=function(e){resolve(e.target.result)},reader.onerror=function(e){reject(e.target.error)},reader.readAsArrayBuffer(data)}):data});return promise.then(function(data){var dataType=exports.getTypeOf(data);return dataType?("arraybuffer"===dataType?data=exports.transformTo("uint8array",data):"string"===dataType&&(isBase64?data=base64.decode(data):isBinary&&isOptimizedBinaryString!==!0&&(data=string2binary(data))),data):external.Promise.reject(new Error("Can't read the data of '"+name+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":235,"./external":240,"./nodejsUtils":248,"./support":264,"core-js/library/fn/set-immediate":154}],267:[function(require,module,exports){"use strict";function ZipEntries(loadOptions){this.files=[],this.loadOptions=loadOptions}var readerFor=require("./reader/readerFor"),utils=require("./utils"),sig=require("./signature"),ZipEntry=require("./zipEntry"),support=(require("./utf8"),require("./support"));ZipEntries.prototype={checkSignature:function(expectedSignature){if(!this.reader.readAndCheckSignature(expectedSignature)){this.reader.index-=4;var signature=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+utils.pretty(signature)+", expected "+utils.pretty(expectedSignature)+")")}},isSignature:function(askedIndex,expectedSignature){var currentIndex=this.reader.index;this.reader.setIndex(askedIndex);var signature=this.reader.readString(4),result=signature===expectedSignature;return this.reader.setIndex(currentIndex),result},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var zipComment=this.reader.readData(this.zipCommentLength),decodeParamType=support.uint8array?"uint8array":"array",decodeContent=utils.transformTo(decodeParamType,zipComment);this.zipComment=this.loadOptions.decodeFileName(decodeContent)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var extraFieldId,extraFieldLength,extraFieldValue,extraDataSize=this.zip64EndOfCentralSize-44,index=0;index<extraDataSize;)extraFieldId=this.reader.readInt(2),extraFieldLength=this.reader.readInt(4),extraFieldValue=this.reader.readData(extraFieldLength),this.zip64ExtensibleData[extraFieldId]={id:extraFieldId,length:extraFieldLength,value:extraFieldValue}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),this.disksCount>1)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var i,file;for(i=0;i<this.files.length;i++)file=this.files[i],this.reader.setIndex(file.localHeaderOffset),this.checkSignature(sig.LOCAL_FILE_HEADER),file.readLocalPart(this.reader),file.handleUTF8(),file.processAttributes()},readCentralDir:function(){var file;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(sig.CENTRAL_FILE_HEADER);)file=new ZipEntry({zip64:this.zip64},this.loadOptions),file.readCentralPart(this.reader),this.files.push(file);if(this.centralDirRecords!==this.files.length&&0!==this.centralDirRecords&&0===this.files.length)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var offset=this.reader.lastIndexOfSignature(sig.CENTRAL_DIRECTORY_END);if(offset<0){var isGarbage=!this.isSignature(0,sig.LOCAL_FILE_HEADER);throw isGarbage?new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html"):new Error("Corrupted zip: can't find end of central directory")}this.reader.setIndex(offset);var endOfCentralDirOffset=offset;if(this.checkSignature(sig.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===utils.MAX_VALUE_16BITS||this.diskWithCentralDirStart===utils.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===utils.MAX_VALUE_16BITS||this.centralDirRecords===utils.MAX_VALUE_16BITS||this.centralDirSize===utils.MAX_VALUE_32BITS||this.centralDirOffset===utils.MAX_VALUE_32BITS){if(this.zip64=!0,offset=this.reader.lastIndexOfSignature(sig.ZIP64_CENTRAL_DIRECTORY_LOCATOR),offset<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(offset),this.checkSignature(sig.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,sig.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(sig.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(sig.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var expectedEndOfCentralDirOffset=this.centralDirOffset+this.centralDirSize;this.zip64&&(expectedEndOfCentralDirOffset+=20,expectedEndOfCentralDirOffset+=12+this.zip64EndOfCentralSize);var extraBytes=endOfCentralDirOffset-expectedEndOfCentralDirOffset;if(extraBytes>0)this.isSignature(endOfCentralDirOffset,sig.CENTRAL_FILE_HEADER)||(this.reader.zero=extraBytes);else if(extraBytes<0)throw new Error("Corrupted zip: missing "+Math.abs(extraBytes)+" bytes.")},prepareReader:function(data){this.reader=readerFor(data)},load:function(data){this.prepareReader(data),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},module.exports=ZipEntries},{"./reader/readerFor":256,"./signature":257,"./support":264,"./utf8":265,"./utils":266,"./zipEntry":268}],268:[function(require,module,exports){"use strict";function ZipEntry(options,loadOptions){this.options=options,this.loadOptions=loadOptions}var readerFor=require("./reader/readerFor"),utils=require("./utils"),CompressedObject=require("./compressedObject"),crc32fn=require("./crc32"),utf8=require("./utf8"),compressions=require("./compressions"),support=require("./support"),MADE_BY_DOS=0,MADE_BY_UNIX=3,findCompression=function(compressionMethod){for(var method in compressions)if(compressions.hasOwnProperty(method)&&compressions[method].magic===compressionMethod)return compressions[method];return null};ZipEntry.prototype={isEncrypted:function(){return 1===(1&this.bitFlag)},useUTF8:function(){return 2048===(2048&this.bitFlag)},readLocalPart:function(reader){var compression,localExtraFieldsLength;if(reader.skip(22),this.fileNameLength=reader.readInt(2),localExtraFieldsLength=reader.readInt(2),this.fileName=reader.readData(this.fileNameLength),reader.skip(localExtraFieldsLength),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough informations from the central directory (compressedSize === -1 || uncompressedSize === -1)");if(compression=findCompression(this.compressionMethod),null===compression)throw new Error("Corrupted zip : compression "+utils.pretty(this.compressionMethod)+" unknown (inner file : "+utils.transformTo("string",this.fileName)+")");this.decompressed=new CompressedObject(this.compressedSize,this.uncompressedSize,this.crc32,compression,reader.readData(this.compressedSize))},readCentralPart:function(reader){this.versionMadeBy=reader.readInt(2),reader.skip(2),this.bitFlag=reader.readInt(2),this.compressionMethod=reader.readString(2),this.date=reader.readDate(),this.crc32=reader.readInt(4),this.compressedSize=reader.readInt(4),this.uncompressedSize=reader.readInt(4);var fileNameLength=reader.readInt(2);if(this.extraFieldsLength=reader.readInt(2),this.fileCommentLength=reader.readInt(2),this.diskNumberStart=reader.readInt(2),this.internalFileAttributes=reader.readInt(2),this.externalFileAttributes=reader.readInt(4),this.localHeaderOffset=reader.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");reader.skip(fileNameLength),this.readExtraFields(reader),this.parseZIP64ExtraField(reader),this.fileComment=reader.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var madeBy=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),madeBy===MADE_BY_DOS&&(this.dosPermissions=63&this.externalFileAttributes),madeBy===MADE_BY_UNIX&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||"/"!==this.fileNameStr.slice(-1)||(this.dir=!0)},parseZIP64ExtraField:function(reader){if(this.extraFields[1]){var extraReader=readerFor(this.extraFields[1].value);this.uncompressedSize===utils.MAX_VALUE_32BITS&&(this.uncompressedSize=extraReader.readInt(8)),this.compressedSize===utils.MAX_VALUE_32BITS&&(this.compressedSize=extraReader.readInt(8)),this.localHeaderOffset===utils.MAX_VALUE_32BITS&&(this.localHeaderOffset=extraReader.readInt(8)),this.diskNumberStart===utils.MAX_VALUE_32BITS&&(this.diskNumberStart=extraReader.readInt(4))}},readExtraFields:function(reader){var extraFieldId,extraFieldLength,extraFieldValue,end=reader.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});reader.index<end;)extraFieldId=reader.readInt(2),extraFieldLength=reader.readInt(2),extraFieldValue=reader.readData(extraFieldLength),this.extraFields[extraFieldId]={id:extraFieldId,length:extraFieldLength,value:extraFieldValue}},handleUTF8:function(){var decodeParamType=support.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=utf8.utf8decode(this.fileName),this.fileCommentStr=utf8.utf8decode(this.fileComment);else{var upath=this.findExtraFieldUnicodePath();if(null!==upath)this.fileNameStr=upath;else{var fileNameByteArray=utils.transformTo(decodeParamType,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(fileNameByteArray)}var ucomment=this.findExtraFieldUnicodeComment();if(null!==ucomment)this.fileCommentStr=ucomment;else{var commentByteArray=utils.transformTo(decodeParamType,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(commentByteArray)}}},findExtraFieldUnicodePath:function(){var upathField=this.extraFields[28789];if(upathField){var extraReader=readerFor(upathField.value);return 1!==extraReader.readInt(1)?null:crc32fn(this.fileName)!==extraReader.readInt(4)?null:utf8.utf8decode(extraReader.readData(upathField.length-5))}return null},findExtraFieldUnicodeComment:function(){var ucommentField=this.extraFields[25461];if(ucommentField){var extraReader=readerFor(ucommentField.value);return 1!==extraReader.readInt(1)?null:crc32fn(this.fileComment)!==extraReader.readInt(4)?null:utf8.utf8decode(extraReader.readData(ucommentField.length-5))}return null}},module.exports=ZipEntry},{"./compressedObject":236,"./compressions":237,"./crc32":238,"./reader/readerFor":256,"./support":264,"./utf8":265,"./utils":266}],269:[function(require,module,exports){"use strict";var StreamHelper=require("./stream/StreamHelper"),DataWorker=require("./stream/DataWorker"),utf8=require("./utf8"),CompressedObject=require("./compressedObject"),GenericWorker=require("./stream/GenericWorker"),ZipObject=function(name,data,options){this.name=name,this.dir=options.dir,this.date=options.date,this.comment=options.comment,this.unixPermissions=options.unixPermissions,this.dosPermissions=options.dosPermissions,this._data=data,this._dataBinary=options.binary,this.options={compression:options.compression,compressionOptions:options.compressionOptions}};ZipObject.prototype={internalStream:function(type){var result=null,outputType="string";try{if(!type)throw new Error("No output type specified.");outputType=type.toLowerCase();var askUnicodeString="string"===outputType||"text"===outputType;"binarystring"!==outputType&&"text"!==outputType||(outputType="string"),result=this._decompressWorker();var isUnicodeString=!this._dataBinary;isUnicodeString&&!askUnicodeString&&(result=result.pipe(new utf8.Utf8EncodeWorker)),!isUnicodeString&&askUnicodeString&&(result=result.pipe(new utf8.Utf8DecodeWorker))}catch(e){result=new GenericWorker("error"),result.error(e)}return new StreamHelper(result,outputType,"")},async:function(type,onUpdate){return this.internalStream(type).accumulate(onUpdate)},nodeStream:function(type,onUpdate){return this.internalStream(type||"nodebuffer").toNodejsStream(onUpdate)},_compressWorker:function(compression,compressionOptions){if(this._data instanceof CompressedObject&&this._data.compression.magic===compression.magic)return this._data.getCompressedWorker();var result=this._decompressWorker();return this._dataBinary||(result=result.pipe(new utf8.Utf8EncodeWorker)),CompressedObject.createWorkerFrom(result,compression,compressionOptions)},_decompressWorker:function(){return this._data instanceof CompressedObject?this._data.getContentWorker():this._data instanceof GenericWorker?this._data:new DataWorker(this._data)}};for(var removedMethods=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],removedFn=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},i=0;i<removedMethods.length;i++)ZipObject.prototype[removedMethods[i]]=removedFn;module.exports=ZipObject},{"./compressedObject":236,"./stream/DataWorker":261,
"./stream/GenericWorker":262,"./stream/StreamHelper":263,"./utf8":265}],270:[function(require,module,exports){"use strict";function INTERNAL(){}function Promise(resolver){if("function"!=typeof resolver)throw new TypeError("resolver must be a function");this.state=PENDING,this.queue=[],this.outcome=void 0,resolver!==INTERNAL&&safelyResolveThenable(this,resolver)}function QueueItem(promise,onFulfilled,onRejected){this.promise=promise,"function"==typeof onFulfilled&&(this.onFulfilled=onFulfilled,this.callFulfilled=this.otherCallFulfilled),"function"==typeof onRejected&&(this.onRejected=onRejected,this.callRejected=this.otherCallRejected)}function unwrap(promise,func,value){immediate(function(){var returnValue;try{returnValue=func(value)}catch(e){return handlers.reject(promise,e)}returnValue===promise?handlers.reject(promise,new TypeError("Cannot resolve promise with itself")):handlers.resolve(promise,returnValue)})}function getThen(obj){var then=obj&&obj.then;if(obj&&("object"==typeof obj||"function"==typeof obj)&&"function"==typeof then)return function(){then.apply(obj,arguments)}}function safelyResolveThenable(self,thenable){function onError(value){called||(called=!0,handlers.reject(self,value))}function onSuccess(value){called||(called=!0,handlers.resolve(self,value))}function tryToUnwrap(){thenable(onSuccess,onError)}var called=!1,result=tryCatch(tryToUnwrap);"error"===result.status&&onError(result.value)}function tryCatch(func,value){var out={};try{out.value=func(value),out.status="success"}catch(e){out.status="error",out.value=e}return out}function resolve(value){return value instanceof this?value:handlers.resolve(new this(INTERNAL),value)}function reject(reason){var promise=new this(INTERNAL);return handlers.reject(promise,reason)}function all(iterable){function allResolver(value,i){function resolveFromAll(outValue){values[i]=outValue,++resolved!==len||called||(called=!0,handlers.resolve(promise,values))}self.resolve(value).then(resolveFromAll,function(error){called||(called=!0,handlers.reject(promise,error))})}var self=this;if("[object Array]"!==Object.prototype.toString.call(iterable))return this.reject(new TypeError("must be an array"));var len=iterable.length,called=!1;if(!len)return this.resolve([]);for(var values=new Array(len),resolved=0,i=-1,promise=new this(INTERNAL);++i<len;)allResolver(iterable[i],i);return promise}function race(iterable){function resolver(value){self.resolve(value).then(function(response){called||(called=!0,handlers.resolve(promise,response))},function(error){called||(called=!0,handlers.reject(promise,error))})}var self=this;if("[object Array]"!==Object.prototype.toString.call(iterable))return this.reject(new TypeError("must be an array"));var len=iterable.length,called=!1;if(!len)return this.resolve([]);for(var i=-1,promise=new this(INTERNAL);++i<len;)resolver(iterable[i]);return promise}var immediate=require("immediate"),handlers={},REJECTED=["REJECTED"],FULFILLED=["FULFILLED"],PENDING=["PENDING"];module.exports=Promise,Promise.prototype["catch"]=function(onRejected){return this.then(null,onRejected)},Promise.prototype.then=function(onFulfilled,onRejected){if("function"!=typeof onFulfilled&&this.state===FULFILLED||"function"!=typeof onRejected&&this.state===REJECTED)return this;var promise=new this.constructor(INTERNAL);if(this.state!==PENDING){var resolver=this.state===FULFILLED?onFulfilled:onRejected;unwrap(promise,resolver,this.outcome)}else this.queue.push(new QueueItem(promise,onFulfilled,onRejected));return promise},QueueItem.prototype.callFulfilled=function(value){handlers.resolve(this.promise,value)},QueueItem.prototype.otherCallFulfilled=function(value){unwrap(this.promise,this.onFulfilled,value)},QueueItem.prototype.callRejected=function(value){handlers.reject(this.promise,value)},QueueItem.prototype.otherCallRejected=function(value){unwrap(this.promise,this.onRejected,value)},handlers.resolve=function(self,value){var result=tryCatch(getThen,value);if("error"===result.status)return handlers.reject(self,result.value);var thenable=result.value;if(thenable)safelyResolveThenable(self,thenable);else{self.state=FULFILLED,self.outcome=value;for(var i=-1,len=self.queue.length;++i<len;)self.queue[i].callFulfilled(value)}return self},handlers.reject=function(self,error){self.state=REJECTED,self.outcome=error;for(var i=-1,len=self.queue.length;++i<len;)self.queue[i].callRejected(error);return self},Promise.resolve=resolve,Promise.reject=reject,Promise.all=all,Promise.race=race},{immediate:232}],271:[function(require,module,exports){(function(global){(function(){function apply(func,thisArg,args){switch(args.length){case 0:return func.call(thisArg);case 1:return func.call(thisArg,args[0]);case 2:return func.call(thisArg,args[0],args[1]);case 3:return func.call(thisArg,args[0],args[1],args[2])}return func.apply(thisArg,args)}function arrayAggregator(array,setter,iteratee,accumulator){for(var index=-1,length=null==array?0:array.length;++index<length;){var value=array[index];setter(accumulator,value,iteratee(value),array)}return accumulator}function arrayEach(array,iteratee){for(var index=-1,length=null==array?0:array.length;++index<length&&iteratee(array[index],index,array)!==!1;);return array}function arrayEachRight(array,iteratee){for(var length=null==array?0:array.length;length--&&iteratee(array[length],length,array)!==!1;);return array}function arrayEvery(array,predicate){for(var index=-1,length=null==array?0:array.length;++index<length;)if(!predicate(array[index],index,array))return!1;return!0}function arrayFilter(array,predicate){for(var index=-1,length=null==array?0:array.length,resIndex=0,result=[];++index<length;){var value=array[index];predicate(value,index,array)&&(result[resIndex++]=value)}return result}function arrayIncludes(array,value){var length=null==array?0:array.length;return!!length&&baseIndexOf(array,value,0)>-1}function arrayIncludesWith(array,value,comparator){for(var index=-1,length=null==array?0:array.length;++index<length;)if(comparator(value,array[index]))return!0;return!1}function arrayMap(array,iteratee){for(var index=-1,length=null==array?0:array.length,result=Array(length);++index<length;)result[index]=iteratee(array[index],index,array);return result}function arrayPush(array,values){for(var index=-1,length=values.length,offset=array.length;++index<length;)array[offset+index]=values[index];return array}function arrayReduce(array,iteratee,accumulator,initAccum){var index=-1,length=null==array?0:array.length;for(initAccum&&length&&(accumulator=array[++index]);++index<length;)accumulator=iteratee(accumulator,array[index],index,array);return accumulator}function arrayReduceRight(array,iteratee,accumulator,initAccum){var length=null==array?0:array.length;for(initAccum&&length&&(accumulator=array[--length]);length--;)accumulator=iteratee(accumulator,array[length],length,array);return accumulator}function arraySome(array,predicate){for(var index=-1,length=null==array?0:array.length;++index<length;)if(predicate(array[index],index,array))return!0;return!1}function asciiToArray(string){return string.split("")}function asciiWords(string){return string.match(reAsciiWord)||[]}function baseFindKey(collection,predicate,eachFunc){var result;return eachFunc(collection,function(value,key,collection){if(predicate(value,key,collection))return result=key,!1}),result}function baseFindIndex(array,predicate,fromIndex,fromRight){for(var length=array.length,index=fromIndex+(fromRight?1:-1);fromRight?index--:++index<length;)if(predicate(array[index],index,array))return index;return-1}function baseIndexOf(array,value,fromIndex){return value===value?strictIndexOf(array,value,fromIndex):baseFindIndex(array,baseIsNaN,fromIndex)}function baseIndexOfWith(array,value,fromIndex,comparator){for(var index=fromIndex-1,length=array.length;++index<length;)if(comparator(array[index],value))return index;return-1}function baseIsNaN(value){return value!==value}function baseMean(array,iteratee){var length=null==array?0:array.length;return length?baseSum(array,iteratee)/length:NAN}function baseProperty(key){return function(object){return null==object?undefined:object[key]}}function basePropertyOf(object){return function(key){return null==object?undefined:object[key]}}function baseReduce(collection,iteratee,accumulator,initAccum,eachFunc){return eachFunc(collection,function(value,index,collection){accumulator=initAccum?(initAccum=!1,value):iteratee(accumulator,value,index,collection)}),accumulator}function baseSortBy(array,comparer){var length=array.length;for(array.sort(comparer);length--;)array[length]=array[length].value;return array}function baseSum(array,iteratee){for(var result,index=-1,length=array.length;++index<length;){var current=iteratee(array[index]);current!==undefined&&(result=result===undefined?current:result+current)}return result}function baseTimes(n,iteratee){for(var index=-1,result=Array(n);++index<n;)result[index]=iteratee(index);return result}function baseToPairs(object,props){return arrayMap(props,function(key){return[key,object[key]]})}function baseUnary(func){return function(value){return func(value)}}function baseValues(object,props){return arrayMap(props,function(key){return object[key]})}function cacheHas(cache,key){return cache.has(key)}function charsStartIndex(strSymbols,chrSymbols){for(var index=-1,length=strSymbols.length;++index<length&&baseIndexOf(chrSymbols,strSymbols[index],0)>-1;);return index}function charsEndIndex(strSymbols,chrSymbols){for(var index=strSymbols.length;index--&&baseIndexOf(chrSymbols,strSymbols[index],0)>-1;);return index}function countHolders(array,placeholder){for(var length=array.length,result=0;length--;)array[length]===placeholder&&++result;return result}function escapeStringChar(chr){return"\\"+stringEscapes[chr]}function getValue(object,key){return null==object?undefined:object[key]}function hasUnicode(string){return reHasUnicode.test(string)}function hasUnicodeWord(string){return reHasUnicodeWord.test(string)}function iteratorToArray(iterator){for(var data,result=[];!(data=iterator.next()).done;)result.push(data.value);return result}function mapToArray(map){var index=-1,result=Array(map.size);return map.forEach(function(value,key){result[++index]=[key,value]}),result}function overArg(func,transform){return function(arg){return func(transform(arg))}}function replaceHolders(array,placeholder){for(var index=-1,length=array.length,resIndex=0,result=[];++index<length;){var value=array[index];value!==placeholder&&value!==PLACEHOLDER||(array[index]=PLACEHOLDER,result[resIndex++]=index)}return result}function safeGet(object,key){return"__proto__"==key?undefined:object[key]}function setToArray(set){var index=-1,result=Array(set.size);return set.forEach(function(value){result[++index]=value}),result}function setToPairs(set){var index=-1,result=Array(set.size);return set.forEach(function(value){result[++index]=[value,value]}),result}function strictIndexOf(array,value,fromIndex){for(var index=fromIndex-1,length=array.length;++index<length;)if(array[index]===value)return index;return-1}function strictLastIndexOf(array,value,fromIndex){for(var index=fromIndex+1;index--;)if(array[index]===value)return index;return index}function stringSize(string){return hasUnicode(string)?unicodeSize(string):asciiSize(string)}function stringToArray(string){return hasUnicode(string)?unicodeToArray(string):asciiToArray(string)}function unicodeSize(string){for(var result=reUnicode.lastIndex=0;reUnicode.test(string);)++result;return result}function unicodeToArray(string){return string.match(reUnicode)||[]}function unicodeWords(string){return string.match(reUnicodeWord)||[]}var undefined,VERSION="4.17.10",LARGE_ARRAY_SIZE=200,CORE_ERROR_TEXT="Unsupported core-js use. Try https://npms.io/search?q=ponyfill.",FUNC_ERROR_TEXT="Expected a function",HASH_UNDEFINED="__lodash_hash_undefined__",MAX_MEMOIZE_SIZE=500,PLACEHOLDER="__lodash_placeholder__",CLONE_DEEP_FLAG=1,CLONE_FLAT_FLAG=2,CLONE_SYMBOLS_FLAG=4,COMPARE_PARTIAL_FLAG=1,COMPARE_UNORDERED_FLAG=2,WRAP_BIND_FLAG=1,WRAP_BIND_KEY_FLAG=2,WRAP_CURRY_BOUND_FLAG=4,WRAP_CURRY_FLAG=8,WRAP_CURRY_RIGHT_FLAG=16,WRAP_PARTIAL_FLAG=32,WRAP_PARTIAL_RIGHT_FLAG=64,WRAP_ARY_FLAG=128,WRAP_REARG_FLAG=256,WRAP_FLIP_FLAG=512,DEFAULT_TRUNC_LENGTH=30,DEFAULT_TRUNC_OMISSION="...",HOT_COUNT=800,HOT_SPAN=16,LAZY_FILTER_FLAG=1,LAZY_MAP_FLAG=2,LAZY_WHILE_FLAG=3,INFINITY=1/0,MAX_SAFE_INTEGER=9007199254740991,MAX_INTEGER=1.7976931348623157e308,NAN=NaN,MAX_ARRAY_LENGTH=4294967295,MAX_ARRAY_INDEX=MAX_ARRAY_LENGTH-1,HALF_MAX_ARRAY_LENGTH=MAX_ARRAY_LENGTH>>>1,wrapFlags=[["ary",WRAP_ARY_FLAG],["bind",WRAP_BIND_FLAG],["bindKey",WRAP_BIND_KEY_FLAG],["curry",WRAP_CURRY_FLAG],["curryRight",WRAP_CURRY_RIGHT_FLAG],["flip",WRAP_FLIP_FLAG],["partial",WRAP_PARTIAL_FLAG],["partialRight",WRAP_PARTIAL_RIGHT_FLAG],["rearg",WRAP_REARG_FLAG]],argsTag="[object Arguments]",arrayTag="[object Array]",asyncTag="[object AsyncFunction]",boolTag="[object Boolean]",dateTag="[object Date]",domExcTag="[object DOMException]",errorTag="[object Error]",funcTag="[object Function]",genTag="[object GeneratorFunction]",mapTag="[object Map]",numberTag="[object Number]",nullTag="[object Null]",objectTag="[object Object]",promiseTag="[object Promise]",proxyTag="[object Proxy]",regexpTag="[object RegExp]",setTag="[object Set]",stringTag="[object String]",symbolTag="[object Symbol]",undefinedTag="[object Undefined]",weakMapTag="[object WeakMap]",weakSetTag="[object WeakSet]",arrayBufferTag="[object ArrayBuffer]",dataViewTag="[object DataView]",float32Tag="[object Float32Array]",float64Tag="[object Float64Array]",int8Tag="[object Int8Array]",int16Tag="[object Int16Array]",int32Tag="[object Int32Array]",uint8Tag="[object Uint8Array]",uint8ClampedTag="[object Uint8ClampedArray]",uint16Tag="[object Uint16Array]",uint32Tag="[object Uint32Array]",reEmptyStringLeading=/\b__p \+= '';/g,reEmptyStringMiddle=/\b(__p \+=) '' \+/g,reEmptyStringTrailing=/(__e\(.*?\)|\b__t\)) \+\n'';/g,reEscapedHtml=/&(?:amp|lt|gt|quot|#39);/g,reUnescapedHtml=/[&<>"']/g,reHasEscapedHtml=RegExp(reEscapedHtml.source),reHasUnescapedHtml=RegExp(reUnescapedHtml.source),reEscape=/<%-([\s\S]+?)%>/g,reEvaluate=/<%([\s\S]+?)%>/g,reInterpolate=/<%=([\s\S]+?)%>/g,reIsDeepProp=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,reIsPlainProp=/^\w*$/,rePropName=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,reRegExpChar=/[\\^$.*+?()[\]{}|]/g,reHasRegExpChar=RegExp(reRegExpChar.source),reTrim=/^\s+|\s+$/g,reTrimStart=/^\s+/,reTrimEnd=/\s+$/,reWrapComment=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,reWrapDetails=/\{\n\/\* \[wrapped with (.+)\] \*/,reSplitDetails=/,? & /,reAsciiWord=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,reEscapeChar=/\\(\\)?/g,reEsTemplate=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,reFlags=/\w*$/,reIsBadHex=/^[-+]0x[0-9a-f]+$/i,reIsBinary=/^0b[01]+$/i,reIsHostCtor=/^\[object .+?Constructor\]$/,reIsOctal=/^0o[0-7]+$/i,reIsUint=/^(?:0|[1-9]\d*)$/,reLatin=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,reNoMatch=/($^)/,reUnescapedString=/['\n\r\u2028\u2029\\]/g,rsAstralRange="\\ud800-\\udfff",rsComboMarksRange="\\u0300-\\u036f",reComboHalfMarksRange="\\ufe20-\\ufe2f",rsComboSymbolsRange="\\u20d0-\\u20ff",rsComboRange=rsComboMarksRange+reComboHalfMarksRange+rsComboSymbolsRange,rsDingbatRange="\\u2700-\\u27bf",rsLowerRange="a-z\\xdf-\\xf6\\xf8-\\xff",rsMathOpRange="\\xac\\xb1\\xd7\\xf7",rsNonCharRange="\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf",rsPunctuationRange="\\u2000-\\u206f",rsSpaceRange=" \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",rsUpperRange="A-Z\\xc0-\\xd6\\xd8-\\xde",rsVarRange="\\ufe0e\\ufe0f",rsBreakRange=rsMathOpRange+rsNonCharRange+rsPunctuationRange+rsSpaceRange,rsApos="[']",rsAstral="["+rsAstralRange+"]",rsBreak="["+rsBreakRange+"]",rsCombo="["+rsComboRange+"]",rsDigits="\\d+",rsDingbat="["+rsDingbatRange+"]",rsLower="["+rsLowerRange+"]",rsMisc="[^"+rsAstralRange+rsBreakRange+rsDigits+rsDingbatRange+rsLowerRange+rsUpperRange+"]",rsFitz="\\ud83c[\\udffb-\\udfff]",rsModifier="(?:"+rsCombo+"|"+rsFitz+")",rsNonAstral="[^"+rsAstralRange+"]",rsRegional="(?:\\ud83c[\\udde6-\\uddff]){2}",rsSurrPair="[\\ud800-\\udbff][\\udc00-\\udfff]",rsUpper="["+rsUpperRange+"]",rsZWJ="\\u200d",rsMiscLower="(?:"+rsLower+"|"+rsMisc+")",rsMiscUpper="(?:"+rsUpper+"|"+rsMisc+")",rsOptContrLower="(?:"+rsApos+"(?:d|ll|m|re|s|t|ve))?",rsOptContrUpper="(?:"+rsApos+"(?:D|LL|M|RE|S|T|VE))?",reOptMod=rsModifier+"?",rsOptVar="["+rsVarRange+"]?",rsOptJoin="(?:"+rsZWJ+"(?:"+[rsNonAstral,rsRegional,rsSurrPair].join("|")+")"+rsOptVar+reOptMod+")*",rsOrdLower="\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",rsOrdUpper="\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])",rsSeq=rsOptVar+reOptMod+rsOptJoin,rsEmoji="(?:"+[rsDingbat,rsRegional,rsSurrPair].join("|")+")"+rsSeq,rsSymbol="(?:"+[rsNonAstral+rsCombo+"?",rsCombo,rsRegional,rsSurrPair,rsAstral].join("|")+")",reApos=RegExp(rsApos,"g"),reComboMark=RegExp(rsCombo,"g"),reUnicode=RegExp(rsFitz+"(?="+rsFitz+")|"+rsSymbol+rsSeq,"g"),reUnicodeWord=RegExp([rsUpper+"?"+rsLower+"+"+rsOptContrLower+"(?="+[rsBreak,rsUpper,"$"].join("|")+")",rsMiscUpper+"+"+rsOptContrUpper+"(?="+[rsBreak,rsUpper+rsMiscLower,"$"].join("|")+")",rsUpper+"?"+rsMiscLower+"+"+rsOptContrLower,rsUpper+"+"+rsOptContrUpper,rsOrdUpper,rsOrdLower,rsDigits,rsEmoji].join("|"),"g"),reHasUnicode=RegExp("["+rsZWJ+rsAstralRange+rsComboRange+rsVarRange+"]"),reHasUnicodeWord=/[a-z][A-Z]|[A-Z]{2,}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,contextProps=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],templateCounter=-1,typedArrayTags={};typedArrayTags[float32Tag]=typedArrayTags[float64Tag]=typedArrayTags[int8Tag]=typedArrayTags[int16Tag]=typedArrayTags[int32Tag]=typedArrayTags[uint8Tag]=typedArrayTags[uint8ClampedTag]=typedArrayTags[uint16Tag]=typedArrayTags[uint32Tag]=!0,typedArrayTags[argsTag]=typedArrayTags[arrayTag]=typedArrayTags[arrayBufferTag]=typedArrayTags[boolTag]=typedArrayTags[dataViewTag]=typedArrayTags[dateTag]=typedArrayTags[errorTag]=typedArrayTags[funcTag]=typedArrayTags[mapTag]=typedArrayTags[numberTag]=typedArrayTags[objectTag]=typedArrayTags[regexpTag]=typedArrayTags[setTag]=typedArrayTags[stringTag]=typedArrayTags[weakMapTag]=!1;var cloneableTags={};cloneableTags[argsTag]=cloneableTags[arrayTag]=cloneableTags[arrayBufferTag]=cloneableTags[dataViewTag]=cloneableTags[boolTag]=cloneableTags[dateTag]=cloneableTags[float32Tag]=cloneableTags[float64Tag]=cloneableTags[int8Tag]=cloneableTags[int16Tag]=cloneableTags[int32Tag]=cloneableTags[mapTag]=cloneableTags[numberTag]=cloneableTags[objectTag]=cloneableTags[regexpTag]=cloneableTags[setTag]=cloneableTags[stringTag]=cloneableTags[symbolTag]=cloneableTags[uint8Tag]=cloneableTags[uint8ClampedTag]=cloneableTags[uint16Tag]=cloneableTags[uint32Tag]=!0,cloneableTags[errorTag]=cloneableTags[funcTag]=cloneableTags[weakMapTag]=!1;var deburredLetters={"":"A","":"A","":"A","":"A","":"A","":"A","":"a","":"a","":"a","":"a","":"a","":"a","":"C","":"c","":"D","":"d","":"E","":"E","":"E","":"E","":"e","":"e","":"e","":"e","":"I","":"I","":"I","":"I","":"i","":"i","":"i","":"i","":"N","":"n","":"O","":"O","":"O","":"O","":"O","":"O","":"o","":"o","":"o","":"o","":"o","":"o","":"U","":"U","":"U","":"U","":"u","":"u","":"u","":"u","":"Y","":"y","":"y","":"Ae","":"ae","":"Th","":"th","":"ss","":"A","":"A","":"A","":"a","":"a","":"a","":"C","":"C","":"C","":"C","":"c","":"c","":"c","":"c","":"D","":"D","":"d","":"d","":"E","":"E","":"E","":"E","":"E","":"e","":"e","":"e","":"e","":"e","":"G","":"G","":"G","":"G","":"g","":"g","":"g","":"g","":"H","":"H","":"h","":"h","":"I","":"I","":"I","":"I","":"I","":"i","":"i","":"i","":"i","":"i","":"J","":"j","":"K","":"k","":"k","":"L","":"L","":"L","":"L","":"L","":"l","":"l","":"l","":"l","":"l","":"N","":"N","":"N","":"N","":"n","":"n","":"n","":"n","":"O","":"O","":"O","":"o","":"o","":"o","":"R","":"R","":"R","":"r","":"r","":"r","":"S","":"S","":"S","":"S","":"s","":"s","":"s","":"s","":"T","":"T","":"T","":"t","":"t","":"t","":"U","":"U","":"U","":"U","":"U","":"U","":"u","":"u","":"u","":"u","":"u","":"u","":"W","":"w","":"Y","":"y","":"Y","":"Z","":"Z","":"Z","":"z","":"z","":"z","":"IJ","":"ij","":"Oe","":"oe","":"'n","":"s"},htmlEscapes={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},htmlUnescapes={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},stringEscapes={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},freeParseFloat=parseFloat,freeParseInt=parseInt,freeGlobal="object"==typeof global&&global&&global.Object===Object&&global,freeSelf="object"==typeof self&&self&&self.Object===Object&&self,root=freeGlobal||freeSelf||Function("return this")(),freeExports="object"==typeof exports&&exports&&!exports.nodeType&&exports,freeModule=freeExports&&"object"==typeof module&&module&&!module.nodeType&&module,moduleExports=freeModule&&freeModule.exports===freeExports,freeProcess=moduleExports&&freeGlobal.process,nodeUtil=function(){try{var types=freeModule&&freeModule.require&&freeModule.require("util").types;return types?types:freeProcess&&freeProcess.binding&&freeProcess.binding("util")}catch(e){}}(),nodeIsArrayBuffer=nodeUtil&&nodeUtil.isArrayBuffer,nodeIsDate=nodeUtil&&nodeUtil.isDate,nodeIsMap=nodeUtil&&nodeUtil.isMap,nodeIsRegExp=nodeUtil&&nodeUtil.isRegExp,nodeIsSet=nodeUtil&&nodeUtil.isSet,nodeIsTypedArray=nodeUtil&&nodeUtil.isTypedArray,asciiSize=baseProperty("length"),deburrLetter=basePropertyOf(deburredLetters),escapeHtmlChar=basePropertyOf(htmlEscapes),unescapeHtmlChar=basePropertyOf(htmlUnescapes),runInContext=function runInContext(context){function lodash(value){if(isObjectLike(value)&&!isArray(value)&&!(value instanceof LazyWrapper)){if(value instanceof LodashWrapper)return value;if(hasOwnProperty.call(value,"__wrapped__"))return wrapperClone(value)}return new LodashWrapper(value)}function baseLodash(){}function LodashWrapper(value,chainAll){this.__wrapped__=value,this.__actions__=[],this.__chain__=!!chainAll,this.__index__=0,this.__values__=undefined}function LazyWrapper(value){this.__wrapped__=value,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=MAX_ARRAY_LENGTH,this.__views__=[]}function lazyClone(){var result=new LazyWrapper(this.__wrapped__);return result.__actions__=copyArray(this.__actions__),result.__dir__=this.__dir__,result.__filtered__=this.__filtered__,result.__iteratees__=copyArray(this.__iteratees__),result.__takeCount__=this.__takeCount__,result.__views__=copyArray(this.__views__),result}function lazyReverse(){if(this.__filtered__){var result=new LazyWrapper(this);result.__dir__=-1,result.__filtered__=!0}else result=this.clone(),result.__dir__*=-1;return result}function lazyValue(){var array=this.__wrapped__.value(),dir=this.__dir__,isArr=isArray(array),isRight=dir<0,arrLength=isArr?array.length:0,view=getView(0,arrLength,this.__views__),start=view.start,end=view.end,length=end-start,index=isRight?end:start-1,iteratees=this.__iteratees__,iterLength=iteratees.length,resIndex=0,takeCount=nativeMin(length,this.__takeCount__);if(!isArr||!isRight&&arrLength==length&&takeCount==length)return baseWrapperValue(array,this.__actions__);var result=[];outer:for(;length--&&resIndex<takeCount;){index+=dir;for(var iterIndex=-1,value=array[index];++iterIndex<iterLength;){var data=iteratees[iterIndex],iteratee=data.iteratee,type=data.type,computed=iteratee(value);if(type==LAZY_MAP_FLAG)value=computed;else if(!computed){if(type==LAZY_FILTER_FLAG)continue outer;break outer}}result[resIndex++]=value}return result}function Hash(entries){var index=-1,length=null==entries?0:entries.length;for(this.clear();++index<length;){var entry=entries[index];this.set(entry[0],entry[1])}}function hashClear(){this.__data__=nativeCreate?nativeCreate(null):{},this.size=0}function hashDelete(key){var result=this.has(key)&&delete this.__data__[key];return this.size-=result?1:0,result}function hashGet(key){var data=this.__data__;if(nativeCreate){var result=data[key];return result===HASH_UNDEFINED?undefined:result}return hasOwnProperty.call(data,key)?data[key]:undefined}function hashHas(key){var data=this.__data__;return nativeCreate?data[key]!==undefined:hasOwnProperty.call(data,key)}function hashSet(key,value){var data=this.__data__;return this.size+=this.has(key)?0:1,data[key]=nativeCreate&&value===undefined?HASH_UNDEFINED:value,this}function ListCache(entries){var index=-1,length=null==entries?0:entries.length;for(this.clear();++index<length;){var entry=entries[index];this.set(entry[0],entry[1])}}function listCacheClear(){this.__data__=[],this.size=0}function listCacheDelete(key){var data=this.__data__,index=assocIndexOf(data,key);if(index<0)return!1;var lastIndex=data.length-1;return index==lastIndex?data.pop():splice.call(data,index,1),--this.size,!0}function listCacheGet(key){var data=this.__data__,index=assocIndexOf(data,key);return index<0?undefined:data[index][1]}function listCacheHas(key){return assocIndexOf(this.__data__,key)>-1}function listCacheSet(key,value){var data=this.__data__,index=assocIndexOf(data,key);return index<0?(++this.size,data.push([key,value])):data[index][1]=value,this}function MapCache(entries){var index=-1,length=null==entries?0:entries.length;for(this.clear();++index<length;){var entry=entries[index];this.set(entry[0],entry[1])}}function mapCacheClear(){this.size=0,this.__data__={hash:new Hash,map:new(Map||ListCache),string:new Hash}}function mapCacheDelete(key){var result=getMapData(this,key)["delete"](key);return this.size-=result?1:0,result}function mapCacheGet(key){return getMapData(this,key).get(key)}function mapCacheHas(key){return getMapData(this,key).has(key)}function mapCacheSet(key,value){var data=getMapData(this,key),size=data.size;return data.set(key,value),this.size+=data.size==size?0:1,this}function SetCache(values){var index=-1,length=null==values?0:values.length;for(this.__data__=new MapCache;++index<length;)this.add(values[index])}function setCacheAdd(value){return this.__data__.set(value,HASH_UNDEFINED),this}function setCacheHas(value){return this.__data__.has(value)}function Stack(entries){var data=this.__data__=new ListCache(entries);this.size=data.size}function stackClear(){this.__data__=new ListCache,this.size=0}function stackDelete(key){var data=this.__data__,result=data["delete"](key);return this.size=data.size,result}function stackGet(key){return this.__data__.get(key)}function stackHas(key){return this.__data__.has(key)}function stackSet(key,value){var data=this.__data__;if(data instanceof ListCache){var pairs=data.__data__;if(!Map||pairs.length<LARGE_ARRAY_SIZE-1)return pairs.push([key,value]),this.size=++data.size,this;data=this.__data__=new MapCache(pairs)}return data.set(key,value),this.size=data.size,this}function arrayLikeKeys(value,inherited){var isArr=isArray(value),isArg=!isArr&&isArguments(value),isBuff=!isArr&&!isArg&&isBuffer(value),isType=!isArr&&!isArg&&!isBuff&&isTypedArray(value),skipIndexes=isArr||isArg||isBuff||isType,result=skipIndexes?baseTimes(value.length,String):[],length=result.length;for(var key in value)!inherited&&!hasOwnProperty.call(value,key)||skipIndexes&&("length"==key||isBuff&&("offset"==key||"parent"==key)||isType&&("buffer"==key||"byteLength"==key||"byteOffset"==key)||isIndex(key,length))||result.push(key);return result}function arraySample(array){var length=array.length;return length?array[baseRandom(0,length-1)]:undefined}function arraySampleSize(array,n){return shuffleSelf(copyArray(array),baseClamp(n,0,array.length))}function arrayShuffle(array){return shuffleSelf(copyArray(array))}function assignMergeValue(object,key,value){(value===undefined||eq(object[key],value))&&(value!==undefined||key in object)||baseAssignValue(object,key,value)}function assignValue(object,key,value){var objValue=object[key];hasOwnProperty.call(object,key)&&eq(objValue,value)&&(value!==undefined||key in object)||baseAssignValue(object,key,value)}function assocIndexOf(array,key){for(var length=array.length;length--;)if(eq(array[length][0],key))return length;return-1}function baseAggregator(collection,setter,iteratee,accumulator){return baseEach(collection,function(value,key,collection){setter(accumulator,value,iteratee(value),collection)}),accumulator}function baseAssign(object,source){return object&&copyObject(source,keys(source),object)}function baseAssignIn(object,source){return object&&copyObject(source,keysIn(source),object)}function baseAssignValue(object,key,value){"__proto__"==key&&defineProperty?defineProperty(object,key,{configurable:!0,enumerable:!0,value:value,writable:!0}):object[key]=value}function baseAt(object,paths){for(var index=-1,length=paths.length,result=Array(length),skip=null==object;++index<length;)result[index]=skip?undefined:get(object,paths[index]);return result}function baseClamp(number,lower,upper){return number===number&&(upper!==undefined&&(number=number<=upper?number:upper),lower!==undefined&&(number=number>=lower?number:lower)),number}function baseClone(value,bitmask,customizer,key,object,stack){var result,isDeep=bitmask&CLONE_DEEP_FLAG,isFlat=bitmask&CLONE_FLAT_FLAG,isFull=bitmask&CLONE_SYMBOLS_FLAG;if(customizer&&(result=object?customizer(value,key,object,stack):customizer(value)),result!==undefined)return result;if(!isObject(value))return value;var isArr=isArray(value);if(isArr){if(result=initCloneArray(value),!isDeep)return copyArray(value,result)}else{var tag=getTag(value),isFunc=tag==funcTag||tag==genTag;if(isBuffer(value))return cloneBuffer(value,isDeep);if(tag==objectTag||tag==argsTag||isFunc&&!object){if(result=isFlat||isFunc?{}:initCloneObject(value),!isDeep)return isFlat?copySymbolsIn(value,baseAssignIn(result,value)):copySymbols(value,baseAssign(result,value))}else{if(!cloneableTags[tag])return object?value:{};result=initCloneByTag(value,tag,isDeep)}}stack||(stack=new Stack);var stacked=stack.get(value);if(stacked)return stacked;if(stack.set(value,result),isSet(value))return value.forEach(function(subValue){result.add(baseClone(subValue,bitmask,customizer,subValue,value,stack))}),result;if(isMap(value))return value.forEach(function(subValue,key){result.set(key,baseClone(subValue,bitmask,customizer,key,value,stack))}),result;var keysFunc=isFull?isFlat?getAllKeysIn:getAllKeys:isFlat?keysIn:keys,props=isArr?undefined:keysFunc(value);return arrayEach(props||value,function(subValue,key){props&&(key=subValue,subValue=value[key]),assignValue(result,key,baseClone(subValue,bitmask,customizer,key,value,stack))}),result}function baseConforms(source){var props=keys(source);return function(object){return baseConformsTo(object,source,props)}}function baseConformsTo(object,source,props){var length=props.length;if(null==object)return!length;for(object=Object(object);length--;){var key=props[length],predicate=source[key],value=object[key];if(value===undefined&&!(key in object)||!predicate(value))return!1}return!0}function baseDelay(func,wait,args){if("function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);return setTimeout(function(){func.apply(undefined,args)},wait)}function baseDifference(array,values,iteratee,comparator){var index=-1,includes=arrayIncludes,isCommon=!0,length=array.length,result=[],valuesLength=values.length;if(!length)return result;iteratee&&(values=arrayMap(values,baseUnary(iteratee))),comparator?(includes=arrayIncludesWith,isCommon=!1):values.length>=LARGE_ARRAY_SIZE&&(includes=cacheHas,isCommon=!1,values=new SetCache(values));
outer:for(;++index<length;){var value=array[index],computed=null==iteratee?value:iteratee(value);if(value=comparator||0!==value?value:0,isCommon&&computed===computed){for(var valuesIndex=valuesLength;valuesIndex--;)if(values[valuesIndex]===computed)continue outer;result.push(value)}else includes(values,computed,comparator)||result.push(value)}return result}function baseEvery(collection,predicate){var result=!0;return baseEach(collection,function(value,index,collection){return result=!!predicate(value,index,collection)}),result}function baseExtremum(array,iteratee,comparator){for(var index=-1,length=array.length;++index<length;){var value=array[index],current=iteratee(value);if(null!=current&&(computed===undefined?current===current&&!isSymbol(current):comparator(current,computed)))var computed=current,result=value}return result}function baseFill(array,value,start,end){var length=array.length;for(start=toInteger(start),start<0&&(start=-start>length?0:length+start),end=end===undefined||end>length?length:toInteger(end),end<0&&(end+=length),end=start>end?0:toLength(end);start<end;)array[start++]=value;return array}function baseFilter(collection,predicate){var result=[];return baseEach(collection,function(value,index,collection){predicate(value,index,collection)&&result.push(value)}),result}function baseFlatten(array,depth,predicate,isStrict,result){var index=-1,length=array.length;for(predicate||(predicate=isFlattenable),result||(result=[]);++index<length;){var value=array[index];depth>0&&predicate(value)?depth>1?baseFlatten(value,depth-1,predicate,isStrict,result):arrayPush(result,value):isStrict||(result[result.length]=value)}return result}function baseForOwn(object,iteratee){return object&&baseFor(object,iteratee,keys)}function baseForOwnRight(object,iteratee){return object&&baseForRight(object,iteratee,keys)}function baseFunctions(object,props){return arrayFilter(props,function(key){return isFunction(object[key])})}function baseGet(object,path){path=castPath(path,object);for(var index=0,length=path.length;null!=object&&index<length;)object=object[toKey(path[index++])];return index&&index==length?object:undefined}function baseGetAllKeys(object,keysFunc,symbolsFunc){var result=keysFunc(object);return isArray(object)?result:arrayPush(result,symbolsFunc(object))}function baseGetTag(value){return null==value?value===undefined?undefinedTag:nullTag:symToStringTag&&symToStringTag in Object(value)?getRawTag(value):objectToString(value)}function baseGt(value,other){return value>other}function baseHas(object,key){return null!=object&&hasOwnProperty.call(object,key)}function baseHasIn(object,key){return null!=object&&key in Object(object)}function baseInRange(number,start,end){return number>=nativeMin(start,end)&&number<nativeMax(start,end)}function baseIntersection(arrays,iteratee,comparator){for(var includes=comparator?arrayIncludesWith:arrayIncludes,length=arrays[0].length,othLength=arrays.length,othIndex=othLength,caches=Array(othLength),maxLength=1/0,result=[];othIndex--;){var array=arrays[othIndex];othIndex&&iteratee&&(array=arrayMap(array,baseUnary(iteratee))),maxLength=nativeMin(array.length,maxLength),caches[othIndex]=!comparator&&(iteratee||length>=120&&array.length>=120)?new SetCache(othIndex&&array):undefined}array=arrays[0];var index=-1,seen=caches[0];outer:for(;++index<length&&result.length<maxLength;){var value=array[index],computed=iteratee?iteratee(value):value;if(value=comparator||0!==value?value:0,!(seen?cacheHas(seen,computed):includes(result,computed,comparator))){for(othIndex=othLength;--othIndex;){var cache=caches[othIndex];if(!(cache?cacheHas(cache,computed):includes(arrays[othIndex],computed,comparator)))continue outer}seen&&seen.push(computed),result.push(value)}}return result}function baseInverter(object,setter,iteratee,accumulator){return baseForOwn(object,function(value,key,object){setter(accumulator,iteratee(value),key,object)}),accumulator}function baseInvoke(object,path,args){path=castPath(path,object),object=parent(object,path);var func=null==object?object:object[toKey(last(path))];return null==func?undefined:apply(func,object,args)}function baseIsArguments(value){return isObjectLike(value)&&baseGetTag(value)==argsTag}function baseIsArrayBuffer(value){return isObjectLike(value)&&baseGetTag(value)==arrayBufferTag}function baseIsDate(value){return isObjectLike(value)&&baseGetTag(value)==dateTag}function baseIsEqual(value,other,bitmask,customizer,stack){return value===other||(null==value||null==other||!isObjectLike(value)&&!isObjectLike(other)?value!==value&&other!==other:baseIsEqualDeep(value,other,bitmask,customizer,baseIsEqual,stack))}function baseIsEqualDeep(object,other,bitmask,customizer,equalFunc,stack){var objIsArr=isArray(object),othIsArr=isArray(other),objTag=objIsArr?arrayTag:getTag(object),othTag=othIsArr?arrayTag:getTag(other);objTag=objTag==argsTag?objectTag:objTag,othTag=othTag==argsTag?objectTag:othTag;var objIsObj=objTag==objectTag,othIsObj=othTag==objectTag,isSameTag=objTag==othTag;if(isSameTag&&isBuffer(object)){if(!isBuffer(other))return!1;objIsArr=!0,objIsObj=!1}if(isSameTag&&!objIsObj)return stack||(stack=new Stack),objIsArr||isTypedArray(object)?equalArrays(object,other,bitmask,customizer,equalFunc,stack):equalByTag(object,other,objTag,bitmask,customizer,equalFunc,stack);if(!(bitmask&COMPARE_PARTIAL_FLAG)){var objIsWrapped=objIsObj&&hasOwnProperty.call(object,"__wrapped__"),othIsWrapped=othIsObj&&hasOwnProperty.call(other,"__wrapped__");if(objIsWrapped||othIsWrapped){var objUnwrapped=objIsWrapped?object.value():object,othUnwrapped=othIsWrapped?other.value():other;return stack||(stack=new Stack),equalFunc(objUnwrapped,othUnwrapped,bitmask,customizer,stack)}}return!!isSameTag&&(stack||(stack=new Stack),equalObjects(object,other,bitmask,customizer,equalFunc,stack))}function baseIsMap(value){return isObjectLike(value)&&getTag(value)==mapTag}function baseIsMatch(object,source,matchData,customizer){var index=matchData.length,length=index,noCustomizer=!customizer;if(null==object)return!length;for(object=Object(object);index--;){var data=matchData[index];if(noCustomizer&&data[2]?data[1]!==object[data[0]]:!(data[0]in object))return!1}for(;++index<length;){data=matchData[index];var key=data[0],objValue=object[key],srcValue=data[1];if(noCustomizer&&data[2]){if(objValue===undefined&&!(key in object))return!1}else{var stack=new Stack;if(customizer)var result=customizer(objValue,srcValue,key,object,source,stack);if(!(result===undefined?baseIsEqual(srcValue,objValue,COMPARE_PARTIAL_FLAG|COMPARE_UNORDERED_FLAG,customizer,stack):result))return!1}}return!0}function baseIsNative(value){if(!isObject(value)||isMasked(value))return!1;var pattern=isFunction(value)?reIsNative:reIsHostCtor;return pattern.test(toSource(value))}function baseIsRegExp(value){return isObjectLike(value)&&baseGetTag(value)==regexpTag}function baseIsSet(value){return isObjectLike(value)&&getTag(value)==setTag}function baseIsTypedArray(value){return isObjectLike(value)&&isLength(value.length)&&!!typedArrayTags[baseGetTag(value)]}function baseIteratee(value){return"function"==typeof value?value:null==value?identity:"object"==typeof value?isArray(value)?baseMatchesProperty(value[0],value[1]):baseMatches(value):property(value)}function baseKeys(object){if(!isPrototype(object))return nativeKeys(object);var result=[];for(var key in Object(object))hasOwnProperty.call(object,key)&&"constructor"!=key&&result.push(key);return result}function baseKeysIn(object){if(!isObject(object))return nativeKeysIn(object);var isProto=isPrototype(object),result=[];for(var key in object)("constructor"!=key||!isProto&&hasOwnProperty.call(object,key))&&result.push(key);return result}function baseLt(value,other){return value<other}function baseMap(collection,iteratee){var index=-1,result=isArrayLike(collection)?Array(collection.length):[];return baseEach(collection,function(value,key,collection){result[++index]=iteratee(value,key,collection)}),result}function baseMatches(source){var matchData=getMatchData(source);return 1==matchData.length&&matchData[0][2]?matchesStrictComparable(matchData[0][0],matchData[0][1]):function(object){return object===source||baseIsMatch(object,source,matchData)}}function baseMatchesProperty(path,srcValue){return isKey(path)&&isStrictComparable(srcValue)?matchesStrictComparable(toKey(path),srcValue):function(object){var objValue=get(object,path);return objValue===undefined&&objValue===srcValue?hasIn(object,path):baseIsEqual(srcValue,objValue,COMPARE_PARTIAL_FLAG|COMPARE_UNORDERED_FLAG)}}function baseMerge(object,source,srcIndex,customizer,stack){object!==source&&baseFor(source,function(srcValue,key){if(isObject(srcValue))stack||(stack=new Stack),baseMergeDeep(object,source,key,srcIndex,baseMerge,customizer,stack);else{var newValue=customizer?customizer(safeGet(object,key),srcValue,key+"",object,source,stack):undefined;newValue===undefined&&(newValue=srcValue),assignMergeValue(object,key,newValue)}},keysIn)}function baseMergeDeep(object,source,key,srcIndex,mergeFunc,customizer,stack){var objValue=safeGet(object,key),srcValue=safeGet(source,key),stacked=stack.get(srcValue);if(stacked)return void assignMergeValue(object,key,stacked);var newValue=customizer?customizer(objValue,srcValue,key+"",object,source,stack):undefined,isCommon=newValue===undefined;if(isCommon){var isArr=isArray(srcValue),isBuff=!isArr&&isBuffer(srcValue),isTyped=!isArr&&!isBuff&&isTypedArray(srcValue);newValue=srcValue,isArr||isBuff||isTyped?isArray(objValue)?newValue=objValue:isArrayLikeObject(objValue)?newValue=copyArray(objValue):isBuff?(isCommon=!1,newValue=cloneBuffer(srcValue,!0)):isTyped?(isCommon=!1,newValue=cloneTypedArray(srcValue,!0)):newValue=[]:isPlainObject(srcValue)||isArguments(srcValue)?(newValue=objValue,isArguments(objValue)?newValue=toPlainObject(objValue):(!isObject(objValue)||srcIndex&&isFunction(objValue))&&(newValue=initCloneObject(srcValue))):isCommon=!1}isCommon&&(stack.set(srcValue,newValue),mergeFunc(newValue,srcValue,srcIndex,customizer,stack),stack["delete"](srcValue)),assignMergeValue(object,key,newValue)}function baseNth(array,n){var length=array.length;if(length)return n+=n<0?length:0,isIndex(n,length)?array[n]:undefined}function baseOrderBy(collection,iteratees,orders){var index=-1;iteratees=arrayMap(iteratees.length?iteratees:[identity],baseUnary(getIteratee()));var result=baseMap(collection,function(value,key,collection){var criteria=arrayMap(iteratees,function(iteratee){return iteratee(value)});return{criteria:criteria,index:++index,value:value}});return baseSortBy(result,function(object,other){return compareMultiple(object,other,orders)})}function basePick(object,paths){return basePickBy(object,paths,function(value,path){return hasIn(object,path)})}function basePickBy(object,paths,predicate){for(var index=-1,length=paths.length,result={};++index<length;){var path=paths[index],value=baseGet(object,path);predicate(value,path)&&baseSet(result,castPath(path,object),value)}return result}function basePropertyDeep(path){return function(object){return baseGet(object,path)}}function basePullAll(array,values,iteratee,comparator){var indexOf=comparator?baseIndexOfWith:baseIndexOf,index=-1,length=values.length,seen=array;for(array===values&&(values=copyArray(values)),iteratee&&(seen=arrayMap(array,baseUnary(iteratee)));++index<length;)for(var fromIndex=0,value=values[index],computed=iteratee?iteratee(value):value;(fromIndex=indexOf(seen,computed,fromIndex,comparator))>-1;)seen!==array&&splice.call(seen,fromIndex,1),splice.call(array,fromIndex,1);return array}function basePullAt(array,indexes){for(var length=array?indexes.length:0,lastIndex=length-1;length--;){var index=indexes[length];if(length==lastIndex||index!==previous){var previous=index;isIndex(index)?splice.call(array,index,1):baseUnset(array,index)}}return array}function baseRandom(lower,upper){return lower+nativeFloor(nativeRandom()*(upper-lower+1))}function baseRange(start,end,step,fromRight){for(var index=-1,length=nativeMax(nativeCeil((end-start)/(step||1)),0),result=Array(length);length--;)result[fromRight?length:++index]=start,start+=step;return result}function baseRepeat(string,n){var result="";if(!string||n<1||n>MAX_SAFE_INTEGER)return result;do n%2&&(result+=string),n=nativeFloor(n/2),n&&(string+=string);while(n);return result}function baseRest(func,start){return setToString(overRest(func,start,identity),func+"")}function baseSample(collection){return arraySample(values(collection))}function baseSampleSize(collection,n){var array=values(collection);return shuffleSelf(array,baseClamp(n,0,array.length))}function baseSet(object,path,value,customizer){if(!isObject(object))return object;path=castPath(path,object);for(var index=-1,length=path.length,lastIndex=length-1,nested=object;null!=nested&&++index<length;){var key=toKey(path[index]),newValue=value;if(index!=lastIndex){var objValue=nested[key];newValue=customizer?customizer(objValue,key,nested):undefined,newValue===undefined&&(newValue=isObject(objValue)?objValue:isIndex(path[index+1])?[]:{})}assignValue(nested,key,newValue),nested=nested[key]}return object}function baseShuffle(collection){return shuffleSelf(values(collection))}function baseSlice(array,start,end){var index=-1,length=array.length;start<0&&(start=-start>length?0:length+start),end=end>length?length:end,end<0&&(end+=length),length=start>end?0:end-start>>>0,start>>>=0;for(var result=Array(length);++index<length;)result[index]=array[index+start];return result}function baseSome(collection,predicate){var result;return baseEach(collection,function(value,index,collection){return result=predicate(value,index,collection),!result}),!!result}function baseSortedIndex(array,value,retHighest){var low=0,high=null==array?low:array.length;if("number"==typeof value&&value===value&&high<=HALF_MAX_ARRAY_LENGTH){for(;low<high;){var mid=low+high>>>1,computed=array[mid];null!==computed&&!isSymbol(computed)&&(retHighest?computed<=value:computed<value)?low=mid+1:high=mid}return high}return baseSortedIndexBy(array,value,identity,retHighest)}function baseSortedIndexBy(array,value,iteratee,retHighest){value=iteratee(value);for(var low=0,high=null==array?0:array.length,valIsNaN=value!==value,valIsNull=null===value,valIsSymbol=isSymbol(value),valIsUndefined=value===undefined;low<high;){var mid=nativeFloor((low+high)/2),computed=iteratee(array[mid]),othIsDefined=computed!==undefined,othIsNull=null===computed,othIsReflexive=computed===computed,othIsSymbol=isSymbol(computed);if(valIsNaN)var setLow=retHighest||othIsReflexive;else setLow=valIsUndefined?othIsReflexive&&(retHighest||othIsDefined):valIsNull?othIsReflexive&&othIsDefined&&(retHighest||!othIsNull):valIsSymbol?othIsReflexive&&othIsDefined&&!othIsNull&&(retHighest||!othIsSymbol):!othIsNull&&!othIsSymbol&&(retHighest?computed<=value:computed<value);setLow?low=mid+1:high=mid}return nativeMin(high,MAX_ARRAY_INDEX)}function baseSortedUniq(array,iteratee){for(var index=-1,length=array.length,resIndex=0,result=[];++index<length;){var value=array[index],computed=iteratee?iteratee(value):value;if(!index||!eq(computed,seen)){var seen=computed;result[resIndex++]=0===value?0:value}}return result}function baseToNumber(value){return"number"==typeof value?value:isSymbol(value)?NAN:+value}function baseToString(value){if("string"==typeof value)return value;if(isArray(value))return arrayMap(value,baseToString)+"";if(isSymbol(value))return symbolToString?symbolToString.call(value):"";var result=value+"";return"0"==result&&1/value==-INFINITY?"-0":result}function baseUniq(array,iteratee,comparator){var index=-1,includes=arrayIncludes,length=array.length,isCommon=!0,result=[],seen=result;if(comparator)isCommon=!1,includes=arrayIncludesWith;else if(length>=LARGE_ARRAY_SIZE){var set=iteratee?null:createSet(array);if(set)return setToArray(set);isCommon=!1,includes=cacheHas,seen=new SetCache}else seen=iteratee?[]:result;outer:for(;++index<length;){var value=array[index],computed=iteratee?iteratee(value):value;if(value=comparator||0!==value?value:0,isCommon&&computed===computed){for(var seenIndex=seen.length;seenIndex--;)if(seen[seenIndex]===computed)continue outer;iteratee&&seen.push(computed),result.push(value)}else includes(seen,computed,comparator)||(seen!==result&&seen.push(computed),result.push(value))}return result}function baseUnset(object,path){return path=castPath(path,object),object=parent(object,path),null==object||delete object[toKey(last(path))]}function baseUpdate(object,path,updater,customizer){return baseSet(object,path,updater(baseGet(object,path)),customizer)}function baseWhile(array,predicate,isDrop,fromRight){for(var length=array.length,index=fromRight?length:-1;(fromRight?index--:++index<length)&&predicate(array[index],index,array););return isDrop?baseSlice(array,fromRight?0:index,fromRight?index+1:length):baseSlice(array,fromRight?index+1:0,fromRight?length:index)}function baseWrapperValue(value,actions){var result=value;return result instanceof LazyWrapper&&(result=result.value()),arrayReduce(actions,function(result,action){return action.func.apply(action.thisArg,arrayPush([result],action.args))},result)}function baseXor(arrays,iteratee,comparator){var length=arrays.length;if(length<2)return length?baseUniq(arrays[0]):[];for(var index=-1,result=Array(length);++index<length;)for(var array=arrays[index],othIndex=-1;++othIndex<length;)othIndex!=index&&(result[index]=baseDifference(result[index]||array,arrays[othIndex],iteratee,comparator));return baseUniq(baseFlatten(result,1),iteratee,comparator)}function baseZipObject(props,values,assignFunc){for(var index=-1,length=props.length,valsLength=values.length,result={};++index<length;){var value=index<valsLength?values[index]:undefined;assignFunc(result,props[index],value)}return result}function castArrayLikeObject(value){return isArrayLikeObject(value)?value:[]}function castFunction(value){return"function"==typeof value?value:identity}function castPath(value,object){return isArray(value)?value:isKey(value,object)?[value]:stringToPath(toString(value))}function castSlice(array,start,end){var length=array.length;return end=end===undefined?length:end,!start&&end>=length?array:baseSlice(array,start,end)}function cloneBuffer(buffer,isDeep){if(isDeep)return buffer.slice();var length=buffer.length,result=allocUnsafe?allocUnsafe(length):new buffer.constructor(length);return buffer.copy(result),result}function cloneArrayBuffer(arrayBuffer){var result=new arrayBuffer.constructor(arrayBuffer.byteLength);return new Uint8Array(result).set(new Uint8Array(arrayBuffer)),result}function cloneDataView(dataView,isDeep){var buffer=isDeep?cloneArrayBuffer(dataView.buffer):dataView.buffer;return new dataView.constructor(buffer,dataView.byteOffset,dataView.byteLength)}function cloneRegExp(regexp){var result=new regexp.constructor(regexp.source,reFlags.exec(regexp));return result.lastIndex=regexp.lastIndex,result}function cloneSymbol(symbol){return symbolValueOf?Object(symbolValueOf.call(symbol)):{}}function cloneTypedArray(typedArray,isDeep){var buffer=isDeep?cloneArrayBuffer(typedArray.buffer):typedArray.buffer;return new typedArray.constructor(buffer,typedArray.byteOffset,typedArray.length)}function compareAscending(value,other){if(value!==other){var valIsDefined=value!==undefined,valIsNull=null===value,valIsReflexive=value===value,valIsSymbol=isSymbol(value),othIsDefined=other!==undefined,othIsNull=null===other,othIsReflexive=other===other,othIsSymbol=isSymbol(other);if(!othIsNull&&!othIsSymbol&&!valIsSymbol&&value>other||valIsSymbol&&othIsDefined&&othIsReflexive&&!othIsNull&&!othIsSymbol||valIsNull&&othIsDefined&&othIsReflexive||!valIsDefined&&othIsReflexive||!valIsReflexive)return 1;if(!valIsNull&&!valIsSymbol&&!othIsSymbol&&value<other||othIsSymbol&&valIsDefined&&valIsReflexive&&!valIsNull&&!valIsSymbol||othIsNull&&valIsDefined&&valIsReflexive||!othIsDefined&&valIsReflexive||!othIsReflexive)return-1}return 0}function compareMultiple(object,other,orders){for(var index=-1,objCriteria=object.criteria,othCriteria=other.criteria,length=objCriteria.length,ordersLength=orders.length;++index<length;){var result=compareAscending(objCriteria[index],othCriteria[index]);if(result){if(index>=ordersLength)return result;var order=orders[index];return result*("desc"==order?-1:1)}}return object.index-other.index}function composeArgs(args,partials,holders,isCurried){for(var argsIndex=-1,argsLength=args.length,holdersLength=holders.length,leftIndex=-1,leftLength=partials.length,rangeLength=nativeMax(argsLength-holdersLength,0),result=Array(leftLength+rangeLength),isUncurried=!isCurried;++leftIndex<leftLength;)result[leftIndex]=partials[leftIndex];for(;++argsIndex<holdersLength;)(isUncurried||argsIndex<argsLength)&&(result[holders[argsIndex]]=args[argsIndex]);for(;rangeLength--;)result[leftIndex++]=args[argsIndex++];return result}function composeArgsRight(args,partials,holders,isCurried){for(var argsIndex=-1,argsLength=args.length,holdersIndex=-1,holdersLength=holders.length,rightIndex=-1,rightLength=partials.length,rangeLength=nativeMax(argsLength-holdersLength,0),result=Array(rangeLength+rightLength),isUncurried=!isCurried;++argsIndex<rangeLength;)result[argsIndex]=args[argsIndex];for(var offset=argsIndex;++rightIndex<rightLength;)result[offset+rightIndex]=partials[rightIndex];for(;++holdersIndex<holdersLength;)(isUncurried||argsIndex<argsLength)&&(result[offset+holders[holdersIndex]]=args[argsIndex++]);return result}function copyArray(source,array){var index=-1,length=source.length;for(array||(array=Array(length));++index<length;)array[index]=source[index];return array}function copyObject(source,props,object,customizer){var isNew=!object;object||(object={});for(var index=-1,length=props.length;++index<length;){var key=props[index],newValue=customizer?customizer(object[key],source[key],key,object,source):undefined;newValue===undefined&&(newValue=source[key]),isNew?baseAssignValue(object,key,newValue):assignValue(object,key,newValue)}return object}function copySymbols(source,object){return copyObject(source,getSymbols(source),object)}function copySymbolsIn(source,object){return copyObject(source,getSymbolsIn(source),object)}function createAggregator(setter,initializer){return function(collection,iteratee){var func=isArray(collection)?arrayAggregator:baseAggregator,accumulator=initializer?initializer():{};return func(collection,setter,getIteratee(iteratee,2),accumulator)}}function createAssigner(assigner){return baseRest(function(object,sources){var index=-1,length=sources.length,customizer=length>1?sources[length-1]:undefined,guard=length>2?sources[2]:undefined;for(customizer=assigner.length>3&&"function"==typeof customizer?(length--,customizer):undefined,guard&&isIterateeCall(sources[0],sources[1],guard)&&(customizer=length<3?undefined:customizer,length=1),object=Object(object);++index<length;){var source=sources[index];source&&assigner(object,source,index,customizer)}return object})}function createBaseEach(eachFunc,fromRight){return function(collection,iteratee){if(null==collection)return collection;if(!isArrayLike(collection))return eachFunc(collection,iteratee);for(var length=collection.length,index=fromRight?length:-1,iterable=Object(collection);(fromRight?index--:++index<length)&&iteratee(iterable[index],index,iterable)!==!1;);return collection}}function createBaseFor(fromRight){return function(object,iteratee,keysFunc){for(var index=-1,iterable=Object(object),props=keysFunc(object),length=props.length;length--;){var key=props[fromRight?length:++index];if(iteratee(iterable[key],key,iterable)===!1)break}return object}}function createBind(func,bitmask,thisArg){function wrapper(){var fn=this&&this!==root&&this instanceof wrapper?Ctor:func;return fn.apply(isBind?thisArg:this,arguments)}var isBind=bitmask&WRAP_BIND_FLAG,Ctor=createCtor(func);return wrapper}function createCaseFirst(methodName){return function(string){string=toString(string);var strSymbols=hasUnicode(string)?stringToArray(string):undefined,chr=strSymbols?strSymbols[0]:string.charAt(0),trailing=strSymbols?castSlice(strSymbols,1).join(""):string.slice(1);return chr[methodName]()+trailing}}function createCompounder(callback){return function(string){return arrayReduce(words(deburr(string).replace(reApos,"")),callback,"")}}function createCtor(Ctor){return function(){var args=arguments;switch(args.length){case 0:return new Ctor;case 1:return new Ctor(args[0]);case 2:return new Ctor(args[0],args[1]);case 3:return new Ctor(args[0],args[1],args[2]);case 4:return new Ctor(args[0],args[1],args[2],args[3]);case 5:return new Ctor(args[0],args[1],args[2],args[3],args[4]);case 6:return new Ctor(args[0],args[1],args[2],args[3],args[4],args[5]);case 7:return new Ctor(args[0],args[1],args[2],args[3],args[4],args[5],args[6])}var thisBinding=baseCreate(Ctor.prototype),result=Ctor.apply(thisBinding,args);return isObject(result)?result:thisBinding}}function createCurry(func,bitmask,arity){function wrapper(){for(var length=arguments.length,args=Array(length),index=length,placeholder=getHolder(wrapper);index--;)args[index]=arguments[index];var holders=length<3&&args[0]!==placeholder&&args[length-1]!==placeholder?[]:replaceHolders(args,placeholder);if(length-=holders.length,length<arity)return createRecurry(func,bitmask,createHybrid,wrapper.placeholder,undefined,args,holders,undefined,undefined,arity-length);var fn=this&&this!==root&&this instanceof wrapper?Ctor:func;return apply(fn,this,args)}var Ctor=createCtor(func);return wrapper}function createFind(findIndexFunc){return function(collection,predicate,fromIndex){var iterable=Object(collection);if(!isArrayLike(collection)){var iteratee=getIteratee(predicate,3);collection=keys(collection),predicate=function(key){return iteratee(iterable[key],key,iterable)}}var index=findIndexFunc(collection,predicate,fromIndex);return index>-1?iterable[iteratee?collection[index]:index]:undefined}}function createFlow(fromRight){return flatRest(function(funcs){var length=funcs.length,index=length,prereq=LodashWrapper.prototype.thru;for(fromRight&&funcs.reverse();index--;){var func=funcs[index];if("function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);if(prereq&&!wrapper&&"wrapper"==getFuncName(func))var wrapper=new LodashWrapper([],(!0))}for(index=wrapper?index:length;++index<length;){func=funcs[index];var funcName=getFuncName(func),data="wrapper"==funcName?getData(func):undefined;wrapper=data&&isLaziable(data[0])&&data[1]==(WRAP_ARY_FLAG|WRAP_CURRY_FLAG|WRAP_PARTIAL_FLAG|WRAP_REARG_FLAG)&&!data[4].length&&1==data[9]?wrapper[getFuncName(data[0])].apply(wrapper,data[3]):1==func.length&&isLaziable(func)?wrapper[funcName]():wrapper.thru(func)}return function(){var args=arguments,value=args[0];if(wrapper&&1==args.length&&isArray(value))return wrapper.plant(value).value();for(var index=0,result=length?funcs[index].apply(this,args):value;++index<length;)result=funcs[index].call(this,result);return result}})}function createHybrid(func,bitmask,thisArg,partials,holders,partialsRight,holdersRight,argPos,ary,arity){function wrapper(){for(var length=arguments.length,args=Array(length),index=length;index--;)args[index]=arguments[index];if(isCurried)var placeholder=getHolder(wrapper),holdersCount=countHolders(args,placeholder);if(partials&&(args=composeArgs(args,partials,holders,isCurried)),partialsRight&&(args=composeArgsRight(args,partialsRight,holdersRight,isCurried)),length-=holdersCount,isCurried&&length<arity){var newHolders=replaceHolders(args,placeholder);return createRecurry(func,bitmask,createHybrid,wrapper.placeholder,thisArg,args,newHolders,argPos,ary,arity-length)}var thisBinding=isBind?thisArg:this,fn=isBindKey?thisBinding[func]:func;return length=args.length,argPos?args=reorder(args,argPos):isFlip&&length>1&&args.reverse(),isAry&&ary<length&&(args.length=ary),this&&this!==root&&this instanceof wrapper&&(fn=Ctor||createCtor(fn)),fn.apply(thisBinding,args)}var isAry=bitmask&WRAP_ARY_FLAG,isBind=bitmask&WRAP_BIND_FLAG,isBindKey=bitmask&WRAP_BIND_KEY_FLAG,isCurried=bitmask&(WRAP_CURRY_FLAG|WRAP_CURRY_RIGHT_FLAG),isFlip=bitmask&WRAP_FLIP_FLAG,Ctor=isBindKey?undefined:createCtor(func);return wrapper}function createInverter(setter,toIteratee){return function(object,iteratee){return baseInverter(object,setter,toIteratee(iteratee),{})}}function createMathOperation(operator,defaultValue){return function(value,other){var result;if(value===undefined&&other===undefined)return defaultValue;if(value!==undefined&&(result=value),other!==undefined){if(result===undefined)return other;"string"==typeof value||"string"==typeof other?(value=baseToString(value),other=baseToString(other)):(value=baseToNumber(value),other=baseToNumber(other)),result=operator(value,other)}return result}}function createOver(arrayFunc){return flatRest(function(iteratees){return iteratees=arrayMap(iteratees,baseUnary(getIteratee())),baseRest(function(args){var thisArg=this;return arrayFunc(iteratees,function(iteratee){return apply(iteratee,thisArg,args)})})})}function createPadding(length,chars){chars=chars===undefined?" ":baseToString(chars);var charsLength=chars.length;if(charsLength<2)return charsLength?baseRepeat(chars,length):chars;var result=baseRepeat(chars,nativeCeil(length/stringSize(chars)));return hasUnicode(chars)?castSlice(stringToArray(result),0,length).join(""):result.slice(0,length)}function createPartial(func,bitmask,thisArg,partials){function wrapper(){for(var argsIndex=-1,argsLength=arguments.length,leftIndex=-1,leftLength=partials.length,args=Array(leftLength+argsLength),fn=this&&this!==root&&this instanceof wrapper?Ctor:func;++leftIndex<leftLength;)args[leftIndex]=partials[leftIndex];for(;argsLength--;)args[leftIndex++]=arguments[++argsIndex];return apply(fn,isBind?thisArg:this,args)}var isBind=bitmask&WRAP_BIND_FLAG,Ctor=createCtor(func);return wrapper}function createRange(fromRight){return function(start,end,step){return step&&"number"!=typeof step&&isIterateeCall(start,end,step)&&(end=step=undefined),start=toFinite(start),end===undefined?(end=start,start=0):end=toFinite(end),step=step===undefined?start<end?1:-1:toFinite(step),baseRange(start,end,step,fromRight)}}function createRelationalOperation(operator){return function(value,other){return"string"==typeof value&&"string"==typeof other||(value=toNumber(value),other=toNumber(other)),operator(value,other)}}function createRecurry(func,bitmask,wrapFunc,placeholder,thisArg,partials,holders,argPos,ary,arity){var isCurry=bitmask&WRAP_CURRY_FLAG,newHolders=isCurry?holders:undefined,newHoldersRight=isCurry?undefined:holders,newPartials=isCurry?partials:undefined,newPartialsRight=isCurry?undefined:partials;bitmask|=isCurry?WRAP_PARTIAL_FLAG:WRAP_PARTIAL_RIGHT_FLAG,bitmask&=~(isCurry?WRAP_PARTIAL_RIGHT_FLAG:WRAP_PARTIAL_FLAG),bitmask&WRAP_CURRY_BOUND_FLAG||(bitmask&=~(WRAP_BIND_FLAG|WRAP_BIND_KEY_FLAG));var newData=[func,bitmask,thisArg,newPartials,newHolders,newPartialsRight,newHoldersRight,argPos,ary,arity],result=wrapFunc.apply(undefined,newData);return isLaziable(func)&&setData(result,newData),result.placeholder=placeholder,setWrapToString(result,func,bitmask)}function createRound(methodName){var func=Math[methodName];return function(number,precision){if(number=toNumber(number),precision=null==precision?0:nativeMin(toInteger(precision),292)){var pair=(toString(number)+"e").split("e"),value=func(pair[0]+"e"+(+pair[1]+precision));return pair=(toString(value)+"e").split("e"),+(pair[0]+"e"+(+pair[1]-precision))}return func(number)}}function createToPairs(keysFunc){return function(object){var tag=getTag(object);return tag==mapTag?mapToArray(object):tag==setTag?setToPairs(object):baseToPairs(object,keysFunc(object))}}function createWrap(func,bitmask,thisArg,partials,holders,argPos,ary,arity){var isBindKey=bitmask&WRAP_BIND_KEY_FLAG;if(!isBindKey&&"function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);var length=partials?partials.length:0;if(length||(bitmask&=~(WRAP_PARTIAL_FLAG|WRAP_PARTIAL_RIGHT_FLAG),partials=holders=undefined),ary=ary===undefined?ary:nativeMax(toInteger(ary),0),arity=arity===undefined?arity:toInteger(arity),
length-=holders?holders.length:0,bitmask&WRAP_PARTIAL_RIGHT_FLAG){var partialsRight=partials,holdersRight=holders;partials=holders=undefined}var data=isBindKey?undefined:getData(func),newData=[func,bitmask,thisArg,partials,holders,partialsRight,holdersRight,argPos,ary,arity];if(data&&mergeData(newData,data),func=newData[0],bitmask=newData[1],thisArg=newData[2],partials=newData[3],holders=newData[4],arity=newData[9]=newData[9]===undefined?isBindKey?0:func.length:nativeMax(newData[9]-length,0),!arity&&bitmask&(WRAP_CURRY_FLAG|WRAP_CURRY_RIGHT_FLAG)&&(bitmask&=~(WRAP_CURRY_FLAG|WRAP_CURRY_RIGHT_FLAG)),bitmask&&bitmask!=WRAP_BIND_FLAG)result=bitmask==WRAP_CURRY_FLAG||bitmask==WRAP_CURRY_RIGHT_FLAG?createCurry(func,bitmask,arity):bitmask!=WRAP_PARTIAL_FLAG&&bitmask!=(WRAP_BIND_FLAG|WRAP_PARTIAL_FLAG)||holders.length?createHybrid.apply(undefined,newData):createPartial(func,bitmask,thisArg,partials);else var result=createBind(func,bitmask,thisArg);var setter=data?baseSetData:setData;return setWrapToString(setter(result,newData),func,bitmask)}function customDefaultsAssignIn(objValue,srcValue,key,object){return objValue===undefined||eq(objValue,objectProto[key])&&!hasOwnProperty.call(object,key)?srcValue:objValue}function customDefaultsMerge(objValue,srcValue,key,object,source,stack){return isObject(objValue)&&isObject(srcValue)&&(stack.set(srcValue,objValue),baseMerge(objValue,srcValue,undefined,customDefaultsMerge,stack),stack["delete"](srcValue)),objValue}function customOmitClone(value){return isPlainObject(value)?undefined:value}function equalArrays(array,other,bitmask,customizer,equalFunc,stack){var isPartial=bitmask&COMPARE_PARTIAL_FLAG,arrLength=array.length,othLength=other.length;if(arrLength!=othLength&&!(isPartial&&othLength>arrLength))return!1;var stacked=stack.get(array);if(stacked&&stack.get(other))return stacked==other;var index=-1,result=!0,seen=bitmask&COMPARE_UNORDERED_FLAG?new SetCache:undefined;for(stack.set(array,other),stack.set(other,array);++index<arrLength;){var arrValue=array[index],othValue=other[index];if(customizer)var compared=isPartial?customizer(othValue,arrValue,index,other,array,stack):customizer(arrValue,othValue,index,array,other,stack);if(compared!==undefined){if(compared)continue;result=!1;break}if(seen){if(!arraySome(other,function(othValue,othIndex){if(!cacheHas(seen,othIndex)&&(arrValue===othValue||equalFunc(arrValue,othValue,bitmask,customizer,stack)))return seen.push(othIndex)})){result=!1;break}}else if(arrValue!==othValue&&!equalFunc(arrValue,othValue,bitmask,customizer,stack)){result=!1;break}}return stack["delete"](array),stack["delete"](other),result}function equalByTag(object,other,tag,bitmask,customizer,equalFunc,stack){switch(tag){case dataViewTag:if(object.byteLength!=other.byteLength||object.byteOffset!=other.byteOffset)return!1;object=object.buffer,other=other.buffer;case arrayBufferTag:return!(object.byteLength!=other.byteLength||!equalFunc(new Uint8Array(object),new Uint8Array(other)));case boolTag:case dateTag:case numberTag:return eq(+object,+other);case errorTag:return object.name==other.name&&object.message==other.message;case regexpTag:case stringTag:return object==other+"";case mapTag:var convert=mapToArray;case setTag:var isPartial=bitmask&COMPARE_PARTIAL_FLAG;if(convert||(convert=setToArray),object.size!=other.size&&!isPartial)return!1;var stacked=stack.get(object);if(stacked)return stacked==other;bitmask|=COMPARE_UNORDERED_FLAG,stack.set(object,other);var result=equalArrays(convert(object),convert(other),bitmask,customizer,equalFunc,stack);return stack["delete"](object),result;case symbolTag:if(symbolValueOf)return symbolValueOf.call(object)==symbolValueOf.call(other)}return!1}function equalObjects(object,other,bitmask,customizer,equalFunc,stack){var isPartial=bitmask&COMPARE_PARTIAL_FLAG,objProps=getAllKeys(object),objLength=objProps.length,othProps=getAllKeys(other),othLength=othProps.length;if(objLength!=othLength&&!isPartial)return!1;for(var index=objLength;index--;){var key=objProps[index];if(!(isPartial?key in other:hasOwnProperty.call(other,key)))return!1}var stacked=stack.get(object);if(stacked&&stack.get(other))return stacked==other;var result=!0;stack.set(object,other),stack.set(other,object);for(var skipCtor=isPartial;++index<objLength;){key=objProps[index];var objValue=object[key],othValue=other[key];if(customizer)var compared=isPartial?customizer(othValue,objValue,key,other,object,stack):customizer(objValue,othValue,key,object,other,stack);if(!(compared===undefined?objValue===othValue||equalFunc(objValue,othValue,bitmask,customizer,stack):compared)){result=!1;break}skipCtor||(skipCtor="constructor"==key)}if(result&&!skipCtor){var objCtor=object.constructor,othCtor=other.constructor;objCtor!=othCtor&&"constructor"in object&&"constructor"in other&&!("function"==typeof objCtor&&objCtor instanceof objCtor&&"function"==typeof othCtor&&othCtor instanceof othCtor)&&(result=!1)}return stack["delete"](object),stack["delete"](other),result}function flatRest(func){return setToString(overRest(func,undefined,flatten),func+"")}function getAllKeys(object){return baseGetAllKeys(object,keys,getSymbols)}function getAllKeysIn(object){return baseGetAllKeys(object,keysIn,getSymbolsIn)}function getFuncName(func){for(var result=func.name+"",array=realNames[result],length=hasOwnProperty.call(realNames,result)?array.length:0;length--;){var data=array[length],otherFunc=data.func;if(null==otherFunc||otherFunc==func)return data.name}return result}function getHolder(func){var object=hasOwnProperty.call(lodash,"placeholder")?lodash:func;return object.placeholder}function getIteratee(){var result=lodash.iteratee||iteratee;return result=result===iteratee?baseIteratee:result,arguments.length?result(arguments[0],arguments[1]):result}function getMapData(map,key){var data=map.__data__;return isKeyable(key)?data["string"==typeof key?"string":"hash"]:data.map}function getMatchData(object){for(var result=keys(object),length=result.length;length--;){var key=result[length],value=object[key];result[length]=[key,value,isStrictComparable(value)]}return result}function getNative(object,key){var value=getValue(object,key);return baseIsNative(value)?value:undefined}function getRawTag(value){var isOwn=hasOwnProperty.call(value,symToStringTag),tag=value[symToStringTag];try{value[symToStringTag]=undefined;var unmasked=!0}catch(e){}var result=nativeObjectToString.call(value);return unmasked&&(isOwn?value[symToStringTag]=tag:delete value[symToStringTag]),result}function getView(start,end,transforms){for(var index=-1,length=transforms.length;++index<length;){var data=transforms[index],size=data.size;switch(data.type){case"drop":start+=size;break;case"dropRight":end-=size;break;case"take":end=nativeMin(end,start+size);break;case"takeRight":start=nativeMax(start,end-size)}}return{start:start,end:end}}function getWrapDetails(source){var match=source.match(reWrapDetails);return match?match[1].split(reSplitDetails):[]}function hasPath(object,path,hasFunc){path=castPath(path,object);for(var index=-1,length=path.length,result=!1;++index<length;){var key=toKey(path[index]);if(!(result=null!=object&&hasFunc(object,key)))break;object=object[key]}return result||++index!=length?result:(length=null==object?0:object.length,!!length&&isLength(length)&&isIndex(key,length)&&(isArray(object)||isArguments(object)))}function initCloneArray(array){var length=array.length,result=new array.constructor(length);return length&&"string"==typeof array[0]&&hasOwnProperty.call(array,"index")&&(result.index=array.index,result.input=array.input),result}function initCloneObject(object){return"function"!=typeof object.constructor||isPrototype(object)?{}:baseCreate(getPrototype(object))}function initCloneByTag(object,tag,isDeep){var Ctor=object.constructor;switch(tag){case arrayBufferTag:return cloneArrayBuffer(object);case boolTag:case dateTag:return new Ctor((+object));case dataViewTag:return cloneDataView(object,isDeep);case float32Tag:case float64Tag:case int8Tag:case int16Tag:case int32Tag:case uint8Tag:case uint8ClampedTag:case uint16Tag:case uint32Tag:return cloneTypedArray(object,isDeep);case mapTag:return new Ctor;case numberTag:case stringTag:return new Ctor(object);case regexpTag:return cloneRegExp(object);case setTag:return new Ctor;case symbolTag:return cloneSymbol(object)}}function insertWrapDetails(source,details){var length=details.length;if(!length)return source;var lastIndex=length-1;return details[lastIndex]=(length>1?"& ":"")+details[lastIndex],details=details.join(length>2?", ":" "),source.replace(reWrapComment,"{\n/* [wrapped with "+details+"] */\n")}function isFlattenable(value){return isArray(value)||isArguments(value)||!!(spreadableSymbol&&value&&value[spreadableSymbol])}function isIndex(value,length){var type=typeof value;return length=null==length?MAX_SAFE_INTEGER:length,!!length&&("number"==type||"symbol"!=type&&reIsUint.test(value))&&value>-1&&value%1==0&&value<length}function isIterateeCall(value,index,object){if(!isObject(object))return!1;var type=typeof index;return!!("number"==type?isArrayLike(object)&&isIndex(index,object.length):"string"==type&&index in object)&&eq(object[index],value)}function isKey(value,object){if(isArray(value))return!1;var type=typeof value;return!("number"!=type&&"symbol"!=type&&"boolean"!=type&&null!=value&&!isSymbol(value))||(reIsPlainProp.test(value)||!reIsDeepProp.test(value)||null!=object&&value in Object(object))}function isKeyable(value){var type=typeof value;return"string"==type||"number"==type||"symbol"==type||"boolean"==type?"__proto__"!==value:null===value}function isLaziable(func){var funcName=getFuncName(func),other=lodash[funcName];if("function"!=typeof other||!(funcName in LazyWrapper.prototype))return!1;if(func===other)return!0;var data=getData(other);return!!data&&func===data[0]}function isMasked(func){return!!maskSrcKey&&maskSrcKey in func}function isPrototype(value){var Ctor=value&&value.constructor,proto="function"==typeof Ctor&&Ctor.prototype||objectProto;return value===proto}function isStrictComparable(value){return value===value&&!isObject(value)}function matchesStrictComparable(key,srcValue){return function(object){return null!=object&&(object[key]===srcValue&&(srcValue!==undefined||key in Object(object)))}}function memoizeCapped(func){var result=memoize(func,function(key){return cache.size===MAX_MEMOIZE_SIZE&&cache.clear(),key}),cache=result.cache;return result}function mergeData(data,source){var bitmask=data[1],srcBitmask=source[1],newBitmask=bitmask|srcBitmask,isCommon=newBitmask<(WRAP_BIND_FLAG|WRAP_BIND_KEY_FLAG|WRAP_ARY_FLAG),isCombo=srcBitmask==WRAP_ARY_FLAG&&bitmask==WRAP_CURRY_FLAG||srcBitmask==WRAP_ARY_FLAG&&bitmask==WRAP_REARG_FLAG&&data[7].length<=source[8]||srcBitmask==(WRAP_ARY_FLAG|WRAP_REARG_FLAG)&&source[7].length<=source[8]&&bitmask==WRAP_CURRY_FLAG;if(!isCommon&&!isCombo)return data;srcBitmask&WRAP_BIND_FLAG&&(data[2]=source[2],newBitmask|=bitmask&WRAP_BIND_FLAG?0:WRAP_CURRY_BOUND_FLAG);var value=source[3];if(value){var partials=data[3];data[3]=partials?composeArgs(partials,value,source[4]):value,data[4]=partials?replaceHolders(data[3],PLACEHOLDER):source[4]}return value=source[5],value&&(partials=data[5],data[5]=partials?composeArgsRight(partials,value,source[6]):value,data[6]=partials?replaceHolders(data[5],PLACEHOLDER):source[6]),value=source[7],value&&(data[7]=value),srcBitmask&WRAP_ARY_FLAG&&(data[8]=null==data[8]?source[8]:nativeMin(data[8],source[8])),null==data[9]&&(data[9]=source[9]),data[0]=source[0],data[1]=newBitmask,data}function nativeKeysIn(object){var result=[];if(null!=object)for(var key in Object(object))result.push(key);return result}function objectToString(value){return nativeObjectToString.call(value)}function overRest(func,start,transform){return start=nativeMax(start===undefined?func.length-1:start,0),function(){for(var args=arguments,index=-1,length=nativeMax(args.length-start,0),array=Array(length);++index<length;)array[index]=args[start+index];index=-1;for(var otherArgs=Array(start+1);++index<start;)otherArgs[index]=args[index];return otherArgs[start]=transform(array),apply(func,this,otherArgs)}}function parent(object,path){return path.length<2?object:baseGet(object,baseSlice(path,0,-1))}function reorder(array,indexes){for(var arrLength=array.length,length=nativeMin(indexes.length,arrLength),oldArray=copyArray(array);length--;){var index=indexes[length];array[length]=isIndex(index,arrLength)?oldArray[index]:undefined}return array}function setWrapToString(wrapper,reference,bitmask){var source=reference+"";return setToString(wrapper,insertWrapDetails(source,updateWrapDetails(getWrapDetails(source),bitmask)))}function shortOut(func){var count=0,lastCalled=0;return function(){var stamp=nativeNow(),remaining=HOT_SPAN-(stamp-lastCalled);if(lastCalled=stamp,remaining>0){if(++count>=HOT_COUNT)return arguments[0]}else count=0;return func.apply(undefined,arguments)}}function shuffleSelf(array,size){var index=-1,length=array.length,lastIndex=length-1;for(size=size===undefined?length:size;++index<size;){var rand=baseRandom(index,lastIndex),value=array[rand];array[rand]=array[index],array[index]=value}return array.length=size,array}function toKey(value){if("string"==typeof value||isSymbol(value))return value;var result=value+"";return"0"==result&&1/value==-INFINITY?"-0":result}function toSource(func){if(null!=func){try{return funcToString.call(func)}catch(e){}try{return func+""}catch(e){}}return""}function updateWrapDetails(details,bitmask){return arrayEach(wrapFlags,function(pair){var value="_."+pair[0];bitmask&pair[1]&&!arrayIncludes(details,value)&&details.push(value)}),details.sort()}function wrapperClone(wrapper){if(wrapper instanceof LazyWrapper)return wrapper.clone();var result=new LodashWrapper(wrapper.__wrapped__,wrapper.__chain__);return result.__actions__=copyArray(wrapper.__actions__),result.__index__=wrapper.__index__,result.__values__=wrapper.__values__,result}function chunk(array,size,guard){size=(guard?isIterateeCall(array,size,guard):size===undefined)?1:nativeMax(toInteger(size),0);var length=null==array?0:array.length;if(!length||size<1)return[];for(var index=0,resIndex=0,result=Array(nativeCeil(length/size));index<length;)result[resIndex++]=baseSlice(array,index,index+=size);return result}function compact(array){for(var index=-1,length=null==array?0:array.length,resIndex=0,result=[];++index<length;){var value=array[index];value&&(result[resIndex++]=value)}return result}function concat(){var length=arguments.length;if(!length)return[];for(var args=Array(length-1),array=arguments[0],index=length;index--;)args[index-1]=arguments[index];return arrayPush(isArray(array)?copyArray(array):[array],baseFlatten(args,1))}function drop(array,n,guard){var length=null==array?0:array.length;return length?(n=guard||n===undefined?1:toInteger(n),baseSlice(array,n<0?0:n,length)):[]}function dropRight(array,n,guard){var length=null==array?0:array.length;return length?(n=guard||n===undefined?1:toInteger(n),n=length-n,baseSlice(array,0,n<0?0:n)):[]}function dropRightWhile(array,predicate){return array&&array.length?baseWhile(array,getIteratee(predicate,3),!0,!0):[]}function dropWhile(array,predicate){return array&&array.length?baseWhile(array,getIteratee(predicate,3),!0):[]}function fill(array,value,start,end){var length=null==array?0:array.length;return length?(start&&"number"!=typeof start&&isIterateeCall(array,value,start)&&(start=0,end=length),baseFill(array,value,start,end)):[]}function findIndex(array,predicate,fromIndex){var length=null==array?0:array.length;if(!length)return-1;var index=null==fromIndex?0:toInteger(fromIndex);return index<0&&(index=nativeMax(length+index,0)),baseFindIndex(array,getIteratee(predicate,3),index)}function findLastIndex(array,predicate,fromIndex){var length=null==array?0:array.length;if(!length)return-1;var index=length-1;return fromIndex!==undefined&&(index=toInteger(fromIndex),index=fromIndex<0?nativeMax(length+index,0):nativeMin(index,length-1)),baseFindIndex(array,getIteratee(predicate,3),index,!0)}function flatten(array){var length=null==array?0:array.length;return length?baseFlatten(array,1):[]}function flattenDeep(array){var length=null==array?0:array.length;return length?baseFlatten(array,INFINITY):[]}function flattenDepth(array,depth){var length=null==array?0:array.length;return length?(depth=depth===undefined?1:toInteger(depth),baseFlatten(array,depth)):[]}function fromPairs(pairs){for(var index=-1,length=null==pairs?0:pairs.length,result={};++index<length;){var pair=pairs[index];result[pair[0]]=pair[1]}return result}function head(array){return array&&array.length?array[0]:undefined}function indexOf(array,value,fromIndex){var length=null==array?0:array.length;if(!length)return-1;var index=null==fromIndex?0:toInteger(fromIndex);return index<0&&(index=nativeMax(length+index,0)),baseIndexOf(array,value,index)}function initial(array){var length=null==array?0:array.length;return length?baseSlice(array,0,-1):[]}function join(array,separator){return null==array?"":nativeJoin.call(array,separator)}function last(array){var length=null==array?0:array.length;return length?array[length-1]:undefined}function lastIndexOf(array,value,fromIndex){var length=null==array?0:array.length;if(!length)return-1;var index=length;return fromIndex!==undefined&&(index=toInteger(fromIndex),index=index<0?nativeMax(length+index,0):nativeMin(index,length-1)),value===value?strictLastIndexOf(array,value,index):baseFindIndex(array,baseIsNaN,index,!0)}function nth(array,n){return array&&array.length?baseNth(array,toInteger(n)):undefined}function pullAll(array,values){return array&&array.length&&values&&values.length?basePullAll(array,values):array}function pullAllBy(array,values,iteratee){return array&&array.length&&values&&values.length?basePullAll(array,values,getIteratee(iteratee,2)):array}function pullAllWith(array,values,comparator){return array&&array.length&&values&&values.length?basePullAll(array,values,undefined,comparator):array}function remove(array,predicate){var result=[];if(!array||!array.length)return result;var index=-1,indexes=[],length=array.length;for(predicate=getIteratee(predicate,3);++index<length;){var value=array[index];predicate(value,index,array)&&(result.push(value),indexes.push(index))}return basePullAt(array,indexes),result}function reverse(array){return null==array?array:nativeReverse.call(array)}function slice(array,start,end){var length=null==array?0:array.length;return length?(end&&"number"!=typeof end&&isIterateeCall(array,start,end)?(start=0,end=length):(start=null==start?0:toInteger(start),end=end===undefined?length:toInteger(end)),baseSlice(array,start,end)):[]}function sortedIndex(array,value){return baseSortedIndex(array,value)}function sortedIndexBy(array,value,iteratee){return baseSortedIndexBy(array,value,getIteratee(iteratee,2))}function sortedIndexOf(array,value){var length=null==array?0:array.length;if(length){var index=baseSortedIndex(array,value);if(index<length&&eq(array[index],value))return index}return-1}function sortedLastIndex(array,value){return baseSortedIndex(array,value,!0)}function sortedLastIndexBy(array,value,iteratee){return baseSortedIndexBy(array,value,getIteratee(iteratee,2),!0)}function sortedLastIndexOf(array,value){var length=null==array?0:array.length;if(length){var index=baseSortedIndex(array,value,!0)-1;if(eq(array[index],value))return index}return-1}function sortedUniq(array){return array&&array.length?baseSortedUniq(array):[]}function sortedUniqBy(array,iteratee){return array&&array.length?baseSortedUniq(array,getIteratee(iteratee,2)):[]}function tail(array){var length=null==array?0:array.length;return length?baseSlice(array,1,length):[]}function take(array,n,guard){return array&&array.length?(n=guard||n===undefined?1:toInteger(n),baseSlice(array,0,n<0?0:n)):[]}function takeRight(array,n,guard){var length=null==array?0:array.length;return length?(n=guard||n===undefined?1:toInteger(n),n=length-n,baseSlice(array,n<0?0:n,length)):[]}function takeRightWhile(array,predicate){return array&&array.length?baseWhile(array,getIteratee(predicate,3),!1,!0):[]}function takeWhile(array,predicate){return array&&array.length?baseWhile(array,getIteratee(predicate,3)):[]}function uniq(array){return array&&array.length?baseUniq(array):[]}function uniqBy(array,iteratee){return array&&array.length?baseUniq(array,getIteratee(iteratee,2)):[]}function uniqWith(array,comparator){return comparator="function"==typeof comparator?comparator:undefined,array&&array.length?baseUniq(array,undefined,comparator):[]}function unzip(array){if(!array||!array.length)return[];var length=0;return array=arrayFilter(array,function(group){if(isArrayLikeObject(group))return length=nativeMax(group.length,length),!0}),baseTimes(length,function(index){return arrayMap(array,baseProperty(index))})}function unzipWith(array,iteratee){if(!array||!array.length)return[];var result=unzip(array);return null==iteratee?result:arrayMap(result,function(group){return apply(iteratee,undefined,group)})}function zipObject(props,values){return baseZipObject(props||[],values||[],assignValue)}function zipObjectDeep(props,values){return baseZipObject(props||[],values||[],baseSet)}function chain(value){var result=lodash(value);return result.__chain__=!0,result}function tap(value,interceptor){return interceptor(value),value}function thru(value,interceptor){return interceptor(value)}function wrapperChain(){return chain(this)}function wrapperCommit(){return new LodashWrapper(this.value(),this.__chain__)}function wrapperNext(){this.__values__===undefined&&(this.__values__=toArray(this.value()));var done=this.__index__>=this.__values__.length,value=done?undefined:this.__values__[this.__index__++];return{done:done,value:value}}function wrapperToIterator(){return this}function wrapperPlant(value){for(var result,parent=this;parent instanceof baseLodash;){var clone=wrapperClone(parent);clone.__index__=0,clone.__values__=undefined,result?previous.__wrapped__=clone:result=clone;var previous=clone;parent=parent.__wrapped__}return previous.__wrapped__=value,result}function wrapperReverse(){var value=this.__wrapped__;if(value instanceof LazyWrapper){var wrapped=value;return this.__actions__.length&&(wrapped=new LazyWrapper(this)),wrapped=wrapped.reverse(),wrapped.__actions__.push({func:thru,args:[reverse],thisArg:undefined}),new LodashWrapper(wrapped,this.__chain__)}return this.thru(reverse)}function wrapperValue(){return baseWrapperValue(this.__wrapped__,this.__actions__)}function every(collection,predicate,guard){var func=isArray(collection)?arrayEvery:baseEvery;return guard&&isIterateeCall(collection,predicate,guard)&&(predicate=undefined),func(collection,getIteratee(predicate,3))}function filter(collection,predicate){var func=isArray(collection)?arrayFilter:baseFilter;return func(collection,getIteratee(predicate,3))}function flatMap(collection,iteratee){return baseFlatten(map(collection,iteratee),1)}function flatMapDeep(collection,iteratee){return baseFlatten(map(collection,iteratee),INFINITY)}function flatMapDepth(collection,iteratee,depth){return depth=depth===undefined?1:toInteger(depth),baseFlatten(map(collection,iteratee),depth)}function forEach(collection,iteratee){var func=isArray(collection)?arrayEach:baseEach;return func(collection,getIteratee(iteratee,3))}function forEachRight(collection,iteratee){var func=isArray(collection)?arrayEachRight:baseEachRight;return func(collection,getIteratee(iteratee,3))}function includes(collection,value,fromIndex,guard){collection=isArrayLike(collection)?collection:values(collection),fromIndex=fromIndex&&!guard?toInteger(fromIndex):0;var length=collection.length;return fromIndex<0&&(fromIndex=nativeMax(length+fromIndex,0)),isString(collection)?fromIndex<=length&&collection.indexOf(value,fromIndex)>-1:!!length&&baseIndexOf(collection,value,fromIndex)>-1}function map(collection,iteratee){var func=isArray(collection)?arrayMap:baseMap;return func(collection,getIteratee(iteratee,3))}function orderBy(collection,iteratees,orders,guard){return null==collection?[]:(isArray(iteratees)||(iteratees=null==iteratees?[]:[iteratees]),orders=guard?undefined:orders,isArray(orders)||(orders=null==orders?[]:[orders]),baseOrderBy(collection,iteratees,orders))}function reduce(collection,iteratee,accumulator){var func=isArray(collection)?arrayReduce:baseReduce,initAccum=arguments.length<3;return func(collection,getIteratee(iteratee,4),accumulator,initAccum,baseEach)}function reduceRight(collection,iteratee,accumulator){var func=isArray(collection)?arrayReduceRight:baseReduce,initAccum=arguments.length<3;return func(collection,getIteratee(iteratee,4),accumulator,initAccum,baseEachRight)}function reject(collection,predicate){var func=isArray(collection)?arrayFilter:baseFilter;return func(collection,negate(getIteratee(predicate,3)))}function sample(collection){var func=isArray(collection)?arraySample:baseSample;return func(collection)}function sampleSize(collection,n,guard){n=(guard?isIterateeCall(collection,n,guard):n===undefined)?1:toInteger(n);var func=isArray(collection)?arraySampleSize:baseSampleSize;return func(collection,n)}function shuffle(collection){var func=isArray(collection)?arrayShuffle:baseShuffle;return func(collection)}function size(collection){if(null==collection)return 0;if(isArrayLike(collection))return isString(collection)?stringSize(collection):collection.length;var tag=getTag(collection);return tag==mapTag||tag==setTag?collection.size:baseKeys(collection).length}function some(collection,predicate,guard){var func=isArray(collection)?arraySome:baseSome;return guard&&isIterateeCall(collection,predicate,guard)&&(predicate=undefined),func(collection,getIteratee(predicate,3))}function after(n,func){if("function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);return n=toInteger(n),function(){if(--n<1)return func.apply(this,arguments)}}function ary(func,n,guard){return n=guard?undefined:n,n=func&&null==n?func.length:n,createWrap(func,WRAP_ARY_FLAG,undefined,undefined,undefined,undefined,n)}function before(n,func){var result;if("function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);return n=toInteger(n),function(){return--n>0&&(result=func.apply(this,arguments)),n<=1&&(func=undefined),result}}function curry(func,arity,guard){arity=guard?undefined:arity;var result=createWrap(func,WRAP_CURRY_FLAG,undefined,undefined,undefined,undefined,undefined,arity);return result.placeholder=curry.placeholder,result}function curryRight(func,arity,guard){arity=guard?undefined:arity;var result=createWrap(func,WRAP_CURRY_RIGHT_FLAG,undefined,undefined,undefined,undefined,undefined,arity);return result.placeholder=curryRight.placeholder,result}function debounce(func,wait,options){function invokeFunc(time){var args=lastArgs,thisArg=lastThis;return lastArgs=lastThis=undefined,lastInvokeTime=time,result=func.apply(thisArg,args)}function leadingEdge(time){return lastInvokeTime=time,timerId=setTimeout(timerExpired,wait),leading?invokeFunc(time):result}function remainingWait(time){var timeSinceLastCall=time-lastCallTime,timeSinceLastInvoke=time-lastInvokeTime,timeWaiting=wait-timeSinceLastCall;return maxing?nativeMin(timeWaiting,maxWait-timeSinceLastInvoke):timeWaiting}function shouldInvoke(time){var timeSinceLastCall=time-lastCallTime,timeSinceLastInvoke=time-lastInvokeTime;return lastCallTime===undefined||timeSinceLastCall>=wait||timeSinceLastCall<0||maxing&&timeSinceLastInvoke>=maxWait}function timerExpired(){var time=now();return shouldInvoke(time)?trailingEdge(time):void(timerId=setTimeout(timerExpired,remainingWait(time)))}function trailingEdge(time){return timerId=undefined,trailing&&lastArgs?invokeFunc(time):(lastArgs=lastThis=undefined,result)}function cancel(){timerId!==undefined&&clearTimeout(timerId),lastInvokeTime=0,lastArgs=lastCallTime=lastThis=timerId=undefined}function flush(){return timerId===undefined?result:trailingEdge(now())}function debounced(){var time=now(),isInvoking=shouldInvoke(time);if(lastArgs=arguments,lastThis=this,lastCallTime=time,isInvoking){if(timerId===undefined)return leadingEdge(lastCallTime);if(maxing)return timerId=setTimeout(timerExpired,wait),invokeFunc(lastCallTime)}return timerId===undefined&&(timerId=setTimeout(timerExpired,wait)),result}var lastArgs,lastThis,maxWait,result,timerId,lastCallTime,lastInvokeTime=0,leading=!1,maxing=!1,trailing=!0;if("function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);return wait=toNumber(wait)||0,isObject(options)&&(leading=!!options.leading,maxing="maxWait"in options,maxWait=maxing?nativeMax(toNumber(options.maxWait)||0,wait):maxWait,trailing="trailing"in options?!!options.trailing:trailing),debounced.cancel=cancel,debounced.flush=flush,debounced}function flip(func){return createWrap(func,WRAP_FLIP_FLAG)}function memoize(func,resolver){if("function"!=typeof func||null!=resolver&&"function"!=typeof resolver)throw new TypeError(FUNC_ERROR_TEXT);var memoized=function(){var args=arguments,key=resolver?resolver.apply(this,args):args[0],cache=memoized.cache;if(cache.has(key))return cache.get(key);var result=func.apply(this,args);return memoized.cache=cache.set(key,result)||cache,result};return memoized.cache=new(memoize.Cache||MapCache),memoized}function negate(predicate){if("function"!=typeof predicate)throw new TypeError(FUNC_ERROR_TEXT);return function(){var args=arguments;switch(args.length){case 0:return!predicate.call(this);case 1:return!predicate.call(this,args[0]);case 2:return!predicate.call(this,args[0],args[1]);case 3:return!predicate.call(this,args[0],args[1],args[2])}return!predicate.apply(this,args)}}function once(func){return before(2,func)}function rest(func,start){if("function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);return start=start===undefined?start:toInteger(start),baseRest(func,start)}function spread(func,start){if("function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);return start=null==start?0:nativeMax(toInteger(start),0),baseRest(function(args){var array=args[start],otherArgs=castSlice(args,0,start);return array&&arrayPush(otherArgs,array),apply(func,this,otherArgs)})}function throttle(func,wait,options){var leading=!0,trailing=!0;if("function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);return isObject(options)&&(leading="leading"in options?!!options.leading:leading,trailing="trailing"in options?!!options.trailing:trailing),debounce(func,wait,{leading:leading,maxWait:wait,trailing:trailing})}function unary(func){return ary(func,1)}function wrap(value,wrapper){return partial(castFunction(wrapper),value)}function castArray(){if(!arguments.length)return[];var value=arguments[0];return isArray(value)?value:[value]}function clone(value){return baseClone(value,CLONE_SYMBOLS_FLAG)}function cloneWith(value,customizer){return customizer="function"==typeof customizer?customizer:undefined,baseClone(value,CLONE_SYMBOLS_FLAG,customizer)}function cloneDeep(value){return baseClone(value,CLONE_DEEP_FLAG|CLONE_SYMBOLS_FLAG)}function cloneDeepWith(value,customizer){return customizer="function"==typeof customizer?customizer:undefined,baseClone(value,CLONE_DEEP_FLAG|CLONE_SYMBOLS_FLAG,customizer)}function conformsTo(object,source){return null==source||baseConformsTo(object,source,keys(source))}function eq(value,other){return value===other||value!==value&&other!==other}function isArrayLike(value){return null!=value&&isLength(value.length)&&!isFunction(value)}function isArrayLikeObject(value){return isObjectLike(value)&&isArrayLike(value)}function isBoolean(value){return value===!0||value===!1||isObjectLike(value)&&baseGetTag(value)==boolTag}function isElement(value){return isObjectLike(value)&&1===value.nodeType&&!isPlainObject(value)}function isEmpty(value){if(null==value)return!0;if(isArrayLike(value)&&(isArray(value)||"string"==typeof value||"function"==typeof value.splice||isBuffer(value)||isTypedArray(value)||isArguments(value)))return!value.length;var tag=getTag(value);if(tag==mapTag||tag==setTag)return!value.size;if(isPrototype(value))return!baseKeys(value).length;
for(var key in value)if(hasOwnProperty.call(value,key))return!1;return!0}function isEqual(value,other){return baseIsEqual(value,other)}function isEqualWith(value,other,customizer){customizer="function"==typeof customizer?customizer:undefined;var result=customizer?customizer(value,other):undefined;return result===undefined?baseIsEqual(value,other,undefined,customizer):!!result}function isError(value){if(!isObjectLike(value))return!1;var tag=baseGetTag(value);return tag==errorTag||tag==domExcTag||"string"==typeof value.message&&"string"==typeof value.name&&!isPlainObject(value)}function isFinite(value){return"number"==typeof value&&nativeIsFinite(value)}function isFunction(value){if(!isObject(value))return!1;var tag=baseGetTag(value);return tag==funcTag||tag==genTag||tag==asyncTag||tag==proxyTag}function isInteger(value){return"number"==typeof value&&value==toInteger(value)}function isLength(value){return"number"==typeof value&&value>-1&&value%1==0&&value<=MAX_SAFE_INTEGER}function isObject(value){var type=typeof value;return null!=value&&("object"==type||"function"==type)}function isObjectLike(value){return null!=value&&"object"==typeof value}function isMatch(object,source){return object===source||baseIsMatch(object,source,getMatchData(source))}function isMatchWith(object,source,customizer){return customizer="function"==typeof customizer?customizer:undefined,baseIsMatch(object,source,getMatchData(source),customizer)}function isNaN(value){return isNumber(value)&&value!=+value}function isNative(value){if(isMaskable(value))throw new Error(CORE_ERROR_TEXT);return baseIsNative(value)}function isNull(value){return null===value}function isNil(value){return null==value}function isNumber(value){return"number"==typeof value||isObjectLike(value)&&baseGetTag(value)==numberTag}function isPlainObject(value){if(!isObjectLike(value)||baseGetTag(value)!=objectTag)return!1;var proto=getPrototype(value);if(null===proto)return!0;var Ctor=hasOwnProperty.call(proto,"constructor")&&proto.constructor;return"function"==typeof Ctor&&Ctor instanceof Ctor&&funcToString.call(Ctor)==objectCtorString}function isSafeInteger(value){return isInteger(value)&&value>=-MAX_SAFE_INTEGER&&value<=MAX_SAFE_INTEGER}function isString(value){return"string"==typeof value||!isArray(value)&&isObjectLike(value)&&baseGetTag(value)==stringTag}function isSymbol(value){return"symbol"==typeof value||isObjectLike(value)&&baseGetTag(value)==symbolTag}function isUndefined(value){return value===undefined}function isWeakMap(value){return isObjectLike(value)&&getTag(value)==weakMapTag}function isWeakSet(value){return isObjectLike(value)&&baseGetTag(value)==weakSetTag}function toArray(value){if(!value)return[];if(isArrayLike(value))return isString(value)?stringToArray(value):copyArray(value);if(symIterator&&value[symIterator])return iteratorToArray(value[symIterator]());var tag=getTag(value),func=tag==mapTag?mapToArray:tag==setTag?setToArray:values;return func(value)}function toFinite(value){if(!value)return 0===value?value:0;if(value=toNumber(value),value===INFINITY||value===-INFINITY){var sign=value<0?-1:1;return sign*MAX_INTEGER}return value===value?value:0}function toInteger(value){var result=toFinite(value),remainder=result%1;return result===result?remainder?result-remainder:result:0}function toLength(value){return value?baseClamp(toInteger(value),0,MAX_ARRAY_LENGTH):0}function toNumber(value){if("number"==typeof value)return value;if(isSymbol(value))return NAN;if(isObject(value)){var other="function"==typeof value.valueOf?value.valueOf():value;value=isObject(other)?other+"":other}if("string"!=typeof value)return 0===value?value:+value;value=value.replace(reTrim,"");var isBinary=reIsBinary.test(value);return isBinary||reIsOctal.test(value)?freeParseInt(value.slice(2),isBinary?2:8):reIsBadHex.test(value)?NAN:+value}function toPlainObject(value){return copyObject(value,keysIn(value))}function toSafeInteger(value){return value?baseClamp(toInteger(value),-MAX_SAFE_INTEGER,MAX_SAFE_INTEGER):0===value?value:0}function toString(value){return null==value?"":baseToString(value)}function create(prototype,properties){var result=baseCreate(prototype);return null==properties?result:baseAssign(result,properties)}function findKey(object,predicate){return baseFindKey(object,getIteratee(predicate,3),baseForOwn)}function findLastKey(object,predicate){return baseFindKey(object,getIteratee(predicate,3),baseForOwnRight)}function forIn(object,iteratee){return null==object?object:baseFor(object,getIteratee(iteratee,3),keysIn)}function forInRight(object,iteratee){return null==object?object:baseForRight(object,getIteratee(iteratee,3),keysIn)}function forOwn(object,iteratee){return object&&baseForOwn(object,getIteratee(iteratee,3))}function forOwnRight(object,iteratee){return object&&baseForOwnRight(object,getIteratee(iteratee,3))}function functions(object){return null==object?[]:baseFunctions(object,keys(object))}function functionsIn(object){return null==object?[]:baseFunctions(object,keysIn(object))}function get(object,path,defaultValue){var result=null==object?undefined:baseGet(object,path);return result===undefined?defaultValue:result}function has(object,path){return null!=object&&hasPath(object,path,baseHas)}function hasIn(object,path){return null!=object&&hasPath(object,path,baseHasIn)}function keys(object){return isArrayLike(object)?arrayLikeKeys(object):baseKeys(object)}function keysIn(object){return isArrayLike(object)?arrayLikeKeys(object,!0):baseKeysIn(object)}function mapKeys(object,iteratee){var result={};return iteratee=getIteratee(iteratee,3),baseForOwn(object,function(value,key,object){baseAssignValue(result,iteratee(value,key,object),value)}),result}function mapValues(object,iteratee){var result={};return iteratee=getIteratee(iteratee,3),baseForOwn(object,function(value,key,object){baseAssignValue(result,key,iteratee(value,key,object))}),result}function omitBy(object,predicate){return pickBy(object,negate(getIteratee(predicate)))}function pickBy(object,predicate){if(null==object)return{};var props=arrayMap(getAllKeysIn(object),function(prop){return[prop]});return predicate=getIteratee(predicate),basePickBy(object,props,function(value,path){return predicate(value,path[0])})}function result(object,path,defaultValue){path=castPath(path,object);var index=-1,length=path.length;for(length||(length=1,object=undefined);++index<length;){var value=null==object?undefined:object[toKey(path[index])];value===undefined&&(index=length,value=defaultValue),object=isFunction(value)?value.call(object):value}return object}function set(object,path,value){return null==object?object:baseSet(object,path,value)}function setWith(object,path,value,customizer){return customizer="function"==typeof customizer?customizer:undefined,null==object?object:baseSet(object,path,value,customizer)}function transform(object,iteratee,accumulator){var isArr=isArray(object),isArrLike=isArr||isBuffer(object)||isTypedArray(object);if(iteratee=getIteratee(iteratee,4),null==accumulator){var Ctor=object&&object.constructor;accumulator=isArrLike?isArr?new Ctor:[]:isObject(object)&&isFunction(Ctor)?baseCreate(getPrototype(object)):{}}return(isArrLike?arrayEach:baseForOwn)(object,function(value,index,object){return iteratee(accumulator,value,index,object)}),accumulator}function unset(object,path){return null==object||baseUnset(object,path)}function update(object,path,updater){return null==object?object:baseUpdate(object,path,castFunction(updater))}function updateWith(object,path,updater,customizer){return customizer="function"==typeof customizer?customizer:undefined,null==object?object:baseUpdate(object,path,castFunction(updater),customizer)}function values(object){return null==object?[]:baseValues(object,keys(object))}function valuesIn(object){return null==object?[]:baseValues(object,keysIn(object))}function clamp(number,lower,upper){return upper===undefined&&(upper=lower,lower=undefined),upper!==undefined&&(upper=toNumber(upper),upper=upper===upper?upper:0),lower!==undefined&&(lower=toNumber(lower),lower=lower===lower?lower:0),baseClamp(toNumber(number),lower,upper)}function inRange(number,start,end){return start=toFinite(start),end===undefined?(end=start,start=0):end=toFinite(end),number=toNumber(number),baseInRange(number,start,end)}function random(lower,upper,floating){if(floating&&"boolean"!=typeof floating&&isIterateeCall(lower,upper,floating)&&(upper=floating=undefined),floating===undefined&&("boolean"==typeof upper?(floating=upper,upper=undefined):"boolean"==typeof lower&&(floating=lower,lower=undefined)),lower===undefined&&upper===undefined?(lower=0,upper=1):(lower=toFinite(lower),upper===undefined?(upper=lower,lower=0):upper=toFinite(upper)),lower>upper){var temp=lower;lower=upper,upper=temp}if(floating||lower%1||upper%1){var rand=nativeRandom();return nativeMin(lower+rand*(upper-lower+freeParseFloat("1e-"+((rand+"").length-1))),upper)}return baseRandom(lower,upper)}function capitalize(string){return upperFirst(toString(string).toLowerCase())}function deburr(string){return string=toString(string),string&&string.replace(reLatin,deburrLetter).replace(reComboMark,"")}function endsWith(string,target,position){string=toString(string),target=baseToString(target);var length=string.length;position=position===undefined?length:baseClamp(toInteger(position),0,length);var end=position;return position-=target.length,position>=0&&string.slice(position,end)==target}function escape(string){return string=toString(string),string&&reHasUnescapedHtml.test(string)?string.replace(reUnescapedHtml,escapeHtmlChar):string}function escapeRegExp(string){return string=toString(string),string&&reHasRegExpChar.test(string)?string.replace(reRegExpChar,"\\$&"):string}function pad(string,length,chars){string=toString(string),length=toInteger(length);var strLength=length?stringSize(string):0;if(!length||strLength>=length)return string;var mid=(length-strLength)/2;return createPadding(nativeFloor(mid),chars)+string+createPadding(nativeCeil(mid),chars)}function padEnd(string,length,chars){string=toString(string),length=toInteger(length);var strLength=length?stringSize(string):0;return length&&strLength<length?string+createPadding(length-strLength,chars):string}function padStart(string,length,chars){string=toString(string),length=toInteger(length);var strLength=length?stringSize(string):0;return length&&strLength<length?createPadding(length-strLength,chars)+string:string}function parseInt(string,radix,guard){return guard||null==radix?radix=0:radix&&(radix=+radix),nativeParseInt(toString(string).replace(reTrimStart,""),radix||0)}function repeat(string,n,guard){return n=(guard?isIterateeCall(string,n,guard):n===undefined)?1:toInteger(n),baseRepeat(toString(string),n)}function replace(){var args=arguments,string=toString(args[0]);return args.length<3?string:string.replace(args[1],args[2])}function split(string,separator,limit){return limit&&"number"!=typeof limit&&isIterateeCall(string,separator,limit)&&(separator=limit=undefined),(limit=limit===undefined?MAX_ARRAY_LENGTH:limit>>>0)?(string=toString(string),string&&("string"==typeof separator||null!=separator&&!isRegExp(separator))&&(separator=baseToString(separator),!separator&&hasUnicode(string))?castSlice(stringToArray(string),0,limit):string.split(separator,limit)):[]}function startsWith(string,target,position){return string=toString(string),position=null==position?0:baseClamp(toInteger(position),0,string.length),target=baseToString(target),string.slice(position,position+target.length)==target}function template(string,options,guard){var settings=lodash.templateSettings;guard&&isIterateeCall(string,options,guard)&&(options=undefined),string=toString(string),options=assignInWith({},options,settings,customDefaultsAssignIn);var isEscaping,isEvaluating,imports=assignInWith({},options.imports,settings.imports,customDefaultsAssignIn),importsKeys=keys(imports),importsValues=baseValues(imports,importsKeys),index=0,interpolate=options.interpolate||reNoMatch,source="__p += '",reDelimiters=RegExp((options.escape||reNoMatch).source+"|"+interpolate.source+"|"+(interpolate===reInterpolate?reEsTemplate:reNoMatch).source+"|"+(options.evaluate||reNoMatch).source+"|$","g"),sourceURL="//# sourceURL="+("sourceURL"in options?options.sourceURL:"lodash.templateSources["+ ++templateCounter+"]")+"\n";string.replace(reDelimiters,function(match,escapeValue,interpolateValue,esTemplateValue,evaluateValue,offset){return interpolateValue||(interpolateValue=esTemplateValue),source+=string.slice(index,offset).replace(reUnescapedString,escapeStringChar),escapeValue&&(isEscaping=!0,source+="' +\n__e("+escapeValue+") +\n'"),evaluateValue&&(isEvaluating=!0,source+="';\n"+evaluateValue+";\n__p += '"),interpolateValue&&(source+="' +\n((__t = ("+interpolateValue+")) == null ? '' : __t) +\n'"),index=offset+match.length,match}),source+="';\n";var variable=options.variable;variable||(source="with (obj) {\n"+source+"\n}\n"),source=(isEvaluating?source.replace(reEmptyStringLeading,""):source).replace(reEmptyStringMiddle,"$1").replace(reEmptyStringTrailing,"$1;"),source="function("+(variable||"obj")+") {\n"+(variable?"":"obj || (obj = {});\n")+"var __t, __p = ''"+(isEscaping?", __e = _.escape":"")+(isEvaluating?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+source+"return __p\n}";var result=attempt(function(){return Function(importsKeys,sourceURL+"return "+source).apply(undefined,importsValues)});if(result.source=source,isError(result))throw result;return result}function toLower(value){return toString(value).toLowerCase()}function toUpper(value){return toString(value).toUpperCase()}function trim(string,chars,guard){if(string=toString(string),string&&(guard||chars===undefined))return string.replace(reTrim,"");if(!string||!(chars=baseToString(chars)))return string;var strSymbols=stringToArray(string),chrSymbols=stringToArray(chars),start=charsStartIndex(strSymbols,chrSymbols),end=charsEndIndex(strSymbols,chrSymbols)+1;return castSlice(strSymbols,start,end).join("")}function trimEnd(string,chars,guard){if(string=toString(string),string&&(guard||chars===undefined))return string.replace(reTrimEnd,"");if(!string||!(chars=baseToString(chars)))return string;var strSymbols=stringToArray(string),end=charsEndIndex(strSymbols,stringToArray(chars))+1;return castSlice(strSymbols,0,end).join("")}function trimStart(string,chars,guard){if(string=toString(string),string&&(guard||chars===undefined))return string.replace(reTrimStart,"");if(!string||!(chars=baseToString(chars)))return string;var strSymbols=stringToArray(string),start=charsStartIndex(strSymbols,stringToArray(chars));return castSlice(strSymbols,start).join("")}function truncate(string,options){var length=DEFAULT_TRUNC_LENGTH,omission=DEFAULT_TRUNC_OMISSION;if(isObject(options)){var separator="separator"in options?options.separator:separator;length="length"in options?toInteger(options.length):length,omission="omission"in options?baseToString(options.omission):omission}string=toString(string);var strLength=string.length;if(hasUnicode(string)){var strSymbols=stringToArray(string);strLength=strSymbols.length}if(length>=strLength)return string;var end=length-stringSize(omission);if(end<1)return omission;var result=strSymbols?castSlice(strSymbols,0,end).join(""):string.slice(0,end);if(separator===undefined)return result+omission;if(strSymbols&&(end+=result.length-end),isRegExp(separator)){if(string.slice(end).search(separator)){var match,substring=result;for(separator.global||(separator=RegExp(separator.source,toString(reFlags.exec(separator))+"g")),separator.lastIndex=0;match=separator.exec(substring);)var newEnd=match.index;result=result.slice(0,newEnd===undefined?end:newEnd)}}else if(string.indexOf(baseToString(separator),end)!=end){var index=result.lastIndexOf(separator);index>-1&&(result=result.slice(0,index))}return result+omission}function unescape(string){return string=toString(string),string&&reHasEscapedHtml.test(string)?string.replace(reEscapedHtml,unescapeHtmlChar):string}function words(string,pattern,guard){return string=toString(string),pattern=guard?undefined:pattern,pattern===undefined?hasUnicodeWord(string)?unicodeWords(string):asciiWords(string):string.match(pattern)||[]}function cond(pairs){var length=null==pairs?0:pairs.length,toIteratee=getIteratee();return pairs=length?arrayMap(pairs,function(pair){if("function"!=typeof pair[1])throw new TypeError(FUNC_ERROR_TEXT);return[toIteratee(pair[0]),pair[1]]}):[],baseRest(function(args){for(var index=-1;++index<length;){var pair=pairs[index];if(apply(pair[0],this,args))return apply(pair[1],this,args)}})}function conforms(source){return baseConforms(baseClone(source,CLONE_DEEP_FLAG))}function constant(value){return function(){return value}}function defaultTo(value,defaultValue){return null==value||value!==value?defaultValue:value}function identity(value){return value}function iteratee(func){return baseIteratee("function"==typeof func?func:baseClone(func,CLONE_DEEP_FLAG))}function matches(source){return baseMatches(baseClone(source,CLONE_DEEP_FLAG))}function matchesProperty(path,srcValue){return baseMatchesProperty(path,baseClone(srcValue,CLONE_DEEP_FLAG))}function mixin(object,source,options){var props=keys(source),methodNames=baseFunctions(source,props);null!=options||isObject(source)&&(methodNames.length||!props.length)||(options=source,source=object,object=this,methodNames=baseFunctions(source,keys(source)));var chain=!(isObject(options)&&"chain"in options&&!options.chain),isFunc=isFunction(object);return arrayEach(methodNames,function(methodName){var func=source[methodName];object[methodName]=func,isFunc&&(object.prototype[methodName]=function(){var chainAll=this.__chain__;if(chain||chainAll){var result=object(this.__wrapped__),actions=result.__actions__=copyArray(this.__actions__);return actions.push({func:func,args:arguments,thisArg:object}),result.__chain__=chainAll,result}return func.apply(object,arrayPush([this.value()],arguments))})}),object}function noConflict(){return root._===this&&(root._=oldDash),this}function noop(){}function nthArg(n){return n=toInteger(n),baseRest(function(args){return baseNth(args,n)})}function property(path){return isKey(path)?baseProperty(toKey(path)):basePropertyDeep(path)}function propertyOf(object){return function(path){return null==object?undefined:baseGet(object,path)}}function stubArray(){return[]}function stubFalse(){return!1}function stubObject(){return{}}function stubString(){return""}function stubTrue(){return!0}function times(n,iteratee){if(n=toInteger(n),n<1||n>MAX_SAFE_INTEGER)return[];var index=MAX_ARRAY_LENGTH,length=nativeMin(n,MAX_ARRAY_LENGTH);iteratee=getIteratee(iteratee),n-=MAX_ARRAY_LENGTH;for(var result=baseTimes(length,iteratee);++index<n;)iteratee(index);return result}function toPath(value){return isArray(value)?arrayMap(value,toKey):isSymbol(value)?[value]:copyArray(stringToPath(toString(value)))}function uniqueId(prefix){var id=++idCounter;return toString(prefix)+id}function max(array){return array&&array.length?baseExtremum(array,identity,baseGt):undefined}function maxBy(array,iteratee){return array&&array.length?baseExtremum(array,getIteratee(iteratee,2),baseGt):undefined}function mean(array){return baseMean(array,identity)}function meanBy(array,iteratee){return baseMean(array,getIteratee(iteratee,2))}function min(array){return array&&array.length?baseExtremum(array,identity,baseLt):undefined}function minBy(array,iteratee){return array&&array.length?baseExtremum(array,getIteratee(iteratee,2),baseLt):undefined}function sum(array){return array&&array.length?baseSum(array,identity):0}function sumBy(array,iteratee){return array&&array.length?baseSum(array,getIteratee(iteratee,2)):0}context=null==context?root:_.defaults(root.Object(),context,_.pick(root,contextProps));var Array=context.Array,Date=context.Date,Error=context.Error,Function=context.Function,Math=context.Math,Object=context.Object,RegExp=context.RegExp,String=context.String,TypeError=context.TypeError,arrayProto=Array.prototype,funcProto=Function.prototype,objectProto=Object.prototype,coreJsData=context["__core-js_shared__"],funcToString=funcProto.toString,hasOwnProperty=objectProto.hasOwnProperty,idCounter=0,maskSrcKey=function(){var uid=/[^.]+$/.exec(coreJsData&&coreJsData.keys&&coreJsData.keys.IE_PROTO||"");return uid?"Symbol(src)_1."+uid:""}(),nativeObjectToString=objectProto.toString,objectCtorString=funcToString.call(Object),oldDash=root._,reIsNative=RegExp("^"+funcToString.call(hasOwnProperty).replace(reRegExpChar,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Buffer=moduleExports?context.Buffer:undefined,Symbol=context.Symbol,Uint8Array=context.Uint8Array,allocUnsafe=Buffer?Buffer.allocUnsafe:undefined,getPrototype=overArg(Object.getPrototypeOf,Object),objectCreate=Object.create,propertyIsEnumerable=objectProto.propertyIsEnumerable,splice=arrayProto.splice,spreadableSymbol=Symbol?Symbol.isConcatSpreadable:undefined,symIterator=Symbol?Symbol.iterator:undefined,symToStringTag=Symbol?Symbol.toStringTag:undefined,defineProperty=function(){try{var func=getNative(Object,"defineProperty");return func({},"",{}),func}catch(e){}}(),ctxClearTimeout=context.clearTimeout!==root.clearTimeout&&context.clearTimeout,ctxNow=Date&&Date.now!==root.Date.now&&Date.now,ctxSetTimeout=context.setTimeout!==root.setTimeout&&context.setTimeout,nativeCeil=Math.ceil,nativeFloor=Math.floor,nativeGetSymbols=Object.getOwnPropertySymbols,nativeIsBuffer=Buffer?Buffer.isBuffer:undefined,nativeIsFinite=context.isFinite,nativeJoin=arrayProto.join,nativeKeys=overArg(Object.keys,Object),nativeMax=Math.max,nativeMin=Math.min,nativeNow=Date.now,nativeParseInt=context.parseInt,nativeRandom=Math.random,nativeReverse=arrayProto.reverse,DataView=getNative(context,"DataView"),Map=getNative(context,"Map"),Promise=getNative(context,"Promise"),Set=getNative(context,"Set"),WeakMap=getNative(context,"WeakMap"),nativeCreate=getNative(Object,"create"),metaMap=WeakMap&&new WeakMap,realNames={},dataViewCtorString=toSource(DataView),mapCtorString=toSource(Map),promiseCtorString=toSource(Promise),setCtorString=toSource(Set),weakMapCtorString=toSource(WeakMap),symbolProto=Symbol?Symbol.prototype:undefined,symbolValueOf=symbolProto?symbolProto.valueOf:undefined,symbolToString=symbolProto?symbolProto.toString:undefined,baseCreate=function(){function object(){}return function(proto){if(!isObject(proto))return{};if(objectCreate)return objectCreate(proto);object.prototype=proto;var result=new object;return object.prototype=undefined,result}}();lodash.templateSettings={escape:reEscape,evaluate:reEvaluate,interpolate:reInterpolate,variable:"",imports:{_:lodash}},lodash.prototype=baseLodash.prototype,lodash.prototype.constructor=lodash,LodashWrapper.prototype=baseCreate(baseLodash.prototype),LodashWrapper.prototype.constructor=LodashWrapper,LazyWrapper.prototype=baseCreate(baseLodash.prototype),LazyWrapper.prototype.constructor=LazyWrapper,Hash.prototype.clear=hashClear,Hash.prototype["delete"]=hashDelete,Hash.prototype.get=hashGet,Hash.prototype.has=hashHas,Hash.prototype.set=hashSet,ListCache.prototype.clear=listCacheClear,ListCache.prototype["delete"]=listCacheDelete,ListCache.prototype.get=listCacheGet,ListCache.prototype.has=listCacheHas,ListCache.prototype.set=listCacheSet,MapCache.prototype.clear=mapCacheClear,MapCache.prototype["delete"]=mapCacheDelete,MapCache.prototype.get=mapCacheGet,MapCache.prototype.has=mapCacheHas,MapCache.prototype.set=mapCacheSet,SetCache.prototype.add=SetCache.prototype.push=setCacheAdd,SetCache.prototype.has=setCacheHas,Stack.prototype.clear=stackClear,Stack.prototype["delete"]=stackDelete,Stack.prototype.get=stackGet,Stack.prototype.has=stackHas,Stack.prototype.set=stackSet;var baseEach=createBaseEach(baseForOwn),baseEachRight=createBaseEach(baseForOwnRight,!0),baseFor=createBaseFor(),baseForRight=createBaseFor(!0),baseSetData=metaMap?function(func,data){return metaMap.set(func,data),func}:identity,baseSetToString=defineProperty?function(func,string){return defineProperty(func,"toString",{configurable:!0,enumerable:!1,value:constant(string),writable:!0})}:identity,castRest=baseRest,clearTimeout=ctxClearTimeout||function(id){return root.clearTimeout(id)},createSet=Set&&1/setToArray(new Set([,-0]))[1]==INFINITY?function(values){return new Set(values)}:noop,getData=metaMap?function(func){return metaMap.get(func)}:noop,getSymbols=nativeGetSymbols?function(object){return null==object?[]:(object=Object(object),arrayFilter(nativeGetSymbols(object),function(symbol){return propertyIsEnumerable.call(object,symbol)}))}:stubArray,getSymbolsIn=nativeGetSymbols?function(object){for(var result=[];object;)arrayPush(result,getSymbols(object)),object=getPrototype(object);return result}:stubArray,getTag=baseGetTag;(DataView&&getTag(new DataView(new ArrayBuffer(1)))!=dataViewTag||Map&&getTag(new Map)!=mapTag||Promise&&getTag(Promise.resolve())!=promiseTag||Set&&getTag(new Set)!=setTag||WeakMap&&getTag(new WeakMap)!=weakMapTag)&&(getTag=function(value){var result=baseGetTag(value),Ctor=result==objectTag?value.constructor:undefined,ctorString=Ctor?toSource(Ctor):"";if(ctorString)switch(ctorString){case dataViewCtorString:return dataViewTag;case mapCtorString:return mapTag;case promiseCtorString:return promiseTag;case setCtorString:return setTag;case weakMapCtorString:return weakMapTag}return result});var isMaskable=coreJsData?isFunction:stubFalse,setData=shortOut(baseSetData),setTimeout=ctxSetTimeout||function(func,wait){return root.setTimeout(func,wait)},setToString=shortOut(baseSetToString),stringToPath=memoizeCapped(function(string){var result=[];return 46===string.charCodeAt(0)&&result.push(""),string.replace(rePropName,function(match,number,quote,subString){result.push(quote?subString.replace(reEscapeChar,"$1"):number||match)}),result}),difference=baseRest(function(array,values){return isArrayLikeObject(array)?baseDifference(array,baseFlatten(values,1,isArrayLikeObject,!0)):[]}),differenceBy=baseRest(function(array,values){var iteratee=last(values);return isArrayLikeObject(iteratee)&&(iteratee=undefined),isArrayLikeObject(array)?baseDifference(array,baseFlatten(values,1,isArrayLikeObject,!0),getIteratee(iteratee,2)):[]}),differenceWith=baseRest(function(array,values){var comparator=last(values);return isArrayLikeObject(comparator)&&(comparator=undefined),isArrayLikeObject(array)?baseDifference(array,baseFlatten(values,1,isArrayLikeObject,!0),undefined,comparator):[]}),intersection=baseRest(function(arrays){var mapped=arrayMap(arrays,castArrayLikeObject);return mapped.length&&mapped[0]===arrays[0]?baseIntersection(mapped):[]}),intersectionBy=baseRest(function(arrays){var iteratee=last(arrays),mapped=arrayMap(arrays,castArrayLikeObject);return iteratee===last(mapped)?iteratee=undefined:mapped.pop(),mapped.length&&mapped[0]===arrays[0]?baseIntersection(mapped,getIteratee(iteratee,2)):[]}),intersectionWith=baseRest(function(arrays){var comparator=last(arrays),mapped=arrayMap(arrays,castArrayLikeObject);return comparator="function"==typeof comparator?comparator:undefined,comparator&&mapped.pop(),mapped.length&&mapped[0]===arrays[0]?baseIntersection(mapped,undefined,comparator):[]}),pull=baseRest(pullAll),pullAt=flatRest(function(array,indexes){var length=null==array?0:array.length,result=baseAt(array,indexes);return basePullAt(array,arrayMap(indexes,function(index){return isIndex(index,length)?+index:index}).sort(compareAscending)),result}),union=baseRest(function(arrays){return baseUniq(baseFlatten(arrays,1,isArrayLikeObject,!0))}),unionBy=baseRest(function(arrays){var iteratee=last(arrays);return isArrayLikeObject(iteratee)&&(iteratee=undefined),baseUniq(baseFlatten(arrays,1,isArrayLikeObject,!0),getIteratee(iteratee,2))}),unionWith=baseRest(function(arrays){var comparator=last(arrays);return comparator="function"==typeof comparator?comparator:undefined,baseUniq(baseFlatten(arrays,1,isArrayLikeObject,!0),undefined,comparator)}),without=baseRest(function(array,values){return isArrayLikeObject(array)?baseDifference(array,values):[]}),xor=baseRest(function(arrays){return baseXor(arrayFilter(arrays,isArrayLikeObject))}),xorBy=baseRest(function(arrays){var iteratee=last(arrays);return isArrayLikeObject(iteratee)&&(iteratee=undefined),baseXor(arrayFilter(arrays,isArrayLikeObject),getIteratee(iteratee,2))}),xorWith=baseRest(function(arrays){var comparator=last(arrays);return comparator="function"==typeof comparator?comparator:undefined,baseXor(arrayFilter(arrays,isArrayLikeObject),undefined,comparator)}),zip=baseRest(unzip),zipWith=baseRest(function(arrays){var length=arrays.length,iteratee=length>1?arrays[length-1]:undefined;return iteratee="function"==typeof iteratee?(arrays.pop(),iteratee):undefined,unzipWith(arrays,iteratee)}),wrapperAt=flatRest(function(paths){var length=paths.length,start=length?paths[0]:0,value=this.__wrapped__,interceptor=function(object){return baseAt(object,paths)};return!(length>1||this.__actions__.length)&&value instanceof LazyWrapper&&isIndex(start)?(value=value.slice(start,+start+(length?1:0)),value.__actions__.push({func:thru,args:[interceptor],thisArg:undefined}),new LodashWrapper(value,this.__chain__).thru(function(array){return length&&!array.length&&array.push(undefined),array})):this.thru(interceptor)}),countBy=createAggregator(function(result,value,key){hasOwnProperty.call(result,key)?++result[key]:baseAssignValue(result,key,1)}),find=createFind(findIndex),findLast=createFind(findLastIndex),groupBy=createAggregator(function(result,value,key){hasOwnProperty.call(result,key)?result[key].push(value):baseAssignValue(result,key,[value])}),invokeMap=baseRest(function(collection,path,args){var index=-1,isFunc="function"==typeof path,result=isArrayLike(collection)?Array(collection.length):[];return baseEach(collection,function(value){result[++index]=isFunc?apply(path,value,args):baseInvoke(value,path,args)}),result}),keyBy=createAggregator(function(result,value,key){baseAssignValue(result,key,value)}),partition=createAggregator(function(result,value,key){result[key?0:1].push(value)},function(){return[[],[]]}),sortBy=baseRest(function(collection,iteratees){if(null==collection)return[];var length=iteratees.length;return length>1&&isIterateeCall(collection,iteratees[0],iteratees[1])?iteratees=[]:length>2&&isIterateeCall(iteratees[0],iteratees[1],iteratees[2])&&(iteratees=[iteratees[0]]),baseOrderBy(collection,baseFlatten(iteratees,1),[])}),now=ctxNow||function(){return root.Date.now()},bind=baseRest(function(func,thisArg,partials){var bitmask=WRAP_BIND_FLAG;if(partials.length){var holders=replaceHolders(partials,getHolder(bind));bitmask|=WRAP_PARTIAL_FLAG}return createWrap(func,bitmask,thisArg,partials,holders)}),bindKey=baseRest(function(object,key,partials){var bitmask=WRAP_BIND_FLAG|WRAP_BIND_KEY_FLAG;if(partials.length){var holders=replaceHolders(partials,getHolder(bindKey));bitmask|=WRAP_PARTIAL_FLAG}return createWrap(key,bitmask,object,partials,holders)}),defer=baseRest(function(func,args){return baseDelay(func,1,args)}),delay=baseRest(function(func,wait,args){return baseDelay(func,toNumber(wait)||0,args)});memoize.Cache=MapCache;var overArgs=castRest(function(func,transforms){transforms=1==transforms.length&&isArray(transforms[0])?arrayMap(transforms[0],baseUnary(getIteratee())):arrayMap(baseFlatten(transforms,1),baseUnary(getIteratee()));var funcsLength=transforms.length;return baseRest(function(args){for(var index=-1,length=nativeMin(args.length,funcsLength);++index<length;)args[index]=transforms[index].call(this,args[index]);return apply(func,this,args)})}),partial=baseRest(function(func,partials){var holders=replaceHolders(partials,getHolder(partial));return createWrap(func,WRAP_PARTIAL_FLAG,undefined,partials,holders)}),partialRight=baseRest(function(func,partials){var holders=replaceHolders(partials,getHolder(partialRight));return createWrap(func,WRAP_PARTIAL_RIGHT_FLAG,undefined,partials,holders)}),rearg=flatRest(function(func,indexes){
return createWrap(func,WRAP_REARG_FLAG,undefined,undefined,undefined,indexes)}),gt=createRelationalOperation(baseGt),gte=createRelationalOperation(function(value,other){return value>=other}),isArguments=baseIsArguments(function(){return arguments}())?baseIsArguments:function(value){return isObjectLike(value)&&hasOwnProperty.call(value,"callee")&&!propertyIsEnumerable.call(value,"callee")},isArray=Array.isArray,isArrayBuffer=nodeIsArrayBuffer?baseUnary(nodeIsArrayBuffer):baseIsArrayBuffer,isBuffer=nativeIsBuffer||stubFalse,isDate=nodeIsDate?baseUnary(nodeIsDate):baseIsDate,isMap=nodeIsMap?baseUnary(nodeIsMap):baseIsMap,isRegExp=nodeIsRegExp?baseUnary(nodeIsRegExp):baseIsRegExp,isSet=nodeIsSet?baseUnary(nodeIsSet):baseIsSet,isTypedArray=nodeIsTypedArray?baseUnary(nodeIsTypedArray):baseIsTypedArray,lt=createRelationalOperation(baseLt),lte=createRelationalOperation(function(value,other){return value<=other}),assign=createAssigner(function(object,source){if(isPrototype(source)||isArrayLike(source))return void copyObject(source,keys(source),object);for(var key in source)hasOwnProperty.call(source,key)&&assignValue(object,key,source[key])}),assignIn=createAssigner(function(object,source){copyObject(source,keysIn(source),object)}),assignInWith=createAssigner(function(object,source,srcIndex,customizer){copyObject(source,keysIn(source),object,customizer)}),assignWith=createAssigner(function(object,source,srcIndex,customizer){copyObject(source,keys(source),object,customizer)}),at=flatRest(baseAt),defaults=baseRest(function(object,sources){object=Object(object);var index=-1,length=sources.length,guard=length>2?sources[2]:undefined;for(guard&&isIterateeCall(sources[0],sources[1],guard)&&(length=1);++index<length;)for(var source=sources[index],props=keysIn(source),propsIndex=-1,propsLength=props.length;++propsIndex<propsLength;){var key=props[propsIndex],value=object[key];(value===undefined||eq(value,objectProto[key])&&!hasOwnProperty.call(object,key))&&(object[key]=source[key])}return object}),defaultsDeep=baseRest(function(args){return args.push(undefined,customDefaultsMerge),apply(mergeWith,undefined,args)}),invert=createInverter(function(result,value,key){null!=value&&"function"!=typeof value.toString&&(value=nativeObjectToString.call(value)),result[value]=key},constant(identity)),invertBy=createInverter(function(result,value,key){null!=value&&"function"!=typeof value.toString&&(value=nativeObjectToString.call(value)),hasOwnProperty.call(result,value)?result[value].push(key):result[value]=[key]},getIteratee),invoke=baseRest(baseInvoke),merge=createAssigner(function(object,source,srcIndex){baseMerge(object,source,srcIndex)}),mergeWith=createAssigner(function(object,source,srcIndex,customizer){baseMerge(object,source,srcIndex,customizer)}),omit=flatRest(function(object,paths){var result={};if(null==object)return result;var isDeep=!1;paths=arrayMap(paths,function(path){return path=castPath(path,object),isDeep||(isDeep=path.length>1),path}),copyObject(object,getAllKeysIn(object),result),isDeep&&(result=baseClone(result,CLONE_DEEP_FLAG|CLONE_FLAT_FLAG|CLONE_SYMBOLS_FLAG,customOmitClone));for(var length=paths.length;length--;)baseUnset(result,paths[length]);return result}),pick=flatRest(function(object,paths){return null==object?{}:basePick(object,paths)}),toPairs=createToPairs(keys),toPairsIn=createToPairs(keysIn),camelCase=createCompounder(function(result,word,index){return word=word.toLowerCase(),result+(index?capitalize(word):word)}),kebabCase=createCompounder(function(result,word,index){return result+(index?"-":"")+word.toLowerCase()}),lowerCase=createCompounder(function(result,word,index){return result+(index?" ":"")+word.toLowerCase()}),lowerFirst=createCaseFirst("toLowerCase"),snakeCase=createCompounder(function(result,word,index){return result+(index?"_":"")+word.toLowerCase()}),startCase=createCompounder(function(result,word,index){return result+(index?" ":"")+upperFirst(word)}),upperCase=createCompounder(function(result,word,index){return result+(index?" ":"")+word.toUpperCase()}),upperFirst=createCaseFirst("toUpperCase"),attempt=baseRest(function(func,args){try{return apply(func,undefined,args)}catch(e){return isError(e)?e:new Error(e)}}),bindAll=flatRest(function(object,methodNames){return arrayEach(methodNames,function(key){key=toKey(key),baseAssignValue(object,key,bind(object[key],object))}),object}),flow=createFlow(),flowRight=createFlow(!0),method=baseRest(function(path,args){return function(object){return baseInvoke(object,path,args)}}),methodOf=baseRest(function(object,args){return function(path){return baseInvoke(object,path,args)}}),over=createOver(arrayMap),overEvery=createOver(arrayEvery),overSome=createOver(arraySome),range=createRange(),rangeRight=createRange(!0),add=createMathOperation(function(augend,addend){return augend+addend},0),ceil=createRound("ceil"),divide=createMathOperation(function(dividend,divisor){return dividend/divisor},1),floor=createRound("floor"),multiply=createMathOperation(function(multiplier,multiplicand){return multiplier*multiplicand},1),round=createRound("round"),subtract=createMathOperation(function(minuend,subtrahend){return minuend-subtrahend},0);return lodash.after=after,lodash.ary=ary,lodash.assign=assign,lodash.assignIn=assignIn,lodash.assignInWith=assignInWith,lodash.assignWith=assignWith,lodash.at=at,lodash.before=before,lodash.bind=bind,lodash.bindAll=bindAll,lodash.bindKey=bindKey,lodash.castArray=castArray,lodash.chain=chain,lodash.chunk=chunk,lodash.compact=compact,lodash.concat=concat,lodash.cond=cond,lodash.conforms=conforms,lodash.constant=constant,lodash.countBy=countBy,lodash.create=create,lodash.curry=curry,lodash.curryRight=curryRight,lodash.debounce=debounce,lodash.defaults=defaults,lodash.defaultsDeep=defaultsDeep,lodash.defer=defer,lodash.delay=delay,lodash.difference=difference,lodash.differenceBy=differenceBy,lodash.differenceWith=differenceWith,lodash.drop=drop,lodash.dropRight=dropRight,lodash.dropRightWhile=dropRightWhile,lodash.dropWhile=dropWhile,lodash.fill=fill,lodash.filter=filter,lodash.flatMap=flatMap,lodash.flatMapDeep=flatMapDeep,lodash.flatMapDepth=flatMapDepth,lodash.flatten=flatten,lodash.flattenDeep=flattenDeep,lodash.flattenDepth=flattenDepth,lodash.flip=flip,lodash.flow=flow,lodash.flowRight=flowRight,lodash.fromPairs=fromPairs,lodash.functions=functions,lodash.functionsIn=functionsIn,lodash.groupBy=groupBy,lodash.initial=initial,lodash.intersection=intersection,lodash.intersectionBy=intersectionBy,lodash.intersectionWith=intersectionWith,lodash.invert=invert,lodash.invertBy=invertBy,lodash.invokeMap=invokeMap,lodash.iteratee=iteratee,lodash.keyBy=keyBy,lodash.keys=keys,lodash.keysIn=keysIn,lodash.map=map,lodash.mapKeys=mapKeys,lodash.mapValues=mapValues,lodash.matches=matches,lodash.matchesProperty=matchesProperty,lodash.memoize=memoize,lodash.merge=merge,lodash.mergeWith=mergeWith,lodash.method=method,lodash.methodOf=methodOf,lodash.mixin=mixin,lodash.negate=negate,lodash.nthArg=nthArg,lodash.omit=omit,lodash.omitBy=omitBy,lodash.once=once,lodash.orderBy=orderBy,lodash.over=over,lodash.overArgs=overArgs,lodash.overEvery=overEvery,lodash.overSome=overSome,lodash.partial=partial,lodash.partialRight=partialRight,lodash.partition=partition,lodash.pick=pick,lodash.pickBy=pickBy,lodash.property=property,lodash.propertyOf=propertyOf,lodash.pull=pull,lodash.pullAll=pullAll,lodash.pullAllBy=pullAllBy,lodash.pullAllWith=pullAllWith,lodash.pullAt=pullAt,lodash.range=range,lodash.rangeRight=rangeRight,lodash.rearg=rearg,lodash.reject=reject,lodash.remove=remove,lodash.rest=rest,lodash.reverse=reverse,lodash.sampleSize=sampleSize,lodash.set=set,lodash.setWith=setWith,lodash.shuffle=shuffle,lodash.slice=slice,lodash.sortBy=sortBy,lodash.sortedUniq=sortedUniq,lodash.sortedUniqBy=sortedUniqBy,lodash.split=split,lodash.spread=spread,lodash.tail=tail,lodash.take=take,lodash.takeRight=takeRight,lodash.takeRightWhile=takeRightWhile,lodash.takeWhile=takeWhile,lodash.tap=tap,lodash.throttle=throttle,lodash.thru=thru,lodash.toArray=toArray,lodash.toPairs=toPairs,lodash.toPairsIn=toPairsIn,lodash.toPath=toPath,lodash.toPlainObject=toPlainObject,lodash.transform=transform,lodash.unary=unary,lodash.union=union,lodash.unionBy=unionBy,lodash.unionWith=unionWith,lodash.uniq=uniq,lodash.uniqBy=uniqBy,lodash.uniqWith=uniqWith,lodash.unset=unset,lodash.unzip=unzip,lodash.unzipWith=unzipWith,lodash.update=update,lodash.updateWith=updateWith,lodash.values=values,lodash.valuesIn=valuesIn,lodash.without=without,lodash.words=words,lodash.wrap=wrap,lodash.xor=xor,lodash.xorBy=xorBy,lodash.xorWith=xorWith,lodash.zip=zip,lodash.zipObject=zipObject,lodash.zipObjectDeep=zipObjectDeep,lodash.zipWith=zipWith,lodash.entries=toPairs,lodash.entriesIn=toPairsIn,lodash.extend=assignIn,lodash.extendWith=assignInWith,mixin(lodash,lodash),lodash.add=add,lodash.attempt=attempt,lodash.camelCase=camelCase,lodash.capitalize=capitalize,lodash.ceil=ceil,lodash.clamp=clamp,lodash.clone=clone,lodash.cloneDeep=cloneDeep,lodash.cloneDeepWith=cloneDeepWith,lodash.cloneWith=cloneWith,lodash.conformsTo=conformsTo,lodash.deburr=deburr,lodash.defaultTo=defaultTo,lodash.divide=divide,lodash.endsWith=endsWith,lodash.eq=eq,lodash.escape=escape,lodash.escapeRegExp=escapeRegExp,lodash.every=every,lodash.find=find,lodash.findIndex=findIndex,lodash.findKey=findKey,lodash.findLast=findLast,lodash.findLastIndex=findLastIndex,lodash.findLastKey=findLastKey,lodash.floor=floor,lodash.forEach=forEach,lodash.forEachRight=forEachRight,lodash.forIn=forIn,lodash.forInRight=forInRight,lodash.forOwn=forOwn,lodash.forOwnRight=forOwnRight,lodash.get=get,lodash.gt=gt,lodash.gte=gte,lodash.has=has,lodash.hasIn=hasIn,lodash.head=head,lodash.identity=identity,lodash.includes=includes,lodash.indexOf=indexOf,lodash.inRange=inRange,lodash.invoke=invoke,lodash.isArguments=isArguments,lodash.isArray=isArray,lodash.isArrayBuffer=isArrayBuffer,lodash.isArrayLike=isArrayLike,lodash.isArrayLikeObject=isArrayLikeObject,lodash.isBoolean=isBoolean,lodash.isBuffer=isBuffer,lodash.isDate=isDate,lodash.isElement=isElement,lodash.isEmpty=isEmpty,lodash.isEqual=isEqual,lodash.isEqualWith=isEqualWith,lodash.isError=isError,lodash.isFinite=isFinite,lodash.isFunction=isFunction,lodash.isInteger=isInteger,lodash.isLength=isLength,lodash.isMap=isMap,lodash.isMatch=isMatch,lodash.isMatchWith=isMatchWith,lodash.isNaN=isNaN,lodash.isNative=isNative,lodash.isNil=isNil,lodash.isNull=isNull,lodash.isNumber=isNumber,lodash.isObject=isObject,lodash.isObjectLike=isObjectLike,lodash.isPlainObject=isPlainObject,lodash.isRegExp=isRegExp,lodash.isSafeInteger=isSafeInteger,lodash.isSet=isSet,lodash.isString=isString,lodash.isSymbol=isSymbol,lodash.isTypedArray=isTypedArray,lodash.isUndefined=isUndefined,lodash.isWeakMap=isWeakMap,lodash.isWeakSet=isWeakSet,lodash.join=join,lodash.kebabCase=kebabCase,lodash.last=last,lodash.lastIndexOf=lastIndexOf,lodash.lowerCase=lowerCase,lodash.lowerFirst=lowerFirst,lodash.lt=lt,lodash.lte=lte,lodash.max=max,lodash.maxBy=maxBy,lodash.mean=mean,lodash.meanBy=meanBy,lodash.min=min,lodash.minBy=minBy,lodash.stubArray=stubArray,lodash.stubFalse=stubFalse,lodash.stubObject=stubObject,lodash.stubString=stubString,lodash.stubTrue=stubTrue,lodash.multiply=multiply,lodash.nth=nth,lodash.noConflict=noConflict,lodash.noop=noop,lodash.now=now,lodash.pad=pad,lodash.padEnd=padEnd,lodash.padStart=padStart,lodash.parseInt=parseInt,lodash.random=random,lodash.reduce=reduce,lodash.reduceRight=reduceRight,lodash.repeat=repeat,lodash.replace=replace,lodash.result=result,lodash.round=round,lodash.runInContext=runInContext,lodash.sample=sample,lodash.size=size,lodash.snakeCase=snakeCase,lodash.some=some,lodash.sortedIndex=sortedIndex,lodash.sortedIndexBy=sortedIndexBy,lodash.sortedIndexOf=sortedIndexOf,lodash.sortedLastIndex=sortedLastIndex,lodash.sortedLastIndexBy=sortedLastIndexBy,lodash.sortedLastIndexOf=sortedLastIndexOf,lodash.startCase=startCase,lodash.startsWith=startsWith,lodash.subtract=subtract,lodash.sum=sum,lodash.sumBy=sumBy,lodash.template=template,lodash.times=times,lodash.toFinite=toFinite,lodash.toInteger=toInteger,lodash.toLength=toLength,lodash.toLower=toLower,lodash.toNumber=toNumber,lodash.toSafeInteger=toSafeInteger,lodash.toString=toString,lodash.toUpper=toUpper,lodash.trim=trim,lodash.trimEnd=trimEnd,lodash.trimStart=trimStart,lodash.truncate=truncate,lodash.unescape=unescape,lodash.uniqueId=uniqueId,lodash.upperCase=upperCase,lodash.upperFirst=upperFirst,lodash.each=forEach,lodash.eachRight=forEachRight,lodash.first=head,mixin(lodash,function(){var source={};return baseForOwn(lodash,function(func,methodName){hasOwnProperty.call(lodash.prototype,methodName)||(source[methodName]=func)}),source}(),{chain:!1}),lodash.VERSION=VERSION,arrayEach(["bind","bindKey","curry","curryRight","partial","partialRight"],function(methodName){lodash[methodName].placeholder=lodash}),arrayEach(["drop","take"],function(methodName,index){LazyWrapper.prototype[methodName]=function(n){n=n===undefined?1:nativeMax(toInteger(n),0);var result=this.__filtered__&&!index?new LazyWrapper(this):this.clone();return result.__filtered__?result.__takeCount__=nativeMin(n,result.__takeCount__):result.__views__.push({size:nativeMin(n,MAX_ARRAY_LENGTH),type:methodName+(result.__dir__<0?"Right":"")}),result},LazyWrapper.prototype[methodName+"Right"]=function(n){return this.reverse()[methodName](n).reverse()}}),arrayEach(["filter","map","takeWhile"],function(methodName,index){var type=index+1,isFilter=type==LAZY_FILTER_FLAG||type==LAZY_WHILE_FLAG;LazyWrapper.prototype[methodName]=function(iteratee){var result=this.clone();return result.__iteratees__.push({iteratee:getIteratee(iteratee,3),type:type}),result.__filtered__=result.__filtered__||isFilter,result}}),arrayEach(["head","last"],function(methodName,index){var takeName="take"+(index?"Right":"");LazyWrapper.prototype[methodName]=function(){return this[takeName](1).value()[0]}}),arrayEach(["initial","tail"],function(methodName,index){var dropName="drop"+(index?"":"Right");LazyWrapper.prototype[methodName]=function(){return this.__filtered__?new LazyWrapper(this):this[dropName](1)}}),LazyWrapper.prototype.compact=function(){return this.filter(identity)},LazyWrapper.prototype.find=function(predicate){return this.filter(predicate).head()},LazyWrapper.prototype.findLast=function(predicate){return this.reverse().find(predicate)},LazyWrapper.prototype.invokeMap=baseRest(function(path,args){return"function"==typeof path?new LazyWrapper(this):this.map(function(value){return baseInvoke(value,path,args)})}),LazyWrapper.prototype.reject=function(predicate){return this.filter(negate(getIteratee(predicate)))},LazyWrapper.prototype.slice=function(start,end){start=toInteger(start);var result=this;return result.__filtered__&&(start>0||end<0)?new LazyWrapper(result):(start<0?result=result.takeRight(-start):start&&(result=result.drop(start)),end!==undefined&&(end=toInteger(end),result=end<0?result.dropRight(-end):result.take(end-start)),result)},LazyWrapper.prototype.takeRightWhile=function(predicate){return this.reverse().takeWhile(predicate).reverse()},LazyWrapper.prototype.toArray=function(){return this.take(MAX_ARRAY_LENGTH)},baseForOwn(LazyWrapper.prototype,function(func,methodName){var checkIteratee=/^(?:filter|find|map|reject)|While$/.test(methodName),isTaker=/^(?:head|last)$/.test(methodName),lodashFunc=lodash[isTaker?"take"+("last"==methodName?"Right":""):methodName],retUnwrapped=isTaker||/^find/.test(methodName);lodashFunc&&(lodash.prototype[methodName]=function(){var value=this.__wrapped__,args=isTaker?[1]:arguments,isLazy=value instanceof LazyWrapper,iteratee=args[0],useLazy=isLazy||isArray(value),interceptor=function(value){var result=lodashFunc.apply(lodash,arrayPush([value],args));return isTaker&&chainAll?result[0]:result};useLazy&&checkIteratee&&"function"==typeof iteratee&&1!=iteratee.length&&(isLazy=useLazy=!1);var chainAll=this.__chain__,isHybrid=!!this.__actions__.length,isUnwrapped=retUnwrapped&&!chainAll,onlyLazy=isLazy&&!isHybrid;if(!retUnwrapped&&useLazy){value=onlyLazy?value:new LazyWrapper(this);var result=func.apply(value,args);return result.__actions__.push({func:thru,args:[interceptor],thisArg:undefined}),new LodashWrapper(result,chainAll)}return isUnwrapped&&onlyLazy?func.apply(this,args):(result=this.thru(interceptor),isUnwrapped?isTaker?result.value()[0]:result.value():result)})}),arrayEach(["pop","push","shift","sort","splice","unshift"],function(methodName){var func=arrayProto[methodName],chainName=/^(?:push|sort|unshift)$/.test(methodName)?"tap":"thru",retUnwrapped=/^(?:pop|shift)$/.test(methodName);lodash.prototype[methodName]=function(){var args=arguments;if(retUnwrapped&&!this.__chain__){var value=this.value();return func.apply(isArray(value)?value:[],args)}return this[chainName](function(value){return func.apply(isArray(value)?value:[],args)})}}),baseForOwn(LazyWrapper.prototype,function(func,methodName){var lodashFunc=lodash[methodName];if(lodashFunc){var key=lodashFunc.name+"",names=realNames[key]||(realNames[key]=[]);names.push({name:methodName,func:lodashFunc})}}),realNames[createHybrid(undefined,WRAP_BIND_KEY_FLAG).name]=[{name:"wrapper",func:undefined}],LazyWrapper.prototype.clone=lazyClone,LazyWrapper.prototype.reverse=lazyReverse,LazyWrapper.prototype.value=lazyValue,lodash.prototype.at=wrapperAt,lodash.prototype.chain=wrapperChain,lodash.prototype.commit=wrapperCommit,lodash.prototype.next=wrapperNext,lodash.prototype.plant=wrapperPlant,lodash.prototype.reverse=wrapperReverse,lodash.prototype.toJSON=lodash.prototype.valueOf=lodash.prototype.value=wrapperValue,lodash.prototype.first=lodash.prototype.head,symIterator&&(lodash.prototype[symIterator]=wrapperToIterator),lodash},_=runInContext();"function"==typeof define&&"object"==typeof define.amd&&define.amd?(root._=_,define(function(){return _})):freeModule?((freeModule.exports=_)._=_,freeExports._=_):root._=_}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],272:[function(require,module,exports){(function(Buffer){"use strict";function MD5(){HashBase.call(this,64),this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878}function rotl(x,n){return x<<n|x>>>32-n}function fnF(a,b,c,d,m,k,s){return rotl(a+(b&c|~b&d)+m+k|0,s)+b|0}function fnG(a,b,c,d,m,k,s){return rotl(a+(b&d|c&~d)+m+k|0,s)+b|0}function fnH(a,b,c,d,m,k,s){return rotl(a+(b^c^d)+m+k|0,s)+b|0}function fnI(a,b,c,d,m,k,s){return rotl(a+(c^(b|~d))+m+k|0,s)+b|0}var inherits=require("inherits"),HashBase=require("hash-base"),ARRAY16=new Array(16);inherits(MD5,HashBase),MD5.prototype._update=function(){for(var M=ARRAY16,i=0;i<16;++i)M[i]=this._block.readInt32LE(4*i);var a=this._a,b=this._b,c=this._c,d=this._d;a=fnF(a,b,c,d,M[0],3614090360,7),d=fnF(d,a,b,c,M[1],3905402710,12),c=fnF(c,d,a,b,M[2],606105819,17),b=fnF(b,c,d,a,M[3],3250441966,22),a=fnF(a,b,c,d,M[4],4118548399,7),d=fnF(d,a,b,c,M[5],1200080426,12),c=fnF(c,d,a,b,M[6],2821735955,17),b=fnF(b,c,d,a,M[7],4249261313,22),a=fnF(a,b,c,d,M[8],1770035416,7),d=fnF(d,a,b,c,M[9],2336552879,12),c=fnF(c,d,a,b,M[10],4294925233,17),b=fnF(b,c,d,a,M[11],2304563134,22),a=fnF(a,b,c,d,M[12],1804603682,7),d=fnF(d,a,b,c,M[13],4254626195,12),c=fnF(c,d,a,b,M[14],2792965006,17),b=fnF(b,c,d,a,M[15],1236535329,22),a=fnG(a,b,c,d,M[1],4129170786,5),d=fnG(d,a,b,c,M[6],3225465664,9),c=fnG(c,d,a,b,M[11],643717713,14),b=fnG(b,c,d,a,M[0],3921069994,20),a=fnG(a,b,c,d,M[5],3593408605,5),d=fnG(d,a,b,c,M[10],38016083,9),c=fnG(c,d,a,b,M[15],3634488961,14),b=fnG(b,c,d,a,M[4],3889429448,20),a=fnG(a,b,c,d,M[9],568446438,5),d=fnG(d,a,b,c,M[14],3275163606,9),c=fnG(c,d,a,b,M[3],4107603335,14),b=fnG(b,c,d,a,M[8],1163531501,20),a=fnG(a,b,c,d,M[13],2850285829,5),d=fnG(d,a,b,c,M[2],4243563512,9),c=fnG(c,d,a,b,M[7],1735328473,14),b=fnG(b,c,d,a,M[12],2368359562,20),a=fnH(a,b,c,d,M[5],4294588738,4),d=fnH(d,a,b,c,M[8],2272392833,11),c=fnH(c,d,a,b,M[11],1839030562,16),b=fnH(b,c,d,a,M[14],4259657740,23),a=fnH(a,b,c,d,M[1],2763975236,4),d=fnH(d,a,b,c,M[4],1272893353,11),c=fnH(c,d,a,b,M[7],4139469664,16),b=fnH(b,c,d,a,M[10],3200236656,23),a=fnH(a,b,c,d,M[13],681279174,4),d=fnH(d,a,b,c,M[0],3936430074,11),c=fnH(c,d,a,b,M[3],3572445317,16),b=fnH(b,c,d,a,M[6],76029189,23),a=fnH(a,b,c,d,M[9],3654602809,4),d=fnH(d,a,b,c,M[12],3873151461,11),c=fnH(c,d,a,b,M[15],530742520,16),b=fnH(b,c,d,a,M[2],3299628645,23),a=fnI(a,b,c,d,M[0],4096336452,6),d=fnI(d,a,b,c,M[7],1126891415,10),c=fnI(c,d,a,b,M[14],2878612391,15),b=fnI(b,c,d,a,M[5],4237533241,21),a=fnI(a,b,c,d,M[12],1700485571,6),d=fnI(d,a,b,c,M[3],2399980690,10),c=fnI(c,d,a,b,M[10],4293915773,15),b=fnI(b,c,d,a,M[1],2240044497,21),a=fnI(a,b,c,d,M[8],1873313359,6),d=fnI(d,a,b,c,M[15],4264355552,10),c=fnI(c,d,a,b,M[6],2734768916,15),b=fnI(b,c,d,a,M[13],1309151649,21),a=fnI(a,b,c,d,M[4],4149444226,6),d=fnI(d,a,b,c,M[11],3174756917,10),c=fnI(c,d,a,b,M[2],718787259,15),b=fnI(b,c,d,a,M[9],3951481745,21),this._a=this._a+a|0,this._b=this._b+b|0,this._c=this._c+c|0,this._d=this._d+d|0},MD5.prototype._digest=function(){this._block[this._blockOffset++]=128,this._blockOffset>56&&(this._block.fill(0,this._blockOffset,64),this._update(),this._blockOffset=0),this._block.fill(0,this._blockOffset,56),this._block.writeUInt32LE(this._length[0],56),this._block.writeUInt32LE(this._length[1],60),this._update();var buffer=new Buffer(16);return buffer.writeInt32LE(this._a,0),buffer.writeInt32LE(this._b,4),buffer.writeInt32LE(this._c,8),buffer.writeInt32LE(this._d,12),buffer},module.exports=MD5}).call(this,require("buffer").Buffer)},{buffer:151,"hash-base":217,inherits:233}],273:[function(require,module,exports){function MillerRabin(rand){this.rand=rand||new brorand.Rand}var bn=require("bn.js"),brorand=require("brorand");module.exports=MillerRabin,MillerRabin.create=function(rand){return new MillerRabin(rand)},MillerRabin.prototype._randbelow=function(n){var len=n.bitLength(),min_bytes=Math.ceil(len/8);do var a=new bn(this.rand.generate(min_bytes));while(a.cmp(n)>=0);return a},MillerRabin.prototype._randrange=function(start,stop){var size=stop.sub(start);return start.add(this._randbelow(size))},MillerRabin.prototype.test=function(n,k,cb){var len=n.bitLength(),red=bn.mont(n),rone=new bn(1).toRed(red);k||(k=Math.max(1,len/48|0));for(var n1=n.subn(1),s=0;!n1.testn(s);s++);for(var d=n.shrn(s),rn1=n1.toRed(red),prime=!0;k>0;k--){var a=this._randrange(new bn(2),n1);cb&&cb(a);var x=a.toRed(red).redPow(d);if(0!==x.cmp(rone)&&0!==x.cmp(rn1)){for(var i=1;i<s;i++){if(x=x.redSqr(),0===x.cmp(rone))return!1;if(0===x.cmp(rn1))break}if(i===s)return!1}}return prime},MillerRabin.prototype.getDivisor=function(n,k){var len=n.bitLength(),red=bn.mont(n),rone=new bn(1).toRed(red);k||(k=Math.max(1,len/48|0));for(var n1=n.subn(1),s=0;!n1.testn(s);s++);for(var d=n.shrn(s),rn1=n1.toRed(red);k>0;k--){var a=this._randrange(new bn(2),n1),g=n.gcd(a);if(0!==g.cmpn(1))return g;var x=a.toRed(red).redPow(d);if(0!==x.cmp(rone)&&0!==x.cmp(rn1)){for(var i=1;i<s;i++){if(x=x.redSqr(),0===x.cmp(rone))return x.fromRed().subn(1).gcd(n);if(0===x.cmp(rn1))break}if(i===s)return x=x.redSqr(),x.fromRed().subn(1).gcd(n)}}return!1}},{"bn.js":117,brorand:118}],274:[function(require,module,exports){function assert(val,msg){if(!val)throw new Error(msg||"Assertion failed")}module.exports=assert,assert.equal=function(l,r,msg){if(l!=r)throw new Error(msg||"Assertion failed: "+l+" != "+r)}},{}],275:[function(require,module,exports){"use strict";function toArray(msg,enc){if(Array.isArray(msg))return msg.slice();if(!msg)return[];var res=[];if("string"!=typeof msg){for(var i=0;i<msg.length;i++)res[i]=0|msg[i];return res}if("hex"===enc){msg=msg.replace(/[^a-z0-9]+/gi,""),msg.length%2!==0&&(msg="0"+msg);for(var i=0;i<msg.length;i+=2)res.push(parseInt(msg[i]+msg[i+1],16))}else for(var i=0;i<msg.length;i++){var c=msg.charCodeAt(i),hi=c>>8,lo=255&c;hi?res.push(hi,lo):res.push(lo)}return res}function zero2(word){return 1===word.length?"0"+word:word}function toHex(msg){for(var res="",i=0;i<msg.length;i++)res+=zero2(msg[i].toString(16));return res}var utils=exports;utils.toArray=toArray,utils.zero2=zero2,utils.toHex=toHex,utils.encode=function(arr,enc){return"hex"===enc?toHex(arr):arr}},{}],276:[function(require,module,exports){exports.endianness=function(){return"LE"},exports.hostname=function(){return"undefined"!=typeof location?location.hostname:""},exports.loadavg=function(){return[]},exports.uptime=function(){return 0},exports.freemem=function(){return Number.MAX_VALUE},exports.totalmem=function(){return Number.MAX_VALUE},exports.cpus=function(){return[]},exports.type=function(){return"Browser"},exports.release=function(){return"undefined"!=typeof navigator?navigator.appVersion:""},exports.networkInterfaces=exports.getNetworkInterfaces=function(){return{}},exports.arch=function(){return"javascript"},exports.platform=function(){return"browser"},exports.tmpdir=exports.tmpDir=function(){return"/tmp"},exports.EOL="\n",exports.homedir=function(){return"/"}},{}],277:[function(require,module,exports){"use strict";var assign=require("./lib/utils/common").assign,deflate=require("./lib/deflate"),inflate=require("./lib/inflate"),constants=require("./lib/zlib/constants"),pako={};assign(pako,deflate,inflate,constants),module.exports=pako},{"./lib/deflate":278,"./lib/inflate":279,"./lib/utils/common":280,"./lib/zlib/constants":283}],278:[function(require,module,exports){"use strict";function Deflate(options){if(!(this instanceof Deflate))return new Deflate(options);this.options=utils.assign({level:Z_DEFAULT_COMPRESSION,method:Z_DEFLATED,chunkSize:16384,windowBits:15,memLevel:8,strategy:Z_DEFAULT_STRATEGY,to:""},options||{});var opt=this.options;opt.raw&&opt.windowBits>0?opt.windowBits=-opt.windowBits:opt.gzip&&opt.windowBits>0&&opt.windowBits<16&&(opt.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new ZStream,this.strm.avail_out=0;var status=zlib_deflate.deflateInit2(this.strm,opt.level,opt.method,opt.windowBits,opt.memLevel,opt.strategy);if(status!==Z_OK)throw new Error(msg[status]);if(opt.header&&zlib_deflate.deflateSetHeader(this.strm,opt.header),opt.dictionary){var dict;if(dict="string"==typeof opt.dictionary?strings.string2buf(opt.dictionary):"[object ArrayBuffer]"===toString.call(opt.dictionary)?new Uint8Array(opt.dictionary):opt.dictionary,status=zlib_deflate.deflateSetDictionary(this.strm,dict),status!==Z_OK)throw new Error(msg[status]);this._dict_set=!0}}function deflate(input,options){var deflator=new Deflate(options);if(deflator.push(input,!0),deflator.err)throw deflator.msg||msg[deflator.err];return deflator.result}function deflateRaw(input,options){return options=options||{},options.raw=!0,deflate(input,options)}function gzip(input,options){return options=options||{},options.gzip=!0,deflate(input,options)}var zlib_deflate=require("./zlib/deflate"),utils=require("./utils/common"),strings=require("./utils/strings"),msg=require("./zlib/messages"),ZStream=require("./zlib/zstream"),toString=Object.prototype.toString,Z_NO_FLUSH=0,Z_FINISH=4,Z_OK=0,Z_STREAM_END=1,Z_SYNC_FLUSH=2,Z_DEFAULT_COMPRESSION=-1,Z_DEFAULT_STRATEGY=0,Z_DEFLATED=8;Deflate.prototype.push=function(data,mode){var status,_mode,strm=this.strm,chunkSize=this.options.chunkSize;if(this.ended)return!1;_mode=mode===~~mode?mode:mode===!0?Z_FINISH:Z_NO_FLUSH,"string"==typeof data?strm.input=strings.string2buf(data):"[object ArrayBuffer]"===toString.call(data)?strm.input=new Uint8Array(data):strm.input=data,strm.next_in=0,strm.avail_in=strm.input.length;do{if(0===strm.avail_out&&(strm.output=new utils.Buf8(chunkSize),strm.next_out=0,strm.avail_out=chunkSize),status=zlib_deflate.deflate(strm,_mode),status!==Z_STREAM_END&&status!==Z_OK)return this.onEnd(status),this.ended=!0,!1;0!==strm.avail_out&&(0!==strm.avail_in||_mode!==Z_FINISH&&_mode!==Z_SYNC_FLUSH)||("string"===this.options.to?this.onData(strings.buf2binstring(utils.shrinkBuf(strm.output,strm.next_out))):this.onData(utils.shrinkBuf(strm.output,strm.next_out)))}while((strm.avail_in>0||0===strm.avail_out)&&status!==Z_STREAM_END);return _mode===Z_FINISH?(status=zlib_deflate.deflateEnd(this.strm),this.onEnd(status),this.ended=!0,status===Z_OK):_mode!==Z_SYNC_FLUSH||(this.onEnd(Z_OK),strm.avail_out=0,!0)},Deflate.prototype.onData=function(chunk){this.chunks.push(chunk)},Deflate.prototype.onEnd=function(status){status===Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=utils.flattenChunks(this.chunks)),this.chunks=[],this.err=status,this.msg=this.strm.msg},exports.Deflate=Deflate,exports.deflate=deflate,exports.deflateRaw=deflateRaw,exports.gzip=gzip},{"./utils/common":280,"./utils/strings":281,"./zlib/deflate":285,"./zlib/messages":290,"./zlib/zstream":292}],279:[function(require,module,exports){"use strict";function Inflate(options){if(!(this instanceof Inflate))return new Inflate(options);this.options=utils.assign({chunkSize:16384,windowBits:0,to:""},options||{});var opt=this.options;opt.raw&&opt.windowBits>=0&&opt.windowBits<16&&(opt.windowBits=-opt.windowBits,0===opt.windowBits&&(opt.windowBits=-15)),!(opt.windowBits>=0&&opt.windowBits<16)||options&&options.windowBits||(opt.windowBits+=32),opt.windowBits>15&&opt.windowBits<48&&0===(15&opt.windowBits)&&(opt.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new ZStream,this.strm.avail_out=0;var status=zlib_inflate.inflateInit2(this.strm,opt.windowBits);if(status!==c.Z_OK)throw new Error(msg[status]);this.header=new GZheader,zlib_inflate.inflateGetHeader(this.strm,this.header)}function inflate(input,options){var inflator=new Inflate(options);if(inflator.push(input,!0),inflator.err)throw inflator.msg||msg[inflator.err];return inflator.result}function inflateRaw(input,options){return options=options||{},options.raw=!0,inflate(input,options)}var zlib_inflate=require("./zlib/inflate"),utils=require("./utils/common"),strings=require("./utils/strings"),c=require("./zlib/constants"),msg=require("./zlib/messages"),ZStream=require("./zlib/zstream"),GZheader=require("./zlib/gzheader"),toString=Object.prototype.toString;Inflate.prototype.push=function(data,mode){var status,_mode,next_out_utf8,tail,utf8str,dict,strm=this.strm,chunkSize=this.options.chunkSize,dictionary=this.options.dictionary,allowBufError=!1;if(this.ended)return!1;_mode=mode===~~mode?mode:mode===!0?c.Z_FINISH:c.Z_NO_FLUSH,"string"==typeof data?strm.input=strings.binstring2buf(data):"[object ArrayBuffer]"===toString.call(data)?strm.input=new Uint8Array(data):strm.input=data,strm.next_in=0,strm.avail_in=strm.input.length;do{if(0===strm.avail_out&&(strm.output=new utils.Buf8(chunkSize),strm.next_out=0,strm.avail_out=chunkSize),status=zlib_inflate.inflate(strm,c.Z_NO_FLUSH),status===c.Z_NEED_DICT&&dictionary&&(dict="string"==typeof dictionary?strings.string2buf(dictionary):"[object ArrayBuffer]"===toString.call(dictionary)?new Uint8Array(dictionary):dictionary,status=zlib_inflate.inflateSetDictionary(this.strm,dict)),status===c.Z_BUF_ERROR&&allowBufError===!0&&(status=c.Z_OK,allowBufError=!1),status!==c.Z_STREAM_END&&status!==c.Z_OK)return this.onEnd(status),this.ended=!0,!1;strm.next_out&&(0!==strm.avail_out&&status!==c.Z_STREAM_END&&(0!==strm.avail_in||_mode!==c.Z_FINISH&&_mode!==c.Z_SYNC_FLUSH)||("string"===this.options.to?(next_out_utf8=strings.utf8border(strm.output,strm.next_out),tail=strm.next_out-next_out_utf8,utf8str=strings.buf2string(strm.output,next_out_utf8),strm.next_out=tail,strm.avail_out=chunkSize-tail,tail&&utils.arraySet(strm.output,strm.output,next_out_utf8,tail,0),this.onData(utf8str)):this.onData(utils.shrinkBuf(strm.output,strm.next_out)))),0===strm.avail_in&&0===strm.avail_out&&(allowBufError=!0)}while((strm.avail_in>0||0===strm.avail_out)&&status!==c.Z_STREAM_END);return status===c.Z_STREAM_END&&(_mode=c.Z_FINISH),_mode===c.Z_FINISH?(status=zlib_inflate.inflateEnd(this.strm),this.onEnd(status),this.ended=!0,status===c.Z_OK):_mode!==c.Z_SYNC_FLUSH||(this.onEnd(c.Z_OK),strm.avail_out=0,!0);
},Inflate.prototype.onData=function(chunk){this.chunks.push(chunk)},Inflate.prototype.onEnd=function(status){status===c.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=utils.flattenChunks(this.chunks)),this.chunks=[],this.err=status,this.msg=this.strm.msg},exports.Inflate=Inflate,exports.inflate=inflate,exports.inflateRaw=inflateRaw,exports.ungzip=inflate},{"./utils/common":280,"./utils/strings":281,"./zlib/constants":283,"./zlib/gzheader":286,"./zlib/inflate":288,"./zlib/messages":290,"./zlib/zstream":292}],280:[function(require,module,exports){"use strict";function _has(obj,key){return Object.prototype.hasOwnProperty.call(obj,key)}var TYPED_OK="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;exports.assign=function(obj){for(var sources=Array.prototype.slice.call(arguments,1);sources.length;){var source=sources.shift();if(source){if("object"!=typeof source)throw new TypeError(source+"must be non-object");for(var p in source)_has(source,p)&&(obj[p]=source[p])}}return obj},exports.shrinkBuf=function(buf,size){return buf.length===size?buf:buf.subarray?buf.subarray(0,size):(buf.length=size,buf)};var fnTyped={arraySet:function(dest,src,src_offs,len,dest_offs){if(src.subarray&&dest.subarray)return void dest.set(src.subarray(src_offs,src_offs+len),dest_offs);for(var i=0;i<len;i++)dest[dest_offs+i]=src[src_offs+i]},flattenChunks:function(chunks){var i,l,len,pos,chunk,result;for(len=0,i=0,l=chunks.length;i<l;i++)len+=chunks[i].length;for(result=new Uint8Array(len),pos=0,i=0,l=chunks.length;i<l;i++)chunk=chunks[i],result.set(chunk,pos),pos+=chunk.length;return result}},fnUntyped={arraySet:function(dest,src,src_offs,len,dest_offs){for(var i=0;i<len;i++)dest[dest_offs+i]=src[src_offs+i]},flattenChunks:function(chunks){return[].concat.apply([],chunks)}};exports.setTyped=function(on){on?(exports.Buf8=Uint8Array,exports.Buf16=Uint16Array,exports.Buf32=Int32Array,exports.assign(exports,fnTyped)):(exports.Buf8=Array,exports.Buf16=Array,exports.Buf32=Array,exports.assign(exports,fnUntyped))},exports.setTyped(TYPED_OK)},{}],281:[function(require,module,exports){"use strict";function buf2binstring(buf,len){if(len<65537&&(buf.subarray&&STR_APPLY_UIA_OK||!buf.subarray&&STR_APPLY_OK))return String.fromCharCode.apply(null,utils.shrinkBuf(buf,len));for(var result="",i=0;i<len;i++)result+=String.fromCharCode(buf[i]);return result}var utils=require("./common"),STR_APPLY_OK=!0,STR_APPLY_UIA_OK=!0;try{String.fromCharCode.apply(null,[0])}catch(__){STR_APPLY_OK=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(__){STR_APPLY_UIA_OK=!1}for(var _utf8len=new utils.Buf8(256),q=0;q<256;q++)_utf8len[q]=q>=252?6:q>=248?5:q>=240?4:q>=224?3:q>=192?2:1;_utf8len[254]=_utf8len[254]=1,exports.string2buf=function(str){var buf,c,c2,m_pos,i,str_len=str.length,buf_len=0;for(m_pos=0;m_pos<str_len;m_pos++)c=str.charCodeAt(m_pos),55296===(64512&c)&&m_pos+1<str_len&&(c2=str.charCodeAt(m_pos+1),56320===(64512&c2)&&(c=65536+(c-55296<<10)+(c2-56320),m_pos++)),buf_len+=c<128?1:c<2048?2:c<65536?3:4;for(buf=new utils.Buf8(buf_len),i=0,m_pos=0;i<buf_len;m_pos++)c=str.charCodeAt(m_pos),55296===(64512&c)&&m_pos+1<str_len&&(c2=str.charCodeAt(m_pos+1),56320===(64512&c2)&&(c=65536+(c-55296<<10)+(c2-56320),m_pos++)),c<128?buf[i++]=c:c<2048?(buf[i++]=192|c>>>6,buf[i++]=128|63&c):c<65536?(buf[i++]=224|c>>>12,buf[i++]=128|c>>>6&63,buf[i++]=128|63&c):(buf[i++]=240|c>>>18,buf[i++]=128|c>>>12&63,buf[i++]=128|c>>>6&63,buf[i++]=128|63&c);return buf},exports.buf2binstring=function(buf){return buf2binstring(buf,buf.length)},exports.binstring2buf=function(str){for(var buf=new utils.Buf8(str.length),i=0,len=buf.length;i<len;i++)buf[i]=str.charCodeAt(i);return buf},exports.buf2string=function(buf,max){var i,out,c,c_len,len=max||buf.length,utf16buf=new Array(2*len);for(out=0,i=0;i<len;)if(c=buf[i++],c<128)utf16buf[out++]=c;else if(c_len=_utf8len[c],c_len>4)utf16buf[out++]=65533,i+=c_len-1;else{for(c&=2===c_len?31:3===c_len?15:7;c_len>1&&i<len;)c=c<<6|63&buf[i++],c_len--;c_len>1?utf16buf[out++]=65533:c<65536?utf16buf[out++]=c:(c-=65536,utf16buf[out++]=55296|c>>10&1023,utf16buf[out++]=56320|1023&c)}return buf2binstring(utf16buf,out)},exports.utf8border=function(buf,max){var pos;for(max=max||buf.length,max>buf.length&&(max=buf.length),pos=max-1;pos>=0&&128===(192&buf[pos]);)pos--;return pos<0?max:0===pos?max:pos+_utf8len[buf[pos]]>max?pos:max}},{"./common":280}],282:[function(require,module,exports){"use strict";function adler32(adler,buf,len,pos){for(var s1=65535&adler|0,s2=adler>>>16&65535|0,n=0;0!==len;){n=len>2e3?2e3:len,len-=n;do s1=s1+buf[pos++]|0,s2=s2+s1|0;while(--n);s1%=65521,s2%=65521}return s1|s2<<16|0}module.exports=adler32},{}],283:[function(require,module,exports){"use strict";module.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],284:[function(require,module,exports){"use strict";function makeTable(){for(var c,table=[],n=0;n<256;n++){c=n;for(var k=0;k<8;k++)c=1&c?3988292384^c>>>1:c>>>1;table[n]=c}return table}function crc32(crc,buf,len,pos){var t=crcTable,end=pos+len;crc^=-1;for(var i=pos;i<end;i++)crc=crc>>>8^t[255&(crc^buf[i])];return crc^-1}var crcTable=makeTable();module.exports=crc32},{}],285:[function(require,module,exports){"use strict";function err(strm,errorCode){return strm.msg=msg[errorCode],errorCode}function rank(f){return(f<<1)-(f>4?9:0)}function zero(buf){for(var len=buf.length;--len>=0;)buf[len]=0}function flush_pending(strm){var s=strm.state,len=s.pending;len>strm.avail_out&&(len=strm.avail_out),0!==len&&(utils.arraySet(strm.output,s.pending_buf,s.pending_out,len,strm.next_out),strm.next_out+=len,s.pending_out+=len,strm.total_out+=len,strm.avail_out-=len,s.pending-=len,0===s.pending&&(s.pending_out=0))}function flush_block_only(s,last){trees._tr_flush_block(s,s.block_start>=0?s.block_start:-1,s.strstart-s.block_start,last),s.block_start=s.strstart,flush_pending(s.strm)}function put_byte(s,b){s.pending_buf[s.pending++]=b}function putShortMSB(s,b){s.pending_buf[s.pending++]=b>>>8&255,s.pending_buf[s.pending++]=255&b}function read_buf(strm,buf,start,size){var len=strm.avail_in;return len>size&&(len=size),0===len?0:(strm.avail_in-=len,utils.arraySet(buf,strm.input,strm.next_in,len,start),1===strm.state.wrap?strm.adler=adler32(strm.adler,buf,len,start):2===strm.state.wrap&&(strm.adler=crc32(strm.adler,buf,len,start)),strm.next_in+=len,strm.total_in+=len,len)}function longest_match(s,cur_match){var match,len,chain_length=s.max_chain_length,scan=s.strstart,best_len=s.prev_length,nice_match=s.nice_match,limit=s.strstart>s.w_size-MIN_LOOKAHEAD?s.strstart-(s.w_size-MIN_LOOKAHEAD):0,_win=s.window,wmask=s.w_mask,prev=s.prev,strend=s.strstart+MAX_MATCH,scan_end1=_win[scan+best_len-1],scan_end=_win[scan+best_len];s.prev_length>=s.good_match&&(chain_length>>=2),nice_match>s.lookahead&&(nice_match=s.lookahead);do if(match=cur_match,_win[match+best_len]===scan_end&&_win[match+best_len-1]===scan_end1&&_win[match]===_win[scan]&&_win[++match]===_win[scan+1]){scan+=2,match++;do;while(_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&scan<strend);if(len=MAX_MATCH-(strend-scan),scan=strend-MAX_MATCH,len>best_len){if(s.match_start=cur_match,best_len=len,len>=nice_match)break;scan_end1=_win[scan+best_len-1],scan_end=_win[scan+best_len]}}while((cur_match=prev[cur_match&wmask])>limit&&0!==--chain_length);return best_len<=s.lookahead?best_len:s.lookahead}function fill_window(s){var p,n,m,more,str,_w_size=s.w_size;do{if(more=s.window_size-s.lookahead-s.strstart,s.strstart>=_w_size+(_w_size-MIN_LOOKAHEAD)){utils.arraySet(s.window,s.window,_w_size,_w_size,0),s.match_start-=_w_size,s.strstart-=_w_size,s.block_start-=_w_size,n=s.hash_size,p=n;do m=s.head[--p],s.head[p]=m>=_w_size?m-_w_size:0;while(--n);n=_w_size,p=n;do m=s.prev[--p],s.prev[p]=m>=_w_size?m-_w_size:0;while(--n);more+=_w_size}if(0===s.strm.avail_in)break;if(n=read_buf(s.strm,s.window,s.strstart+s.lookahead,more),s.lookahead+=n,s.lookahead+s.insert>=MIN_MATCH)for(str=s.strstart-s.insert,s.ins_h=s.window[str],s.ins_h=(s.ins_h<<s.hash_shift^s.window[str+1])&s.hash_mask;s.insert&&(s.ins_h=(s.ins_h<<s.hash_shift^s.window[str+MIN_MATCH-1])&s.hash_mask,s.prev[str&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=str,str++,s.insert--,!(s.lookahead+s.insert<MIN_MATCH)););}while(s.lookahead<MIN_LOOKAHEAD&&0!==s.strm.avail_in)}function deflate_stored(s,flush){var max_block_size=65535;for(max_block_size>s.pending_buf_size-5&&(max_block_size=s.pending_buf_size-5);;){if(s.lookahead<=1){if(fill_window(s),0===s.lookahead&&flush===Z_NO_FLUSH)return BS_NEED_MORE;if(0===s.lookahead)break}s.strstart+=s.lookahead,s.lookahead=0;var max_start=s.block_start+max_block_size;if((0===s.strstart||s.strstart>=max_start)&&(s.lookahead=s.strstart-max_start,s.strstart=max_start,flush_block_only(s,!1),0===s.strm.avail_out))return BS_NEED_MORE;if(s.strstart-s.block_start>=s.w_size-MIN_LOOKAHEAD&&(flush_block_only(s,!1),0===s.strm.avail_out))return BS_NEED_MORE}return s.insert=0,flush===Z_FINISH?(flush_block_only(s,!0),0===s.strm.avail_out?BS_FINISH_STARTED:BS_FINISH_DONE):s.strstart>s.block_start&&(flush_block_only(s,!1),0===s.strm.avail_out)?BS_NEED_MORE:BS_NEED_MORE}function deflate_fast(s,flush){for(var hash_head,bflush;;){if(s.lookahead<MIN_LOOKAHEAD){if(fill_window(s),s.lookahead<MIN_LOOKAHEAD&&flush===Z_NO_FLUSH)return BS_NEED_MORE;if(0===s.lookahead)break}if(hash_head=0,s.lookahead>=MIN_MATCH&&(s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+MIN_MATCH-1])&s.hash_mask,hash_head=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=s.strstart),0!==hash_head&&s.strstart-hash_head<=s.w_size-MIN_LOOKAHEAD&&(s.match_length=longest_match(s,hash_head)),s.match_length>=MIN_MATCH)if(bflush=trees._tr_tally(s,s.strstart-s.match_start,s.match_length-MIN_MATCH),s.lookahead-=s.match_length,s.match_length<=s.max_lazy_match&&s.lookahead>=MIN_MATCH){s.match_length--;do s.strstart++,s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+MIN_MATCH-1])&s.hash_mask,hash_head=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=s.strstart;while(0!==--s.match_length);s.strstart++}else s.strstart+=s.match_length,s.match_length=0,s.ins_h=s.window[s.strstart],s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+1])&s.hash_mask;else bflush=trees._tr_tally(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++;if(bflush&&(flush_block_only(s,!1),0===s.strm.avail_out))return BS_NEED_MORE}return s.insert=s.strstart<MIN_MATCH-1?s.strstart:MIN_MATCH-1,flush===Z_FINISH?(flush_block_only(s,!0),0===s.strm.avail_out?BS_FINISH_STARTED:BS_FINISH_DONE):s.last_lit&&(flush_block_only(s,!1),0===s.strm.avail_out)?BS_NEED_MORE:BS_BLOCK_DONE}function deflate_slow(s,flush){for(var hash_head,bflush,max_insert;;){if(s.lookahead<MIN_LOOKAHEAD){if(fill_window(s),s.lookahead<MIN_LOOKAHEAD&&flush===Z_NO_FLUSH)return BS_NEED_MORE;if(0===s.lookahead)break}if(hash_head=0,s.lookahead>=MIN_MATCH&&(s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+MIN_MATCH-1])&s.hash_mask,hash_head=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=s.strstart),s.prev_length=s.match_length,s.prev_match=s.match_start,s.match_length=MIN_MATCH-1,0!==hash_head&&s.prev_length<s.max_lazy_match&&s.strstart-hash_head<=s.w_size-MIN_LOOKAHEAD&&(s.match_length=longest_match(s,hash_head),s.match_length<=5&&(s.strategy===Z_FILTERED||s.match_length===MIN_MATCH&&s.strstart-s.match_start>4096)&&(s.match_length=MIN_MATCH-1)),s.prev_length>=MIN_MATCH&&s.match_length<=s.prev_length){max_insert=s.strstart+s.lookahead-MIN_MATCH,bflush=trees._tr_tally(s,s.strstart-1-s.prev_match,s.prev_length-MIN_MATCH),s.lookahead-=s.prev_length-1,s.prev_length-=2;do++s.strstart<=max_insert&&(s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+MIN_MATCH-1])&s.hash_mask,hash_head=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=s.strstart);while(0!==--s.prev_length);if(s.match_available=0,s.match_length=MIN_MATCH-1,s.strstart++,bflush&&(flush_block_only(s,!1),0===s.strm.avail_out))return BS_NEED_MORE}else if(s.match_available){if(bflush=trees._tr_tally(s,0,s.window[s.strstart-1]),bflush&&flush_block_only(s,!1),s.strstart++,s.lookahead--,0===s.strm.avail_out)return BS_NEED_MORE}else s.match_available=1,s.strstart++,s.lookahead--}return s.match_available&&(bflush=trees._tr_tally(s,0,s.window[s.strstart-1]),s.match_available=0),s.insert=s.strstart<MIN_MATCH-1?s.strstart:MIN_MATCH-1,flush===Z_FINISH?(flush_block_only(s,!0),0===s.strm.avail_out?BS_FINISH_STARTED:BS_FINISH_DONE):s.last_lit&&(flush_block_only(s,!1),0===s.strm.avail_out)?BS_NEED_MORE:BS_BLOCK_DONE}function deflate_rle(s,flush){for(var bflush,prev,scan,strend,_win=s.window;;){if(s.lookahead<=MAX_MATCH){if(fill_window(s),s.lookahead<=MAX_MATCH&&flush===Z_NO_FLUSH)return BS_NEED_MORE;if(0===s.lookahead)break}if(s.match_length=0,s.lookahead>=MIN_MATCH&&s.strstart>0&&(scan=s.strstart-1,prev=_win[scan],prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan])){strend=s.strstart+MAX_MATCH;do;while(prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&scan<strend);s.match_length=MAX_MATCH-(strend-scan),s.match_length>s.lookahead&&(s.match_length=s.lookahead)}if(s.match_length>=MIN_MATCH?(bflush=trees._tr_tally(s,1,s.match_length-MIN_MATCH),s.lookahead-=s.match_length,s.strstart+=s.match_length,s.match_length=0):(bflush=trees._tr_tally(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++),bflush&&(flush_block_only(s,!1),0===s.strm.avail_out))return BS_NEED_MORE}return s.insert=0,flush===Z_FINISH?(flush_block_only(s,!0),0===s.strm.avail_out?BS_FINISH_STARTED:BS_FINISH_DONE):s.last_lit&&(flush_block_only(s,!1),0===s.strm.avail_out)?BS_NEED_MORE:BS_BLOCK_DONE}function deflate_huff(s,flush){for(var bflush;;){if(0===s.lookahead&&(fill_window(s),0===s.lookahead)){if(flush===Z_NO_FLUSH)return BS_NEED_MORE;break}if(s.match_length=0,bflush=trees._tr_tally(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++,bflush&&(flush_block_only(s,!1),0===s.strm.avail_out))return BS_NEED_MORE}return s.insert=0,flush===Z_FINISH?(flush_block_only(s,!0),0===s.strm.avail_out?BS_FINISH_STARTED:BS_FINISH_DONE):s.last_lit&&(flush_block_only(s,!1),0===s.strm.avail_out)?BS_NEED_MORE:BS_BLOCK_DONE}function Config(good_length,max_lazy,nice_length,max_chain,func){this.good_length=good_length,this.max_lazy=max_lazy,this.nice_length=nice_length,this.max_chain=max_chain,this.func=func}function lm_init(s){s.window_size=2*s.w_size,zero(s.head),s.max_lazy_match=configuration_table[s.level].max_lazy,s.good_match=configuration_table[s.level].good_length,s.nice_match=configuration_table[s.level].nice_length,s.max_chain_length=configuration_table[s.level].max_chain,s.strstart=0,s.block_start=0,s.lookahead=0,s.insert=0,s.match_length=s.prev_length=MIN_MATCH-1,s.match_available=0,s.ins_h=0}function DeflateState(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Z_DEFLATED,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new utils.Buf16(2*HEAP_SIZE),this.dyn_dtree=new utils.Buf16(2*(2*D_CODES+1)),this.bl_tree=new utils.Buf16(2*(2*BL_CODES+1)),zero(this.dyn_ltree),zero(this.dyn_dtree),zero(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new utils.Buf16(MAX_BITS+1),this.heap=new utils.Buf16(2*L_CODES+1),zero(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new utils.Buf16(2*L_CODES+1),zero(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function deflateResetKeep(strm){var s;return strm&&strm.state?(strm.total_in=strm.total_out=0,strm.data_type=Z_UNKNOWN,s=strm.state,s.pending=0,s.pending_out=0,s.wrap<0&&(s.wrap=-s.wrap),s.status=s.wrap?INIT_STATE:BUSY_STATE,strm.adler=2===s.wrap?0:1,s.last_flush=Z_NO_FLUSH,trees._tr_init(s),Z_OK):err(strm,Z_STREAM_ERROR)}function deflateReset(strm){var ret=deflateResetKeep(strm);return ret===Z_OK&&lm_init(strm.state),ret}function deflateSetHeader(strm,head){return strm&&strm.state?2!==strm.state.wrap?Z_STREAM_ERROR:(strm.state.gzhead=head,Z_OK):Z_STREAM_ERROR}function deflateInit2(strm,level,method,windowBits,memLevel,strategy){if(!strm)return Z_STREAM_ERROR;var wrap=1;if(level===Z_DEFAULT_COMPRESSION&&(level=6),windowBits<0?(wrap=0,windowBits=-windowBits):windowBits>15&&(wrap=2,windowBits-=16),memLevel<1||memLevel>MAX_MEM_LEVEL||method!==Z_DEFLATED||windowBits<8||windowBits>15||level<0||level>9||strategy<0||strategy>Z_FIXED)return err(strm,Z_STREAM_ERROR);8===windowBits&&(windowBits=9);var s=new DeflateState;return strm.state=s,s.strm=strm,s.wrap=wrap,s.gzhead=null,s.w_bits=windowBits,s.w_size=1<<s.w_bits,s.w_mask=s.w_size-1,s.hash_bits=memLevel+7,s.hash_size=1<<s.hash_bits,s.hash_mask=s.hash_size-1,s.hash_shift=~~((s.hash_bits+MIN_MATCH-1)/MIN_MATCH),s.window=new utils.Buf8(2*s.w_size),s.head=new utils.Buf16(s.hash_size),s.prev=new utils.Buf16(s.w_size),s.lit_bufsize=1<<memLevel+6,s.pending_buf_size=4*s.lit_bufsize,s.pending_buf=new utils.Buf8(s.pending_buf_size),s.d_buf=1*s.lit_bufsize,s.l_buf=3*s.lit_bufsize,s.level=level,s.strategy=strategy,s.method=method,deflateReset(strm)}function deflateInit(strm,level){return deflateInit2(strm,level,Z_DEFLATED,MAX_WBITS,DEF_MEM_LEVEL,Z_DEFAULT_STRATEGY)}function deflate(strm,flush){var old_flush,s,beg,val;if(!strm||!strm.state||flush>Z_BLOCK||flush<0)return strm?err(strm,Z_STREAM_ERROR):Z_STREAM_ERROR;if(s=strm.state,!strm.output||!strm.input&&0!==strm.avail_in||s.status===FINISH_STATE&&flush!==Z_FINISH)return err(strm,0===strm.avail_out?Z_BUF_ERROR:Z_STREAM_ERROR);if(s.strm=strm,old_flush=s.last_flush,s.last_flush=flush,s.status===INIT_STATE)if(2===s.wrap)strm.adler=0,put_byte(s,31),put_byte(s,139),put_byte(s,8),s.gzhead?(put_byte(s,(s.gzhead.text?1:0)+(s.gzhead.hcrc?2:0)+(s.gzhead.extra?4:0)+(s.gzhead.name?8:0)+(s.gzhead.comment?16:0)),put_byte(s,255&s.gzhead.time),put_byte(s,s.gzhead.time>>8&255),put_byte(s,s.gzhead.time>>16&255),put_byte(s,s.gzhead.time>>24&255),put_byte(s,9===s.level?2:s.strategy>=Z_HUFFMAN_ONLY||s.level<2?4:0),put_byte(s,255&s.gzhead.os),s.gzhead.extra&&s.gzhead.extra.length&&(put_byte(s,255&s.gzhead.extra.length),put_byte(s,s.gzhead.extra.length>>8&255)),s.gzhead.hcrc&&(strm.adler=crc32(strm.adler,s.pending_buf,s.pending,0)),s.gzindex=0,s.status=EXTRA_STATE):(put_byte(s,0),put_byte(s,0),put_byte(s,0),put_byte(s,0),put_byte(s,0),put_byte(s,9===s.level?2:s.strategy>=Z_HUFFMAN_ONLY||s.level<2?4:0),put_byte(s,OS_CODE),s.status=BUSY_STATE);else{var header=Z_DEFLATED+(s.w_bits-8<<4)<<8,level_flags=-1;level_flags=s.strategy>=Z_HUFFMAN_ONLY||s.level<2?0:s.level<6?1:6===s.level?2:3,header|=level_flags<<6,0!==s.strstart&&(header|=PRESET_DICT),header+=31-header%31,s.status=BUSY_STATE,putShortMSB(s,header),0!==s.strstart&&(putShortMSB(s,strm.adler>>>16),putShortMSB(s,65535&strm.adler)),strm.adler=1}if(s.status===EXTRA_STATE)if(s.gzhead.extra){for(beg=s.pending;s.gzindex<(65535&s.gzhead.extra.length)&&(s.pending!==s.pending_buf_size||(s.gzhead.hcrc&&s.pending>beg&&(strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)),flush_pending(strm),beg=s.pending,s.pending!==s.pending_buf_size));)put_byte(s,255&s.gzhead.extra[s.gzindex]),s.gzindex++;s.gzhead.hcrc&&s.pending>beg&&(strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)),s.gzindex===s.gzhead.extra.length&&(s.gzindex=0,s.status=NAME_STATE)}else s.status=NAME_STATE;if(s.status===NAME_STATE)if(s.gzhead.name){beg=s.pending;do{if(s.pending===s.pending_buf_size&&(s.gzhead.hcrc&&s.pending>beg&&(strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)),flush_pending(strm),beg=s.pending,s.pending===s.pending_buf_size)){val=1;break}val=s.gzindex<s.gzhead.name.length?255&s.gzhead.name.charCodeAt(s.gzindex++):0,put_byte(s,val)}while(0!==val);s.gzhead.hcrc&&s.pending>beg&&(strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)),0===val&&(s.gzindex=0,s.status=COMMENT_STATE)}else s.status=COMMENT_STATE;if(s.status===COMMENT_STATE)if(s.gzhead.comment){beg=s.pending;do{if(s.pending===s.pending_buf_size&&(s.gzhead.hcrc&&s.pending>beg&&(strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)),flush_pending(strm),beg=s.pending,s.pending===s.pending_buf_size)){val=1;break}val=s.gzindex<s.gzhead.comment.length?255&s.gzhead.comment.charCodeAt(s.gzindex++):0,put_byte(s,val)}while(0!==val);s.gzhead.hcrc&&s.pending>beg&&(strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)),0===val&&(s.status=HCRC_STATE)}else s.status=HCRC_STATE;if(s.status===HCRC_STATE&&(s.gzhead.hcrc?(s.pending+2>s.pending_buf_size&&flush_pending(strm),s.pending+2<=s.pending_buf_size&&(put_byte(s,255&strm.adler),put_byte(s,strm.adler>>8&255),strm.adler=0,s.status=BUSY_STATE)):s.status=BUSY_STATE),0!==s.pending){if(flush_pending(strm),0===strm.avail_out)return s.last_flush=-1,Z_OK}else if(0===strm.avail_in&&rank(flush)<=rank(old_flush)&&flush!==Z_FINISH)return err(strm,Z_BUF_ERROR);if(s.status===FINISH_STATE&&0!==strm.avail_in)return err(strm,Z_BUF_ERROR);if(0!==strm.avail_in||0!==s.lookahead||flush!==Z_NO_FLUSH&&s.status!==FINISH_STATE){var bstate=s.strategy===Z_HUFFMAN_ONLY?deflate_huff(s,flush):s.strategy===Z_RLE?deflate_rle(s,flush):configuration_table[s.level].func(s,flush);if(bstate!==BS_FINISH_STARTED&&bstate!==BS_FINISH_DONE||(s.status=FINISH_STATE),bstate===BS_NEED_MORE||bstate===BS_FINISH_STARTED)return 0===strm.avail_out&&(s.last_flush=-1),Z_OK;if(bstate===BS_BLOCK_DONE&&(flush===Z_PARTIAL_FLUSH?trees._tr_align(s):flush!==Z_BLOCK&&(trees._tr_stored_block(s,0,0,!1),flush===Z_FULL_FLUSH&&(zero(s.head),0===s.lookahead&&(s.strstart=0,s.block_start=0,s.insert=0))),flush_pending(strm),0===strm.avail_out))return s.last_flush=-1,Z_OK}return flush!==Z_FINISH?Z_OK:s.wrap<=0?Z_STREAM_END:(2===s.wrap?(put_byte(s,255&strm.adler),put_byte(s,strm.adler>>8&255),put_byte(s,strm.adler>>16&255),put_byte(s,strm.adler>>24&255),put_byte(s,255&strm.total_in),put_byte(s,strm.total_in>>8&255),put_byte(s,strm.total_in>>16&255),put_byte(s,strm.total_in>>24&255)):(putShortMSB(s,strm.adler>>>16),putShortMSB(s,65535&strm.adler)),flush_pending(strm),s.wrap>0&&(s.wrap=-s.wrap),0!==s.pending?Z_OK:Z_STREAM_END)}function deflateEnd(strm){var status;return strm&&strm.state?(status=strm.state.status,status!==INIT_STATE&&status!==EXTRA_STATE&&status!==NAME_STATE&&status!==COMMENT_STATE&&status!==HCRC_STATE&&status!==BUSY_STATE&&status!==FINISH_STATE?err(strm,Z_STREAM_ERROR):(strm.state=null,status===BUSY_STATE?err(strm,Z_DATA_ERROR):Z_OK)):Z_STREAM_ERROR}function deflateSetDictionary(strm,dictionary){var s,str,n,wrap,avail,next,input,tmpDict,dictLength=dictionary.length;if(!strm||!strm.state)return Z_STREAM_ERROR;if(s=strm.state,wrap=s.wrap,2===wrap||1===wrap&&s.status!==INIT_STATE||s.lookahead)return Z_STREAM_ERROR;for(1===wrap&&(strm.adler=adler32(strm.adler,dictionary,dictLength,0)),s.wrap=0,dictLength>=s.w_size&&(0===wrap&&(zero(s.head),s.strstart=0,s.block_start=0,s.insert=0),tmpDict=new utils.Buf8(s.w_size),utils.arraySet(tmpDict,dictionary,dictLength-s.w_size,s.w_size,0),dictionary=tmpDict,dictLength=s.w_size),avail=strm.avail_in,next=strm.next_in,input=strm.input,strm.avail_in=dictLength,strm.next_in=0,strm.input=dictionary,fill_window(s);s.lookahead>=MIN_MATCH;){str=s.strstart,n=s.lookahead-(MIN_MATCH-1);do s.ins_h=(s.ins_h<<s.hash_shift^s.window[str+MIN_MATCH-1])&s.hash_mask,s.prev[str&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=str,str++;while(--n);s.strstart=str,s.lookahead=MIN_MATCH-1,fill_window(s)}return s.strstart+=s.lookahead,s.block_start=s.strstart,s.insert=s.lookahead,s.lookahead=0,s.match_length=s.prev_length=MIN_MATCH-1,s.match_available=0,strm.next_in=next,strm.input=input,strm.avail_in=avail,s.wrap=wrap,Z_OK}var configuration_table,utils=require("../utils/common"),trees=require("./trees"),adler32=require("./adler32"),crc32=require("./crc32"),msg=require("./messages"),Z_NO_FLUSH=0,Z_PARTIAL_FLUSH=1,Z_FULL_FLUSH=3,Z_FINISH=4,Z_BLOCK=5,Z_OK=0,Z_STREAM_END=1,Z_STREAM_ERROR=-2,Z_DATA_ERROR=-3,Z_BUF_ERROR=-5,Z_DEFAULT_COMPRESSION=-1,Z_FILTERED=1,Z_HUFFMAN_ONLY=2,Z_RLE=3,Z_FIXED=4,Z_DEFAULT_STRATEGY=0,Z_UNKNOWN=2,Z_DEFLATED=8,MAX_MEM_LEVEL=9,MAX_WBITS=15,DEF_MEM_LEVEL=8,LENGTH_CODES=29,LITERALS=256,L_CODES=LITERALS+1+LENGTH_CODES,D_CODES=30,BL_CODES=19,HEAP_SIZE=2*L_CODES+1,MAX_BITS=15,MIN_MATCH=3,MAX_MATCH=258,MIN_LOOKAHEAD=MAX_MATCH+MIN_MATCH+1,PRESET_DICT=32,INIT_STATE=42,EXTRA_STATE=69,NAME_STATE=73,COMMENT_STATE=91,HCRC_STATE=103,BUSY_STATE=113,FINISH_STATE=666,BS_NEED_MORE=1,BS_BLOCK_DONE=2,BS_FINISH_STARTED=3,BS_FINISH_DONE=4,OS_CODE=3;configuration_table=[new Config(0,0,0,0,deflate_stored),new Config(4,4,8,4,deflate_fast),new Config(4,5,16,8,deflate_fast),new Config(4,6,32,32,deflate_fast),new Config(4,4,16,16,deflate_slow),new Config(8,16,32,32,deflate_slow),new Config(8,16,128,128,deflate_slow),new Config(8,32,128,256,deflate_slow),new Config(32,128,258,1024,deflate_slow),new Config(32,258,258,4096,deflate_slow)],exports.deflateInit=deflateInit,exports.deflateInit2=deflateInit2,exports.deflateReset=deflateReset,exports.deflateResetKeep=deflateResetKeep,exports.deflateSetHeader=deflateSetHeader,exports.deflate=deflate,exports.deflateEnd=deflateEnd,exports.deflateSetDictionary=deflateSetDictionary,exports.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":280,"./adler32":282,"./crc32":284,"./messages":290,"./trees":291}],286:[function(require,module,exports){"use strict";function GZheader(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}module.exports=GZheader},{}],287:[function(require,module,exports){"use strict";var BAD=30,TYPE=12;module.exports=function(strm,start){var state,_in,last,_out,beg,end,dmax,wsize,whave,wnext,s_window,hold,bits,lcode,dcode,lmask,dmask,here,op,len,dist,from,from_source,input,output;state=strm.state,_in=strm.next_in,input=strm.input,last=_in+(strm.avail_in-5),_out=strm.next_out,output=strm.output,beg=_out-(start-strm.avail_out),end=_out+(strm.avail_out-257),dmax=state.dmax,wsize=state.wsize,whave=state.whave,wnext=state.wnext,s_window=state.window,hold=state.hold,bits=state.bits,lcode=state.lencode,dcode=state.distcode,lmask=(1<<state.lenbits)-1,dmask=(1<<state.distbits)-1;top:do{bits<15&&(hold+=input[_in++]<<bits,bits+=8,hold+=input[_in++]<<bits,bits+=8),here=lcode[hold&lmask];dolen:for(;;){if(op=here>>>24,hold>>>=op,bits-=op,op=here>>>16&255,0===op)output[_out++]=65535&here;else{if(!(16&op)){if(0===(64&op)){here=lcode[(65535&here)+(hold&(1<<op)-1)];continue dolen}if(32&op){state.mode=TYPE;break top}strm.msg="invalid literal/length code",state.mode=BAD;break top}len=65535&here,op&=15,op&&(bits<op&&(hold+=input[_in++]<<bits,bits+=8),len+=hold&(1<<op)-1,hold>>>=op,bits-=op),bits<15&&(hold+=input[_in++]<<bits,bits+=8,hold+=input[_in++]<<bits,bits+=8),here=dcode[hold&dmask];dodist:for(;;){if(op=here>>>24,hold>>>=op,bits-=op,op=here>>>16&255,!(16&op)){if(0===(64&op)){here=dcode[(65535&here)+(hold&(1<<op)-1)];continue dodist}strm.msg="invalid distance code",state.mode=BAD;break top}if(dist=65535&here,op&=15,bits<op&&(hold+=input[_in++]<<bits,bits+=8,bits<op&&(hold+=input[_in++]<<bits,bits+=8)),dist+=hold&(1<<op)-1,dist>dmax){strm.msg="invalid distance too far back",state.mode=BAD;break top}if(hold>>>=op,bits-=op,op=_out-beg,dist>op){if(op=dist-op,op>whave&&state.sane){strm.msg="invalid distance too far back",state.mode=BAD;break top}if(from=0,from_source=s_window,0===wnext){if(from+=wsize-op,op<len){len-=op;do output[_out++]=s_window[from++];while(--op);from=_out-dist,from_source=output}}else if(wnext<op){if(from+=wsize+wnext-op,op-=wnext,op<len){len-=op;do output[_out++]=s_window[from++];while(--op);if(from=0,wnext<len){op=wnext,len-=op;do output[_out++]=s_window[from++];while(--op);from=_out-dist,from_source=output}}}else if(from+=wnext-op,op<len){len-=op;do output[_out++]=s_window[from++];while(--op);from=_out-dist,from_source=output}for(;len>2;)output[_out++]=from_source[from++],output[_out++]=from_source[from++],output[_out++]=from_source[from++],len-=3;len&&(output[_out++]=from_source[from++],len>1&&(output[_out++]=from_source[from++]))}else{from=_out-dist;do output[_out++]=output[from++],output[_out++]=output[from++],output[_out++]=output[from++],len-=3;while(len>2);len&&(output[_out++]=output[from++],len>1&&(output[_out++]=output[from++]))}break}}break}}while(_in<last&&_out<end);len=bits>>3,_in-=len,bits-=len<<3,hold&=(1<<bits)-1,strm.next_in=_in,strm.next_out=_out,strm.avail_in=_in<last?5+(last-_in):5-(_in-last),strm.avail_out=_out<end?257+(end-_out):257-(_out-end),state.hold=hold,state.bits=bits}},{}],288:[function(require,module,exports){"use strict";function zswap32(q){return(q>>>24&255)+(q>>>8&65280)+((65280&q)<<8)+((255&q)<<24)}function InflateState(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new utils.Buf16(320),this.work=new utils.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function inflateResetKeep(strm){var state;return strm&&strm.state?(state=strm.state,strm.total_in=strm.total_out=state.total=0,strm.msg="",state.wrap&&(strm.adler=1&state.wrap),state.mode=HEAD,state.last=0,state.havedict=0,state.dmax=32768,state.head=null,state.hold=0,state.bits=0,state.lencode=state.lendyn=new utils.Buf32(ENOUGH_LENS),state.distcode=state.distdyn=new utils.Buf32(ENOUGH_DISTS),state.sane=1,state.back=-1,Z_OK):Z_STREAM_ERROR}function inflateReset(strm){var state;return strm&&strm.state?(state=strm.state,state.wsize=0,state.whave=0,state.wnext=0,inflateResetKeep(strm)):Z_STREAM_ERROR}function inflateReset2(strm,windowBits){var wrap,state;return strm&&strm.state?(state=strm.state,windowBits<0?(wrap=0,windowBits=-windowBits):(wrap=(windowBits>>4)+1,windowBits<48&&(windowBits&=15)),windowBits&&(windowBits<8||windowBits>15)?Z_STREAM_ERROR:(null!==state.window&&state.wbits!==windowBits&&(state.window=null),state.wrap=wrap,state.wbits=windowBits,inflateReset(strm))):Z_STREAM_ERROR}function inflateInit2(strm,windowBits){var ret,state;return strm?(state=new InflateState,strm.state=state,state.window=null,ret=inflateReset2(strm,windowBits),ret!==Z_OK&&(strm.state=null),ret):Z_STREAM_ERROR}function inflateInit(strm){return inflateInit2(strm,DEF_WBITS)}function fixedtables(state){if(virgin){var sym;for(lenfix=new utils.Buf32(512),distfix=new utils.Buf32(32),sym=0;sym<144;)state.lens[sym++]=8;for(;sym<256;)state.lens[sym++]=9;for(;sym<280;)state.lens[sym++]=7;for(;sym<288;)state.lens[sym++]=8;for(inflate_table(LENS,state.lens,0,288,lenfix,0,state.work,{bits:9}),sym=0;sym<32;)state.lens[sym++]=5;
inflate_table(DISTS,state.lens,0,32,distfix,0,state.work,{bits:5}),virgin=!1}state.lencode=lenfix,state.lenbits=9,state.distcode=distfix,state.distbits=5}function updatewindow(strm,src,end,copy){var dist,state=strm.state;return null===state.window&&(state.wsize=1<<state.wbits,state.wnext=0,state.whave=0,state.window=new utils.Buf8(state.wsize)),copy>=state.wsize?(utils.arraySet(state.window,src,end-state.wsize,state.wsize,0),state.wnext=0,state.whave=state.wsize):(dist=state.wsize-state.wnext,dist>copy&&(dist=copy),utils.arraySet(state.window,src,end-copy,dist,state.wnext),copy-=dist,copy?(utils.arraySet(state.window,src,end-copy,copy,0),state.wnext=copy,state.whave=state.wsize):(state.wnext+=dist,state.wnext===state.wsize&&(state.wnext=0),state.whave<state.wsize&&(state.whave+=dist))),0}function inflate(strm,flush){var state,input,output,next,put,have,left,hold,bits,_in,_out,copy,from,from_source,here_bits,here_op,here_val,last_bits,last_op,last_val,len,ret,opts,n,here=0,hbuf=new utils.Buf8(4),order=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!strm||!strm.state||!strm.output||!strm.input&&0!==strm.avail_in)return Z_STREAM_ERROR;state=strm.state,state.mode===TYPE&&(state.mode=TYPEDO),put=strm.next_out,output=strm.output,left=strm.avail_out,next=strm.next_in,input=strm.input,have=strm.avail_in,hold=state.hold,bits=state.bits,_in=have,_out=left,ret=Z_OK;inf_leave:for(;;)switch(state.mode){case HEAD:if(0===state.wrap){state.mode=TYPEDO;break}for(;bits<16;){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}if(2&state.wrap&&35615===hold){state.check=0,hbuf[0]=255&hold,hbuf[1]=hold>>>8&255,state.check=crc32(state.check,hbuf,2,0),hold=0,bits=0,state.mode=FLAGS;break}if(state.flags=0,state.head&&(state.head.done=!1),!(1&state.wrap)||(((255&hold)<<8)+(hold>>8))%31){strm.msg="incorrect header check",state.mode=BAD;break}if((15&hold)!==Z_DEFLATED){strm.msg="unknown compression method",state.mode=BAD;break}if(hold>>>=4,bits-=4,len=(15&hold)+8,0===state.wbits)state.wbits=len;else if(len>state.wbits){strm.msg="invalid window size",state.mode=BAD;break}state.dmax=1<<len,strm.adler=state.check=1,state.mode=512&hold?DICTID:TYPE,hold=0,bits=0;break;case FLAGS:for(;bits<16;){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}if(state.flags=hold,(255&state.flags)!==Z_DEFLATED){strm.msg="unknown compression method",state.mode=BAD;break}if(57344&state.flags){strm.msg="unknown header flags set",state.mode=BAD;break}state.head&&(state.head.text=hold>>8&1),512&state.flags&&(hbuf[0]=255&hold,hbuf[1]=hold>>>8&255,state.check=crc32(state.check,hbuf,2,0)),hold=0,bits=0,state.mode=TIME;case TIME:for(;bits<32;){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}state.head&&(state.head.time=hold),512&state.flags&&(hbuf[0]=255&hold,hbuf[1]=hold>>>8&255,hbuf[2]=hold>>>16&255,hbuf[3]=hold>>>24&255,state.check=crc32(state.check,hbuf,4,0)),hold=0,bits=0,state.mode=OS;case OS:for(;bits<16;){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}state.head&&(state.head.xflags=255&hold,state.head.os=hold>>8),512&state.flags&&(hbuf[0]=255&hold,hbuf[1]=hold>>>8&255,state.check=crc32(state.check,hbuf,2,0)),hold=0,bits=0,state.mode=EXLEN;case EXLEN:if(1024&state.flags){for(;bits<16;){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}state.length=hold,state.head&&(state.head.extra_len=hold),512&state.flags&&(hbuf[0]=255&hold,hbuf[1]=hold>>>8&255,state.check=crc32(state.check,hbuf,2,0)),hold=0,bits=0}else state.head&&(state.head.extra=null);state.mode=EXTRA;case EXTRA:if(1024&state.flags&&(copy=state.length,copy>have&&(copy=have),copy&&(state.head&&(len=state.head.extra_len-state.length,state.head.extra||(state.head.extra=new Array(state.head.extra_len)),utils.arraySet(state.head.extra,input,next,copy,len)),512&state.flags&&(state.check=crc32(state.check,input,copy,next)),have-=copy,next+=copy,state.length-=copy),state.length))break inf_leave;state.length=0,state.mode=NAME;case NAME:if(2048&state.flags){if(0===have)break inf_leave;copy=0;do len=input[next+copy++],state.head&&len&&state.length<65536&&(state.head.name+=String.fromCharCode(len));while(len&&copy<have);if(512&state.flags&&(state.check=crc32(state.check,input,copy,next)),have-=copy,next+=copy,len)break inf_leave}else state.head&&(state.head.name=null);state.length=0,state.mode=COMMENT;case COMMENT:if(4096&state.flags){if(0===have)break inf_leave;copy=0;do len=input[next+copy++],state.head&&len&&state.length<65536&&(state.head.comment+=String.fromCharCode(len));while(len&&copy<have);if(512&state.flags&&(state.check=crc32(state.check,input,copy,next)),have-=copy,next+=copy,len)break inf_leave}else state.head&&(state.head.comment=null);state.mode=HCRC;case HCRC:if(512&state.flags){for(;bits<16;){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}if(hold!==(65535&state.check)){strm.msg="header crc mismatch",state.mode=BAD;break}hold=0,bits=0}state.head&&(state.head.hcrc=state.flags>>9&1,state.head.done=!0),strm.adler=state.check=0,state.mode=TYPE;break;case DICTID:for(;bits<32;){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}strm.adler=state.check=zswap32(hold),hold=0,bits=0,state.mode=DICT;case DICT:if(0===state.havedict)return strm.next_out=put,strm.avail_out=left,strm.next_in=next,strm.avail_in=have,state.hold=hold,state.bits=bits,Z_NEED_DICT;strm.adler=state.check=1,state.mode=TYPE;case TYPE:if(flush===Z_BLOCK||flush===Z_TREES)break inf_leave;case TYPEDO:if(state.last){hold>>>=7&bits,bits-=7&bits,state.mode=CHECK;break}for(;bits<3;){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}switch(state.last=1&hold,hold>>>=1,bits-=1,3&hold){case 0:state.mode=STORED;break;case 1:if(fixedtables(state),state.mode=LEN_,flush===Z_TREES){hold>>>=2,bits-=2;break inf_leave}break;case 2:state.mode=TABLE;break;case 3:strm.msg="invalid block type",state.mode=BAD}hold>>>=2,bits-=2;break;case STORED:for(hold>>>=7&bits,bits-=7&bits;bits<32;){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}if((65535&hold)!==(hold>>>16^65535)){strm.msg="invalid stored block lengths",state.mode=BAD;break}if(state.length=65535&hold,hold=0,bits=0,state.mode=COPY_,flush===Z_TREES)break inf_leave;case COPY_:state.mode=COPY;case COPY:if(copy=state.length){if(copy>have&&(copy=have),copy>left&&(copy=left),0===copy)break inf_leave;utils.arraySet(output,input,next,copy,put),have-=copy,next+=copy,left-=copy,put+=copy,state.length-=copy;break}state.mode=TYPE;break;case TABLE:for(;bits<14;){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}if(state.nlen=(31&hold)+257,hold>>>=5,bits-=5,state.ndist=(31&hold)+1,hold>>>=5,bits-=5,state.ncode=(15&hold)+4,hold>>>=4,bits-=4,state.nlen>286||state.ndist>30){strm.msg="too many length or distance symbols",state.mode=BAD;break}state.have=0,state.mode=LENLENS;case LENLENS:for(;state.have<state.ncode;){for(;bits<3;){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}state.lens[order[state.have++]]=7&hold,hold>>>=3,bits-=3}for(;state.have<19;)state.lens[order[state.have++]]=0;if(state.lencode=state.lendyn,state.lenbits=7,opts={bits:state.lenbits},ret=inflate_table(CODES,state.lens,0,19,state.lencode,0,state.work,opts),state.lenbits=opts.bits,ret){strm.msg="invalid code lengths set",state.mode=BAD;break}state.have=0,state.mode=CODELENS;case CODELENS:for(;state.have<state.nlen+state.ndist;){for(;here=state.lencode[hold&(1<<state.lenbits)-1],here_bits=here>>>24,here_op=here>>>16&255,here_val=65535&here,!(here_bits<=bits);){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}if(here_val<16)hold>>>=here_bits,bits-=here_bits,state.lens[state.have++]=here_val;else{if(16===here_val){for(n=here_bits+2;bits<n;){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}if(hold>>>=here_bits,bits-=here_bits,0===state.have){strm.msg="invalid bit length repeat",state.mode=BAD;break}len=state.lens[state.have-1],copy=3+(3&hold),hold>>>=2,bits-=2}else if(17===here_val){for(n=here_bits+3;bits<n;){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}hold>>>=here_bits,bits-=here_bits,len=0,copy=3+(7&hold),hold>>>=3,bits-=3}else{for(n=here_bits+7;bits<n;){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}hold>>>=here_bits,bits-=here_bits,len=0,copy=11+(127&hold),hold>>>=7,bits-=7}if(state.have+copy>state.nlen+state.ndist){strm.msg="invalid bit length repeat",state.mode=BAD;break}for(;copy--;)state.lens[state.have++]=len}}if(state.mode===BAD)break;if(0===state.lens[256]){strm.msg="invalid code -- missing end-of-block",state.mode=BAD;break}if(state.lenbits=9,opts={bits:state.lenbits},ret=inflate_table(LENS,state.lens,0,state.nlen,state.lencode,0,state.work,opts),state.lenbits=opts.bits,ret){strm.msg="invalid literal/lengths set",state.mode=BAD;break}if(state.distbits=6,state.distcode=state.distdyn,opts={bits:state.distbits},ret=inflate_table(DISTS,state.lens,state.nlen,state.ndist,state.distcode,0,state.work,opts),state.distbits=opts.bits,ret){strm.msg="invalid distances set",state.mode=BAD;break}if(state.mode=LEN_,flush===Z_TREES)break inf_leave;case LEN_:state.mode=LEN;case LEN:if(have>=6&&left>=258){strm.next_out=put,strm.avail_out=left,strm.next_in=next,strm.avail_in=have,state.hold=hold,state.bits=bits,inflate_fast(strm,_out),put=strm.next_out,output=strm.output,left=strm.avail_out,next=strm.next_in,input=strm.input,have=strm.avail_in,hold=state.hold,bits=state.bits,state.mode===TYPE&&(state.back=-1);break}for(state.back=0;here=state.lencode[hold&(1<<state.lenbits)-1],here_bits=here>>>24,here_op=here>>>16&255,here_val=65535&here,!(here_bits<=bits);){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}if(here_op&&0===(240&here_op)){for(last_bits=here_bits,last_op=here_op,last_val=here_val;here=state.lencode[last_val+((hold&(1<<last_bits+last_op)-1)>>last_bits)],here_bits=here>>>24,here_op=here>>>16&255,here_val=65535&here,!(last_bits+here_bits<=bits);){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}hold>>>=last_bits,bits-=last_bits,state.back+=last_bits}if(hold>>>=here_bits,bits-=here_bits,state.back+=here_bits,state.length=here_val,0===here_op){state.mode=LIT;break}if(32&here_op){state.back=-1,state.mode=TYPE;break}if(64&here_op){strm.msg="invalid literal/length code",state.mode=BAD;break}state.extra=15&here_op,state.mode=LENEXT;case LENEXT:if(state.extra){for(n=state.extra;bits<n;){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}state.length+=hold&(1<<state.extra)-1,hold>>>=state.extra,bits-=state.extra,state.back+=state.extra}state.was=state.length,state.mode=DIST;case DIST:for(;here=state.distcode[hold&(1<<state.distbits)-1],here_bits=here>>>24,here_op=here>>>16&255,here_val=65535&here,!(here_bits<=bits);){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}if(0===(240&here_op)){for(last_bits=here_bits,last_op=here_op,last_val=here_val;here=state.distcode[last_val+((hold&(1<<last_bits+last_op)-1)>>last_bits)],here_bits=here>>>24,here_op=here>>>16&255,here_val=65535&here,!(last_bits+here_bits<=bits);){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}hold>>>=last_bits,bits-=last_bits,state.back+=last_bits}if(hold>>>=here_bits,bits-=here_bits,state.back+=here_bits,64&here_op){strm.msg="invalid distance code",state.mode=BAD;break}state.offset=here_val,state.extra=15&here_op,state.mode=DISTEXT;case DISTEXT:if(state.extra){for(n=state.extra;bits<n;){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}state.offset+=hold&(1<<state.extra)-1,hold>>>=state.extra,bits-=state.extra,state.back+=state.extra}if(state.offset>state.dmax){strm.msg="invalid distance too far back",state.mode=BAD;break}state.mode=MATCH;case MATCH:if(0===left)break inf_leave;if(copy=_out-left,state.offset>copy){if(copy=state.offset-copy,copy>state.whave&&state.sane){strm.msg="invalid distance too far back",state.mode=BAD;break}copy>state.wnext?(copy-=state.wnext,from=state.wsize-copy):from=state.wnext-copy,copy>state.length&&(copy=state.length),from_source=state.window}else from_source=output,from=put-state.offset,copy=state.length;copy>left&&(copy=left),left-=copy,state.length-=copy;do output[put++]=from_source[from++];while(--copy);0===state.length&&(state.mode=LEN);break;case LIT:if(0===left)break inf_leave;output[put++]=state.length,left--,state.mode=LEN;break;case CHECK:if(state.wrap){for(;bits<32;){if(0===have)break inf_leave;have--,hold|=input[next++]<<bits,bits+=8}if(_out-=left,strm.total_out+=_out,state.total+=_out,_out&&(strm.adler=state.check=state.flags?crc32(state.check,output,_out,put-_out):adler32(state.check,output,_out,put-_out)),_out=left,(state.flags?hold:zswap32(hold))!==state.check){strm.msg="incorrect data check",state.mode=BAD;break}hold=0,bits=0}state.mode=LENGTH;case LENGTH:if(state.wrap&&state.flags){for(;bits<32;){if(0===have)break inf_leave;have--,hold+=input[next++]<<bits,bits+=8}if(hold!==(4294967295&state.total)){strm.msg="incorrect length check",state.mode=BAD;break}hold=0,bits=0}state.mode=DONE;case DONE:ret=Z_STREAM_END;break inf_leave;case BAD:ret=Z_DATA_ERROR;break inf_leave;case MEM:return Z_MEM_ERROR;case SYNC:default:return Z_STREAM_ERROR}return strm.next_out=put,strm.avail_out=left,strm.next_in=next,strm.avail_in=have,state.hold=hold,state.bits=bits,(state.wsize||_out!==strm.avail_out&&state.mode<BAD&&(state.mode<CHECK||flush!==Z_FINISH))&&updatewindow(strm,strm.output,strm.next_out,_out-strm.avail_out)?(state.mode=MEM,Z_MEM_ERROR):(_in-=strm.avail_in,_out-=strm.avail_out,strm.total_in+=_in,strm.total_out+=_out,state.total+=_out,state.wrap&&_out&&(strm.adler=state.check=state.flags?crc32(state.check,output,_out,strm.next_out-_out):adler32(state.check,output,_out,strm.next_out-_out)),strm.data_type=state.bits+(state.last?64:0)+(state.mode===TYPE?128:0)+(state.mode===LEN_||state.mode===COPY_?256:0),(0===_in&&0===_out||flush===Z_FINISH)&&ret===Z_OK&&(ret=Z_BUF_ERROR),ret)}function inflateEnd(strm){if(!strm||!strm.state)return Z_STREAM_ERROR;var state=strm.state;return state.window&&(state.window=null),strm.state=null,Z_OK}function inflateGetHeader(strm,head){var state;return strm&&strm.state?(state=strm.state,0===(2&state.wrap)?Z_STREAM_ERROR:(state.head=head,head.done=!1,Z_OK)):Z_STREAM_ERROR}function inflateSetDictionary(strm,dictionary){var state,dictid,ret,dictLength=dictionary.length;return strm&&strm.state?(state=strm.state,0!==state.wrap&&state.mode!==DICT?Z_STREAM_ERROR:state.mode===DICT&&(dictid=1,dictid=adler32(dictid,dictionary,dictLength,0),dictid!==state.check)?Z_DATA_ERROR:(ret=updatewindow(strm,dictionary,dictLength,dictLength))?(state.mode=MEM,Z_MEM_ERROR):(state.havedict=1,Z_OK)):Z_STREAM_ERROR}var lenfix,distfix,utils=require("../utils/common"),adler32=require("./adler32"),crc32=require("./crc32"),inflate_fast=require("./inffast"),inflate_table=require("./inftrees"),CODES=0,LENS=1,DISTS=2,Z_FINISH=4,Z_BLOCK=5,Z_TREES=6,Z_OK=0,Z_STREAM_END=1,Z_NEED_DICT=2,Z_STREAM_ERROR=-2,Z_DATA_ERROR=-3,Z_MEM_ERROR=-4,Z_BUF_ERROR=-5,Z_DEFLATED=8,HEAD=1,FLAGS=2,TIME=3,OS=4,EXLEN=5,EXTRA=6,NAME=7,COMMENT=8,HCRC=9,DICTID=10,DICT=11,TYPE=12,TYPEDO=13,STORED=14,COPY_=15,COPY=16,TABLE=17,LENLENS=18,CODELENS=19,LEN_=20,LEN=21,LENEXT=22,DIST=23,DISTEXT=24,MATCH=25,LIT=26,CHECK=27,LENGTH=28,DONE=29,BAD=30,MEM=31,SYNC=32,ENOUGH_LENS=852,ENOUGH_DISTS=592,MAX_WBITS=15,DEF_WBITS=MAX_WBITS,virgin=!0;exports.inflateReset=inflateReset,exports.inflateReset2=inflateReset2,exports.inflateResetKeep=inflateResetKeep,exports.inflateInit=inflateInit,exports.inflateInit2=inflateInit2,exports.inflate=inflate,exports.inflateEnd=inflateEnd,exports.inflateGetHeader=inflateGetHeader,exports.inflateSetDictionary=inflateSetDictionary,exports.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":280,"./adler32":282,"./crc32":284,"./inffast":287,"./inftrees":289}],289:[function(require,module,exports){"use strict";var utils=require("../utils/common"),MAXBITS=15,ENOUGH_LENS=852,ENOUGH_DISTS=592,CODES=0,LENS=1,DISTS=2,lbase=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],lext=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],dbase=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],dext=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];module.exports=function(type,lens,lens_index,codes,table,table_index,work,opts){var incr,fill,low,mask,next,end,here_bits,here_op,here_val,bits=opts.bits,len=0,sym=0,min=0,max=0,root=0,curr=0,drop=0,left=0,used=0,huff=0,base=null,base_index=0,count=new utils.Buf16(MAXBITS+1),offs=new utils.Buf16(MAXBITS+1),extra=null,extra_index=0;for(len=0;len<=MAXBITS;len++)count[len]=0;for(sym=0;sym<codes;sym++)count[lens[lens_index+sym]]++;for(root=bits,max=MAXBITS;max>=1&&0===count[max];max--);if(root>max&&(root=max),0===max)return table[table_index++]=20971520,table[table_index++]=20971520,opts.bits=1,0;for(min=1;min<max&&0===count[min];min++);for(root<min&&(root=min),left=1,len=1;len<=MAXBITS;len++)if(left<<=1,left-=count[len],left<0)return-1;if(left>0&&(type===CODES||1!==max))return-1;for(offs[1]=0,len=1;len<MAXBITS;len++)offs[len+1]=offs[len]+count[len];for(sym=0;sym<codes;sym++)0!==lens[lens_index+sym]&&(work[offs[lens[lens_index+sym]]++]=sym);if(type===CODES?(base=extra=work,end=19):type===LENS?(base=lbase,base_index-=257,extra=lext,extra_index-=257,end=256):(base=dbase,extra=dext,end=-1),huff=0,sym=0,len=min,next=table_index,curr=root,drop=0,low=-1,used=1<<root,mask=used-1,type===LENS&&used>ENOUGH_LENS||type===DISTS&&used>ENOUGH_DISTS)return 1;for(;;){here_bits=len-drop,work[sym]<end?(here_op=0,here_val=work[sym]):work[sym]>end?(here_op=extra[extra_index+work[sym]],here_val=base[base_index+work[sym]]):(here_op=96,here_val=0),incr=1<<len-drop,fill=1<<curr,min=fill;do fill-=incr,table[next+(huff>>drop)+fill]=here_bits<<24|here_op<<16|here_val|0;while(0!==fill);for(incr=1<<len-1;huff&incr;)incr>>=1;if(0!==incr?(huff&=incr-1,huff+=incr):huff=0,sym++,0===--count[len]){if(len===max)break;len=lens[lens_index+work[sym]]}if(len>root&&(huff&mask)!==low){for(0===drop&&(drop=root),next+=min,curr=len-drop,left=1<<curr;curr+drop<max&&(left-=count[curr+drop],!(left<=0));)curr++,left<<=1;if(used+=1<<curr,type===LENS&&used>ENOUGH_LENS||type===DISTS&&used>ENOUGH_DISTS)return 1;low=huff&mask,table[low]=root<<24|curr<<16|next-table_index|0}}return 0!==huff&&(table[next+huff]=len-drop<<24|64<<16|0),opts.bits=root,0}},{"../utils/common":280}],290:[function(require,module,exports){"use strict";module.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],291:[function(require,module,exports){"use strict";function zero(buf){for(var len=buf.length;--len>=0;)buf[len]=0}function StaticTreeDesc(static_tree,extra_bits,extra_base,elems,max_length){this.static_tree=static_tree,this.extra_bits=extra_bits,this.extra_base=extra_base,this.elems=elems,this.max_length=max_length,this.has_stree=static_tree&&static_tree.length}function TreeDesc(dyn_tree,stat_desc){this.dyn_tree=dyn_tree,this.max_code=0,this.stat_desc=stat_desc}function d_code(dist){return dist<256?_dist_code[dist]:_dist_code[256+(dist>>>7)]}function put_short(s,w){s.pending_buf[s.pending++]=255&w,s.pending_buf[s.pending++]=w>>>8&255}function send_bits(s,value,length){s.bi_valid>Buf_size-length?(s.bi_buf|=value<<s.bi_valid&65535,put_short(s,s.bi_buf),s.bi_buf=value>>Buf_size-s.bi_valid,s.bi_valid+=length-Buf_size):(s.bi_buf|=value<<s.bi_valid&65535,s.bi_valid+=length)}function send_code(s,c,tree){send_bits(s,tree[2*c],tree[2*c+1])}function bi_reverse(code,len){var res=0;do res|=1&code,code>>>=1,res<<=1;while(--len>0);return res>>>1}function bi_flush(s){16===s.bi_valid?(put_short(s,s.bi_buf),s.bi_buf=0,s.bi_valid=0):s.bi_valid>=8&&(s.pending_buf[s.pending++]=255&s.bi_buf,s.bi_buf>>=8,s.bi_valid-=8)}function gen_bitlen(s,desc){var h,n,m,bits,xbits,f,tree=desc.dyn_tree,max_code=desc.max_code,stree=desc.stat_desc.static_tree,has_stree=desc.stat_desc.has_stree,extra=desc.stat_desc.extra_bits,base=desc.stat_desc.extra_base,max_length=desc.stat_desc.max_length,overflow=0;for(bits=0;bits<=MAX_BITS;bits++)s.bl_count[bits]=0;for(tree[2*s.heap[s.heap_max]+1]=0,h=s.heap_max+1;h<HEAP_SIZE;h++)n=s.heap[h],bits=tree[2*tree[2*n+1]+1]+1,bits>max_length&&(bits=max_length,overflow++),tree[2*n+1]=bits,n>max_code||(s.bl_count[bits]++,xbits=0,n>=base&&(xbits=extra[n-base]),f=tree[2*n],s.opt_len+=f*(bits+xbits),has_stree&&(s.static_len+=f*(stree[2*n+1]+xbits)));if(0!==overflow){do{for(bits=max_length-1;0===s.bl_count[bits];)bits--;s.bl_count[bits]--,s.bl_count[bits+1]+=2,s.bl_count[max_length]--,overflow-=2}while(overflow>0);for(bits=max_length;0!==bits;bits--)for(n=s.bl_count[bits];0!==n;)m=s.heap[--h],m>max_code||(tree[2*m+1]!==bits&&(s.opt_len+=(bits-tree[2*m+1])*tree[2*m],tree[2*m+1]=bits),n--)}}function gen_codes(tree,max_code,bl_count){var bits,n,next_code=new Array(MAX_BITS+1),code=0;for(bits=1;bits<=MAX_BITS;bits++)next_code[bits]=code=code+bl_count[bits-1]<<1;for(n=0;n<=max_code;n++){var len=tree[2*n+1];0!==len&&(tree[2*n]=bi_reverse(next_code[len]++,len))}}function tr_static_init(){var n,bits,length,code,dist,bl_count=new Array(MAX_BITS+1);for(length=0,code=0;code<LENGTH_CODES-1;code++)for(base_length[code]=length,n=0;n<1<<extra_lbits[code];n++)_length_code[length++]=code;for(_length_code[length-1]=code,dist=0,code=0;code<16;code++)for(base_dist[code]=dist,n=0;n<1<<extra_dbits[code];n++)_dist_code[dist++]=code;for(dist>>=7;code<D_CODES;code++)for(base_dist[code]=dist<<7,n=0;n<1<<extra_dbits[code]-7;n++)_dist_code[256+dist++]=code;for(bits=0;bits<=MAX_BITS;bits++)bl_count[bits]=0;for(n=0;n<=143;)static_ltree[2*n+1]=8,n++,bl_count[8]++;for(;n<=255;)static_ltree[2*n+1]=9,n++,bl_count[9]++;for(;n<=279;)static_ltree[2*n+1]=7,n++,bl_count[7]++;for(;n<=287;)static_ltree[2*n+1]=8,n++,bl_count[8]++;for(gen_codes(static_ltree,L_CODES+1,bl_count),n=0;n<D_CODES;n++)static_dtree[2*n+1]=5,static_dtree[2*n]=bi_reverse(n,5);static_l_desc=new StaticTreeDesc(static_ltree,extra_lbits,LITERALS+1,L_CODES,MAX_BITS),static_d_desc=new StaticTreeDesc(static_dtree,extra_dbits,0,D_CODES,MAX_BITS),static_bl_desc=new StaticTreeDesc(new Array(0),extra_blbits,0,BL_CODES,MAX_BL_BITS)}function init_block(s){var n;for(n=0;n<L_CODES;n++)s.dyn_ltree[2*n]=0;for(n=0;n<D_CODES;n++)s.dyn_dtree[2*n]=0;for(n=0;n<BL_CODES;n++)s.bl_tree[2*n]=0;s.dyn_ltree[2*END_BLOCK]=1,s.opt_len=s.static_len=0,s.last_lit=s.matches=0}function bi_windup(s){s.bi_valid>8?put_short(s,s.bi_buf):s.bi_valid>0&&(s.pending_buf[s.pending++]=s.bi_buf),s.bi_buf=0,s.bi_valid=0}function copy_block(s,buf,len,header){bi_windup(s),header&&(put_short(s,len),put_short(s,~len)),utils.arraySet(s.pending_buf,s.window,buf,len,s.pending),s.pending+=len}function smaller(tree,n,m,depth){var _n2=2*n,_m2=2*m;return tree[_n2]<tree[_m2]||tree[_n2]===tree[_m2]&&depth[n]<=depth[m]}function pqdownheap(s,tree,k){for(var v=s.heap[k],j=k<<1;j<=s.heap_len&&(j<s.heap_len&&smaller(tree,s.heap[j+1],s.heap[j],s.depth)&&j++,!smaller(tree,v,s.heap[j],s.depth));)s.heap[k]=s.heap[j],k=j,j<<=1;s.heap[k]=v}function compress_block(s,ltree,dtree){var dist,lc,code,extra,lx=0;if(0!==s.last_lit)do dist=s.pending_buf[s.d_buf+2*lx]<<8|s.pending_buf[s.d_buf+2*lx+1],lc=s.pending_buf[s.l_buf+lx],lx++,0===dist?send_code(s,lc,ltree):(code=_length_code[lc],send_code(s,code+LITERALS+1,ltree),extra=extra_lbits[code],0!==extra&&(lc-=base_length[code],send_bits(s,lc,extra)),dist--,code=d_code(dist),send_code(s,code,dtree),extra=extra_dbits[code],0!==extra&&(dist-=base_dist[code],send_bits(s,dist,extra)));while(lx<s.last_lit);send_code(s,END_BLOCK,ltree)}function build_tree(s,desc){var n,m,node,tree=desc.dyn_tree,stree=desc.stat_desc.static_tree,has_stree=desc.stat_desc.has_stree,elems=desc.stat_desc.elems,max_code=-1;for(s.heap_len=0,s.heap_max=HEAP_SIZE,n=0;n<elems;n++)0!==tree[2*n]?(s.heap[++s.heap_len]=max_code=n,s.depth[n]=0):tree[2*n+1]=0;for(;s.heap_len<2;)node=s.heap[++s.heap_len]=max_code<2?++max_code:0,tree[2*node]=1,s.depth[node]=0,s.opt_len--,has_stree&&(s.static_len-=stree[2*node+1]);for(desc.max_code=max_code,n=s.heap_len>>1;n>=1;n--)pqdownheap(s,tree,n);node=elems;do n=s.heap[1],s.heap[1]=s.heap[s.heap_len--],pqdownheap(s,tree,1),m=s.heap[1],s.heap[--s.heap_max]=n,s.heap[--s.heap_max]=m,tree[2*node]=tree[2*n]+tree[2*m],s.depth[node]=(s.depth[n]>=s.depth[m]?s.depth[n]:s.depth[m])+1,tree[2*n+1]=tree[2*m+1]=node,s.heap[1]=node++,pqdownheap(s,tree,1);while(s.heap_len>=2);s.heap[--s.heap_max]=s.heap[1],gen_bitlen(s,desc),gen_codes(tree,max_code,s.bl_count)}function scan_tree(s,tree,max_code){var n,curlen,prevlen=-1,nextlen=tree[1],count=0,max_count=7,min_count=4;for(0===nextlen&&(max_count=138,min_count=3),tree[2*(max_code+1)+1]=65535,n=0;n<=max_code;n++)curlen=nextlen,nextlen=tree[2*(n+1)+1],++count<max_count&&curlen===nextlen||(count<min_count?s.bl_tree[2*curlen]+=count:0!==curlen?(curlen!==prevlen&&s.bl_tree[2*curlen]++,s.bl_tree[2*REP_3_6]++):count<=10?s.bl_tree[2*REPZ_3_10]++:s.bl_tree[2*REPZ_11_138]++,count=0,prevlen=curlen,0===nextlen?(max_count=138,min_count=3):curlen===nextlen?(max_count=6,min_count=3):(max_count=7,min_count=4))}function send_tree(s,tree,max_code){var n,curlen,prevlen=-1,nextlen=tree[1],count=0,max_count=7,min_count=4;for(0===nextlen&&(max_count=138,min_count=3),n=0;n<=max_code;n++)if(curlen=nextlen,nextlen=tree[2*(n+1)+1],!(++count<max_count&&curlen===nextlen)){if(count<min_count){do send_code(s,curlen,s.bl_tree);while(0!==--count)}else 0!==curlen?(curlen!==prevlen&&(send_code(s,curlen,s.bl_tree),count--),send_code(s,REP_3_6,s.bl_tree),send_bits(s,count-3,2)):count<=10?(send_code(s,REPZ_3_10,s.bl_tree),send_bits(s,count-3,3)):(send_code(s,REPZ_11_138,s.bl_tree),send_bits(s,count-11,7));count=0,prevlen=curlen,0===nextlen?(max_count=138,min_count=3):curlen===nextlen?(max_count=6,min_count=3):(max_count=7,min_count=4)}}function build_bl_tree(s){var max_blindex;for(scan_tree(s,s.dyn_ltree,s.l_desc.max_code),scan_tree(s,s.dyn_dtree,s.d_desc.max_code),build_tree(s,s.bl_desc),max_blindex=BL_CODES-1;max_blindex>=3&&0===s.bl_tree[2*bl_order[max_blindex]+1];max_blindex--);return s.opt_len+=3*(max_blindex+1)+5+5+4,max_blindex}function send_all_trees(s,lcodes,dcodes,blcodes){var rank;for(send_bits(s,lcodes-257,5),send_bits(s,dcodes-1,5),send_bits(s,blcodes-4,4),rank=0;rank<blcodes;rank++)send_bits(s,s.bl_tree[2*bl_order[rank]+1],3);send_tree(s,s.dyn_ltree,lcodes-1),send_tree(s,s.dyn_dtree,dcodes-1)}function detect_data_type(s){var n,black_mask=4093624447;for(n=0;n<=31;n++,black_mask>>>=1)if(1&black_mask&&0!==s.dyn_ltree[2*n])return Z_BINARY;if(0!==s.dyn_ltree[18]||0!==s.dyn_ltree[20]||0!==s.dyn_ltree[26])return Z_TEXT;for(n=32;n<LITERALS;n++)if(0!==s.dyn_ltree[2*n])return Z_TEXT;return Z_BINARY}function _tr_init(s){static_init_done||(tr_static_init(),static_init_done=!0),s.l_desc=new TreeDesc(s.dyn_ltree,static_l_desc),s.d_desc=new TreeDesc(s.dyn_dtree,static_d_desc),s.bl_desc=new TreeDesc(s.bl_tree,static_bl_desc),s.bi_buf=0,s.bi_valid=0,init_block(s)}function _tr_stored_block(s,buf,stored_len,last){send_bits(s,(STORED_BLOCK<<1)+(last?1:0),3),copy_block(s,buf,stored_len,!0)}function _tr_align(s){send_bits(s,STATIC_TREES<<1,3),send_code(s,END_BLOCK,static_ltree),bi_flush(s)}function _tr_flush_block(s,buf,stored_len,last){var opt_lenb,static_lenb,max_blindex=0;s.level>0?(s.strm.data_type===Z_UNKNOWN&&(s.strm.data_type=detect_data_type(s)),build_tree(s,s.l_desc),build_tree(s,s.d_desc),max_blindex=build_bl_tree(s),opt_lenb=s.opt_len+3+7>>>3,static_lenb=s.static_len+3+7>>>3,static_lenb<=opt_lenb&&(opt_lenb=static_lenb)):opt_lenb=static_lenb=stored_len+5,stored_len+4<=opt_lenb&&buf!==-1?_tr_stored_block(s,buf,stored_len,last):s.strategy===Z_FIXED||static_lenb===opt_lenb?(send_bits(s,(STATIC_TREES<<1)+(last?1:0),3),compress_block(s,static_ltree,static_dtree)):(send_bits(s,(DYN_TREES<<1)+(last?1:0),3),send_all_trees(s,s.l_desc.max_code+1,s.d_desc.max_code+1,max_blindex+1),compress_block(s,s.dyn_ltree,s.dyn_dtree)),init_block(s),last&&bi_windup(s)}function _tr_tally(s,dist,lc){return s.pending_buf[s.d_buf+2*s.last_lit]=dist>>>8&255,s.pending_buf[s.d_buf+2*s.last_lit+1]=255&dist,s.pending_buf[s.l_buf+s.last_lit]=255&lc,s.last_lit++,0===dist?s.dyn_ltree[2*lc]++:(s.matches++,dist--,s.dyn_ltree[2*(_length_code[lc]+LITERALS+1)]++,s.dyn_dtree[2*d_code(dist)]++),s.last_lit===s.lit_bufsize-1}var utils=require("../utils/common"),Z_FIXED=4,Z_BINARY=0,Z_TEXT=1,Z_UNKNOWN=2,STORED_BLOCK=0,STATIC_TREES=1,DYN_TREES=2,MIN_MATCH=3,MAX_MATCH=258,LENGTH_CODES=29,LITERALS=256,L_CODES=LITERALS+1+LENGTH_CODES,D_CODES=30,BL_CODES=19,HEAP_SIZE=2*L_CODES+1,MAX_BITS=15,Buf_size=16,MAX_BL_BITS=7,END_BLOCK=256,REP_3_6=16,REPZ_3_10=17,REPZ_11_138=18,extra_lbits=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],extra_dbits=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],extra_blbits=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],bl_order=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],DIST_CODE_LEN=512,static_ltree=new Array(2*(L_CODES+2));zero(static_ltree);var static_dtree=new Array(2*D_CODES);zero(static_dtree);var _dist_code=new Array(DIST_CODE_LEN);zero(_dist_code);var _length_code=new Array(MAX_MATCH-MIN_MATCH+1);zero(_length_code);var base_length=new Array(LENGTH_CODES);zero(base_length);var base_dist=new Array(D_CODES);zero(base_dist);var static_l_desc,static_d_desc,static_bl_desc,static_init_done=!1;exports._tr_init=_tr_init,exports._tr_stored_block=_tr_stored_block,exports._tr_flush_block=_tr_flush_block,exports._tr_tally=_tr_tally,exports._tr_align=_tr_align},{"../utils/common":280}],292:[function(require,module,exports){"use strict";function ZStream(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}module.exports=ZStream},{}],293:[function(require,module,exports){module.exports={"2.16.840.1.101.3.4.1.1":"aes-128-ecb","2.16.840.1.101.3.4.1.2":"aes-128-cbc","2.16.840.1.101.3.4.1.3":"aes-128-ofb","2.16.840.1.101.3.4.1.4":"aes-128-cfb","2.16.840.1.101.3.4.1.21":"aes-192-ecb","2.16.840.1.101.3.4.1.22":"aes-192-cbc","2.16.840.1.101.3.4.1.23":"aes-192-ofb","2.16.840.1.101.3.4.1.24":"aes-192-cfb","2.16.840.1.101.3.4.1.41":"aes-256-ecb","2.16.840.1.101.3.4.1.42":"aes-256-cbc","2.16.840.1.101.3.4.1.43":"aes-256-ofb","2.16.840.1.101.3.4.1.44":"aes-256-cfb"}},{}],294:[function(require,module,exports){"use strict";var asn1=require("asn1.js");exports.certificate=require("./certificate");var RSAPrivateKey=asn1.define("RSAPrivateKey",function(){this.seq().obj(this.key("version")["int"](),this.key("modulus")["int"](),this.key("publicExponent")["int"](),this.key("privateExponent")["int"](),this.key("prime1")["int"](),this.key("prime2")["int"](),this.key("exponent1")["int"](),this.key("exponent2")["int"](),this.key("coefficient")["int"]())});exports.RSAPrivateKey=RSAPrivateKey;var RSAPublicKey=asn1.define("RSAPublicKey",function(){this.seq().obj(this.key("modulus")["int"](),this.key("publicExponent")["int"]())});exports.RSAPublicKey=RSAPublicKey;var PublicKey=asn1.define("SubjectPublicKeyInfo",function(){this.seq().obj(this.key("algorithm").use(AlgorithmIdentifier),this.key("subjectPublicKey").bitstr())});exports.PublicKey=PublicKey;var AlgorithmIdentifier=asn1.define("AlgorithmIdentifier",function(){this.seq().obj(this.key("algorithm").objid(),this.key("none").null_().optional(),this.key("curve").objid().optional(),this.key("params").seq().obj(this.key("p")["int"](),this.key("q")["int"](),this.key("g")["int"]()).optional())}),PrivateKeyInfo=asn1.define("PrivateKeyInfo",function(){this.seq().obj(this.key("version")["int"](),this.key("algorithm").use(AlgorithmIdentifier),this.key("subjectPrivateKey").octstr());
});exports.PrivateKey=PrivateKeyInfo;var EncryptedPrivateKeyInfo=asn1.define("EncryptedPrivateKeyInfo",function(){this.seq().obj(this.key("algorithm").seq().obj(this.key("id").objid(),this.key("decrypt").seq().obj(this.key("kde").seq().obj(this.key("id").objid(),this.key("kdeparams").seq().obj(this.key("salt").octstr(),this.key("iters")["int"]())),this.key("cipher").seq().obj(this.key("algo").objid(),this.key("iv").octstr()))),this.key("subjectPrivateKey").octstr())});exports.EncryptedPrivateKey=EncryptedPrivateKeyInfo;var DSAPrivateKey=asn1.define("DSAPrivateKey",function(){this.seq().obj(this.key("version")["int"](),this.key("p")["int"](),this.key("q")["int"](),this.key("g")["int"](),this.key("pub_key")["int"](),this.key("priv_key")["int"]())});exports.DSAPrivateKey=DSAPrivateKey,exports.DSAparam=asn1.define("DSAparam",function(){this["int"]()});var ECPrivateKey=asn1.define("ECPrivateKey",function(){this.seq().obj(this.key("version")["int"](),this.key("privateKey").octstr(),this.key("parameters").optional().explicit(0).use(ECParameters),this.key("publicKey").optional().explicit(1).bitstr())});exports.ECPrivateKey=ECPrivateKey;var ECParameters=asn1.define("ECParameters",function(){this.choice({namedCurve:this.objid()})});exports.signature=asn1.define("signature",function(){this.seq().obj(this.key("r")["int"](),this.key("s")["int"]())})},{"./certificate":295,"asn1.js":11}],295:[function(require,module,exports){"use strict";var asn=require("asn1.js"),Time=asn.define("Time",function(){this.choice({utcTime:this.utctime(),generalTime:this.gentime()})}),AttributeTypeValue=asn.define("AttributeTypeValue",function(){this.seq().obj(this.key("type").objid(),this.key("value").any())}),AlgorithmIdentifier=asn.define("AlgorithmIdentifier",function(){this.seq().obj(this.key("algorithm").objid(),this.key("parameters").optional())}),SubjectPublicKeyInfo=asn.define("SubjectPublicKeyInfo",function(){this.seq().obj(this.key("algorithm").use(AlgorithmIdentifier),this.key("subjectPublicKey").bitstr())}),RelativeDistinguishedName=asn.define("RelativeDistinguishedName",function(){this.setof(AttributeTypeValue)}),RDNSequence=asn.define("RDNSequence",function(){this.seqof(RelativeDistinguishedName)}),Name=asn.define("Name",function(){this.choice({rdnSequence:this.use(RDNSequence)})}),Validity=asn.define("Validity",function(){this.seq().obj(this.key("notBefore").use(Time),this.key("notAfter").use(Time))}),Extension=asn.define("Extension",function(){this.seq().obj(this.key("extnID").objid(),this.key("critical").bool().def(!1),this.key("extnValue").octstr())}),TBSCertificate=asn.define("TBSCertificate",function(){this.seq().obj(this.key("version").explicit(0)["int"](),this.key("serialNumber")["int"](),this.key("signature").use(AlgorithmIdentifier),this.key("issuer").use(Name),this.key("validity").use(Validity),this.key("subject").use(Name),this.key("subjectPublicKeyInfo").use(SubjectPublicKeyInfo),this.key("issuerUniqueID").implicit(1).bitstr().optional(),this.key("subjectUniqueID").implicit(2).bitstr().optional(),this.key("extensions").explicit(3).seqof(Extension).optional())}),X509Certificate=asn.define("X509Certificate",function(){this.seq().obj(this.key("tbsCertificate").use(TBSCertificate),this.key("signatureAlgorithm").use(AlgorithmIdentifier),this.key("signatureValue").bitstr())});module.exports=X509Certificate},{"asn1.js":11}],296:[function(require,module,exports){(function(Buffer){var findProc=/Proc-Type: 4,ENCRYPTED[\n\r]+DEK-Info: AES-((?:128)|(?:192)|(?:256))-CBC,([0-9A-H]+)[\n\r]+([0-9A-z\n\r\+\/\=]+)[\n\r]+/m,startRegex=/^-----BEGIN ((?:.* KEY)|CERTIFICATE)-----/m,fullRegex=/^-----BEGIN ((?:.* KEY)|CERTIFICATE)-----([0-9A-z\n\r\+\/\=]+)-----END \1-----$/m,evp=require("evp_bytestokey"),ciphers=require("browserify-aes");module.exports=function(okey,password){var decrypted,key=okey.toString(),match=key.match(findProc);if(match){var suite="aes"+match[1],iv=new Buffer(match[2],"hex"),cipherText=new Buffer(match[3].replace(/[\r\n]/g,""),"base64"),cipherKey=evp(password,iv.slice(0,8),parseInt(match[1],10)).key,out=[],cipher=ciphers.createDecipheriv(suite,cipherKey,iv);out.push(cipher.update(cipherText)),out.push(cipher["final"]()),decrypted=Buffer.concat(out)}else{var match2=key.match(fullRegex);decrypted=new Buffer(match2[2].replace(/[\r\n]/g,""),"base64")}var tag=key.match(startRegex)[1];return{tag:tag,data:decrypted}}}).call(this,require("buffer").Buffer)},{"browserify-aes":122,buffer:151,evp_bytestokey:216}],297:[function(require,module,exports){(function(Buffer){function parseKeys(buffer){var password;"object"!=typeof buffer||Buffer.isBuffer(buffer)||(password=buffer.passphrase,buffer=buffer.key),"string"==typeof buffer&&(buffer=new Buffer(buffer));var subtype,ndata,stripped=fixProc(buffer,password),type=stripped.tag,data=stripped.data;switch(type){case"CERTIFICATE":ndata=asn1.certificate.decode(data,"der").tbsCertificate.subjectPublicKeyInfo;case"PUBLIC KEY":switch(ndata||(ndata=asn1.PublicKey.decode(data,"der")),subtype=ndata.algorithm.algorithm.join(".")){case"1.2.840.113549.1.1.1":return asn1.RSAPublicKey.decode(ndata.subjectPublicKey.data,"der");case"1.2.840.10045.2.1":return ndata.subjectPrivateKey=ndata.subjectPublicKey,{type:"ec",data:ndata};case"1.2.840.10040.4.1":return ndata.algorithm.params.pub_key=asn1.DSAparam.decode(ndata.subjectPublicKey.data,"der"),{type:"dsa",data:ndata.algorithm.params};default:throw new Error("unknown key id "+subtype)}throw new Error("unknown key type "+type);case"ENCRYPTED PRIVATE KEY":data=asn1.EncryptedPrivateKey.decode(data,"der"),data=decrypt(data,password);case"PRIVATE KEY":switch(ndata=asn1.PrivateKey.decode(data,"der"),subtype=ndata.algorithm.algorithm.join(".")){case"1.2.840.113549.1.1.1":return asn1.RSAPrivateKey.decode(ndata.subjectPrivateKey,"der");case"1.2.840.10045.2.1":return{curve:ndata.algorithm.curve,privateKey:asn1.ECPrivateKey.decode(ndata.subjectPrivateKey,"der").privateKey};case"1.2.840.10040.4.1":return ndata.algorithm.params.priv_key=asn1.DSAparam.decode(ndata.subjectPrivateKey,"der"),{type:"dsa",params:ndata.algorithm.params};default:throw new Error("unknown key id "+subtype)}throw new Error("unknown key type "+type);case"RSA PUBLIC KEY":return asn1.RSAPublicKey.decode(data,"der");case"RSA PRIVATE KEY":return asn1.RSAPrivateKey.decode(data,"der");case"DSA PRIVATE KEY":return{type:"dsa",params:asn1.DSAPrivateKey.decode(data,"der")};case"EC PRIVATE KEY":return data=asn1.ECPrivateKey.decode(data,"der"),{curve:data.parameters.value,privateKey:data.privateKey};default:throw new Error("unknown key type "+type)}}function decrypt(data,password){var salt=data.algorithm.decrypt.kde.kdeparams.salt,iters=parseInt(data.algorithm.decrypt.kde.kdeparams.iters.toString(),10),algo=aesid[data.algorithm.decrypt.cipher.algo.join(".")],iv=data.algorithm.decrypt.cipher.iv,cipherText=data.subjectPrivateKey,keylen=parseInt(algo.split("-")[1],10)/8,key=compat.pbkdf2Sync(password,salt,iters,keylen),cipher=ciphers.createDecipheriv(algo,key,iv),out=[];return out.push(cipher.update(cipherText)),out.push(cipher["final"]()),Buffer.concat(out)}var asn1=require("./asn1"),aesid=require("./aesid.json"),fixProc=require("./fixProc"),ciphers=require("browserify-aes"),compat=require("pbkdf2");module.exports=parseKeys,parseKeys.signature=asn1.signature}).call(this,require("buffer").Buffer)},{"./aesid.json":293,"./asn1":294,"./fixProc":296,"browserify-aes":122,buffer:151,pbkdf2:298}],298:[function(require,module,exports){exports.pbkdf2=require("./lib/async"),exports.pbkdf2Sync=require("./lib/sync")},{"./lib/async":299,"./lib/sync":302}],299:[function(require,module,exports){(function(process,global){function checkNative(algo){if(global.process&&!global.process.browser)return Promise.resolve(!1);if(!subtle||!subtle.importKey||!subtle.deriveBits)return Promise.resolve(!1);if(void 0!==checks[algo])return checks[algo];ZERO_BUF=ZERO_BUF||Buffer.alloc(8);var prom=browserPbkdf2(ZERO_BUF,ZERO_BUF,10,128,algo).then(function(){return!0})["catch"](function(){return!1});return checks[algo]=prom,prom}function browserPbkdf2(password,salt,iterations,length,algo){return subtle.importKey("raw",password,{name:"PBKDF2"},!1,["deriveBits"]).then(function(key){return subtle.deriveBits({name:"PBKDF2",salt:salt,iterations:iterations,hash:{name:algo}},key,length<<3)}).then(function(res){return Buffer.from(res)})}function resolvePromise(promise,callback){promise.then(function(out){process.nextTick(function(){callback(null,out)})},function(e){process.nextTick(function(){callback(e)})})}var ZERO_BUF,checkParameters=require("./precondition"),defaultEncoding=require("./default-encoding"),sync=require("./sync"),Buffer=require("safe-buffer").Buffer,subtle=global.crypto&&global.crypto.subtle,toBrowser={sha:"SHA-1","sha-1":"SHA-1",sha1:"SHA-1",sha256:"SHA-256","sha-256":"SHA-256",sha384:"SHA-384","sha-384":"SHA-384","sha-512":"SHA-512",sha512:"SHA-512"},checks=[];module.exports=function(password,salt,iterations,keylen,digest,callback){"function"==typeof digest&&(callback=digest,digest=void 0),digest=digest||"sha1";var algo=toBrowser[digest.toLowerCase()];if(!algo||"function"!=typeof global.Promise)return process.nextTick(function(){var out;try{out=sync(password,salt,iterations,keylen,digest)}catch(e){return callback(e)}callback(null,out)});if(checkParameters(password,salt,iterations,keylen),"function"!=typeof callback)throw new Error("No callback provided to pbkdf2");Buffer.isBuffer(password)||(password=Buffer.from(password,defaultEncoding)),Buffer.isBuffer(salt)||(salt=Buffer.from(salt,defaultEncoding)),resolvePromise(checkNative(algo).then(function(resp){return resp?browserPbkdf2(password,salt,iterations,keylen,algo):sync(password,salt,iterations,keylen,digest)}),callback)}}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./default-encoding":300,"./precondition":301,"./sync":302,_process:309,"safe-buffer":323}],300:[function(require,module,exports){(function(process){var defaultEncoding;if(process.browser)defaultEncoding="utf-8";else{var pVersionMajor=parseInt(process.version.split(".")[0].slice(1),10);defaultEncoding=pVersionMajor>=6?"utf-8":"binary"}module.exports=defaultEncoding}).call(this,require("_process"))},{_process:309}],301:[function(require,module,exports){(function(Buffer){function checkBuffer(buf,name){if("string"!=typeof buf&&!Buffer.isBuffer(buf))throw new TypeError(name+" must be a buffer or string")}var MAX_ALLOC=Math.pow(2,30)-1;module.exports=function(password,salt,iterations,keylen){if(checkBuffer(password,"Password"),checkBuffer(salt,"Salt"),"number"!=typeof iterations)throw new TypeError("Iterations not a number");if(iterations<0)throw new TypeError("Bad iterations");if("number"!=typeof keylen)throw new TypeError("Key length not a number");if(keylen<0||keylen>MAX_ALLOC||keylen!==keylen)throw new TypeError("Bad key length")}}).call(this,{isBuffer:require("../../is-buffer/index.js")})},{"../../is-buffer/index.js":234}],302:[function(require,module,exports){function Hmac(alg,key,saltLen){var hash=getDigest(alg),blocksize="sha512"===alg||"sha384"===alg?128:64;key.length>blocksize?key=hash(key):key.length<blocksize&&(key=Buffer.concat([key,ZEROS],blocksize));for(var ipad=Buffer.allocUnsafe(blocksize+sizes[alg]),opad=Buffer.allocUnsafe(blocksize+sizes[alg]),i=0;i<blocksize;i++)ipad[i]=54^key[i],opad[i]=92^key[i];var ipad1=Buffer.allocUnsafe(blocksize+saltLen+4);ipad.copy(ipad1,0,0,blocksize),this.ipad1=ipad1,this.ipad2=ipad,this.opad=opad,this.alg=alg,this.blocksize=blocksize,this.hash=hash,this.size=sizes[alg]}function getDigest(alg){function shaFunc(data){return sha(alg).update(data).digest()}return"rmd160"===alg||"ripemd160"===alg?rmd160:"md5"===alg?md5:shaFunc}function pbkdf2(password,salt,iterations,keylen,digest){checkParameters(password,salt,iterations,keylen),Buffer.isBuffer(password)||(password=Buffer.from(password,defaultEncoding)),Buffer.isBuffer(salt)||(salt=Buffer.from(salt,defaultEncoding)),digest=digest||"sha1";var hmac=new Hmac(digest,password,salt.length),DK=Buffer.allocUnsafe(keylen),block1=Buffer.allocUnsafe(salt.length+4);salt.copy(block1,0,0,salt.length);for(var destPos=0,hLen=sizes[digest],l=Math.ceil(keylen/hLen),i=1;i<=l;i++){block1.writeUInt32BE(i,salt.length);for(var T=hmac.run(block1,hmac.ipad1),U=T,j=1;j<iterations;j++){U=hmac.run(U,hmac.ipad2);for(var k=0;k<hLen;k++)T[k]^=U[k]}T.copy(DK,destPos),destPos+=hLen}return DK}var md5=require("create-hash/md5"),rmd160=require("ripemd160"),sha=require("sha.js"),checkParameters=require("./precondition"),defaultEncoding=require("./default-encoding"),Buffer=require("safe-buffer").Buffer,ZEROS=Buffer.alloc(128),sizes={md5:16,sha1:20,sha224:28,sha256:32,sha384:48,sha512:64,rmd160:20,ripemd160:20};Hmac.prototype.run=function(data,ipad){data.copy(ipad,this.blocksize);var h=this.hash(ipad);return h.copy(this.opad,this.blocksize),this.hash(this.opad)},module.exports=pbkdf2},{"./default-encoding":300,"./precondition":301,"create-hash/md5":178,ripemd160:322,"safe-buffer":323,"sha.js":337}],303:[function(require,module,exports){module.exports=require("./src/preconditions")},{"./src/preconditions":306}],304:[function(require,module,exports){(function(global){(function(){function baseIndexOf(array,value,fromIndex){for(var index=(fromIndex||0)-1,length=array?array.length:0;++index<length;)if(array[index]===value)return index;return-1}function cacheIndexOf(cache,value){var type=typeof value;if(cache=cache.cache,"boolean"==type||null==value)return cache[value]?0:-1;"number"!=type&&"string"!=type&&(type="object");var key="number"==type?value:keyPrefix+value;return cache=(cache=cache[type])&&cache[key],"object"==type?cache&&baseIndexOf(cache,value)>-1?0:-1:cache?0:-1}function cachePush(value){var cache=this.cache,type=typeof value;if("boolean"==type||null==value)cache[value]=!0;else{"number"!=type&&"string"!=type&&(type="object");var key="number"==type?value:keyPrefix+value,typeCache=cache[type]||(cache[type]={});"object"==type?(typeCache[key]||(typeCache[key]=[])).push(value):typeCache[key]=!0}}function charAtCallback(value){return value.charCodeAt(0)}function compareAscending(a,b){for(var ac=a.criteria,bc=b.criteria,index=-1,length=ac.length;++index<length;){var value=ac[index],other=bc[index];if(value!==other){if(value>other||"undefined"==typeof value)return 1;if(value<other||"undefined"==typeof other)return-1}}return a.index-b.index}function createCache(array){var index=-1,length=array.length,first=array[0],mid=array[length/2|0],last=array[length-1];if(first&&"object"==typeof first&&mid&&"object"==typeof mid&&last&&"object"==typeof last)return!1;var cache=getObject();cache["false"]=cache["null"]=cache["true"]=cache.undefined=!1;var result=getObject();for(result.array=array,result.cache=cache,result.push=cachePush;++index<length;)result.push(array[index]);return result}function escapeStringChar(match){return"\\"+stringEscapes[match]}function getArray(){return arrayPool.pop()||[]}function getObject(){return objectPool.pop()||{array:null,cache:null,criteria:null,"false":!1,index:0,"null":!1,number:null,object:null,push:null,string:null,"true":!1,undefined:!1,value:null}}function releaseArray(array){array.length=0,arrayPool.length<maxPoolSize&&arrayPool.push(array)}function releaseObject(object){var cache=object.cache;cache&&releaseObject(cache),object.array=object.cache=object.criteria=object.object=object.number=object.string=object.value=null,objectPool.length<maxPoolSize&&objectPool.push(object)}function slice(array,start,end){start||(start=0),"undefined"==typeof end&&(end=array?array.length:0);for(var index=-1,length=end-start||0,result=Array(length<0?0:length);++index<length;)result[index]=array[start+index];return result}function runInContext(context){function lodash(value){return value&&"object"==typeof value&&!isArray(value)&&hasOwnProperty.call(value,"__wrapped__")?value:new lodashWrapper(value)}function lodashWrapper(value,chainAll){this.__chain__=!!chainAll,this.__wrapped__=value}function baseBind(bindData){function bound(){if(partialArgs){var args=slice(partialArgs);push.apply(args,arguments)}if(this instanceof bound){var thisBinding=baseCreate(func.prototype),result=func.apply(thisBinding,args||arguments);return isObject(result)?result:thisBinding}return func.apply(thisArg,args||arguments)}var func=bindData[0],partialArgs=bindData[2],thisArg=bindData[4];return setBindData(bound,bindData),bound}function baseClone(value,isDeep,callback,stackA,stackB){if(callback){var result=callback(value);if("undefined"!=typeof result)return result}var isObj=isObject(value);if(!isObj)return value;var className=toString.call(value);if(!cloneableClasses[className])return value;var ctor=ctorByClass[className];switch(className){case boolClass:case dateClass:return new ctor((+value));case numberClass:case stringClass:return new ctor(value);case regexpClass:return result=ctor(value.source,reFlags.exec(value)),result.lastIndex=value.lastIndex,result}var isArr=isArray(value);if(isDeep){var initedStack=!stackA;stackA||(stackA=getArray()),stackB||(stackB=getArray());for(var length=stackA.length;length--;)if(stackA[length]==value)return stackB[length];result=isArr?ctor(value.length):{}}else result=isArr?slice(value):assign({},value);return isArr&&(hasOwnProperty.call(value,"index")&&(result.index=value.index),hasOwnProperty.call(value,"input")&&(result.input=value.input)),isDeep?(stackA.push(value),stackB.push(result),(isArr?forEach:forOwn)(value,function(objValue,key){result[key]=baseClone(objValue,isDeep,callback,stackA,stackB)}),initedStack&&(releaseArray(stackA),releaseArray(stackB)),result):result}function baseCreate(prototype,properties){return isObject(prototype)?nativeCreate(prototype):{}}function baseCreateCallback(func,thisArg,argCount){if("function"!=typeof func)return identity;if("undefined"==typeof thisArg||!("prototype"in func))return func;var bindData=func.__bindData__;if("undefined"==typeof bindData&&(support.funcNames&&(bindData=!func.name),bindData=bindData||!support.funcDecomp,!bindData)){var source=fnToString.call(func);support.funcNames||(bindData=!reFuncName.test(source)),bindData||(bindData=reThis.test(source),setBindData(func,bindData))}if(bindData===!1||bindData!==!0&&1&bindData[1])return func;switch(argCount){case 1:return function(value){return func.call(thisArg,value)};case 2:return function(a,b){return func.call(thisArg,a,b)};case 3:return function(value,index,collection){return func.call(thisArg,value,index,collection)};case 4:return function(accumulator,value,index,collection){return func.call(thisArg,accumulator,value,index,collection)}}return bind(func,thisArg)}function baseCreateWrapper(bindData){function bound(){var thisBinding=isBind?thisArg:this;if(partialArgs){var args=slice(partialArgs);push.apply(args,arguments)}if((partialRightArgs||isCurry)&&(args||(args=slice(arguments)),partialRightArgs&&push.apply(args,partialRightArgs),isCurry&&args.length<arity))return bitmask|=16,baseCreateWrapper([func,isCurryBound?bitmask:bitmask&-4,args,null,thisArg,arity]);if(args||(args=arguments),isBindKey&&(func=thisBinding[key]),this instanceof bound){thisBinding=baseCreate(func.prototype);var result=func.apply(thisBinding,args);return isObject(result)?result:thisBinding}return func.apply(thisBinding,args)}var func=bindData[0],bitmask=bindData[1],partialArgs=bindData[2],partialRightArgs=bindData[3],thisArg=bindData[4],arity=bindData[5],isBind=1&bitmask,isBindKey=2&bitmask,isCurry=4&bitmask,isCurryBound=8&bitmask,key=func;return setBindData(bound,bindData),bound}function baseDifference(array,values){var index=-1,indexOf=getIndexOf(),length=array?array.length:0,isLarge=length>=largeArraySize&&indexOf===baseIndexOf,result=[];if(isLarge){var cache=createCache(values);cache?(indexOf=cacheIndexOf,values=cache):isLarge=!1}for(;++index<length;){var value=array[index];indexOf(values,value)<0&&result.push(value)}return isLarge&&releaseObject(values),result}function baseFlatten(array,isShallow,isStrict,fromIndex){for(var index=(fromIndex||0)-1,length=array?array.length:0,result=[];++index<length;){var value=array[index];if(value&&"object"==typeof value&&"number"==typeof value.length&&(isArray(value)||isArguments(value))){isShallow||(value=baseFlatten(value,isShallow,isStrict));var valIndex=-1,valLength=value.length,resIndex=result.length;for(result.length+=valLength;++valIndex<valLength;)result[resIndex++]=value[valIndex]}else isStrict||result.push(value)}return result}function baseIsEqual(a,b,callback,isWhere,stackA,stackB){if(callback){var result=callback(a,b);if("undefined"!=typeof result)return!!result}if(a===b)return 0!==a||1/a==1/b;var type=typeof a,otherType=typeof b;if(!(a!==a||a&&objectTypes[type]||b&&objectTypes[otherType]))return!1;if(null==a||null==b)return a===b;var className=toString.call(a),otherClass=toString.call(b);if(className==argsClass&&(className=objectClass),otherClass==argsClass&&(otherClass=objectClass),className!=otherClass)return!1;switch(className){case boolClass:case dateClass:return+a==+b;case numberClass:return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case regexpClass:case stringClass:return a==String(b)}var isArr=className==arrayClass;if(!isArr){var aWrapped=hasOwnProperty.call(a,"__wrapped__"),bWrapped=hasOwnProperty.call(b,"__wrapped__");if(aWrapped||bWrapped)return baseIsEqual(aWrapped?a.__wrapped__:a,bWrapped?b.__wrapped__:b,callback,isWhere,stackA,stackB);if(className!=objectClass)return!1;var ctorA=a.constructor,ctorB=b.constructor;if(ctorA!=ctorB&&!(isFunction(ctorA)&&ctorA instanceof ctorA&&isFunction(ctorB)&&ctorB instanceof ctorB)&&"constructor"in a&&"constructor"in b)return!1}var initedStack=!stackA;stackA||(stackA=getArray()),stackB||(stackB=getArray());for(var length=stackA.length;length--;)if(stackA[length]==a)return stackB[length]==b;var size=0;if(result=!0,stackA.push(a),stackB.push(b),isArr){if(length=a.length,size=b.length,result=size==length,result||isWhere)for(;size--;){var index=length,value=b[size];if(isWhere)for(;index--&&!(result=baseIsEqual(a[index],value,callback,isWhere,stackA,stackB)););else if(!(result=baseIsEqual(a[size],value,callback,isWhere,stackA,stackB)))break}}else forIn(b,function(value,key,b){if(hasOwnProperty.call(b,key))return size++,result=hasOwnProperty.call(a,key)&&baseIsEqual(a[key],value,callback,isWhere,stackA,stackB)}),result&&!isWhere&&forIn(a,function(value,key,a){if(hasOwnProperty.call(a,key))return result=--size>-1});return stackA.pop(),stackB.pop(),initedStack&&(releaseArray(stackA),releaseArray(stackB)),result}function baseMerge(object,source,callback,stackA,stackB){(isArray(source)?forEach:forOwn)(source,function(source,key){var found,isArr,result=source,value=object[key];if(source&&((isArr=isArray(source))||isPlainObject(source))){for(var stackLength=stackA.length;stackLength--;)if(found=stackA[stackLength]==source){value=stackB[stackLength];break}if(!found){var isShallow;callback&&(result=callback(value,source),(isShallow="undefined"!=typeof result)&&(value=result)),isShallow||(value=isArr?isArray(value)?value:[]:isPlainObject(value)?value:{}),stackA.push(source),stackB.push(value),isShallow||baseMerge(value,source,callback,stackA,stackB)}}else callback&&(result=callback(value,source),"undefined"==typeof result&&(result=source)),"undefined"!=typeof result&&(value=result);object[key]=value})}function baseRandom(min,max){return min+floor(nativeRandom()*(max-min+1))}function baseUniq(array,isSorted,callback){var index=-1,indexOf=getIndexOf(),length=array?array.length:0,result=[],isLarge=!isSorted&&length>=largeArraySize&&indexOf===baseIndexOf,seen=callback||isLarge?getArray():result;if(isLarge){var cache=createCache(seen);indexOf=cacheIndexOf,seen=cache}for(;++index<length;){var value=array[index],computed=callback?callback(value,index,array):value;(isSorted?!index||seen[seen.length-1]!==computed:indexOf(seen,computed)<0)&&((callback||isLarge)&&seen.push(computed),result.push(value))}return isLarge?(releaseArray(seen.array),releaseObject(seen)):callback&&releaseArray(seen),result}function createAggregator(setter){return function(collection,callback,thisArg){var result={};callback=lodash.createCallback(callback,thisArg,3);var index=-1,length=collection?collection.length:0;if("number"==typeof length)for(;++index<length;){var value=collection[index];setter(result,value,callback(value,index,collection),collection)}else forOwn(collection,function(value,key,collection){setter(result,value,callback(value,key,collection),collection)});return result}}function createWrapper(func,bitmask,partialArgs,partialRightArgs,thisArg,arity){var isBind=1&bitmask,isBindKey=2&bitmask,isCurry=4&bitmask,isPartial=16&bitmask,isPartialRight=32&bitmask;if(!isBindKey&&!isFunction(func))throw new TypeError;isPartial&&!partialArgs.length&&(bitmask&=-17,isPartial=partialArgs=!1),isPartialRight&&!partialRightArgs.length&&(bitmask&=-33,isPartialRight=partialRightArgs=!1);var bindData=func&&func.__bindData__;if(bindData&&bindData!==!0)return bindData=slice(bindData),bindData[2]&&(bindData[2]=slice(bindData[2])),bindData[3]&&(bindData[3]=slice(bindData[3])),!isBind||1&bindData[1]||(bindData[4]=thisArg),!isBind&&1&bindData[1]&&(bitmask|=8),!isCurry||4&bindData[1]||(bindData[5]=arity),isPartial&&push.apply(bindData[2]||(bindData[2]=[]),partialArgs),isPartialRight&&unshift.apply(bindData[3]||(bindData[3]=[]),partialRightArgs),bindData[1]|=bitmask,createWrapper.apply(null,bindData);var creater=1==bitmask||17===bitmask?baseBind:baseCreateWrapper;return creater([func,bitmask,partialArgs,partialRightArgs,thisArg,arity])}function escapeHtmlChar(match){return htmlEscapes[match]}function getIndexOf(){var result=(result=lodash.indexOf)===indexOf?baseIndexOf:result;return result}function isNative(value){return"function"==typeof value&&reNative.test(value)}function shimIsPlainObject(value){var ctor,result;return!!(value&&toString.call(value)==objectClass&&(ctor=value.constructor,!isFunction(ctor)||ctor instanceof ctor))&&(forIn(value,function(value,key){result=key}),"undefined"==typeof result||hasOwnProperty.call(value,result))}function unescapeHtmlChar(match){return htmlUnescapes[match]}function isArguments(value){return value&&"object"==typeof value&&"number"==typeof value.length&&toString.call(value)==argsClass||!1}function clone(value,isDeep,callback,thisArg){return"boolean"!=typeof isDeep&&null!=isDeep&&(thisArg=callback,callback=isDeep,isDeep=!1),baseClone(value,isDeep,"function"==typeof callback&&baseCreateCallback(callback,thisArg,1))}function cloneDeep(value,callback,thisArg){return baseClone(value,!0,"function"==typeof callback&&baseCreateCallback(callback,thisArg,1))}function create(prototype,properties){var result=baseCreate(prototype);return properties?assign(result,properties):result}function findKey(object,callback,thisArg){var result;return callback=lodash.createCallback(callback,thisArg,3),forOwn(object,function(value,key,object){if(callback(value,key,object))return result=key,!1}),result}function findLastKey(object,callback,thisArg){var result;return callback=lodash.createCallback(callback,thisArg,3),forOwnRight(object,function(value,key,object){if(callback(value,key,object))return result=key,!1}),result}function forInRight(object,callback,thisArg){var pairs=[];forIn(object,function(value,key){pairs.push(key,value)});var length=pairs.length;for(callback=baseCreateCallback(callback,thisArg,3);length--&&callback(pairs[length--],pairs[length],object)!==!1;);return object}function forOwnRight(object,callback,thisArg){var props=keys(object),length=props.length;for(callback=baseCreateCallback(callback,thisArg,3);length--;){var key=props[length];if(callback(object[key],key,object)===!1)break}return object}function functions(object){var result=[];return forIn(object,function(value,key){isFunction(value)&&result.push(key)}),result.sort()}function has(object,key){return!!object&&hasOwnProperty.call(object,key)}function invert(object){for(var index=-1,props=keys(object),length=props.length,result={};++index<length;){var key=props[index];result[object[key]]=key}return result}function isBoolean(value){return value===!0||value===!1||value&&"object"==typeof value&&toString.call(value)==boolClass||!1}function isDate(value){return value&&"object"==typeof value&&toString.call(value)==dateClass||!1}function isElement(value){return value&&1===value.nodeType||!1}function isEmpty(value){var result=!0;if(!value)return result;var className=toString.call(value),length=value.length;return className==arrayClass||className==stringClass||className==argsClass||className==objectClass&&"number"==typeof length&&isFunction(value.splice)?!length:(forOwn(value,function(){return result=!1}),result)}function isEqual(a,b,callback,thisArg){return baseIsEqual(a,b,"function"==typeof callback&&baseCreateCallback(callback,thisArg,2))}function isFinite(value){return nativeIsFinite(value)&&!nativeIsNaN(parseFloat(value))}function isFunction(value){return"function"==typeof value}function isObject(value){return!(!value||!objectTypes[typeof value])}function isNaN(value){return isNumber(value)&&value!=+value}function isNull(value){return null===value}function isNumber(value){return"number"==typeof value||value&&"object"==typeof value&&toString.call(value)==numberClass||!1}function isRegExp(value){return value&&"object"==typeof value&&toString.call(value)==regexpClass||!1}function isString(value){return"string"==typeof value||value&&"object"==typeof value&&toString.call(value)==stringClass||!1}function isUndefined(value){return"undefined"==typeof value}function mapValues(object,callback,thisArg){var result={};return callback=lodash.createCallback(callback,thisArg,3),forOwn(object,function(value,key,object){result[key]=callback(value,key,object)}),result}function merge(object){var args=arguments,length=2;if(!isObject(object))return object;if("number"!=typeof args[2]&&(length=args.length),length>3&&"function"==typeof args[length-2])var callback=baseCreateCallback(args[--length-1],args[length--],2);else length>2&&"function"==typeof args[length-1]&&(callback=args[--length]);for(var sources=slice(arguments,1,length),index=-1,stackA=getArray(),stackB=getArray();++index<length;)baseMerge(object,sources[index],callback,stackA,stackB);return releaseArray(stackA),releaseArray(stackB),object}function omit(object,callback,thisArg){var result={};if("function"!=typeof callback){var props=[];forIn(object,function(value,key){props.push(key)}),props=baseDifference(props,baseFlatten(arguments,!0,!1,1));for(var index=-1,length=props.length;++index<length;){var key=props[index];result[key]=object[key]}}else callback=lodash.createCallback(callback,thisArg,3),forIn(object,function(value,key,object){callback(value,key,object)||(result[key]=value)});return result}function pairs(object){for(var index=-1,props=keys(object),length=props.length,result=Array(length);++index<length;){var key=props[index];result[index]=[key,object[key]]}return result}function pick(object,callback,thisArg){var result={};if("function"!=typeof callback)for(var index=-1,props=baseFlatten(arguments,!0,!1,1),length=isObject(object)?props.length:0;++index<length;){var key=props[index];key in object&&(result[key]=object[key])}else callback=lodash.createCallback(callback,thisArg,3),forIn(object,function(value,key,object){callback(value,key,object)&&(result[key]=value)});return result}function transform(object,callback,accumulator,thisArg){var isArr=isArray(object);if(null==accumulator)if(isArr)accumulator=[];else{var ctor=object&&object.constructor,proto=ctor&&ctor.prototype;accumulator=baseCreate(proto)}return callback&&(callback=lodash.createCallback(callback,thisArg,4),(isArr?forEach:forOwn)(object,function(value,index,object){return callback(accumulator,value,index,object)})),accumulator}function values(object){for(var index=-1,props=keys(object),length=props.length,result=Array(length);++index<length;)result[index]=object[props[index]];return result}function at(collection){for(var args=arguments,index=-1,props=baseFlatten(args,!0,!1,1),length=args[2]&&args[2][args[1]]===collection?1:props.length,result=Array(length);++index<length;)result[index]=collection[props[index]];
return result}function contains(collection,target,fromIndex){var index=-1,indexOf=getIndexOf(),length=collection?collection.length:0,result=!1;return fromIndex=(fromIndex<0?nativeMax(0,length+fromIndex):fromIndex)||0,isArray(collection)?result=indexOf(collection,target,fromIndex)>-1:"number"==typeof length?result=(isString(collection)?collection.indexOf(target,fromIndex):indexOf(collection,target,fromIndex))>-1:forOwn(collection,function(value){if(++index>=fromIndex)return!(result=value===target)}),result}function every(collection,callback,thisArg){var result=!0;callback=lodash.createCallback(callback,thisArg,3);var index=-1,length=collection?collection.length:0;if("number"==typeof length)for(;++index<length&&(result=!!callback(collection[index],index,collection)););else forOwn(collection,function(value,index,collection){return result=!!callback(value,index,collection)});return result}function filter(collection,callback,thisArg){var result=[];callback=lodash.createCallback(callback,thisArg,3);var index=-1,length=collection?collection.length:0;if("number"==typeof length)for(;++index<length;){var value=collection[index];callback(value,index,collection)&&result.push(value)}else forOwn(collection,function(value,index,collection){callback(value,index,collection)&&result.push(value)});return result}function find(collection,callback,thisArg){callback=lodash.createCallback(callback,thisArg,3);var index=-1,length=collection?collection.length:0;if("number"!=typeof length){var result;return forOwn(collection,function(value,index,collection){if(callback(value,index,collection))return result=value,!1}),result}for(;++index<length;){var value=collection[index];if(callback(value,index,collection))return value}}function findLast(collection,callback,thisArg){var result;return callback=lodash.createCallback(callback,thisArg,3),forEachRight(collection,function(value,index,collection){if(callback(value,index,collection))return result=value,!1}),result}function forEach(collection,callback,thisArg){var index=-1,length=collection?collection.length:0;if(callback=callback&&"undefined"==typeof thisArg?callback:baseCreateCallback(callback,thisArg,3),"number"==typeof length)for(;++index<length&&callback(collection[index],index,collection)!==!1;);else forOwn(collection,callback);return collection}function forEachRight(collection,callback,thisArg){var length=collection?collection.length:0;if(callback=callback&&"undefined"==typeof thisArg?callback:baseCreateCallback(callback,thisArg,3),"number"==typeof length)for(;length--&&callback(collection[length],length,collection)!==!1;);else{var props=keys(collection);length=props.length,forOwn(collection,function(value,key,collection){return key=props?props[--length]:--length,callback(collection[key],key,collection)})}return collection}function invoke(collection,methodName){var args=slice(arguments,2),index=-1,isFunc="function"==typeof methodName,length=collection?collection.length:0,result=Array("number"==typeof length?length:0);return forEach(collection,function(value){result[++index]=(isFunc?methodName:value[methodName]).apply(value,args)}),result}function map(collection,callback,thisArg){var index=-1,length=collection?collection.length:0;if(callback=lodash.createCallback(callback,thisArg,3),"number"==typeof length)for(var result=Array(length);++index<length;)result[index]=callback(collection[index],index,collection);else result=[],forOwn(collection,function(value,key,collection){result[++index]=callback(value,key,collection)});return result}function max(collection,callback,thisArg){var computed=-(1/0),result=computed;if("function"!=typeof callback&&thisArg&&thisArg[callback]===collection&&(callback=null),null==callback&&isArray(collection))for(var index=-1,length=collection.length;++index<length;){var value=collection[index];value>result&&(result=value)}else callback=null==callback&&isString(collection)?charAtCallback:lodash.createCallback(callback,thisArg,3),forEach(collection,function(value,index,collection){var current=callback(value,index,collection);current>computed&&(computed=current,result=value)});return result}function min(collection,callback,thisArg){var computed=1/0,result=computed;if("function"!=typeof callback&&thisArg&&thisArg[callback]===collection&&(callback=null),null==callback&&isArray(collection))for(var index=-1,length=collection.length;++index<length;){var value=collection[index];value<result&&(result=value)}else callback=null==callback&&isString(collection)?charAtCallback:lodash.createCallback(callback,thisArg,3),forEach(collection,function(value,index,collection){var current=callback(value,index,collection);current<computed&&(computed=current,result=value)});return result}function reduce(collection,callback,accumulator,thisArg){if(!collection)return accumulator;var noaccum=arguments.length<3;callback=lodash.createCallback(callback,thisArg,4);var index=-1,length=collection.length;if("number"==typeof length)for(noaccum&&(accumulator=collection[++index]);++index<length;)accumulator=callback(accumulator,collection[index],index,collection);else forOwn(collection,function(value,index,collection){accumulator=noaccum?(noaccum=!1,value):callback(accumulator,value,index,collection)});return accumulator}function reduceRight(collection,callback,accumulator,thisArg){var noaccum=arguments.length<3;return callback=lodash.createCallback(callback,thisArg,4),forEachRight(collection,function(value,index,collection){accumulator=noaccum?(noaccum=!1,value):callback(accumulator,value,index,collection)}),accumulator}function reject(collection,callback,thisArg){return callback=lodash.createCallback(callback,thisArg,3),filter(collection,function(value,index,collection){return!callback(value,index,collection)})}function sample(collection,n,guard){if(collection&&"number"!=typeof collection.length&&(collection=values(collection)),null==n||guard)return collection?collection[baseRandom(0,collection.length-1)]:undefined;var result=shuffle(collection);return result.length=nativeMin(nativeMax(0,n),result.length),result}function shuffle(collection){var index=-1,length=collection?collection.length:0,result=Array("number"==typeof length?length:0);return forEach(collection,function(value){var rand=baseRandom(0,++index);result[index]=result[rand],result[rand]=value}),result}function size(collection){var length=collection?collection.length:0;return"number"==typeof length?length:keys(collection).length}function some(collection,callback,thisArg){var result;callback=lodash.createCallback(callback,thisArg,3);var index=-1,length=collection?collection.length:0;if("number"==typeof length)for(;++index<length&&!(result=callback(collection[index],index,collection)););else forOwn(collection,function(value,index,collection){return!(result=callback(value,index,collection))});return!!result}function sortBy(collection,callback,thisArg){var index=-1,isArr=isArray(callback),length=collection?collection.length:0,result=Array("number"==typeof length?length:0);for(isArr||(callback=lodash.createCallback(callback,thisArg,3)),forEach(collection,function(value,key,collection){var object=result[++index]=getObject();isArr?object.criteria=map(callback,function(key){return value[key]}):(object.criteria=getArray())[0]=callback(value,key,collection),object.index=index,object.value=value}),length=result.length,result.sort(compareAscending);length--;){var object=result[length];result[length]=object.value,isArr||releaseArray(object.criteria),releaseObject(object)}return result}function toArray(collection){return collection&&"number"==typeof collection.length?slice(collection):values(collection)}function compact(array){for(var index=-1,length=array?array.length:0,result=[];++index<length;){var value=array[index];value&&result.push(value)}return result}function difference(array){return baseDifference(array,baseFlatten(arguments,!0,!0,1))}function findIndex(array,callback,thisArg){var index=-1,length=array?array.length:0;for(callback=lodash.createCallback(callback,thisArg,3);++index<length;)if(callback(array[index],index,array))return index;return-1}function findLastIndex(array,callback,thisArg){var length=array?array.length:0;for(callback=lodash.createCallback(callback,thisArg,3);length--;)if(callback(array[length],length,array))return length;return-1}function first(array,callback,thisArg){var n=0,length=array?array.length:0;if("number"!=typeof callback&&null!=callback){var index=-1;for(callback=lodash.createCallback(callback,thisArg,3);++index<length&&callback(array[index],index,array);)n++}else if(n=callback,null==n||thisArg)return array?array[0]:undefined;return slice(array,0,nativeMin(nativeMax(0,n),length))}function flatten(array,isShallow,callback,thisArg){return"boolean"!=typeof isShallow&&null!=isShallow&&(thisArg=callback,callback="function"!=typeof isShallow&&thisArg&&thisArg[isShallow]===array?null:isShallow,isShallow=!1),null!=callback&&(array=map(array,callback,thisArg)),baseFlatten(array,isShallow)}function indexOf(array,value,fromIndex){if("number"==typeof fromIndex){var length=array?array.length:0;fromIndex=fromIndex<0?nativeMax(0,length+fromIndex):fromIndex||0}else if(fromIndex){var index=sortedIndex(array,value);return array[index]===value?index:-1}return baseIndexOf(array,value,fromIndex)}function initial(array,callback,thisArg){var n=0,length=array?array.length:0;if("number"!=typeof callback&&null!=callback){var index=length;for(callback=lodash.createCallback(callback,thisArg,3);index--&&callback(array[index],index,array);)n++}else n=null==callback||thisArg?1:callback||n;return slice(array,0,nativeMin(nativeMax(0,length-n),length))}function intersection(){for(var args=[],argsIndex=-1,argsLength=arguments.length,caches=getArray(),indexOf=getIndexOf(),trustIndexOf=indexOf===baseIndexOf,seen=getArray();++argsIndex<argsLength;){var value=arguments[argsIndex];(isArray(value)||isArguments(value))&&(args.push(value),caches.push(trustIndexOf&&value.length>=largeArraySize&&createCache(argsIndex?args[argsIndex]:seen)))}var array=args[0],index=-1,length=array?array.length:0,result=[];outer:for(;++index<length;){var cache=caches[0];if(value=array[index],(cache?cacheIndexOf(cache,value):indexOf(seen,value))<0){for(argsIndex=argsLength,(cache||seen).push(value);--argsIndex;)if(cache=caches[argsIndex],(cache?cacheIndexOf(cache,value):indexOf(args[argsIndex],value))<0)continue outer;result.push(value)}}for(;argsLength--;)cache=caches[argsLength],cache&&releaseObject(cache);return releaseArray(caches),releaseArray(seen),result}function last(array,callback,thisArg){var n=0,length=array?array.length:0;if("number"!=typeof callback&&null!=callback){var index=length;for(callback=lodash.createCallback(callback,thisArg,3);index--&&callback(array[index],index,array);)n++}else if(n=callback,null==n||thisArg)return array?array[length-1]:undefined;return slice(array,nativeMax(0,length-n))}function lastIndexOf(array,value,fromIndex){var index=array?array.length:0;for("number"==typeof fromIndex&&(index=(fromIndex<0?nativeMax(0,index+fromIndex):nativeMin(fromIndex,index-1))+1);index--;)if(array[index]===value)return index;return-1}function pull(array){for(var args=arguments,argsIndex=0,argsLength=args.length,length=array?array.length:0;++argsIndex<argsLength;)for(var index=-1,value=args[argsIndex];++index<length;)array[index]===value&&(splice.call(array,index--,1),length--);return array}function range(start,end,step){start=+start||0,step="number"==typeof step?step:+step||1,null==end&&(end=start,start=0);for(var index=-1,length=nativeMax(0,ceil((end-start)/(step||1))),result=Array(length);++index<length;)result[index]=start,start+=step;return result}function remove(array,callback,thisArg){var index=-1,length=array?array.length:0,result=[];for(callback=lodash.createCallback(callback,thisArg,3);++index<length;){var value=array[index];callback(value,index,array)&&(result.push(value),splice.call(array,index--,1),length--)}return result}function rest(array,callback,thisArg){if("number"!=typeof callback&&null!=callback){var n=0,index=-1,length=array?array.length:0;for(callback=lodash.createCallback(callback,thisArg,3);++index<length&&callback(array[index],index,array);)n++}else n=null==callback||thisArg?1:nativeMax(0,callback);return slice(array,n)}function sortedIndex(array,value,callback,thisArg){var low=0,high=array?array.length:low;for(callback=callback?lodash.createCallback(callback,thisArg,1):identity,value=callback(value);low<high;){var mid=low+high>>>1;callback(array[mid])<value?low=mid+1:high=mid}return low}function union(){return baseUniq(baseFlatten(arguments,!0,!0))}function uniq(array,isSorted,callback,thisArg){return"boolean"!=typeof isSorted&&null!=isSorted&&(thisArg=callback,callback="function"!=typeof isSorted&&thisArg&&thisArg[isSorted]===array?null:isSorted,isSorted=!1),null!=callback&&(callback=lodash.createCallback(callback,thisArg,3)),baseUniq(array,isSorted,callback)}function without(array){return baseDifference(array,slice(arguments,1))}function xor(){for(var index=-1,length=arguments.length;++index<length;){var array=arguments[index];if(isArray(array)||isArguments(array))var result=result?baseUniq(baseDifference(result,array).concat(baseDifference(array,result))):array}return result||[]}function zip(){for(var array=arguments.length>1?arguments:arguments[0],index=-1,length=array?max(pluck(array,"length")):0,result=Array(length<0?0:length);++index<length;)result[index]=pluck(array,index);return result}function zipObject(keys,values){var index=-1,length=keys?keys.length:0,result={};for(values||!length||isArray(keys[0])||(values=[]);++index<length;){var key=keys[index];values?result[key]=values[index]:key&&(result[key[0]]=key[1])}return result}function after(n,func){if(!isFunction(func))throw new TypeError;return function(){if(--n<1)return func.apply(this,arguments)}}function bind(func,thisArg){return arguments.length>2?createWrapper(func,17,slice(arguments,2),null,thisArg):createWrapper(func,1,null,null,thisArg)}function bindAll(object){for(var funcs=arguments.length>1?baseFlatten(arguments,!0,!1,1):functions(object),index=-1,length=funcs.length;++index<length;){var key=funcs[index];object[key]=createWrapper(object[key],1,null,null,object)}return object}function bindKey(object,key){return arguments.length>2?createWrapper(key,19,slice(arguments,2),null,object):createWrapper(key,3,null,null,object)}function compose(){for(var funcs=arguments,length=funcs.length;length--;)if(!isFunction(funcs[length]))throw new TypeError;return function(){for(var args=arguments,length=funcs.length;length--;)args=[funcs[length].apply(this,args)];return args[0]}}function curry(func,arity){return arity="number"==typeof arity?arity:+arity||func.length,createWrapper(func,4,null,null,null,arity)}function debounce(func,wait,options){var args,maxTimeoutId,result,stamp,thisArg,timeoutId,trailingCall,lastCalled=0,maxWait=!1,trailing=!0;if(!isFunction(func))throw new TypeError;if(wait=nativeMax(0,wait)||0,options===!0){var leading=!0;trailing=!1}else isObject(options)&&(leading=options.leading,maxWait="maxWait"in options&&(nativeMax(wait,options.maxWait)||0),trailing="trailing"in options?options.trailing:trailing);var delayed=function(){var remaining=wait-(now()-stamp);if(remaining<=0){maxTimeoutId&&clearTimeout(maxTimeoutId);var isCalled=trailingCall;maxTimeoutId=timeoutId=trailingCall=undefined,isCalled&&(lastCalled=now(),result=func.apply(thisArg,args),timeoutId||maxTimeoutId||(args=thisArg=null))}else timeoutId=setTimeout(delayed,remaining)},maxDelayed=function(){timeoutId&&clearTimeout(timeoutId),maxTimeoutId=timeoutId=trailingCall=undefined,(trailing||maxWait!==wait)&&(lastCalled=now(),result=func.apply(thisArg,args),timeoutId||maxTimeoutId||(args=thisArg=null))};return function(){if(args=arguments,stamp=now(),thisArg=this,trailingCall=trailing&&(timeoutId||!leading),maxWait===!1)var leadingCall=leading&&!timeoutId;else{maxTimeoutId||leading||(lastCalled=stamp);var remaining=maxWait-(stamp-lastCalled),isCalled=remaining<=0;isCalled?(maxTimeoutId&&(maxTimeoutId=clearTimeout(maxTimeoutId)),lastCalled=stamp,result=func.apply(thisArg,args)):maxTimeoutId||(maxTimeoutId=setTimeout(maxDelayed,remaining))}return isCalled&&timeoutId?timeoutId=clearTimeout(timeoutId):timeoutId||wait===maxWait||(timeoutId=setTimeout(delayed,wait)),leadingCall&&(isCalled=!0,result=func.apply(thisArg,args)),!isCalled||timeoutId||maxTimeoutId||(args=thisArg=null),result}}function defer(func){if(!isFunction(func))throw new TypeError;var args=slice(arguments,1);return setTimeout(function(){func.apply(undefined,args)},1)}function delay(func,wait){if(!isFunction(func))throw new TypeError;var args=slice(arguments,2);return setTimeout(function(){func.apply(undefined,args)},wait)}function memoize(func,resolver){if(!isFunction(func))throw new TypeError;var memoized=function(){var cache=memoized.cache,key=resolver?resolver.apply(this,arguments):keyPrefix+arguments[0];return hasOwnProperty.call(cache,key)?cache[key]:cache[key]=func.apply(this,arguments)};return memoized.cache={},memoized}function once(func){var ran,result;if(!isFunction(func))throw new TypeError;return function(){return ran?result:(ran=!0,result=func.apply(this,arguments),func=null,result)}}function partial(func){return createWrapper(func,16,slice(arguments,1))}function partialRight(func){return createWrapper(func,32,null,slice(arguments,1))}function throttle(func,wait,options){var leading=!0,trailing=!0;if(!isFunction(func))throw new TypeError;return options===!1?leading=!1:isObject(options)&&(leading="leading"in options?options.leading:leading,trailing="trailing"in options?options.trailing:trailing),debounceOptions.leading=leading,debounceOptions.maxWait=wait,debounceOptions.trailing=trailing,debounce(func,wait,debounceOptions)}function wrap(value,wrapper){return createWrapper(wrapper,16,[value])}function constant(value){return function(){return value}}function createCallback(func,thisArg,argCount){var type=typeof func;if(null==func||"function"==type)return baseCreateCallback(func,thisArg,argCount);if("object"!=type)return property(func);var props=keys(func),key=props[0],a=func[key];return 1!=props.length||a!==a||isObject(a)?function(object){for(var length=props.length,result=!1;length--&&(result=baseIsEqual(object[props[length]],func[props[length]],null,!0)););return result}:function(object){var b=object[key];return a===b&&(0!==a||1/a==1/b)}}function escape(string){return null==string?"":String(string).replace(reUnescapedHtml,escapeHtmlChar)}function identity(value){return value}function mixin(object,source,options){var chain=!0,methodNames=source&&functions(source);source&&(options||methodNames.length)||(null==options&&(options=source),ctor=lodashWrapper,source=object,object=lodash,methodNames=functions(source)),options===!1?chain=!1:isObject(options)&&"chain"in options&&(chain=options.chain);var ctor=object,isFunc=isFunction(ctor);forEach(methodNames,function(methodName){var func=object[methodName]=source[methodName];isFunc&&(ctor.prototype[methodName]=function(){var chainAll=this.__chain__,value=this.__wrapped__,args=[value];push.apply(args,arguments);var result=func.apply(object,args);if(chain||chainAll){if(value===result&&isObject(result))return this;result=new ctor(result),result.__chain__=chainAll}return result})})}function noConflict(){return context._=oldDash,this}function noop(){}function property(key){return function(object){return object[key]}}function random(min,max,floating){var noMin=null==min,noMax=null==max;if(null==floating&&("boolean"==typeof min&&noMax?(floating=min,min=1):noMax||"boolean"!=typeof max||(floating=max,noMax=!0)),noMin&&noMax&&(max=1),min=+min||0,noMax?(max=min,min=0):max=+max||0,floating||min%1||max%1){var rand=nativeRandom();return nativeMin(min+rand*(max-min+parseFloat("1e-"+((rand+"").length-1))),max)}return baseRandom(min,max)}function result(object,key){if(object){var value=object[key];return isFunction(value)?object[key]():value}}function template(text,data,options){var settings=lodash.templateSettings;text=String(text||""),options=defaults({},options,settings);var isEvaluating,imports=defaults({},options.imports,settings.imports),importsKeys=keys(imports),importsValues=values(imports),index=0,interpolate=options.interpolate||reNoMatch,source="__p += '",reDelimiters=RegExp((options.escape||reNoMatch).source+"|"+interpolate.source+"|"+(interpolate===reInterpolate?reEsTemplate:reNoMatch).source+"|"+(options.evaluate||reNoMatch).source+"|$","g");text.replace(reDelimiters,function(match,escapeValue,interpolateValue,esTemplateValue,evaluateValue,offset){return interpolateValue||(interpolateValue=esTemplateValue),source+=text.slice(index,offset).replace(reUnescapedString,escapeStringChar),escapeValue&&(source+="' +\n__e("+escapeValue+") +\n'"),evaluateValue&&(isEvaluating=!0,source+="';\n"+evaluateValue+";\n__p += '"),interpolateValue&&(source+="' +\n((__t = ("+interpolateValue+")) == null ? '' : __t) +\n'"),index=offset+match.length,match}),source+="';\n";var variable=options.variable,hasVariable=variable;hasVariable||(variable="obj",source="with ("+variable+") {\n"+source+"\n}\n"),source=(isEvaluating?source.replace(reEmptyStringLeading,""):source).replace(reEmptyStringMiddle,"$1").replace(reEmptyStringTrailing,"$1;"),source="function("+variable+") {\n"+(hasVariable?"":variable+" || ("+variable+" = {});\n")+"var __t, __p = '', __e = _.escape"+(isEvaluating?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+source+"return __p\n}";var sourceURL="\n/*\n//# sourceURL="+(options.sourceURL||"/lodash/template/source["+templateCounter++ +"]")+"\n*/";try{var result=Function(importsKeys,"return "+source+sourceURL).apply(undefined,importsValues)}catch(e){throw e.source=source,e}return data?result(data):(result.source=source,result)}function times(n,callback,thisArg){n=(n=+n)>-1?n:0;var index=-1,result=Array(n);for(callback=baseCreateCallback(callback,thisArg,1);++index<n;)result[index]=callback(index);return result}function unescape(string){return null==string?"":String(string).replace(reEscapedHtml,unescapeHtmlChar)}function uniqueId(prefix){var id=++idCounter;return String(null==prefix?"":prefix)+id}function chain(value){return value=new lodashWrapper(value),value.__chain__=!0,value}function tap(value,interceptor){return interceptor(value),value}function wrapperChain(){return this.__chain__=!0,this}function wrapperToString(){return String(this.__wrapped__)}function wrapperValueOf(){return this.__wrapped__}context=context?_.defaults(root.Object(),context,_.pick(root,contextProps)):root;var Array=context.Array,Boolean=context.Boolean,Date=context.Date,Function=context.Function,Math=context.Math,Number=context.Number,Object=context.Object,RegExp=context.RegExp,String=context.String,TypeError=context.TypeError,arrayRef=[],objectProto=Object.prototype,oldDash=context._,toString=objectProto.toString,reNative=RegExp("^"+String(toString).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/toString| for [^\]]+/g,".*?")+"$"),ceil=Math.ceil,clearTimeout=context.clearTimeout,floor=Math.floor,fnToString=Function.prototype.toString,getPrototypeOf=isNative(getPrototypeOf=Object.getPrototypeOf)&&getPrototypeOf,hasOwnProperty=objectProto.hasOwnProperty,push=arrayRef.push,setTimeout=context.setTimeout,splice=arrayRef.splice,unshift=arrayRef.unshift,defineProperty=function(){try{var o={},func=isNative(func=Object.defineProperty)&&func,result=func(o,o,o)&&func}catch(e){}return result}(),nativeCreate=isNative(nativeCreate=Object.create)&&nativeCreate,nativeIsArray=isNative(nativeIsArray=Array.isArray)&&nativeIsArray,nativeIsFinite=context.isFinite,nativeIsNaN=context.isNaN,nativeKeys=isNative(nativeKeys=Object.keys)&&nativeKeys,nativeMax=Math.max,nativeMin=Math.min,nativeParseInt=context.parseInt,nativeRandom=Math.random,ctorByClass={};ctorByClass[arrayClass]=Array,ctorByClass[boolClass]=Boolean,ctorByClass[dateClass]=Date,ctorByClass[funcClass]=Function,ctorByClass[objectClass]=Object,ctorByClass[numberClass]=Number,ctorByClass[regexpClass]=RegExp,ctorByClass[stringClass]=String,lodashWrapper.prototype=lodash.prototype;var support=lodash.support={};support.funcDecomp=!isNative(context.WinRTError)&&reThis.test(runInContext),support.funcNames="string"==typeof Function.name,lodash.templateSettings={escape:/<%-([\s\S]+?)%>/g,evaluate:/<%([\s\S]+?)%>/g,interpolate:reInterpolate,variable:"",imports:{_:lodash}},nativeCreate||(baseCreate=function(){function Object(){}return function(prototype){if(isObject(prototype)){Object.prototype=prototype;var result=new Object;Object.prototype=null}return result||context.Object()}}());var setBindData=defineProperty?function(func,value){descriptor.value=value,defineProperty(func,"__bindData__",descriptor),descriptor.value=null}:noop,isArray=nativeIsArray||function(value){return value&&"object"==typeof value&&"number"==typeof value.length&&toString.call(value)==arrayClass||!1},shimKeys=function(object){var index,iterable=object,result=[];if(!iterable)return result;if(!objectTypes[typeof object])return result;for(index in iterable)hasOwnProperty.call(iterable,index)&&result.push(index);return result},keys=nativeKeys?function(object){return isObject(object)?nativeKeys(object):[]}:shimKeys,htmlEscapes={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},htmlUnescapes=invert(htmlEscapes),reEscapedHtml=RegExp("("+keys(htmlUnescapes).join("|")+")","g"),reUnescapedHtml=RegExp("["+keys(htmlEscapes).join("")+"]","g"),assign=function(object,source,guard){var index,iterable=object,result=iterable;if(!iterable)return result;var args=arguments,argsIndex=0,argsLength="number"==typeof guard?2:args.length;if(argsLength>3&&"function"==typeof args[argsLength-2])var callback=baseCreateCallback(args[--argsLength-1],args[argsLength--],2);else argsLength>2&&"function"==typeof args[argsLength-1]&&(callback=args[--argsLength]);for(;++argsIndex<argsLength;)if(iterable=args[argsIndex],iterable&&objectTypes[typeof iterable])for(var ownIndex=-1,ownProps=objectTypes[typeof iterable]&&keys(iterable),length=ownProps?ownProps.length:0;++ownIndex<length;)index=ownProps[ownIndex],result[index]=callback?callback(result[index],iterable[index]):iterable[index];return result},defaults=function(object,source,guard){var index,iterable=object,result=iterable;if(!iterable)return result;for(var args=arguments,argsIndex=0,argsLength="number"==typeof guard?2:args.length;++argsIndex<argsLength;)if(iterable=args[argsIndex],iterable&&objectTypes[typeof iterable])for(var ownIndex=-1,ownProps=objectTypes[typeof iterable]&&keys(iterable),length=ownProps?ownProps.length:0;++ownIndex<length;)index=ownProps[ownIndex],"undefined"==typeof result[index]&&(result[index]=iterable[index]);return result},forIn=function(collection,callback,thisArg){var index,iterable=collection,result=iterable;if(!iterable)return result;if(!objectTypes[typeof iterable])return result;callback=callback&&"undefined"==typeof thisArg?callback:baseCreateCallback(callback,thisArg,3);for(index in iterable)if(callback(iterable[index],index,collection)===!1)return result;return result},forOwn=function(collection,callback,thisArg){var index,iterable=collection,result=iterable;if(!iterable)return result;if(!objectTypes[typeof iterable])return result;callback=callback&&"undefined"==typeof thisArg?callback:baseCreateCallback(callback,thisArg,3);for(var ownIndex=-1,ownProps=objectTypes[typeof iterable]&&keys(iterable),length=ownProps?ownProps.length:0;++ownIndex<length;)if(index=ownProps[ownIndex],callback(iterable[index],index,collection)===!1)return result;return result},isPlainObject=getPrototypeOf?function(value){if(!value||toString.call(value)!=objectClass)return!1;var valueOf=value.valueOf,objProto=isNative(valueOf)&&(objProto=getPrototypeOf(valueOf))&&getPrototypeOf(objProto);return objProto?value==objProto||getPrototypeOf(value)==objProto:shimIsPlainObject(value)}:shimIsPlainObject,countBy=createAggregator(function(result,value,key){hasOwnProperty.call(result,key)?result[key]++:result[key]=1}),groupBy=createAggregator(function(result,value,key){(hasOwnProperty.call(result,key)?result[key]:result[key]=[]).push(value)}),indexBy=createAggregator(function(result,value,key){result[key]=value}),pluck=map,where=filter,now=isNative(now=Date.now)&&now||function(){return(new Date).getTime()},parseInt=8==nativeParseInt(whitespace+"08")?nativeParseInt:function(value,radix){return nativeParseInt(isString(value)?value.replace(reLeadingSpacesAndZeros,""):value,radix||0)};return lodash.after=after,lodash.assign=assign,lodash.at=at,lodash.bind=bind,lodash.bindAll=bindAll,lodash.bindKey=bindKey,lodash.chain=chain,lodash.compact=compact,lodash.compose=compose,lodash.constant=constant,lodash.countBy=countBy,lodash.create=create,lodash.createCallback=createCallback,lodash.curry=curry,lodash.debounce=debounce,lodash.defaults=defaults,lodash.defer=defer,lodash.delay=delay,lodash.difference=difference,lodash.filter=filter,lodash.flatten=flatten,lodash.forEach=forEach,lodash.forEachRight=forEachRight,lodash.forIn=forIn,lodash.forInRight=forInRight,lodash.forOwn=forOwn,lodash.forOwnRight=forOwnRight,lodash.functions=functions,lodash.groupBy=groupBy,lodash.indexBy=indexBy,lodash.initial=initial,lodash.intersection=intersection,lodash.invert=invert,lodash.invoke=invoke,lodash.keys=keys,lodash.map=map,lodash.mapValues=mapValues,lodash.max=max,lodash.memoize=memoize,lodash.merge=merge,lodash.min=min,lodash.omit=omit,lodash.once=once,lodash.pairs=pairs,lodash.partial=partial,lodash.partialRight=partialRight,lodash.pick=pick,lodash.pluck=pluck,lodash.property=property,lodash.pull=pull,lodash.range=range,lodash.reject=reject,lodash.remove=remove,lodash.rest=rest,lodash.shuffle=shuffle,lodash.sortBy=sortBy,lodash.tap=tap,lodash.throttle=throttle,lodash.times=times,lodash.toArray=toArray,lodash.transform=transform,lodash.union=union,lodash.uniq=uniq,lodash.values=values,lodash.where=where,lodash.without=without,lodash.wrap=wrap,lodash.xor=xor,lodash.zip=zip,lodash.zipObject=zipObject,lodash.collect=map,lodash.drop=rest,lodash.each=forEach,lodash.eachRight=forEachRight,lodash.extend=assign,lodash.methods=functions,lodash.object=zipObject,lodash.select=filter,lodash.tail=rest,lodash.unique=uniq,lodash.unzip=zip,mixin(lodash),lodash.clone=clone,lodash.cloneDeep=cloneDeep,lodash.contains=contains,lodash.escape=escape,lodash.every=every,lodash.find=find,lodash.findIndex=findIndex,lodash.findKey=findKey,lodash.findLast=findLast,lodash.findLastIndex=findLastIndex,lodash.findLastKey=findLastKey,lodash.has=has,lodash.identity=identity,lodash.indexOf=indexOf,lodash.isArguments=isArguments,lodash.isArray=isArray,lodash.isBoolean=isBoolean,lodash.isDate=isDate,lodash.isElement=isElement,lodash.isEmpty=isEmpty,lodash.isEqual=isEqual,lodash.isFinite=isFinite,lodash.isFunction=isFunction,lodash.isNaN=isNaN,lodash.isNull=isNull,lodash.isNumber=isNumber,lodash.isObject=isObject,lodash.isPlainObject=isPlainObject,lodash.isRegExp=isRegExp,lodash.isString=isString,lodash.isUndefined=isUndefined,lodash.lastIndexOf=lastIndexOf,lodash.mixin=mixin,lodash.noConflict=noConflict,lodash.noop=noop,lodash.now=now,lodash.parseInt=parseInt,lodash.random=random,lodash.reduce=reduce,lodash.reduceRight=reduceRight,lodash.result=result,lodash.runInContext=runInContext,lodash.size=size,lodash.some=some,lodash.sortedIndex=sortedIndex,lodash.template=template,lodash.unescape=unescape,lodash.uniqueId=uniqueId,lodash.all=every,lodash.any=some,lodash.detect=find,lodash.findWhere=find,lodash.foldl=reduce,lodash.foldr=reduceRight,lodash.include=contains,lodash.inject=reduce,mixin(function(){var source={};return forOwn(lodash,function(func,methodName){lodash.prototype[methodName]||(source[methodName]=func)}),source}(),!1),lodash.first=first,lodash.last=last,lodash.sample=sample,lodash.take=first,lodash.head=first,forOwn(lodash,function(func,methodName){var callbackable="sample"!==methodName;lodash.prototype[methodName]||(lodash.prototype[methodName]=function(n,guard){var chainAll=this.__chain__,result=func(this.__wrapped__,n,guard);
return chainAll||null!=n&&(!guard||callbackable&&"function"==typeof n)?new lodashWrapper(result,chainAll):result})}),lodash.VERSION="2.4.2",lodash.prototype.chain=wrapperChain,lodash.prototype.toString=wrapperToString,lodash.prototype.value=wrapperValueOf,lodash.prototype.valueOf=wrapperValueOf,forEach(["join","pop","shift"],function(methodName){var func=arrayRef[methodName];lodash.prototype[methodName]=function(){var chainAll=this.__chain__,result=func.apply(this.__wrapped__,arguments);return chainAll?new lodashWrapper(result,chainAll):result}}),forEach(["push","reverse","sort","unshift"],function(methodName){var func=arrayRef[methodName];lodash.prototype[methodName]=function(){return func.apply(this.__wrapped__,arguments),this}}),forEach(["concat","slice","splice"],function(methodName){var func=arrayRef[methodName];lodash.prototype[methodName]=function(){return new lodashWrapper(func.apply(this.__wrapped__,arguments),this.__chain__)}}),lodash}var undefined,arrayPool=[],objectPool=[],idCounter=0,keyPrefix=+new Date+"",largeArraySize=75,maxPoolSize=40,whitespace=" \t\x0B\f\ufeff\n\r\u2028\u2029",reEmptyStringLeading=/\b__p \+= '';/g,reEmptyStringMiddle=/\b(__p \+=) '' \+/g,reEmptyStringTrailing=/(__e\(.*?\)|\b__t\)) \+\n'';/g,reEsTemplate=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,reFlags=/\w*$/,reFuncName=/^\s*function[ \n\r\t]+\w/,reInterpolate=/<%=([\s\S]+?)%>/g,reLeadingSpacesAndZeros=RegExp("^["+whitespace+"]*0+(?=.$)"),reNoMatch=/($^)/,reThis=/\bthis\b/,reUnescapedString=/['\n\r\t\u2028\u2029\\]/g,contextProps=["Array","Boolean","Date","Function","Math","Number","Object","RegExp","String","_","attachEvent","clearTimeout","isFinite","isNaN","parseInt","setTimeout"],templateCounter=0,argsClass="[object Arguments]",arrayClass="[object Array]",boolClass="[object Boolean]",dateClass="[object Date]",funcClass="[object Function]",numberClass="[object Number]",objectClass="[object Object]",regexpClass="[object RegExp]",stringClass="[object String]",cloneableClasses={};cloneableClasses[funcClass]=!1,cloneableClasses[argsClass]=cloneableClasses[arrayClass]=cloneableClasses[boolClass]=cloneableClasses[dateClass]=cloneableClasses[numberClass]=cloneableClasses[objectClass]=cloneableClasses[regexpClass]=cloneableClasses[stringClass]=!0;var debounceOptions={leading:!1,maxWait:0,trailing:!1},descriptor={configurable:!1,enumerable:!1,value:null,writable:!1},objectTypes={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},stringEscapes={"\\":"\\","'":"'","\n":"n","\r":"r","\t":"t","\u2028":"u2028","\u2029":"u2029"},root=objectTypes[typeof window]&&window||this,freeExports=objectTypes[typeof exports]&&exports&&!exports.nodeType&&exports,freeModule=objectTypes[typeof module]&&module&&!module.nodeType&&module,moduleExports=freeModule&&freeModule.exports===freeExports&&freeExports,freeGlobal=objectTypes[typeof global]&&global;!freeGlobal||freeGlobal.global!==freeGlobal&&freeGlobal.window!==freeGlobal||(root=freeGlobal);var _=runInContext();"function"==typeof define&&"object"==typeof define.amd&&define.amd?(root._=_,define(function(){return _})):freeExports&&freeModule?moduleExports?(freeModule.exports=_)._=_:freeExports._=_:root._=_}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],305:[function(require,module,exports){exports.ShouldBeDefined="Variable should be defined.",exports.ShouldBeUndefined="Variable should be undefined.",exports.ShouldBeArray="Variable should be of type Array.",exports.ShouldNotBeArray="Variable should NOT be of type Array.",exports.ShouldBeObject="Variable should be of type Object.",exports.ShouldNotBeObject="Variable should NOT be of type Object.",exports.ShouldBeEmpty="Array or object should be empty.",exports.ShouldNotBeEmpty="Array or object should NOT be empty.",exports.ShouldBeFunction="Variable should be a Function.",exports.ShouldNotBeFunction="Variable should NOT be a Function.",exports.ShouldBeString="Variable should be a String.",exports.ShouldNotBeString="Variable should NOT be a String.",exports.ShouldBeNumber="Variable should be a Number.",exports.ShouldNotBeNumber="Variable should NOT be a Number.",exports.ShouldBeFinite="Variable should be Finite (i.e. not infinity).",exports.ShouldBeInfinite="Variable should be Infinite.",exports.ShouldBeBoolean="Variable should be a Boolean.",exports.ShouldNotBeBoolean="Variable should NOT be a Boolean.",exports.ShouldBeDate="Variable should be a Date.",exports.ShouldNotBeDate="Variable should NOT be a Date.",exports.ShouldBeRegExp="Variable should be a RegExp.",exports.ShouldNotBeRegExp="Variable should NOT be a RegExp.",exports.ShouldBeFalsey="Variable should be falsey.",exports.ShouldNotBeFalsey="Variable should NOT be falsey.",exports.IllegalArgument="Illegal Argument.",exports.IllegalState="Illegal State.",exports.ShouldHaveValidIndex="Index should be between between 0 (inclusive) and size (exclusive).",exports.ShouldHaveValidPosition="Index should be between index between 0 (inclusive) and size (inclusive).",exports.ShouldHaveValidPositions="Start and End should be between valid sub range between 0 (inclusive) and size (inclusive).",exports.StartBeforeEnd="Start value should be less than the end value."},{}],306:[function(require,module,exports){"use strict";function Preconditions(objectUnderTest){this.out=objectUnderTest}var validatorFunctions=require("./validatorFunctions"),_=require("lodash");Preconditions.prototype.validate=function(configPath,verification,message){var variables=configPath.split("."),current=this.out||{},count=0;_.forEach(variables,function(variable){count!==variables.length-1&&validatorFunctions.shouldBeDefined(current[variable],message),current=current[variable],count++}),verification(current)},Preconditions.prototype.shouldBeDefined=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldBeDefined(val,message)},message),this},Preconditions.prototype.shouldBeUndefined=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldBeUndefined(val,message)},message),this},Preconditions.prototype.shouldBeNonEmptyArray=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldBeArray(val,message),validatorFunctions.shouldNotBeEmpty(val,message)},message),this},Preconditions.prototype.shouldBeArray=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldBeArray(val,message)},message),this},Preconditions.prototype.shouldNotBeArray=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldNotBeArray(val,message)},message),this},Preconditions.prototype.shouldBeObject=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldBeObject(val,message)},message),this},Preconditions.prototype.shouldNotBeObject=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldNotBeObject(val,message)},message),this},Preconditions.prototype.shouldBeEmpty=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldBeEmpty(val,message)},message),this},Preconditions.prototype.shouldNotBeEmpty=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldNotBeEmpty(val,message)},message),this},Preconditions.prototype.shouldBeFunction=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldBeFunction(val,message)},message),this},Preconditions.prototype.shouldNotBeFunction=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldNotBeFunction(val,message)},message),this},Preconditions.prototype.shouldBeString=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldBeString(val,message)},message),this},Preconditions.prototype.shouldNotBeString=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldNotBeString(val,message)},message),this},Preconditions.prototype.shouldBeNumber=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldBeNumber(val,message)},message),this},Preconditions.prototype.shouldNotBeNumber=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldNotBeNumber(val,message)},message),this},Preconditions.prototype.shouldBeFinite=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldBeFinite(val,message)},message),this},Preconditions.prototype.shouldBeInfinite=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldBeInfinite(val,message)},message),this},Preconditions.prototype.shouldBeBoolean=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldBeBoolean(val,message)},message),this},Preconditions.prototype.shouldNotBeBoolean=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldNotBeBoolean(val,message)},message),this},Preconditions.prototype.shouldBeDate=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldBeDate(val,message)},message),this},Preconditions.prototype.shouldNotBeDate=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldNotBeDate(val,message)},message),this},Preconditions.prototype.shouldBeRegExp=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldBeRegExp(val,message)},message),this},Preconditions.prototype.shouldNotBeRegExp=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldNotBeRegExp(val,message)},message),this},Preconditions.prototype.shouldBeFalsey=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldBeFalsey(val,message)},message),this},Preconditions.prototype.shouldNotBeFalsey=function(configPath,message){return this.validate(configPath,function(val){validatorFunctions.shouldNotBeFalsey(val,message)},message),this},Preconditions.prototype.checkArgument=function(val,message){return validatorFunctions.checkArgument(val,message),this},Preconditions.prototype.checkState=function(val,message){return validatorFunctions.checkState(val,message),this},Preconditions.prototype.checkElementIndex=function(index,size,message){return validatorFunctions.checkElementIndex(index,size,message),this},Preconditions.prototype.checkPositionIndex=function(index,size,message){return validatorFunctions.checkPositionIndex(index,size,message),this},Preconditions.prototype.checkPositionIndexes=function(start,end,size,message){return validatorFunctions.checkPositionIndexes(start,end,size,message),this},module.exports={instance:function(objectUnderTest){return new Preconditions(objectUnderTest)},constructor:function(){return Preconditions},singleton:function(){return validatorFunctions}}},{"./validatorFunctions":307,lodash:304}],307:[function(require,module,exports){"use strict";var constants=require("./constants"),_=require("lodash"),validatorFunctions={shouldBeDefined:function(val,message){if(_.isUndefined(val)){var msg=message||constants.ShouldBeDefined;throw new Error(msg)}return this},shouldBeUndefined:function(val,message){if(!_.isUndefined(val)){var msg=message||constants.ShouldBeUndefined;throw new Error(msg)}return this},shouldBeArray:function(val,message){if(!_.isArray(val)){var msg=message||constants.ShouldBeArray;throw new Error(msg)}return this},shouldNotBeArray:function(val,message){if(_.isArray(val)){var msg=message||constants.ShouldNotBeArray;throw new Error(msg)}return this},shouldBeObject:function(val,message){if(!_.isObject(val)){var msg=message||constants.ShouldBeObject;throw new Error(msg)}return this},shouldNotBeObject:function(val,message){if(_.isObject(val)){var msg=message||constants.ShouldNotBeObject;throw new Error(msg)}return this},shouldBeEmpty:function(val,message){if(!_.isEmpty(val)){var msg=message||constants.ShouldBeEmpty;throw new Error(msg)}return this},shouldNotBeEmpty:function(val,message){if(_.isEmpty(val)){var msg=message||constants.ShouldNotBeEmpty;throw new Error(msg)}return this},shouldBeFunction:function(val,message){if(!_.isFunction(val)){var msg=message||constants.ShouldBeFunction;throw new Error(msg)}return this},shouldNotBeFunction:function(val,message){if(_.isFunction(val)){var msg=message||constants.ShouldNotBeFunction;throw new Error(msg)}return this},shouldBeString:function(val,message){if(!_.isString(val)){var msg=message||constants.ShouldBeString;throw new Error(msg)}return this},shouldNotBeString:function(val,message){if(_.isString(val)){var msg=message||constants.ShouldNotBeString;throw new Error(msg)}return this},shouldBeNumber:function(val,message){if(!_.isNumber(val)){var msg=message||constants.ShouldBeNumber;throw new Error(msg)}return this},shouldNotBeNumber:function(val,message){if(console.log("val: "+val),_.isNumber(val)){var msg=message||constants.ShouldNotBeNumber;throw new Error(msg)}return this},shouldBeFinite:function(val,message){if(!_.isFinite(val)){var msg=message||constants.ShouldBeFinite;throw new Error(msg)}return this},shouldBeInfinite:function(val,message){if(_.isFinite(val)){var msg=message||constants.ShouldBeInfinite;throw new Error(msg)}return this},shouldBeBoolean:function(val,message){if(!_.isBoolean(val)){var msg=message||constants.ShouldBeBoolean;throw new Error(msg)}return this},shouldNotBeBoolean:function(val,message){if(_.isBoolean(val)){var msg=message||constants.ShouldNotBeBoolean;throw new Error(msg)}return this},shouldBeDate:function(val,message){if(!_.isDate(val)){var msg=message||constants.ShouldBeDate;throw new Error(msg)}return this},shouldNotBeDate:function(val,message){if(_.isDate(val)){var msg=message||constants.ShouldNotBeDate;throw new Error(msg)}return this},shouldBeRegExp:function(val,message){if(!_.isRegExp(val)){var msg=message||constants.ShouldBeRegExp;throw new Error(msg)}return this},shouldNotBeRegExp:function(val,message){if(_.isRegExp(val)){var msg=message||constants.ShouldNotBeRegExp;throw new Error(msg)}return this},shouldBeFalsey:function(val,message){if(!_.isNaN(val)&&!_.isNull(val)&&!_.isUndefined(val)){var msg=message||constants.ShouldBeFalsey;throw new Error(msg)}return this},shouldNotBeFalsey:function(val,message){if(_.isNaN(val)||_.isNull(val)||_.isUndefined(val)){var msg=message||constants.ShouldNotBeFalsey;throw new Error(msg)}return this},checkArgument:function(val,message){if(!val){var msg=message||constants.IllegalArgument;throw new Error(msg)}return this},checkState:function(val,message){if(!val){var msg=message||constants.IllegalState;throw new Error(msg)}return this},checkElementIndex:function(index,size,message){if(index<0||index>=size){var msg=message||constants.ShouldHaveValidIndex;throw new Error(msg)}return this},checkPositionIndex:function(index,size,message){if(index<0||index>size){var msg=message||constants.ShouldHaveValidPosition;throw new Error(msg)}return this},checkPositionIndexes:function(start,end,size,message){var msg;if(end<start)throw msg=message||constants.StartBeforeEnd,new Error(msg);if(start<0||end>size)throw msg=message||constants.ShouldHaveValidPositions,new Error(msg);return this}};module.exports=validatorFunctions},{"./constants":305,lodash:304}],308:[function(require,module,exports){(function(process){"use strict";function nextTick(fn,arg1,arg2,arg3){if("function"!=typeof fn)throw new TypeError('"callback" argument must be a function');var args,i,len=arguments.length;switch(len){case 0:case 1:return process.nextTick(fn);case 2:return process.nextTick(function(){fn.call(null,arg1)});case 3:return process.nextTick(function(){fn.call(null,arg1,arg2)});case 4:return process.nextTick(function(){fn.call(null,arg1,arg2,arg3)});default:for(args=new Array(len-1),i=0;i<args.length;)args[i++]=arguments[i];return process.nextTick(function(){fn.apply(null,args)})}}!process.version||0===process.version.indexOf("v0.")||0===process.version.indexOf("v1.")&&0!==process.version.indexOf("v1.8.")?module.exports={nextTick:nextTick}:module.exports=process}).call(this,require("_process"))},{_process:309}],309:[function(require,module,exports){function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(fun){if(cachedSetTimeout===setTimeout)return setTimeout(fun,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(fun,0);try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout)return clearTimeout(marker);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(marker);try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var timeout=runTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,runClearTimeout(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}var cachedSetTimeout,cachedClearTimeout,process=module.exports={};!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(name){return[]},process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},{}],310:[function(require,module,exports){exports.publicEncrypt=require("./publicEncrypt"),exports.privateDecrypt=require("./privateDecrypt"),exports.privateEncrypt=function(key,buf){return exports.publicEncrypt(key,buf,!0)},exports.publicDecrypt=function(key,buf){return exports.privateDecrypt(key,buf,!0)}},{"./privateDecrypt":312,"./publicEncrypt":313}],311:[function(require,module,exports){(function(Buffer){function i2ops(c){var out=new Buffer(4);return out.writeUInt32BE(c,0),out}var createHash=require("create-hash");module.exports=function(seed,len){for(var c,t=new Buffer(""),i=0;t.length<len;)c=i2ops(i++),t=Buffer.concat([t,createHash("sha1").update(seed).update(c).digest()]);return t.slice(0,len)}}).call(this,require("buffer").Buffer)},{buffer:151,"create-hash":177}],312:[function(require,module,exports){(function(Buffer){function oaep(key,msg){var k=(key.modulus,key.modulus.byteLength()),iHash=(msg.length,createHash("sha1").update(new Buffer("")).digest()),hLen=iHash.length;if(0!==msg[0])throw new Error("decryption error");var maskedSeed=msg.slice(1,hLen+1),maskedDb=msg.slice(hLen+1),seed=xor(maskedSeed,mgf(maskedDb,hLen)),db=xor(maskedDb,mgf(seed,k-hLen-1));if(compare(iHash,db.slice(0,hLen)))throw new Error("decryption error");for(var i=hLen;0===db[i];)i++;if(1!==db[i++])throw new Error("decryption error");return db.slice(i)}function pkcs1(key,msg,reverse){for(var p1=msg.slice(0,2),i=2,status=0;0!==msg[i++];)if(i>=msg.length){status++;break}var ps=msg.slice(2,i-1);msg.slice(i-1,i);if(("0002"!==p1.toString("hex")&&!reverse||"0001"!==p1.toString("hex")&&reverse)&&status++,ps.length<8&&status++,status)throw new Error("decryption error");return msg.slice(i)}function compare(a,b){a=new Buffer(a),b=new Buffer(b);var dif=0,len=a.length;a.length!==b.length&&(dif++,len=Math.min(a.length,b.length));for(var i=-1;++i<len;)dif+=a[i]^b[i];return dif}var parseKeys=require("parse-asn1"),mgf=require("./mgf"),xor=require("./xor"),bn=require("bn.js"),crt=require("browserify-rsa"),createHash=require("create-hash"),withPublic=require("./withPublic");module.exports=function(private_key,enc,reverse){var padding;padding=private_key.padding?private_key.padding:reverse?1:4;var key=parseKeys(private_key),k=key.modulus.byteLength();if(enc.length>k||new bn(enc).cmp(key.modulus)>=0)throw new Error("decryption error");var msg;msg=reverse?withPublic(new bn(enc),key):crt(enc,key);var zBuffer=new Buffer(k-msg.length);if(zBuffer.fill(0),msg=Buffer.concat([zBuffer,msg],k),4===padding)return oaep(key,msg);if(1===padding)return pkcs1(key,msg,reverse);if(3===padding)return msg;throw new Error("unknown padding")}}).call(this,require("buffer").Buffer)},{"./mgf":311,"./withPublic":314,"./xor":315,"bn.js":117,"browserify-rsa":140,buffer:151,"create-hash":177,"parse-asn1":297}],313:[function(require,module,exports){(function(Buffer){function oaep(key,msg){var k=key.modulus.byteLength(),mLen=msg.length,iHash=createHash("sha1").update(new Buffer("")).digest(),hLen=iHash.length,hLen2=2*hLen;if(mLen>k-hLen2-2)throw new Error("message too long");var ps=new Buffer(k-mLen-hLen2-2);ps.fill(0);var dblen=k-hLen-1,seed=randomBytes(hLen),maskedDb=xor(Buffer.concat([iHash,ps,new Buffer([1]),msg],dblen),mgf(seed,dblen)),maskedSeed=xor(seed,mgf(maskedDb,hLen));return new bn(Buffer.concat([new Buffer([0]),maskedSeed,maskedDb],k))}function pkcs1(key,msg,reverse){var mLen=msg.length,k=key.modulus.byteLength();if(mLen>k-11)throw new Error("message too long");var ps;return reverse?(ps=new Buffer(k-mLen-3),ps.fill(255)):ps=nonZero(k-mLen-3),new bn(Buffer.concat([new Buffer([0,reverse?1:2]),ps,new Buffer([0]),msg],k))}function nonZero(len,crypto){for(var num,out=new Buffer(len),i=0,cache=randomBytes(2*len),cur=0;i<len;)cur===cache.length&&(cache=randomBytes(2*len),cur=0),num=cache[cur++],num&&(out[i++]=num);return out}var parseKeys=require("parse-asn1"),randomBytes=require("randombytes"),createHash=require("create-hash"),mgf=require("./mgf"),xor=require("./xor"),bn=require("bn.js"),withPublic=require("./withPublic"),crt=require("browserify-rsa");module.exports=function(public_key,msg,reverse){var padding;padding=public_key.padding?public_key.padding:reverse?1:4;var paddedMsg,key=parseKeys(public_key);if(4===padding)paddedMsg=oaep(key,msg);else if(1===padding)paddedMsg=pkcs1(key,msg,reverse);else{if(3!==padding)throw new Error("unknown padding");if(paddedMsg=new bn(msg),paddedMsg.cmp(key.modulus)>=0)throw new Error("data too long for modulus")}return reverse?crt(paddedMsg,key):withPublic(paddedMsg,key)}}).call(this,require("buffer").Buffer)},{"./mgf":311,"./withPublic":314,"./xor":315,"bn.js":117,"browserify-rsa":140,buffer:151,"create-hash":177,"parse-asn1":297,randombytes:320}],314:[function(require,module,exports){(function(Buffer){function withPublic(paddedMsg,key){return new Buffer(paddedMsg.toRed(bn.mont(key.modulus)).redPow(new bn(key.publicExponent)).fromRed().toArray())}var bn=require("bn.js");module.exports=withPublic}).call(this,require("buffer").Buffer)},{"bn.js":117,buffer:151}],315:[function(require,module,exports){module.exports=function(a,b){for(var len=a.length,i=-1;++i<len;)a[i]^=b[i];return a}},{}],316:[function(require,module,exports){(function(global){!function(root){function error(type){throw new RangeError(errors[type])}function map(array,fn){for(var length=array.length,result=[];length--;)result[length]=fn(array[length]);return result}function mapDomain(string,fn){var parts=string.split("@"),result="";parts.length>1&&(result=parts[0]+"@",string=parts[1]),string=string.replace(regexSeparators,".");var labels=string.split("."),encoded=map(labels,fn).join(".");return result+encoded}function ucs2decode(string){for(var value,extra,output=[],counter=0,length=string.length;counter<length;)value=string.charCodeAt(counter++),value>=55296&&value<=56319&&counter<length?(extra=string.charCodeAt(counter++),56320==(64512&extra)?output.push(((1023&value)<<10)+(1023&extra)+65536):(output.push(value),counter--)):output.push(value);return output}function ucs2encode(array){return map(array,function(value){var output="";return value>65535&&(value-=65536,output+=stringFromCharCode(value>>>10&1023|55296),value=56320|1023&value),output+=stringFromCharCode(value)}).join("")}function basicToDigit(codePoint){return codePoint-48<10?codePoint-22:codePoint-65<26?codePoint-65:codePoint-97<26?codePoint-97:base}function digitToBasic(digit,flag){return digit+22+75*(digit<26)-((0!=flag)<<5)}function adapt(delta,numPoints,firstTime){var k=0;for(delta=firstTime?floor(delta/damp):delta>>1,delta+=floor(delta/numPoints);delta>baseMinusTMin*tMax>>1;k+=base)delta=floor(delta/baseMinusTMin);return floor(k+(baseMinusTMin+1)*delta/(delta+skew))}function decode(input){var out,basic,j,index,oldi,w,k,digit,t,baseMinusT,output=[],inputLength=input.length,i=0,n=initialN,bias=initialBias;for(basic=input.lastIndexOf(delimiter),basic<0&&(basic=0),j=0;j<basic;++j)input.charCodeAt(j)>=128&&error("not-basic"),output.push(input.charCodeAt(j));for(index=basic>0?basic+1:0;index<inputLength;){for(oldi=i,w=1,k=base;index>=inputLength&&error("invalid-input"),digit=basicToDigit(input.charCodeAt(index++)),(digit>=base||digit>floor((maxInt-i)/w))&&error("overflow"),i+=digit*w,t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias,!(digit<t);k+=base)baseMinusT=base-t,w>floor(maxInt/baseMinusT)&&error("overflow"),w*=baseMinusT;out=output.length+1,bias=adapt(i-oldi,out,0==oldi),floor(i/out)>maxInt-n&&error("overflow"),n+=floor(i/out),i%=out,output.splice(i++,0,n)}return ucs2encode(output)}function encode(input){var n,delta,handledCPCount,basicLength,bias,j,m,q,k,t,currentValue,inputLength,handledCPCountPlusOne,baseMinusT,qMinusT,output=[];for(input=ucs2decode(input),inputLength=input.length,n=initialN,delta=0,bias=initialBias,j=0;j<inputLength;++j)currentValue=input[j],currentValue<128&&output.push(stringFromCharCode(currentValue));for(handledCPCount=basicLength=output.length,basicLength&&output.push(delimiter);handledCPCount<inputLength;){for(m=maxInt,j=0;j<inputLength;++j)currentValue=input[j],currentValue>=n&&currentValue<m&&(m=currentValue);for(handledCPCountPlusOne=handledCPCount+1,m-n>floor((maxInt-delta)/handledCPCountPlusOne)&&error("overflow"),delta+=(m-n)*handledCPCountPlusOne,n=m,j=0;j<inputLength;++j)if(currentValue=input[j],currentValue<n&&++delta>maxInt&&error("overflow"),currentValue==n){for(q=delta,k=base;t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias,!(q<t);k+=base)qMinusT=q-t,baseMinusT=base-t,output.push(stringFromCharCode(digitToBasic(t+qMinusT%baseMinusT,0))),q=floor(qMinusT/baseMinusT);output.push(stringFromCharCode(digitToBasic(q,0))),bias=adapt(delta,handledCPCountPlusOne,handledCPCount==basicLength),delta=0,++handledCPCount}++delta,++n}return output.join("")}function toUnicode(input){return mapDomain(input,function(string){return regexPunycode.test(string)?decode(string.slice(4).toLowerCase()):string})}function toASCII(input){return mapDomain(input,function(string){return regexNonASCII.test(string)?"xn--"+encode(string):string})}var freeExports="object"==typeof exports&&exports&&!exports.nodeType&&exports,freeModule="object"==typeof module&&module&&!module.nodeType&&module,freeGlobal="object"==typeof global&&global;freeGlobal.global!==freeGlobal&&freeGlobal.window!==freeGlobal&&freeGlobal.self!==freeGlobal||(root=freeGlobal);var punycode,key,maxInt=2147483647,base=36,tMin=1,tMax=26,skew=38,damp=700,initialBias=72,initialN=128,delimiter="-",regexPunycode=/^xn--/,regexNonASCII=/[^\x20-\x7E]/,regexSeparators=/[\x2E\u3002\uFF0E\uFF61]/g,errors={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},baseMinusTMin=base-tMin,floor=Math.floor,stringFromCharCode=String.fromCharCode;if(punycode={version:"1.4.1",ucs2:{decode:ucs2decode,encode:ucs2encode},decode:decode,encode:encode,toASCII:toASCII,toUnicode:toUnicode},"function"==typeof define&&"object"==typeof define.amd&&define.amd)define("punycode",function(){return punycode});else if(freeExports&&freeModule)if(module.exports==freeExports)freeModule.exports=punycode;else for(key in punycode)punycode.hasOwnProperty(key)&&(freeExports[key]=punycode[key]);else root.punycode=punycode}(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],317:[function(require,module,exports){"use strict";function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}module.exports=function(qs,sep,eq,options){sep=sep||"&",eq=eq||"=";var obj={};if("string"!=typeof qs||0===qs.length)return obj;var regexp=/\+/g;qs=qs.split(sep);var maxKeys=1e3;options&&"number"==typeof options.maxKeys&&(maxKeys=options.maxKeys);var len=qs.length;maxKeys>0&&len>maxKeys&&(len=maxKeys);for(var i=0;i<len;++i){var kstr,vstr,k,v,x=qs[i].replace(regexp,"%20"),idx=x.indexOf(eq);idx>=0?(kstr=x.substr(0,idx),vstr=x.substr(idx+1)):(kstr=x,vstr=""),k=decodeURIComponent(kstr),v=decodeURIComponent(vstr),hasOwnProperty(obj,k)?isArray(obj[k])?obj[k].push(v):obj[k]=[obj[k],v]:obj[k]=v}return obj};var isArray=Array.isArray||function(xs){return"[object Array]"===Object.prototype.toString.call(xs)}},{}],318:[function(require,module,exports){"use strict";function map(xs,f){if(xs.map)return xs.map(f);for(var res=[],i=0;i<xs.length;i++)res.push(f(xs[i],i));return res}var stringifyPrimitive=function(v){switch(typeof v){case"string":return v;case"boolean":return v?"true":"false";case"number":return isFinite(v)?v:"";default:return""}};module.exports=function(obj,sep,eq,name){return sep=sep||"&",eq=eq||"=",null===obj&&(obj=void 0),"object"==typeof obj?map(objectKeys(obj),function(k){var ks=encodeURIComponent(stringifyPrimitive(k))+eq;return isArray(obj[k])?map(obj[k],function(v){return ks+encodeURIComponent(stringifyPrimitive(v))}).join(sep):ks+encodeURIComponent(stringifyPrimitive(obj[k]))}).join(sep):name?encodeURIComponent(stringifyPrimitive(name))+eq+encodeURIComponent(stringifyPrimitive(obj)):""};var isArray=Array.isArray||function(xs){return"[object Array]"===Object.prototype.toString.call(xs)},objectKeys=Object.keys||function(obj){var res=[];for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&res.push(key);return res}},{}],319:[function(require,module,exports){"use strict";exports.decode=exports.parse=require("./decode"),exports.encode=exports.stringify=require("./encode")},{"./decode":317,"./encode":318}],320:[function(require,module,exports){(function(process,global){"use strict";function oldBrowser(){throw new Error("Secure random number generation is not supported by this browser.\nUse Chrome, Firefox or Internet Explorer 11")}function randomBytes(size,cb){if(size>65536)throw new Error("requested too many random bytes");var rawBytes=new global.Uint8Array(size);
size>0&&crypto.getRandomValues(rawBytes);var bytes=Buffer.from(rawBytes.buffer);return"function"==typeof cb?process.nextTick(function(){cb(null,bytes)}):bytes}var Buffer=require("safe-buffer").Buffer,crypto=global.crypto||global.msCrypto;crypto&&crypto.getRandomValues?module.exports=randomBytes:module.exports=oldBrowser}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{_process:309,"safe-buffer":323}],321:[function(require,module,exports){(function(process,global){"use strict";function oldBrowser(){throw new Error("secure random number generation not supported by this browser\nuse chrome, FireFox or Internet Explorer 11")}function assertOffset(offset,length){if("number"!=typeof offset||offset!==offset)throw new TypeError("offset must be a number");if(offset>kMaxUint32||offset<0)throw new TypeError("offset must be a uint32");if(offset>kBufferMaxLength||offset>length)throw new RangeError("offset out of range")}function assertSize(size,offset,length){if("number"!=typeof size||size!==size)throw new TypeError("size must be a number");if(size>kMaxUint32||size<0)throw new TypeError("size must be a uint32");if(size+offset>length||size>kBufferMaxLength)throw new RangeError("buffer too small")}function randomFill(buf,offset,size,cb){if(!(Buffer.isBuffer(buf)||buf instanceof global.Uint8Array))throw new TypeError('"buf" argument must be a Buffer or Uint8Array');if("function"==typeof offset)cb=offset,offset=0,size=buf.length;else if("function"==typeof size)cb=size,size=buf.length-offset;else if("function"!=typeof cb)throw new TypeError('"cb" argument must be a function');return assertOffset(offset,buf.length),assertSize(size,offset,buf.length),actualFill(buf,offset,size,cb)}function actualFill(buf,offset,size,cb){if(process.browser){var ourBuf=buf.buffer,uint=new Uint8Array(ourBuf,offset,size);return crypto.getRandomValues(uint),cb?void process.nextTick(function(){cb(null,buf)}):buf}if(cb)return void randombytes(size,function(err,bytes){return err?cb(err):(bytes.copy(buf,offset),void cb(null,buf))});var bytes=randombytes(size);return bytes.copy(buf,offset),buf}function randomFillSync(buf,offset,size){if("undefined"==typeof offset&&(offset=0),!(Buffer.isBuffer(buf)||buf instanceof global.Uint8Array))throw new TypeError('"buf" argument must be a Buffer or Uint8Array');return assertOffset(offset,buf.length),void 0===size&&(size=buf.length-offset),assertSize(size,offset,buf.length),actualFill(buf,offset,size)}var safeBuffer=require("safe-buffer"),randombytes=require("randombytes"),Buffer=safeBuffer.Buffer,kBufferMaxLength=safeBuffer.kMaxLength,crypto=global.crypto||global.msCrypto,kMaxUint32=Math.pow(2,32)-1;crypto&&crypto.getRandomValues||!process.browser?(exports.randomFill=randomFill,exports.randomFillSync=randomFillSync):(exports.randomFill=oldBrowser,exports.randomFillSync=oldBrowser)}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{_process:309,randombytes:320,"safe-buffer":323}],322:[function(require,module,exports){"use strict";function RIPEMD160(){HashBase.call(this,64),this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520}function rotl(x,n){return x<<n|x>>>32-n}function fn1(a,b,c,d,e,m,k,s){return rotl(a+(b^c^d)+m+k|0,s)+e|0}function fn2(a,b,c,d,e,m,k,s){return rotl(a+(b&c|~b&d)+m+k|0,s)+e|0}function fn3(a,b,c,d,e,m,k,s){return rotl(a+((b|~c)^d)+m+k|0,s)+e|0}function fn4(a,b,c,d,e,m,k,s){return rotl(a+(b&d|c&~d)+m+k|0,s)+e|0}function fn5(a,b,c,d,e,m,k,s){return rotl(a+(b^(c|~d))+m+k|0,s)+e|0}var Buffer=require("buffer").Buffer,inherits=require("inherits"),HashBase=require("hash-base"),ARRAY16=new Array(16),zl=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13],zr=[5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11],sl=[11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6],sr=[8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11],hl=[0,1518500249,1859775393,2400959708,2840853838],hr=[1352829926,1548603684,1836072691,2053994217,0];inherits(RIPEMD160,HashBase),RIPEMD160.prototype._update=function(){for(var words=ARRAY16,j=0;j<16;++j)words[j]=this._block.readInt32LE(4*j);for(var al=0|this._a,bl=0|this._b,cl=0|this._c,dl=0|this._d,el=0|this._e,ar=0|this._a,br=0|this._b,cr=0|this._c,dr=0|this._d,er=0|this._e,i=0;i<80;i+=1){var tl,tr;i<16?(tl=fn1(al,bl,cl,dl,el,words[zl[i]],hl[0],sl[i]),tr=fn5(ar,br,cr,dr,er,words[zr[i]],hr[0],sr[i])):i<32?(tl=fn2(al,bl,cl,dl,el,words[zl[i]],hl[1],sl[i]),tr=fn4(ar,br,cr,dr,er,words[zr[i]],hr[1],sr[i])):i<48?(tl=fn3(al,bl,cl,dl,el,words[zl[i]],hl[2],sl[i]),tr=fn3(ar,br,cr,dr,er,words[zr[i]],hr[2],sr[i])):i<64?(tl=fn4(al,bl,cl,dl,el,words[zl[i]],hl[3],sl[i]),tr=fn2(ar,br,cr,dr,er,words[zr[i]],hr[3],sr[i])):(tl=fn5(al,bl,cl,dl,el,words[zl[i]],hl[4],sl[i]),tr=fn1(ar,br,cr,dr,er,words[zr[i]],hr[4],sr[i])),al=el,el=dl,dl=rotl(cl,10),cl=bl,bl=tl,ar=er,er=dr,dr=rotl(cr,10),cr=br,br=tr}var t=this._b+cl+dr|0;this._b=this._c+dl+er|0,this._c=this._d+el+ar|0,this._d=this._e+al+br|0,this._e=this._a+bl+cr|0,this._a=t},RIPEMD160.prototype._digest=function(){this._block[this._blockOffset++]=128,this._blockOffset>56&&(this._block.fill(0,this._blockOffset,64),this._update(),this._blockOffset=0),this._block.fill(0,this._blockOffset,56),this._block.writeUInt32LE(this._length[0],56),this._block.writeUInt32LE(this._length[1],60),this._update();var buffer=Buffer.alloc?Buffer.alloc(20):new Buffer(20);return buffer.writeInt32LE(this._a,0),buffer.writeInt32LE(this._b,4),buffer.writeInt32LE(this._c,8),buffer.writeInt32LE(this._d,12),buffer.writeInt32LE(this._e,16),buffer},module.exports=RIPEMD160},{buffer:151,"hash-base":217,inherits:233}],323:[function(require,module,exports){function copyProps(src,dst){for(var key in src)dst[key]=src[key]}function SafeBuffer(arg,encodingOrOffset,length){return Buffer(arg,encodingOrOffset,length)}var buffer=require("buffer"),Buffer=buffer.Buffer;Buffer.from&&Buffer.alloc&&Buffer.allocUnsafe&&Buffer.allocUnsafeSlow?module.exports=buffer:(copyProps(buffer,exports),exports.Buffer=SafeBuffer),copyProps(Buffer,SafeBuffer),SafeBuffer.from=function(arg,encodingOrOffset,length){if("number"==typeof arg)throw new TypeError("Argument must not be a number");return Buffer(arg,encodingOrOffset,length)},SafeBuffer.alloc=function(size,fill,encoding){if("number"!=typeof size)throw new TypeError("Argument must be a number");var buf=Buffer(size);return void 0!==fill?"string"==typeof encoding?buf.fill(fill,encoding):buf.fill(fill):buf.fill(0),buf},SafeBuffer.allocUnsafe=function(size){if("number"!=typeof size)throw new TypeError("Argument must be a number");return Buffer(size)},SafeBuffer.allocUnsafeSlow=function(size){if("number"!=typeof size)throw new TypeError("Argument must be a number");return buffer.SlowBuffer(size)}},{buffer:151}],324:[function(require,module,exports){(function(Buffer){function scrypt(key,salt,N,r,p,dkLen,progressCallback){function smix(B,Bi,r,N,V,XY){var i,Xi=0,Yi=128*r;for(B.copy(XY,Xi,Bi,Bi+Yi),i=0;i<N;i++)XY.copy(V,i*Yi,Xi,Xi+Yi),blockmix_salsa8(XY,Xi,Yi,r),tickCallback&&tickCallback();for(i=0;i<N;i++){var offset=Xi+64*(2*r-1),j=XY.readUInt32LE(offset)&N-1;blockxor(V,j*Yi,XY,Xi,Yi),blockmix_salsa8(XY,Xi,Yi,r),tickCallback&&tickCallback()}XY.copy(B,Bi,Xi,Xi+Yi)}function blockmix_salsa8(BY,Bi,Yi,r){var i;for(arraycopy(BY,Bi+64*(2*r-1),_X,0,64),i=0;i<2*r;i++)blockxor(BY,64*i,_X,0,64),salsa20_8(_X),arraycopy(_X,0,BY,Yi+64*i,64);for(i=0;i<r;i++)arraycopy(BY,Yi+2*i*64,BY,Bi+64*i,64);for(i=0;i<r;i++)arraycopy(BY,Yi+64*(2*i+1),BY,Bi+64*(i+r),64)}function R(a,b){return a<<b|a>>>32-b}function salsa20_8(B){var i;for(i=0;i<16;i++)B32[i]=(255&B[4*i+0])<<0,B32[i]|=(255&B[4*i+1])<<8,B32[i]|=(255&B[4*i+2])<<16,B32[i]|=(255&B[4*i+3])<<24;for(arraycopy(B32,0,x,0,16),i=8;i>0;i-=2)x[4]^=R(x[0]+x[12],7),x[8]^=R(x[4]+x[0],9),x[12]^=R(x[8]+x[4],13),x[0]^=R(x[12]+x[8],18),x[9]^=R(x[5]+x[1],7),x[13]^=R(x[9]+x[5],9),x[1]^=R(x[13]+x[9],13),x[5]^=R(x[1]+x[13],18),x[14]^=R(x[10]+x[6],7),x[2]^=R(x[14]+x[10],9),x[6]^=R(x[2]+x[14],13),x[10]^=R(x[6]+x[2],18),x[3]^=R(x[15]+x[11],7),x[7]^=R(x[3]+x[15],9),x[11]^=R(x[7]+x[3],13),x[15]^=R(x[11]+x[7],18),x[1]^=R(x[0]+x[3],7),x[2]^=R(x[1]+x[0],9),x[3]^=R(x[2]+x[1],13),x[0]^=R(x[3]+x[2],18),x[6]^=R(x[5]+x[4],7),x[7]^=R(x[6]+x[5],9),x[4]^=R(x[7]+x[6],13),x[5]^=R(x[4]+x[7],18),x[11]^=R(x[10]+x[9],7),x[8]^=R(x[11]+x[10],9),x[9]^=R(x[8]+x[11],13),x[10]^=R(x[9]+x[8],18),x[12]^=R(x[15]+x[14],7),x[13]^=R(x[12]+x[15],9),x[14]^=R(x[13]+x[12],13),x[15]^=R(x[14]+x[13],18);for(i=0;i<16;++i)B32[i]=x[i]+B32[i];for(i=0;i<16;i++){var bi=4*i;B[bi+0]=B32[i]>>0&255,B[bi+1]=B32[i]>>8&255,B[bi+2]=B32[i]>>16&255,B[bi+3]=B32[i]>>24&255}}function blockxor(S,Si,D,Di,len){for(var i=0;i<len;i++)D[Di+i]^=S[Si+i]}if(0===N||0!==(N&N-1))throw Error("N must be > 0 and a power of 2");if(N>MAX_VALUE/128/r)throw Error("Parameter N is too large");if(r>MAX_VALUE/128/p)throw Error("Parameter r is too large");var tickCallback,XY=new Buffer(256*r),V=new Buffer(128*r*N),B32=new Int32Array(16),x=new Int32Array(16),_X=new Buffer(64),B=pbkdf2Sync(key,salt,1,128*p*r,"sha256");if(progressCallback){var totalOps=p*N*2,currentOp=0;tickCallback=function(){++currentOp,currentOp%1e3===0&&progressCallback({current:currentOp,total:totalOps,percent:currentOp/totalOps*100})}}for(var i=0;i<p;i++)smix(B,128*i*r,r,N,V,XY);return pbkdf2Sync(key,B,1,dkLen,"sha256")}function arraycopy(src,srcPos,dest,destPos,length){if(Buffer.isBuffer(src)&&Buffer.isBuffer(dest))src.copy(dest,destPos,srcPos,srcPos+length);else for(;length--;)dest[destPos++]=src[srcPos++]}var pbkdf2Sync=require("pbkdf2").pbkdf2Sync,MAX_VALUE=2147483647;module.exports=scrypt}).call(this,require("buffer").Buffer)},{buffer:151,pbkdf2:298}],325:[function(require,module,exports){"use strict";module.exports=require("./lib")(require("./lib/js"))},{"./lib":328,"./lib/js":334}],326:[function(require,module,exports){(function(Buffer){"use strict";var toString=Object.prototype.toString;exports.isArray=function(value,message){if(!Array.isArray(value))throw TypeError(message)},exports.isBoolean=function(value,message){if("[object Boolean]"!==toString.call(value))throw TypeError(message)},exports.isBuffer=function(value,message){if(!Buffer.isBuffer(value))throw TypeError(message)},exports.isFunction=function(value,message){if("[object Function]"!==toString.call(value))throw TypeError(message)},exports.isNumber=function(value,message){if("[object Number]"!==toString.call(value))throw TypeError(message)},exports.isObject=function(value,message){if("[object Object]"!==toString.call(value))throw TypeError(message)},exports.isBufferLength=function(buffer,length,message){if(buffer.length!==length)throw RangeError(message)},exports.isBufferLength2=function(buffer,length1,length2,message){if(buffer.length!==length1&&buffer.length!==length2)throw RangeError(message)},exports.isLengthGTZero=function(value,message){if(0===value.length)throw RangeError(message)},exports.isNumberInInterval=function(number,x,y,message){if(number<=x||number>=y)throw RangeError(message)}}).call(this,{isBuffer:require("../../is-buffer/index.js")})},{"../../is-buffer/index.js":234}],327:[function(require,module,exports){"use strict";var Buffer=require("safe-buffer").Buffer,bip66=require("bip66"),EC_PRIVKEY_EXPORT_DER_COMPRESSED=Buffer.from([48,129,211,2,1,1,4,32,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,160,129,133,48,129,130,2,1,1,48,44,6,7,42,134,72,206,61,1,1,2,33,0,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,254,255,255,252,47,48,6,4,1,0,4,1,7,4,33,2,121,190,102,126,249,220,187,172,85,160,98,149,206,135,11,7,2,155,252,219,45,206,40,217,89,242,129,91,22,248,23,152,2,33,0,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,254,186,174,220,230,175,72,160,59,191,210,94,140,208,54,65,65,2,1,1,161,36,3,34,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),EC_PRIVKEY_EXPORT_DER_UNCOMPRESSED=Buffer.from([48,130,1,19,2,1,1,4,32,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,160,129,165,48,129,162,2,1,1,48,44,6,7,42,134,72,206,61,1,1,2,33,0,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,254,255,255,252,47,48,6,4,1,0,4,1,7,4,65,4,121,190,102,126,249,220,187,172,85,160,98,149,206,135,11,7,2,155,252,219,45,206,40,217,89,242,129,91,22,248,23,152,72,58,218,119,38,163,196,101,93,164,251,252,14,17,8,168,253,23,180,72,166,133,84,25,156,71,208,143,251,16,212,184,2,33,0,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,254,186,174,220,230,175,72,160,59,191,210,94,140,208,54,65,65,2,1,1,161,68,3,66,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);exports.privateKeyExport=function(privateKey,publicKey,compressed){var result=Buffer.from(compressed?EC_PRIVKEY_EXPORT_DER_COMPRESSED:EC_PRIVKEY_EXPORT_DER_UNCOMPRESSED);return privateKey.copy(result,compressed?8:9),publicKey.copy(result,compressed?181:214),result},exports.privateKeyImport=function(privateKey){var length=privateKey.length,index=0;if(!(length<index+1||48!==privateKey[index])&&(index+=1,!(length<index+1)&&128&privateKey[index])){var lenb=127&privateKey[index];if(index+=1,!(lenb<1||lenb>2||length<index+lenb)){var len=privateKey[index+lenb-1]|(lenb>1?privateKey[index+lenb-2]<<8:0);if(index+=lenb,!(length<index+len||length<index+3||2!==privateKey[index]||1!==privateKey[index+1]||1!==privateKey[index+2]||(index+=3,length<index+2||4!==privateKey[index]||privateKey[index+1]>32||length<index+2+privateKey[index+1])))return privateKey.slice(index+2,index+2+privateKey[index+1])}}},exports.signatureExport=function(sigObj){for(var r=Buffer.concat([Buffer.from([0]),sigObj.r]),lenR=33,posR=0;lenR>1&&0===r[posR]&&!(128&r[posR+1]);--lenR,++posR);for(var s=Buffer.concat([Buffer.from([0]),sigObj.s]),lenS=33,posS=0;lenS>1&&0===s[posS]&&!(128&s[posS+1]);--lenS,++posS);return bip66.encode(r.slice(posR),s.slice(posS))},exports.signatureImport=function(sig){var r=Buffer.alloc(32,0),s=Buffer.alloc(32,0);try{var sigObj=bip66.decode(sig);if(33===sigObj.r.length&&0===sigObj.r[0]&&(sigObj.r=sigObj.r.slice(1)),sigObj.r.length>32)throw new Error("R length is too long");if(33===sigObj.s.length&&0===sigObj.s[0]&&(sigObj.s=sigObj.s.slice(1)),sigObj.s.length>32)throw new Error("S length is too long")}catch(err){return}return sigObj.r.copy(r,32-sigObj.r.length),sigObj.s.copy(s,32-sigObj.s.length),{r:r,s:s}},exports.signatureImportLax=function(sig){var r=Buffer.alloc(32,0),s=Buffer.alloc(32,0),length=sig.length,index=0;if(48===sig[index++]){var lenbyte=sig[index++];if(!(128&lenbyte&&(index+=lenbyte-128,index>length))&&2===sig[index++]){var rlen=sig[index++];if(128&rlen){if(lenbyte=rlen-128,index+lenbyte>length)return;for(;lenbyte>0&&0===sig[index];index+=1,lenbyte-=1);for(rlen=0;lenbyte>0;index+=1,lenbyte-=1)rlen=(rlen<<8)+sig[index]}if(!(rlen>length-index)){var rindex=index;if(index+=rlen,2===sig[index++]){var slen=sig[index++];if(128&slen){if(lenbyte=slen-128,index+lenbyte>length)return;for(;lenbyte>0&&0===sig[index];index+=1,lenbyte-=1);for(slen=0;lenbyte>0;index+=1,lenbyte-=1)slen=(slen<<8)+sig[index]}if(!(slen>length-index)){var sindex=index;for(index+=slen;rlen>0&&0===sig[rindex];rlen-=1,rindex+=1);if(!(rlen>32)){var rvalue=sig.slice(rindex,rindex+rlen);for(rvalue.copy(r,32-rvalue.length);slen>0&&0===sig[sindex];slen-=1,sindex+=1);if(!(slen>32)){var svalue=sig.slice(sindex,sindex+slen);return svalue.copy(s,32-svalue.length),{r:r,s:s}}}}}}}}}},{bip66:33,"safe-buffer":323}],328:[function(require,module,exports){"use strict";function initCompressedValue(value,defaultValue){return void 0===value?defaultValue:(assert.isBoolean(value,messages.COMPRESSED_TYPE_INVALID),value)}var assert=require("./assert"),der=require("./der"),messages=require("./messages.json");module.exports=function(secp256k1){return{privateKeyVerify:function(privateKey){return assert.isBuffer(privateKey,messages.EC_PRIVATE_KEY_TYPE_INVALID),32===privateKey.length&&secp256k1.privateKeyVerify(privateKey)},privateKeyExport:function(privateKey,compressed){assert.isBuffer(privateKey,messages.EC_PRIVATE_KEY_TYPE_INVALID),assert.isBufferLength(privateKey,32,messages.EC_PRIVATE_KEY_LENGTH_INVALID),compressed=initCompressedValue(compressed,!0);var publicKey=secp256k1.privateKeyExport(privateKey,compressed);return der.privateKeyExport(privateKey,publicKey,compressed)},privateKeyImport:function(privateKey){if(assert.isBuffer(privateKey,messages.EC_PRIVATE_KEY_TYPE_INVALID),privateKey=der.privateKeyImport(privateKey),privateKey&&32===privateKey.length&&secp256k1.privateKeyVerify(privateKey))return privateKey;throw new Error(messages.EC_PRIVATE_KEY_IMPORT_DER_FAIL)},privateKeyNegate:function(privateKey){return assert.isBuffer(privateKey,messages.EC_PRIVATE_KEY_TYPE_INVALID),assert.isBufferLength(privateKey,32,messages.EC_PRIVATE_KEY_LENGTH_INVALID),secp256k1.privateKeyNegate(privateKey)},privateKeyModInverse:function(privateKey){return assert.isBuffer(privateKey,messages.EC_PRIVATE_KEY_TYPE_INVALID),assert.isBufferLength(privateKey,32,messages.EC_PRIVATE_KEY_LENGTH_INVALID),secp256k1.privateKeyModInverse(privateKey)},privateKeyTweakAdd:function(privateKey,tweak){return assert.isBuffer(privateKey,messages.EC_PRIVATE_KEY_TYPE_INVALID),assert.isBufferLength(privateKey,32,messages.EC_PRIVATE_KEY_LENGTH_INVALID),assert.isBuffer(tweak,messages.TWEAK_TYPE_INVALID),assert.isBufferLength(tweak,32,messages.TWEAK_LENGTH_INVALID),secp256k1.privateKeyTweakAdd(privateKey,tweak)},privateKeyTweakMul:function(privateKey,tweak){return assert.isBuffer(privateKey,messages.EC_PRIVATE_KEY_TYPE_INVALID),assert.isBufferLength(privateKey,32,messages.EC_PRIVATE_KEY_LENGTH_INVALID),assert.isBuffer(tweak,messages.TWEAK_TYPE_INVALID),assert.isBufferLength(tweak,32,messages.TWEAK_LENGTH_INVALID),secp256k1.privateKeyTweakMul(privateKey,tweak)},publicKeyCreate:function(privateKey,compressed){return assert.isBuffer(privateKey,messages.EC_PRIVATE_KEY_TYPE_INVALID),assert.isBufferLength(privateKey,32,messages.EC_PRIVATE_KEY_LENGTH_INVALID),compressed=initCompressedValue(compressed,!0),secp256k1.publicKeyCreate(privateKey,compressed)},publicKeyConvert:function(publicKey,compressed){return assert.isBuffer(publicKey,messages.EC_PUBLIC_KEY_TYPE_INVALID),assert.isBufferLength2(publicKey,33,65,messages.EC_PUBLIC_KEY_LENGTH_INVALID),compressed=initCompressedValue(compressed,!0),secp256k1.publicKeyConvert(publicKey,compressed)},publicKeyVerify:function(publicKey){return assert.isBuffer(publicKey,messages.EC_PUBLIC_KEY_TYPE_INVALID),secp256k1.publicKeyVerify(publicKey)},publicKeyTweakAdd:function(publicKey,tweak,compressed){return assert.isBuffer(publicKey,messages.EC_PUBLIC_KEY_TYPE_INVALID),assert.isBufferLength2(publicKey,33,65,messages.EC_PUBLIC_KEY_LENGTH_INVALID),assert.isBuffer(tweak,messages.TWEAK_TYPE_INVALID),assert.isBufferLength(tweak,32,messages.TWEAK_LENGTH_INVALID),compressed=initCompressedValue(compressed,!0),secp256k1.publicKeyTweakAdd(publicKey,tweak,compressed)},publicKeyTweakMul:function(publicKey,tweak,compressed){return assert.isBuffer(publicKey,messages.EC_PUBLIC_KEY_TYPE_INVALID),assert.isBufferLength2(publicKey,33,65,messages.EC_PUBLIC_KEY_LENGTH_INVALID),assert.isBuffer(tweak,messages.TWEAK_TYPE_INVALID),assert.isBufferLength(tweak,32,messages.TWEAK_LENGTH_INVALID),compressed=initCompressedValue(compressed,!0),secp256k1.publicKeyTweakMul(publicKey,tweak,compressed)},publicKeyCombine:function(publicKeys,compressed){assert.isArray(publicKeys,messages.EC_PUBLIC_KEYS_TYPE_INVALID),assert.isLengthGTZero(publicKeys,messages.EC_PUBLIC_KEYS_LENGTH_INVALID);for(var i=0;i<publicKeys.length;++i)assert.isBuffer(publicKeys[i],messages.EC_PUBLIC_KEY_TYPE_INVALID),assert.isBufferLength2(publicKeys[i],33,65,messages.EC_PUBLIC_KEY_LENGTH_INVALID);return compressed=initCompressedValue(compressed,!0),secp256k1.publicKeyCombine(publicKeys,compressed)},signatureNormalize:function(signature){return assert.isBuffer(signature,messages.ECDSA_SIGNATURE_TYPE_INVALID),assert.isBufferLength(signature,64,messages.ECDSA_SIGNATURE_LENGTH_INVALID),secp256k1.signatureNormalize(signature)},signatureExport:function(signature){assert.isBuffer(signature,messages.ECDSA_SIGNATURE_TYPE_INVALID),assert.isBufferLength(signature,64,messages.ECDSA_SIGNATURE_LENGTH_INVALID);var sigObj=secp256k1.signatureExport(signature);return der.signatureExport(sigObj)},signatureImport:function(sig){assert.isBuffer(sig,messages.ECDSA_SIGNATURE_TYPE_INVALID),assert.isLengthGTZero(sig,messages.ECDSA_SIGNATURE_LENGTH_INVALID);var sigObj=der.signatureImport(sig);if(sigObj)return secp256k1.signatureImport(sigObj);throw new Error(messages.ECDSA_SIGNATURE_PARSE_DER_FAIL)},signatureImportLax:function(sig){assert.isBuffer(sig,messages.ECDSA_SIGNATURE_TYPE_INVALID),assert.isLengthGTZero(sig,messages.ECDSA_SIGNATURE_LENGTH_INVALID);var sigObj=der.signatureImportLax(sig);if(sigObj)return secp256k1.signatureImport(sigObj);throw new Error(messages.ECDSA_SIGNATURE_PARSE_DER_FAIL)},sign:function(message,privateKey,options){assert.isBuffer(message,messages.MSG32_TYPE_INVALID),assert.isBufferLength(message,32,messages.MSG32_LENGTH_INVALID),assert.isBuffer(privateKey,messages.EC_PRIVATE_KEY_TYPE_INVALID),assert.isBufferLength(privateKey,32,messages.EC_PRIVATE_KEY_LENGTH_INVALID);var data=null,noncefn=null;return void 0!==options&&(assert.isObject(options,messages.OPTIONS_TYPE_INVALID),void 0!==options.data&&(assert.isBuffer(options.data,messages.OPTIONS_DATA_TYPE_INVALID),assert.isBufferLength(options.data,32,messages.OPTIONS_DATA_LENGTH_INVALID),data=options.data),void 0!==options.noncefn&&(assert.isFunction(options.noncefn,messages.OPTIONS_NONCEFN_TYPE_INVALID),noncefn=options.noncefn)),secp256k1.sign(message,privateKey,noncefn,data)},verify:function(message,signature,publicKey){return assert.isBuffer(message,messages.MSG32_TYPE_INVALID),assert.isBufferLength(message,32,messages.MSG32_LENGTH_INVALID),assert.isBuffer(signature,messages.ECDSA_SIGNATURE_TYPE_INVALID),assert.isBufferLength(signature,64,messages.ECDSA_SIGNATURE_LENGTH_INVALID),assert.isBuffer(publicKey,messages.EC_PUBLIC_KEY_TYPE_INVALID),assert.isBufferLength2(publicKey,33,65,messages.EC_PUBLIC_KEY_LENGTH_INVALID),secp256k1.verify(message,signature,publicKey)},recover:function(message,signature,recovery,compressed){return assert.isBuffer(message,messages.MSG32_TYPE_INVALID),assert.isBufferLength(message,32,messages.MSG32_LENGTH_INVALID),assert.isBuffer(signature,messages.ECDSA_SIGNATURE_TYPE_INVALID),assert.isBufferLength(signature,64,messages.ECDSA_SIGNATURE_LENGTH_INVALID),assert.isNumber(recovery,messages.RECOVERY_ID_TYPE_INVALID),assert.isNumberInInterval(recovery,-1,4,messages.RECOVERY_ID_VALUE_INVALID),compressed=initCompressedValue(compressed,!0),secp256k1.recover(message,signature,recovery,compressed)},ecdh:function(publicKey,privateKey){return assert.isBuffer(publicKey,messages.EC_PUBLIC_KEY_TYPE_INVALID),assert.isBufferLength2(publicKey,33,65,messages.EC_PUBLIC_KEY_LENGTH_INVALID),assert.isBuffer(privateKey,messages.EC_PRIVATE_KEY_TYPE_INVALID),assert.isBufferLength(privateKey,32,messages.EC_PRIVATE_KEY_LENGTH_INVALID),secp256k1.ecdh(publicKey,privateKey)},ecdhUnsafe:function(publicKey,privateKey,compressed){return assert.isBuffer(publicKey,messages.EC_PUBLIC_KEY_TYPE_INVALID),assert.isBufferLength2(publicKey,33,65,messages.EC_PUBLIC_KEY_LENGTH_INVALID),assert.isBuffer(privateKey,messages.EC_PRIVATE_KEY_TYPE_INVALID),assert.isBufferLength(privateKey,32,messages.EC_PRIVATE_KEY_LENGTH_INVALID),compressed=initCompressedValue(compressed,!0),secp256k1.ecdhUnsafe(publicKey,privateKey,compressed)}}}},{"./assert":326,"./der":327,"./messages.json":335}],329:[function(require,module,exports){"use strict";function BN(){this.negative=0,this.words=null,this.length=0}var Buffer=require("safe-buffer").Buffer,optimized=require("./optimized");BN.fromNumber=function(n){var bn=new BN;return bn.words=[67108863&n],bn.length=1,bn},BN.fromBuffer=function(b32){var bn=new BN;return bn.words=new Array(10),bn.words[0]=(3&b32[28])<<24|b32[29]<<16|b32[30]<<8|b32[31],bn.words[1]=(15&b32[25])<<22|b32[26]<<14|b32[27]<<6|b32[28]>>>2,bn.words[2]=(63&b32[22])<<20|b32[23]<<12|b32[24]<<4|b32[25]>>>4,bn.words[3]=(255&b32[19])<<18|b32[20]<<10|b32[21]<<2|b32[22]>>>6,bn.words[4]=(3&b32[15])<<24|b32[16]<<16|b32[17]<<8|b32[18],bn.words[5]=(15&b32[12])<<22|b32[13]<<14|b32[14]<<6|b32[15]>>>2,bn.words[6]=(63&b32[9])<<20|b32[10]<<12|b32[11]<<4|b32[12]>>>4,bn.words[7]=(255&b32[6])<<18|b32[7]<<10|b32[8]<<2|b32[9]>>>6,bn.words[8]=(3&b32[2])<<24|b32[3]<<16|b32[4]<<8|b32[5],bn.words[9]=b32[0]<<14|b32[1]<<6|b32[2]>>>2,bn.length=10,bn.strip()},BN.prototype.toBuffer=function(){for(var w=this.words,i=this.length;i<10;++i)w[i]=0;return Buffer.from([w[9]>>>14&255,w[9]>>>6&255,(63&w[9])<<2|w[8]>>>24&3,w[8]>>>16&255,w[8]>>>8&255,255&w[8],w[7]>>>18&255,w[7]>>>10&255,w[7]>>>2&255,(3&w[7])<<6|w[6]>>>20&63,w[6]>>>12&255,w[6]>>>4&255,(15&w[6])<<4|w[5]>>>22&15,w[5]>>>14&255,w[5]>>>6&255,(63&w[5])<<2|w[4]>>>24&3,w[4]>>>16&255,w[4]>>>8&255,255&w[4],w[3]>>>18&255,w[3]>>>10&255,w[3]>>>2&255,(3&w[3])<<6|w[2]>>>20&63,w[2]>>>12&255,w[2]>>>4&255,(15&w[2])<<4|w[1]>>>22&15,w[1]>>>14&255,w[1]>>>6&255,(63&w[1])<<2|w[0]>>>24&3,w[0]>>>16&255,w[0]>>>8&255,255&w[0]])},BN.prototype.clone=function(){var r=new BN;r.words=new Array(this.length);for(var i=0;i<this.length;i++)r.words[i]=this.words[i];return r.length=this.length,r.negative=this.negative,r},BN.prototype.strip=function(){for(;this.length>1&&0===(0|this.words[this.length-1]);)this.length--;return this},BN.prototype.normSign=function(){return 1===this.length&&0===this.words[0]&&(this.negative=0),this},BN.prototype.isEven=function(){return 0===(1&this.words[0])},BN.prototype.isOdd=function(){return 1===(1&this.words[0])},BN.prototype.isZero=function(){return 1===this.length&&0===this.words[0]},BN.prototype.ucmp=function(num){if(this.length!==num.length)return this.length>num.length?1:-1;for(var i=this.length-1;i>=0;--i)if(this.words[i]!==num.words[i])return this.words[i]>num.words[i]?1:-1;return 0},BN.prototype.gtOne=function(){return this.length>1||this.words[0]>1},BN.prototype.isOverflow=function(){return this.ucmp(BN.n)>=0},BN.prototype.isHigh=function(){return 1===this.ucmp(BN.nh)},BN.prototype.bitLengthGT256=function(){return this.length>10||10===this.length&&this.words[9]>4194303},BN.prototype.iuaddn=function(num){this.words[0]+=num;for(var i=0;this.words[i]>67108863&&i<this.length;++i)this.words[i]-=67108864,this.words[i+1]+=1;return i===this.length&&(this.words[i]=1,this.length+=1),this},BN.prototype.iadd=function(num){if(this.negative!==num.negative)return 0!==this.negative?(this.negative=0,this.isub(num),this.negative^=1):(num.negative=0,this.isub(num),num.negative=1),this.normSign();var a,b;this.length>num.length?(a=this,b=num):(a=num,b=this);for(var i=0,carry=0;i<b.length;++i){var word=a.words[i]+b.words[i]+carry;this.words[i]=67108863&word,carry=word>>>26}for(;0!==carry&&i<a.length;++i)word=a.words[i]+carry,this.words[i]=67108863&word,carry=word>>>26;if(this.length=a.length,0!==carry)this.words[this.length++]=carry;else if(a!==this)for(;i<a.length;++i)this.words[i]=a.words[i];return this},BN.prototype.add=function(num){return this.clone().iadd(num)},BN.prototype.isub=function(num){if(this.negative!==num.negative)return 0!==this.negative?(this.negative=0,this.iadd(num),this.negative=1):(num.negative=0,this.iadd(num),num.negative=1),this.normSign();var cmp=this.ucmp(num);if(0===cmp)return this.negative=0,this.words[0]=0,this.length=1,this;var a,b;cmp>0?(a=this,b=num):(a=num,b=this);for(var i=0,carry=0;i<b.length;++i){var word=a.words[i]-b.words[i]+carry;carry=word>>26,this.words[i]=67108863&word}for(;0!==carry&&i<a.length;++i)word=a.words[i]+carry,carry=word>>26,this.words[i]=67108863&word;if(0===carry&&i<a.length&&a!==this)for(;i<a.length;++i)this.words[i]=a.words[i];return this.length=Math.max(this.length,i),a!==this&&(this.negative^=1),this.strip().normSign()},BN.prototype.sub=function(num){return this.clone().isub(num)},BN.umulTo=function(num1,num2,out){out.length=num1.length+num2.length-1;var a1=num1.words[0],b1=num2.words[0],r1=a1*b1,carry=r1/67108864|0;out.words[0]=67108863&r1;for(var k=1,maxK=out.length;k<maxK;k++){for(var ncarry=carry>>>26,rword=67108863&carry,j=Math.max(0,k-num1.length+1),maxJ=Math.min(k,num2.length-1);j<=maxJ;j++){var i=k-j,a=num1.words[i],b=num2.words[j],r=a*b+rword;ncarry+=r/67108864|0,rword=67108863&r}out.words[k]=rword,carry=ncarry}return 0!==carry&&(out.words[out.length++]=carry),out.strip()},BN.umulTo10x10=Math.imul?optimized.umulTo10x10:BN.umulTo,BN.umulnTo=function(num,k,out){if(0===k)return out.words=[0],out.length=1,out;for(var i=0,carry=0;i<num.length;++i){var r=num.words[i]*k+carry;out.words[i]=67108863&r,carry=r/67108864|0}return carry>0?(out.words[i]=carry,out.length=num.length+1):out.length=num.length,out},BN.prototype.umul=function(num){var out=new BN;return out.words=new Array(this.length+num.length),10===this.length&&10===num.length?BN.umulTo10x10(this,num,out):1===this.length?BN.umulnTo(num,this.words[0],out):1===num.length?BN.umulnTo(this,num.words[0],out):BN.umulTo(this,num,out)},BN.prototype.isplit=function(output){output.length=Math.min(this.length,9);for(var i=0;i<output.length;++i)output.words[i]=this.words[i];if(this.length<=9)return this.words[0]=0,this.length=1,this;var prev=this.words[9];for(output.words[output.length++]=4194303&prev,i=10;i<this.length;++i){var word=this.words[i];this.words[i-10]=(4194303&word)<<4|prev>>>22,prev=word}return prev>>>=22,this.words[i-10]=prev,0===prev&&this.length>10?this.length-=10:this.length-=9,this},BN.prototype.fireduce=function(){return this.isOverflow()&&this.isub(BN.n),this},BN.prototype.ureduce=function(){var num=this.clone().isplit(BN.tmp).umul(BN.nc).iadd(BN.tmp);return num.bitLengthGT256()&&(num=num.isplit(BN.tmp).umul(BN.nc).iadd(BN.tmp),num.bitLengthGT256()&&(num=num.isplit(BN.tmp).umul(BN.nc).iadd(BN.tmp))),num.fireduce()},BN.prototype.ishrn=function(n){for(var mask=(1<<n)-1,m=26-n,i=this.length-1,carry=0;i>=0;--i){var word=this.words[i];this.words[i]=carry<<m|word>>>n,carry=word&mask}return this.length>1&&0===this.words[this.length-1]&&(this.length-=1),this},BN.prototype.uinvm=function(){for(var x=this.clone(),y=BN.n.clone(),A=BN.fromNumber(1),B=BN.fromNumber(0),C=BN.fromNumber(0),D=BN.fromNumber(1);x.isEven()&&y.isEven();){for(var k=1,m=1;0===(x.words[0]&m)&&0===(y.words[0]&m)&&k<26;++k,m<<=1);x.ishrn(k),y.ishrn(k)}for(var yp=y.clone(),xp=x.clone();!x.isZero();){for(var i=0,im=1;0===(x.words[0]&im)&&i<26;++i,im<<=1);if(i>0)for(x.ishrn(i);i-- >0;)(A.isOdd()||B.isOdd())&&(A.iadd(yp),B.isub(xp)),A.ishrn(1),B.ishrn(1);for(var j=0,jm=1;0===(y.words[0]&jm)&&j<26;++j,jm<<=1);if(j>0)for(y.ishrn(j);j-- >0;)(C.isOdd()||D.isOdd())&&(C.iadd(yp),D.isub(xp)),C.ishrn(1),D.ishrn(1);x.ucmp(y)>=0?(x.isub(y),A.isub(C),B.isub(D)):(y.isub(x),C.isub(A),D.isub(B))}if(1===C.negative){C.negative=0;var result=C.ureduce();return result.negative^=1,result.normSign().iadd(BN.n)}return C.ureduce()},BN.prototype.imulK=function(){this.words[this.length]=0,this.words[this.length+1]=0,this.length+=2;for(var i=0,lo=0;i<this.length;++i){var w=0|this.words[i];lo+=977*w,this.words[i]=67108863&lo,lo=64*w+(lo/67108864|0)}return 0===this.words[this.length-1]&&(this.length-=1,
0===this.words[this.length-1]&&(this.length-=1)),this},BN.prototype.redIReduce=function(){this.isplit(BN.tmp).imulK().iadd(BN.tmp),this.bitLengthGT256()&&this.isplit(BN.tmp).imulK().iadd(BN.tmp);var cmp=this.ucmp(BN.p);return 0===cmp?(this.words[0]=0,this.length=1):cmp>0?this.isub(BN.p):this.strip(),this},BN.prototype.redNeg=function(){return this.isZero()?BN.fromNumber(0):BN.p.sub(this)},BN.prototype.redAdd=function(num){return this.clone().redIAdd(num)},BN.prototype.redIAdd=function(num){return this.iadd(num),this.ucmp(BN.p)>=0&&this.isub(BN.p),this},BN.prototype.redIAdd7=function(){return this.iuaddn(7),this.ucmp(BN.p)>=0&&this.isub(BN.p),this},BN.prototype.redSub=function(num){return this.clone().redISub(num)},BN.prototype.redISub=function(num){return this.isub(num),0!==this.negative&&this.iadd(BN.p),this},BN.prototype.redMul=function(num){return this.umul(num).redIReduce()},BN.prototype.redSqr=function(){return this.umul(this).redIReduce()},BN.prototype.redSqrt=function(){if(this.isZero())return this.clone();for(var wv2=this.redSqr(),wv4=wv2.redSqr(),wv12=wv4.redSqr().redMul(wv4),wv14=wv12.redMul(wv2),wv15=wv14.redMul(this),out=wv15,i=0;i<54;++i)out=out.redSqr().redSqr().redSqr().redSqr().redMul(wv15);for(out=out.redSqr().redSqr().redSqr().redSqr().redMul(wv14),i=0;i<5;++i)out=out.redSqr().redSqr().redSqr().redSqr().redMul(wv15);return out=out.redSqr().redSqr().redSqr().redSqr().redMul(wv12),out=out.redSqr().redSqr().redSqr().redSqr().redSqr().redSqr().redMul(wv12),0===out.redSqr().ucmp(this)?out:null},BN.prototype.redInvm=function(){for(var a=this.clone(),b=BN.p.clone(),x1=BN.fromNumber(1),x2=BN.fromNumber(0);a.gtOne()&&b.gtOne();){for(var i=0,im=1;0===(a.words[0]&im)&&i<26;++i,im<<=1);if(i>0)for(a.ishrn(i);i-- >0;)x1.isOdd()&&x1.iadd(BN.p),x1.ishrn(1);for(var j=0,jm=1;0===(b.words[0]&jm)&&j<26;++j,jm<<=1);if(j>0)for(b.ishrn(j);j-- >0;)x2.isOdd()&&x2.iadd(BN.p),x2.ishrn(1);a.ucmp(b)>=0?(a.isub(b),x1.isub(x2)):(b.isub(a),x2.isub(x1))}var res;return res=1===a.length&&1===a.words[0]?x1:x2,0!==res.negative&&res.iadd(BN.p),0!==res.negative?(res.negative=0,res.redIReduce().redNeg()):res.redIReduce()},BN.prototype.getNAF=function(w){for(var naf=[],ws=1<<w+1,wsm1=ws-1,ws2=ws>>1,k=this.clone();!k.isZero();){for(var i=0,m=1;0===(k.words[0]&m)&&i<26;++i,m<<=1)naf.push(0);if(0!==i)k.ishrn(i);else{var mod=k.words[0]&wsm1;if(mod>=ws2)naf.push(ws2-mod),k.iuaddn(mod-ws2).ishrn(1);else if(naf.push(mod),k.words[0]-=mod,!k.isZero()){for(i=w-1;i>0;--i)naf.push(0);k.ishrn(w)}}}return naf},BN.prototype.inspect=function(){if(this.isZero())return"0";for(var buffer=this.toBuffer().toString("hex"),i=0;"0"===buffer[i];++i);return buffer.slice(i)},BN.n=BN.fromBuffer(Buffer.from("FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141","hex")),BN.nh=BN.n.clone().ishrn(1),BN.nc=BN.fromBuffer(Buffer.from("000000000000000000000000000000014551231950B75FC4402DA1732FC9BEBF","hex")),BN.p=BN.fromBuffer(Buffer.from("FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFC2F","hex")),BN.psn=BN.p.sub(BN.n),BN.tmp=new BN,BN.tmp.words=new Array(10),function(){var x=BN.fromNumber(1);x.words[3]=0}(),module.exports=BN},{"./optimized":330,"safe-buffer":323}],330:[function(require,module,exports){"use strict";exports.umulTo10x10=function(num1,num2,out){var lo,mid,hi,a=num1.words,b=num2.words,o=out.words,c=0,a0=0|a[0],al0=8191&a0,ah0=a0>>>13,a1=0|a[1],al1=8191&a1,ah1=a1>>>13,a2=0|a[2],al2=8191&a2,ah2=a2>>>13,a3=0|a[3],al3=8191&a3,ah3=a3>>>13,a4=0|a[4],al4=8191&a4,ah4=a4>>>13,a5=0|a[5],al5=8191&a5,ah5=a5>>>13,a6=0|a[6],al6=8191&a6,ah6=a6>>>13,a7=0|a[7],al7=8191&a7,ah7=a7>>>13,a8=0|a[8],al8=8191&a8,ah8=a8>>>13,a9=0|a[9],al9=8191&a9,ah9=a9>>>13,b0=0|b[0],bl0=8191&b0,bh0=b0>>>13,b1=0|b[1],bl1=8191&b1,bh1=b1>>>13,b2=0|b[2],bl2=8191&b2,bh2=b2>>>13,b3=0|b[3],bl3=8191&b3,bh3=b3>>>13,b4=0|b[4],bl4=8191&b4,bh4=b4>>>13,b5=0|b[5],bl5=8191&b5,bh5=b5>>>13,b6=0|b[6],bl6=8191&b6,bh6=b6>>>13,b7=0|b[7],bl7=8191&b7,bh7=b7>>>13,b8=0|b[8],bl8=8191&b8,bh8=b8>>>13,b9=0|b[9],bl9=8191&b9,bh9=b9>>>13;out.length=19,lo=Math.imul(al0,bl0),mid=Math.imul(al0,bh0),mid+=Math.imul(ah0,bl0),hi=Math.imul(ah0,bh0);var w0=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w0>>>26),w0&=67108863,lo=Math.imul(al1,bl0),mid=Math.imul(al1,bh0),mid+=Math.imul(ah1,bl0),hi=Math.imul(ah1,bh0),lo+=Math.imul(al0,bl1),mid+=Math.imul(al0,bh1),mid+=Math.imul(ah0,bl1),hi+=Math.imul(ah0,bh1);var w1=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w1>>>26),w1&=67108863,lo=Math.imul(al2,bl0),mid=Math.imul(al2,bh0),mid+=Math.imul(ah2,bl0),hi=Math.imul(ah2,bh0),lo+=Math.imul(al1,bl1),mid+=Math.imul(al1,bh1),mid+=Math.imul(ah1,bl1),hi+=Math.imul(ah1,bh1),lo+=Math.imul(al0,bl2),mid+=Math.imul(al0,bh2),mid+=Math.imul(ah0,bl2),hi+=Math.imul(ah0,bh2);var w2=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w2>>>26),w2&=67108863,lo=Math.imul(al3,bl0),mid=Math.imul(al3,bh0),mid+=Math.imul(ah3,bl0),hi=Math.imul(ah3,bh0),lo+=Math.imul(al2,bl1),mid+=Math.imul(al2,bh1),mid+=Math.imul(ah2,bl1),hi+=Math.imul(ah2,bh1),lo+=Math.imul(al1,bl2),mid+=Math.imul(al1,bh2),mid+=Math.imul(ah1,bl2),hi+=Math.imul(ah1,bh2),lo+=Math.imul(al0,bl3),mid+=Math.imul(al0,bh3),mid+=Math.imul(ah0,bl3),hi+=Math.imul(ah0,bh3);var w3=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w3>>>26),w3&=67108863,lo=Math.imul(al4,bl0),mid=Math.imul(al4,bh0),mid+=Math.imul(ah4,bl0),hi=Math.imul(ah4,bh0),lo+=Math.imul(al3,bl1),mid+=Math.imul(al3,bh1),mid+=Math.imul(ah3,bl1),hi+=Math.imul(ah3,bh1),lo+=Math.imul(al2,bl2),mid+=Math.imul(al2,bh2),mid+=Math.imul(ah2,bl2),hi+=Math.imul(ah2,bh2),lo+=Math.imul(al1,bl3),mid+=Math.imul(al1,bh3),mid+=Math.imul(ah1,bl3),hi+=Math.imul(ah1,bh3),lo+=Math.imul(al0,bl4),mid+=Math.imul(al0,bh4),mid+=Math.imul(ah0,bl4),hi+=Math.imul(ah0,bh4);var w4=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w4>>>26),w4&=67108863,lo=Math.imul(al5,bl0),mid=Math.imul(al5,bh0),mid+=Math.imul(ah5,bl0),hi=Math.imul(ah5,bh0),lo+=Math.imul(al4,bl1),mid+=Math.imul(al4,bh1),mid+=Math.imul(ah4,bl1),hi+=Math.imul(ah4,bh1),lo+=Math.imul(al3,bl2),mid+=Math.imul(al3,bh2),mid+=Math.imul(ah3,bl2),hi+=Math.imul(ah3,bh2),lo+=Math.imul(al2,bl3),mid+=Math.imul(al2,bh3),mid+=Math.imul(ah2,bl3),hi+=Math.imul(ah2,bh3),lo+=Math.imul(al1,bl4),mid+=Math.imul(al1,bh4),mid+=Math.imul(ah1,bl4),hi+=Math.imul(ah1,bh4),lo+=Math.imul(al0,bl5),mid+=Math.imul(al0,bh5),mid+=Math.imul(ah0,bl5),hi+=Math.imul(ah0,bh5);var w5=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w5>>>26),w5&=67108863,lo=Math.imul(al6,bl0),mid=Math.imul(al6,bh0),mid+=Math.imul(ah6,bl0),hi=Math.imul(ah6,bh0),lo+=Math.imul(al5,bl1),mid+=Math.imul(al5,bh1),mid+=Math.imul(ah5,bl1),hi+=Math.imul(ah5,bh1),lo+=Math.imul(al4,bl2),mid+=Math.imul(al4,bh2),mid+=Math.imul(ah4,bl2),hi+=Math.imul(ah4,bh2),lo+=Math.imul(al3,bl3),mid+=Math.imul(al3,bh3),mid+=Math.imul(ah3,bl3),hi+=Math.imul(ah3,bh3),lo+=Math.imul(al2,bl4),mid+=Math.imul(al2,bh4),mid+=Math.imul(ah2,bl4),hi+=Math.imul(ah2,bh4),lo+=Math.imul(al1,bl5),mid+=Math.imul(al1,bh5),mid+=Math.imul(ah1,bl5),hi+=Math.imul(ah1,bh5),lo+=Math.imul(al0,bl6),mid+=Math.imul(al0,bh6),mid+=Math.imul(ah0,bl6),hi+=Math.imul(ah0,bh6);var w6=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w6>>>26),w6&=67108863,lo=Math.imul(al7,bl0),mid=Math.imul(al7,bh0),mid+=Math.imul(ah7,bl0),hi=Math.imul(ah7,bh0),lo+=Math.imul(al6,bl1),mid+=Math.imul(al6,bh1),mid+=Math.imul(ah6,bl1),hi+=Math.imul(ah6,bh1),lo+=Math.imul(al5,bl2),mid+=Math.imul(al5,bh2),mid+=Math.imul(ah5,bl2),hi+=Math.imul(ah5,bh2),lo+=Math.imul(al4,bl3),mid+=Math.imul(al4,bh3),mid+=Math.imul(ah4,bl3),hi+=Math.imul(ah4,bh3),lo+=Math.imul(al3,bl4),mid+=Math.imul(al3,bh4),mid+=Math.imul(ah3,bl4),hi+=Math.imul(ah3,bh4),lo+=Math.imul(al2,bl5),mid+=Math.imul(al2,bh5),mid+=Math.imul(ah2,bl5),hi+=Math.imul(ah2,bh5),lo+=Math.imul(al1,bl6),mid+=Math.imul(al1,bh6),mid+=Math.imul(ah1,bl6),hi+=Math.imul(ah1,bh6),lo+=Math.imul(al0,bl7),mid+=Math.imul(al0,bh7),mid+=Math.imul(ah0,bl7),hi+=Math.imul(ah0,bh7);var w7=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w7>>>26),w7&=67108863,lo=Math.imul(al8,bl0),mid=Math.imul(al8,bh0),mid+=Math.imul(ah8,bl0),hi=Math.imul(ah8,bh0),lo+=Math.imul(al7,bl1),mid+=Math.imul(al7,bh1),mid+=Math.imul(ah7,bl1),hi+=Math.imul(ah7,bh1),lo+=Math.imul(al6,bl2),mid+=Math.imul(al6,bh2),mid+=Math.imul(ah6,bl2),hi+=Math.imul(ah6,bh2),lo+=Math.imul(al5,bl3),mid+=Math.imul(al5,bh3),mid+=Math.imul(ah5,bl3),hi+=Math.imul(ah5,bh3),lo+=Math.imul(al4,bl4),mid+=Math.imul(al4,bh4),mid+=Math.imul(ah4,bl4),hi+=Math.imul(ah4,bh4),lo+=Math.imul(al3,bl5),mid+=Math.imul(al3,bh5),mid+=Math.imul(ah3,bl5),hi+=Math.imul(ah3,bh5),lo+=Math.imul(al2,bl6),mid+=Math.imul(al2,bh6),mid+=Math.imul(ah2,bl6),hi+=Math.imul(ah2,bh6),lo+=Math.imul(al1,bl7),mid+=Math.imul(al1,bh7),mid+=Math.imul(ah1,bl7),hi+=Math.imul(ah1,bh7),lo+=Math.imul(al0,bl8),mid+=Math.imul(al0,bh8),mid+=Math.imul(ah0,bl8),hi+=Math.imul(ah0,bh8);var w8=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w8>>>26),w8&=67108863,lo=Math.imul(al9,bl0),mid=Math.imul(al9,bh0),mid+=Math.imul(ah9,bl0),hi=Math.imul(ah9,bh0),lo+=Math.imul(al8,bl1),mid+=Math.imul(al8,bh1),mid+=Math.imul(ah8,bl1),hi+=Math.imul(ah8,bh1),lo+=Math.imul(al7,bl2),mid+=Math.imul(al7,bh2),mid+=Math.imul(ah7,bl2),hi+=Math.imul(ah7,bh2),lo+=Math.imul(al6,bl3),mid+=Math.imul(al6,bh3),mid+=Math.imul(ah6,bl3),hi+=Math.imul(ah6,bh3),lo+=Math.imul(al5,bl4),mid+=Math.imul(al5,bh4),mid+=Math.imul(ah5,bl4),hi+=Math.imul(ah5,bh4),lo+=Math.imul(al4,bl5),mid+=Math.imul(al4,bh5),mid+=Math.imul(ah4,bl5),hi+=Math.imul(ah4,bh5),lo+=Math.imul(al3,bl6),mid+=Math.imul(al3,bh6),mid+=Math.imul(ah3,bl6),hi+=Math.imul(ah3,bh6),lo+=Math.imul(al2,bl7),mid+=Math.imul(al2,bh7),mid+=Math.imul(ah2,bl7),hi+=Math.imul(ah2,bh7),lo+=Math.imul(al1,bl8),mid+=Math.imul(al1,bh8),mid+=Math.imul(ah1,bl8),hi+=Math.imul(ah1,bh8),lo+=Math.imul(al0,bl9),mid+=Math.imul(al0,bh9),mid+=Math.imul(ah0,bl9),hi+=Math.imul(ah0,bh9);var w9=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w9>>>26),w9&=67108863,lo=Math.imul(al9,bl1),mid=Math.imul(al9,bh1),mid+=Math.imul(ah9,bl1),hi=Math.imul(ah9,bh1),lo+=Math.imul(al8,bl2),mid+=Math.imul(al8,bh2),mid+=Math.imul(ah8,bl2),hi+=Math.imul(ah8,bh2),lo+=Math.imul(al7,bl3),mid+=Math.imul(al7,bh3),mid+=Math.imul(ah7,bl3),hi+=Math.imul(ah7,bh3),lo+=Math.imul(al6,bl4),mid+=Math.imul(al6,bh4),mid+=Math.imul(ah6,bl4),hi+=Math.imul(ah6,bh4),lo+=Math.imul(al5,bl5),mid+=Math.imul(al5,bh5),mid+=Math.imul(ah5,bl5),hi+=Math.imul(ah5,bh5),lo+=Math.imul(al4,bl6),mid+=Math.imul(al4,bh6),mid+=Math.imul(ah4,bl6),hi+=Math.imul(ah4,bh6),lo+=Math.imul(al3,bl7),mid+=Math.imul(al3,bh7),mid+=Math.imul(ah3,bl7),hi+=Math.imul(ah3,bh7),lo+=Math.imul(al2,bl8),mid+=Math.imul(al2,bh8),mid+=Math.imul(ah2,bl8),hi+=Math.imul(ah2,bh8),lo+=Math.imul(al1,bl9),mid+=Math.imul(al1,bh9),mid+=Math.imul(ah1,bl9),hi+=Math.imul(ah1,bh9);var w10=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w10>>>26),w10&=67108863,lo=Math.imul(al9,bl2),mid=Math.imul(al9,bh2),mid+=Math.imul(ah9,bl2),hi=Math.imul(ah9,bh2),lo+=Math.imul(al8,bl3),mid+=Math.imul(al8,bh3),mid+=Math.imul(ah8,bl3),hi+=Math.imul(ah8,bh3),lo+=Math.imul(al7,bl4),mid+=Math.imul(al7,bh4),mid+=Math.imul(ah7,bl4),hi+=Math.imul(ah7,bh4),lo+=Math.imul(al6,bl5),mid+=Math.imul(al6,bh5),mid+=Math.imul(ah6,bl5),hi+=Math.imul(ah6,bh5),lo+=Math.imul(al5,bl6),mid+=Math.imul(al5,bh6),mid+=Math.imul(ah5,bl6),hi+=Math.imul(ah5,bh6),lo+=Math.imul(al4,bl7),mid+=Math.imul(al4,bh7),mid+=Math.imul(ah4,bl7),hi+=Math.imul(ah4,bh7),lo+=Math.imul(al3,bl8),mid+=Math.imul(al3,bh8),mid+=Math.imul(ah3,bl8),hi+=Math.imul(ah3,bh8),lo+=Math.imul(al2,bl9),mid+=Math.imul(al2,bh9),mid+=Math.imul(ah2,bl9),hi+=Math.imul(ah2,bh9);var w11=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w11>>>26),w11&=67108863,lo=Math.imul(al9,bl3),mid=Math.imul(al9,bh3),mid+=Math.imul(ah9,bl3),hi=Math.imul(ah9,bh3),lo+=Math.imul(al8,bl4),mid+=Math.imul(al8,bh4),mid+=Math.imul(ah8,bl4),hi+=Math.imul(ah8,bh4),lo+=Math.imul(al7,bl5),mid+=Math.imul(al7,bh5),mid+=Math.imul(ah7,bl5),hi+=Math.imul(ah7,bh5),lo+=Math.imul(al6,bl6),mid+=Math.imul(al6,bh6),mid+=Math.imul(ah6,bl6),hi+=Math.imul(ah6,bh6),lo+=Math.imul(al5,bl7),mid+=Math.imul(al5,bh7),mid+=Math.imul(ah5,bl7),hi+=Math.imul(ah5,bh7),lo+=Math.imul(al4,bl8),mid+=Math.imul(al4,bh8),mid+=Math.imul(ah4,bl8),hi+=Math.imul(ah4,bh8),lo+=Math.imul(al3,bl9),mid+=Math.imul(al3,bh9),mid+=Math.imul(ah3,bl9),hi+=Math.imul(ah3,bh9);var w12=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w12>>>26),w12&=67108863,lo=Math.imul(al9,bl4),mid=Math.imul(al9,bh4),mid+=Math.imul(ah9,bl4),hi=Math.imul(ah9,bh4),lo+=Math.imul(al8,bl5),mid+=Math.imul(al8,bh5),mid+=Math.imul(ah8,bl5),hi+=Math.imul(ah8,bh5),lo+=Math.imul(al7,bl6),mid+=Math.imul(al7,bh6),mid+=Math.imul(ah7,bl6),hi+=Math.imul(ah7,bh6),lo+=Math.imul(al6,bl7),mid+=Math.imul(al6,bh7),mid+=Math.imul(ah6,bl7),hi+=Math.imul(ah6,bh7),lo+=Math.imul(al5,bl8),mid+=Math.imul(al5,bh8),mid+=Math.imul(ah5,bl8),hi+=Math.imul(ah5,bh8),lo+=Math.imul(al4,bl9),mid+=Math.imul(al4,bh9),mid+=Math.imul(ah4,bl9),hi+=Math.imul(ah4,bh9);var w13=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w13>>>26),w13&=67108863,lo=Math.imul(al9,bl5),mid=Math.imul(al9,bh5),mid+=Math.imul(ah9,bl5),hi=Math.imul(ah9,bh5),lo+=Math.imul(al8,bl6),mid+=Math.imul(al8,bh6),mid+=Math.imul(ah8,bl6),hi+=Math.imul(ah8,bh6),lo+=Math.imul(al7,bl7),mid+=Math.imul(al7,bh7),mid+=Math.imul(ah7,bl7),hi+=Math.imul(ah7,bh7),lo+=Math.imul(al6,bl8),mid+=Math.imul(al6,bh8),mid+=Math.imul(ah6,bl8),hi+=Math.imul(ah6,bh8),lo+=Math.imul(al5,bl9),mid+=Math.imul(al5,bh9),mid+=Math.imul(ah5,bl9),hi+=Math.imul(ah5,bh9);var w14=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w14>>>26),w14&=67108863,lo=Math.imul(al9,bl6),mid=Math.imul(al9,bh6),mid+=Math.imul(ah9,bl6),hi=Math.imul(ah9,bh6),lo+=Math.imul(al8,bl7),mid+=Math.imul(al8,bh7),mid+=Math.imul(ah8,bl7),hi+=Math.imul(ah8,bh7),lo+=Math.imul(al7,bl8),mid+=Math.imul(al7,bh8),mid+=Math.imul(ah7,bl8),hi+=Math.imul(ah7,bh8),lo+=Math.imul(al6,bl9),mid+=Math.imul(al6,bh9),mid+=Math.imul(ah6,bl9),hi+=Math.imul(ah6,bh9);var w15=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w15>>>26),w15&=67108863,lo=Math.imul(al9,bl7),mid=Math.imul(al9,bh7),mid+=Math.imul(ah9,bl7),hi=Math.imul(ah9,bh7),lo+=Math.imul(al8,bl8),mid+=Math.imul(al8,bh8),mid+=Math.imul(ah8,bl8),hi+=Math.imul(ah8,bh8),lo+=Math.imul(al7,bl9),mid+=Math.imul(al7,bh9),mid+=Math.imul(ah7,bl9),hi+=Math.imul(ah7,bh9);var w16=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w16>>>26),w16&=67108863,lo=Math.imul(al9,bl8),mid=Math.imul(al9,bh8),mid+=Math.imul(ah9,bl8),hi=Math.imul(ah9,bh8),lo+=Math.imul(al8,bl9),mid+=Math.imul(al8,bh9),mid+=Math.imul(ah8,bl9),hi+=Math.imul(ah8,bh9);var w17=c+lo+((8191&mid)<<13);c=hi+(mid>>>13)+(w17>>>26),w17&=67108863,lo=Math.imul(al9,bl9),mid=Math.imul(al9,bh9),mid+=Math.imul(ah9,bl9),hi=Math.imul(ah9,bh9);var w18=c+lo+((8191&mid)<<13);return c=hi+(mid>>>13)+(w18>>>26),w18&=67108863,o[0]=w0,o[1]=w1,o[2]=w2,o[3]=w3,o[4]=w4,o[5]=w5,o[6]=w6,o[7]=w7,o[8]=w8,o[9]=w9,o[10]=w10,o[11]=w11,o[12]=w12,o[13]=w13,o[14]=w14,o[15]=w15,o[16]=w16,o[17]=w17,o[18]=w18,0!==c&&(o[19]=c,out.length++),out}},{}],331:[function(require,module,exports){"use strict";function ECJPoint(x,y,z){null===x&&null===y&&null===z?(this.x=ECJPoint.one,this.y=ECJPoint.one,this.z=ECJPoint.zero):(this.x=x,this.y=y,this.z=z),this.zOne=this.z===ECJPoint.one}var BN=require("./bn");ECJPoint.zero=BN.fromNumber(0),ECJPoint.one=BN.fromNumber(1),ECJPoint.prototype.neg=function(){return this.inf?this:new ECJPoint(this.x,this.y.redNeg(),this.z)},ECJPoint.prototype.add=function(p){if(this.inf)return p;if(p.inf)return this;var pz2=p.z.redSqr(),z2=this.z.redSqr(),u1=this.x.redMul(pz2),u2=p.x.redMul(z2),s1=this.y.redMul(pz2).redMul(p.z),s2=p.y.redMul(z2).redMul(this.z),h=u1.redSub(u2),r=s1.redSub(s2);if(h.isZero())return r.isZero()?this.dbl():new ECJPoint(null,null,null);var h2=h.redSqr(),v=u1.redMul(h2),h3=h2.redMul(h),nx=r.redSqr().redIAdd(h3).redISub(v).redISub(v),ny=r.redMul(v.redISub(nx)).redISub(s1.redMul(h3)),nz=this.z.redMul(p.z).redMul(h);return new ECJPoint(nx,ny,nz)},ECJPoint.prototype.mixedAdd=function(p){if(this.inf)return p.toECJPoint();if(p.inf)return this;var z2=this.z.redSqr(),u1=this.x,u2=p.x.redMul(z2),s1=this.y,s2=p.y.redMul(z2).redMul(this.z),h=u1.redSub(u2),r=s1.redSub(s2);if(h.isZero())return r.isZero()?this.dbl():new ECJPoint(null,null,null);var h2=h.redSqr(),v=u1.redMul(h2),h3=h2.redMul(h),nx=r.redSqr().redIAdd(h3).redISub(v).redISub(v),ny=r.redMul(v.redISub(nx)).redISub(s1.redMul(h3)),nz=this.z.redMul(h);return new ECJPoint(nx,ny,nz)},ECJPoint.prototype.dbl=function(){if(this.inf)return this;var nx,ny,nz;if(this.zOne){var xx=this.x.redSqr(),yy=this.y.redSqr(),yyyy=yy.redSqr(),s=this.x.redAdd(yy).redSqr().redISub(xx).redISub(yyyy);s=s.redIAdd(s);var m=xx.redAdd(xx).redIAdd(xx),t=m.redSqr().redISub(s).redISub(s),yyyy8=yyyy.redIAdd(yyyy).redIAdd(yyyy).redIAdd(yyyy);nx=t,ny=m.redMul(s.redISub(t)).redISub(yyyy8),nz=this.y.redAdd(this.y)}else{var a=this.x.redSqr(),b=this.y.redSqr(),c=b.redSqr(),d=this.x.redAdd(b).redSqr().redISub(a).redISub(c);d=d.redIAdd(d);var e=a.redAdd(a).redIAdd(a),f=e.redSqr(),c8=c.redIAdd(c).redIAdd(c).redIAdd(c);nx=f.redISub(d).redISub(d),ny=e.redMul(d.redISub(nx)).redISub(c8),nz=this.y.redMul(this.z),nz=nz.redIAdd(nz)}return new ECJPoint(nx,ny,nz)},ECJPoint.prototype.dblp=function(pow){if(0===pow||this.inf)return this;for(var point=this,i=0;i<pow;i++)point=point.dbl();return point},Object.defineProperty(ECJPoint.prototype,"inf",{enumerable:!0,get:function(){return this.z.isZero()}}),module.exports=ECJPoint},{"./bn":329}],332:[function(require,module,exports){"use strict";function ECPoint(x,y){null===x&&null===y?(this.x=this.y=null,this.inf=!0):(this.x=x,this.y=y,this.inf=!1)}var Buffer=require("safe-buffer").Buffer,BN=require("./bn"),ECJPoint=require("./ecjpoint");ECPoint.fromPublicKey=function(publicKey){var x,y,first=publicKey[0];return 33!==publicKey.length||2!==first&&3!==first?65!==publicKey.length||4!==first&&6!==first&&7!==first?null:(x=BN.fromBuffer(publicKey.slice(1,33)),y=BN.fromBuffer(publicKey.slice(33,65)),x.ucmp(BN.p)>=0||y.ucmp(BN.p)>=0?null:6!==first&&7!==first||y.isOdd()===(7===first)?0!==x.redSqr().redMul(x).redIAdd7().ucmp(y.redSqr())?null:new ECPoint(x,y):null):(x=BN.fromBuffer(publicKey.slice(1,33)),x.ucmp(BN.p)>=0?null:(y=x.redSqr().redMul(x).redIAdd7().redSqrt(),null===y?null:(3===first!==y.isOdd()&&(y=y.redNeg()),new ECPoint(x,y))))},ECPoint.prototype.toPublicKey=function(compressed){var publicKey,x=this.x,y=this.y;return compressed?(publicKey=Buffer.alloc(33),publicKey[0]=y.isOdd()?3:2,x.toBuffer().copy(publicKey,1)):(publicKey=Buffer.alloc(65),publicKey[0]=4,x.toBuffer().copy(publicKey,1),y.toBuffer().copy(publicKey,33)),publicKey},ECPoint.fromECJPoint=function(p){if(p.inf)return new ECPoint(null,null);var zinv=p.z.redInvm(),zinv2=zinv.redSqr(),ax=p.x.redMul(zinv2),ay=p.y.redMul(zinv2).redMul(zinv);return new ECPoint(ax,ay)},ECPoint.prototype.toECJPoint=function(){return this.inf?new ECJPoint(null,null,null):new ECJPoint(this.x,this.y,ECJPoint.one)},ECPoint.prototype.neg=function(){return this.inf?this:new ECPoint(this.x,this.y.redNeg())},ECPoint.prototype.add=function(p){if(this.inf)return p;if(p.inf)return this;if(0===this.x.ucmp(p.x))return 0===this.y.ucmp(p.y)?this.dbl():new ECPoint(null,null);var s=this.y.redSub(p.y);s.isZero()||(s=s.redMul(this.x.redSub(p.x).redInvm()));var nx=s.redSqr().redISub(this.x).redISub(p.x),ny=s.redMul(this.x.redSub(nx)).redISub(this.y);return new ECPoint(nx,ny)},ECPoint.prototype.dbl=function(){if(this.inf)return this;var yy=this.y.redAdd(this.y);if(yy.isZero())return new ECPoint(null,null);var x2=this.x.redSqr(),s=x2.redAdd(x2).redIAdd(x2).redMul(yy.redInvm()),nx=s.redSqr().redISub(this.x.redAdd(this.x)),ny=s.redMul(this.x.redSub(nx)).redISub(this.y);return new ECPoint(nx,ny)},ECPoint.prototype.mul=function(num){for(var nafPoints=this._getNAFPoints(4),points=nafPoints.points,naf=num.getNAF(nafPoints.wnd),acc=new ECJPoint(null,null,null),i=naf.length-1;i>=0;i--){for(var k=0;i>=0&&0===naf[i];i--,++k);if(i>=0&&(k+=1),acc=acc.dblp(k),i<0)break;var z=naf[i];acc=z>0?acc.mixedAdd(points[z-1>>1]):acc.mixedAdd(points[-z-1>>1].neg())}return ECPoint.fromECJPoint(acc)},ECPoint.prototype._getNAFPoints1=function(){return{wnd:1,points:[this]}},ECPoint.prototype._getNAFPoints=function(wnd){var points=new Array((1<<wnd)-1);points[0]=this;for(var dbl=this.dbl(),i=1;i<points.length;++i)points[i]=points[i-1].add(dbl);return{wnd:wnd,points:points}},module.exports=ECPoint},{"./bn":329,"./ecjpoint":331,"safe-buffer":323}],333:[function(require,module,exports){"use strict";function ECPointG(){this.x=BN.fromBuffer(Buffer.from("79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798","hex")),this.y=BN.fromBuffer(Buffer.from("483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8","hex")),this.inf=!1,this._precompute()}var Buffer=require("safe-buffer").Buffer,BN=require("./bn"),ECPoint=require("./ecpoint"),ECJPoint=require("./ecjpoint");ECPointG.prototype._precompute=function(){for(var ecpoint=new ECPoint(this.x,this.y),dstep=4,points=new Array(1+Math.ceil(257/dstep)),acc=points[0]=ecpoint,i=1;i<points.length;++i){for(var j=0;j<dstep;j++)acc=acc.dbl();points[i]=acc}this.precomputed={naf:ecpoint._getNAFPoints(7),doubles:{step:dstep,points:points,negpoints:points.map(function(p){return p.neg()})}}},ECPointG.prototype.mul=function(num){for(var step=this.precomputed.doubles.step,points=this.precomputed.doubles.points,negpoints=this.precomputed.doubles.negpoints,naf=num.getNAF(1),I=((1<<step+1)-(step%2===0?2:1))/3,repr=[],j=0;j<naf.length;j+=step){for(var nafW=0,k=j+step-1;k>=j;k--)nafW=(nafW<<1)+naf[k];repr.push(nafW)}for(var a=new ECJPoint(null,null,null),b=new ECJPoint(null,null,null),i=I;i>0;i--){for(var jj=0;jj<repr.length;jj++)repr[jj]===i?b=b.mixedAdd(points[jj]):repr[jj]===-i&&(b=b.mixedAdd(negpoints[jj]));a=a.add(b)}return ECPoint.fromECJPoint(a)},ECPointG.prototype.mulAdd=function(k1,p2,k2){for(var nafPointsP1=this.precomputed.naf,nafPointsP2=p2._getNAFPoints1(),wnd=[nafPointsP1.points,nafPointsP2.points],naf=[k1.getNAF(nafPointsP1.wnd),k2.getNAF(nafPointsP2.wnd)],acc=new ECJPoint(null,null,null),tmp=[null,null],i=Math.max(naf[0].length,naf[1].length);i>=0;i--){for(var k=0;i>=0&&(tmp[0]=0|naf[0][i],tmp[1]=0|naf[1][i],0===tmp[0]&&0===tmp[1]);++k,--i);if(i>=0&&(k+=1),acc=acc.dblp(k),i<0)break;for(var jj=0;jj<2;jj++){var p,z=tmp[jj];0!==z&&(z>0?p=wnd[jj][z>>1]:z<0&&(p=wnd[jj][-z>>1].neg()),acc=void 0===p.z?acc.mixedAdd(p):acc.add(p))}}return acc},module.exports=new ECPointG},{"./bn":329,"./ecjpoint":331,"./ecpoint":332,"safe-buffer":323}],334:[function(require,module,exports){"use strict";var Buffer=require("safe-buffer").Buffer,createHash=require("create-hash"),HmacDRBG=require("drbg.js/hmac"),messages=require("../messages.json"),BN=require("./bn"),ECPoint=require("./ecpoint"),g=require("./ecpointg");exports.privateKeyVerify=function(privateKey){var bn=BN.fromBuffer(privateKey);return!(bn.isOverflow()||bn.isZero())},exports.privateKeyExport=function(privateKey,compressed){var d=BN.fromBuffer(privateKey);if(d.isOverflow()||d.isZero())throw new Error(messages.EC_PRIVATE_KEY_EXPORT_DER_FAIL);return g.mul(d).toPublicKey(compressed)},exports.privateKeyNegate=function(privateKey){var bn=BN.fromBuffer(privateKey);return bn.isZero()?Buffer.alloc(32):(bn.ucmp(BN.n)>0&&bn.isub(BN.n),BN.n.sub(bn).toBuffer())},exports.privateKeyModInverse=function(privateKey){var bn=BN.fromBuffer(privateKey);if(bn.isOverflow()||bn.isZero())throw new Error(messages.EC_PRIVATE_KEY_RANGE_INVALID);return bn.uinvm().toBuffer()},exports.privateKeyTweakAdd=function(privateKey,tweak){var bn=BN.fromBuffer(tweak);if(bn.isOverflow())throw new Error(messages.EC_PRIVATE_KEY_TWEAK_ADD_FAIL);if(bn.iadd(BN.fromBuffer(privateKey)),bn.isOverflow()&&bn.isub(BN.n),bn.isZero())throw new Error(messages.EC_PRIVATE_KEY_TWEAK_ADD_FAIL);return bn.toBuffer()},exports.privateKeyTweakMul=function(privateKey,tweak){var bn=BN.fromBuffer(tweak);if(bn.isOverflow()||bn.isZero())throw new Error(messages.EC_PRIVATE_KEY_TWEAK_MUL_FAIL);var d=BN.fromBuffer(privateKey);return bn.umul(d).ureduce().toBuffer()},exports.publicKeyCreate=function(privateKey,compressed){var d=BN.fromBuffer(privateKey);if(d.isOverflow()||d.isZero())throw new Error(messages.EC_PUBLIC_KEY_CREATE_FAIL);return g.mul(d).toPublicKey(compressed)},exports.publicKeyConvert=function(publicKey,compressed){var point=ECPoint.fromPublicKey(publicKey);if(null===point)throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);return point.toPublicKey(compressed)},exports.publicKeyVerify=function(publicKey){return null!==ECPoint.fromPublicKey(publicKey)},exports.publicKeyTweakAdd=function(publicKey,tweak,compressed){var point=ECPoint.fromPublicKey(publicKey);if(null===point)throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);if(tweak=BN.fromBuffer(tweak),tweak.isOverflow())throw new Error(messages.EC_PUBLIC_KEY_TWEAK_ADD_FAIL);return g.mul(tweak).add(point).toPublicKey(compressed)},exports.publicKeyTweakMul=function(publicKey,tweak,compressed){var point=ECPoint.fromPublicKey(publicKey);if(null===point)throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);if(tweak=BN.fromBuffer(tweak),tweak.isOverflow()||tweak.isZero())throw new Error(messages.EC_PUBLIC_KEY_TWEAK_MUL_FAIL);return point.mul(tweak).toPublicKey(compressed)},exports.publicKeyCombine=function(publicKeys,compressed){for(var points=new Array(publicKeys.length),i=0;i<publicKeys.length;++i)if(points[i]=ECPoint.fromPublicKey(publicKeys[i]),null===points[i])throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);for(var point=points[0],j=1;j<points.length;++j)point=point.add(points[j]);if(point.inf)throw new Error(messages.EC_PUBLIC_KEY_COMBINE_FAIL);return point.toPublicKey(compressed)},exports.signatureNormalize=function(signature){var r=BN.fromBuffer(signature.slice(0,32)),s=BN.fromBuffer(signature.slice(32,64));if(r.isOverflow()||s.isOverflow())throw new Error(messages.ECDSA_SIGNATURE_PARSE_FAIL);var result=Buffer.from(signature);return s.isHigh()&&BN.n.sub(s).toBuffer().copy(result,32),result},exports.signatureExport=function(signature){var r=signature.slice(0,32),s=signature.slice(32,64);if(BN.fromBuffer(r).isOverflow()||BN.fromBuffer(s).isOverflow())throw new Error(messages.ECDSA_SIGNATURE_PARSE_FAIL);return{r:r,s:s}},exports.signatureImport=function(sigObj){var r=BN.fromBuffer(sigObj.r);r.isOverflow()&&(r=BN.fromNumber(0));var s=BN.fromBuffer(sigObj.s);return s.isOverflow()&&(s=BN.fromNumber(0)),Buffer.concat([r.toBuffer(),s.toBuffer()])},exports.sign=function(message,privateKey,noncefn,data){var d=BN.fromBuffer(privateKey);if(d.isOverflow()||d.isZero())throw new Error(messages.ECDSA_SIGN_FAIL);if(null===noncefn){var drbg=new HmacDRBG("sha256",privateKey,message,data);noncefn=function(){return drbg.generate(32)}}for(var bnMessage=BN.fromBuffer(message),count=0;;++count){var nonce=noncefn(message,privateKey,null,data,count);if(!Buffer.isBuffer(nonce)||32!==nonce.length)throw new Error(messages.ECDSA_SIGN_FAIL);var k=BN.fromBuffer(nonce);if(!k.isOverflow()&&!k.isZero()){var kp=g.mul(k),r=kp.x.fireduce();if(!r.isZero()){var s=k.uinvm().umul(r.umul(d).ureduce().iadd(bnMessage).fireduce()).ureduce();if(!s.isZero()){var recovery=(0!==kp.x.ucmp(r)?2:0)|(kp.y.isOdd()?1:0);return s.isHigh()&&(s=BN.n.sub(s),recovery^=1),{signature:Buffer.concat([r.toBuffer(),s.toBuffer()]),recovery:recovery}}}}}},exports.verify=function(message,signature,publicKey){var sigr=BN.fromBuffer(signature.slice(0,32)),sigs=BN.fromBuffer(signature.slice(32,64));if(sigr.isOverflow()||sigs.isOverflow())throw new Error(messages.ECDSA_SIGNATURE_PARSE_FAIL);if(sigs.isHigh()||sigr.isZero()||sigs.isZero())return!1;var pub=ECPoint.fromPublicKey(publicKey);if(null===pub)throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);var sinv=sigs.uinvm(),u1=sinv.umul(BN.fromBuffer(message)).ureduce(),u2=sinv.umul(sigr).ureduce(),point=g.mulAdd(u1,pub,u2);if(point.inf)return!1;var z2=point.z.redSqr();return 0===sigr.redMul(z2).ucmp(point.x)||!(sigr.ucmp(BN.psn)>=0)&&0===sigr.iadd(BN.psn).redMul(z2).ucmp(point.x)},exports.recover=function(message,signature,recovery,compressed){var sigr=BN.fromBuffer(signature.slice(0,32)),sigs=BN.fromBuffer(signature.slice(32,64));if(sigr.isOverflow()||sigs.isOverflow())throw new Error(messages.ECDSA_SIGNATURE_PARSE_FAIL);do{if(sigr.isZero()||sigs.isZero())break;var kpx=sigr;if(recovery>>1){if(kpx.ucmp(BN.psn)>=0)break;kpx=sigr.add(BN.n)}var kpPublicKey=Buffer.concat([Buffer.from([2+(1&recovery)]),kpx.toBuffer()]),kp=ECPoint.fromPublicKey(kpPublicKey);if(null===kp)break;var rInv=sigr.uinvm(),s1=BN.n.sub(BN.fromBuffer(message)).umul(rInv).ureduce(),s2=sigs.umul(rInv).ureduce(),point=ECPoint.fromECJPoint(g.mulAdd(s1,kp,s2));return point.toPublicKey(compressed)}while(!1);throw new Error(messages.ECDSA_RECOVER_FAIL)},exports.ecdh=function(publicKey,privateKey){var shared=exports.ecdhUnsafe(publicKey,privateKey,!0);return createHash("sha256").update(shared).digest()},exports.ecdhUnsafe=function(publicKey,privateKey,compressed){var point=ECPoint.fromPublicKey(publicKey);if(null===point)throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);var scalar=BN.fromBuffer(privateKey);if(scalar.isOverflow()||scalar.isZero())throw new Error(messages.ECDH_FAIL);return point.mul(scalar).toPublicKey(compressed)}},{"../messages.json":335,"./bn":329,"./ecpoint":332,"./ecpointg":333,"create-hash":177,"drbg.js/hmac":192,"safe-buffer":323}],335:[function(require,module,exports){module.exports={COMPRESSED_TYPE_INVALID:"compressed should be a boolean",EC_PRIVATE_KEY_TYPE_INVALID:"private key should be a Buffer",EC_PRIVATE_KEY_LENGTH_INVALID:"private key length is invalid",EC_PRIVATE_KEY_RANGE_INVALID:"private key range is invalid",EC_PRIVATE_KEY_TWEAK_ADD_FAIL:"tweak out of range or resulting private key is invalid",EC_PRIVATE_KEY_TWEAK_MUL_FAIL:"tweak out of range",EC_PRIVATE_KEY_EXPORT_DER_FAIL:"couldn't export to DER format",EC_PRIVATE_KEY_IMPORT_DER_FAIL:"couldn't import from DER format",EC_PUBLIC_KEYS_TYPE_INVALID:"public keys should be an Array",EC_PUBLIC_KEYS_LENGTH_INVALID:"public keys Array should have at least 1 element",EC_PUBLIC_KEY_TYPE_INVALID:"public key should be a Buffer",EC_PUBLIC_KEY_LENGTH_INVALID:"public key length is invalid",EC_PUBLIC_KEY_PARSE_FAIL:"the public key could not be parsed or is invalid",EC_PUBLIC_KEY_CREATE_FAIL:"private was invalid, try again",EC_PUBLIC_KEY_TWEAK_ADD_FAIL:"tweak out of range or resulting public key is invalid",EC_PUBLIC_KEY_TWEAK_MUL_FAIL:"tweak out of range",EC_PUBLIC_KEY_COMBINE_FAIL:"the sum of the public keys is not valid",ECDH_FAIL:"scalar was invalid (zero or overflow)",ECDSA_SIGNATURE_TYPE_INVALID:"signature should be a Buffer",ECDSA_SIGNATURE_LENGTH_INVALID:"signature length is invalid",ECDSA_SIGNATURE_PARSE_FAIL:"couldn't parse signature",ECDSA_SIGNATURE_PARSE_DER_FAIL:"couldn't parse DER signature",ECDSA_SIGNATURE_SERIALIZE_DER_FAIL:"couldn't serialize signature to DER format",ECDSA_SIGN_FAIL:"nonce generation function failed or private key is invalid",ECDSA_RECOVER_FAIL:"couldn't recover public key from signature",MSG32_TYPE_INVALID:"message should be a Buffer",MSG32_LENGTH_INVALID:"message length is invalid",OPTIONS_TYPE_INVALID:"options should be an Object",OPTIONS_DATA_TYPE_INVALID:"options.data should be a Buffer",OPTIONS_DATA_LENGTH_INVALID:"options.data length is invalid",OPTIONS_NONCEFN_TYPE_INVALID:"options.noncefn should be a Function",RECOVERY_ID_TYPE_INVALID:"recovery should be a Number",RECOVERY_ID_VALUE_INVALID:"recovery should have value between -1 and 4",TWEAK_TYPE_INVALID:"tweak should be a Buffer",TWEAK_LENGTH_INVALID:"tweak length is invalid"}},{}],336:[function(require,module,exports){function Hash(blockSize,finalSize){this._block=Buffer.alloc(blockSize),this._finalSize=finalSize,this._blockSize=blockSize,this._len=0}var Buffer=require("safe-buffer").Buffer;Hash.prototype.update=function(data,enc){"string"==typeof data&&(enc=enc||"utf8",data=Buffer.from(data,enc));for(var block=this._block,blockSize=this._blockSize,length=data.length,accum=this._len,offset=0;offset<length;){for(var assigned=accum%blockSize,remainder=Math.min(length-offset,blockSize-assigned),i=0;i<remainder;i++)block[assigned+i]=data[offset+i];
accum+=remainder,offset+=remainder,accum%blockSize===0&&this._update(block)}return this._len+=length,this},Hash.prototype.digest=function(enc){var rem=this._len%this._blockSize;this._block[rem]=128,this._block.fill(0,rem+1),rem>=this._finalSize&&(this._update(this._block),this._block.fill(0));var bits=8*this._len;if(bits<=4294967295)this._block.writeUInt32BE(bits,this._blockSize-4);else{var lowBits=(4294967295&bits)>>>0,highBits=(bits-lowBits)/4294967296;this._block.writeUInt32BE(highBits,this._blockSize-8),this._block.writeUInt32BE(lowBits,this._blockSize-4)}this._update(this._block);var hash=this._hash();return enc?hash.toString(enc):hash},Hash.prototype._update=function(){throw new Error("_update must be implemented by subclass")},module.exports=Hash},{"safe-buffer":323}],337:[function(require,module,exports){var exports=module.exports=function(algorithm){algorithm=algorithm.toLowerCase();var Algorithm=exports[algorithm];if(!Algorithm)throw new Error(algorithm+" is not supported (we accept pull requests)");return new Algorithm};exports.sha=require("./sha"),exports.sha1=require("./sha1"),exports.sha224=require("./sha224"),exports.sha256=require("./sha256"),exports.sha384=require("./sha384"),exports.sha512=require("./sha512")},{"./sha":338,"./sha1":339,"./sha224":340,"./sha256":341,"./sha384":342,"./sha512":343}],338:[function(require,module,exports){function Sha(){this.init(),this._w=W,Hash.call(this,64,56)}function rotl5(num){return num<<5|num>>>27}function rotl30(num){return num<<30|num>>>2}function ft(s,b,c,d){return 0===s?b&c|~b&d:2===s?b&c|b&d|c&d:b^c^d}var inherits=require("inherits"),Hash=require("./hash"),Buffer=require("safe-buffer").Buffer,K=[1518500249,1859775393,-1894007588,-899497514],W=new Array(80);inherits(Sha,Hash),Sha.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this},Sha.prototype._update=function(M){for(var W=this._w,a=0|this._a,b=0|this._b,c=0|this._c,d=0|this._d,e=0|this._e,i=0;i<16;++i)W[i]=M.readInt32BE(4*i);for(;i<80;++i)W[i]=W[i-3]^W[i-8]^W[i-14]^W[i-16];for(var j=0;j<80;++j){var s=~~(j/20),t=rotl5(a)+ft(s,b,c,d)+e+W[j]+K[s]|0;e=d,d=c,c=rotl30(b),b=a,a=t}this._a=a+this._a|0,this._b=b+this._b|0,this._c=c+this._c|0,this._d=d+this._d|0,this._e=e+this._e|0},Sha.prototype._hash=function(){var H=Buffer.allocUnsafe(20);return H.writeInt32BE(0|this._a,0),H.writeInt32BE(0|this._b,4),H.writeInt32BE(0|this._c,8),H.writeInt32BE(0|this._d,12),H.writeInt32BE(0|this._e,16),H},module.exports=Sha},{"./hash":336,inherits:233,"safe-buffer":323}],339:[function(require,module,exports){function Sha1(){this.init(),this._w=W,Hash.call(this,64,56)}function rotl1(num){return num<<1|num>>>31}function rotl5(num){return num<<5|num>>>27}function rotl30(num){return num<<30|num>>>2}function ft(s,b,c,d){return 0===s?b&c|~b&d:2===s?b&c|b&d|c&d:b^c^d}var inherits=require("inherits"),Hash=require("./hash"),Buffer=require("safe-buffer").Buffer,K=[1518500249,1859775393,-1894007588,-899497514],W=new Array(80);inherits(Sha1,Hash),Sha1.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this},Sha1.prototype._update=function(M){for(var W=this._w,a=0|this._a,b=0|this._b,c=0|this._c,d=0|this._d,e=0|this._e,i=0;i<16;++i)W[i]=M.readInt32BE(4*i);for(;i<80;++i)W[i]=rotl1(W[i-3]^W[i-8]^W[i-14]^W[i-16]);for(var j=0;j<80;++j){var s=~~(j/20),t=rotl5(a)+ft(s,b,c,d)+e+W[j]+K[s]|0;e=d,d=c,c=rotl30(b),b=a,a=t}this._a=a+this._a|0,this._b=b+this._b|0,this._c=c+this._c|0,this._d=d+this._d|0,this._e=e+this._e|0},Sha1.prototype._hash=function(){var H=Buffer.allocUnsafe(20);return H.writeInt32BE(0|this._a,0),H.writeInt32BE(0|this._b,4),H.writeInt32BE(0|this._c,8),H.writeInt32BE(0|this._d,12),H.writeInt32BE(0|this._e,16),H},module.exports=Sha1},{"./hash":336,inherits:233,"safe-buffer":323}],340:[function(require,module,exports){function Sha224(){this.init(),this._w=W,Hash.call(this,64,56)}var inherits=require("inherits"),Sha256=require("./sha256"),Hash=require("./hash"),Buffer=require("safe-buffer").Buffer,W=new Array(64);inherits(Sha224,Sha256),Sha224.prototype.init=function(){return this._a=3238371032,this._b=914150663,this._c=812702999,this._d=4144912697,this._e=4290775857,this._f=1750603025,this._g=1694076839,this._h=3204075428,this},Sha224.prototype._hash=function(){var H=Buffer.allocUnsafe(28);return H.writeInt32BE(this._a,0),H.writeInt32BE(this._b,4),H.writeInt32BE(this._c,8),H.writeInt32BE(this._d,12),H.writeInt32BE(this._e,16),H.writeInt32BE(this._f,20),H.writeInt32BE(this._g,24),H},module.exports=Sha224},{"./hash":336,"./sha256":341,inherits:233,"safe-buffer":323}],341:[function(require,module,exports){function Sha256(){this.init(),this._w=W,Hash.call(this,64,56)}function ch(x,y,z){return z^x&(y^z)}function maj(x,y,z){return x&y|z&(x|y)}function sigma0(x){return(x>>>2|x<<30)^(x>>>13|x<<19)^(x>>>22|x<<10)}function sigma1(x){return(x>>>6|x<<26)^(x>>>11|x<<21)^(x>>>25|x<<7)}function gamma0(x){return(x>>>7|x<<25)^(x>>>18|x<<14)^x>>>3}function gamma1(x){return(x>>>17|x<<15)^(x>>>19|x<<13)^x>>>10}var inherits=require("inherits"),Hash=require("./hash"),Buffer=require("safe-buffer").Buffer,K=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],W=new Array(64);inherits(Sha256,Hash),Sha256.prototype.init=function(){return this._a=1779033703,this._b=3144134277,this._c=1013904242,this._d=2773480762,this._e=1359893119,this._f=2600822924,this._g=528734635,this._h=1541459225,this},Sha256.prototype._update=function(M){for(var W=this._w,a=0|this._a,b=0|this._b,c=0|this._c,d=0|this._d,e=0|this._e,f=0|this._f,g=0|this._g,h=0|this._h,i=0;i<16;++i)W[i]=M.readInt32BE(4*i);for(;i<64;++i)W[i]=gamma1(W[i-2])+W[i-7]+gamma0(W[i-15])+W[i-16]|0;for(var j=0;j<64;++j){var T1=h+sigma1(e)+ch(e,f,g)+K[j]+W[j]|0,T2=sigma0(a)+maj(a,b,c)|0;h=g,g=f,f=e,e=d+T1|0,d=c,c=b,b=a,a=T1+T2|0}this._a=a+this._a|0,this._b=b+this._b|0,this._c=c+this._c|0,this._d=d+this._d|0,this._e=e+this._e|0,this._f=f+this._f|0,this._g=g+this._g|0,this._h=h+this._h|0},Sha256.prototype._hash=function(){var H=Buffer.allocUnsafe(32);return H.writeInt32BE(this._a,0),H.writeInt32BE(this._b,4),H.writeInt32BE(this._c,8),H.writeInt32BE(this._d,12),H.writeInt32BE(this._e,16),H.writeInt32BE(this._f,20),H.writeInt32BE(this._g,24),H.writeInt32BE(this._h,28),H},module.exports=Sha256},{"./hash":336,inherits:233,"safe-buffer":323}],342:[function(require,module,exports){function Sha384(){this.init(),this._w=W,Hash.call(this,128,112)}var inherits=require("inherits"),SHA512=require("./sha512"),Hash=require("./hash"),Buffer=require("safe-buffer").Buffer,W=new Array(160);inherits(Sha384,SHA512),Sha384.prototype.init=function(){return this._ah=3418070365,this._bh=1654270250,this._ch=2438529370,this._dh=355462360,this._eh=1731405415,this._fh=2394180231,this._gh=3675008525,this._hh=1203062813,this._al=3238371032,this._bl=914150663,this._cl=812702999,this._dl=4144912697,this._el=4290775857,this._fl=1750603025,this._gl=1694076839,this._hl=3204075428,this},Sha384.prototype._hash=function(){function writeInt64BE(h,l,offset){H.writeInt32BE(h,offset),H.writeInt32BE(l,offset+4)}var H=Buffer.allocUnsafe(48);return writeInt64BE(this._ah,this._al,0),writeInt64BE(this._bh,this._bl,8),writeInt64BE(this._ch,this._cl,16),writeInt64BE(this._dh,this._dl,24),writeInt64BE(this._eh,this._el,32),writeInt64BE(this._fh,this._fl,40),H},module.exports=Sha384},{"./hash":336,"./sha512":343,inherits:233,"safe-buffer":323}],343:[function(require,module,exports){function Sha512(){this.init(),this._w=W,Hash.call(this,128,112)}function Ch(x,y,z){return z^x&(y^z)}function maj(x,y,z){return x&y|z&(x|y)}function sigma0(x,xl){return(x>>>28|xl<<4)^(xl>>>2|x<<30)^(xl>>>7|x<<25)}function sigma1(x,xl){return(x>>>14|xl<<18)^(x>>>18|xl<<14)^(xl>>>9|x<<23)}function Gamma0(x,xl){return(x>>>1|xl<<31)^(x>>>8|xl<<24)^x>>>7}function Gamma0l(x,xl){return(x>>>1|xl<<31)^(x>>>8|xl<<24)^(x>>>7|xl<<25)}function Gamma1(x,xl){return(x>>>19|xl<<13)^(xl>>>29|x<<3)^x>>>6}function Gamma1l(x,xl){return(x>>>19|xl<<13)^(xl>>>29|x<<3)^(x>>>6|xl<<26)}function getCarry(a,b){return a>>>0<b>>>0?1:0}var inherits=require("inherits"),Hash=require("./hash"),Buffer=require("safe-buffer").Buffer,K=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591],W=new Array(160);inherits(Sha512,Hash),Sha512.prototype.init=function(){return this._ah=1779033703,this._bh=3144134277,this._ch=1013904242,this._dh=2773480762,this._eh=1359893119,this._fh=2600822924,this._gh=528734635,this._hh=1541459225,this._al=4089235720,this._bl=2227873595,this._cl=4271175723,this._dl=1595750129,this._el=2917565137,this._fl=725511199,this._gl=4215389547,this._hl=327033209,this},Sha512.prototype._update=function(M){for(var W=this._w,ah=0|this._ah,bh=0|this._bh,ch=0|this._ch,dh=0|this._dh,eh=0|this._eh,fh=0|this._fh,gh=0|this._gh,hh=0|this._hh,al=0|this._al,bl=0|this._bl,cl=0|this._cl,dl=0|this._dl,el=0|this._el,fl=0|this._fl,gl=0|this._gl,hl=0|this._hl,i=0;i<32;i+=2)W[i]=M.readInt32BE(4*i),W[i+1]=M.readInt32BE(4*i+4);for(;i<160;i+=2){var xh=W[i-30],xl=W[i-30+1],gamma0=Gamma0(xh,xl),gamma0l=Gamma0l(xl,xh);xh=W[i-4],xl=W[i-4+1];var gamma1=Gamma1(xh,xl),gamma1l=Gamma1l(xl,xh),Wi7h=W[i-14],Wi7l=W[i-14+1],Wi16h=W[i-32],Wi16l=W[i-32+1],Wil=gamma0l+Wi7l|0,Wih=gamma0+Wi7h+getCarry(Wil,gamma0l)|0;Wil=Wil+gamma1l|0,Wih=Wih+gamma1+getCarry(Wil,gamma1l)|0,Wil=Wil+Wi16l|0,Wih=Wih+Wi16h+getCarry(Wil,Wi16l)|0,W[i]=Wih,W[i+1]=Wil}for(var j=0;j<160;j+=2){Wih=W[j],Wil=W[j+1];var majh=maj(ah,bh,ch),majl=maj(al,bl,cl),sigma0h=sigma0(ah,al),sigma0l=sigma0(al,ah),sigma1h=sigma1(eh,el),sigma1l=sigma1(el,eh),Kih=K[j],Kil=K[j+1],chh=Ch(eh,fh,gh),chl=Ch(el,fl,gl),t1l=hl+sigma1l|0,t1h=hh+sigma1h+getCarry(t1l,hl)|0;t1l=t1l+chl|0,t1h=t1h+chh+getCarry(t1l,chl)|0,t1l=t1l+Kil|0,t1h=t1h+Kih+getCarry(t1l,Kil)|0,t1l=t1l+Wil|0,t1h=t1h+Wih+getCarry(t1l,Wil)|0;var t2l=sigma0l+majl|0,t2h=sigma0h+majh+getCarry(t2l,sigma0l)|0;hh=gh,hl=gl,gh=fh,gl=fl,fh=eh,fl=el,el=dl+t1l|0,eh=dh+t1h+getCarry(el,dl)|0,dh=ch,dl=cl,ch=bh,cl=bl,bh=ah,bl=al,al=t1l+t2l|0,ah=t1h+t2h+getCarry(al,t1l)|0}this._al=this._al+al|0,this._bl=this._bl+bl|0,this._cl=this._cl+cl|0,this._dl=this._dl+dl|0,this._el=this._el+el|0,this._fl=this._fl+fl|0,this._gl=this._gl+gl|0,this._hl=this._hl+hl|0,this._ah=this._ah+ah+getCarry(this._al,al)|0,this._bh=this._bh+bh+getCarry(this._bl,bl)|0,this._ch=this._ch+ch+getCarry(this._cl,cl)|0,this._dh=this._dh+dh+getCarry(this._dl,dl)|0,this._eh=this._eh+eh+getCarry(this._el,el)|0,this._fh=this._fh+fh+getCarry(this._fl,fl)|0,this._gh=this._gh+gh+getCarry(this._gl,gl)|0,this._hh=this._hh+hh+getCarry(this._hl,hl)|0},Sha512.prototype._hash=function(){function writeInt64BE(h,l,offset){H.writeInt32BE(h,offset),H.writeInt32BE(l,offset+4)}var H=Buffer.allocUnsafe(64);return writeInt64BE(this._ah,this._al,0),writeInt64BE(this._bh,this._bl,8),writeInt64BE(this._ch,this._cl,16),writeInt64BE(this._dh,this._dl,24),writeInt64BE(this._eh,this._el,32),writeInt64BE(this._fh,this._fl,40),writeInt64BE(this._gh,this._gl,48),writeInt64BE(this._hh,this._hl,56),H},module.exports=Sha512},{"./hash":336,inherits:233,"safe-buffer":323}],344:[function(require,module,exports){"use strict";function t(a,b,c){if(4!==b.length)throw new sjcl.exception.invalid("invalid aes block size");var d=a.b[c],e=b[0]^d[0],f=b[c?3:1]^d[1],g=b[2]^d[2];b=b[c?1:3]^d[3];var h,k,l,m,n=d.length/4-2,p=4,r=[0,0,0,0];h=a.s[c],a=h[0];var q=h[1],v=h[2],w=h[3],x=h[4];for(m=0;m<n;m++)h=a[e>>>24]^q[f>>16&255]^v[g>>8&255]^w[255&b]^d[p],k=a[f>>>24]^q[g>>16&255]^v[b>>8&255]^w[255&e]^d[p+1],l=a[g>>>24]^q[b>>16&255]^v[e>>8&255]^w[255&f]^d[p+2],b=a[b>>>24]^q[e>>16&255]^v[f>>8&255]^w[255&g]^d[p+3],p+=4,e=h,f=k,g=l;for(m=0;4>m;m++)r[c?3&-m:m]=x[e>>>24]<<24^x[f>>16&255]<<16^x[g>>8&255]<<8^x[255&b]^d[p++],h=e,e=f,f=g,g=b,b=h;return r}function u(a,b){var c,d,e,f=a.F,g=a.b,h=f[0],k=f[1],l=f[2],n=f[3],m=f[4],p=f[5],r=f[6],q=f[7];for(c=0;64>c;c++)16>c?d=b[c]:(d=b[c+1&15],e=b[c+14&15],d=b[15&c]=(d>>>7^d>>>18^d>>>3^d<<25^d<<14)+(e>>>17^e>>>19^e>>>10^e<<15^e<<13)+b[15&c]+b[c+9&15]|0),d=d+q+(m>>>6^m>>>11^m>>>25^m<<26^m<<21^m<<7)+(r^m&(p^r))+g[c],q=r,r=p,p=m,m=n+d|0,n=l,l=k,k=h,h=d+(k&l^n&(k^l))+(k>>>2^k>>>13^k>>>22^k<<30^k<<19^k<<10)|0;f[0]=f[0]+h|0,f[1]=f[1]+k|0,f[2]=f[2]+l|0,f[3]=f[3]+n|0,f[4]=f[4]+m|0,f[5]=f[5]+p|0,f[6]=f[6]+r|0,f[7]=f[7]+q|0}function A(a,b){var c,d=sjcl.random.K[a],e=[];for(c in d)d.hasOwnProperty(c)&&e.push(d[c]);for(c=0;c<e.length;c++)e[c](b)}function C(a,b){"undefined"!=typeof window&&window.performance&&"function"==typeof window.performance.now?a.addEntropy(window.performance.now(),b,"loadtime"):a.addEntropy((new Date).valueOf(),b,"loadtime")}function y(a){a.b=z(a).concat(z(a)),a.L=new sjcl.cipher.aes(a.b)}function z(a){for(var b=0;4>b&&(a.h[b]=a.h[b]+1|0,!a.h[b]);b++);return a.L.encrypt(a.h)}function B(a,b){return function(){b.apply(a,arguments)}}var sjcl={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(a){this.toString=function(){return"CORRUPT: "+this.message},this.message=a},invalid:function(a){this.toString=function(){return"INVALID: "+this.message},this.message=a},bug:function(a){this.toString=function(){return"BUG: "+this.message},this.message=a},notReady:function(a){this.toString=function(){return"NOT READY: "+this.message},this.message=a}}};sjcl.cipher.aes=function(a){this.s[0][0][0]||this.O();var b,c,d,e,f=this.s[0][4],g=this.s[1];b=a.length;var h=1;if(4!==b&&6!==b&&8!==b)throw new sjcl.exception.invalid("invalid aes key size");for(this.b=[d=a.slice(0),e=[]],a=b;a<4*b+28;a++)c=d[a-1],(0===a%b||8===b&&4===a%b)&&(c=f[c>>>24]<<24^f[c>>16&255]<<16^f[c>>8&255]<<8^f[255&c],0===a%b&&(c=c<<8^c>>>24^h<<24,h=h<<1^283*(h>>7))),d[a]=d[a-b]^c;for(b=0;a;b++,a--)c=d[3&b?a:a-4],e[b]=4>=a||4>b?c:g[0][f[c>>>24]]^g[1][f[c>>16&255]]^g[2][f[c>>8&255]]^g[3][f[255&c]]},sjcl.cipher.aes.prototype={encrypt:function(a){return t(this,a,0)},decrypt:function(a){return t(this,a,1)},s:[[[],[],[],[],[]],[[],[],[],[],[]]],O:function(){var e,f,g,l,n,m,p,a=this.s[0],b=this.s[1],c=a[4],d=b[4],h=[],k=[];for(e=0;256>e;e++)k[(h[e]=e<<1^283*(e>>7))^e]=e;for(f=g=0;!c[f];f^=l||1,g=k[g]||1)for(m=g^g<<1^g<<2^g<<3^g<<4,m=m>>8^255&m^99,c[f]=m,d[m]=f,n=h[e=h[l=h[f]]],p=16843009*n^65537*e^257*l^16843008*f,n=257*h[m]^16843008*m,e=0;4>e;e++)a[e][f]=n=n<<24^n>>>8,b[e][m]=p=p<<24^p>>>8;for(e=0;5>e;e++)a[e]=a[e].slice(0),b[e]=b[e].slice(0)}},sjcl.bitArray={bitSlice:function(a,b,c){return a=sjcl.bitArray.$(a.slice(b/32),32-(31&b)).slice(1),void 0===c?a:sjcl.bitArray.clamp(a,c-b)},extract:function(a,b,c){var d=Math.floor(-b-c&31);return((b+c-1^b)&-32?a[b/32|0]<<32-d^a[b/32+1|0]>>>d:a[b/32|0]>>>d)&(1<<c)-1},concat:function(a,b){if(0===a.length||0===b.length)return a.concat(b);var c=a[a.length-1],d=sjcl.bitArray.getPartial(c);return 32===d?a.concat(b):sjcl.bitArray.$(b,d,0|c,a.slice(0,a.length-1))},bitLength:function(a){var b=a.length;return 0===b?0:32*(b-1)+sjcl.bitArray.getPartial(a[b-1])},clamp:function(a,b){if(32*a.length<b)return a;a=a.slice(0,Math.ceil(b/32));var c=a.length;return b=31&b,0<c&&b&&(a[c-1]=sjcl.bitArray.partial(b,a[c-1]&2147483648>>b-1,1)),a},partial:function(a,b,c){return 32===a?b:(c?0|b:b<<32-a)+1099511627776*a},getPartial:function(a){return Math.round(a/1099511627776)||32},equal:function(a,b){if(sjcl.bitArray.bitLength(a)!==sjcl.bitArray.bitLength(b))return!1;var d,c=0;for(d=0;d<a.length;d++)c|=a[d]^b[d];return 0===c},$:function(a,b,c,d){var e;for(e=0,void 0===d&&(d=[]);32<=b;b-=32)d.push(c),c=0;if(0===b)return d.concat(a);for(e=0;e<a.length;e++)d.push(c|a[e]>>>b),c=a[e]<<32-b;return e=a.length?a[a.length-1]:0,a=sjcl.bitArray.getPartial(e),d.push(sjcl.bitArray.partial(b+a&31,32<b+a?c:d.pop(),1)),d},i:function(a,b){return[a[0]^b[0],a[1]^b[1],a[2]^b[2],a[3]^b[3]]},byteswapM:function(a){var b,c;for(b=0;b<a.length;++b)c=a[b],a[b]=c>>>24|c>>>8&65280|(65280&c)<<8|c<<24;return a}},sjcl.codec.utf8String={fromBits:function(a){var d,e,b="",c=sjcl.bitArray.bitLength(a);for(d=0;d<c/8;d++)0===(3&d)&&(e=a[d/4]),b+=String.fromCharCode(e>>>8>>>8>>>8),e<<=8;return decodeURIComponent(escape(b))},toBits:function(a){a=unescape(encodeURIComponent(a));var c,b=[],d=0;for(c=0;c<a.length;c++)d=d<<8|a.charCodeAt(c),3===(3&c)&&(b.push(d),d=0);return 3&c&&b.push(sjcl.bitArray.partial(8*(3&c),d)),b}},sjcl.codec.hex={fromBits:function(a){var c,b="";for(c=0;c<a.length;c++)b+=((0|a[c])+0xf00000000000).toString(16).substr(4);return b.substr(0,sjcl.bitArray.bitLength(a)/4)},toBits:function(a){var b,d,c=[];for(a=a.replace(/\s|0x/g,""),d=a.length,a+="00000000",b=0;b<a.length;b+=8)c.push(0^parseInt(a.substr(b,8),16));return sjcl.bitArray.clamp(c,4*d)}},sjcl.codec.base32={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",X:"0123456789ABCDEFGHIJKLMNOPQRSTUV",BITS:32,BASE:5,REMAINING:27,fromBits:function(a,b,c){var d=sjcl.codec.base32.BASE,e=sjcl.codec.base32.REMAINING,f="",g=0,h=sjcl.codec.base32.B,k=0,l=sjcl.bitArray.bitLength(a);for(c&&(h=sjcl.codec.base32.X),c=0;f.length*d<l;)f+=h.charAt((k^a[c]>>>g)>>>e),g<d?(k=a[c]<<d-g,g+=e,c++):(k<<=d,g-=d);for(;7&f.length&&!b;)f+="=";return f},toBits:function(a,b){a=a.replace(/\s|=/g,"").toUpperCase();var g,n,c=sjcl.codec.base32.BITS,d=sjcl.codec.base32.BASE,e=sjcl.codec.base32.REMAINING,f=[],h=0,k=sjcl.codec.base32.B,l=0,m="base32";for(b&&(k=sjcl.codec.base32.X,m="base32hex"),g=0;g<a.length;g++){if(n=k.indexOf(a.charAt(g)),0>n){if(!b)try{return sjcl.codec.base32hex.toBits(a)}catch(p){}throw new sjcl.exception.invalid("this isn't "+m+"!")}h>e?(h-=e,f.push(l^n>>>h),l=n<<c-h):(h+=d,l^=n<<c-h)}return 56&h&&f.push(sjcl.bitArray.partial(56&h,l,1)),f}},sjcl.codec.base32hex={fromBits:function(a,b){return sjcl.codec.base32.fromBits(a,b,1)},toBits:function(a){return sjcl.codec.base32.toBits(a,1)}},sjcl.codec.base64={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(a,b,c){var d="",e=0,f=sjcl.codec.base64.B,g=0,h=sjcl.bitArray.bitLength(a);for(c&&(f=f.substr(0,62)+"-_"),c=0;6*d.length<h;)d+=f.charAt((g^a[c]>>>e)>>>26),6>e?(g=a[c]<<6-e,e+=26,c++):(g<<=6,e-=6);for(;3&d.length&&!b;)d+="=";return d},toBits:function(a,b){a=a.replace(/\s|=/g,"");var d,h,c=[],e=0,f=sjcl.codec.base64.B,g=0;for(b&&(f=f.substr(0,62)+"-_"),d=0;d<a.length;d++){if(h=f.indexOf(a.charAt(d)),0>h)throw new sjcl.exception.invalid("this isn't base64!");26<e?(e-=26,c.push(g^h>>>e),g=h<<32-e):(e+=6,g^=h<<32-e)}return 56&e&&c.push(sjcl.bitArray.partial(56&e,g,1)),c}},sjcl.codec.base64url={fromBits:function(a){return sjcl.codec.base64.fromBits(a,1,1)},toBits:function(a){return sjcl.codec.base64.toBits(a,1)}},sjcl.hash.sha256=function(a){this.b[0]||this.O(),a?(this.F=a.F.slice(0),this.A=a.A.slice(0),this.l=a.l):this.reset()},sjcl.hash.sha256.hash=function(a){return(new sjcl.hash.sha256).update(a).finalize()},sjcl.hash.sha256.prototype={blockSize:512,reset:function(){return this.F=this.Y.slice(0),this.A=[],this.l=0,this},update:function(a){"string"==typeof a&&(a=sjcl.codec.utf8String.toBits(a));var b,c=this.A=sjcl.bitArray.concat(this.A,a);if(b=this.l,a=this.l=b+sjcl.bitArray.bitLength(a),9007199254740991<a)throw new sjcl.exception.invalid("Cannot hash more than 2^53 - 1 bits");if("undefined"!=typeof Uint32Array){var d=new Uint32Array(c),e=0;for(b=512+b-(512+b&511);b<=a;b+=512)u(this,d.subarray(16*e,16*(e+1))),e+=1;c.splice(0,16*e)}else for(b=512+b-(512+b&511);b<=a;b+=512)u(this,c.splice(0,16));return this},finalize:function(){var a,b=this.A,c=this.F,b=sjcl.bitArray.concat(b,[sjcl.bitArray.partial(1,1)]);for(a=b.length+2;15&a;a++)b.push(0);for(b.push(Math.floor(this.l/4294967296)),b.push(0|this.l);b.length;)u(this,b.splice(0,16));return this.reset(),c},Y:[],b:[],O:function(){function a(a){return 4294967296*(a-Math.floor(a))|0}for(var d,e,b=0,c=2;64>b;c++){for(e=!0,d=2;d*d<=c;d++)if(0===c%d){e=!1;break}e&&(8>b&&(this.Y[b]=a(Math.pow(c,.5))),this.b[b]=a(Math.pow(c,1/3)),b++)}}},sjcl.mode.ccm={name:"ccm",G:[],listenProgress:function(a){sjcl.mode.ccm.G.push(a)},unListenProgress:function(a){a=sjcl.mode.ccm.G.indexOf(a),-1<a&&sjcl.mode.ccm.G.splice(a,1)},fa:function(a){var c,b=sjcl.mode.ccm.G.slice();for(c=0;c<b.length;c+=1)b[c](a)},encrypt:function(a,b,c,d,e){var f,g=b.slice(0),h=sjcl.bitArray,k=h.bitLength(c)/8,l=h.bitLength(g)/8;if(e=e||64,d=d||[],7>k)throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes");for(f=2;4>f&&l>>>8*f;f++);return f<15-k&&(f=15-k),c=h.clamp(c,8*(15-f)),b=sjcl.mode.ccm.V(a,b,c,d,e,f),g=sjcl.mode.ccm.C(a,g,c,b,e,f),h.concat(g.data,g.tag)},decrypt:function(a,b,c,d,e){e=e||64,d=d||[];var f=sjcl.bitArray,g=f.bitLength(c)/8,h=f.bitLength(b),k=f.clamp(b,h-e),l=f.bitSlice(b,h-e),h=(h-e)/8;if(7>g)throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes");for(b=2;4>b&&h>>>8*b;b++);if(b<15-g&&(b=15-g),c=f.clamp(c,8*(15-b)),k=sjcl.mode.ccm.C(a,k,c,l,e,b),a=sjcl.mode.ccm.V(a,k.data,c,d,e,b),!f.equal(k.tag,a))throw new sjcl.exception.corrupt("ccm: tag doesn't match");return k.data},na:function(a,b,c,d,e,f){var g=[],h=sjcl.bitArray,k=h.i;if(d=[h.partial(8,(b.length?64:0)|d-2<<2|f-1)],d=h.concat(d,c),d[3]|=e,d=a.encrypt(d),b.length)for(c=h.bitLength(b)/8,65279>=c?g=[h.partial(16,c)]:4294967295>=c&&(g=h.concat([h.partial(16,65534)],[c])),g=h.concat(g,b),b=0;b<g.length;b+=4)d=a.encrypt(k(d,g.slice(b,b+4).concat([0,0,0])));return d},V:function(a,b,c,d,e,f){var g=sjcl.bitArray,h=g.i;if(e/=8,e%2||4>e||16<e)throw new sjcl.exception.invalid("ccm: invalid tag length");if(4294967295<d.length||4294967295<b.length)throw new sjcl.exception.bug("ccm: can't deal with 4GiB or more data");for(c=sjcl.mode.ccm.na(a,d,c,e,g.bitLength(b)/8,f),d=0;d<b.length;d+=4)c=a.encrypt(h(c,b.slice(d,d+4).concat([0,0,0])));return g.clamp(c,8*e)},C:function(a,b,c,d,e,f){var g,h=sjcl.bitArray;g=h.i;var k=b.length,l=h.bitLength(b),n=k/50,m=n;if(c=h.concat([h.partial(8,f-1)],c).concat([0,0,0]).slice(0,4),d=h.bitSlice(g(d,a.encrypt(c)),0,e),!k)return{tag:d,data:[]};for(g=0;g<k;g+=4)g>n&&(sjcl.mode.ccm.fa(g/k),n+=m),c[3]++,e=a.encrypt(c),b[g]^=e[0],b[g+1]^=e[1],b[g+2]^=e[2],b[g+3]^=e[3];return{tag:d,data:h.clamp(b,l)}}},sjcl.mode.ocb2={name:"ocb2",encrypt:function(a,b,c,d,e,f){if(128!==sjcl.bitArray.bitLength(c))throw new sjcl.exception.invalid("ocb iv must be 128 bits");var g,h=sjcl.mode.ocb2.S,k=sjcl.bitArray,l=k.i,n=[0,0,0,0];c=h(a.encrypt(c));var m,p=[];for(d=d||[],e=e||64,g=0;g+4<b.length;g+=4)m=b.slice(g,g+4),n=l(n,m),p=p.concat(l(c,a.encrypt(l(c,m)))),c=h(c);return m=b.slice(g),b=k.bitLength(m),g=a.encrypt(l(c,[0,0,0,b])),m=k.clamp(l(m.concat([0,0,0]),g),b),n=l(n,l(m.concat([0,0,0]),g)),n=a.encrypt(l(n,l(c,h(c)))),d.length&&(n=l(n,f?d:sjcl.mode.ocb2.pmac(a,d))),p.concat(k.concat(m,k.clamp(n,e)))},decrypt:function(a,b,c,d,e,f){if(128!==sjcl.bitArray.bitLength(c))throw new sjcl.exception.invalid("ocb iv must be 128 bits");e=e||64;var m,p,g=sjcl.mode.ocb2.S,h=sjcl.bitArray,k=h.i,l=[0,0,0,0],n=g(a.encrypt(c)),r=sjcl.bitArray.bitLength(b)-e,q=[];for(d=d||[],c=0;c+4<r/32;c+=4)m=k(n,a.decrypt(k(n,b.slice(c,c+4)))),l=k(l,m),q=q.concat(m),n=g(n);if(p=r-32*c,m=a.encrypt(k(n,[0,0,0,p])),m=k(m,h.clamp(b.slice(c),p).concat([0,0,0])),l=k(l,m),l=a.encrypt(k(l,k(n,g(n)))),d.length&&(l=k(l,f?d:sjcl.mode.ocb2.pmac(a,d))),!h.equal(h.clamp(l,e),h.bitSlice(b,r)))throw new sjcl.exception.corrupt("ocb: tag doesn't match");return q.concat(h.clamp(m,p))},pmac:function(a,b){var c,d=sjcl.mode.ocb2.S,e=sjcl.bitArray,f=e.i,g=[0,0,0,0],h=a.encrypt([0,0,0,0]),h=f(h,d(d(h)));for(c=0;c+4<b.length;c+=4)h=d(h),g=f(g,a.encrypt(f(h,b.slice(c,c+4))));return c=b.slice(c),128>e.bitLength(c)&&(h=f(h,d(h)),c=e.concat(c,[-2147483648,0,0,0])),g=f(g,c),a.encrypt(f(d(f(h,d(h))),g))},S:function(a){return[a[0]<<1^a[1]>>>31,a[1]<<1^a[2]>>>31,a[2]<<1^a[3]>>>31,a[3]<<1^135*(a[0]>>>31)]}},sjcl.mode.gcm={name:"gcm",encrypt:function(a,b,c,d,e){var f=b.slice(0);return b=sjcl.bitArray,d=d||[],a=sjcl.mode.gcm.C(!0,a,f,d,c,e||128),b.concat(a.data,a.tag)},decrypt:function(a,b,c,d,e){var f=b.slice(0),g=sjcl.bitArray,h=g.bitLength(f);if(e=e||128,d=d||[],e<=h?(b=g.bitSlice(f,h-e),f=g.bitSlice(f,0,h-e)):(b=f,f=[]),a=sjcl.mode.gcm.C(!1,a,f,d,c,e),!g.equal(a.tag,b))throw new sjcl.exception.corrupt("gcm: tag doesn't match");return a.data},ka:function(a,b){var c,d,e,f,g,h=sjcl.bitArray.i;for(e=[0,0,0,0],f=b.slice(0),c=0;128>c;c++){for((d=0!==(a[Math.floor(c/32)]&1<<31-c%32))&&(e=h(e,f)),g=0!==(1&f[3]),d=3;0<d;d--)f[d]=f[d]>>>1|(1&f[d-1])<<31;f[0]>>>=1,g&&(f[0]^=-520093696)}return e},j:function(a,b,c){var d,e=c.length;for(b=b.slice(0),d=0;d<e;d+=4)b[0]^=4294967295&c[d],b[1]^=4294967295&c[d+1],b[2]^=4294967295&c[d+2],b[3]^=4294967295&c[d+3],b=sjcl.mode.gcm.ka(b,a);return b},C:function(a,b,c,d,e,f){var g,h,k,l,n,m,p,r,q=sjcl.bitArray;for(m=c.length,p=q.bitLength(c),r=q.bitLength(d),h=q.bitLength(e),g=b.encrypt([0,0,0,0]),96===h?(e=e.slice(0),e=q.concat(e,[1])):(e=sjcl.mode.gcm.j(g,[0,0,0,0],e),e=sjcl.mode.gcm.j(g,e,[0,0,Math.floor(h/4294967296),4294967295&h])),h=sjcl.mode.gcm.j(g,[0,0,0,0],d),n=e.slice(0),d=h.slice(0),a||(d=sjcl.mode.gcm.j(g,h,c)),l=0;l<m;l+=4)n[3]++,k=b.encrypt(n),c[l]^=k[0],c[l+1]^=k[1],c[l+2]^=k[2],c[l+3]^=k[3];return c=q.clamp(c,p),a&&(d=sjcl.mode.gcm.j(g,h,c)),a=[Math.floor(r/4294967296),4294967295&r,Math.floor(p/4294967296),4294967295&p],d=sjcl.mode.gcm.j(g,d,a),k=b.encrypt(e),d[0]^=k[0],d[1]^=k[1],d[2]^=k[2],d[3]^=k[3],{tag:q.bitSlice(d,0,f),data:c}}},sjcl.misc.hmac=function(a,b){this.W=b=b||sjcl.hash.sha256;var d,c=[[],[]],e=b.prototype.blockSize/32;for(this.w=[new b,new b],a.length>e&&(a=b.hash(a)),d=0;d<e;d++)c[0][d]=909522486^a[d],c[1][d]=1549556828^a[d];this.w[0].update(c[0]),this.w[1].update(c[1]),this.R=new b(this.w[0])},sjcl.misc.hmac.prototype.encrypt=sjcl.misc.hmac.prototype.mac=function(a){if(this.aa)throw new sjcl.exception.invalid("encrypt on already updated hmac called!");return this.update(a),this.digest(a)},sjcl.misc.hmac.prototype.reset=function(){this.R=new this.W(this.w[0]),this.aa=!1},sjcl.misc.hmac.prototype.update=function(a){this.aa=!0,this.R.update(a)},sjcl.misc.hmac.prototype.digest=function(){var a=this.R.finalize(),a=new this.W(this.w[1]).update(a).finalize();return this.reset(),a},sjcl.misc.pbkdf2=function(a,b,c,d,e){if(c=c||1e4,0>d||0>c)throw new sjcl.exception.invalid("invalid params to pbkdf2");"string"==typeof a&&(a=sjcl.codec.utf8String.toBits(a)),"string"==typeof b&&(b=sjcl.codec.utf8String.toBits(b)),e=e||sjcl.misc.hmac,a=new e(a);var f,g,h,k,l=[],n=sjcl.bitArray;for(k=1;32*l.length<(d||1);k++){for(e=f=a.encrypt(n.concat(b,[k])),g=1;g<c;g++)for(f=a.encrypt(f),h=0;h<f.length;h++)e[h]^=f[h];l=l.concat(e)}return d&&(l=n.clamp(l,d)),l},sjcl.prng=function(a){this.c=[new sjcl.hash.sha256],this.m=[0],this.P=0,this.H={},this.N=0,this.U={},this.Z=this.f=this.o=this.ha=0,this.b=[0,0,0,0,0,0,0,0],this.h=[0,0,0,0],this.L=void 0,this.M=a,this.D=!1,this.K={progress:{},seeded:{}},this.u=this.ga=0,this.I=1,this.J=2,this.ca=65536,this.T=[0,48,64,96,128,192,256,384,512,768,1024],this.da=3e4,this.ba=80},sjcl.prng.prototype={randomWords:function(a,b){var d,c=[];d=this.isReady(b);var e;if(d===this.u)throw new sjcl.exception.notReady("generator isn't seeded");if(d&this.J){d=!(d&this.I),e=[];var g,f=0;for(this.Z=e[0]=(new Date).valueOf()+this.da,g=0;16>g;g++)e.push(4294967296*Math.random()|0);for(g=0;g<this.c.length&&(e=e.concat(this.c[g].finalize()),f+=this.m[g],this.m[g]=0,d||!(this.P&1<<g));g++);for(this.P>=1<<this.c.length&&(this.c.push(new sjcl.hash.sha256),this.m.push(0)),this.f-=f,f>this.o&&(this.o=f),this.P++,this.b=sjcl.hash.sha256.hash(this.b.concat(e)),this.L=new sjcl.cipher.aes(this.b),d=0;4>d&&(this.h[d]=this.h[d]+1|0,!this.h[d]);d++);}for(d=0;d<a;d+=4)0===(d+1)%this.ca&&y(this),e=z(this),c.push(e[0],e[1],e[2],e[3]);return y(this),c.slice(0,a)},setDefaultParanoia:function(a,b){if(0===a&&"Setting paranoia=0 will ruin your security; use it only for testing"!==b)throw new sjcl.exception.invalid("Setting paranoia=0 will ruin your security; use it only for testing");this.M=a},addEntropy:function(a,b,c){c=c||"user";var d,e,f=(new Date).valueOf(),g=this.H[c],h=this.isReady(),k=0;switch(d=this.U[c],void 0===d&&(d=this.U[c]=this.ha++),void 0===g&&(g=this.H[c]=0),this.H[c]=(this.H[c]+1)%this.c.length,typeof a){case"number":void 0===b&&(b=1),this.c[g].update([d,this.N++,1,b,f,1,0|a]);break;case"object":if(c=Object.prototype.toString.call(a),"[object Uint32Array]"===c){for(e=[],c=0;c<a.length;c++)e.push(a[c]);a=e}else for("[object Array]"!==c&&(k=1),c=0;c<a.length&&!k;c++)"number"!=typeof a[c]&&(k=1);if(!k){if(void 0===b)for(c=b=0;c<a.length;c++)for(e=a[c];0<e;)b++,e>>>=1;this.c[g].update([d,this.N++,2,b,f,a.length].concat(a))}break;case"string":void 0===b&&(b=a.length),this.c[g].update([d,this.N++,3,b,f,a.length]),this.c[g].update(a);break;default:k=1}if(k)throw new sjcl.exception.bug("random: addEntropy only supports number, array of numbers or string");this.m[g]+=b,this.f+=b,h===this.u&&(this.isReady()!==this.u&&A("seeded",Math.max(this.o,this.f)),A("progress",this.getProgress()))},isReady:function(a){return a=this.T[void 0!==a?a:this.M],this.o&&this.o>=a?this.m[0]>this.ba&&(new Date).valueOf()>this.Z?this.J|this.I:this.I:this.f>=a?this.J|this.u:this.u},getProgress:function(a){return a=this.T[a?a:this.M],this.o>=a?1:this.f>a?1:this.f/a},startCollectors:function(){if(!this.D){if(this.a={loadTimeCollector:B(this,this.ma),mouseCollector:B(this,this.oa),keyboardCollector:B(this,this.la),accelerometerCollector:B(this,this.ea),touchCollector:B(this,this.qa)},window.addEventListener)window.addEventListener("load",this.a.loadTimeCollector,!1),window.addEventListener("mousemove",this.a.mouseCollector,!1),window.addEventListener("keypress",this.a.keyboardCollector,!1),window.addEventListener("devicemotion",this.a.accelerometerCollector,!1),window.addEventListener("touchmove",this.a.touchCollector,!1);else{if(!document.attachEvent)throw new sjcl.exception.bug("can't attach event");
document.attachEvent("onload",this.a.loadTimeCollector),document.attachEvent("onmousemove",this.a.mouseCollector),document.attachEvent("keypress",this.a.keyboardCollector)}this.D=!0}},stopCollectors:function(){this.D&&(window.removeEventListener?(window.removeEventListener("load",this.a.loadTimeCollector,!1),window.removeEventListener("mousemove",this.a.mouseCollector,!1),window.removeEventListener("keypress",this.a.keyboardCollector,!1),window.removeEventListener("devicemotion",this.a.accelerometerCollector,!1),window.removeEventListener("touchmove",this.a.touchCollector,!1)):document.detachEvent&&(document.detachEvent("onload",this.a.loadTimeCollector),document.detachEvent("onmousemove",this.a.mouseCollector),document.detachEvent("keypress",this.a.keyboardCollector)),this.D=!1)},addEventListener:function(a,b){this.K[a][this.ga++]=b},removeEventListener:function(a,b){var c,d,e=this.K[a],f=[];for(d in e)e.hasOwnProperty(d)&&e[d]===b&&f.push(d);for(c=0;c<f.length;c++)d=f[c],delete e[d]},la:function(){C(this,1)},oa:function(a){var b,c;try{b=a.x||a.clientX||a.offsetX||0,c=a.y||a.clientY||a.offsetY||0}catch(d){c=b=0}0!=b&&0!=c&&this.addEntropy([b,c],2,"mouse"),C(this,0)},qa:function(a){a=a.touches[0]||a.changedTouches[0],this.addEntropy([a.pageX||a.clientX,a.pageY||a.clientY],1,"touch"),C(this,0)},ma:function(){C(this,2)},ea:function(a){if(a=a.accelerationIncludingGravity.x||a.accelerationIncludingGravity.y||a.accelerationIncludingGravity.z,window.orientation){var b=window.orientation;"number"==typeof b&&this.addEntropy(b,1,"accelerometer")}a&&this.addEntropy(a,2,"accelerometer"),C(this,0)}},sjcl.random=new sjcl.prng(6);a:try{var D,E,F,G;if(G="undefined"!=typeof module&&module.exports){var H;try{H=require("crypto")}catch(a){H=null}G=E=H}if(G&&E.randomBytes)D=E.randomBytes(128),D=new Uint32Array(new Uint8Array(D).buffer),sjcl.random.addEntropy(D,1024,"crypto['randomBytes']");else if("undefined"!=typeof window&&"undefined"!=typeof Uint32Array){if(F=new Uint32Array(32),window.crypto&&window.crypto.getRandomValues)window.crypto.getRandomValues(F);else{if(!window.msCrypto||!window.msCrypto.getRandomValues)break a;window.msCrypto.getRandomValues(F)}sjcl.random.addEntropy(F,1024,"crypto['getRandomValues']")}}catch(a){"undefined"!=typeof window&&window.console&&(console.log("There was an error collecting entropy from the browser:"),console.log(a))}sjcl.json={defaults:{v:1,iter:1e4,ks:128,ts:64,mode:"ccm",adata:"",cipher:"aes"},ja:function(a,b,c,d){c=c||{},d=d||{};var g,e=sjcl.json,f=e.g({iv:sjcl.random.randomWords(4,0)},e.defaults);if(e.g(f,c),c=f.adata,"string"==typeof f.salt&&(f.salt=sjcl.codec.base64.toBits(f.salt)),"string"==typeof f.iv&&(f.iv=sjcl.codec.base64.toBits(f.iv)),!sjcl.mode[f.mode]||!sjcl.cipher[f.cipher]||"string"==typeof a&&100>=f.iter||64!==f.ts&&96!==f.ts&&128!==f.ts||128!==f.ks&&192!==f.ks&&256!==f.ks||2>f.iv.length||4<f.iv.length)throw new sjcl.exception.invalid("json encrypt: invalid parameters");return"string"==typeof a?(g=sjcl.misc.cachedPbkdf2(a,f),a=g.key.slice(0,f.ks/32),f.salt=g.salt):sjcl.ecc&&a instanceof sjcl.ecc.elGamal.publicKey&&(g=a.kem(),f.kemtag=g.tag,a=g.key.slice(0,f.ks/32)),"string"==typeof b&&(b=sjcl.codec.utf8String.toBits(b)),"string"==typeof c&&(f.adata=c=sjcl.codec.utf8String.toBits(c)),g=new sjcl.cipher[f.cipher](a),e.g(d,f),d.key=a,f.ct="ccm"===f.mode&&sjcl.arrayBuffer&&sjcl.arrayBuffer.ccm&&b instanceof ArrayBuffer?sjcl.arrayBuffer.ccm.encrypt(g,b,f.iv,c,f.ts):sjcl.mode[f.mode].encrypt(g,b,f.iv,c,f.ts),f},encrypt:function(a,b,c,d){var e=sjcl.json,f=e.ja.apply(e,arguments);return e.encode(f)},ia:function(a,b,c,d){c=c||{},d=d||{};var e=sjcl.json;b=e.g(e.g(e.g({},e.defaults),b),c,!0);var f,g;if(f=b.adata,"string"==typeof b.salt&&(b.salt=sjcl.codec.base64.toBits(b.salt)),"string"==typeof b.iv&&(b.iv=sjcl.codec.base64.toBits(b.iv)),!sjcl.mode[b.mode]||!sjcl.cipher[b.cipher]||"string"==typeof a&&100>=b.iter||64!==b.ts&&96!==b.ts&&128!==b.ts||128!==b.ks&&192!==b.ks&&256!==b.ks||!b.iv||2>b.iv.length||4<b.iv.length)throw new sjcl.exception.invalid("json decrypt: invalid parameters");return"string"==typeof a?(g=sjcl.misc.cachedPbkdf2(a,b),a=g.key.slice(0,b.ks/32),b.salt=g.salt):sjcl.ecc&&a instanceof sjcl.ecc.elGamal.secretKey&&(a=a.unkem(sjcl.codec.base64.toBits(b.kemtag)).slice(0,b.ks/32)),"string"==typeof f&&(f=sjcl.codec.utf8String.toBits(f)),g=new sjcl.cipher[b.cipher](a),f="ccm"===b.mode&&sjcl.arrayBuffer&&sjcl.arrayBuffer.ccm&&b.ct instanceof ArrayBuffer?sjcl.arrayBuffer.ccm.decrypt(g,b.ct,b.iv,b.tag,f,b.ts):sjcl.mode[b.mode].decrypt(g,b.ct,b.iv,f,b.ts),e.g(d,b),d.key=a,1===c.raw?f:sjcl.codec.utf8String.fromBits(f)},decrypt:function(a,b,c,d){var e=sjcl.json;return e.ia(a,e.decode(b),c,d)},encode:function(a){var b,c="{",d="";for(b in a)if(a.hasOwnProperty(b)){if(!b.match(/^[a-z0-9]+$/i))throw new sjcl.exception.invalid("json encode: invalid property name");switch(c+=d+'"'+b+'":',d=",",typeof a[b]){case"number":case"boolean":c+=a[b];break;case"string":c+='"'+escape(a[b])+'"';break;case"object":c+='"'+sjcl.codec.base64.fromBits(a[b],0)+'"';break;default:throw new sjcl.exception.bug("json encode: unsupported type")}}return c+"}"},decode:function(a){if(a=a.replace(/\s/g,""),!a.match(/^\{.*\}$/))throw new sjcl.exception.invalid("json decode: this isn't json!");a=a.replace(/^\{|\}$/g,"").split(/,/);var c,d,b={};for(c=0;c<a.length;c++){if(!(d=a[c].match(/^\s*(?:(["']?)([a-z][a-z0-9]*)\1)\s*:\s*(?:(-?\d+)|"([a-z0-9+\/%*_.@=\-]*)"|(true|false))$/i)))throw new sjcl.exception.invalid("json decode: this isn't json!");null!=d[3]?b[d[2]]=parseInt(d[3],10):null!=d[4]?b[d[2]]=d[2].match(/^(ct|adata|salt|iv)$/)?sjcl.codec.base64.toBits(d[4]):unescape(d[4]):null!=d[5]&&(b[d[2]]="true"===d[5])}return b},g:function(a,b,c){if(void 0===a&&(a={}),void 0===b)return a;for(var d in b)if(b.hasOwnProperty(d)){if(c&&void 0!==a[d]&&a[d]!==b[d])throw new sjcl.exception.invalid("required parameter overridden");a[d]=b[d]}return a},sa:function(a,b){var d,c={};for(d in a)a.hasOwnProperty(d)&&a[d]!==b[d]&&(c[d]=a[d]);return c},ra:function(a,b){var d,c={};for(d=0;d<b.length;d++)void 0!==a[b[d]]&&(c[b[d]]=a[b[d]]);return c}},sjcl.encrypt=sjcl.json.encrypt,sjcl.decrypt=sjcl.json.decrypt,sjcl.misc.pa={},sjcl.misc.cachedPbkdf2=function(a,b){var d,c=sjcl.misc.pa;return b=b||{},d=b.iter||1e3,c=c[a]=c[a]||{},d=c[d]=c[d]||{firstSalt:b.salt&&b.salt.length?b.salt.slice(0):sjcl.random.randomWords(2,0)},c=void 0===b.salt?d.firstSalt:b.salt,d[c]=d[c]||sjcl.misc.pbkdf2(a,c,b.iter),{key:d[c].slice(0),salt:c.slice(0)}},"undefined"!=typeof module&&module.exports&&(module.exports=sjcl),"function"==typeof define&&define([],function(){return sjcl})},{crypto:181}],345:[function(require,module,exports){function Stream(){EE.call(this)}module.exports=Stream;var EE=require("events").EventEmitter,inherits=require("inherits");inherits(Stream,EE),Stream.Readable=require("readable-stream/readable.js"),Stream.Writable=require("readable-stream/writable.js"),Stream.Duplex=require("readable-stream/duplex.js"),Stream.Transform=require("readable-stream/transform.js"),Stream.PassThrough=require("readable-stream/passthrough.js"),Stream.Stream=Stream,Stream.prototype.pipe=function(dest,options){function ondata(chunk){dest.writable&&!1===dest.write(chunk)&&source.pause&&source.pause()}function ondrain(){source.readable&&source.resume&&source.resume()}function onend(){didOnEnd||(didOnEnd=!0,dest.end())}function onclose(){didOnEnd||(didOnEnd=!0,"function"==typeof dest.destroy&&dest.destroy())}function onerror(er){if(cleanup(),0===EE.listenerCount(this,"error"))throw er}function cleanup(){source.removeListener("data",ondata),dest.removeListener("drain",ondrain),source.removeListener("end",onend),source.removeListener("close",onclose),source.removeListener("error",onerror),dest.removeListener("error",onerror),source.removeListener("end",cleanup),source.removeListener("close",cleanup),dest.removeListener("close",cleanup)}var source=this;source.on("data",ondata),dest.on("drain",ondrain),dest._isStdio||options&&options.end===!1||(source.on("end",onend),source.on("close",onclose));var didOnEnd=!1;return source.on("error",onerror),dest.on("error",onerror),source.on("end",cleanup),source.on("close",cleanup),dest.on("close",cleanup),dest.emit("pipe",source),dest}},{events:215,inherits:233,"readable-stream/duplex.js":347,"readable-stream/passthrough.js":356,"readable-stream/readable.js":357,"readable-stream/transform.js":358,"readable-stream/writable.js":359}],346:[function(require,module,exports){var toString={}.toString;module.exports=Array.isArray||function(arr){return"[object Array]"==toString.call(arr)}},{}],347:[function(require,module,exports){module.exports=require("./lib/_stream_duplex.js")},{"./lib/_stream_duplex.js":348}],348:[function(require,module,exports){"use strict";function Duplex(options){return this instanceof Duplex?(Readable.call(this,options),Writable.call(this,options),options&&options.readable===!1&&(this.readable=!1),options&&options.writable===!1&&(this.writable=!1),this.allowHalfOpen=!0,options&&options.allowHalfOpen===!1&&(this.allowHalfOpen=!1),void this.once("end",onend)):new Duplex(options)}function onend(){this.allowHalfOpen||this._writableState.ended||pna.nextTick(onEndNT,this)}function onEndNT(self){self.end()}var pna=require("process-nextick-args"),objectKeys=Object.keys||function(obj){var keys=[];for(var key in obj)keys.push(key);return keys};module.exports=Duplex;var util=require("core-util-is");util.inherits=require("inherits");var Readable=require("./_stream_readable"),Writable=require("./_stream_writable");util.inherits(Duplex,Readable);for(var keys=objectKeys(Writable.prototype),v=0;v<keys.length;v++){var method=keys[v];Duplex.prototype[method]||(Duplex.prototype[method]=Writable.prototype[method])}Object.defineProperty(Duplex.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(Duplex.prototype,"destroyed",{get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed&&this._writableState.destroyed)},set:function(value){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=value,this._writableState.destroyed=value)}}),Duplex.prototype._destroy=function(err,cb){this.push(null),this.end(),pna.nextTick(cb,err)}},{"./_stream_readable":350,"./_stream_writable":352,"core-util-is":175,inherits:233,"process-nextick-args":308}],349:[function(require,module,exports){"use strict";function PassThrough(options){return this instanceof PassThrough?void Transform.call(this,options):new PassThrough(options)}module.exports=PassThrough;var Transform=require("./_stream_transform"),util=require("core-util-is");util.inherits=require("inherits"),util.inherits(PassThrough,Transform),PassThrough.prototype._transform=function(chunk,encoding,cb){cb(null,chunk)}},{"./_stream_transform":351,"core-util-is":175,inherits:233}],350:[function(require,module,exports){(function(process,global){"use strict";function _uint8ArrayToBuffer(chunk){return Buffer.from(chunk)}function _isUint8Array(obj){return Buffer.isBuffer(obj)||obj instanceof OurUint8Array}function prependListener(emitter,event,fn){return"function"==typeof emitter.prependListener?emitter.prependListener(event,fn):void(emitter._events&&emitter._events[event]?isArray(emitter._events[event])?emitter._events[event].unshift(fn):emitter._events[event]=[fn,emitter._events[event]]:emitter.on(event,fn))}function ReadableState(options,stream){Duplex=Duplex||require("./_stream_duplex"),options=options||{};var isDuplex=stream instanceof Duplex;this.objectMode=!!options.objectMode,isDuplex&&(this.objectMode=this.objectMode||!!options.readableObjectMode);var hwm=options.highWaterMark,readableHwm=options.readableHighWaterMark,defaultHwm=this.objectMode?16:16384;hwm||0===hwm?this.highWaterMark=hwm:isDuplex&&(readableHwm||0===readableHwm)?this.highWaterMark=readableHwm:this.highWaterMark=defaultHwm,this.highWaterMark=Math.floor(this.highWaterMark),this.buffer=new BufferList,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.destroyed=!1,this.defaultEncoding=options.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,options.encoding&&(StringDecoder||(StringDecoder=require("string_decoder/").StringDecoder),this.decoder=new StringDecoder(options.encoding),this.encoding=options.encoding)}function Readable(options){return Duplex=Duplex||require("./_stream_duplex"),this instanceof Readable?(this._readableState=new ReadableState(options,this),this.readable=!0,options&&("function"==typeof options.read&&(this._read=options.read),"function"==typeof options.destroy&&(this._destroy=options.destroy)),void Stream.call(this)):new Readable(options)}function readableAddChunk(stream,chunk,encoding,addToFront,skipChunkCheck){var state=stream._readableState;if(null===chunk)state.reading=!1,onEofChunk(stream,state);else{var er;skipChunkCheck||(er=chunkInvalid(state,chunk)),er?stream.emit("error",er):state.objectMode||chunk&&chunk.length>0?("string"==typeof chunk||state.objectMode||Object.getPrototypeOf(chunk)===Buffer.prototype||(chunk=_uint8ArrayToBuffer(chunk)),addToFront?state.endEmitted?stream.emit("error",new Error("stream.unshift() after end event")):addChunk(stream,state,chunk,!0):state.ended?stream.emit("error",new Error("stream.push() after EOF")):(state.reading=!1,state.decoder&&!encoding?(chunk=state.decoder.write(chunk),state.objectMode||0!==chunk.length?addChunk(stream,state,chunk,!1):maybeReadMore(stream,state)):addChunk(stream,state,chunk,!1))):addToFront||(state.reading=!1)}return needMoreData(state)}function addChunk(stream,state,chunk,addToFront){state.flowing&&0===state.length&&!state.sync?(stream.emit("data",chunk),stream.read(0)):(state.length+=state.objectMode?1:chunk.length,addToFront?state.buffer.unshift(chunk):state.buffer.push(chunk),state.needReadable&&emitReadable(stream)),maybeReadMore(stream,state)}function chunkInvalid(state,chunk){var er;return _isUint8Array(chunk)||"string"==typeof chunk||void 0===chunk||state.objectMode||(er=new TypeError("Invalid non-string/buffer chunk")),er}function needMoreData(state){return!state.ended&&(state.needReadable||state.length<state.highWaterMark||0===state.length)}function computeNewHighWaterMark(n){return n>=MAX_HWM?n=MAX_HWM:(n--,n|=n>>>1,n|=n>>>2,n|=n>>>4,n|=n>>>8,n|=n>>>16,n++),n}function howMuchToRead(n,state){return n<=0||0===state.length&&state.ended?0:state.objectMode?1:n!==n?state.flowing&&state.length?state.buffer.head.data.length:state.length:(n>state.highWaterMark&&(state.highWaterMark=computeNewHighWaterMark(n)),n<=state.length?n:state.ended?state.length:(state.needReadable=!0,0))}function onEofChunk(stream,state){if(!state.ended){if(state.decoder){var chunk=state.decoder.end();chunk&&chunk.length&&(state.buffer.push(chunk),state.length+=state.objectMode?1:chunk.length)}state.ended=!0,emitReadable(stream)}}function emitReadable(stream){var state=stream._readableState;state.needReadable=!1,state.emittedReadable||(debug("emitReadable",state.flowing),state.emittedReadable=!0,state.sync?pna.nextTick(emitReadable_,stream):emitReadable_(stream))}function emitReadable_(stream){debug("emit readable"),stream.emit("readable"),flow(stream)}function maybeReadMore(stream,state){state.readingMore||(state.readingMore=!0,pna.nextTick(maybeReadMore_,stream,state))}function maybeReadMore_(stream,state){for(var len=state.length;!state.reading&&!state.flowing&&!state.ended&&state.length<state.highWaterMark&&(debug("maybeReadMore read 0"),stream.read(0),len!==state.length);)len=state.length;state.readingMore=!1}function pipeOnDrain(src){return function(){var state=src._readableState;debug("pipeOnDrain",state.awaitDrain),state.awaitDrain&&state.awaitDrain--,0===state.awaitDrain&&EElistenerCount(src,"data")&&(state.flowing=!0,flow(src))}}function nReadingNextTick(self){debug("readable nexttick read 0"),self.read(0)}function resume(stream,state){state.resumeScheduled||(state.resumeScheduled=!0,pna.nextTick(resume_,stream,state))}function resume_(stream,state){state.reading||(debug("resume read 0"),stream.read(0)),state.resumeScheduled=!1,state.awaitDrain=0,stream.emit("resume"),flow(stream),state.flowing&&!state.reading&&stream.read(0)}function flow(stream){var state=stream._readableState;for(debug("flow",state.flowing);state.flowing&&null!==stream.read(););}function fromList(n,state){if(0===state.length)return null;var ret;return state.objectMode?ret=state.buffer.shift():!n||n>=state.length?(ret=state.decoder?state.buffer.join(""):1===state.buffer.length?state.buffer.head.data:state.buffer.concat(state.length),state.buffer.clear()):ret=fromListPartial(n,state.buffer,state.decoder),ret}function fromListPartial(n,list,hasStrings){var ret;return n<list.head.data.length?(ret=list.head.data.slice(0,n),list.head.data=list.head.data.slice(n)):ret=n===list.head.data.length?list.shift():hasStrings?copyFromBufferString(n,list):copyFromBuffer(n,list),ret}function copyFromBufferString(n,list){var p=list.head,c=1,ret=p.data;for(n-=ret.length;p=p.next;){var str=p.data,nb=n>str.length?str.length:n;if(ret+=nb===str.length?str:str.slice(0,n),n-=nb,0===n){nb===str.length?(++c,p.next?list.head=p.next:list.head=list.tail=null):(list.head=p,p.data=str.slice(nb));break}++c}return list.length-=c,ret}function copyFromBuffer(n,list){var ret=Buffer.allocUnsafe(n),p=list.head,c=1;for(p.data.copy(ret),n-=p.data.length;p=p.next;){var buf=p.data,nb=n>buf.length?buf.length:n;if(buf.copy(ret,ret.length-n,0,nb),n-=nb,0===n){nb===buf.length?(++c,p.next?list.head=p.next:list.head=list.tail=null):(list.head=p,p.data=buf.slice(nb));break}++c}return list.length-=c,ret}function endReadable(stream){var state=stream._readableState;if(state.length>0)throw new Error('"endReadable()" called on non-empty stream');state.endEmitted||(state.ended=!0,pna.nextTick(endReadableNT,state,stream))}function endReadableNT(state,stream){state.endEmitted||0!==state.length||(state.endEmitted=!0,stream.readable=!1,stream.emit("end"))}function indexOf(xs,x){for(var i=0,l=xs.length;i<l;i++)if(xs[i]===x)return i;return-1}var pna=require("process-nextick-args");module.exports=Readable;var Duplex,isArray=require("isarray");Readable.ReadableState=ReadableState;var EElistenerCount=(require("events").EventEmitter,function(emitter,type){return emitter.listeners(type).length}),Stream=require("./internal/streams/stream"),Buffer=require("safe-buffer").Buffer,OurUint8Array=global.Uint8Array||function(){},util=require("core-util-is");util.inherits=require("inherits");var debugUtil=require("util"),debug=void 0;debug=debugUtil&&debugUtil.debuglog?debugUtil.debuglog("stream"):function(){};var StringDecoder,BufferList=require("./internal/streams/BufferList"),destroyImpl=require("./internal/streams/destroy");util.inherits(Readable,Stream);var kProxyEvents=["error","close","destroy","pause","resume"];Object.defineProperty(Readable.prototype,"destroyed",{get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(value){this._readableState&&(this._readableState.destroyed=value)}}),Readable.prototype.destroy=destroyImpl.destroy,Readable.prototype._undestroy=destroyImpl.undestroy,Readable.prototype._destroy=function(err,cb){this.push(null),cb(err)},Readable.prototype.push=function(chunk,encoding){var skipChunkCheck,state=this._readableState;return state.objectMode?skipChunkCheck=!0:"string"==typeof chunk&&(encoding=encoding||state.defaultEncoding,encoding!==state.encoding&&(chunk=Buffer.from(chunk,encoding),encoding=""),skipChunkCheck=!0),readableAddChunk(this,chunk,encoding,!1,skipChunkCheck)},Readable.prototype.unshift=function(chunk){return readableAddChunk(this,chunk,null,!0,!1)},Readable.prototype.isPaused=function(){return this._readableState.flowing===!1},Readable.prototype.setEncoding=function(enc){return StringDecoder||(StringDecoder=require("string_decoder/").StringDecoder),this._readableState.decoder=new StringDecoder(enc),this._readableState.encoding=enc,this};var MAX_HWM=8388608;Readable.prototype.read=function(n){debug("read",n),n=parseInt(n,10);var state=this._readableState,nOrig=n;if(0!==n&&(state.emittedReadable=!1),0===n&&state.needReadable&&(state.length>=state.highWaterMark||state.ended))return debug("read: emitReadable",state.length,state.ended),0===state.length&&state.ended?endReadable(this):emitReadable(this),null;if(n=howMuchToRead(n,state),0===n&&state.ended)return 0===state.length&&endReadable(this),null;var doRead=state.needReadable;debug("need readable",doRead),(0===state.length||state.length-n<state.highWaterMark)&&(doRead=!0,debug("length less than watermark",doRead)),state.ended||state.reading?(doRead=!1,debug("reading or ended",doRead)):doRead&&(debug("do read"),state.reading=!0,state.sync=!0,0===state.length&&(state.needReadable=!0),this._read(state.highWaterMark),state.sync=!1,state.reading||(n=howMuchToRead(nOrig,state)));var ret;return ret=n>0?fromList(n,state):null,null===ret?(state.needReadable=!0,n=0):state.length-=n,0===state.length&&(state.ended||(state.needReadable=!0),nOrig!==n&&state.ended&&endReadable(this)),null!==ret&&this.emit("data",ret),ret},Readable.prototype._read=function(n){this.emit("error",new Error("_read() is not implemented"))},Readable.prototype.pipe=function(dest,pipeOpts){function onunpipe(readable,unpipeInfo){debug("onunpipe"),readable===src&&unpipeInfo&&unpipeInfo.hasUnpiped===!1&&(unpipeInfo.hasUnpiped=!0,cleanup())}function onend(){debug("onend"),dest.end()}function cleanup(){debug("cleanup"),dest.removeListener("close",onclose),dest.removeListener("finish",onfinish),dest.removeListener("drain",ondrain),dest.removeListener("error",onerror),dest.removeListener("unpipe",onunpipe),src.removeListener("end",onend),src.removeListener("end",unpipe),src.removeListener("data",ondata),cleanedUp=!0,!state.awaitDrain||dest._writableState&&!dest._writableState.needDrain||ondrain()}function ondata(chunk){debug("ondata"),increasedAwaitDrain=!1;var ret=dest.write(chunk);!1!==ret||increasedAwaitDrain||((1===state.pipesCount&&state.pipes===dest||state.pipesCount>1&&indexOf(state.pipes,dest)!==-1)&&!cleanedUp&&(debug("false write response, pause",src._readableState.awaitDrain),src._readableState.awaitDrain++,increasedAwaitDrain=!0),src.pause())}function onerror(er){debug("onerror",er),unpipe(),dest.removeListener("error",onerror),0===EElistenerCount(dest,"error")&&dest.emit("error",er)}function onclose(){dest.removeListener("finish",onfinish),unpipe()}function onfinish(){debug("onfinish"),dest.removeListener("close",onclose),unpipe()}function unpipe(){debug("unpipe"),src.unpipe(dest)}var src=this,state=this._readableState;switch(state.pipesCount){case 0:state.pipes=dest;break;case 1:state.pipes=[state.pipes,dest];break;default:state.pipes.push(dest)}state.pipesCount+=1,debug("pipe count=%d opts=%j",state.pipesCount,pipeOpts);var doEnd=(!pipeOpts||pipeOpts.end!==!1)&&dest!==process.stdout&&dest!==process.stderr,endFn=doEnd?onend:unpipe;state.endEmitted?pna.nextTick(endFn):src.once("end",endFn),dest.on("unpipe",onunpipe);var ondrain=pipeOnDrain(src);dest.on("drain",ondrain);var cleanedUp=!1,increasedAwaitDrain=!1;return src.on("data",ondata),prependListener(dest,"error",onerror),dest.once("close",onclose),dest.once("finish",onfinish),dest.emit("pipe",src),state.flowing||(debug("pipe resume"),src.resume()),dest},Readable.prototype.unpipe=function(dest){var state=this._readableState,unpipeInfo={hasUnpiped:!1};if(0===state.pipesCount)return this;if(1===state.pipesCount)return dest&&dest!==state.pipes?this:(dest||(dest=state.pipes),state.pipes=null,state.pipesCount=0,state.flowing=!1,dest&&dest.emit("unpipe",this,unpipeInfo),this);if(!dest){var dests=state.pipes,len=state.pipesCount;state.pipes=null,state.pipesCount=0,state.flowing=!1;for(var i=0;i<len;i++)dests[i].emit("unpipe",this,unpipeInfo);return this}var index=indexOf(state.pipes,dest);return index===-1?this:(state.pipes.splice(index,1),state.pipesCount-=1,1===state.pipesCount&&(state.pipes=state.pipes[0]),dest.emit("unpipe",this,unpipeInfo),this)},Readable.prototype.on=function(ev,fn){var res=Stream.prototype.on.call(this,ev,fn);if("data"===ev)this._readableState.flowing!==!1&&this.resume();else if("readable"===ev){var state=this._readableState;state.endEmitted||state.readableListening||(state.readableListening=state.needReadable=!0,state.emittedReadable=!1,state.reading?state.length&&emitReadable(this):pna.nextTick(nReadingNextTick,this))}return res},Readable.prototype.addListener=Readable.prototype.on,Readable.prototype.resume=function(){var state=this._readableState;return state.flowing||(debug("resume"),state.flowing=!0,resume(this,state)),this},Readable.prototype.pause=function(){return debug("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(debug("pause"),this._readableState.flowing=!1,this.emit("pause")),this},Readable.prototype.wrap=function(stream){var _this=this,state=this._readableState,paused=!1;stream.on("end",function(){if(debug("wrapped end"),state.decoder&&!state.ended){var chunk=state.decoder.end();chunk&&chunk.length&&_this.push(chunk)}_this.push(null)}),stream.on("data",function(chunk){if(debug("wrapped data"),state.decoder&&(chunk=state.decoder.write(chunk)),(!state.objectMode||null!==chunk&&void 0!==chunk)&&(state.objectMode||chunk&&chunk.length)){var ret=_this.push(chunk);ret||(paused=!0,stream.pause())}});for(var i in stream)void 0===this[i]&&"function"==typeof stream[i]&&(this[i]=function(method){return function(){return stream[method].apply(stream,arguments)}}(i));for(var n=0;n<kProxyEvents.length;n++)stream.on(kProxyEvents[n],this.emit.bind(this,kProxyEvents[n]));return this._read=function(n){debug("wrapped _read",n),paused&&(paused=!1,stream.resume())},this},Object.defineProperty(Readable.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Readable._fromList=fromList}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./_stream_duplex":348,"./internal/streams/BufferList":353,"./internal/streams/destroy":354,"./internal/streams/stream":355,_process:309,"core-util-is":175,events:215,inherits:233,isarray:346,"process-nextick-args":308,"safe-buffer":323,"string_decoder/":360,util:119}],351:[function(require,module,exports){"use strict";function afterTransform(er,data){var ts=this._transformState;ts.transforming=!1;var cb=ts.writecb;if(!cb)return this.emit("error",new Error("write callback called multiple times"));ts.writechunk=null,ts.writecb=null,null!=data&&this.push(data),cb(er);var rs=this._readableState;rs.reading=!1,(rs.needReadable||rs.length<rs.highWaterMark)&&this._read(rs.highWaterMark)}function Transform(options){return this instanceof Transform?(Duplex.call(this,options),this._transformState={afterTransform:afterTransform.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,options&&("function"==typeof options.transform&&(this._transform=options.transform),"function"==typeof options.flush&&(this._flush=options.flush)),void this.on("prefinish",prefinish)):new Transform(options)}function prefinish(){var _this=this;"function"==typeof this._flush?this._flush(function(er,data){done(_this,er,data)}):done(this,null,null)}function done(stream,er,data){if(er)return stream.emit("error",er);if(null!=data&&stream.push(data),stream._writableState.length)throw new Error("Calling transform done when ws.length != 0");if(stream._transformState.transforming)throw new Error("Calling transform done when still transforming");return stream.push(null)}module.exports=Transform;var Duplex=require("./_stream_duplex"),util=require("core-util-is");util.inherits=require("inherits"),util.inherits(Transform,Duplex),Transform.prototype.push=function(chunk,encoding){return this._transformState.needTransform=!1,Duplex.prototype.push.call(this,chunk,encoding)},Transform.prototype._transform=function(chunk,encoding,cb){throw new Error("_transform() is not implemented")},Transform.prototype._write=function(chunk,encoding,cb){var ts=this._transformState;if(ts.writecb=cb,ts.writechunk=chunk,ts.writeencoding=encoding,!ts.transforming){var rs=this._readableState;(ts.needTransform||rs.needReadable||rs.length<rs.highWaterMark)&&this._read(rs.highWaterMark)}},Transform.prototype._read=function(n){var ts=this._transformState;null!==ts.writechunk&&ts.writecb&&!ts.transforming?(ts.transforming=!0,this._transform(ts.writechunk,ts.writeencoding,ts.afterTransform)):ts.needTransform=!0},Transform.prototype._destroy=function(err,cb){var _this2=this;Duplex.prototype._destroy.call(this,err,function(err2){cb(err2),_this2.emit("close")})}},{"./_stream_duplex":348,"core-util-is":175,inherits:233}],352:[function(require,module,exports){(function(process,global){"use strict";function CorkedRequest(state){var _this=this;this.next=null,this.entry=null,this.finish=function(){onCorkedFinish(_this,state)}}function _uint8ArrayToBuffer(chunk){return Buffer.from(chunk)}function _isUint8Array(obj){return Buffer.isBuffer(obj)||obj instanceof OurUint8Array}function nop(){}function WritableState(options,stream){Duplex=Duplex||require("./_stream_duplex"),options=options||{};var isDuplex=stream instanceof Duplex;this.objectMode=!!options.objectMode,isDuplex&&(this.objectMode=this.objectMode||!!options.writableObjectMode);var hwm=options.highWaterMark,writableHwm=options.writableHighWaterMark,defaultHwm=this.objectMode?16:16384;hwm||0===hwm?this.highWaterMark=hwm:isDuplex&&(writableHwm||0===writableHwm)?this.highWaterMark=writableHwm:this.highWaterMark=defaultHwm,this.highWaterMark=Math.floor(this.highWaterMark),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var noDecode=options.decodeStrings===!1;this.decodeStrings=!noDecode,this.defaultEncoding=options.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(er){onwrite(stream,er)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.bufferedRequestCount=0,this.corkedRequestsFree=new CorkedRequest(this)}function Writable(options){return Duplex=Duplex||require("./_stream_duplex"),realHasInstance.call(Writable,this)||this instanceof Duplex?(this._writableState=new WritableState(options,this),this.writable=!0,options&&("function"==typeof options.write&&(this._write=options.write),"function"==typeof options.writev&&(this._writev=options.writev),"function"==typeof options.destroy&&(this._destroy=options.destroy),"function"==typeof options["final"]&&(this._final=options["final"])),void Stream.call(this)):new Writable(options)}function writeAfterEnd(stream,cb){var er=new Error("write after end");stream.emit("error",er),pna.nextTick(cb,er)}function validChunk(stream,state,chunk,cb){var valid=!0,er=!1;return null===chunk?er=new TypeError("May not write null values to stream"):"string"==typeof chunk||void 0===chunk||state.objectMode||(er=new TypeError("Invalid non-string/buffer chunk")),er&&(stream.emit("error",er),pna.nextTick(cb,er),valid=!1),valid}function decodeChunk(state,chunk,encoding){return state.objectMode||state.decodeStrings===!1||"string"!=typeof chunk||(chunk=Buffer.from(chunk,encoding)),chunk}function writeOrBuffer(stream,state,isBuf,chunk,encoding,cb){if(!isBuf){var newChunk=decodeChunk(state,chunk,encoding);chunk!==newChunk&&(isBuf=!0,encoding="buffer",chunk=newChunk)}var len=state.objectMode?1:chunk.length;state.length+=len;var ret=state.length<state.highWaterMark;if(ret||(state.needDrain=!0),
state.writing||state.corked){var last=state.lastBufferedRequest;state.lastBufferedRequest={chunk:chunk,encoding:encoding,isBuf:isBuf,callback:cb,next:null},last?last.next=state.lastBufferedRequest:state.bufferedRequest=state.lastBufferedRequest,state.bufferedRequestCount+=1}else doWrite(stream,state,!1,len,chunk,encoding,cb);return ret}function doWrite(stream,state,writev,len,chunk,encoding,cb){state.writelen=len,state.writecb=cb,state.writing=!0,state.sync=!0,writev?stream._writev(chunk,state.onwrite):stream._write(chunk,encoding,state.onwrite),state.sync=!1}function onwriteError(stream,state,sync,er,cb){--state.pendingcb,sync?(pna.nextTick(cb,er),pna.nextTick(finishMaybe,stream,state),stream._writableState.errorEmitted=!0,stream.emit("error",er)):(cb(er),stream._writableState.errorEmitted=!0,stream.emit("error",er),finishMaybe(stream,state))}function onwriteStateUpdate(state){state.writing=!1,state.writecb=null,state.length-=state.writelen,state.writelen=0}function onwrite(stream,er){var state=stream._writableState,sync=state.sync,cb=state.writecb;if(onwriteStateUpdate(state),er)onwriteError(stream,state,sync,er,cb);else{var finished=needFinish(state);finished||state.corked||state.bufferProcessing||!state.bufferedRequest||clearBuffer(stream,state),sync?asyncWrite(afterWrite,stream,state,finished,cb):afterWrite(stream,state,finished,cb)}}function afterWrite(stream,state,finished,cb){finished||onwriteDrain(stream,state),state.pendingcb--,cb(),finishMaybe(stream,state)}function onwriteDrain(stream,state){0===state.length&&state.needDrain&&(state.needDrain=!1,stream.emit("drain"))}function clearBuffer(stream,state){state.bufferProcessing=!0;var entry=state.bufferedRequest;if(stream._writev&&entry&&entry.next){var l=state.bufferedRequestCount,buffer=new Array(l),holder=state.corkedRequestsFree;holder.entry=entry;for(var count=0,allBuffers=!0;entry;)buffer[count]=entry,entry.isBuf||(allBuffers=!1),entry=entry.next,count+=1;buffer.allBuffers=allBuffers,doWrite(stream,state,!0,state.length,buffer,"",holder.finish),state.pendingcb++,state.lastBufferedRequest=null,holder.next?(state.corkedRequestsFree=holder.next,holder.next=null):state.corkedRequestsFree=new CorkedRequest(state),state.bufferedRequestCount=0}else{for(;entry;){var chunk=entry.chunk,encoding=entry.encoding,cb=entry.callback,len=state.objectMode?1:chunk.length;if(doWrite(stream,state,!1,len,chunk,encoding,cb),entry=entry.next,state.bufferedRequestCount--,state.writing)break}null===entry&&(state.lastBufferedRequest=null)}state.bufferedRequest=entry,state.bufferProcessing=!1}function needFinish(state){return state.ending&&0===state.length&&null===state.bufferedRequest&&!state.finished&&!state.writing}function callFinal(stream,state){stream._final(function(err){state.pendingcb--,err&&stream.emit("error",err),state.prefinished=!0,stream.emit("prefinish"),finishMaybe(stream,state)})}function prefinish(stream,state){state.prefinished||state.finalCalled||("function"==typeof stream._final?(state.pendingcb++,state.finalCalled=!0,pna.nextTick(callFinal,stream,state)):(state.prefinished=!0,stream.emit("prefinish")))}function finishMaybe(stream,state){var need=needFinish(state);return need&&(prefinish(stream,state),0===state.pendingcb&&(state.finished=!0,stream.emit("finish"))),need}function endWritable(stream,state,cb){state.ending=!0,finishMaybe(stream,state),cb&&(state.finished?pna.nextTick(cb):stream.once("finish",cb)),state.ended=!0,stream.writable=!1}function onCorkedFinish(corkReq,state,err){var entry=corkReq.entry;for(corkReq.entry=null;entry;){var cb=entry.callback;state.pendingcb--,cb(err),entry=entry.next}state.corkedRequestsFree?state.corkedRequestsFree.next=corkReq:state.corkedRequestsFree=corkReq}var pna=require("process-nextick-args");module.exports=Writable;var Duplex,asyncWrite=!process.browser&&["v0.10","v0.9."].indexOf(process.version.slice(0,5))>-1?setImmediate:pna.nextTick;Writable.WritableState=WritableState;var util=require("core-util-is");util.inherits=require("inherits");var internalUtil={deprecate:require("util-deprecate")},Stream=require("./internal/streams/stream"),Buffer=require("safe-buffer").Buffer,OurUint8Array=global.Uint8Array||function(){},destroyImpl=require("./internal/streams/destroy");util.inherits(Writable,Stream),WritableState.prototype.getBuffer=function(){for(var current=this.bufferedRequest,out=[];current;)out.push(current),current=current.next;return out},function(){try{Object.defineProperty(WritableState.prototype,"buffer",{get:internalUtil.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(_){}}();var realHasInstance;"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(realHasInstance=Function.prototype[Symbol.hasInstance],Object.defineProperty(Writable,Symbol.hasInstance,{value:function(object){return!!realHasInstance.call(this,object)||this===Writable&&(object&&object._writableState instanceof WritableState)}})):realHasInstance=function(object){return object instanceof this},Writable.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe, not readable"))},Writable.prototype.write=function(chunk,encoding,cb){var state=this._writableState,ret=!1,isBuf=!state.objectMode&&_isUint8Array(chunk);return isBuf&&!Buffer.isBuffer(chunk)&&(chunk=_uint8ArrayToBuffer(chunk)),"function"==typeof encoding&&(cb=encoding,encoding=null),isBuf?encoding="buffer":encoding||(encoding=state.defaultEncoding),"function"!=typeof cb&&(cb=nop),state.ended?writeAfterEnd(this,cb):(isBuf||validChunk(this,state,chunk,cb))&&(state.pendingcb++,ret=writeOrBuffer(this,state,isBuf,chunk,encoding,cb)),ret},Writable.prototype.cork=function(){var state=this._writableState;state.corked++},Writable.prototype.uncork=function(){var state=this._writableState;state.corked&&(state.corked--,state.writing||state.corked||state.finished||state.bufferProcessing||!state.bufferedRequest||clearBuffer(this,state))},Writable.prototype.setDefaultEncoding=function(encoding){if("string"==typeof encoding&&(encoding=encoding.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((encoding+"").toLowerCase())>-1))throw new TypeError("Unknown encoding: "+encoding);return this._writableState.defaultEncoding=encoding,this},Object.defineProperty(Writable.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Writable.prototype._write=function(chunk,encoding,cb){cb(new Error("_write() is not implemented"))},Writable.prototype._writev=null,Writable.prototype.end=function(chunk,encoding,cb){var state=this._writableState;"function"==typeof chunk?(cb=chunk,chunk=null,encoding=null):"function"==typeof encoding&&(cb=encoding,encoding=null),null!==chunk&&void 0!==chunk&&this.write(chunk,encoding),state.corked&&(state.corked=1,this.uncork()),state.ending||state.finished||endWritable(this,state,cb)},Object.defineProperty(Writable.prototype,"destroyed",{get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(value){this._writableState&&(this._writableState.destroyed=value)}}),Writable.prototype.destroy=destroyImpl.destroy,Writable.prototype._undestroy=destroyImpl.undestroy,Writable.prototype._destroy=function(err,cb){this.end(),cb(err)}}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./_stream_duplex":348,"./internal/streams/destroy":354,"./internal/streams/stream":355,_process:309,"core-util-is":175,inherits:233,"process-nextick-args":308,"safe-buffer":323,"util-deprecate":415}],353:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function copyBuffer(src,target,offset){src.copy(target,offset)}var Buffer=require("safe-buffer").Buffer,util=require("util");module.exports=function(){function BufferList(){_classCallCheck(this,BufferList),this.head=null,this.tail=null,this.length=0}return BufferList.prototype.push=function(v){var entry={data:v,next:null};this.length>0?this.tail.next=entry:this.head=entry,this.tail=entry,++this.length},BufferList.prototype.unshift=function(v){var entry={data:v,next:this.head};0===this.length&&(this.tail=entry),this.head=entry,++this.length},BufferList.prototype.shift=function(){if(0!==this.length){var ret=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,ret}},BufferList.prototype.clear=function(){this.head=this.tail=null,this.length=0},BufferList.prototype.join=function(s){if(0===this.length)return"";for(var p=this.head,ret=""+p.data;p=p.next;)ret+=s+p.data;return ret},BufferList.prototype.concat=function(n){if(0===this.length)return Buffer.alloc(0);if(1===this.length)return this.head.data;for(var ret=Buffer.allocUnsafe(n>>>0),p=this.head,i=0;p;)copyBuffer(p.data,ret,i),i+=p.data.length,p=p.next;return ret},BufferList}(),util&&util.inspect&&util.inspect.custom&&(module.exports.prototype[util.inspect.custom]=function(){var obj=util.inspect({length:this.length});return this.constructor.name+" "+obj})},{"safe-buffer":323,util:119}],354:[function(require,module,exports){"use strict";function destroy(err,cb){var _this=this,readableDestroyed=this._readableState&&this._readableState.destroyed,writableDestroyed=this._writableState&&this._writableState.destroyed;return readableDestroyed||writableDestroyed?(cb?cb(err):!err||this._writableState&&this._writableState.errorEmitted||pna.nextTick(emitErrorNT,this,err),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(err||null,function(err){!cb&&err?(pna.nextTick(emitErrorNT,_this,err),_this._writableState&&(_this._writableState.errorEmitted=!0)):cb&&cb(err)}),this)}function undestroy(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}function emitErrorNT(self,err){self.emit("error",err)}var pna=require("process-nextick-args");module.exports={destroy:destroy,undestroy:undestroy}},{"process-nextick-args":308}],355:[function(require,module,exports){module.exports=require("events").EventEmitter},{events:215}],356:[function(require,module,exports){module.exports=require("./readable").PassThrough},{"./readable":357}],357:[function(require,module,exports){exports=module.exports=require("./lib/_stream_readable.js"),exports.Stream=exports,exports.Readable=exports,exports.Writable=require("./lib/_stream_writable.js"),exports.Duplex=require("./lib/_stream_duplex.js"),exports.Transform=require("./lib/_stream_transform.js"),exports.PassThrough=require("./lib/_stream_passthrough.js")},{"./lib/_stream_duplex.js":348,"./lib/_stream_passthrough.js":349,"./lib/_stream_readable.js":350,"./lib/_stream_transform.js":351,"./lib/_stream_writable.js":352}],358:[function(require,module,exports){module.exports=require("./readable").Transform},{"./readable":357}],359:[function(require,module,exports){module.exports=require("./lib/_stream_writable.js")},{"./lib/_stream_writable.js":352}],360:[function(require,module,exports){arguments[4][148][0].apply(exports,arguments)},{dup:148,"safe-buffer":323}],361:[function(require,module,exports){var base32=require("./thirty-two");exports.encode=base32.encode,exports.decode=base32.decode},{"./thirty-two":362}],362:[function(require,module,exports){(function(Buffer){"use strict";function quintetCount(buff){var quintets=Math.floor(buff.length/5);return buff.length%5===0?quintets:quintets+1}var charTable="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",byteTable=[255,255,26,27,28,29,30,31,255,255,255,255,255,255,255,255,255,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,255,255,255,255,255,255,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,255,255,255,255,255];exports.encode=function(plain){Buffer.isBuffer(plain)||(plain=new Buffer(plain));for(var i=0,j=0,shiftIndex=0,digit=0,encoded=new Buffer(8*quintetCount(plain));i<plain.length;){var current=plain[i];shiftIndex>3?(digit=current&255>>shiftIndex,shiftIndex=(shiftIndex+5)%8,digit=digit<<shiftIndex|(i+1<plain.length?plain[i+1]:0)>>8-shiftIndex,i++):(digit=current>>8-(shiftIndex+5)&31,shiftIndex=(shiftIndex+5)%8,0===shiftIndex&&i++),encoded[j]=charTable.charCodeAt(digit),j++}for(i=j;i<encoded.length;i++)encoded[i]=61;return encoded},exports.decode=function(encoded){var plainChar,shiftIndex=0,plainDigit=0,plainPos=0;Buffer.isBuffer(encoded)||(encoded=new Buffer(encoded));for(var decoded=new Buffer(Math.ceil(5*encoded.length/8)),i=0;i<encoded.length&&61!==encoded[i];i++){var encodedByte=encoded[i]-48;if(!(encodedByte<byteTable.length))throw new Error("Invalid input - it is not base32 encoded string");plainDigit=byteTable[encodedByte],shiftIndex<=3?(shiftIndex=(shiftIndex+5)%8,0===shiftIndex?(plainChar|=plainDigit,decoded[plainPos]=plainChar,plainPos++,plainChar=0):plainChar|=255&plainDigit<<8-shiftIndex):(shiftIndex=(shiftIndex+5)%8,plainChar|=255&plainDigit>>>shiftIndex,decoded[plainPos]=plainChar,plainPos++,plainChar=255&plainDigit<<8-shiftIndex)}return decoded.slice(0,plainPos)}}).call(this,require("buffer").Buffer)},{buffer:151}],363:[function(require,module,exports){"use strict";function readBalance(wallet,handleBalance){var walletIsAddress="string"==typeof wallet&&32===wallet.length,join_my_addresses=walletIsAddress?"":"JOIN my_addresses USING(address)",where_condition=walletIsAddress?"address=?":"wallet=?",assocBalances={base:{stable:0,pending:0}};db.query("SELECT asset, is_stable, SUM(amount) AS balance \n\t\tFROM outputs "+join_my_addresses+" CROSS JOIN units USING(unit) \n\t\tWHERE is_spent=0 AND "+where_condition+" AND sequence='good' \n\t\tGROUP BY asset, is_stable",[wallet],function(rows){for(var i=0;i<rows.length;i++){var row=rows[i],asset=row.asset||"base";assocBalances[asset]||(assocBalances[asset]={stable:0,pending:0}),assocBalances[asset][row.is_stable?"stable":"pending"]=row.balance}var my_addresses_join=walletIsAddress?"":"my_addresses CROSS JOIN",using=walletIsAddress?"":"USING(address)";db.query("SELECT SUM(total) AS total FROM ( \n\t\t\t\tSELECT SUM(amount) AS total FROM "+my_addresses_join+" witnessing_outputs "+using+" WHERE is_spent=0 AND "+where_condition+" \n\t\t\t\tUNION ALL \n\t\t\t\tSELECT SUM(amount) AS total FROM "+my_addresses_join+" headers_commission_outputs "+using+" WHERE is_spent=0 AND "+where_condition+" ) AS t",[wallet,wallet],function(rows){rows.length&&(assocBalances.base.stable+=rows[0].total),db.query("SELECT DISTINCT outputs.asset, is_private \n\t\t\t\t\t\tFROM outputs "+join_my_addresses+" CROSS JOIN units USING(unit) LEFT JOIN assets ON asset=assets.unit \n\t\t\t\t\t\tWHERE "+where_condition+" AND sequence='good'",[wallet],function(rows){for(var i=0;i<rows.length;i++){var row=rows[i],asset=row.asset||"base";assocBalances[asset]||(assocBalances[asset]={stable:0,pending:0}),assocBalances[asset].is_private=row.is_private}handleBalance(assocBalances)})})})}function readOutputsBalance(wallet,handleBalance){var walletIsAddress="string"==typeof wallet&&32===wallet.length,join_my_addresses=walletIsAddress?"":"JOIN my_addresses USING(address)",where_condition=walletIsAddress?"address=?":"wallet=?",assocBalances={base:{stable:0,pending:0}};db.query("SELECT asset, is_stable, SUM(amount) AS balance \n\t\tFROM outputs "+join_my_addresses+" CROSS JOIN units USING(unit) \n\t\tWHERE is_spent=0 AND "+where_condition+" AND sequence='good' \n\t\tGROUP BY asset, is_stable",[wallet],function(rows){for(var i=0;i<rows.length;i++){var row=rows[i],asset=row.asset||"base";assocBalances[asset]||(assocBalances[asset]={stable:0,pending:0}),assocBalances[asset][row.is_stable?"stable":"pending"]=row.balance}handleBalance(assocBalances)})}function readSharedAddressesOnWallet(wallet,handleSharedAddresses){db.query("SELECT DISTINCT shared_address FROM my_addresses JOIN shared_address_signing_paths USING(address) WHERE wallet=?",[wallet],function(rows){var arrSharedAddresses=rows.map(function(row){return row.shared_address});return 0===arrSharedAddresses.length?handleSharedAddresses([]):void readSharedAddressesDependingOnAddresses(arrSharedAddresses,function(arrNewSharedAddresses){handleSharedAddresses(arrSharedAddresses.concat(arrNewSharedAddresses))})})}function readSharedAddressesDependingOnAddresses(arrMemberAddresses,handleSharedAddresses){db.query("SELECT DISTINCT shared_address FROM shared_address_signing_paths WHERE address IN(?)",[arrMemberAddresses],function(rows){var arrSharedAddresses=rows.map(function(row){return row.shared_address});if(0===arrSharedAddresses.length)return handleSharedAddresses([]);var arrNewMemberAddresses=_.difference(arrSharedAddresses,arrMemberAddresses);return 0===arrNewMemberAddresses.length?handleSharedAddresses([]):void readSharedAddressesDependingOnAddresses(arrNewMemberAddresses,function(arrNewSharedAddresses){handleSharedAddresses(arrNewMemberAddresses.concat(arrNewSharedAddresses))})})}function readSharedBalance(wallet,handleBalance){var assocBalances={};readSharedAddressesOnWallet(wallet,function(arrSharedAddresses){if(0===arrSharedAddresses.length)return handleBalance(assocBalances);var strAddressList=arrSharedAddresses.map(db.escape).join(", ");db.query("SELECT asset, address, is_stable, SUM(amount) AS balance \n\t\t\tFROM outputs CROSS JOIN units USING(unit) \n\t\t\tWHERE is_spent=0 AND sequence='good' AND address IN("+strAddressList+") \n\t\t\tGROUP BY asset, address, is_stable \n\t\t\tUNION ALL \n\t\t\tSELECT NULL AS asset, address, 1 AS is_stable, SUM(amount) AS balance FROM witnessing_outputs \n\t\t\tWHERE is_spent=0 AND address IN("+strAddressList+") GROUP BY address \n\t\t\tUNION ALL \n\t\t\tSELECT NULL AS asset, address, 1 AS is_stable, SUM(amount) AS balance FROM headers_commission_outputs \n\t\t\tWHERE is_spent=0 AND address IN("+strAddressList+") GROUP BY address",function(rows){for(var i=0;i<rows.length;i++){var row=rows[i],asset=row.asset||"base";assocBalances[asset]||(assocBalances[asset]={}),assocBalances[asset][row.address]||(assocBalances[asset][row.address]={stable:0,pending:0}),assocBalances[asset][row.address][row.is_stable?"stable":"pending"]+=row.balance}handleBalance(assocBalances)})})}var _=require("lodash"),db=require("./db");exports.readBalance=readBalance,exports.readOutputsBalance=readOutputsBalance,exports.readSharedBalance=readSharedBalance},{"./db":372,lodash:271}],364:[function(require,module,exports){"use strict";function getBotByID(id,cb){for(var i in bots_cache){var bot=bots_cache[i];if(bot.id==id)return setPairingStatus(bot,cb)}}function load(cb){device.requestFromHub("hub/get_bots",!1,function(err,bots){return null!=err?cb(err,null):void async.eachSeries(bots,function(bot,cb){setPairingStatus(bot,function(handled_bot){bot.isPaired=handled_bot.isPaired,cb()})},function(){bots_cache=bots,cb(err,bots)})})}function setPairingStatus(bot,cb){var pubkey=bot.pairing_code.substr(0,bot.pairing_code.indexOf("@"));bot.device_address=objectHash.getDeviceAddress(pubkey),db.query("SELECT 1 FROM correspondent_devices WHERE device_address = ?",[bot.device_address],function(rows){bot.isPaired=1==rows.length,cb(bot)})}var db=require("./db.js"),objectHash=require("./object_hash.js"),device=require("./device.js"),async=require("async"),bots_cache=[];exports.load=load,exports.getBotByID=getBotByID},{"./db.js":372,"./device.js":375,"./object_hash.js":392,async:26}],365:[function(require,module,exports){"use strict";function add(breadcrumb){arrBreadcrumbs.length>MAX_LENGTH&&arrBreadcrumbs.shift(),arrBreadcrumbs.push(Date().toString()+": "+breadcrumb),console.log(breadcrumb)}function get(){return arrBreadcrumbs}var MAX_LENGTH=200,arrBreadcrumbs=[];exports.add=add,exports.get=get},{}],366:[function(require,module,exports){"use strict";function prepareCatchupChain(catchupRequest,callbacks){var last_stable_mci=catchupRequest.last_stable_mci,last_known_mci=catchupRequest.last_known_mci,arrWitnesses=catchupRequest.witnesses;if("number"!=typeof last_stable_mci)return callbacks.ifError("no last_stable_mci");if("number"!=typeof last_known_mci)return callbacks.ifError("no last_known_mci");if(last_stable_mci>=last_known_mci&&(last_known_mci>0||last_stable_mci>0))return callbacks.ifError("last_stable_mci >= last_known_mci");if(!Array.isArray(arrWitnesses))return callbacks.ifError("no witnesses");var objCatchupChain={unstable_mc_joints:[],stable_last_ball_joints:[],witness_change_and_definition_joints:[]},last_ball_unit=null;async.series([function(cb){db.query("SELECT is_stable FROM units WHERE is_on_main_chain=1 AND main_chain_index=?",[last_known_mci],function(rows){return 0===rows.length?cb("already_current"):0===rows[0].is_stable?cb("already_current"):void cb()})},function(cb){witnessProof.prepareWitnessProof(arrWitnesses,last_stable_mci,function(err,arrUnstableMcJoints,arrWitnessChangeAndDefinitionJoints,_last_ball_unit,_last_ball_mci){return err?cb(err):(objCatchupChain.unstable_mc_joints=arrUnstableMcJoints,arrWitnessChangeAndDefinitionJoints.length>0&&(objCatchupChain.witness_change_and_definition_joints=arrWitnessChangeAndDefinitionJoints),last_ball_unit=_last_ball_unit,void cb())})},function(cb){function goUp(unit){storage.readJointWithBall(db,unit,function(objJoint){objCatchupChain.stable_last_ball_joints.push(objJoint),storage.readUnitProps(db,unit,function(objUnitProps){objUnitProps.main_chain_index<=last_stable_mci?cb():goUp(objJoint.unit.last_ball_unit)})})}return last_ball_unit?void goUp(last_ball_unit):cb()}],function(err){return"already_current"===err?callbacks.ifOk({status:"current"}):err?callbacks.ifError(err):void callbacks.ifOk(objCatchupChain)})}function processCatchupChain(catchupChain,peer,callbacks){return"current"===catchupChain.status?callbacks.ifCurrent():Array.isArray(catchupChain.unstable_mc_joints)?Array.isArray(catchupChain.stable_last_ball_joints)?0===catchupChain.stable_last_ball_joints.length?callbacks.ifError("stable_last_ball_joints is empty"):(catchupChain.witness_change_and_definition_joints||(catchupChain.witness_change_and_definition_joints=[]),Array.isArray(catchupChain.witness_change_and_definition_joints)?void witnessProof.processWitnessProof(catchupChain.unstable_mc_joints,catchupChain.witness_change_and_definition_joints,!0,function(err,arrLastBallUnits,assocLastBallByLastBallUnit){if(err)return callbacks.ifError(err);var objFirstStableJoint=catchupChain.stable_last_ball_joints[0],objFirstStableUnit=objFirstStableJoint.unit;if(arrLastBallUnits.indexOf(objFirstStableUnit.unit)===-1)return callbacks.ifError("first stable unit is not last ball unit of any unstable unit");var last_ball_unit=objFirstStableUnit.unit,last_ball=assocLastBallByLastBallUnit[last_ball_unit];if(objFirstStableJoint.ball!==last_ball)return callbacks.ifError("last ball and last ball unit do not match: "+objFirstStableJoint.ball+"!=="+last_ball);for(var arrChainBalls=[],i=0;i<catchupChain.stable_last_ball_joints.length;i++){var objJoint=catchupChain.stable_last_ball_joints[i],objUnit=objJoint.unit;if(!objJoint.ball)return callbacks.ifError("stable but no ball");if(!validation.hasValidHashes(objJoint))return callbacks.ifError("invalid hash");if(objUnit.unit!==last_ball_unit)return callbacks.ifError("not the last ball unit");if(objJoint.ball!==last_ball)return callbacks.ifError("not the last ball");objUnit.last_ball_unit&&(last_ball_unit=objUnit.last_ball_unit,last_ball=objUnit.last_ball),arrChainBalls.push(objJoint.ball)}arrChainBalls.reverse();var unlock=null;async.series([function(cb){mutex.lock(["catchup_chain"],function(_unlock){unlock=_unlock,db.query("SELECT 1 FROM catchup_chain_balls LIMIT 1",function(rows){rows.length>0?cb("duplicate"):cb()})})},function(cb){db.query("SELECT is_stable, is_on_main_chain, main_chain_index FROM balls JOIN units USING(unit) WHERE ball=?",[arrChainBalls[0]],function(rows){if(0===rows.length)return storage.isGenesisBall(arrChainBalls[0])?cb():cb("first chain ball "+arrChainBalls[0]+" is not known");var objFirstChainBallProps=rows[0];return 1!==objFirstChainBallProps.is_stable?cb("first chain ball "+arrChainBalls[0]+" is not stable"):1!==objFirstChainBallProps.is_on_main_chain?cb("first chain ball "+arrChainBalls[0]+" is not on mc"):void storage.readLastStableMcUnitProps(db,function(objLastStableMcUnitProps){var last_stable_mci=objLastStableMcUnitProps.main_chain_index;return objFirstChainBallProps.main_chain_index>last_stable_mci?cb("first chain ball "+arrChainBalls[0]+" mci is too large"):objFirstChainBallProps.main_chain_index===last_stable_mci?cb():(arrChainBalls[0]=objLastStableMcUnitProps.ball,arrChainBalls[1]?void db.query("SELECT is_stable FROM balls JOIN units USING(unit) WHERE ball=?",[arrChainBalls[1]],function(rows2){if(0===rows2.length)return cb();var objSecondChainBallProps=rows2[0];return 1===objSecondChainBallProps.is_stable?cb("second chain ball "+arrChainBalls[1]+" must not be stable"):void cb()}):cb())})})},function(cb){var arrValues=arrChainBalls.map(function(ball){return"("+db.escape(ball)+")"});db.query("INSERT INTO catchup_chain_balls (ball) VALUES "+arrValues.join(", "),function(){cb()})}],function(err){unlock(),err?callbacks.ifError(err):callbacks.ifOk()})}):callbacks.ifError("witness_change_and_definition_joints must be array")):callbacks.ifError("no stable_last_ball_joints"):callbacks.ifError("no unstable_mc_joints")}function readHashTree(hashTreeRequest,callbacks){var from_ball=hashTreeRequest.from_ball,to_ball=hashTreeRequest.to_ball;if("string"!=typeof from_ball)return callbacks.ifError("no from_ball");if("string"!=typeof to_ball)return callbacks.ifError("no to_ball");var from_mci,to_mci;db.query("SELECT is_stable, is_on_main_chain, main_chain_index, ball FROM balls JOIN units USING(unit) WHERE ball IN(?,?)",[from_ball,to_ball],function(rows){if(2!==rows.length)return callbacks.ifError("some balls not found");for(var i=0;i<rows.length;i++){var props=rows[i];if(1!==props.is_stable)return callbacks.ifError("some balls not stable");if(1!==props.is_on_main_chain)return callbacks.ifError("some balls not on mc");props.ball===from_ball?from_mci=props.main_chain_index:props.ball===to_ball&&(to_mci=props.main_chain_index)}if(from_mci>=to_mci)return callbacks.ifError("from is after to");var arrBalls=[],op=0===from_mci?">=":">";db.query("SELECT unit, ball, content_hash FROM units LEFT JOIN balls USING(unit) \n\t\t\t\tWHERE main_chain_index "+op+" ? AND main_chain_index<=? ORDER BY `level`",[from_mci,to_mci],function(ball_rows){async.eachSeries(ball_rows,function(objBall,cb){if(!objBall.ball)throw Error("no ball for unit "+objBall.unit);objBall.content_hash&&(objBall.is_nonserial=!0),delete objBall.content_hash,db.query("SELECT ball FROM parenthoods LEFT JOIN balls ON parent_unit=balls.unit WHERE child_unit=? ORDER BY ball",[objBall.unit],function(parent_rows){if(parent_rows.some(function(parent_row){return!parent_row.ball}))throw Error("some parents have no balls");parent_rows.length>0&&(objBall.parent_balls=parent_rows.map(function(parent_row){return parent_row.ball})),db.query("SELECT ball FROM skiplist_units LEFT JOIN balls ON skiplist_unit=balls.unit WHERE skiplist_units.unit=? ORDER BY ball",[objBall.unit],function(srows){if(srows.some(function(srow){return!srow.ball}))throw Error("some skiplist units have no balls");srows.length>0&&(objBall.skiplist_balls=srows.map(function(srow){return srow.ball})),arrBalls.push(objBall),cb()})})},function(){callbacks.ifOk(arrBalls)})})})}function processHashTree(arrBalls,callbacks){return Array.isArray(arrBalls)?void mutex.lock(["hash_tree"],function(unlock){db.query("SELECT 1 FROM hash_tree_balls LIMIT 1",function(ht_rows){db.takeConnectionFromPool(function(conn){conn.query("BEGIN",function(){var max_mci=null;async.eachSeries(arrBalls,function(objBall,cb){function addBall(){conn.query("INSERT "+conn.getIgnore()+" INTO hash_tree_balls (ball, unit) VALUES(?,?)",[objBall.ball,objBall.unit],function(){cb()})}function checkSkiplistBallsExist(){return objBall.skiplist_balls?void conn.query("SELECT ball FROM hash_tree_balls WHERE ball IN(?) UNION SELECT ball FROM balls WHERE ball IN(?)",[objBall.skiplist_balls,objBall.skiplist_balls],function(rows){return rows.length!==objBall.skiplist_balls.length?cb("some skiplist balls not found"):void addBall()}):addBall()}if("string"!=typeof objBall.ball)return cb("no ball");if("string"!=typeof objBall.unit)return cb("no unit");if(storage.isGenesisUnit(objBall.unit)){if(objBall.parent_balls)return cb("genesis with parents?")}else if(!Array.isArray(objBall.parent_balls))return cb("no parents");return objBall.ball!==objectHash.getBallHash(objBall.unit,objBall.parent_balls,objBall.skiplist_balls,objBall.is_nonserial)?cb("wrong ball hash, ball "+objBall.ball+", unit "+objBall.unit):objBall.parent_balls?void conn.query("SELECT ball FROM hash_tree_balls WHERE ball IN(?)",[objBall.parent_balls],function(rows){if(rows.length===objBall.parent_balls.length)return checkSkiplistBallsExist();var arrFoundBalls=rows.map(function(row){return row.ball}),arrMissingBalls=_.difference(objBall.parent_balls,arrFoundBalls);conn.query("SELECT ball, main_chain_index, is_on_main_chain FROM balls JOIN units USING(unit) WHERE ball IN(?)",[arrMissingBalls],function(rows2){if(rows2.length!==arrMissingBalls.length)return cb("some parents not found, unit "+objBall.unit);for(var i=0;i<rows2.length;i++){var props=rows2[i];1===props.is_on_main_chain&&(props.main_chain_index>max_mci||null===max_mci)&&(max_mci=props.main_chain_index)}checkSkiplistBallsExist()})}):checkSkiplistBallsExist()},function(error){function finish(err){conn.query(err?"ROLLBACK":"COMMIT",function(){conn.release(),unlock(),err?callbacks.ifError(err):callbacks.ifOk()})}return error?finish(error):void conn.query("SELECT ball, main_chain_index \n\t\t\t\t\t\t\t\tFROM catchup_chain_balls LEFT JOIN balls USING(ball) LEFT JOIN units USING(unit) \n\t\t\t\t\t\t\t\tORDER BY member_index LIMIT 2",function(rows){return 2!==rows.length?finish("expecting to have 2 elements in the chain"):rows[1].ball!==arrBalls[arrBalls.length-1].ball?finish("tree root doesn't match second chain element"):void conn.query("DELETE FROM catchup_chain_balls WHERE ball=?",[rows[0].ball],function(){purgeHandledBallsFromHashTree(conn,finish)})})})})})})}):callbacks.ifError("no balls array")}function purgeHandledBallsFromHashTree(conn,onDone){conn.query("SELECT ball FROM hash_tree_balls CROSS JOIN balls USING(ball)",function(rows){if(0===rows.length)return onDone();var arrHandledBalls=rows.map(function(row){return row.ball});conn.query("DELETE FROM hash_tree_balls WHERE ball IN(?)",[arrHandledBalls],function(){onDone()})})}var async=require("async"),_=require("lodash"),storage=require("./storage.js"),objectHash=require("./object_hash.js"),db=require("./db.js"),mutex=require("./mutex.js"),validation=require("./validation.js"),witnessProof=require("./witness_proof.js");exports.prepareCatchupChain=prepareCatchupChain,exports.processCatchupChain=processCatchupChain,exports.readHashTree=readHashTree,exports.processHashTree=processHashTree,exports.purgeHandledBallsFromHashTree=purgeHandledBallsFromHashTree},{"./db.js":372,"./mutex.js":388,"./object_hash.js":392,"./storage.js":402,"./validation.js":404,"./witness_proof.js":410,async:26,lodash:271}],367:[function(require,module,exports){(function(Buffer){"use strict";function checkLength(chash_length){if(160!==chash_length&&288!==chash_length)throw"unsupported c-hash length: "+chash_length}function calcOffsets(chash_length){checkLength(chash_length);for(var arrOffsets=[],offset=0,index=0,i=0;offset<chash_length;i++){var relative_offset=parseInt(arrRelativeOffsets[i]);
if(0!==relative_offset){if(offset+=relative_offset,288===chash_length&&(offset+=4),offset>=chash_length)break;arrOffsets.push(offset),index++}}if(32!=index)throw"wrong number of checksum bits";return arrOffsets}function separateIntoCleanDataAndChecksum(bin){var arrOffsets,len=bin.length;if(160===len)arrOffsets=arrOffsets160;else{if(288!==len)throw Error("bad length="+len+", bin = "+bin);arrOffsets=arrOffsets288}for(var arrFrags=[],arrChecksumBits=[],start=0,i=0;i<arrOffsets.length;i++)arrFrags.push(bin.substring(start,arrOffsets[i])),arrChecksumBits.push(bin.substr(arrOffsets[i],1)),start=arrOffsets[i]+1;start<bin.length&&arrFrags.push(bin.substring(start));var binCleanData=arrFrags.join(""),binChecksum=arrChecksumBits.join("");return{clean_data:binCleanData,checksum:binChecksum}}function mixChecksumIntoCleanData(binCleanData,binChecksum){if(32!==binChecksum.length)throw"bad checksum length";var arrOffsets,len=binCleanData.length+binChecksum.length;if(160===len)arrOffsets=arrOffsets160;else{if(288!==len)throw Error("bad length="+len+", clean data = "+binCleanData+", checksum = "+binChecksum);arrOffsets=arrOffsets288}for(var arrFrags=[],arrChecksumBits=binChecksum.split(""),start=0,i=0;i<arrOffsets.length;i++){var end=arrOffsets[i]-i;arrFrags.push(binCleanData.substring(start,end)),arrFrags.push(arrChecksumBits[i]),start=end}return start<binCleanData.length&&arrFrags.push(binCleanData.substring(start)),arrFrags.join("")}function buffer2bin(buf){for(var bytes=[],i=0;i<buf.length;i++){var bin=buf[i].toString(2);bin.length<8&&(bin=zeroString.substring(bin.length,8)+bin),bytes.push(bin)}return bytes.join("")}function bin2buffer(bin){for(var len=bin.length/8,buf=new Buffer(len),i=0;i<len;i++)buf[i]=parseInt(bin.substr(8*i,8),2);return buf}function getChecksum(clean_data){var full_checksum=crypto.createHash("sha256").update(clean_data).digest(),checksum=new Buffer([full_checksum[5],full_checksum[13],full_checksum[21],full_checksum[29]]);return checksum}function getChash(data,chash_length){checkLength(chash_length);var hash=crypto.createHash(160===chash_length?"ripemd160":"sha256").update(data,"utf8").digest(),truncated_hash=160===chash_length?hash.slice(4):hash,checksum=getChecksum(truncated_hash),binCleanData=buffer2bin(truncated_hash),binChecksum=buffer2bin(checksum),binChash=mixChecksumIntoCleanData(binCleanData,binChecksum),chash=bin2buffer(binChash),encoded=160===chash_length?base32.encode(chash).toString():chash.toString("base64");return encoded}function getChash160(data){return getChash(data,160)}function getChash288(data){return getChash(data,288)}function isChashValid(encoded){var encoded_len=encoded.length;if(32!==encoded_len&&48!==encoded_len)throw"wrong encoded length: "+encoded_len;var chash=32===encoded_len?base32.decode(encoded):new Buffer(encoded,"base64"),binChash=buffer2bin(chash),separated=separateIntoCleanDataAndChecksum(binChash),clean_data=bin2buffer(separated.clean_data),checksum=bin2buffer(separated.checksum);return checksum.equals(getChecksum(clean_data))}var crypto=require("crypto"),base32=require("thirty-two"),PI="14159265358979323846264338327950288419716939937510",zeroString="00000000",arrRelativeOffsets=PI.split(""),arrOffsets160=calcOffsets(160),arrOffsets288=calcOffsets(288);exports.getChash160=getChash160,exports.getChash288=getChash288,exports.isChashValid=isChashValid}).call(this,require("buffer").Buffer)},{buffer:151,crypto:181,"thirty-two":361}],368:[function(require,module,exports){"use strict";function store(correspondent_address,message,is_incoming,type){var type=type||"text";db.query("INSERT INTO chat_messages ('correspondent_address', 'message', 'is_incoming', 'type') VALUES (?, ?, ?, ?)",[correspondent_address,message,is_incoming,type])}function load(correspondent_address,up_to_id,limit,cb){db.query("SELECT id, message, creation_date, is_incoming, type FROM chat_messages \n\t\tWHERE correspondent_address=? AND id < "+up_to_id+" ORDER BY id DESC LIMIT ?",[correspondent_address,limit],function(rows){cb(rows)})}function purge(correspondent_address){db.query("DELETE FROM chat_messages \n\t\tWHERE correspondent_address=?",[correspondent_address])}var db=require("./db.js");exports.store=store,exports.load=load,exports.purge=purge},{"./db.js":372}],369:[function(require,module,exports){"use strict";function repeatString(str,times){return str.repeat?str.repeat(times):new Array(times+1).join(str)}function sortOutputs(a,b){var addr_comparison=a.address.localeCompare(b.address);return addr_comparison?addr_comparison:a.amount-b.amount}function pickDivisibleCoinsForAmount(conn,objAsset,arrAddresses,last_ball_mci,amount,bMultiAuthored,onDone){function addInput(input){total_amount+=input.amount;var objInputWithProof={input:input};if(objAsset&&objAsset.is_private){var spend_proof=objectHash.getBase64Hash({asset:asset,amount:input.amount,address:input.address,unit:input.unit,message_index:input.message_index,output_index:input.output_index,blinding:input.blinding}),objSpendProof={spend_proof:spend_proof};bMultiAuthored&&(objSpendProof.address=input.address),objInputWithProof.spend_proof=objSpendProof}bMultiAuthored&&input.type||delete input.address,delete input.amount,delete input.blinding,arrInputsWithProofs.push(objInputWithProof)}function pickOneCoinJustBiggerAndContinue(){if(amount===1/0)return pickMultipleCoinsAndContinue();var more=is_base?">":">=";conn.query("SELECT unit, message_index, output_index, amount, blinding, address \n\t\t\tFROM outputs \n\t\t\tCROSS JOIN units USING(unit) \n\t\t\tWHERE address IN(?) AND asset"+(asset?"="+conn.escape(asset):" IS NULL")+" AND is_spent=0 AND amount "+more+" ? \n\t\t\t\tAND is_stable=1 AND sequence='good' AND main_chain_index<=?  \n\t\t\tORDER BY amount LIMIT 1",[arrSpendableAddresses,amount+is_base*TRANSFER_INPUT_SIZE,last_ball_mci],function(rows){if(1===rows.length){var input=rows[0];addInput(input),onDone(arrInputsWithProofs,total_amount)}else pickMultipleCoinsAndContinue()})}function pickMultipleCoinsAndContinue(){conn.query("SELECT unit, message_index, output_index, amount, address, blinding \n\t\t\tFROM outputs \n\t\t\tCROSS JOIN units USING(unit) \n\t\t\tWHERE address IN(?) AND asset"+(asset?"="+conn.escape(asset):" IS NULL")+" AND is_spent=0 \n\t\t\t\tAND is_stable=1 AND sequence='good' AND main_chain_index<=?  \n\t\t\tORDER BY amount DESC",[arrSpendableAddresses,last_ball_mci],function(rows){async.eachSeries(rows,function(row,cb){var input=row;objectHash.cleanNulls(input),required_amount+=is_base*TRANSFER_INPUT_SIZE,addInput(input);var bFound=is_base?total_amount>required_amount:total_amount>=required_amount;bFound?cb("found"):cb()},function(err){"found"===err?onDone(arrInputsWithProofs,total_amount):asset?issueAsset():addHeadersCommissionInputs()})})}function addHeadersCommissionInputs(){addMcInputs("headers_commission",HEADERS_COMMISSION_INPUT_SIZE,headers_commission.getMaxSpendableMciForLastBallMci(last_ball_mci),addWitnessingInputs)}function addWitnessingInputs(){addMcInputs("witnessing",WITNESSING_INPUT_SIZE,paid_witnessing.getMaxSpendableMciForLastBallMci(last_ball_mci),issueAsset)}function addMcInputs(type,input_size,max_mci,onStillNotEnough){async.eachSeries(arrAddresses,function(address,cb){var target_amount=required_amount+input_size+(bMultiAuthored?ADDRESS_SIZE:0)-total_amount;mc_outputs.findMcIndexIntervalToTargetAmount(conn,type,address,max_mci,target_amount,{ifNothing:cb,ifFound:function(from_mc_index,to_mc_index,earnings,bSufficient){if(0===earnings)throw Error("earnings === 0");total_amount+=earnings;var input={type:type,from_main_chain_index:from_mc_index,to_main_chain_index:to_mc_index},full_input_size=input_size;bMultiAuthored&&(full_input_size+=ADDRESS_SIZE,input.address=address),required_amount+=full_input_size,arrInputsWithProofs.push({input:input}),total_amount>required_amount?cb("found"):cb()}})},function(err){err||console.log(arrAddresses+" "+type+": got only "+total_amount+" out of required "+required_amount),"found"===err?onDone(arrInputsWithProofs,total_amount):onStillNotEnough()})}function issueAsset(){function addIssueInput(serial_number){total_amount+=issue_amount;var input={type:"issue",amount:issue_amount,serial_number:serial_number};bMultiAuthored&&(input.address=issuer_address);var objInputWithProof={input:input};if(objAsset&&objAsset.is_private){var spend_proof=objectHash.getBase64Hash({asset:asset,amount:issue_amount,denomination:1,address:issuer_address,serial_number:serial_number}),objSpendProof={spend_proof:spend_proof};bMultiAuthored&&(objSpendProof.address=input.address),objInputWithProof.spend_proof=objSpendProof}arrInputsWithProofs.push(objInputWithProof);var bFound=is_base?total_amount>required_amount:total_amount>=required_amount;bFound?onDone(arrInputsWithProofs,total_amount):finish()}if(!asset)return finish();if(amount===1/0&&!objAsset.cap)return onDone(null);if(console.log("will try to issue asset "+asset),objAsset.issued_by_definer_only&&arrAddresses.indexOf(objAsset.definer_address)===-1)return finish();var issuer_address=objAsset.issued_by_definer_only?objAsset.definer_address:arrAddresses[0],issue_amount=objAsset.cap||required_amount-total_amount||1;objAsset.cap?conn.query("SELECT 1 FROM inputs WHERE type='issue' AND asset=?",[asset],function(rows){return rows.length>0?finish():void addIssueInput(1)}):conn.query("SELECT MAX(serial_number) AS max_serial_number FROM inputs WHERE type='issue' AND asset=? AND address=?",[asset,issuer_address],function(rows){var max_serial_number=0===rows.length?0:rows[0].max_serial_number;addIssueInput(max_serial_number+1)})}function finish(){amount===1/0&&arrInputsWithProofs.length>0?onDone(arrInputsWithProofs,total_amount):onDone(null)}var asset=objAsset?objAsset.asset:null;console.log("pick coins "+asset+" amount "+amount);var is_base=objAsset?0:1,arrInputsWithProofs=[],total_amount=0,required_amount=amount,arrSpendableAddresses=arrAddresses.concat();if(objAsset&&objAsset.auto_destroy){var i=arrAddresses.indexOf(objAsset.definer_address);i>=0&&arrSpendableAddresses.splice(i,1)}arrSpendableAddresses.length>0?pickOneCoinJustBiggerAndContinue():issueAsset()}function createTextMessage(text){return{app:"text",payload_location:"inline",payload_hash:objectHash.getBase64Hash(text),payload:text}}function composeTextJoint(arrSigningAddresses,arrPayingAddresses,text,signer,callbacks){composePaymentAndTextJoint(arrSigningAddresses,arrPayingAddresses,[{address:arrPayingAddresses[0],amount:0}],text,signer,callbacks)}function composePaymentJoint(arrFromAddresses,arrOutputs,signer,callbacks){composeJoint({paying_addresses:arrFromAddresses,outputs:arrOutputs,signer:signer,callbacks:callbacks})}function composePaymentAndTextJoint(arrSigningAddresses,arrPayingAddresses,arrOutputs,text,signer,callbacks){composeJoint({signing_addresses:arrSigningAddresses,paying_addresses:arrPayingAddresses,outputs:arrOutputs,messages:[createTextMessage(text)],signer:signer,callbacks:callbacks})}function composeContentJoint(from_address,app,payload,signer,callbacks){var objMessage={app:app,payload_location:"inline",payload_hash:objectHash.getBase64Hash(payload),payload:payload};composeJoint({paying_addresses:[from_address],outputs:[{address:from_address,amount:0}],messages:[objMessage],signer:signer,callbacks:callbacks})}function composeDefinitionChangeJoint(from_address,definition_chash,signer,callbacks){composeContentJoint(from_address,"address_definition_change",{definition_chash:definition_chash},signer,callbacks)}function composeDataFeedJoint(from_address,data,signer,callbacks){composeContentJoint(from_address,"data_feed",data,signer,callbacks)}function composeDataJoint(from_address,data,signer,callbacks){composeContentJoint(from_address,"data",data,signer,callbacks)}function composeDedinitionTemplateJoint(from_address,arrDefinitionTemplate,signer,callbacks){composeContentJoint(from_address,"definition_template",arrDefinitionTemplate,signer,callbacks)}function composePollJoint(from_address,question,arrChoices,signer,callbacks){var poll_data={question:question,choices:arrChoices};composeContentJoint(from_address,"poll",poll_data,signer,callbacks)}function composeVoteJoint(from_address,poll_unit,choice,signer,callbacks){var vote_data={unit:poll_unit,choice:choice};composeContentJoint(from_address,"vote",vote_data,signer,callbacks)}function composeProfileJoint(from_address,profile_data,signer,callbacks){composeContentJoint(from_address,"profile",profile_data,signer,callbacks)}function composeAttestationJoint(from_address,attested_address,profile_data,signer,callbacks){composeContentJoint(from_address,"attestation",{address:attested_address,profile:profile_data},signer,callbacks)}function composeAssetDefinitionJoint(from_address,asset_definition,signer,callbacks){composeContentJoint(from_address,"asset",asset_definition,signer,callbacks)}function composeAssetAttestorsJoint(from_address,asset,arrNewAttestors,signer,callbacks){composeContentJoint(from_address,"asset_attestors",{asset:asset,attestors:arrNewAttestors},signer,callbacks)}function composeJoint(params){var arrWitnesses=params.witnesses;if(!arrWitnesses)return void myWitnesses.readMyWitnesses(function(_arrWitnesses){params.witnesses=_arrWitnesses,composeJoint(params)});if(conf.bLight&&!params.lightProps){var network=require("./network.js");return void network.requestFromLightVendor("light/get_parents_and_last_ball_and_witness_list_unit",{witnesses:arrWitnesses},function(ws,request,response){return response.error?params.callbacks.ifError(response.error):response.parent_units&&response.last_stable_mc_ball&&response.last_stable_mc_ball_unit&&"number"==typeof response.last_stable_mc_ball_mci?(params.lightProps=response,void composeJoint(params)):params.callbacks.ifError("invalid parents from light vendor")})}if(params.minimal&&!params.send_all){var callbacks=params.callbacks,arrCandidatePayingAddresses=params.paying_addresses,trySubset=function(count){if(count>constants.MAX_AUTHORS_PER_UNIT)return callbacks.ifNotEnoughFunds("Too many authors.  Consider splitting the payment into two units.");var try_params=_.clone(params);delete try_params.minimal,try_params.paying_addresses=arrCandidatePayingAddresses.slice(0,count),try_params.callbacks={ifOk:callbacks.ifOk,ifError:callbacks.ifError,ifNotEnoughFunds:function(error_message){return count===arrCandidatePayingAddresses.length?callbacks.ifNotEnoughFunds(error_message):void trySubset(count+1)}},composeJoint(try_params)};return trySubset(1)}var arrSigningAddresses=params.signing_addresses||[],arrPayingAddresses=params.paying_addresses||[],arrOutputs=params.outputs||[],arrMessages=_.clone(params.messages||[]),assocPrivatePayloads=params.private_payloads||{},fnRetrieveMessages=params.retrieveMessages,lightProps=params.lightProps,signer=params.signer,callbacks=params.callbacks;if(conf.bLight&&!lightProps)throw Error("no parent props for light");var arrChangeOutputs=arrOutputs.filter(function(output){return 0===output.amount}),arrExternalOutputs=arrOutputs.filter(function(output){return output.amount>0});if(arrChangeOutputs.length>1)throw Error("more than one change output");if(0===arrChangeOutputs.length)throw Error("no change outputs");if(0===arrPayingAddresses.length)throw Error("no payers?");var arrFromAddresses=_.union(arrSigningAddresses,arrPayingAddresses).sort(),objPaymentMessage={app:"payment",payload_location:"inline",payload_hash:hash_placeholder,payload:{outputs:arrChangeOutputs}},total_amount=0;arrExternalOutputs.forEach(function(output){objPaymentMessage.payload.outputs.push(output),total_amount+=output.amount}),arrMessages.push(objPaymentMessage);var bMultiAuthored=arrFromAddresses.length>1,objUnit={version:constants.version,alt:constants.alt,messages:arrMessages,authors:[]},objJoint={unit:objUnit};params.earned_headers_commission_recipients?objUnit.earned_headers_commission_recipients=params.earned_headers_commission_recipients.concat().sort(function(a,b){return a.address<b.address?-1:1}):bMultiAuthored&&(objUnit.earned_headers_commission_recipients=[{address:arrChangeOutputs[0].address,earned_headers_commission_share:100}]);var total_input,last_ball_mci,unlock_callback,conn,assocSigningPaths={},handleError=function(err){if(unlock_callback(),"object"==typeof err){if("NOT_ENOUGH_FUNDS"===err.error_code)return callbacks.ifNotEnoughFunds(err.error);throw Error("unknown error code in: "+JSON.stringify(err))}callbacks.ifError(err)};async.series([function(cb){mutex.lock(arrFromAddresses.map(function(from_address){return"c-"+from_address}),function(unlock){unlock_callback=unlock,cb()})},function(cb){db.takeConnectionFromPool(function(new_conn){conn=new_conn,conn.query("BEGIN",function(){cb()})})},function(cb){function checkForUnstablePredecessors(){conn.query("SELECT 1 FROM units CROSS JOIN unit_authors USING(unit) \n\t\t\t\t\tWHERE  (main_chain_index>? OR main_chain_index IS NULL) AND address IN(?) AND definition_chash IS NOT NULL \n\t\t\t\t\tUNION \n\t\t\t\t\tSELECT 1 FROM units JOIN address_definition_changes USING(unit) \n\t\t\t\t\tWHERE (main_chain_index>? OR main_chain_index IS NULL) AND address IN(?) \n\t\t\t\t\tUNION \n\t\t\t\t\tSELECT 1 FROM units CROSS JOIN unit_authors USING(unit) \n\t\t\t\t\tWHERE (main_chain_index>? OR main_chain_index IS NULL) AND address IN(?) AND sequence!='good'",[last_ball_mci,arrFromAddresses,last_ball_mci,arrFromAddresses,last_ball_mci,arrFromAddresses],function(rows){return rows.length>0?cb("some definition changes or definitions or nonserials are not stable yet"):void cb()})}return bGenesis?cb():conf.bLight?(objUnit.parent_units=lightProps.parent_units,objUnit.last_ball=lightProps.last_stable_mc_ball,objUnit.last_ball_unit=lightProps.last_stable_mc_ball_unit,last_ball_mci=lightProps.last_stable_mc_ball_mci,checkForUnstablePredecessors()):void parentComposer.pickParentUnitsAndLastBall(conn,arrWitnesses,function(err,arrParentUnits,last_stable_mc_ball,last_stable_mc_ball_unit,last_stable_mc_ball_mci){return err?cb("unable to find parents: "+err):(objUnit.parent_units=arrParentUnits,objUnit.last_ball=last_stable_mc_ball,objUnit.last_ball_unit=last_stable_mc_ball_unit,last_ball_mci=last_stable_mc_ball_mci,void checkForUnstablePredecessors())})},function(cb){async.eachSeries(arrFromAddresses,function(from_address,cb2){function setDefinition(){signer.readDefinition(conn,from_address,function(err,arrDefinition){return err?cb2(err):(objAuthor.definition=arrDefinition,void cb2())})}var objAuthor={address:from_address,authentifiers:{}};signer.readSigningPaths(conn,from_address,function(assocLengthsBySigningPaths){var arrSigningPaths=Object.keys(assocLengthsBySigningPaths);assocSigningPaths[from_address]=arrSigningPaths;for(var j=0;j<arrSigningPaths.length;j++)objAuthor.authentifiers[arrSigningPaths[j]]=repeatString("-",assocLengthsBySigningPaths[arrSigningPaths[j]]);objUnit.authors.push(objAuthor),conn.query("SELECT 1 FROM unit_authors CROSS JOIN units USING(unit) \n\t\t\t\t\t\tWHERE address=? AND is_stable=1 AND sequence='good' AND main_chain_index<=? \n\t\t\t\t\t\tLIMIT 1",[from_address,last_ball_mci],function(rows){return 0===rows.length?setDefinition():void conn.query("SELECT definition \n\t\t\t\t\t\t\t\tFROM address_definition_changes CROSS JOIN units USING(unit) LEFT JOIN definitions USING(definition_chash) \n\t\t\t\t\t\t\t\tWHERE address=? AND is_stable=1 AND sequence='good' AND main_chain_index<=? \n\t\t\t\t\t\t\t\tORDER BY level DESC LIMIT 1",[from_address,last_ball_mci],function(rows){if(0===rows.length)return cb2();var row=rows[0];row.definition?cb2():setDefinition()})})})},cb)},function(cb){return bGenesis?(objUnit.witnesses=arrWitnesses,cb()):conf.bLight?(lightProps.witness_list_unit?objUnit.witness_list_unit=lightProps.witness_list_unit:objUnit.witnesses=arrWitnesses,cb()):void storage.determineIfWitnessAddressDefinitionsHaveReferences(conn,arrWitnesses,function(bWithReferences){return bWithReferences?cb("some witnesses have references in their addresses"):void storage.findWitnessListUnit(conn,arrWitnesses,last_ball_mci,function(witness_list_unit){witness_list_unit?objUnit.witness_list_unit=witness_list_unit:objUnit.witnesses=arrWitnesses,cb()})})},function(cb){return fnRetrieveMessages?(console.log("will retrieve messages"),void fnRetrieveMessages(conn,last_ball_mci,bMultiAuthored,arrPayingAddresses,function(err,arrMoreMessages,assocMorePrivatePayloads){if(console.log("fnRetrieveMessages callback: err code = "+(err?err.error_code:"")),err)return cb("string"==typeof err?"unable to add additional messages: "+err:err);if(Array.prototype.push.apply(objUnit.messages,arrMoreMessages),assocMorePrivatePayloads&&Object.keys(assocMorePrivatePayloads).length>0)for(var payload_hash in assocMorePrivatePayloads)assocPrivatePayloads[payload_hash]=assocMorePrivatePayloads[payload_hash];cb()})):cb()},function(cb){objUnit.headers_commission=objectLength.getHeadersSize(objUnit);var naked_payload_commission=objectLength.getTotalPayloadSize(objUnit);if(bGenesis)return objPaymentMessage.payload.inputs=[{type:"issue",serial_number:1,amount:constants.TOTAL_WHITEBYTES,address:arrWitnesses[0]}],objUnit.payload_commission=objectLength.getTotalPayloadSize(objUnit),total_input=constants.TOTAL_WHITEBYTES,cb();if(params.inputs){if(!params.input_amount)throw Error("inputs but no input_amount");return total_input=params.input_amount,objPaymentMessage.payload.inputs=params.inputs,objUnit.payload_commission=objectLength.getTotalPayloadSize(objUnit),cb()}var target_amount=params.send_all?1/0:total_amount+objUnit.headers_commission+naked_payload_commission;pickDivisibleCoinsForAmount(conn,null,arrPayingAddresses,last_ball_mci,target_amount,bMultiAuthored,function(arrInputsWithProofs,_total_input){return arrInputsWithProofs?(total_input=_total_input,objPaymentMessage.payload.inputs=arrInputsWithProofs.map(function(objInputWithProof){return objInputWithProof.input}),objUnit.payload_commission=objectLength.getTotalPayloadSize(objUnit),console.log("inputs increased payload by",objUnit.payload_commission-naked_payload_commission),void cb()):cb({error_code:"NOT_ENOUGH_FUNDS",error:"not enough spendable funds from "+arrPayingAddresses+" for "+target_amount})})}],function(err){conn.query(err?"ROLLBACK":"COMMIT",function(){if(conn.release(),err)return handleError(err);var change=total_input-total_amount-objUnit.headers_commission-objUnit.payload_commission;if(change<=0){if(!params.send_all)throw Error("change="+change+", params="+JSON.stringify(params));return handleError({error_code:"NOT_ENOUGH_FUNDS",error:"not enough spendable funds from "+arrPayingAddresses+" for fees"})}objPaymentMessage.payload.outputs[0].amount=change,objPaymentMessage.payload.outputs.sort(sortOutputs),objPaymentMessage.payload_hash=objectHash.getBase64Hash(objPaymentMessage.payload);var text_to_sign=objectHash.getUnitHashToSign(objUnit);async.each(objUnit.authors,function(author,cb2){var address=author.address;async.each(assocSigningPaths[address],function(path,cb3){signer.sign?signer.sign(objUnit,assocPrivatePayloads,address,path,function(err,signature){return err?cb3(err):"[refused]"===signature?cb3("one of the cosigners refused to sign"):(author.authentifiers[path]=signature,void cb3())}):signer.readPrivateKey(address,path,function(err,privKey){return err?cb3(err):(author.authentifiers[path]=ecdsaSig.sign(text_to_sign,privKey),void cb3())})},function(err){cb2(err)})},function(err){return err?handleError(err):(objUnit.unit=objectHash.getUnitHash(objUnit),bGenesis&&(objJoint.ball=objectHash.getBallHash(objUnit.unit)),console.log(require("util").inspect(objJoint,{depth:null})),objJoint.unit.timestamp=Math.round(Date.now()/1e3),0===Object.keys(assocPrivatePayloads).length&&(assocPrivatePayloads=null),void callbacks.ifOk(objJoint,assocPrivatePayloads,unlock_callback))})})})}function filterMostFundedAddresses(rows,estimated_amount){if(!estimated_amount)return rows.map(function(row){return row.address});for(var arrFundedAddresses=[],accumulated_amount=0,i=0;i<rows.length&&(arrFundedAddresses.push(rows[i].address),accumulated_amount+=rows[i].total,!(accumulated_amount>estimated_amount+MAX_FEE));i++);return arrFundedAddresses}function readSortedFundedAddresses(asset,arrAvailableAddresses,estimated_amount,handleFundedAddresses){if(0===arrAvailableAddresses.length)return handleFundedAddresses([]);if(estimated_amount&&"number"!=typeof estimated_amount)throw Error("invalid estimated amount: "+estimated_amount);var order_by=estimated_amount?"(SUM(amount)>"+estimated_amount+") DESC, ABS(SUM(amount)-"+estimated_amount+") ASC":"SUM(amount) DESC";db.query("SELECT address, SUM(amount) AS total \n\t\tFROM outputs \n\t\tCROSS JOIN units USING(unit) \n\t\tWHERE address IN(?) AND is_stable=1 AND sequence='good' AND is_spent=0 AND asset"+(asset?"=?":" IS NULL")+" \n\t\t\tAND NOT EXISTS ( \n\t\t\t\tSELECT * FROM unit_authors JOIN units USING(unit) \n\t\t\t\tWHERE is_stable=0 AND unit_authors.address=outputs.address AND definition_chash IS NOT NULL \n\t\t\t) \n\t\tGROUP BY address ORDER BY "+order_by,asset?[arrAvailableAddresses,asset]:[arrAvailableAddresses],function(rows){var arrFundedAddresses=filterMostFundedAddresses(rows,estimated_amount);handleFundedAddresses(arrFundedAddresses)})}function composeMinimalJoint(params){var estimated_amount=params.send_all||params.retrieveMessages?0:params.outputs.reduce(function(acc,output){return acc+output.amount},0)+TYPICAL_FEE;readSortedFundedAddresses(null,params.available_paying_addresses,estimated_amount,function(arrFundedPayingAddresses){if(0===arrFundedPayingAddresses.length)return params.callbacks.ifNotEnoughFunds("all paying addresses are unfunded");var minimal_params=_.clone(params);delete minimal_params.available_paying_addresses,minimal_params.minimal=!0,minimal_params.paying_addresses=arrFundedPayingAddresses,composeJoint(minimal_params)})}function composeAndSaveMinimalJoint(params){var params_with_save=_.clone(params);params_with_save.callbacks=getSavingCallbacks(params.callbacks),composeMinimalJoint(params_with_save)}function getSavingCallbacks(callbacks){return{ifError:callbacks.ifError,ifNotEnoughFunds:callbacks.ifNotEnoughFunds,ifOk:function(objJoint,assocPrivatePayloads,composer_unlock){var objUnit=objJoint.unit,unit=objUnit.unit;validation.validate(objJoint,{ifUnitError:function(err){composer_unlock(),callbacks.ifError("Validation error: "+err)},ifJointError:function(err){throw Error("unexpected validation joint error: "+err)},ifTransientError:function(err){throw Error("unexpected validation transient error: "+err)},ifNeedHashTree:function(){throw Error("unexpected need hash tree")},ifNeedParentUnits:function(arrMissingUnits){throw Error("unexpected dependencies: "+arrMissingUnits.join(", "))},ifOk:function(objValidationState,validation_unlock){return console.log("base asset OK "+objValidationState.sequence),"good"!==objValidationState.sequence?(validation_unlock(),composer_unlock(),callbacks.ifError("Bad sequence "+objValidationState.sequence)):void postJointToLightVendorIfNecessaryAndSave(objJoint,function(err){console.log("failed to post base payment "+unit);var eventBus=require("./event_bus.js");err.match(/signature/)&&eventBus.emit("nonfatal_error","failed to post unit "+unit+": "+err+"; "+JSON.stringify(objUnit),new Error),validation_unlock(),composer_unlock(),callbacks.ifError(err)},function(){writer.saveJoint(objJoint,objValidationState,null,function(){console.log("saved unit "+unit),validation_unlock(),composer_unlock(),callbacks.ifOk(objJoint,assocPrivatePayloads)})})}})}}}function postJointToLightVendorIfNecessaryAndSave(objJoint,onLightError,save){if(conf.bLight){var network=require("./network.js");network.postJointToLightVendor(objJoint,function(response){"accepted"===response?save():onLightError(response.error)})}else save()}function composeAndSavePaymentJoint(arrFromAddresses,arrOutputs,signer,callbacks){composePaymentJoint(arrFromAddresses,arrOutputs,signer,getSavingCallbacks(callbacks))}function getMessageIndexByPayloadHash(objUnit,payload_hash){for(var i=0;i<objUnit.messages.length;i++)if(objUnit.messages[i].payload_hash===payload_hash)return i;throw Error("message not found by payload hash "+payload_hash)}function generateBlinding(){return crypto.randomBytes(12).toString("base64")}var crypto=require("crypto"),async=require("async"),db=require("./db.js"),constants=require("./constants.js"),objectHash=require("./object_hash.js"),objectLength=require("./object_length.js"),ecdsaSig=require("./signature.js"),mutex=require("./mutex.js"),_=require("lodash"),storage=require("./storage.js"),myWitnesses=require("./my_witnesses.js"),parentComposer=require("./parent_composer.js"),paid_witnessing=require("./paid_witnessing.js"),headers_commission=require("./headers_commission.js"),mc_outputs=require("./mc_outputs.js"),validation=require("./validation.js"),writer=require("./writer.js"),conf=require("./conf.js"),TRANSFER_INPUT_SIZE=(require("./profiler.js"),60),HEADERS_COMMISSION_INPUT_SIZE=34,WITNESSING_INPUT_SIZE=26,ADDRESS_SIZE=32,hash_placeholder="--------------------------------------------",bGenesis=!1;exports.setGenesis=function(_bGenesis){bGenesis=_bGenesis};var TYPICAL_FEE=1e3,MAX_FEE=2e4;exports.composePaymentAndTextJoint=composePaymentAndTextJoint,exports.composeTextJoint=composeTextJoint,exports.composePaymentJoint=composePaymentJoint,exports.composeDefinitionChangeJoint=composeDefinitionChangeJoint,exports.composeDataFeedJoint=composeDataFeedJoint,exports.composeDataJoint=composeDataJoint,exports.composeDedinitionTemplateJoint=composeDedinitionTemplateJoint,exports.composePollJoint=composePollJoint,exports.composeVoteJoint=composeVoteJoint,exports.composeProfileJoint=composeProfileJoint,exports.composeAttestationJoint=composeAttestationJoint,exports.composeAssetDefinitionJoint=composeAssetDefinitionJoint,exports.composeAssetAttestorsJoint=composeAssetAttestorsJoint,exports.composeJoint=composeJoint,exports.filterMostFundedAddresses=filterMostFundedAddresses,exports.readSortedFundedAddresses=readSortedFundedAddresses,exports.composeAndSaveMinimalJoint=composeAndSaveMinimalJoint,exports.sortOutputs=sortOutputs,exports.getSavingCallbacks=getSavingCallbacks,exports.postJointToLightVendorIfNecessaryAndSave=postJointToLightVendorIfNecessaryAndSave,exports.composeAndSavePaymentJoint=composeAndSavePaymentJoint,exports.generateBlinding=generateBlinding,exports.getMessageIndexByPayloadHash=getMessageIndexByPayloadHash,exports.pickDivisibleCoinsForAmount=pickDivisibleCoinsForAmount},{"./conf.js":370,"./constants.js":371,"./db.js":372,"./event_bus.js":378,"./headers_commission.js":380,"./mc_outputs.js":386,"./mutex.js":388,"./my_witnesses.js":389,"./network.js":391,"./object_hash.js":392,"./object_length.js":393,"./paid_witnessing.js":395,"./parent_composer.js":396,"./profiler.js":398,"./signature.js":399,"./storage.js":402,"./validation.js":404,"./writer.js":411,async:26,crypto:181,lodash:271,util:418}],370:[function(require,module,exports){(function(process,__dirname){"use strict";function mergeExports(anotherModule){for(var key in anotherModule)exports[key]=anotherModule[key]}if(require("./enforce_singleton.js"),exports.port=null,exports.WS_PROTOCOL="wss://",exports.MAX_INBOUND_CONNECTIONS=100,exports.MAX_OUTBOUND_CONNECTIONS=100,exports.MAX_TOLERATED_INVALID_RATIO=.1,exports.MIN_COUNT_GOOD_PEERS=10,exports.bWantNewPeers=!0,exports.bIgnoreUnpairRequests=!1,exports.storage="sqlite",process.browser&&(exports.storage="sqlite",exports.bLight=!0),exports.database={},"undefined"==typeof window||!window.cordova){var desktopApp=require("./desktop_app.js"),appRootDir=desktopApp.getAppRootDir(),appPackageJson=require(appRootDir+"/package.json");if(exports.program=appPackageJson.name,exports.program_version=appPackageJson.version,appRootDir!==__dirname)try{mergeExports(require(appRootDir+"/conf.js")),console.log("merged app root conf from "+appRootDir+"/conf.js")}catch(e){console.log("not using app root conf: "+e)}else console.log("I'm already at the root");var appDataDir=desktopApp.getAppDataDir();try{mergeExports(require(appDataDir+"/conf.json")),
console.log("merged user conf from "+appDataDir+"/conf.json")}catch(e){console.log("not using user conf: "+e)}}"mysql"===exports.storage?(exports.database.max_connections=exports.database.max_connections||30,exports.database.host=exports.database.host||"localhost",exports.database.name=exports.database.name||"trustnote",exports.database.user=exports.database.user||"trustnote"):"sqlite"===exports.storage&&(exports.database.max_connections=exports.database.max_connections||1,exports.database.filename=exports.database.filename||(exports.bLight?"trustnote-light.sqlite":"trustnote.sqlite"))}).call(this,require("_process"),"/node_modules/trustnote-common")},{"./enforce_singleton.js":377,_process:309}],371:[function(require,module,exports){"use strict";exports.COUNT_WITNESSES=12,exports.MAX_WITNESS_LIST_MUTATIONS=1,exports.TOTAL_WHITEBYTES=5e14,exports.MAJORITY_OF_WITNESSES=exports.COUNT_WITNESSES%2===0?exports.COUNT_WITNESSES/2+1:Math.ceil(exports.COUNT_WITNESSES/2),exports.COUNT_MC_BALLS_FOR_PAID_WITNESSING=100,exports.version="1.0",exports.alt="1",exports.GENESIS_UNIT="rg1RzwKwnfRHjBojGol3gZaC5w7kR++rOR6O61JRsrQ=",exports.BLACKBYTES_ASSET="9qQId3BlWRQHvVy+STWyLKFb3lUd0xfQhX6mPVEHC2c=",exports.HASH_LENGTH=44,exports.PUBKEY_LENGTH=44,exports.SIG_LENGTH=88,exports.MAX_AUTHORS_PER_UNIT=16,exports.MAX_PARENTS_PER_UNIT=16,exports.MAX_MESSAGES_PER_UNIT=128,exports.MAX_SPEND_PROOFS_PER_MESSAGE=128,exports.MAX_INPUTS_PER_PAYMENT_MESSAGE=128,exports.MAX_OUTPUTS_PER_PAYMENT_MESSAGE=128,exports.MAX_CHOICES_PER_POLL=128,exports.MAX_DENOMINATIONS_PER_ASSET_DEFINITION=64,exports.MAX_ATTESTORS_PER_ASSET=64,exports.MAX_DATA_FEED_NAME_LENGTH=64,exports.MAX_DATA_FEED_VALUE_LENGTH=64,exports.MAX_AUTHENTIFIER_LENGTH=4096,exports.MAX_CAP=9e15,exports.MAX_COMPLEXITY=100},{}],372:[function(require,module,exports){"use strict";function executeInTransaction(doWork,onDone){module.exports.takeConnectionFromPool(function(conn){conn.query("BEGIN",function(){doWork(conn,function(err){conn.query(err?"ROLLBACK":"COMMIT",function(){conn.release(),onDone(err)})})})})}var conf=require("./conf.js");if("mysql"===conf.storage){var mysql=require("mysql"),mysql_pool_constructor=require("./mysql_pool.js"),pool=mysql.createPool({connectionLimit:conf.database.max_connections,host:conf.database.host,user:conf.database.user,password:conf.database.password,charset:"UTF8_UNICODE_CI",database:conf.database.name});module.exports=mysql_pool_constructor(pool)}else if("sqlite"===conf.storage){var sqlitePool=require("./sqlite_pool.js");module.exports=sqlitePool(conf.database.filename,conf.database.max_connections,conf.database.bReadOnly)}module.exports.executeInTransaction=executeInTransaction},{"./conf.js":370,"./mysql_pool.js":390,"./sqlite_pool.js":401,mysql:void 0}],373:[function(require,module,exports){"use strict";function validateDefinition(conn,arrDefinition,objUnit,objValidationState,bAssetCondition,handleResult){function getFilterError(filter){if(!filter)return"no filter";if(hasFieldsExcept(filter,["what","asset","type","own_funds","address","amount","amount_at_least","amount_at_most"]))return"unknown fields in filter";if("input"!==filter.what&&"output"!==filter.what)return"invalid what="+filter.what;if(bAssetCondition&&"this asset"===filter.asset&&objValidationState.bDefiningPrivateAsset)return"private asset cannot reference itself";if("asset"in filter&&!("base"===filter.asset||isStringOfLength(filter.asset,constants.HASH_LENGTH)||bAssetCondition&&"this asset"===filter.asset))return"invalid asset: "+filter.asset;if("output"===filter.what){if("type"in filter)return"output canot have type";if("own_funds"in filter)return"output canot have own_funds"}return bAssetCondition&&"own_funds"in filter?"asset condition cannot be filtered by own_funds":"type"in filter&&"issue"!==filter.type&&"transfer"!==filter.type?"invalid type: "+filter.type:"own_funds"in filter&&"boolean"!=typeof filter.own_funds?"own_funds must be boolean":bAssetCondition&&"this address"===filter.address?"asset condition cannot reference this address":"address"in filter&&!isValidAddress(filter.address)&&"this address"!==filter.address?"invalid address: "+filter.address:"amount"in filter&&!isPositiveInteger(filter.amount)?"amount must be positive int":"amount_at_least"in filter&&!isPositiveInteger(filter.amount_at_least)?"amount_at_least must be positive int":"amount_at_most"in filter&&!isPositiveInteger(filter.amount_at_most)?"amount_at_most must be positive int":filter.amount&&(filter.amount_at_least||filter.amount_at_most)?"can't have amount and amount_at_least/most at the same time":null}function determineIfAnyOfAssetsIsPrivate(arrAssets,cb){return 0===arrAssets.length?cb(!1):void conn.query("SELECT 1 FROM assets WHERE unit IN(?) AND is_private=1 LIMIT 1",[arrAssets],function(rows){cb(rows.length>0)})}function evaluate(arr,bInNegation,cb){if(complexity++,complexity>constants.MAX_COMPLEXITY)return cb("complexity exceeded");if(!isArrayOfLength(arr,2))return cb("expression must be 2-element array");var op=arr[0],args=arr[1];switch(op){case"or":case"and":if(!Array.isArray(args))return cb(op+" args must be array");if(args.length<2)return cb(op+" must have at least 2 options");var count_options_with_sig=0;async.eachSeries(args,function(arg,cb2){evaluate(arg,bInNegation,function(err,bHasSig){return err?cb2(err):(bHasSig&&count_options_with_sig++,void cb2())})},function(err){return err?cb(err):void cb(null,"and"===op&&count_options_with_sig>0||"or"===op&&count_options_with_sig===args.length)});break;case"r of set":if(hasFieldsExcept(args,["required","set"]))return cb("unknown fields in "+op);if(!isPositiveInteger(args.required))return cb("required must be positive");if(!Array.isArray(args.set))return cb("set must be array");if(args.set.length<2)return cb("set must have at least 2 options");if(args.required>args.set.length)return cb("required must be <= than set length");var count_options_with_sig=0;async.eachSeries(args.set,function(arg,cb2){evaluate(arg,bInNegation,function(err,bHasSig){return err?cb2(err):(bHasSig&&count_options_with_sig++,void cb2())})},function(err){if(err)return cb(err);var count_options_without_sig=args.set.length-count_options_with_sig;cb(null,args.required>count_options_without_sig)});break;case"weighted and":if(hasFieldsExcept(args,["required","set"]))return cb("unknown fields in "+op);if(!isPositiveInteger(args.required))return cb("required must be positive");if(!Array.isArray(args.set))return cb("set must be array");if(args.set.length<2)return cb("set must have at least 2 options");var weight_of_options_with_sig=0,total_weight=0;async.eachSeries(args.set,function(arg,cb2){return hasFieldsExcept(arg,["value","weight"])?cb2("unknown fields in weighted set element"):isPositiveInteger(arg.weight)?(total_weight+=arg.weight,void evaluate(arg.value,bInNegation,function(err,bHasSig){return err?cb2(err):(bHasSig&&(weight_of_options_with_sig+=arg.weight),void cb2())})):cb2("weight must be positive int")},function(err){if(err)return cb(err);if(args.required>total_weight)return cb("required must be <= than total weight");var weight_of_options_without_sig=total_weight-weight_of_options_with_sig;cb(null,args.required>weight_of_options_without_sig)});break;case"sig":return bInNegation?cb(op+" cannot be negated"):bAssetCondition?cb("asset condition cannot have "+op):hasFieldsExcept(args,["algo","pubkey"])?cb("unknown fields in "+op):"secp256k1"===args.algo?cb("default algo must not be explicitly specified"):"algo"in args&&"secp256k1"!==args.algo?cb("unsupported sig algo"):isStringOfLength(args.pubkey,constants.PUBKEY_LENGTH)?cb(null,!0):cb("wrong pubkey length");case"hash":return bInNegation?cb(op+" cannot be negated"):bAssetCondition?cb("asset condition cannot have "+op):hasFieldsExcept(args,["algo","hash"])?cb("unknown fields in "+op):"sha256"===args.algo?cb("default algo must not be explicitly specified"):"algo"in args&&"sha256"!==args.algo?cb("unsupported hash algo"):ValidationUtils.isValidBase64(args.hash,constants.HASH_LENGTH)?cb():cb("wrong base64 hash");case"address":if(objValidationState.bNoReferences)return cb("no references allowed in address definition");if(bInNegation)return cb(op+" cannot be negated");if(bAssetCondition)return cb("asset condition cannot have "+op);var other_address=args;if(!isValidAddress(other_address))return cb("invalid address");storage.readDefinitionByAddress(conn,other_address,objValidationState.last_ball_mci,{ifFound:function(arrInnerAddressDefinition){console.log("inner address:",arrInnerAddressDefinition),evaluate(arrInnerAddressDefinition,bInNegation,cb)},ifDefinitionNotFound:function(definition_chash){var bAllowUnresolvedInnerDefinitions=!("1.0t"===constants.version&&"1"===constants.alt),arrDefiningAuthors=objUnit.authors.filter(function(author){return author.address===other_address&&objectHash.getChash160(author.definition)===definition_chash});if(0===arrDefiningAuthors.length)return bAllowUnresolvedInnerDefinitions?cb(null,!0):cb("definition of inner address "+other_address+" not found");if(arrDefiningAuthors.length>1)throw"more than 1 address definition";var arrInnerAddressDefinition=arrDefiningAuthors[0].definition;evaluate(arrInnerAddressDefinition,bInNegation,cb)}});break;case"definition template":if(objValidationState.bNoReferences)return cb("no references allowed in address definition");if(!isArrayOfLength(args,2))return cb("2-element array expected in "+op);var unit=args[0],params=args[1];if(!isStringOfLength(unit,constants.HASH_LENGTH))return cb("unit must be 44 bytes long");if(!ValidationUtils.isNonemptyObject(params))return cb("params must be non-empty object");for(var key in params)if("string"!=typeof params[key]&&"number"!=typeof params[key])return cb("each param must be string or number");conn.query("SELECT payload FROM messages JOIN units USING(unit) \n\t\t\t\t\tWHERE unit=? AND app='definition_template' AND main_chain_index<=? AND +sequence='good' AND is_stable=1",[unit,objValidationState.last_ball_mci],function(rows){if(1!==rows.length)return cb("template not found or too many");var template=rows[0].payload,arrTemplate=JSON.parse(template);try{var arrFilledTemplate=replaceInTemplate(arrTemplate,params);console.log(require("util").inspect(arrFilledTemplate,{depth:null}))}catch(e){if(e instanceof NoVarException)return cb(e.toString());throw e}evaluate(arrFilledTemplate,bInNegation,cb)});break;case"seen address":return objValidationState.bNoReferences?cb("no references allowed in address definition"):isValidAddress(args)?cb():cb("invalid seen address");case"seen definition change":case"has definition change":if(objValidationState.bNoReferences)return cb("no references allowed in address definition");if(!isArrayOfLength(args,2))return cb(op+" must have 2 args");var changed_address=args[0],new_definition_chash=args[1];return!bAssetCondition||"this address"!==changed_address&&"this address"!==new_definition_chash?isValidAddress(changed_address)||"this address"===changed_address?isValidAddress(new_definition_chash)||"this address"===new_definition_chash?cb():cb("invalid new definition chash"):cb("invalid changed address"):cb("asset condition cannot reference this address in "+op);case"cosigned by":return bInNegation?cb(op+" cannot be negated"):isValidAddress(args)?cb():cb("invalid cosigner address");case"not":evaluate(args,!0,cb);break;case"in data feed":if(objValidationState.bNoReferences)return cb("no references allowed in address definition");if(!Array.isArray(args))return cb(op+" arg must be array");if(4!==args.length&&5!==args.length)return cb(op+" must have 4 or 5 args");var arrAddresses=args[0],feed_name=args[1],relation=args[2],value=args[3],min_mci=args[4];if(!isNonemptyArray(arrAddresses))return cb("no addresses in "+op);for(var i=0;i<arrAddresses.length;i++)if(!isValidAddress(arrAddresses[i]))return cb("address "+arrAddresses[i]+" not valid");if(complexity+=arrAddresses.length-1,!isNonemptyString(relation))return cb("no relation");if(["=",">","<",">=","<=","!="].indexOf(relation)===-1)return cb("invalid relation: "+relation);if(!isNonemptyString(feed_name))return cb("no feed_name");if(feed_name.length>constants.MAX_DATA_FEED_NAME_LENGTH)return cb("feed_name too long");if("string"==typeof value){if(!isNonemptyString(value))return cb("no value");if(value.length>constants.MAX_DATA_FEED_VALUE_LENGTH)return cb("value too long")}else{if("number"!=typeof value)return cb("invalid value");if(!isInteger(value))return cb("no fractional values allowed")}return"undefined"==typeof min_mci||isNonnegativeInteger(min_mci)?cb():cb(op+": invalid min_mci");case"in merkle":if(bInNegation)return cb(op+" cannot be negated");if(objValidationState.bNoReferences)return cb("no references allowed in address definition");if(bAssetCondition)return cb("asset condition cannot have "+op);if(!Array.isArray(args))return cb(op+" arg must be array");if(3!==args.length&&4!==args.length)return cb(op+" must have 3 or 4 args");var arrAddresses=args[0],feed_name=args[1],element=args[2],min_mci=args[3];if(!isNonemptyArray(arrAddresses))return cb("no addresses in "+op);for(var i=0;i<arrAddresses.length;i++)if(!isValidAddress(arrAddresses[i]))return cb("address "+arrAddresses[i]+" not valid");return complexity+=arrAddresses.length-1,isNonemptyString(feed_name)?feed_name.length>constants.MAX_DATA_FEED_NAME_LENGTH?cb("feed_name too long"):element.match(/[\w ~,.\/\\;:!@#$%^&*\(\)=+\[\]\{\}<>\?|-]{1,100}/)?"undefined"==typeof min_mci||isNonnegativeInteger(min_mci)?cb():cb(op+": invalid min_mci"):cb("incorrect format of merkled element"):cb("no feed_name");case"mci":case"age":var relation=args[0],value=args[1];if(!isNonemptyString(relation))return cb("no relation");if(["=",">","<",">=","<=","!="].indexOf(relation)===-1)return cb("invalid relation: "+relation);if(!isNonnegativeInteger(value))return cb(op+" must be a non-neg number");break;case"has":case"has one":case"seen":if(objValidationState.bNoReferences)return cb("no references allowed in address definition");var err=getFilterError(args);if(err)return cb(err);if("seen"===op){if(!args.address)return cb("seen must specify address");if("input"===args.what&&(args.amount||args.amount_at_least||args.amount_at_most))return cb("amount not allowed in seen input");if("own_funds"in args)return cb("own_funds not allowed in seen")}if(!args.asset||"base"===args.asset||bAssetCondition&&"this asset"===args.asset)return cb();determineIfAnyOfAssetsIsPrivate([args.asset],function(bPrivate){return bPrivate?cb("asset must be public"):void cb()});break;case"has equal":case"has one equal":if(objValidationState.bNoReferences)return cb("no references allowed in address definition");if(hasFieldsExcept(args,["equal_fields","search_criteria"]))return cb("unknown fields in "+op);if(!isNonemptyArray(args.equal_fields))return cb("no equal_fields");for(var assocUsedFields={},i=0;i<args.equal_fields.length;i++){var field=args.equal_fields[i];if(assocUsedFields[field])return cb("duplicate "+field);if(assocUsedFields[field]=!0,["asset","address","amount","type"].indexOf(field)===-1)return cb("unknown field: "+field)}if(!isArrayOfLength(args.search_criteria,2))return cb("search_criteria must be 2-elements array");for(var arrAssets=[],i=0;i<2;i++){var filter=args.search_criteria[i],err=getFilterError(filter);if(err)return cb(err);filter.asset||"base"===filter.asset||bAssetCondition&&"this asset"===filter.asset||arrAssets.push(filter.asset)}if(args.equal_fields.indexOf("type")>=0&&("output"===args.search_criteria[0].what||"output"===args.search_criteria[1].what))return cb("outputs cannot have type");if(0===arrAssets.length)return cb();determineIfAnyOfAssetsIsPrivate(arrAssets,function(bPrivate){bPrivate?cb("all assets must be public"):cb()});break;case"sum":if(objValidationState.bNoReferences)return cb("no references allowed in address definition");if(hasFieldsExcept(args,["filter","equals","at_least","at_most"]))return cb("unknown fields in "+op);var err=getFilterError(args.filter);if(err)return cb(err);if(args.filter.amount||args.filter.amount_at_least||args.filter.amount_at_most)return cb("sum filter cannot restrict amounts");if("equals"in args&&!isNonnegativeInteger(args.equals))return cb("equals must be nonnegative int");if("at_least"in args&&!isPositiveInteger(args.at_least))return cb("at_least must be positive int");if("at_most"in args&&!isPositiveInteger(args.at_most))return cb("at_most must be positive int");if("equals"in args&&("at_least"in args||"at_most"in args))return cb("can't have equals and at_least/at_most at the same time");if(!("equals"in args||"at_least"in args||"at_most"in args))return cb("at least one of equals, at_least, at_most must be specified");if(!args.filter.asset||"base"===args.filter.asset||bAssetCondition&&"this asset"===args.filter.asset)return cb();determineIfAnyOfAssetsIsPrivate([args.filter.asset],function(bPrivate){bPrivate?cb("asset must be public"):cb()});break;default:return cb("unknown op: "+op)}}var complexity=0;evaluate(arrDefinition,!1,function(err,bHasSig){return err?handleResult(err):bHasSig||bAssetCondition?complexity>constants.MAX_COMPLEXITY?handleResult("complexity exceeded"):void handleResult():handleResult("each branch must have a signature")})}function evaluateAssetCondition(conn,asset,arrDefinition,objUnit,objValidationState,cb){validateAuthentifiers(conn,null,asset,arrDefinition,objUnit,objValidationState,null,cb)}function validateAuthentifiers(conn,address,this_asset,arrDefinition,objUnit,objValidationState,assocAuthentifiers,cb){function evaluate(arr,path,cb2){var op=arr[0],args=arr[1];switch(op){case"or":var res=!1,index=-1;async.eachSeries(args,function(arg,cb3){index++,evaluate(arg,path+"."+index,function(arg_res){res=res||arg_res,cb3()})},function(){cb2(res)});break;case"and":var res=!0,index=-1;async.eachSeries(args,function(arg,cb3){index++,evaluate(arg,path+"."+index,function(arg_res){res=res&&arg_res,cb3()})},function(){cb2(res)});break;case"r of set":var count=0,index=-1;async.eachSeries(args.set,function(arg,cb3){index++,evaluate(arg,path+"."+index,function(arg_res){arg_res&&count++,cb3()})},function(){cb2(count>=args.required)});break;case"weighted and":var weight=0,index=-1;async.eachSeries(args.set,function(arg,cb3){index++,evaluate(arg.value,path+"."+index,function(arg_res){arg_res&&(weight+=arg.weight),cb3()})},function(){cb2(weight>=args.required)});break;case"sig":var signature=assocAuthentifiers[path];if(!signature)return cb2(!1);arrUsedPaths.push(path);var algo=args.algo||"secp256k1";if("secp256k1"===algo){if(objValidationState.bUnsigned&&"-"===signature[0])return cb2(!0);var res=ecdsaSig.verify(objValidationState.unit_hash_to_sign,signature,args.pubkey);res||(fatal_error="bad signature at path "+path),cb2(res)}break;case"hash":if(!assocAuthentifiers[path])return cb2(!1);arrUsedPaths.push(path);var algo=args.algo||"sha256";if("sha256"===algo){var res=args.hash===crypto.createHash("sha256").update(assocAuthentifiers[path],"utf8").digest("base64");res||(fatal_error="bad hash at path "+path),cb2(res)}break;case"address":var other_address=args;storage.readDefinitionByAddress(conn,other_address,objValidationState.last_ball_mci,{ifFound:function(arrInnerAddressDefinition){evaluate(arrInnerAddressDefinition,path,cb2)},ifDefinitionNotFound:function(definition_chash){var arrDefiningAuthors=objUnit.authors.filter(function(author){return author.address===other_address&&author.definition&&objectHash.getChash160(author.definition)===definition_chash});if(0===arrDefiningAuthors.length)return cb2(!1);if(arrDefiningAuthors.length>1)throw"more than 1 address definition";var arrInnerAddressDefinition=arrDefiningAuthors[0].definition;evaluate(arrInnerAddressDefinition,path,cb2)}});break;case"definition template":var unit=args[0],params=args[1];conn.query("SELECT payload FROM messages JOIN units USING(unit) \n\t\t\t\t\tWHERE unit=? AND app='definition_template' AND main_chain_index<=? AND +sequence='good' AND is_stable=1",[unit,objValidationState.last_ball_mci],function(rows){if(1!==rows.length)throw"not 1 template";var template=rows[0].payload,arrTemplate=JSON.parse(template),arrFilledTemplate=replaceInTemplate(arrTemplate,params);evaluate(arrFilledTemplate,path,cb2)});break;case"seen address":var seen_address=args;conn.query("SELECT 1 FROM unit_authors CROSS JOIN units USING(unit) \n\t\t\t\t\tWHERE address=? AND main_chain_index<=? AND sequence='good' AND is_stable=1 \n\t\t\t\t\tLIMIT 1",[seen_address,objValidationState.last_ball_mci],function(rows){cb2(rows.length>0)});break;case"seen definition change":var changed_address=args[0],new_definition_chash=args[1];"this address"===changed_address&&(changed_address=address),"this address"===new_definition_chash&&(new_definition_chash=address),conn.query("SELECT 1 FROM address_definition_changes CROSS JOIN units USING(unit) \n\t\t\t\t\tWHERE address=? AND definition_chash=? AND main_chain_index<=? AND sequence='good' AND is_stable=1 \n\t\t\t\t\tLIMIT 1",[changed_address,new_definition_chash,objValidationState.last_ball_mci],function(rows){cb2(rows.length>0)});break;case"seen":var filter=args,sql="SELECT 1 FROM "+filter.what+"s CROSS JOIN units USING(unit) \n\t\t\t\t\tLEFT JOIN assets ON asset=assets.unit \n\t\t\t\t\tWHERE main_chain_index<=? AND sequence='good' AND is_stable=1 AND (asset IS NULL OR is_private=0) ",params=[objValidationState.last_ball_mci];filter.asset&&("base"===filter.asset?sql+=" AND asset IS NULL ":(sql+=" AND asset=? ",params.push(filter.asset))),filter.type&&(sql+=" AND type=? ",params.push(filter.type)),filter.address&&(sql+=" AND address=? ",params.push("this address"===filter.address?address:filter.address)),"output"===filter.what&&(filter.amount_at_least&&(sql+=" AND amount>=? ",params.push(filter.amount_at_least)),filter.amount_at_most&&(sql+=" AND amount<=? ",params.push(filter.amount_at_most)),filter.amount&&(sql+=" AND amount=? ",params.push(filter.amount))),sql+=" LIMIT 1",conn.query(sql,params,function(rows){cb2(rows.length>0)});break;case"cosigned by":var cosigner_address=args,arrAuthorAddresses=objUnit.authors.map(function(author){return author.address});console.log(op+" "+arrAuthorAddresses.indexOf(cosigner_address)),cb2(arrAuthorAddresses.indexOf(cosigner_address)>=0);break;case"not":evaluate(args,path,function(not_res){cb2(!not_res)});break;case"in data feed":var value_condition,index,arrAddresses=args[0],feed_name=args[1],relation=args[2],value=args[3],min_mci=args[4]||0,params=[arrAddresses,feed_name];if("string"==typeof value){index="byNameStringValue";var isNumber=/^-?\d+\.?\d*$/.test(value);if(isNumber){var bForceNumericComparison=[">",">=","<","<="].indexOf(relation)>=0,plus_0=bForceNumericComparison?"+0":"";value_condition="(value"+plus_0+relation+value+" OR int_value"+relation+value+")"}else value_condition="value"+relation+"?",params.push(value)}else index="byNameIntValue",value_condition="int_value"+relation+"?",params.push(value);params.push(objValidationState.last_ball_mci,min_mci),conn.query("SELECT 1 FROM data_feeds "+db.forceIndex(index)+" CROSS JOIN units USING(unit) CROSS JOIN unit_authors USING(unit) \n\t\t\t\t\tWHERE address IN(?) AND feed_name=? AND "+value_condition+" \n\t\t\t\t\t\tAND main_chain_index<=? AND main_chain_index>=? AND sequence='good' AND is_stable=1 LIMIT 1",params,function(rows){console.log(op+" "+feed_name+" "+rows.length),cb2(rows.length>0)});break;case"in merkle":if(!assocAuthentifiers[path])return cb2(!1);arrUsedPaths.push(path);var arrAddresses=args[0],feed_name=args[1],element=args[2],min_mci=args[3]||0,serialized_proof=assocAuthentifiers[path],proof=merkle.deserializeMerkleProof(serialized_proof);if(!merkle.verifyMerkleProof(element,proof))return fatal_error="bad merkle proof at path "+path,cb2(!1);conn.query("SELECT 1 FROM data_feeds CROSS JOIN units USING(unit) JOIN unit_authors USING(unit) \n\t\t\t\t\tWHERE address IN(?) AND feed_name=? AND value=? AND main_chain_index<=? AND main_chain_index>=? AND sequence='good' AND is_stable=1 \n\t\t\t\t\tLIMIT 1",[arrAddresses,feed_name,proof.root,objValidationState.last_ball_mci,min_mci],function(rows){0===rows.length&&(fatal_error="merkle proof at path "+path+" not found"),cb2(rows.length>0)});break;case"mci":var relation=args[0],mci=args[1];switch(relation){case">":return cb2(objValidationState.last_ball_mci>mci);case">=":return cb2(objValidationState.last_ball_mci>=mci);case"<":return cb2(objValidationState.last_ball_mci<mci);case"<=":return cb2(objValidationState.last_ball_mci<=mci);case"=":return cb2(objValidationState.last_ball_mci===mci);default:throw Error("unknown relation in mci: "+relation)}break;case"age":for(var relation=args[0],age=args[1],arrSrcUnits=[],i=0;i<objUnit.messages.length;i++){var message=objUnit.messages[i];if("payment"===message.app&&message.payload)for(var inputs=message.payload.inputs,j=0;j<inputs.length;j++){var input=inputs[j];if(!input.address)throw Error("no input address");input.address===address&&arrSrcUnits.indexOf(input.unit)===-1&&arrSrcUnits.push(input.unit)}}if(0===arrSrcUnits.length)return cb2(!1);conn.query("SELECT 1 FROM units \n\t\t\t\t\tWHERE unit IN(?) AND ?"+relation+"main_chain_index AND main_chain_index<=? AND +sequence='good' AND is_stable=1",[arrSrcUnits,objValidationState.last_ball_mci-age,objValidationState.last_ball_mci],function(rows){var bSatisfies=rows.length===arrSrcUnits.length;console.log(op+" "+bSatisfies),cb2(bSatisfies)});break;case"has":case"has one":augmentMessagesAndEvaluateFilter(op,args,function(res){console.log(op+" "+res,args),cb2(res)});break;case"has equal":case"has one equal":augmentMessagesAndEvaluateFilter("has",args.search_criteria[0],function(res1,arrFirstObjects){return res1?void augmentMessagesAndEvaluateFilter("has",args.search_criteria[1],function(res2,arrSecondObjects){if(!res2)return cb2(!1);for(var count_equal_pairs=0,i=0;i<arrFirstObjects.length;i++)for(var j=0;j<arrSecondObjects.length;j++)args.equal_fields.some(function(field){return arrFirstObjects[i][field]!==arrSecondObjects[j][field]})||count_equal_pairs++;return 0===count_equal_pairs?cb2(!1):"has one equal"===op&&1===count_equal_pairs?cb2(!0):"has equal"===op&&count_equal_pairs>0?cb2(!0):void cb2(!1)}):cb2(!1)});break;case"sum":augmentMessagesAndEvaluateFilter("has",args.filter,function(res,arrFoundObjects){var sum=0;if(res)for(var i=0;i<arrFoundObjects.length;i++)sum+=arrFoundObjects[i].amount;return console.log("sum="+sum),"number"==typeof args.equals&&sum===args.equals?cb2(!0):"number"==typeof args.at_least&&sum>=args.at_least?cb2(!0):"number"==typeof args.at_most&&sum<=args.at_most?cb2(!0):void cb2(!1)});break;case"has definition change":var changed_address=args[0],new_definition_chash=args[1];"this address"===changed_address&&(changed_address=address),"this address"===new_definition_chash&&(new_definition_chash=address),cb2(objUnit.messages.some(function(message){if("address_definition_change"!==message.app)return!1;if(!message.payload)return!1;if(message.payload.definition_chash!==new_definition_chash)return!1;var address=message.payload.address||objUnit.authors[0].address;return address===changed_address}))}}function augmentMessagesAndEvaluateFilter(op,filter,handleResult){function doEvaluateFilter(){evaluateFilter(op,filter,handleResult)}!objValidationState.arrAugmentedMessages&&"input"===filter.what&&(filter.address||"own_funds"in filter||"number"==typeof filter.amount||"number"==typeof filter.amount_at_least||"number"==typeof filter.amount_at_most)?augmentMessages(doEvaluateFilter):doEvaluateFilter()}function evaluateFilter(op,filter,handleResult){var filter_address=filter.address;"this address"===filter_address&&(filter_address=address);for(var arrFoundObjects=[],i=0;i<objUnit.messages.length;i++){var message=objUnit.messages[i];if("payment"===message.app&&message.payload){var payload=message.payload;if(filter.asset)if("base"===filter.asset){if(payload.asset)continue}else if("this asset"===filter.asset){if(payload.asset!==this_asset)continue}else if(payload.asset!==filter.asset)continue;if("input"===filter.what)for(var j=0;j<payload.inputs.length;j++){var input=payload.inputs[j];if("headers_commission"!==input.type&&"witnessing"!==input.type){if(filter.type){var type=input.type||"transfer";if(type!==filter.type)continue}filter.own_funds&&objValidationState.arrAugmentedMessages[i].payload.inputs[j].address!==address||filter.own_funds===!1&&objValidationState.arrAugmentedMessages[i].payload.inputs[j].address===address||filter_address&&objValidationState.arrAugmentedMessages[i].payload.inputs[j].address!==filter_address||filter.amount&&objValidationState.arrAugmentedMessages[i].payload.inputs[j].amount!==filter.amount||filter.amount_at_least&&objValidationState.arrAugmentedMessages[i].payload.inputs[j].amount<filter.amount_at_least||filter.amount_at_most&&objValidationState.arrAugmentedMessages[i].payload.inputs[j].amount>filter.amount_at_most||arrFoundObjects.push(objValidationState.arrAugmentedMessages[i].payload.inputs[j])}}else if("output"===filter.what)for(var j=0;j<payload.outputs.length;j++){var output=payload.outputs[j];filter_address&&output.address!==filter_address||filter.amount&&output.amount!==filter.amount||filter.amount_at_least&&output.amount<filter.amount_at_least||filter.amount_at_most&&output.amount>filter.amount_at_most||arrFoundObjects.push(output)}}}return 0===arrFoundObjects.length?handleResult(!1):"has one"===op&&1===arrFoundObjects.length?handleResult(!0):"has"===op&&arrFoundObjects.length>0?handleResult(!0,arrFoundObjects):void handleResult(!1)}function augmentMessages(onDone){console.log("augmenting");var arrAuthorAddresses=objUnit.authors.map(function(author){return author.address});objValidationState.arrAugmentedMessages=_.cloneDeep(objUnit.messages),async.eachSeries(objValidationState.arrAugmentedMessages,function(message,cb3){if("payment"!==message.app||!message.payload)return cb3();var payload=message.payload;return payload.inputs?(console.log("augmenting inputs"),void async.eachSeries(payload.inputs,function(input,cb4){console.log("input",input),"issue"===input.type?(input.address||(input.address=arrAuthorAddresses[0]),cb4()):input.type?cb4():(input.type="transfer",conn.query("SELECT amount, address FROM outputs WHERE unit=? AND message_index=? AND output_index=?",[input.unit,input.message_index,input.output_index],function(rows){1===rows.length&&(console.log("src",rows[0]),input.amount=rows[0].amount,input.address=rows[0].address),cb4()}))},cb3)):cb3()},onDone)}var bAssetCondition=null===assocAuthentifiers;if(bAssetCondition&&address||!bAssetCondition&&this_asset)throw"incompatible params";var fatal_error=null,arrUsedPaths=[];validateDefinition(conn,arrDefinition,objUnit,objValidationState,bAssetCondition,function(err){return err?cb(err):void evaluate(arrDefinition,"r",function(res){return fatal_error?cb(fatal_error):bAssetCondition||arrUsedPaths.length===Object.keys(assocAuthentifiers).length?void cb(null,res):cb("some authentifiers are not used, res="+res+", used="+arrUsedPaths+", passed="+JSON.stringify(assocAuthentifiers))})})}function replaceInTemplate(arrTemplate,params){function replaceInVar(x){switch(typeof x){case"number":case"boolean":return x;case"string":if("$"!==x.charAt(0))return x;var name=x.substring(1);if(!(name in params))throw NoVarException("variable "+name+" not specified");return params[name];case"object":if(Array.isArray(x))for(var i=0;i<x.length;i++)x[i]=replaceInVar(x[i]);else for(var key in x)x[key]=replaceInVar(x[key]);return x;default:throw"unknown type"}}return replaceInVar(_.cloneDeep(arrTemplate))}function NoVarException(error){this.error=error,this.toString=function(){return this.error}}function hasReferences(arrDefinition){function evaluate(arr){var op=arr[0],args=arr[1];switch(op){case"or":case"and":for(var i=0;i<args.length;i++)if(evaluate(args[i]))return!0;return!1;case"r of set":for(var i=0;i<args.set.length;i++)if(evaluate(args.set[i]))return!0;return!1;case"weighted and":for(var i=0;i<args.set.length;i++)if(evaluate(args.set[i].value))return!0;return!1;case"sig":case"hash":case"cosigned by":
return!1;case"not":return evaluate(args);case"address":case"definition template":case"seen address":case"seen":case"in data feed":case"in merkle":case"mci":case"age":case"has":case"has one":case"has equal":case"has one equal":case"sum":return!0;default:throw"unknown op: "+op}}return evaluate(arrDefinition)}var crypto=require("crypto"),_=require("lodash"),async=require("async"),constants=require("./constants.js"),storage=require("./storage.js"),db=require("./db.js"),ecdsaSig=require("./signature.js"),merkle=require("./merkle.js"),ValidationUtils=require("./validation_utils.js"),objectHash=require("./object_hash.js"),hasFieldsExcept=ValidationUtils.hasFieldsExcept,isStringOfLength=ValidationUtils.isStringOfLength,isNonemptyString=ValidationUtils.isNonemptyString,isInteger=ValidationUtils.isInteger,isNonnegativeInteger=ValidationUtils.isNonnegativeInteger,isPositiveInteger=ValidationUtils.isPositiveInteger,isNonemptyArray=ValidationUtils.isNonemptyArray,isArrayOfLength=ValidationUtils.isArrayOfLength,isValidAddress=ValidationUtils.isValidAddress;exports.validateDefinition=validateDefinition,exports.evaluateAssetCondition=evaluateAssetCondition,exports.validateAuthentifiers=validateAuthentifiers,exports.hasReferences=hasReferences,exports.replaceInTemplate=replaceInTemplate},{"./constants.js":371,"./db.js":372,"./merkle.js":387,"./object_hash.js":392,"./signature.js":399,"./storage.js":402,"./validation_utils.js":405,async:26,crypto:181,lodash:271,util:418}],374:[function(require,module,exports){(function(process){"use strict";function getAppsDataDir(){switch(process.platform){case"win32":return process.env.LOCALAPPDATA;case"linux":return process.env.HOME+"/.config";case"darwin":return process.env.HOME+"/Library/Application Support";default:throw Error("unknown platform "+process.platform)}}function getPackageJsonDir(start_dir){try{return fs.accessSync(start_dir+"/package.json"),start_dir}catch(e){var parent_dir=path.dirname(start_dir);if("/"===parent_dir||"win32"===process.platform&&parent_dir.match(/^\w:[\/\\]/))throw Error("no package.json found");return getPackageJsonDir(parent_dir)}}function getAppRootDir(){var mainModuleDir=path.dirname(process.mainModule.paths[0]);return getPackageJsonDir(mainModuleDir)}function getAppName(){var appDir=getAppRootDir();return console.log("app dir "+appDir),require(appDir+"/package.json").name}function getAppDataDir(){return"win32"==process.platform?getAppsDataDir()+"\\"+getAppName():getAppsDataDir()+"/"+getAppName()}var fs=require("fs"),path=require("path");exports.getAppRootDir=getAppRootDir,exports.getAppDataDir=getAppDataDir}).call(this,require("_process"))},{_process:309}],375:[function(require,module,exports){(function(process,Buffer){"use strict";function getMyDevicePubKey(){if(!objMyPermanentDeviceKey||!objMyPermanentDeviceKey.pub_b64)throw Error("my device pubkey not defined");return objMyPermanentDeviceKey.pub_b64}function getMyDeviceAddress(){if(!my_device_address)throw Error("my_device_address not defined");return my_cold_device_address&&my_cold_device_address!=my_device_address?my_cold_device_address:("undefined"!=typeof window&&window&&window.cordova&&checkDeviceAddress(),my_device_address)}function uPMyColdDeviceAddress(walletId){db.query("SELECT device_address FROM extended_pubkeys WHERE wallet=?",[walletId],function(rows){setMyColdDeviceAddress(rows[0].device_address)})}function setMyColdDeviceAddress(addr){my_cold_device_address=addr}function getMyColdDeviceAddress(){if(!my_cold_device_address)throw Error("My_device_address not defined");return my_cold_device_address}function setDevicePrivateKey(priv_key){breadcrumbs.add("setDevicePrivateKey");var bChanged=!objMyPermanentDeviceKey||priv_key!==objMyPermanentDeviceKey.priv;objMyPermanentDeviceKey={priv:priv_key,pub_b64:ecdsa.publicKeyCreate(priv_key,!0).toString("base64")};var new_my_device_address=objectHash.getDeviceAddress(objMyPermanentDeviceKey.pub_b64);if(my_device_address&&my_device_address!==new_my_device_address)throw breadcrumbs.add("different device address: old "+my_device_address+", new "+new_my_device_address),Error("different device address: old "+my_device_address+", new "+new_my_device_address);breadcrumbs.add("same device addresses: "+new_my_device_address),my_device_address=new_my_device_address,network.setMyDeviceProps(my_device_address,createTempPubkeyPackage(objMyPermanentDeviceKey.pub_b64)),bChanged&&loginToHub()}function checkDeviceAddress(){if(objMyPermanentDeviceKey){var derived_my_device_address=objectHash.getDeviceAddress(objMyPermanentDeviceKey.pub_b64);if(my_device_address!==derived_my_device_address)throw breadcrumbs.add("different device address: old "+my_device_address+", derived "+derived_my_device_address),Error("different device address: old "+my_device_address+", derived "+derived_my_device_address)}}function setTempKeys(temp_priv_key,prev_temp_priv_key,fnSaveTempKeys){objMyTempDeviceKey={use_count:null,priv:temp_priv_key,pub_b64:ecdsa.publicKeyCreate(temp_priv_key,!0).toString("base64")},prev_temp_priv_key&&(objMyPrevTempDeviceKey={priv:prev_temp_priv_key,pub_b64:ecdsa.publicKeyCreate(prev_temp_priv_key,!0).toString("base64")}),saveTempKeys=fnSaveTempKeys,loginToHub()}function setDeviceAddress(device_address){if(breadcrumbs.add("setDeviceAddress: "+device_address),my_device_address&&my_device_address!==device_address)throw Error("different device address");my_device_address=device_address}function setNewDeviceAddress(device_address){breadcrumbs.add("setNewDeviceAddress: "+device_address),my_device_address=device_address}function setDeviceName(device_name){console.log("setDeviceName",device_name),my_device_name=device_name}function setDeviceHub(device_hub){console.log("setDeviceHub",device_hub);var bChanged=device_hub!==my_device_hub;my_device_hub=device_hub,bChanged&&(network.addPeer(conf.WS_PROTOCOL+device_hub),loginToHub())}function isValidPubKey(b64_pubkey){return ecdsa.publicKeyVerify(new Buffer(b64_pubkey,"base64"))}function handleChallenge(ws,challenge){console.log("handleChallenge"),ws.bLoggingIn?sendLoginCommand(ws,challenge):ws.received_challenge=challenge}function loginToHub(){return objMyPermanentDeviceKey?objMyTempDeviceKey?my_device_hub?(console.log("logging in to hub "+my_device_hub),void network.findOutboundPeerOrConnect(conf.WS_PROTOCOL+my_device_hub,function(err,ws){err||ws.bLoggedIn||(ws.received_challenge?sendLoginCommand(ws,ws.received_challenge):ws.bLoggingIn=!0,console.log("done loginToHub"))})):console.log("my_device_hub not set yet, can't log in"):console.log("objMyTempDeviceKey not set yet, can't log in"):console.log("objMyPermanentDeviceKey not set yet, can't log in")}function sendLoginCommand(ws,challenge){var objLogin={challenge:challenge,pubkey:objMyPermanentDeviceKey.pub_b64};objLogin.signature=ecdsaSig.sign(objectHash.getDeviceMessageHashToSign(objLogin),objMyPermanentDeviceKey.priv),network.sendJustsaying(ws,"hub/login",objLogin),ws.bLoggedIn=!0,sendTempPubkey(ws,objMyTempDeviceKey.pub_b64),network.initWitnessesIfNecessary(ws),resendStalledMessages()}function sendTempPubkey(ws,temp_pubkey,callbacks){callbacks||(callbacks={ifOk:function(){},ifError:function(){}}),network.sendRequest(ws,"hub/temp_pubkey",createTempPubkeyPackage(temp_pubkey),!1,function(ws,request,response){if("updated"===response)return callbacks.ifOk();var error=response.error||"unrecognized response: "+JSON.stringify(response);callbacks.ifError(error)})}function createTempPubkeyPackage(temp_pubkey){var objTempPubkey={temp_pubkey:temp_pubkey,pubkey:objMyPermanentDeviceKey.pub_b64};return objTempPubkey.signature=ecdsaSig.sign(objectHash.getDeviceMessageHashToSign(objTempPubkey),objMyPermanentDeviceKey.priv),objTempPubkey}function genPrivKey(){var privKey;do console.log("generating new priv key"),privKey=crypto.randomBytes(32);while(!ecdsa.privateKeyVerify(privKey));return privKey}function rotateTempDeviceKeyIfCouldBeAlreadyUsed(){var actual_interval=Date.now()-last_rotate_wake_ts;return last_rotate_wake_ts=Date.now(),actual_interval>TEMP_DEVICE_KEY_ROTATION_PERIOD+1e3?console.log("woke up after sleep or high load, will skip rotation"):0===objMyTempDeviceKey.use_count?console.log("the current temp key was not used yet, will not rotate"):void rotateTempDeviceKey()}function rotateTempDeviceKey(){return saveTempKeys?(console.log("will rotate temp device key"),void network.findOutboundPeerOrConnect(conf.WS_PROTOCOL+my_device_hub,function(err,ws){if(err)return console.log("will not rotate because: "+err);if(ws.readyState!==ws.OPEN)return console.log("will not rotate because connection is not open");if(!ws.bLoggedIn)return console.log("will not rotate because not logged in");var new_priv_key=genPrivKey(),objNewMyTempDeviceKey={use_count:0,priv:new_priv_key,pub_b64:ecdsa.publicKeyCreate(new_priv_key,!0).toString("base64")};saveTempKeys(new_priv_key,objMyTempDeviceKey.priv,function(err){return err?void console.log("failed to save new temp keys, canceling: "+err):(objMyPrevTempDeviceKey=objMyTempDeviceKey,objMyTempDeviceKey=objNewMyTempDeviceKey,breadcrumbs.add("rotated temp device key"),void sendTempPubkey(ws,objMyTempDeviceKey.pub_b64))})})):console.log("no saving function")}function scheduleTempDeviceKeyRotation(){bScheduledTempDeviceKeyRotation||(bScheduledTempDeviceKeyRotation=!0,console.log("will schedule rotation in 1 minute"),setTimeout(function(){mutex.lock(["from_hub"],function(unlock){console.log("will schedule rotation"),rotateTempDeviceKeyIfCouldBeAlreadyUsed(),last_rotate_wake_ts=Date.now(),setInterval(rotateTempDeviceKeyIfCouldBeAlreadyUsed,TEMP_DEVICE_KEY_ROTATION_PERIOD),unlock()})},6e4))}function deriveSharedSecret(ecdh,peer_b64_pubkey){var shared_secret_src=ecdh.computeSecret(peer_b64_pubkey,"base64"),shared_secret=crypto.createHash("sha256").update(shared_secret_src).digest().slice(0,16);return shared_secret}function decryptPackage(objEncryptedPackage){var priv_key;if(objEncryptedPackage.dh.recipient_ephemeral_pubkey===objMyTempDeviceKey.pub_b64)priv_key=objMyTempDeviceKey.priv,objMyTempDeviceKey.use_count?objMyTempDeviceKey.use_count++:objMyTempDeviceKey.use_count=1,console.log("message encrypted to temp key");else if(objMyPrevTempDeviceKey&&objEncryptedPackage.dh.recipient_ephemeral_pubkey===objMyPrevTempDeviceKey.pub_b64)priv_key=objMyPrevTempDeviceKey.priv,console.log("message encrypted to prev temp key");else{if(objEncryptedPackage.dh.recipient_ephemeral_pubkey!==objMyPermanentDeviceKey.pub_b64)return console.log("message encrypted to unknown key"),setTimeout(function(){throw Error("message encrypted to unknown key, device "+my_device_address+", len="+objEncryptedPackage.encrypted_message.length+". The error might be caused by restoring from an old backup or using the same keys on another device.")},100),null;priv_key=objMyPermanentDeviceKey.priv,console.log("message encrypted to permanent key")}var ecdh=crypto.createECDH("secp256k1");process.browser&&ecdh.generateKeys("base64","compressed"),ecdh.setPrivateKey(priv_key);var shared_secret=deriveSharedSecret(ecdh,objEncryptedPackage.dh.sender_ephemeral_pubkey),iv=new Buffer(objEncryptedPackage.iv,"base64"),decipher=crypto.createDecipheriv("aes-128-gcm",shared_secret,iv),authtag=new Buffer(objEncryptedPackage.authtag,"base64");decipher.setAuthTag(authtag);for(var enc_buf=Buffer(objEncryptedPackage.encrypted_message,"base64"),arrChunks=[],CHUNK_LENGTH=4096,offset=0;offset<enc_buf.length;offset+=CHUNK_LENGTH)arrChunks.push(decipher.update(enc_buf.slice(offset,Math.min(offset+CHUNK_LENGTH,enc_buf.length))));var decrypted1=Buffer.concat(arrChunks);arrChunks=null;var decrypted2=decipher["final"]();breadcrumbs.add("decrypted lengths: "+decrypted1.length+" + "+decrypted2.length);var decrypted_message_buf=Buffer.concat([decrypted1,decrypted2]),decrypted_message=decrypted_message_buf.toString("utf8");console.log("decrypted: "+decrypted_message);var json=JSON.parse(decrypted_message);return json.encrypted_package?(console.log("inner encryption"),decryptPackage(json.encrypted_package)):json}function readMessageInChunksFromOutbox(message_hash,len,handleMessage){function readChunk(){db.query("SELECT SUBSTR(message, ?, ?) AS chunk FROM outbox WHERE message_hash=?",[start,CHUNK_LEN,message_hash],function(rows){if(1!==rows.length)throw Error(rows.length+" msgs by hash in outbox");message+=rows[0].chunk,start+=CHUNK_LEN,start>len?handleMessage(message):readChunk()})}var CHUNK_LEN=1e6,start=1,message="";readChunk()}function resendStalledMessages(){return console.log("resending stalled messages"),objMyPermanentDeviceKey?void mutex.lockOrSkip(["stalled"],function(unlock){var bCordova="undefined"!=typeof window&&window&&window.cordova;db.query("SELECT "+(bCordova?"LENGTH(message) AS len":"message")+", message_hash, `to`, pubkey, hub \n\t\t\tFROM outbox JOIN correspondent_devices ON `to`=device_address \n\t\t\tWHERE outbox.creation_date<"+db.addTime("-1 MINUTE")+" ORDER BY outbox.creation_date",function(rows){console.log(rows.length+" stalled messages"),async.eachSeries(rows,function(row,cb){if(!row.hub)return eventBus.emit("nonfatal_error","no hub in resendStalledMessages: "+JSON.stringify(row)+", l="+rows.length,new Error("no hub")),cb();var send=function(message){var objDeviceMessage=JSON.parse(message);console.log("sending stalled "+row.message_hash),sendPreparedMessageToHub(row.hub,row.pubkey,row.message_hash,objDeviceMessage,{ifOk:cb,ifError:function(err){cb()}})};bCordova?readMessageInChunksFromOutbox(row.message_hash,row.len,send):send(row.message)},unlock)})}):console.log("objMyPermanentDeviceKey not set yet, can't resend stalled messages")}function reliablySendPreparedMessageToHub(ws,recipient_device_pubkey,json,callbacks,conn){var recipient_device_address=objectHash.getDeviceAddress(recipient_device_pubkey);console.log("will encrypt and send to "+recipient_device_address+": "+JSON.stringify(json));var objEncryptedPackage=createEncryptedPackage(json,recipient_device_pubkey),objDeviceMessage={encrypted_package:objEncryptedPackage},message_hash=objectHash.getBase64Hash(objDeviceMessage);conn=conn||db,conn.query("INSERT INTO outbox (message_hash, `to`, message) VALUES (?,?,?)",[message_hash,recipient_device_address,JSON.stringify(objDeviceMessage)],function(){callbacks&&callbacks.onSaved&&callbacks.onSaved(),sendPreparedMessageToHub(ws,recipient_device_pubkey,message_hash,json,callbacks)})}function sendPreparedMessageToHub(ws,recipient_device_pubkey,message_hash,json,callbacks){if(callbacks||(callbacks={ifOk:function(){},ifError:function(){}}),"string"==typeof ws){var hub_host=ws;network.findOutboundPeerOrConnect(conf.WS_PROTOCOL+hub_host,function(err,ws){return err?callbacks.ifError(err):void sendPreparedMessageToConnectedHub(ws,recipient_device_pubkey,message_hash,json,callbacks)})}else sendPreparedMessageToConnectedHub(ws,recipient_device_pubkey,message_hash,json,callbacks)}function sendPreparedMessageToConnectedHub(ws,recipient_device_pubkey,message_hash,json,callbacks){network.sendRequest(ws,"hub/get_temp_pubkey",recipient_device_pubkey,!1,function(ws,request,response){function handleError(error){callbacks.ifError(error),db.query("UPDATE outbox SET last_error=? WHERE message_hash=?",[error,message_hash],function(){})}if(response.error)return handleError(response.error);var objTempPubkey=response;if(!objTempPubkey.temp_pubkey||!objTempPubkey.pubkey||!objTempPubkey.signature)return handleError("missing fields in hub response");if(objTempPubkey.pubkey!==recipient_device_pubkey)return handleError("temp pubkey signed by wrong permanent pubkey");if(!ecdsaSig.verify(objectHash.getDeviceMessageHashToSign(objTempPubkey),objTempPubkey.signature,objTempPubkey.pubkey))return handleError("wrong sig under temp pubkey");var objEncryptedPackage=createEncryptedPackage(json,objTempPubkey.temp_pubkey),recipient_device_address=objectHash.getDeviceAddress(recipient_device_pubkey),objDeviceMessage={encrypted_package:objEncryptedPackage,to:recipient_device_address,pubkey:objMyPermanentDeviceKey.pub_b64};objDeviceMessage.signature=ecdsaSig.sign(objectHash.getDeviceMessageHashToSign(objDeviceMessage),objMyPermanentDeviceKey.priv),network.sendRequest(ws,"hub/deliver",objDeviceMessage,!1,function(ws,request,response){"accepted"===response?db.query("DELETE FROM outbox WHERE message_hash=?",[message_hash],function(){callbacks.ifOk()}):handleError(response.error||"unrecognized response: "+JSON.stringify(response))})})}function createEncryptedPackage(json,recipient_device_pubkey){var text=JSON.stringify(json),ecdh=crypto.createECDH("secp256k1"),sender_ephemeral_pubkey=ecdh.generateKeys("base64","compressed"),shared_secret=deriveSharedSecret(ecdh,recipient_device_pubkey);console.log(shared_secret.length);for(var iv=crypto.randomBytes(12),cipher=crypto.createCipheriv("aes-128-gcm",shared_secret,iv),arrChunks=[],CHUNK_LENGTH=2003,offset=0;offset<text.length;offset+=CHUNK_LENGTH)arrChunks.push(cipher.update(text.slice(offset,Math.min(offset+CHUNK_LENGTH,text.length)),"utf8"));arrChunks.push(cipher["final"]());var encrypted_message_buf=Buffer.concat(arrChunks);arrChunks=null;var encrypted_message=encrypted_message_buf.toString("base64"),authtag=cipher.getAuthTag(),encrypted_package={encrypted_message:encrypted_message,iv:iv.toString("base64"),authtag:authtag.toString("base64"),dh:{sender_ephemeral_pubkey:sender_ephemeral_pubkey,recipient_ephemeral_pubkey:recipient_device_pubkey}};return encrypted_package}function sendMessageToHub(ws,recipient_device_pubkey,subject,body,callbacks,conn){var json={from:my_device_address,device_hub:my_device_hub,subject:subject,body:body};if(conn=conn||db,ws)return reliablySendPreparedMessageToHub(ws,recipient_device_pubkey,json,callbacks,conn);var recipient_device_address=objectHash.getDeviceAddress(recipient_device_pubkey);conn.query("SELECT hub FROM correspondent_devices WHERE device_address=?",[recipient_device_address],function(rows){if(1!==rows.length)throw Error("no hub in correspondents");reliablySendPreparedMessageToHub(rows[0].hub,recipient_device_pubkey,json,callbacks,conn)})}function sendMessageToDevice(device_address,subject,body,callbacks,conn){conn=conn||db,conn.query("SELECT hub, pubkey FROM correspondent_devices WHERE device_address=?",[device_address],function(rows){if(1!==rows.length)throw Error("correspondent not found");sendMessageToHub(rows[0].hub,rows[0].pubkey,subject,body,callbacks,conn)})}function sendPairingMessage(hub_host,recipient_device_pubkey,pairing_secret,reverse_pairing_secret,callbacks){var body={pairing_secret:pairing_secret,device_name:my_device_name};reverse_pairing_secret&&(body.reverse_pairing_secret=reverse_pairing_secret),sendMessageToHub(hub_host,recipient_device_pubkey,"pairing",body,callbacks)}function startWaitingForPairing(handlePairingInfo){var pairing_secret=crypto.randomBytes(9).toString("base64"),pairingInfo={pairing_secret:pairing_secret,device_pubkey:objMyPermanentDeviceKey.pub_b64,device_address:my_device_address,hub:my_device_hub};db.query("INSERT INTO pairing_secrets (pairing_secret, expiry_date) VALUES(?, "+db.addTime("+1 MONTH")+")",[pairing_secret],function(){handlePairingInfo(pairingInfo)})}function handlePairingMessage(json,device_pubkey,callbacks){var body=json.body,from_address=objectHash.getDeviceAddress(device_pubkey);return ValidationUtils.isNonemptyString(body.pairing_secret)?ValidationUtils.isNonemptyString(json.device_hub)?ValidationUtils.isNonemptyString(body.device_name)?"reverse_pairing_secret"in body&&!ValidationUtils.isNonemptyString(body.reverse_pairing_secret)?callbacks.ifError("bad reverse pairing secret"):void db.query("SELECT is_permanent FROM pairing_secrets WHERE pairing_secret=? AND expiry_date > "+db.getNow(),[body.pairing_secret],function(pairing_rows){return 0===pairing_rows.length?callbacks.ifError("pairing secret not found or expired"):void db.query("INSERT "+db.getIgnore()+" INTO correspondent_devices (device_address, pubkey, hub, name, is_confirmed) VALUES (?,?,?,?,1)",[from_address,device_pubkey,json.device_hub,body.device_name],function(){db.query("UPDATE correspondent_devices SET is_confirmed=1, name=? WHERE device_address=? AND is_confirmed=0",[body.device_name,from_address],function(){eventBus.emit("paired",from_address),0===pairing_rows[0].is_permanent&&(db.query("DELETE FROM pairing_secrets WHERE pairing_secret=?",[body.pairing_secret],function(){}),eventBus.emit("paired_by_secret-"+body.pairing_secret,from_address)),body.reverse_pairing_secret&&sendPairingMessage(json.device_hub,device_pubkey,body.reverse_pairing_secret,null),callbacks.ifOk()})})}):callbacks.ifError("no device_name when pairing"):callbacks.ifError("no device_hub when pairing"):callbacks.ifError("correspondent not known and no pairing secret")}function addUnconfirmedCorrespondent(device_pubkey,device_hub,device_name,onDone){console.log("addUnconfirmedCorrespondent");var device_address=objectHash.getDeviceAddress(device_pubkey);db.query("INSERT "+db.getIgnore()+" INTO correspondent_devices (device_address, pubkey, hub, name, is_confirmed) VALUES (?,?,?,?,0)",[device_address,device_pubkey,device_hub,device_name],function(){onDone&&onDone(device_address)})}function readCorrespondents(handleCorrespondents){db.query("SELECT device_address, hub, name, my_record_pref, peer_record_pref FROM correspondent_devices ORDER BY name",function(rows){handleCorrespondents(rows)})}function readCorrespondent(device_address,handleCorrespondent){db.query("SELECT device_address, hub, name, my_record_pref, peer_record_pref FROM correspondent_devices WHERE device_address=?",[device_address],function(rows){handleCorrespondent(rows.length?rows[0]:null)})}function readCorrespondentsByDeviceAddresses(arrDeviceAddresses,handleCorrespondents){db.query("SELECT device_address, hub, name, pubkey, my_record_pref, peer_record_pref FROM correspondent_devices WHERE device_address IN(?) ORDER BY name",[arrDeviceAddresses],function(rows){handleCorrespondents(rows)})}function updateCorrespondentProps(correspondent,onDone){db.query("UPDATE correspondent_devices SET hub=?, name=?, my_record_pref=?, peer_record_pref=? WHERE device_address=?",[correspondent.hub,correspondent.name,correspondent.my_record_pref,correspondent.peer_record_pref,correspondent.device_address],function(){onDone&&onDone()})}function addIndirectCorrespondents(arrOtherCosigners,onDone){async.eachSeries(arrOtherCosigners,function(correspondent,cb){return correspondent.device_address===my_device_address?cb():void db.query("INSERT "+db.getIgnore()+" INTO correspondent_devices (device_address, hub, name, pubkey, is_indirect) VALUES(?,?,?,?,1)",[correspondent.device_address,correspondent.hub,correspondent.name,correspondent.pubkey],function(){cb()})},onDone)}function removeCorrespondentDevice(device_address,onDone){breadcrumbs.add("correspondent removed: "+device_address);var arrQueries=[];db.addQuery(arrQueries,"DELETE FROM outbox WHERE `to`=?",[device_address]),db.addQuery(arrQueries,"DELETE FROM correspondent_devices WHERE device_address=?",[device_address]),async.series(arrQueries,onDone)}function getWitnessesFromHub(cb){return console.log("getWitnessesFromHub"),my_device_hub?void network.findOutboundPeerOrConnect(conf.WS_PROTOCOL+my_device_hub,function(err,ws){return err?cb(err):void network.sendRequest(ws,"get_witnesses",null,!1,function(ws,request,response){if(response.error)return cb(response.error);var arrWitnessesFromHub=response;cb(null,arrWitnessesFromHub)})}):(console.log("getWitnessesFromHub: no hub yet"),setTimeout(function(){getWitnessesFromHub(cb)},2e3))}function requestFromHub(command,params,responseHandler){return my_device_hub?void network.findOutboundPeerOrConnect(conf.WS_PROTOCOL+my_device_hub,function(err,ws){return err?responseHandler(err):void network.sendRequest(ws,command,params,!1,function(ws,request,response){return response.error?responseHandler(response.error):void responseHandler(null,response)})}):setTimeout(function(){requestFromHub(command,params,responseHandler)},2e3)}var my_device_hub,my_device_name,my_device_address,my_cold_device_address,objMyPermanentDeviceKey,objMyTempDeviceKey,objMyPrevTempDeviceKey,saveTempKeys,crypto=require("crypto"),async=require("async"),ecdsa=require("secp256k1"),db=require("./db.js"),mutex=require("./mutex.js"),objectHash=require("./object_hash.js"),ecdsaSig=require("./signature.js"),network=require("./network.js"),eventBus=require("./event_bus.js"),ValidationUtils=require("./validation_utils.js"),conf=require("./conf.js"),breadcrumbs=require("./breadcrumbs.js"),SEND_RETRY_PERIOD=6e4,RECONNECT_TO_HUB_PERIOD=6e4,TEMP_DEVICE_KEY_ROTATION_PERIOD=36e5,bScheduledTempDeviceKeyRotation=!1;setInterval(loginToHub,RECONNECT_TO_HUB_PERIOD),eventBus.on("connected",loginToHub);var last_rotate_wake_ts=Date.now();setInterval(resendStalledMessages,SEND_RETRY_PERIOD),exports.getMyDevicePubKey=getMyDevicePubKey,exports.getMyDeviceAddress=getMyDeviceAddress,exports.uPMyColdDeviceAddress=uPMyColdDeviceAddress,exports.setMyColdDeviceAddress=setMyColdDeviceAddress,exports.getMyColdDeviceAddress=getMyColdDeviceAddress,exports.isValidPubKey=isValidPubKey,exports.genPrivKey=genPrivKey,exports.setDevicePrivateKey=setDevicePrivateKey,exports.setTempKeys=setTempKeys,exports.setDeviceAddress=setDeviceAddress,exports.setNewDeviceAddress=setNewDeviceAddress,exports.setDeviceName=setDeviceName,exports.setDeviceHub=setDeviceHub,exports.scheduleTempDeviceKeyRotation=scheduleTempDeviceKeyRotation,exports.decryptPackage=decryptPackage,exports.handleChallenge=handleChallenge,exports.loginToHub=loginToHub,exports.sendMessageToHub=sendMessageToHub,exports.sendMessageToDevice=sendMessageToDevice,exports.sendPairingMessage=sendPairingMessage,exports.startWaitingForPairing=startWaitingForPairing,exports.handlePairingMessage=handlePairingMessage,exports.addUnconfirmedCorrespondent=addUnconfirmedCorrespondent,exports.readCorrespondents=readCorrespondents,exports.readCorrespondent=readCorrespondent,exports.readCorrespondentsByDeviceAddresses=readCorrespondentsByDeviceAddresses,exports.updateCorrespondentProps=updateCorrespondentProps,exports.removeCorrespondentDevice=removeCorrespondentDevice,exports.addIndirectCorrespondents=addIndirectCorrespondents,exports.getWitnessesFromHub=getWitnessesFromHub,exports.requestFromHub=requestFromHub}).call(this,require("_process"),require("buffer").Buffer)},{"./breadcrumbs.js":365,"./conf.js":370,"./db.js":372,"./event_bus.js":378,"./mutex.js":388,"./network.js":391,"./object_hash.js":392,"./signature.js":399,"./validation_utils.js":405,_process:309,async:26,buffer:151,crypto:181,secp256k1:325}],376:[function(require,module,exports){"use strict";function validateAndSavePrivatePaymentChain(conn,arrPrivateElements,callbacks){validateAndSaveDivisiblePrivatePayment(conn,arrPrivateElements[0],callbacks)}function validateAndSaveDivisiblePrivatePayment(conn,objPrivateElement,callbacks){validateDivisiblePrivatePayment(conn,objPrivateElement,{ifError:callbacks.ifError,ifOk:function(bStable,arrAuthorAddresses){console.log("private validation OK "+bStable);for(var unit=objPrivateElement.unit,message_index=objPrivateElement.message_index,payload=objPrivateElement.payload,arrQueries=[],j=0;j<payload.outputs.length;j++){var output=payload.outputs[j];conn.addQuery(arrQueries,"INSERT INTO outputs (unit, message_index, output_index, address, amount, blinding, asset) VALUES (?,?,?,?,?,?,?)",[unit,message_index,j,output.address,parseInt(output.amount),output.blinding,payload.asset])}for(var j=0;j<payload.inputs.length;j++){var input=payload.inputs[j],type=input.type||"transfer",src_unit=input.unit,src_message_index=input.message_index,src_output_index=input.output_index,address=null,address_sql=null;"issue"===type?address=input.address||arrAuthorAddresses[0]:1===arrAuthorAddresses.length?address=arrAuthorAddresses[0]:address_sql="(SELECT address FROM outputs \t\t\t\t\t\t\tWHERE unit="+conn.escape(src_unit)+" AND message_index="+src_message_index+" \t\t\t\t\t\t\t\tAND output_index="+src_output_index+" AND address IN("+conn.escape(arrAuthorAddresses)+"))";var is_unique=bStable?1:null;conn.addQuery(arrQueries,"INSERT INTO inputs \n\t\t\t\t\t\t(unit, message_index, input_index, type, \n\t\t\t\t\t\tsrc_unit, src_message_index, src_output_index, \t\t\t\t\t\tserial_number, amount, \n\t\t\t\t\t\tasset, is_unique, address) VALUES(?,?,?,?,?,?,?,?,?,?,?,"+(address_sql||conn.escape(address))+")",[unit,message_index,j,type,src_unit,src_message_index,src_output_index,input.serial_number,input.amount,payload.asset,is_unique]),"transfer"===type&&conn.addQuery(arrQueries,"UPDATE outputs SET is_spent=1 WHERE unit=? AND message_index=? AND output_index=?",[src_unit,src_message_index,src_output_index])}async.series(arrQueries,callbacks.ifOk)}})}function validateDivisiblePrivatePayment(conn,objPrivateElement,callbacks){var unit=objPrivateElement.unit,message_index=objPrivateElement.message_index,payload=objPrivateElement.payload;return ValidationUtils.isStringOfLength(payload.asset,constants.HASH_LENGTH)?ValidationUtils.isNonemptyArray(payload.inputs)?void validation.initPrivatePaymentValidationState(conn,unit,message_index,payload,callbacks.ifError,function(bStable,objPartialUnit,objValidationState){function validateSpendProofs(sp_cb){var arrSpendProofs=[];async.eachSeries(payload.inputs,function(input,cb){if("issue"===input.type){var address=input.address||arrAuthorAddresses[0],spend_proof=objectHash.getBase64Hash({asset:payload.asset,amount:input.amount,address:address,serial_number:input.serial_number});arrSpendProofs.push({address:address,spend_proof:spend_proof}),cb()}else input.type?cb("unknown input type: "+input.type):conn.query("SELECT address, amount, blinding FROM outputs WHERE unit=? AND message_index=? AND output_index=? AND asset=?",[input.unit,input.message_index,input.output_index,payload.asset],function(rows){if(1!==rows.length)return cb("not 1 row when selecting src output");var src_output=rows[0],spend_proof=objectHash.getBase64Hash({asset:payload.asset,unit:input.unit,message_index:input.message_index,output_index:input.output_index,address:src_output.address,amount:src_output.amount,blinding:src_output.blinding});arrSpendProofs.push({address:src_output.address,spend_proof:spend_proof}),cb()})},function(err){return err?sp_cb(err):void conn.query("SELECT address, spend_proof FROM spend_proofs WHERE unit=? AND message_index=? ORDER BY spend_proof",[unit,message_index],function(rows){if(rows.length!==arrSpendProofs.length)return sp_cb("incorrect number of spend proofs");for(var i=0;i<rows.length;i++)if(rows[i].address!==arrSpendProofs[i].address||rows[i].spend_proof!==arrSpendProofs[i].spend_proof)return sp_cb("incorrect spend proof");sp_cb()})})}var arrAuthorAddresses=objPartialUnit.authors.map(function(author){return author.address}),arrFuncs=[];arrFuncs.push(validateSpendProofs),arrFuncs.push(function(cb){validation.validatePayment(conn,payload,message_index,objPartialUnit,objValidationState,cb)}),async.series(arrFuncs,function(err){console.log("162: "+err),err?callbacks.ifError(err):callbacks.ifOk(bStable,arrAuthorAddresses)})}):callbacks.ifError("no inputs"):callbacks.ifError("invalid asset in private divisible payment")}function composeDivisibleAssetPaymentJoint(params){if(console.log("asset payment from "+params.paying_addresses),(params.to_address||params.amount)&&params.asset_outputs)throw Error("to_address and asset_outputs at the same time");if(!ValidationUtils.isNonemptyArray(params.fee_paying_addresses))throw Error("no fee_paying_addresses");var private_payload,arrBaseOutputs=[{address:params.fee_paying_addresses[0],amount:0}];params.base_outputs&&(arrBaseOutputs=arrBaseOutputs.concat(params.base_outputs)),composer.composeJoint({paying_addresses:_.union(params.paying_addresses,params.fee_paying_addresses),signing_addresses:params.signing_addresses,minimal:params.minimal,outputs:arrBaseOutputs,retrieveMessages:function(conn,last_ball_mci,bMultiAuthored,arrPayingAddresses,onDone){var arrAssetPayingAddresses=_.intersection(arrPayingAddresses,params.paying_addresses);storage.loadAssetWithListOfAttestedAuthors(conn,params.asset,last_ball_mci,arrAssetPayingAddresses,function(err,objAsset){
if(err)return onDone(err);if(objAsset.fixed_denominations)return onDone("fixed denominations asset type");if(!objAsset.is_transferrable&&params.to_address!==objAsset.definer_address&&arrAssetPayingAddresses.indexOf(objAsset.definer_address)===-1)return onDone("the asset is not transferrable and definer not found on either side of the deal");if(objAsset.cosigned_by_definer&&arrPayingAddresses.concat(params.signing_addresses||[]).indexOf(objAsset.definer_address)===-1)return onDone("the asset must be cosigned by definer");if(objAsset.spender_attested&&0===objAsset.arrAttestedAddresses.length)return onDone("none of the authors is attested");var target_amount=params.to_address?params.amount:params.asset_outputs.reduce(function(accumulator,output){return accumulator+output.amount},0);composer.pickDivisibleCoinsForAmount(conn,objAsset,arrAssetPayingAddresses,last_ball_mci,target_amount,bMultiAuthored,function(arrInputsWithProofs,total_input){if(console.log("pick coins callback "+arrInputsWithProofs),!arrInputsWithProofs)return onDone({error_code:"NOT_ENOUGH_FUNDS",error:"not enough asset coins"});var arrOutputs=params.to_address?[{address:params.to_address,amount:params.amount}]:params.asset_outputs,change=total_input-target_amount;if(change>0){var objChangeOutput={address:params.change_address,amount:change};arrOutputs.push(objChangeOutput)}objAsset.is_private&&arrOutputs.forEach(function(output){output.blinding=composer.generateBlinding()}),arrOutputs.sort(composer.sortOutputs);var assocPrivatePayloads,payload={asset:params.asset,inputs:arrInputsWithProofs.map(function(objInputWithProof){return objInputWithProof.input}),outputs:arrOutputs},objMessage={app:"payment",payload_location:objAsset.is_private?"none":"inline",payload_hash:objectHash.getBase64Hash(payload)};objAsset.is_private?(objMessage.spend_proofs=arrInputsWithProofs.map(function(objInputWithProof){return objInputWithProof.spend_proof}),private_payload=payload,assocPrivatePayloads[objMessage.payload_hash]=private_payload):objMessage.payload=payload,onDone(null,[objMessage],assocPrivatePayloads)})})},signer:params.signer,callbacks:{ifError:params.callbacks.ifError,ifNotEnoughFunds:params.callbacks.ifNotEnoughFunds,ifOk:function(objJoint,assocPrivatePayloads,composer_unlock_callback){params.callbacks.ifOk(objJoint,private_payload,composer_unlock_callback)}}})}function getSavingCallbacks(callbacks){return{ifError:callbacks.ifError,ifNotEnoughFunds:callbacks.ifNotEnoughFunds,ifOk:function(objJoint,private_payload,composer_unlock){var objUnit=objJoint.unit,unit=objUnit.unit;validation.validate(objJoint,{ifUnitError:function(err){composer_unlock(),callbacks.ifError("Validation error: "+err)},ifJointError:function(err){throw Error("unexpected validation joint error: "+err)},ifTransientError:function(err){throw Error("unexpected validation transient error: "+err)},ifNeedHashTree:function(){throw Error("unexpected need hash tree")},ifNeedParentUnits:function(arrMissingUnits){throw Error("unexpected dependencies: "+arrMissingUnits.join(", "))},ifOk:function(objValidationState,validation_unlock){if(console.log("divisible asset OK "+objValidationState.sequence),"good"!==objValidationState.sequence)return validation_unlock(),composer_unlock(),callbacks.ifError("Divisible asset bad sequence "+objValidationState.sequence);var objPrivateElement,bPrivate=!!private_payload,preCommitCallback=null;bPrivate&&(preCommitCallback=function(conn,cb){var payload_hash=objectHash.getBase64Hash(private_payload),message_index=composer.getMessageIndexByPayloadHash(objUnit,payload_hash);objPrivateElement={unit:unit,message_index:message_index,payload:private_payload},validateAndSaveDivisiblePrivatePayment(conn,objPrivateElement,{ifError:function(err){cb(err)},ifOk:function(){cb()}})}),composer.postJointToLightVendorIfNecessaryAndSave(objJoint,function(err){console.log("failed to post divisible payment "+unit),validation_unlock(),composer_unlock(),callbacks.ifError(err)},function(){writer.saveJoint(objJoint,objValidationState,preCommitCallback,function(err){console.log("saved unit "+unit,objPrivateElement),validation_unlock(),composer_unlock();var arrChains=objPrivateElement?[[objPrivateElement]]:null;callbacks.ifOk(objJoint,arrChains,arrChains)})})}})}}}function composeAndSaveDivisibleAssetPaymentJoint(params){var params_with_save=_.clone(params);params_with_save.callbacks=getSavingCallbacks(params.callbacks),composeDivisibleAssetPaymentJoint(params_with_save)}function composeMinimalDivisibleAssetPaymentJoint(params){if(!ValidationUtils.isNonemptyArray(params.available_paying_addresses))throw Error("no available_paying_addresses");if(!ValidationUtils.isNonemptyArray(params.available_fee_paying_addresses))throw Error("no available_fee_paying_addresses");composer.readSortedFundedAddresses(params.asset,params.available_paying_addresses,params.amount,function(arrFundedPayingAddresses){return 0===arrFundedPayingAddresses.length?params.callbacks.ifNotEnoughFunds("all paying addresses are unfunded in asset, make sure all your funds are confirmed"):void composer.readSortedFundedAddresses(null,params.available_fee_paying_addresses,TYPICAL_FEE,function(arrFundedFeePayingAddresses){if(0===arrFundedPayingAddresses.length)return params.callbacks.ifNotEnoughFunds("all paying addresses are unfunded in asset, make sure all your funds are confirmed");var minimal_params=_.clone(params);delete minimal_params.available_paying_addresses,delete minimal_params.available_fee_paying_addresses,minimal_params.minimal=!0,minimal_params.paying_addresses=arrFundedPayingAddresses,minimal_params.fee_paying_addresses=arrFundedFeePayingAddresses,composeDivisibleAssetPaymentJoint(minimal_params)})})}function composeAndSaveMinimalDivisibleAssetPaymentJoint(params){var params_with_save=_.clone(params);params_with_save.callbacks=getSavingCallbacks(params.callbacks),composeMinimalDivisibleAssetPaymentJoint(params_with_save)}var async=require("async"),_=require("lodash"),constants=require("./constants.js"),storage=require("./storage.js"),objectHash=require("./object_hash.js"),composer=(require("./db.js"),require("./composer.js")),ValidationUtils=require("./validation_utils.js"),validation=require("./validation.js"),writer=require("./writer.js"),TYPICAL_FEE=1e3;exports.validateAndSavePrivatePaymentChain=validateAndSavePrivatePaymentChain,exports.composeAndSaveDivisibleAssetPaymentJoint=composeAndSaveDivisibleAssetPaymentJoint,exports.composeAndSaveMinimalDivisibleAssetPaymentJoint=composeAndSaveMinimalDivisibleAssetPaymentJoint},{"./composer.js":369,"./constants.js":371,"./db.js":372,"./object_hash.js":392,"./storage.js":402,"./validation.js":404,"./validation_utils.js":405,"./writer.js":411,async:26,lodash:271}],377:[function(require,module,exports){(function(global){"use strict";if(global._bTrustnoteCoreLoaded)throw Error("Looks like you are loading multiple copies of trustnote-common, which is not supported.\nRunnung 'npm dedupe' might help.");global._bTrustnoteCoreLoaded=!0}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],378:[function(require,module,exports){"use strict";require("./enforce_singleton.js");var EventEmitter=require("events").EventEmitter,eventEmitter=new EventEmitter;eventEmitter.setMaxListeners(25),module.exports=eventEmitter},{"./enforce_singleton.js":377,events:215}],379:[function(require,module,exports){"use strict";function compareUnits(conn,unit1,unit2,handleResult){return unit1===unit2?handleResult(0):void conn.query("SELECT unit, level, latest_included_mc_index, main_chain_index, is_on_main_chain, is_free FROM units WHERE unit IN(?)",[[unit1,unit2]],function(rows){if(2!==rows.length)throw Error("not 2 rows");var objUnitProps1=rows[0].unit===unit1?rows[0]:rows[1],objUnitProps2=rows[0].unit===unit2?rows[0]:rows[1];compareUnitsByProps(conn,objUnitProps1,objUnitProps2,handleResult)})}function compareUnitsByProps(conn,objUnitProps1,objUnitProps2,handleResult){function goUp(arrStartUnits){conn.query("SELECT unit, level, latest_included_mc_index, main_chain_index, is_on_main_chain \n\t\t\tFROM parenthoods JOIN units ON parent_unit=unit \n\t\t\tWHERE child_unit IN(?)",[arrStartUnits],function(rows){for(var arrNewStartUnits=[],i=0;i<rows.length;i++){var objUnitProps=rows[i];if(objUnitProps.unit===objEarlierUnit.unit)return handleResult(resultIfFound);0===objUnitProps.is_on_main_chain&&objUnitProps.level>objEarlierUnit.level&&arrNewStartUnits.push(objUnitProps.unit)}arrNewStartUnits.length>0?goUp(arrNewStartUnits):handleResult(null)})}function goDown(arrStartUnits){conn.query("SELECT unit, level, latest_included_mc_index, main_chain_index, is_on_main_chain \n\t\t\tFROM parenthoods JOIN units ON child_unit=unit \n\t\t\tWHERE parent_unit IN(?)",[arrStartUnits],function(rows){for(var arrNewStartUnits=[],i=0;i<rows.length;i++){var objUnitProps=rows[i];if(objUnitProps.unit===objLaterUnit.unit)return handleResult(resultIfFound);0===objUnitProps.is_on_main_chain&&objUnitProps.level<objLaterUnit.level&&arrNewStartUnits.push(objUnitProps.unit)}arrNewStartUnits.length>0?goDown(arrNewStartUnits):handleResult(null)})}if(objUnitProps1.unit===objUnitProps2.unit)return handleResult(0);if(objUnitProps1.level===objUnitProps2.level)return handleResult(null);if(1===objUnitProps1.is_free&&1===objUnitProps2.is_free)return handleResult(null);if(null===objUnitProps1.latest_included_mc_index)return handleResult(-1);if(null===objUnitProps2.latest_included_mc_index)return handleResult(1);if(objUnitProps1.latest_included_mc_index>=objUnitProps2.main_chain_index&&null!==objUnitProps2.main_chain_index)return handleResult(1);if(objUnitProps2.latest_included_mc_index>=objUnitProps1.main_chain_index&&null!==objUnitProps1.main_chain_index)return handleResult(-1);if(!(objUnitProps1.level<=objUnitProps2.level&&objUnitProps1.latest_included_mc_index<=objUnitProps2.latest_included_mc_index&&(objUnitProps1.main_chain_index<=objUnitProps2.main_chain_index&&null!==objUnitProps1.main_chain_index&&null!==objUnitProps2.main_chain_index||null===objUnitProps1.main_chain_index||null===objUnitProps2.main_chain_index)||objUnitProps1.level>=objUnitProps2.level&&objUnitProps1.latest_included_mc_index>=objUnitProps2.latest_included_mc_index&&(objUnitProps1.main_chain_index>=objUnitProps2.main_chain_index&&null!==objUnitProps1.main_chain_index&&null!==objUnitProps2.main_chain_index||null===objUnitProps1.main_chain_index||null===objUnitProps2.main_chain_index)))return handleResult(null);var objEarlierUnit=objUnitProps1.level<objUnitProps2.level?objUnitProps1:objUnitProps2,objLaterUnit=objUnitProps1.level<objUnitProps2.level?objUnitProps2:objUnitProps1,resultIfFound=objUnitProps1.level<objUnitProps2.level?-1:1,earlier_unit_delta=objEarlierUnit.main_chain_index-objEarlierUnit.latest_included_mc_index,later_unit_delta=objLaterUnit.main_chain_index-objLaterUnit.latest_included_mc_index;later_unit_delta>earlier_unit_delta?goUp([objLaterUnit.unit]):goDown([objEarlierUnit.unit])}function determineIfIncluded(conn,earlier_unit,arrLaterUnits,handleResult){if(!earlier_unit)throw Error("no earlier_unit");return storage.isGenesisUnit(earlier_unit)?handleResult(!0):void storage.readPropsOfUnits(conn,earlier_unit,arrLaterUnits,function(objEarlierUnitProps,arrLaterUnitProps){function goUp(arrStartUnits){conn.query("SELECT unit, level, latest_included_mc_index, main_chain_index, is_on_main_chain \n\t\t\t\tFROM parenthoods JOIN units ON parent_unit=unit \n\t\t\t\tWHERE child_unit IN(?)",[arrStartUnits],function(rows){for(var arrNewStartUnits=[],i=0;i<rows.length;i++){var objUnitProps=rows[i];if(objUnitProps.unit===earlier_unit)return handleResult(!0);0===objUnitProps.is_on_main_chain&&objUnitProps.level>objEarlierUnitProps.level&&arrNewStartUnits.push(objUnitProps.unit)}arrNewStartUnits.length>0?goUp(_.uniq(arrNewStartUnits)):handleResult(!1)})}if(1===objEarlierUnitProps.is_free)return handleResult(!1);var max_later_limci=Math.max.apply(null,arrLaterUnitProps.map(function(objLaterUnitProps){return objLaterUnitProps.latest_included_mc_index}));if(null!==objEarlierUnitProps.main_chain_index&&max_later_limci>=objEarlierUnitProps.main_chain_index)return handleResult(!0);var max_later_level=Math.max.apply(null,arrLaterUnitProps.map(function(objLaterUnitProps){return objLaterUnitProps.level}));return max_later_level<objEarlierUnitProps.level?handleResult(!1):void goUp(arrLaterUnits)})}function determineIfIncludedOrEqual(conn,earlier_unit,arrLaterUnits,handleResult){return arrLaterUnits.indexOf(earlier_unit)>=0?handleResult(!0):void determineIfIncluded(conn,earlier_unit,arrLaterUnits,handleResult)}function readDescendantUnitsByAuthorsBeforeMcIndex(conn,objEarlierUnitProps,arrAuthorAddresses,to_main_chain_index,handleUnits){function goDown(arrStartUnits){profiler.start(),conn.query("SELECT units.unit, unit_authors.address AS author_in_list \n\t\t\tFROM parenthoods \n\t\t\tJOIN units ON child_unit=units.unit \n\t\t\tLEFT JOIN unit_authors ON unit_authors.unit=units.unit AND address IN(?) \n\t\t\tWHERE parent_unit IN(?) AND latest_included_mc_index<? AND main_chain_index<=?",[arrAuthorAddresses,arrStartUnits,objEarlierUnitProps.main_chain_index,to_main_chain_index],function(rows){for(var arrNewStartUnits=[],i=0;i<rows.length;i++){var objUnitProps=rows[i];arrNewStartUnits.push(objUnitProps.unit),objUnitProps.author_in_list&&arrUnits.push(objUnitProps.unit)}profiler.stop("mc-wc-descendants-goDown"),arrNewStartUnits.length>0?goDown(arrNewStartUnits):handleUnits(arrUnits)})}var arrUnits=[];profiler.start(),conn.query("SELECT unit FROM units "+db.forceIndex("byMcIndex")+" LEFT JOIN unit_authors USING(unit) \n\t\tWHERE latest_included_mc_index>=? AND main_chain_index>? AND main_chain_index<=? AND latest_included_mc_index<? AND address IN(?)",[objEarlierUnitProps.main_chain_index,objEarlierUnitProps.main_chain_index,to_main_chain_index,to_main_chain_index,arrAuthorAddresses],function(rows){arrUnits=rows.map(function(row){return row.unit}),profiler.stop("mc-wc-descendants-initial"),goDown([objEarlierUnitProps.unit])})}function readDescendantUnitsBeforeLandingOnMc(conn,objEarlierUnitProps,arrLaterUnitProps,handleUnits){function goDown(arrStartUnits){conn.query("SELECT unit, level, latest_included_mc_index, main_chain_index, is_on_main_chain \n\t\t\tFROM parenthoods JOIN units ON child_unit=unit \n\t\t\tWHERE parent_unit IN(?) AND latest_included_mc_index<? AND level<=?",[arrStartUnits,objEarlierUnitProps.main_chain_index,max_later_level],function(rows){for(var arrNewStartUnits=[],i=0;i<rows.length;i++){var objUnitProps=rows[i];arrNewStartUnits.push(objUnitProps.unit),null!==objUnitProps.main_chain_index&&objUnitProps.main_chain_index<=max_later_limci?arrLandedUnits.push(objUnitProps.unit):arrUnlandedUnits.push(objUnitProps.unit)}arrNewStartUnits.length>0?goDown(arrNewStartUnits):handleUnits(arrLandedUnits,arrUnlandedUnits)})}var max_later_limci=Math.max.apply(null,arrLaterUnitProps.map(function(objLaterUnitProps){return objLaterUnitProps.latest_included_mc_index})),max_later_level=Math.max.apply(null,arrLaterUnitProps.map(function(objLaterUnitProps){return objLaterUnitProps.level})),arrLandedUnits=[],arrUnlandedUnits=[];goDown([objEarlierUnitProps.unit])}function readAscendantUnitsAfterTakingOffMc(conn,objEarlierUnitProps,arrLaterUnitProps,handleUnits){function goUp(arrStartUnits){conn.query("SELECT unit, level, latest_included_mc_index, main_chain_index, is_on_main_chain \n\t\t\tFROM parenthoods JOIN units ON parent_unit=unit \n\t\t\tWHERE child_unit IN(?) AND (main_chain_index>? OR main_chain_index IS NULL) AND level>=?",[arrStartUnits,max_later_limci,objEarlierUnitProps.level],function(rows){for(var arrNewStartUnits=[],i=0;i<rows.length;i++){var objUnitProps=rows[i];arrNewStartUnits.push(objUnitProps.unit),objUnitProps.latest_included_mc_index>=objEarlierUnitProps.main_chain_index?arrLandedUnits.push(objUnitProps.unit):arrUnlandedUnits.push(objUnitProps.unit)}arrNewStartUnits.length>0?goUp(arrNewStartUnits):handleUnits(arrLandedUnits,arrUnlandedUnits)})}var arrLaterUnits=arrLaterUnitProps.map(function(objLaterUnitProps){return objLaterUnitProps.unit}),max_later_limci=Math.max.apply(null,arrLaterUnitProps.map(function(objLaterUnitProps){return objLaterUnitProps.latest_included_mc_index})),arrLandedUnits=[],arrUnlandedUnits=[];arrLaterUnitProps.forEach(function(objUnitProps){objUnitProps.latest_included_mc_index>=objEarlierUnitProps.main_chain_index?arrLandedUnits.push(objUnitProps.unit):arrUnlandedUnits.push(objUnitProps.unit)}),goUp(arrLaterUnits)}var _=require("lodash"),storage=(require("async"),require("./storage.js")),db=require("./db.js"),profiler=require("./profiler.js");exports.compareUnitsByProps=compareUnitsByProps,exports.compareUnits=compareUnits,exports.determineIfIncluded=determineIfIncluded,exports.determineIfIncludedOrEqual=determineIfIncludedOrEqual,exports.readDescendantUnitsByAuthorsBeforeMcIndex=readDescendantUnitsByAuthorsBeforeMcIndex,exports.readDescendantUnitsBeforeLandingOnMc=readDescendantUnitsBeforeLandingOnMc,exports.readAscendantUnitsAfterTakingOffMc=readAscendantUnitsAfterTakingOffMc},{"./db.js":372,"./profiler.js":398,"./storage.js":402,async:26,lodash:271}],380:[function(require,module,exports){"use strict";function calcHeadersCommissions(conn,onDone){if(console.log("will calc h-comm"),null===max_spendable_mci)return initMaxSpendableMci(conn,function(){calcHeadersCommissions(conn,onDone)});var since_mc_index=max_spendable_mci;async.series([function(cb){if("mysql"===conf.storage){var best_child_sql="SELECT unit \n\t\t\t\t\tFROM parenthoods \n\t\t\t\t\tJOIN units AS alt_child_units ON parenthoods.child_unit=alt_child_units.unit \n\t\t\t\t\tWHERE parent_unit=punits.unit AND alt_child_units.main_chain_index-punits.main_chain_index<=1 AND +alt_child_units.sequence='good' \n\t\t\t\t\tORDER BY SHA1(CONCAT(alt_child_units.unit, next_mc_units.unit)) \n\t\t\t\t\tLIMIT 1";conn.query("INSERT INTO headers_commission_contributions (unit, address, amount) \n\t\t\t\t\tSELECT punits.unit, address, punits.headers_commission AS hc \n\t\t\t\t\tFROM units AS chunits \n\t\t\t\t\tJOIN unit_authors USING(unit) \n\t\t\t\t\tJOIN parenthoods ON chunits.unit=parenthoods.child_unit \n\t\t\t\t\tJOIN units AS punits ON parenthoods.parent_unit=punits.unit \n\t\t\t\t\tJOIN units AS next_mc_units ON next_mc_units.is_on_main_chain=1 AND next_mc_units.main_chain_index=punits.main_chain_index+1 \n\t\t\t\t\tWHERE chunits.is_stable=1 \n\t\t\t\t\t\tAND +chunits.sequence='good' \n\t\t\t\t\t\tAND punits.main_chain_index>? \n\t\t\t\t\t\tAND chunits.main_chain_index-punits.main_chain_index<=1 \n\t\t\t\t\t\tAND +punits.sequence='good' \n\t\t\t\t\t\tAND punits.is_stable=1 \n\t\t\t\t\t\tAND next_mc_units.is_stable=1 \n\t\t\t\t\t\tAND chunits.unit=( "+best_child_sql+" ) \n\t\t\t\t\t\tAND (SELECT COUNT(*) FROM unit_authors WHERE unit=chunits.unit)=1 \n\t\t\t\t\t\tAND (SELECT COUNT(*) FROM earned_headers_commission_recipients WHERE unit=chunits.unit)=0 \n\t\t\t\t\tUNION ALL \n\t\t\t\t\tSELECT punits.unit, earned_headers_commission_recipients.address, \n\t\t\t\t\t\tROUND(punits.headers_commission*earned_headers_commission_share/100.0) AS hc \n\t\t\t\t\tFROM units AS chunits \n\t\t\t\t\tJOIN earned_headers_commission_recipients USING(unit) \n\t\t\t\t\tJOIN parenthoods ON chunits.unit=parenthoods.child_unit \n\t\t\t\t\tJOIN units AS punits ON parenthoods.parent_unit=punits.unit \n\t\t\t\t\tJOIN units AS next_mc_units ON next_mc_units.is_on_main_chain=1 AND next_mc_units.main_chain_index=punits.main_chain_index+1 \n\t\t\t\t\tWHERE chunits.is_stable=1 \n\t\t\t\t\t\tAND +chunits.sequence='good' \n\t\t\t\t\t\tAND punits.main_chain_index>? \n\t\t\t\t\t\tAND chunits.main_chain_index-punits.main_chain_index<=1 \n\t\t\t\t\t\tAND +punits.sequence='good' \n\t\t\t\t\t\tAND punits.is_stable=1 \n\t\t\t\t\t\tAND next_mc_units.is_stable=1 \n\t\t\t\t\t\tAND chunits.unit=( "+best_child_sql+" )",[since_mc_index,since_mc_index],function(){cb()})}else conn.query("SELECT chunits.unit AS child_unit, punits.headers_commission, next_mc_units.unit AS next_mc_unit, punits.unit AS payer_unit \n\t\t\t\t\tFROM units AS chunits \n\t\t\t\t\tJOIN parenthoods ON chunits.unit=parenthoods.child_unit \n\t\t\t\t\tJOIN units AS punits ON parenthoods.parent_unit=punits.unit \n\t\t\t\t\tJOIN units AS next_mc_units ON next_mc_units.is_on_main_chain=1 AND next_mc_units.main_chain_index=punits.main_chain_index+1 \n\t\t\t\t\tWHERE chunits.is_stable=1 \n\t\t\t\t\t\tAND +chunits.sequence='good' \n\t\t\t\t\t\tAND punits.main_chain_index>? \n\t\t\t\t\t\tAND +punits.sequence='good' \n\t\t\t\t\t\tAND punits.is_stable=1 \n\t\t\t\t\t\tAND chunits.main_chain_index-punits.main_chain_index<=1 \n\t\t\t\t\t\tAND next_mc_units.is_stable=1",[since_mc_index],function(rows){var assocChildrenInfos={};rows.forEach(function(row){var payer_unit=row.payer_unit;row.child_unit;if(assocChildrenInfos[payer_unit]){if(assocChildrenInfos[payer_unit].headers_commission!==row.headers_commission)throw Error("different headers_commission")}else assocChildrenInfos[payer_unit]={headers_commission:row.headers_commission,children:[]};delete row.headers_commission,delete row.payer_unit,assocChildrenInfos[payer_unit].children.push(row)});var assocWonAmounts={};for(var payer_unit in assocChildrenInfos){var headers_commission=assocChildrenInfos[payer_unit].headers_commission,winnerChildInfo=getWinnerInfo(assocChildrenInfos[payer_unit].children),child_unit=winnerChildInfo.child_unit;assocWonAmounts[child_unit]||(assocWonAmounts[child_unit]={}),assocWonAmounts[child_unit][payer_unit]=headers_commission}var arrWinnerUnits=Object.keys(assocWonAmounts);return 0===arrWinnerUnits.length?cb():void conn.query("SELECT \n\t\t\t\t\t\t\t\tunit_authors.unit, \n\t\t\t\t\t\t\t\tunit_authors.address, \n\t\t\t\t\t\t\t\t100 AS earned_headers_commission_share \n\t\t\t\t\t\t\tFROM unit_authors \n\t\t\t\t\t\t\tLEFT JOIN earned_headers_commission_recipients USING(unit) \n\t\t\t\t\t\t\tWHERE unit_authors.unit IN(?) AND earned_headers_commission_recipients.unit IS NULL \n\t\t\t\t\t\t\tUNION ALL \n\t\t\t\t\t\t\tSELECT \n\t\t\t\t\t\t\t\tunit, \n\t\t\t\t\t\t\t\taddress, \n\t\t\t\t\t\t\t\tearned_headers_commission_share \n\t\t\t\t\t\t\tFROM earned_headers_commission_recipients \n\t\t\t\t\t\t\tWHERE unit IN(?)",[arrWinnerUnits,arrWinnerUnits],function(profit_distribution_rows){var arrValues=[];profit_distribution_rows.forEach(function(row){var child_unit=row.unit;for(var payer_unit in assocWonAmounts[child_unit]){var full_amount=assocWonAmounts[child_unit][payer_unit];if(!full_amount)throw Error("no amount for child unit "+child_unit+", payer unit "+payer_unit);var amount=100===row.earned_headers_commission_share?full_amount:Math.round(full_amount*row.earned_headers_commission_share/100);arrValues.push("('"+payer_unit+"', '"+row.address+"', "+amount+")")}}),conn.query("INSERT INTO headers_commission_contributions (unit, address, amount) VALUES "+arrValues.join(", "),function(){cb()})})})},function(cb){conn.query("INSERT INTO headers_commission_outputs (main_chain_index, address, amount) \n\t\t\t\tSELECT main_chain_index, address, SUM(amount) FROM headers_commission_contributions JOIN units USING(unit) \n\t\t\t\tWHERE main_chain_index>? \n\t\t\t\tGROUP BY main_chain_index, address",[since_mc_index],function(){cb()})},function(cb){conn.query("SELECT MAX(main_chain_index) AS max_spendable_mci FROM headers_commission_outputs",function(rows){max_spendable_mci=rows[0].max_spendable_mci,cb()})}],onDone)}function getWinnerInfo(arrChildren){return 1===arrChildren.length?arrChildren[0]:(arrChildren.forEach(function(child){child.hash=crypto.createHash("sha1").update(child.child_unit+child.next_mc_unit,"utf8").digest("hex")}),arrChildren.sort(function(a,b){return a.hash<b.hash?-1:1}),arrChildren[0])}function initMaxSpendableMci(conn,onDone){conn.query("SELECT MAX(main_chain_index) AS max_spendable_mci FROM headers_commission_outputs",function(rows){max_spendable_mci=rows[0].max_spendable_mci||0,onDone&&onDone()})}function getMaxSpendableMciForLastBallMci(last_ball_mci){return last_ball_mci-1}var crypto=require("crypto"),async=require("async"),conf=(require("./db.js"),require("./conf.js")),max_spendable_mci=null;exports.calcHeadersCommissions=calcHeadersCommissions,exports.getMaxSpendableMciForLastBallMci=getMaxSpendableMciForLastBallMci},{"./conf.js":370,"./db.js":372,async:26,crypto:181}],381:[function(require,module,exports){"use strict";function validatePrivatePayment(conn,objPrivateElement,objPrevPrivateElement,callbacks){function validateSpendProof(spend_proof,cb){profiler.start(),conn.query("SELECT spend_proof, address FROM spend_proofs WHERE unit=? AND message_index=?",[objPrivateElement.unit,objPrivateElement.message_index],function(rows){if(profiler.stop("spend_proof"),1!==rows.length)return cb("expected 1 spend proof, found "+rows.length);var stored_spend_proof=rows[0].spend_proof,spend_proof_address=rows[0].address;return stored_spend_proof!==spend_proof?cb("spend proof doesn't match"):objPrevPrivateElement&&objPrevPrivateElement.output.address!==spend_proof_address?cb("spend proof address does not match src output"):input.address&&input.address!==spend_proof_address?cb("spend proof address does not match issuer address"):void cb()})}function validateSourceOutput(cb){return conf.bLight?cb():(profiler.start(),void graph.determineIfIncluded(conn,input.unit,[objPrivateElement.unit],function(bIncluded){profiler.stop("determineIfIncluded"),bIncluded?cb():cb("input unit not included")}))}var payload=objPrivateElement.payload;if(!ValidationUtils.isStringOfLength(payload.asset,constants.HASH_LENGTH))return callbacks.ifError("invalid asset in private payment");if(!ValidationUtils.isPositiveInteger(payload.denomination))return callbacks.ifError("invalid denomination in private payment");if(!ValidationUtils.isNonemptyObject(objPrivateElement.output))return callbacks.ifError("no output");if(!ValidationUtils.isNonnegativeInteger(objPrivateElement.output_index))return callbacks.ifError("invalid output index");if(!ValidationUtils.isNonemptyArray(payload.outputs))return callbacks.ifError("invalid outputs");var our_hidden_output=payload.outputs[objPrivateElement.output_index];if(!ValidationUtils.isNonemptyObject(payload.outputs[objPrivateElement.output_index]))return callbacks.ifError("no output at output_index");if(!ValidationUtils.isValidAddress(objPrivateElement.output.address))return callbacks.ifError("bad address in output");if(!ValidationUtils.isNonemptyString(objPrivateElement.output.blinding))return callbacks.ifError("bad blinding in output");if(objectHash.getBase64Hash(objPrivateElement.output)!==our_hidden_output.output_hash)return callbacks.ifError("output hash doesn't match, output="+JSON.stringify(objPrivateElement.output)+", hash="+our_hidden_output.output_hash);if(!ValidationUtils.isArrayOfLength(payload.inputs,1))return callbacks.ifError("inputs array must be 1 element long");var input=payload.inputs[0];return ValidationUtils.isNonemptyObject(input)?(profiler.start(),void validation.initPrivatePaymentValidationState(conn,objPrivateElement.unit,objPrivateElement.message_index,payload,callbacks.ifError,function(bStable,objPartialUnit,objValidationState){profiler.stop("initPrivatePaymentValidationState");var spend_proof,input_address,arrFuncs=[];if(input.type){if("issue"!==input.type)return callbacks.ifError("neither transfer nor issue in private input");if(objPrevPrivateElement)return callbacks.ifError("prev payload and initial input");input_address=1===objPartialUnit.authors.length?objPartialUnit.authors[0].address:input.address,spend_proof=objectHash.getBase64Hash({asset:payload.asset,address:input_address,serial_number:input.serial_number,denomination:payload.denomination,amount:input.amount})}else{if("string"!=typeof input.unit)return callbacks.ifError("invalid unit in private payment");if(!ValidationUtils.isNonnegativeInteger(input.message_index))return callbacks.ifError("invalid input message_index");if(!ValidationUtils.isNonnegativeInteger(input.output_index))return callbacks.ifError("invalid input output_index");if(!objPrevPrivateElement||!objPrevPrivateElement.output||!objPrevPrivateElement.output.blinding)return callbacks.ifError("no prev output blinding");if(!objPrevPrivateElement.payload||!objPrevPrivateElement.payload.outputs)return callbacks.ifError("no prev outputs");var src_output=objPrevPrivateElement.output,prev_hidden_output=objPrevPrivateElement.payload.outputs[input.output_index];if(!prev_hidden_output)return callbacks.ifError("no prev hidden output");input_address=src_output.address,spend_proof=objectHash.getBase64Hash({asset:payload.asset,unit:input.unit,message_index:input.message_index,output_index:input.output_index,address:src_output.address,amount:prev_hidden_output.amount,blinding:src_output.blinding}),console.log("validation spend proof: "+JSON.stringify({asset:payload.asset,unit:input.unit,message_index:input.message_index,output_index:input.output_index,address:src_output.address,amount:prev_hidden_output.amount,blinding:src_output.blinding})),arrFuncs.push(validateSourceOutput),objValidationState.src_coin={src_output:src_output,denomination:payload.denomination,amount:prev_hidden_output.amount}}return objPartialUnit.authors.some(function(author){return author.address===input_address})?(arrFuncs.push(function(cb){validateSpendProof(spend_proof,cb)}),arrFuncs.push(function(cb){var partially_revealed_payload=_.cloneDeep(payload),our_output=partially_revealed_payload.outputs[objPrivateElement.output_index];our_output.address=objPrivateElement.output.address,our_output.blinding=objPrivateElement.output.blinding,validation.validatePayment(conn,partially_revealed_payload,objPrivateElement.message_index,objPartialUnit,objValidationState,cb)}),void async.series(arrFuncs,function(err){err?callbacks.ifError(err):callbacks.ifOk(bStable,input_address)})):callbacks.ifError("input address not found among unit authors")})):callbacks.ifError("no inputs[0]")}function parsePrivatePaymentChain(conn,arrPrivateElements,callbacks){var bAllStable=!0,issuePrivateElement=arrPrivateElements[arrPrivateElements.length-1];if(!issuePrivateElement.payload||!issuePrivateElement.payload.inputs||!issuePrivateElement.payload.inputs[0])return callbacks.ifError("invalid issue private element");var asset=issuePrivateElement.payload.asset;if(!asset)return callbacks.ifError("no asset in issue private element");var denomination=issuePrivateElement.payload.denomination;return denomination?void async.forEachOfSeries(arrPrivateElements,function(objPrivateElement,i,cb){if(!objPrivateElement.payload||!objPrivateElement.payload.inputs||!objPrivateElement.payload.inputs[0])return cb("invalid payload");if(!objPrivateElement.output)return cb("no output in private element");if(objPrivateElement.payload.asset!==asset)return cb("private element has a different asset");if(objPrivateElement.payload.denomination!==denomination)return cb("private element has a different denomination");var prevElement=null;if(i+1<arrPrivateElements.length){var prevElement=arrPrivateElements[i+1];if(prevElement.unit!==objPrivateElement.payload.inputs[0].unit)return cb("not referencing previous element unit");if(prevElement.message_index!==objPrivateElement.payload.inputs[0].message_index)return cb("not referencing previous element message index");if(prevElement.output_index!==objPrivateElement.payload.inputs[0].output_index)return cb("not referencing previous element output index")}validatePrivatePayment(conn,objPrivateElement,prevElement,{ifError:cb,ifOk:function(bStable,input_address){objPrivateElement.bStable=bStable,objPrivateElement.input_address=input_address,bStable||(bAllStable=!1),cb()}})},function(err){return err?callbacks.ifError(err):void callbacks.ifOk(bAllStable)}):callbacks.ifError("no denomination in issue private element")}function validateAndSavePrivatePaymentChain(conn,arrPrivateElements,callbacks){parsePrivatePaymentChain(conn,arrPrivateElements,{ifError:callbacks.ifError,
ifOk:function(bAllStable){console.log("saving private chain "+JSON.stringify(arrPrivateElements)),profiler.start();for(var arrQueries=[],i=0;i<arrPrivateElements.length;i++){var objPrivateElement=arrPrivateElements[i],payload=objPrivateElement.payload,input_address=objPrivateElement.input_address,input=payload.inputs[0],is_unique=objPrivateElement.bStable?1:null;if(input.type){if("issue"!==input.type)throw Error("neither transfer nor issue after validation");conn.addQuery(arrQueries,"INSERT "+db.getIgnore()+" INTO inputs \n\t\t\t\t\t\t(unit, message_index, input_index, serial_number, amount, asset, denomination, address, type, is_unique) \n\t\t\t\t\t\tVALUES (?,?,?,?,?,?,?,?,'issue',?)",[objPrivateElement.unit,objPrivateElement.message_index,0,input.serial_number,input.amount,payload.asset,payload.denomination,input_address,is_unique])}else conn.addQuery(arrQueries,"INSERT "+db.getIgnore()+" INTO inputs \n\t\t\t\t\t\t(unit, message_index, input_index, src_unit, src_message_index, src_output_index, asset, denomination, address, type, is_unique) \n\t\t\t\t\t\tVALUES (?,?,?,?,?,?,?,?,?,'transfer',?)",[objPrivateElement.unit,objPrivateElement.message_index,0,input.unit,input.message_index,input.output_index,payload.asset,payload.denomination,input_address,is_unique]);for(var is_serial=objPrivateElement.bStable?1:null,outputs=payload.outputs,output_index=0;output_index<outputs.length;output_index++){var output=outputs[output_index];console.log("inserting output "+JSON.stringify(output)),conn.addQuery(arrQueries,"INSERT "+db.getIgnore()+" INTO outputs \n\t\t\t\t\t\t(unit, message_index, output_index, amount, output_hash, asset, denomination) \n\t\t\t\t\t\tVALUES (?,?,?,?,?,?,?)",[objPrivateElement.unit,objPrivateElement.message_index,output_index,output.amount,output.output_hash,payload.asset,payload.denomination]);var fields="is_serial=?",params=[is_serial];if(output_index===objPrivateElement.output_index){var is_spent=0===i?0:1;fields+=", is_spent=?, address=?, blinding=?",params.push(is_spent,objPrivateElement.output.address,objPrivateElement.output.blinding)}params.push(objPrivateElement.unit,objPrivateElement.message_index,output_index),conn.addQuery(arrQueries,"UPDATE outputs SET "+fields+" WHERE unit=? AND message_index=? AND output_index=? AND is_spent=0",params)}}async.series(arrQueries,function(){profiler.stop("save"),callbacks.ifOk()})}})}function updateIndivisibleOutputsThatWereReceivedUnstable(conn,onDone){function updateOutputProps(unit,is_serial,onUpdated){conn.query("UPDATE outputs SET is_serial=? WHERE unit=?",[is_serial,unit],function(){is_serial?updateInputUniqueness(unit,onUpdated):onUpdated()})}function updateInputUniqueness(unit,onUpdated){conn.query("UPDATE inputs SET is_unique=1 WHERE unit=?",[unit],function(){onUpdated()})}console.log("updatePrivateIndivisibleOutputsThatWereReceivedUnstable starting"),conn.query("SELECT unit, message_index, sequence FROM outputs "+("sqlite"===conf.storage?"INDEXED BY outputsIsSerial":"")+" \n\t\tJOIN units USING(unit) \n\t\tWHERE outputs.is_serial IS NULL AND units.is_stable=1 AND is_spent=0",function(rows){return 0===rows.length?onDone():void async.eachSeries(rows,function(row,cb){function updateFinalOutputProps(is_serial){updateOutputProps(row.unit,is_serial,cb)}function goUp(unit,message_index){conn.query("SELECT src_unit, src_message_index, src_output_index \n\t\t\t\t\t\t\tFROM inputs \n\t\t\t\t\t\t\tWHERE unit=? AND message_index=?",[unit,message_index],function(src_rows){if(0===src_rows.length)throw Error("updating unstable: blackbyte input not found");if(src_rows.length>1)throw Error("updating unstable: more than one input found");var src_row=src_rows[0];return null===src_row.src_unit?cb():void conn.query("SELECT sequence, is_stable, is_serial FROM outputs JOIN units USING(unit) \n\t\t\t\t\t\t\t\t\tWHERE unit=? AND message_index=? AND output_index=?",[src_row.src_unit,src_row.src_message_index,src_row.src_output_index],function(prev_rows){if(0===prev_rows.length)throw Error("src unit not found");var prev_output=prev_rows[0];if(0===prev_output.is_serial)throw Error("prev is already nonserial");if(0===prev_output.is_stable)throw Error("prev is not stable");if(1===prev_output.is_serial&&"good"!==prev_output.sequence)throw Error("prev is_serial=1 but seq!=good");if(1===prev_output.is_serial)return cb();var is_serial="good"===prev_output.sequence?1:0;updateOutputProps(src_row.src_unit,is_serial,function(){return is_serial?void goUp(src_row.src_unit,src_row.src_message_index):updateFinalOutputProps(0)})})})}var is_serial="good"===row.sequence?1:0;updateOutputProps(row.unit,is_serial,function(){goUp(row.unit,row.message_index)})},onDone)})}function pickIndivisibleCoinsForAmount(conn,objAsset,arrAddresses,last_ball_mci,to_address,change_address,amount,tolerance_plus,tolerance_minus,bMultiAuthored,onDone){updateIndivisibleOutputsThatWereReceivedUnstable(conn,function(){function createOutputs(amount_to_use,change_amount){var output={address:to_address,amount:amount_to_use};objAsset.is_private&&(output.blinding=composer.generateBlinding());var outputs=[output];if(change_amount){var change_output={address:change_address,amount:change_amount};objAsset.is_private&&(change_output.blinding=composer.generateBlinding()),outputs.push(change_output),outputs.sort(function(o1,o2){return o1.address<o2.address?-1:1})}return outputs}function pickNextCoin(remaining_amount){if(console.log("looking for output for "+remaining_amount),remaining_amount<=0)throw Error("remaining amount is "+remaining_amount);conn.query("SELECT output_id, unit, message_index, output_index, amount, denomination, address, blinding, is_stable \n\t\t\t\tFROM outputs CROSS JOIN units USING(unit) \n\t\t\t\tWHERE asset=? AND address IN(?) AND +is_serial=1 AND is_spent=0 AND sequence='good' \n\t\t\t\t\tAND main_chain_index<=? AND denomination<=? AND output_id NOT IN(?) \n\t\t\t\tORDER BY denomination DESC, (amount>=?) DESC, ABS(amount-?) LIMIT 1",[asset,arrAddresses,last_ball_mci,remaining_amount,arrOutputIds.length>0?arrOutputIds:-1,remaining_amount+tolerance_plus,remaining_amount],function(rows){if(0===rows.length)return issueNextCoinIfAllowed(remaining_amount);var row=rows[0];if(0===row.is_stable)throw Error("unstable or nonserial unit");var amount_to_use,change_amount,input={unit:row.unit,message_index:row.message_index,output_index:row.output_index};row.amount>remaining_amount+tolerance_plus?(amount_to_use=Math.floor((remaining_amount+tolerance_plus)/row.denomination)*row.denomination,change_amount=row.amount-amount_to_use):amount_to_use=row.amount;var payload={asset:asset,denomination:row.denomination,inputs:[input],outputs:createOutputs(amount_to_use,change_amount)},objPayloadWithProof={payload:payload,input_address:row.address};if(objAsset.is_private){var spend_proof=objectHash.getBase64Hash({asset:asset,unit:row.unit,message_index:row.message_index,output_index:row.output_index,address:row.address,amount:row.amount,blinding:row.blinding}),objSpendProof={spend_proof:spend_proof};bMultiAuthored&&(objSpendProof.address=row.address),objPayloadWithProof.spend_proof=objSpendProof}return arrPayloadsWithProofs.push(objPayloadWithProof),arrOutputIds.push(row.output_id),accumulated_amount+=amount_to_use,accumulated_amount>=amount-tolerance_minus&&accumulated_amount<=amount+tolerance_plus?onDone(null,arrPayloadsWithProofs):arrPayloadsWithProofs.length>=constants.MAX_MESSAGES_PER_UNIT-1?onDone("Too many messages, try sending a smaller amount"):void pickNextCoin(amount-accumulated_amount)})}function issueNextCoinIfAllowed(remaining_amount){return!objAsset.issued_by_definer_only||arrAddresses.indexOf(objAsset.definer_address)>=0?issueNextCoin(remaining_amount):onDone(NOT_ENOUGH_FUNDS_ERROR_MESSAGE)}function issueNextCoin(remaining_amount){if(console.log("issuing a new coin"),remaining_amount<=0)throw Error("remaining amount is "+remaining_amount);var issuer_address=objAsset.issued_by_definer_only?objAsset.definer_address:arrAddresses[0],can_issue_condition=objAsset.cap?"max_issued_serial_number=0":"1";conn.query("SELECT denomination, count_coins, max_issued_serial_number FROM asset_denominations \n\t\t\t\tWHERE asset=? AND "+can_issue_condition+" AND denomination<=? \n\t\t\t\tORDER BY denomination DESC LIMIT 1",[asset,remaining_amount+tolerance_plus],function(rows){if(0===rows.length)return onDone(NOT_ENOUGH_FUNDS_ERROR_MESSAGE);var row=rows[0];if(!!row.count_coins!=!!objAsset.cap)throw Error("invalid asset cap and count_coins");var denomination=row.denomination,serial_number=row.max_issued_serial_number+1,count_coins_to_issue=row.count_coins||Math.floor((remaining_amount+tolerance_plus)/denomination),issue_amount=count_coins_to_issue*denomination;conn.query("UPDATE asset_denominations SET max_issued_serial_number=max_issued_serial_number+1 WHERE denomination=? AND asset=?",[denomination,asset],function(){var input={type:"issue",serial_number:serial_number,amount:issue_amount};bMultiAuthored&&(input.address=issuer_address);var amount_to_use,change_amount;issue_amount>remaining_amount+tolerance_plus?(amount_to_use=Math.floor((remaining_amount+tolerance_plus)/denomination)*denomination,change_amount=issue_amount-amount_to_use):amount_to_use=issue_amount;var payload={asset:asset,denomination:denomination,inputs:[input],outputs:createOutputs(amount_to_use,change_amount)},objPayloadWithProof={payload:payload,input_address:issuer_address};if(objAsset.is_private){var spend_proof=objectHash.getBase64Hash({asset:asset,address:issuer_address,serial_number:serial_number,denomination:denomination,amount:input.amount}),objSpendProof={spend_proof:spend_proof};bMultiAuthored&&(objSpendProof.address=issuer_address),objPayloadWithProof.spend_proof=objSpendProof}return arrPayloadsWithProofs.push(objPayloadWithProof),accumulated_amount+=amount_to_use,console.log("payloads with proofs: "+JSON.stringify(arrPayloadsWithProofs)),accumulated_amount>=amount-tolerance_minus&&accumulated_amount<=amount+tolerance_plus?onDone(null,arrPayloadsWithProofs):void pickNextCoin(amount-accumulated_amount)})})}console.log("updatePrivateIndivisibleOutputsThatWereReceivedUnstable done");var arrPayloadsWithProofs=[],arrOutputIds=[],accumulated_amount=0,asset=objAsset.asset,arrSpendableAddresses=arrAddresses.concat();if(objAsset&&objAsset.auto_destroy){var i=arrAddresses.indexOf(objAsset.definer_address);i>=0&&arrSpendableAddresses.splice(i,1)}arrSpendableAddresses.length>0?pickNextCoin(amount):issueNextCoinIfAllowed(amount)})}function shuffleArray(array){for(var i=array.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1)),temp=array[i];array[i]=array[j],array[j]=temp}return array}function buildPrivateElementsChain(conn,unit,message_index,output_index,payload,handlePrivateElements){function readPayloadAndGoUp(_unit,_message_index,_output_index){conn.query("SELECT src_unit, src_message_index, src_output_index, serial_number, denomination, amount, address, asset, \n\t\t\t\t(SELECT COUNT(*) FROM unit_authors WHERE unit=?) AS count_authors \n\t\t\tFROM inputs WHERE unit=? AND message_index=?",[_unit,_unit,_message_index],function(in_rows){if(0===in_rows.length)throw Error("building chain: blackbyte input not found");if(in_rows.length>1)throw Error("building chain: more than 1 input found");var in_row=in_rows[0];if(!in_row.address)throw Error("readPayloadAndGoUp: input address is NULL");if(in_row.asset!==asset)throw Error("building chain: asset mismatch");if(in_row.denomination!==denomination)throw Error("building chain: denomination mismatch");var input={};in_row.src_unit?(input.unit=in_row.src_unit,input.message_index=in_row.src_message_index,input.output_index=in_row.src_output_index):(input.type="issue",input.serial_number=in_row.serial_number,input.amount=in_row.amount,in_row.count_authors>1&&(input.address=in_row.address)),conn.query("SELECT address, blinding, output_hash, amount, output_index, asset, denomination FROM outputs \n\t\t\t\t\tWHERE unit=? AND message_index=? ORDER BY output_index",[_unit,_message_index],function(out_rows){if(0===out_rows.length)throw Error("blackbyte output not found");var output={},outputs=out_rows.map(function(o){if(o.asset!==asset)throw Error("outputs asset mismatch");if(o.denomination!==denomination)throw Error("outputs denomination mismatch");return o.output_index===_output_index&&(output.address=o.address,output.blinding=o.blinding),{amount:o.amount,output_hash:o.output_hash}});if(!output.address)throw Error("output not filled");var objPrivateElement={unit:_unit,message_index:_message_index,payload:{asset:asset,denomination:denomination,inputs:[input],outputs:outputs},output_index:_output_index,output:output};arrPrivateElements.push(objPrivateElement),"issue"===input.type?handlePrivateElements(arrPrivateElements):readPayloadAndGoUp(input.unit,input.message_index,input.output_index)})})}var asset=payload.asset,denomination=payload.denomination,output=payload.outputs[output_index],hidden_payload=_.cloneDeep(payload);hidden_payload.outputs.forEach(function(o){delete o.address,delete o.blinding});var arrPrivateElements=[{unit:unit,message_index:message_index,payload:hidden_payload,output_index:output_index,output:{address:output.address,blinding:output.blinding}}],input=payload.inputs[0];"issue"===input.type?handlePrivateElements(arrPrivateElements):readPayloadAndGoUp(input.unit,input.message_index,input.output_index)}function composeIndivisibleAssetPaymentJoint(params){if(console.log("indivisible payment from "+params.paying_addresses),!ValidationUtils.isNonemptyArray(params.fee_paying_addresses))throw Error("no fee_paying_addresses");composer.composeJoint({paying_addresses:_.union(params.paying_addresses,params.fee_paying_addresses),signing_addresses:params.signing_addresses,minimal:params.minimal,outputs:[{address:params.fee_paying_addresses[0],amount:0}],retrieveMessages:function(conn,last_ball_mci,bMultiAuthored,arrPayingAddresses,onDone){var arrAssetPayingAddresses=_.intersection(arrPayingAddresses,params.paying_addresses);storage.loadAssetWithListOfAttestedAuthors(conn,params.asset,last_ball_mci,arrAssetPayingAddresses,function(err,objAsset){return err?onDone(err):objAsset.fixed_denominations?objAsset.is_transferrable||params.to_address===objAsset.definer_address||arrAssetPayingAddresses.indexOf(objAsset.definer_address)!==-1?objAsset.cosigned_by_definer&&arrPayingAddresses.concat(params.signing_addresses||[]).indexOf(objAsset.definer_address)===-1?onDone("the asset must be cosigned by definer"):objAsset.spender_attested&&0===objAsset.arrAttestedAddresses.length?onDone("none of the authors is attested"):void pickIndivisibleCoinsForAmount(conn,objAsset,arrAssetPayingAddresses,last_ball_mci,params.to_address,params.change_address,params.amount,params.tolerance_plus||0,params.tolerance_minus||0,bMultiAuthored,function(err,arrPayloadsWithProofs){if(!arrPayloadsWithProofs)return onDone({error_code:"NOT_ENOUGH_FUNDS",error:err});for(var arrMessages=[],assocPrivatePayloads={},i=0;i<arrPayloadsWithProofs.length;i++){var payload_hash,payload=arrPayloadsWithProofs[i].payload;if(objAsset.is_private){payload.outputs.forEach(function(o){o.output_hash=objectHash.getBase64Hash({address:o.address,blinding:o.blinding})});var hidden_payload=_.cloneDeep(payload);hidden_payload.outputs.forEach(function(o){delete o.address,delete o.blinding}),payload_hash=objectHash.getBase64Hash(hidden_payload)}else payload_hash=objectHash.getBase64Hash(payload);var objMessage={app:"payment",payload_location:objAsset.is_private?"none":"inline",payload_hash:payload_hash};objAsset.is_private?(assocPrivatePayloads[payload_hash]=payload,objMessage.spend_proofs=[arrPayloadsWithProofs[i].spend_proof]):objMessage.payload=payload,arrMessages.push(objMessage)}shuffleArray(arrMessages),console.log("composed messages "+JSON.stringify(arrMessages)),onDone(null,arrMessages,assocPrivatePayloads)}):onDone("the asset is not transferrable and definer not found on either side of the deal"):onDone("divisible asset type")})},signer:params.signer,callbacks:{ifError:params.callbacks.ifError,ifNotEnoughFunds:params.callbacks.ifNotEnoughFunds,ifOk:function(objJoint,assocPrivatePayloads,composer_unlock_callback){params.callbacks.ifOk(objJoint,assocPrivatePayloads,composer_unlock_callback)}}})}function getSavingCallbacks(to_address,callbacks){return{ifError:callbacks.ifError,ifNotEnoughFunds:callbacks.ifNotEnoughFunds,ifOk:function(objJoint,assocPrivatePayloads,composer_unlock){var objUnit=objJoint.unit,unit=objUnit.unit;validation.validate(objJoint,{ifUnitError:function(err){composer_unlock(),callbacks.ifError("Validation error: "+err)},ifJointError:function(err){throw Error("unexpected validation joint error: "+err)},ifTransientError:function(err){throw Error("unexpected validation transient error: "+err)},ifNeedHashTree:function(){throw Error("unexpected need hash tree")},ifNeedParentUnits:function(arrMissingUnits){throw Error("unexpected dependencies: "+arrMissingUnits.join(", "))},ifOk:function(objValidationState,validation_unlock){if(console.log("Private OK "+objValidationState.sequence),"good"!==objValidationState.sequence)return validation_unlock(),composer_unlock(),callbacks.ifError("Indivisible asset bad sequence "+objValidationState.sequence);var bPrivate=!!assocPrivatePayloads,arrRecipientChains=bPrivate?[]:null,arrCosignerChains=bPrivate?[]:null,preCommitCallback=null,bPreCommitCallbackFailed=!1;bPrivate&&(preCommitCallback=function(conn,cb){async.eachSeries(Object.keys(assocPrivatePayloads),function(payload_hash,cb2){var message_index=composer.getMessageIndexByPayloadHash(objUnit,payload_hash),payload=assocPrivatePayloads[payload_hash];async.forEachOfSeries(payload.outputs,function(output,output_index,cb3){buildPrivateElementsChain(conn,unit,message_index,output_index,payload,function(arrPrivateElements){validateAndSavePrivatePaymentChain(conn,_.cloneDeep(arrPrivateElements),{ifError:function(err){cb3(err)},ifOk:function(){output.address===to_address&&arrRecipientChains.push(arrPrivateElements),arrCosignerChains.push(arrPrivateElements),cb3()}})})},cb2)},function(err){if(err)return console.log("===== error in precommit callback: "+err),bPreCommitCallbackFailed=!0,cb(err);var onSuccessfulPrecommit=conf.bLight?function(){composer.postJointToLightVendorIfNecessaryAndSave(objJoint,function(err){console.log("failed to post indivisible payment "+unit),bPreCommitCallbackFailed=!0,cb(err)},function(){cb()})}:cb;return callbacks.preCommitCb?void callbacks.preCommitCb(conn,arrRecipientChains,arrCosignerChains,onSuccessfulPrecommit):onSuccessfulPrecommit()})});var saveAndUnlock=function(){writer.saveJoint(objJoint,objValidationState,preCommitCallback,function(err){console.log("saved unit "+unit),validation_unlock(),composer_unlock(),bPreCommitCallbackFailed?callbacks.ifError("precommit callback failed: "+err):callbacks.ifOk(objJoint,arrRecipientChains,arrCosignerChains)})};return bPrivate||!conf.bLight?saveAndUnlock():void composer.postJointToLightVendorIfNecessaryAndSave(objJoint,function(err){console.log("failed to post indivisible payment "+unit),validation_unlock(),composer_unlock(),callbacks.ifError(err)},saveAndUnlock)}})}}}function restorePrivateChains(asset,unit,to_address,handleChains){var arrRecipientChains=[],arrCosignerChains=[];db.query("SELECT DISTINCT message_index, denomination, payload_hash FROM outputs JOIN messages USING(unit, message_index) WHERE unit=? AND asset=?",[unit,asset],function(rows){async.eachSeries(rows,function(row,cb){var payload={asset:asset,denomination:row.denomination},message_index=row.message_index;db.query("SELECT src_unit, src_message_index, src_output_index, denomination, asset FROM inputs WHERE unit=? AND message_index=?",[unit,message_index],function(input_rows){if(1!==input_rows.length)throw Error("not 1 input");var input_row=input_rows[0];if(input_row.asset!==asset)throw Error("assets don't match");if(input_row.denomination!==row.denomination)throw Error("denominations don't match");if(null===input_row.src_message_index||null===input_row.src_output_index)throw Error("only transfers supported");var input={unit:input_row.src_unit,message_index:input_row.src_message_index,output_index:input_row.src_output_index};payload.inputs=[input],db.query("SELECT address, amount, blinding, output_hash FROM outputs \n\t\t\t\t\t\t\t\tWHERE unit=? AND asset=? AND message_index=? ORDER BY output_index",[unit,asset,message_index],function(outputs){if(0===outputs.length)throw Error("outputs not found for mi "+message_index);if(!outputs.some(function(output){return output.address&&output.blinding}))throw Error("all outputs are hidden");payload.outputs=outputs;var hidden_payload=_.cloneDeep(payload);hidden_payload.outputs.forEach(function(o){delete o.address,delete o.blinding});var payload_hash=objectHash.getBase64Hash(hidden_payload);if(payload_hash!==row.payload_hash)throw Error("wrong payload hash");async.forEachOfSeries(payload.outputs,function(output,output_index,cb3){return output.address&&output.blinding?void buildPrivateElementsChain(db,unit,message_index,output_index,payload,function(arrPrivateElements){output.address===to_address&&arrRecipientChains.push(arrPrivateElements),arrCosignerChains.push(arrPrivateElements),cb3()}):cb3()},cb)})})},function(){handleChains(arrRecipientChains,arrCosignerChains)})})}function composeAndSaveIndivisibleAssetPaymentJoint(params){var params_with_save=_.clone(params);params_with_save.callbacks=getSavingCallbacks(params.to_address,params.callbacks),composeIndivisibleAssetPaymentJoint(params_with_save)}function readAddressesFundedInAsset(asset,amount,arrAvailablePayingAddresses,handleFundedAddresses){var remaining_amount=amount,assocAddresses={};db.query("SELECT amount, denomination, address FROM outputs CROSS JOIN units USING(unit) \n\t\tWHERE is_spent=0 AND address IN(?) AND is_stable=1 AND sequence='good' AND asset=? \n\t\t\tAND NOT EXISTS ( \n\t\t\t\tSELECT * FROM unit_authors JOIN units USING(unit) \n\t\t\t\tWHERE is_stable=0 AND unit_authors.address=outputs.address AND definition_chash IS NOT NULL \n\t\t\t) \n\t\tORDER BY denomination DESC, amount DESC",[arrAvailablePayingAddresses,asset],function(rows){for(var i=0;i<rows.length;i++){var row=rows[i];if(!(row.denomination>remaining_amount)){assocAddresses[row.address]=!0;var used_amount=row.amount<=remaining_amount?row.amount:row.denomination*Math.floor(remaining_amount/row.denomination);if(remaining_amount-=used_amount,0===remaining_amount)break}}var arrAddresses=Object.keys(assocAddresses);handleFundedAddresses(arrAddresses)})}function readFundedAddresses(asset,amount,arrAvailablePayingAddresses,arrAvailableFeePayingAddresses,handleFundedAddresses){readAddressesFundedInAsset(asset,amount,arrAvailablePayingAddresses,function(arrAddressesFundedInAsset){composer.readSortedFundedAddresses(null,arrAvailableFeePayingAddresses,TYPICAL_FEE,function(arrFundedFeePayingAddresses){handleFundedAddresses(arrAddressesFundedInAsset,arrFundedFeePayingAddresses)})})}function composeMinimalIndivisibleAssetPaymentJoint(params){if(!ValidationUtils.isNonemptyArray(params.available_paying_addresses))throw Error("no available_paying_addresses");if(!ValidationUtils.isNonemptyArray(params.available_fee_paying_addresses))throw Error("no available_fee_paying_addresses");readFundedAddresses(params.asset,params.amount,params.available_paying_addresses,params.available_fee_paying_addresses,function(arrFundedPayingAddresses,arrFundedFeePayingAddresses){if(0===arrFundedPayingAddresses.length)return params.callbacks.ifNotEnoughFunds("all paying addresses are unfunded in asset, make sure all your funds are confirmed");var minimal_params=_.clone(params);delete minimal_params.available_paying_addresses,delete minimal_params.available_fee_paying_addresses,minimal_params.minimal=!0,minimal_params.paying_addresses=arrFundedPayingAddresses,minimal_params.fee_paying_addresses=arrFundedFeePayingAddresses,composeIndivisibleAssetPaymentJoint(minimal_params)})}function composeAndSaveMinimalIndivisibleAssetPaymentJoint(params){var params_with_save=_.clone(params);params_with_save.callbacks=getSavingCallbacks(params.to_address,params.callbacks),composeMinimalIndivisibleAssetPaymentJoint(params_with_save)}var async=require("async"),_=require("lodash"),conf=require("./conf.js"),storage=require("./storage.js"),objectHash=require("./object_hash.js"),db=require("./db.js"),constants=require("./constants.js"),composer=require("./composer.js"),validation=require("./validation.js"),ValidationUtils=require("./validation_utils.js"),writer=require("./writer.js"),graph=require("./graph.js"),profiler=require("./profiler.js"),NOT_ENOUGH_FUNDS_ERROR_MESSAGE="not enough indivisible asset coins that fit the desired amount within the specified tolerances, make sure all your funds are confirmed",TYPICAL_FEE=3e3;exports.getSavingCallbacks=getSavingCallbacks,exports.validateAndSavePrivatePaymentChain=validateAndSavePrivatePaymentChain,exports.restorePrivateChains=restorePrivateChains,exports.composeAndSaveIndivisibleAssetPaymentJoint=composeAndSaveIndivisibleAssetPaymentJoint,exports.composeAndSaveMinimalIndivisibleAssetPaymentJoint=composeAndSaveMinimalIndivisibleAssetPaymentJoint,exports.updateIndivisibleOutputsThatWereReceivedUnstable=updateIndivisibleOutputsThatWereReceivedUnstable},{"./composer.js":369,"./conf.js":370,"./constants.js":371,"./db.js":372,"./graph.js":379,"./object_hash.js":392,"./profiler.js":398,"./storage.js":402,"./validation.js":404,"./validation_utils.js":405,"./writer.js":411,async:26,lodash:271}],382:[function(require,module,exports){"use strict";function checkIfNewUnit(unit,callbacks){return storage.isKnownUnit(unit)?callbacks.ifKnown():void db.query("SELECT 1 FROM units WHERE unit=?",[unit],function(rows){return rows.length>0?(storage.setUnitIsKnown(unit),callbacks.ifKnown()):void db.query("SELECT 1 FROM unhandled_joints WHERE unit=?",[unit],function(unhandled_rows){return unhandled_rows.length>0?callbacks.ifKnownUnverified():void db.query("SELECT error FROM known_bad_joints WHERE unit=?",[unit],function(bad_rows){0===bad_rows.length?callbacks.ifNew():callbacks.ifKnownBad(bad_rows[0].error)})})})}function checkIfNewJoint(objJoint,callbacks){checkIfNewUnit(objJoint.unit.unit,{ifKnown:callbacks.ifKnown,ifKnownUnverified:callbacks.ifKnownUnverified,ifKnownBad:callbacks.ifKnownBad,ifNew:function(){db.query("SELECT error FROM known_bad_joints WHERE joint=?",[objectHash.getJointHash(objJoint)],function(bad_rows){0===bad_rows.length?callbacks.ifNew():callbacks.ifKnownBad(bad_rows[0].error)})}})}function removeUnhandledJointAndDependencies(unit,onDone){db.takeConnectionFromPool(function(conn){var arrQueries=[];conn.addQuery(arrQueries,"BEGIN"),conn.addQuery(arrQueries,"DELETE FROM unhandled_joints WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM dependencies WHERE unit=?",[unit]),conn.addQuery(arrQueries,"COMMIT"),async.series(arrQueries,function(){conn.release(),onDone&&onDone()})})}function saveUnhandledJointAndDependencies(objJoint,arrMissingParentUnits,peer,onDone){db.takeConnectionFromPool(function(conn){var unit=objJoint.unit.unit,sql="INSERT "+conn.getIgnore()+" INTO dependencies (unit, depends_on_unit) VALUES "+arrMissingParentUnits.map(function(missing_unit){return"("+conn.escape(unit)+", "+conn.escape(missing_unit)+")"}).join(", "),arrQueries=[];conn.addQuery(arrQueries,"BEGIN"),conn.addQuery(arrQueries,"INSERT INTO unhandled_joints (unit, json, peer) VALUES (?, ?, ?)",[unit,JSON.stringify(objJoint),peer]),conn.addQuery(arrQueries,sql),conn.addQuery(arrQueries,"COMMIT"),async.series(arrQueries,function(){conn.release(),onDone&&onDone()})})}function readDependentJointsThatAreReady(unit,handleDependentJoint){var from=(Date.now(),unit?"FROM dependencies AS src_deps JOIN dependencies USING(unit)":"FROM dependencies"),where=unit?"WHERE src_deps.depends_on_unit="+db.escape(unit):"";mutex.lock(["dependencies"],function(unlock){db.query("SELECT dependencies.unit, unhandled_joints.unit AS unit_for_json, \n\t\t\t\tSUM(CASE WHEN units.unit IS NULL THEN 1 ELSE 0 END) AS count_missing_parents \n\t\t\t"+from+" \n\t\t\tJOIN unhandled_joints ON dependencies.unit=unhandled_joints.unit \n\t\t\tLEFT JOIN units ON dependencies.depends_on_unit=units.unit \n\t\t\t"+where+" \n\t\t\tGROUP BY dependencies.unit \n\t\t\tHAVING count_missing_parents=0 \n\t\t\tORDER BY NULL",function(rows){rows.forEach(function(row){db.query("SELECT json, peer, "+db.getUnixTimestamp("creation_date")+" AS creation_ts FROM unhandled_joints WHERE unit=?",[row.unit_for_json],function(internal_rows){internal_rows.forEach(function(internal_row){handleDependentJoint(JSON.parse(internal_row.json),parseInt(internal_row.creation_ts),internal_row.peer)})})}),unlock()})})}function findLostJoints(handleLostJoints){db.query("SELECT DISTINCT depends_on_unit \n\t\tFROM dependencies \n\t\tLEFT JOIN unhandled_joints ON depends_on_unit=unhandled_joints.unit \n\t\tLEFT JOIN units ON depends_on_unit=units.unit \n\t\tWHERE unhandled_joints.unit IS NULL AND units.unit IS NULL AND dependencies.creation_date < "+db.addTime("-8 SECOND"),function(rows){0!==rows.length&&handleLostJoints(rows.map(function(row){return row.depends_on_unit}))})}function purgeJointAndDependencies(objJoint,error,onPurgedDependentJoint,onDone){db.takeConnectionFromPool(function(conn){var unit=objJoint.unit.unit,arrQueries=[];conn.addQuery(arrQueries,"BEGIN"),conn.addQuery(arrQueries,"INSERT INTO known_bad_joints (unit, json, error) VALUES (?,?,?)",[unit,JSON.stringify(objJoint),error]),conn.addQuery(arrQueries,"DELETE FROM unhandled_joints WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM dependencies WHERE unit=?",[unit]),collectQueriesToPurgeDependentJoints(conn,arrQueries,unit,error,onPurgedDependentJoint,function(){conn.addQuery(arrQueries,"COMMIT"),async.series(arrQueries,function(){conn.release(),onDone&&onDone()})})})}function purgeDependencies(unit,error,onPurgedDependentJoint,onDone){db.takeConnectionFromPool(function(conn){var arrQueries=[];conn.addQuery(arrQueries,"BEGIN"),collectQueriesToPurgeDependentJoints(conn,arrQueries,unit,error,onPurgedDependentJoint,function(){conn.addQuery(arrQueries,"COMMIT"),async.series(arrQueries,function(){conn.release(),onDone&&onDone()})})})}function collectQueriesToPurgeDependentJoints(conn,arrQueries,unit,error,onPurgedDependentJoint,onDone){conn.query("SELECT unit, peer FROM dependencies JOIN unhandled_joints USING(unit) WHERE depends_on_unit=?",[unit],function(rows){if(0===rows.length)return onDone();var arrUnits=rows.map(function(row){return row.unit});conn.addQuery(arrQueries,"INSERT "+conn.getIgnore()+" INTO known_bad_joints (unit, json, error) \n\t\t\tSELECT unit, json, ? FROM unhandled_joints WHERE unit IN(?)",[error,arrUnits]),conn.addQuery(arrQueries,"DELETE FROM unhandled_joints WHERE unit IN(?)",[arrUnits]),conn.addQuery(arrQueries,"DELETE FROM dependencies WHERE unit IN(?)",[arrUnits]),async.eachSeries(rows,function(row,cb){onPurgedDependentJoint&&onPurgedDependentJoint(row.unit,row.peer),collectQueriesToPurgeDependentJoints(conn,arrQueries,row.unit,error,onPurgedDependentJoint,cb)},onDone)})}function purgeUncoveredNonserialJointsUnderLock(){mutex.lockOrSkip(["purge_uncovered"],function(unlock){purgeUncoveredNonserialJoints(!1,unlock)})}function purgeUncoveredNonserialJoints(bByExistenceOfChildren,onDone){var cond=bByExistenceOfChildren?"(SELECT 1 FROM parenthoods WHERE parent_unit=unit LIMIT 1) IS NULL":"is_free=1",order_column="mysql"===conf.storage?"creation_date":"rowid",byIndex=bByExistenceOfChildren&&"sqlite"===conf.storage?"INDEXED BY bySequence":"";db.query("SELECT unit FROM units "+byIndex+" \n\t\tWHERE "+cond+" AND sequence IN('final-bad','temp-bad') AND content_hash IS NULL \n\t\t\tAND NOT EXISTS (SELECT * FROM dependencies WHERE depends_on_unit=units.unit) \n\t\t\tAND NOT EXISTS (SELECT * FROM balls WHERE balls.unit=units.unit) \n\t\t\tAND EXISTS ( \n\t\t\t\tSELECT DISTINCT address FROM units AS wunits CROSS JOIN unit_authors USING(unit) CROSS JOIN my_witnesses USING(address) \n\t\t\t\tWHERE wunits."+order_column+" > units."+order_column+" \n\t\t\t\tLIMIT ?,1 \n\t\t\t) \n\t\t\t/* AND NOT EXISTS (SELECT * FROM unhandled_joints) */",[constants.MAJORITY_OF_WITNESSES-1],function(rows){
async.eachSeries(rows,function(row,cb){breadcrumbs.add("--------------- archiving uncovered unit "+row.unit),storage.readJoint(db,row.unit,{ifNotFound:function(){throw Error("nonserial unit not found?")},ifFound:function(objJoint){db.takeConnectionFromPool(function(conn){mutex.lock(["write"],function(unlock){var arrQueries=[];conn.addQuery(arrQueries,"BEGIN"),storage.generateQueriesToArchiveJoint(conn,objJoint,"uncovered",arrQueries,function(){conn.addQuery(arrQueries,"COMMIT"),async.series(arrQueries,function(){unlock(),conn.release(),breadcrumbs.add("------- done archiving "+row.unit),storage.forgetUnit(row.unit),cb()})})})})}})},function(){return rows.length>0?purgeUncoveredNonserialJoints(!0,onDone):bByExistenceOfChildren?void db.query("UPDATE units SET is_free=1 WHERE is_free=0 AND main_chain_index IS NULL \n\t\t\t\t\t\tAND (SELECT 1 FROM parenthoods WHERE parent_unit=unit LIMIT 1) IS NULL",function(){onDone()}):onDone()})})}function readJointsSinceMci(mci,handleJoint,onDone){db.query("SELECT units.unit FROM units LEFT JOIN archived_joints USING(unit) \n\t\tWHERE (is_stable=0 AND main_chain_index>=? OR main_chain_index IS NULL OR is_free=1) AND archived_joints.unit IS NULL \n\t\tORDER BY +level",[mci],function(rows){async.eachSeries(rows,function(row,cb){storage.readJoint(db,row.unit,{ifNotFound:function(){breadcrumbs.add("unit "+row.unit+" not found"),cb()},ifFound:function(objJoint){handleJoint(objJoint),cb()}})},onDone)})}var async=(require("lodash"),require("async")),storage=require("./storage.js"),db=require("./db.js"),constants=require("./constants.js"),objectHash=require("./object_hash.js"),mutex=require("./mutex.js"),conf=require("./conf.js"),breadcrumbs=require("./breadcrumbs.js");exports.checkIfNewUnit=checkIfNewUnit,exports.checkIfNewJoint=checkIfNewJoint,exports.saveUnhandledJointAndDependencies=saveUnhandledJointAndDependencies,exports.removeUnhandledJointAndDependencies=removeUnhandledJointAndDependencies,exports.readDependentJointsThatAreReady=readDependentJointsThatAreReady,exports.findLostJoints=findLostJoints,exports.purgeJointAndDependencies=purgeJointAndDependencies,exports.purgeDependencies=purgeDependencies,exports.purgeUncoveredNonserialJointsUnderLock=purgeUncoveredNonserialJointsUnderLock,exports.readJointsSinceMci=readJointsSinceMci},{"./breadcrumbs.js":365,"./conf.js":370,"./constants.js":371,"./db.js":372,"./mutex.js":388,"./object_hash.js":392,"./storage.js":402,async:26,lodash:271}],383:[function(require,module,exports){"use strict";function buildProofChain(later_mci,earlier_mci,unit,arrBalls,onDone){if(null===earlier_mci)throw Error("earlier_mci=null, unit="+unit);return later_mci===earlier_mci?buildLastMileOfProofChain(earlier_mci,unit,arrBalls,onDone):void buildProofChainOnMc(later_mci,earlier_mci,arrBalls,function(){buildLastMileOfProofChain(earlier_mci,unit,arrBalls,onDone)})}function buildProofChainOnMc(later_mci,earlier_mci,arrBalls,onDone){function addBall(mci){if(mci<0)throw Error("mci<0, later_mci="+later_mci+", earlier_mci="+earlier_mci);db.query("SELECT unit, ball, content_hash FROM units JOIN balls USING(unit) WHERE main_chain_index=? AND is_on_main_chain=1",[mci],function(rows){if(1!==rows.length)throw Error("no prev chain element? mci="+mci+", later_mci="+later_mci+", earlier_mci="+earlier_mci);var objBall=rows[0];objBall.content_hash&&(objBall.is_nonserial=!0),delete objBall.content_hash,db.query("SELECT ball FROM parenthoods LEFT JOIN balls ON parent_unit=balls.unit WHERE child_unit=? ORDER BY ball",[objBall.unit],function(parent_rows){if(parent_rows.some(function(parent_row){return!parent_row.ball}))throw Error("some parents have no balls");parent_rows.length>0&&(objBall.parent_balls=parent_rows.map(function(parent_row){return parent_row.ball})),db.query("SELECT ball, main_chain_index \n\t\t\t\t\t\tFROM skiplist_units JOIN units ON skiplist_unit=units.unit LEFT JOIN balls ON units.unit=balls.unit \n\t\t\t\t\t\tWHERE skiplist_units.unit=? ORDER BY ball",[objBall.unit],function(srows){if(srows.some(function(srow){return!srow.ball}))throw Error("some skiplist units have no balls");if(srows.length>0&&(objBall.skiplist_balls=srows.map(function(srow){return srow.ball})),arrBalls.push(objBall),mci===earlier_mci)return onDone();if(0===srows.length)return addBall(mci-1);for(var next_mci=mci-1,i=0;i<srows.length;i++){var next_skiplist_mci=srows[i].main_chain_index;next_skiplist_mci<next_mci&&next_skiplist_mci>=earlier_mci&&(next_mci=next_skiplist_mci)}addBall(next_mci)})})})}if(earlier_mci>later_mci)throw Error("earlier > later");return earlier_mci===later_mci?onDone():void addBall(later_mci-1)}function buildLastMileOfProofChain(mci,unit,arrBalls,onDone){function addBall(_unit){db.query("SELECT unit, ball FROM units JOIN balls USING(unit) WHERE unit=?",[_unit],function(rows){if(1!==rows.length)throw Error("no unit?");var objBall=rows[0];db.query("SELECT ball FROM parenthoods LEFT JOIN balls ON parent_unit=balls.unit WHERE child_unit=? ORDER BY ball",[objBall.unit],function(parent_rows){if(parent_rows.some(function(parent_row){return!parent_row.ball}))throw Error("some parents have no balls");return parent_rows.length>0&&(objBall.parent_balls=parent_rows.map(function(parent_row){return parent_row.ball})),arrBalls.push(objBall),_unit===unit?onDone():void findParent(_unit)})})}function findParent(interim_unit){db.query("SELECT parent_unit FROM parenthoods JOIN units ON parent_unit=unit WHERE child_unit=? AND main_chain_index=?",[interim_unit,mci],function(parent_rows){var arrParents=parent_rows.map(function(parent_row){return parent_row.parent_unit});return arrParents.indexOf(unit)>=0?addBall(unit):void async.eachSeries(arrParents,function(parent_unit,cb){graph.determineIfIncluded(db,unit,[parent_unit],function(bIncluded){bIncluded?cb(parent_unit):cb()})},function(parent_unit){if(!parent_unit)throw Error("no parent that includes target unit");addBall(parent_unit)})})}db.query("SELECT unit FROM units WHERE main_chain_index=? AND is_on_main_chain=1",[mci],function(rows){if(1!==rows.length)throw Error("no mc unit?");var mc_unit=rows[0].unit;return mc_unit===unit?onDone():void findParent(mc_unit)})}function prepareHistory(historyRequest,callbacks){var arrKnownStableUnits=historyRequest.known_stable_units,arrWitnesses=historyRequest.witnesses,arrAddresses=historyRequest.addresses,arrRequestedJoints=historyRequest.requested_joints;if(!arrAddresses&&!arrRequestedJoints)return callbacks.ifError("neither addresses nor joints requested");if(arrAddresses){if(!ValidationUtils.isNonemptyArray(arrAddresses))return callbacks.ifError("no addresses");if(arrKnownStableUnits&&!ValidationUtils.isNonemptyArray(arrKnownStableUnits))return callbacks.ifError("known_stable_units must be non-empty array")}if(arrRequestedJoints&&!ValidationUtils.isNonemptyArray(arrRequestedJoints))return callbacks.ifError("no requested joints");if(!ValidationUtils.isArrayOfLength(arrWitnesses,constants.COUNT_WITNESSES))return callbacks.ifError("wrong number of witnesses");var assocKnownStableUnits={};arrKnownStableUnits&&arrKnownStableUnits.forEach(function(unit){assocKnownStableUnits[unit]=!0});var objResponse={},arrSelects=[];if(arrAddresses){var strAddressList=arrAddresses.map(db.escape).join(", ");arrSelects=["SELECT DISTINCT unit, main_chain_index, level FROM outputs JOIN units USING(unit) \n\t\t\tWHERE address IN("+strAddressList+") AND (+sequence='good' OR is_stable=1) \n\t\t\tUNION \n\t\t\tSELECT DISTINCT unit, main_chain_index, level FROM unit_authors JOIN units USING(unit) \n\t\t\tWHERE address IN("+strAddressList+") AND (+sequence='good' OR is_stable=1) \n"]}if(arrRequestedJoints){var strUnitList=arrRequestedJoints.map(db.escape).join(", ");arrSelects.push("SELECT unit, main_chain_index, level FROM units WHERE unit IN("+strUnitList+") AND (+sequence='good' OR is_stable=1) \n")}var sql=arrSelects.join("UNION \n")+"ORDER BY main_chain_index DESC, level DESC";db.query(sql,function(rows){return rows=rows.filter(function(row){return!assocKnownStableUnits[row.unit]}),0===rows.length?callbacks.ifOk(objResponse):rows.length>MAX_HISTORY_ITEMS?callbacks.ifError("your history is too large, consider switching to a full client"):void witnessProof.prepareWitnessProof(arrWitnesses,0,function(err,arrUnstableMcJoints,arrWitnessChangeAndDefinitionJoints,last_ball_unit,last_ball_mci){if(err)return callbacks.ifError(err);objResponse.unstable_mc_joints=arrUnstableMcJoints,arrWitnessChangeAndDefinitionJoints.length>0&&(objResponse.witness_change_and_definition_joints=arrWitnessChangeAndDefinitionJoints),objResponse.joints=[],objResponse.proofchain_balls=[];var later_mci=last_ball_mci+1;async.eachSeries(rows,function(row,cb2){storage.readJoint(db,row.unit,{ifNotFound:function(){throw Error("prepareJointsWithProofs unit not found "+row.unit)},ifFound:function(objJoint){return objResponse.joints.push(objJoint),row.main_chain_index>last_ball_mci||null===row.main_chain_index?cb2():void buildProofChain(later_mci,row.main_chain_index,row.unit,objResponse.proofchain_balls,function(){later_mci=row.main_chain_index,cb2()})}})},function(){0===objResponse.proofchain_balls.length&&delete objResponse.proofchain_balls,callbacks.ifOk(objResponse)})})})}function processHistory(objResponse,callbacks){return"joints"in objResponse?ValidationUtils.isNonemptyArray(objResponse.unstable_mc_joints)?(objResponse.witness_change_and_definition_joints||(objResponse.witness_change_and_definition_joints=[]),Array.isArray(objResponse.witness_change_and_definition_joints)?ValidationUtils.isNonemptyArray(objResponse.joints)?(objResponse.proofchain_balls||(objResponse.proofchain_balls=[]),void witnessProof.processWitnessProof(objResponse.unstable_mc_joints,objResponse.witness_change_and_definition_joints,!1,function(err,arrLastBallUnits,assocLastBallByLastBallUnit){if(err)return callbacks.ifError(err);var assocKnownBalls={};for(var unit in assocLastBallByLastBallUnit){var ball=assocLastBallByLastBallUnit[unit];assocKnownBalls[ball]=!0}for(var assocProvenUnitsNonserialness={},i=0;i<objResponse.proofchain_balls.length;i++){var objBall=objResponse.proofchain_balls[i];if(objBall.ball!==objectHash.getBallHash(objBall.unit,objBall.parent_balls,objBall.skiplist_balls,objBall.is_nonserial))return callbacks.ifError("wrong ball hash");if(!assocKnownBalls[objBall.ball])return callbacks.ifError("ball not known");objBall.parent_balls.forEach(function(parent_ball){assocKnownBalls[parent_ball]=!0}),objBall.skiplist_balls&&objBall.skiplist_balls.forEach(function(skiplist_ball){assocKnownBalls[skiplist_ball]=!0}),assocProvenUnitsNonserialness[objBall.unit]=objBall.is_nonserial}assocKnownBalls=null;for(var i=0;i<objResponse.joints.length;i++){var objJoint=objResponse.joints[i],objUnit=objJoint.unit;if(!validation.hasValidHashes(objJoint))return callbacks.ifError("invalid hash");if(!ValidationUtils.isPositiveInteger(objUnit.timestamp))return callbacks.ifError("no timestamp")}mutex.lock(["light_joints"],function(unlock){var arrUnits=objResponse.joints.map(function(objJoint){return objJoint.unit.unit});breadcrumbs.add("got light_joints for processHistory "+arrUnits.join(", ")),db.query("SELECT unit, is_stable FROM units WHERE unit IN(?)",[arrUnits],function(rows){var assocExistingUnits={};rows.forEach(function(row){assocExistingUnits[row.unit]=!0});var arrProvenUnits=[];async.eachSeries(objResponse.joints.reverse(),function(objJoint,cb2){var objUnit=objJoint.unit,unit=objUnit.unit,sequence=assocProvenUnitsNonserialness[unit]?"final-bad":"good";unit in assocProvenUnitsNonserialness&&arrProvenUnits.push(unit),assocExistingUnits[unit]?db.query("UPDATE units SET main_chain_index=?, sequence=? WHERE unit=?",[objUnit.main_chain_index,sequence,unit],function(){cb2()}):writer.saveJoint(objJoint,{sequence:sequence,arrDoubleSpendInputs:[],arrAdditionalQueries:[]},null,cb2)},function(err){return breadcrumbs.add("processHistory almost done"),err?(unlock(),callbacks.ifError(err)):void fixIsSpentFlagAndInputAddress(function(){return 0===arrProvenUnits.length?(unlock(),callbacks.ifOk()):void db.query("UPDATE units SET is_stable=1, is_free=0 WHERE unit IN(?)",[arrProvenUnits],function(){unlock(),callbacks.ifOk()})})})})})})):callbacks.ifError("no joints"):callbacks.ifError("witness_change_and_definition_joints must be array")):callbacks.ifError("no unstable_mc_joints"):callbacks.ifOk()}function fixIsSpentFlag(onDone){db.query("SELECT outputs.unit, outputs.message_index, outputs.output_index \n\t\tFROM outputs \n\t\tJOIN inputs ON outputs.unit=inputs.src_unit AND outputs.message_index=inputs.src_message_index AND outputs.output_index=inputs.src_output_index \n\t\tWHERE is_spent=0 AND type='transfer'",function(rows){if(console.log(rows.length+" previous outputs appear to be spent"),0===rows.length)return onDone();var arrQueries=[];rows.forEach(function(row){console.log("fixing is_spent for output",row),db.addQuery(arrQueries,"UPDATE outputs SET is_spent=1 WHERE unit=? AND message_index=? AND output_index=?",[row.unit,row.message_index,row.output_index])}),async.series(arrQueries,onDone)})}function fixInputAddress(onDone){db.query("SELECT outputs.unit, outputs.message_index, outputs.output_index, outputs.address \n\t\tFROM outputs \n\t\tJOIN inputs ON outputs.unit=inputs.src_unit AND outputs.message_index=inputs.src_message_index AND outputs.output_index=inputs.src_output_index \n\t\tWHERE inputs.address IS NULL AND type='transfer'",function(rows){if(console.log(rows.length+" previous inputs appear to be without address"),0===rows.length)return onDone();var arrQueries=[];rows.forEach(function(row){console.log("fixing input address for output",row),db.addQuery(arrQueries,"UPDATE inputs SET address=? WHERE src_unit=? AND src_message_index=? AND src_output_index=?",[row.address,row.unit,row.message_index,row.output_index])}),async.series(arrQueries,onDone)})}function fixIsSpentFlagAndInputAddress(onDone){fixIsSpentFlag(function(){fixInputAddress(onDone)})}function determineIfHaveUnstableJoints(arrAddresses,handleResult){return 0===arrAddresses.length?handleResult(!1):void db.query("SELECT DISTINCT unit, main_chain_index FROM outputs JOIN units USING(unit) \n\t\tWHERE address IN(?) AND +sequence='good' AND is_stable=0 \n\t\tUNION \n\t\tSELECT DISTINCT unit, main_chain_index FROM unit_authors JOIN units USING(unit) \n\t\tWHERE address IN(?) AND +sequence='good' AND is_stable=0 \n\t\tLIMIT 1",[arrAddresses,arrAddresses],function(rows){handleResult(rows.length>0)})}function prepareParentsAndLastBallAndWitnessListUnit(arrWitnesses,callbacks){return ValidationUtils.isArrayOfLength(arrWitnesses,constants.COUNT_WITNESSES)?void storage.determineIfWitnessAddressDefinitionsHaveReferences(db,arrWitnesses,function(bWithReferences){return bWithReferences?callbacks.ifError("some witnesses have references in their addresses"):void parentComposer.pickParentUnitsAndLastBall(db,arrWitnesses,function(err,arrParentUnits,last_stable_mc_ball,last_stable_mc_ball_unit,last_stable_mc_ball_mci){if(err)return callbacks.ifError("unable to find parents: "+err);var objResponse={parent_units:arrParentUnits,last_stable_mc_ball:last_stable_mc_ball,last_stable_mc_ball_unit:last_stable_mc_ball_unit,last_stable_mc_ball_mci:last_stable_mc_ball_mci};storage.findWitnessListUnit(db,arrWitnesses,last_stable_mc_ball_mci,function(witness_list_unit){witness_list_unit&&(objResponse.witness_list_unit=witness_list_unit),callbacks.ifOk(objResponse)})})}):callbacks.ifError("wrong number of witnesses")}function prepareLinkProofs(arrUnits,callbacks){if(!ValidationUtils.isNonemptyArray(arrUnits))return callbacks.ifError("no units array");if(1===arrUnits.length)return callbacks.ifError("chain of one element");var arrChain=[];async.forEachOfSeries(arrUnits,function(unit,i,cb){return 0===i?cb():void createLinkProof(arrUnits[i-1],arrUnits[i],arrChain,cb)},function(err){return err?callbacks.ifError(err):void callbacks.ifOk(arrChain)})}function createLinkProof(later_unit,earlier_unit,arrChain,cb){storage.readJoint(db,later_unit,{ifNotFound:function(){cb("later unit not found")},ifFound:function(objLaterJoint){var later_mci=objLaterJoint.unit.main_chain_index;arrChain.push(objLaterJoint),storage.readUnitProps(db,objLaterJoint.unit.last_ball_unit,function(objLaterLastBallUnitProps){var later_lb_mci=objLaterLastBallUnitProps.main_chain_index;storage.readJoint(db,earlier_unit,{ifNotFound:function(){cb("earlier unit not found")},ifFound:function(objEarlierJoint){var earlier_mci=objEarlierJoint.unit.main_chain_index,earlier_unit=objEarlierJoint.unit.unit;return later_mci<earlier_mci?cb("not included"):void(later_lb_mci>=earlier_mci?buildProofChain(later_lb_mci+1,earlier_mci,earlier_unit,arrChain,function(){cb()}):graph.determineIfIncluded(db,earlier_unit,[later_unit],function(bIncluded){return bIncluded?void buildPath(objLaterJoint,objEarlierJoint,arrChain,function(){cb()}):cb("not included")}))}})})}})}function buildPath(objLaterJoint,objEarlierJoint,arrChain,onDone){function addJoint(unit,onAdded){storage.readJoint(db,unit,{ifNotFound:function(){throw Error("unit not found?")},ifFound:function(objJoint){arrChain.push(objJoint),onAdded(objJoint)}})}function goUp(objChildJoint){db.query("SELECT parent.unit, parent.main_chain_index FROM units AS child JOIN units AS parent ON child.best_parent_unit=parent.unit \n\t\t\tWHERE child.unit=?",[objChildJoint.unit.unit],function(rows){if(1!==rows.length)throw Error("goUp not 1 parent");return rows[0].main_chain_index<objEarlierJoint.unit.main_chain_index?buildPathToEarlierUnit(objChildJoint):void addJoint(rows[0].unit,function(objJoint){objJoint.unit.main_chain_index===objEarlierJoint.unit.main_chain_index?buildPathToEarlierUnit(objJoint):goUp(objJoint)})})}function buildPathToEarlierUnit(objJoint){db.query("SELECT unit FROM parenthoods JOIN units ON parent_unit=unit \n\t\t\tWHERE child_unit=? AND main_chain_index=?",[objJoint.unit.unit,objJoint.unit.main_chain_index],function(rows){if(0===rows.length)throw Error("no parents with same mci?");var arrParentUnits=rows.map(function(row){return row.unit});return arrParentUnits.indexOf(objEarlierJoint.unit.unit)>=0?onDone():1===arrParentUnits.length?addJoint(arrParentUnits[0],buildPathToEarlierUnit):void async.eachSeries(arrParentUnits,function(unit,cb){graph.determineIfIncluded(db,objEarlierJoint.unit.unit,[unit],function(bIncluded){return bIncluded?void cb(unit):cb()})},function(unit){if(!unit)throw Error("none of the parents includes earlier unit");addJoint(unit,buildPathToEarlierUnit)})})}return objLaterJoint.unit.unit===objEarlierJoint.unit.unit?onDone():void(objLaterJoint.unit.main_chain_index===objEarlierJoint.unit.main_chain_index?buildPathToEarlierUnit(objLaterJoint):goUp(objLaterJoint))}function processLinkProofs(arrUnits,arrChain,callbacks){var objFirstJoint=arrChain[0];if(!objFirstJoint||!objFirstJoint.unit||objFirstJoint.unit.unit!==arrUnits[0])return callbacks.ifError("unexpected 1st element");var assocKnownUnits={},assocKnownBalls={};assocKnownUnits[arrUnits[0]]=!0;for(var i=0;i<arrChain.length;i++){var objElement=arrChain[i];if(objElement.unit&&objElement.unit.unit){var objJoint=objElement,objUnit=objJoint.unit,unit=objUnit.unit;if(!assocKnownUnits[unit])return callbacks.ifError("unknown unit "+unit);if(!validation.hasValidHashes(objJoint))return callbacks.ifError("invalid hash of unit "+unit);assocKnownBalls[objUnit.last_ball]=!0,assocKnownUnits[objUnit.last_ball_unit]=!0,objUnit.parent_units.forEach(function(parent_unit){assocKnownUnits[parent_unit]=!0})}else{if(!objElement.unit||!objElement.ball)return callbacks.ifError("unrecognized chain element");var objBall=objElement;if(!assocKnownBalls[objBall.ball])return callbacks.ifError("unknown ball "+objBall.ball);if(objBall.ball!==objectHash.getBallHash(objBall.unit,objBall.parent_balls,objBall.skiplist_balls,objBall.is_nonserial))return callbacks.ifError("invalid ball hash");objBall.parent_balls.forEach(function(parent_ball){assocKnownBalls[parent_ball]=!0}),objBall.skiplist_balls&&objBall.skiplist_balls.forEach(function(skiplist_ball){assocKnownBalls[skiplist_ball]=!0}),assocKnownUnits[objBall.unit]=!0}}for(var i=1;i<arrUnits.length;i++)if(!assocKnownUnits[arrUnits[i]])return callbacks.ifError("unit "+arrUnits[i]+" not found in the chain");callbacks.ifOk()}var async=require("async"),storage=require("./storage.js"),objectHash=require("./object_hash.js"),db=require("./db.js"),mutex=require("./mutex.js"),constants=require("./constants.js"),graph=require("./graph.js"),writer=require("./writer.js"),validation=require("./validation.js"),witnessProof=require("./witness_proof.js"),ValidationUtils=require("./validation_utils.js"),parentComposer=require("./parent_composer.js"),breadcrumbs=require("./breadcrumbs.js"),MAX_HISTORY_ITEMS=1e3;exports.prepareHistory=prepareHistory,exports.processHistory=processHistory,exports.prepareLinkProofs=prepareLinkProofs,exports.processLinkProofs=processLinkProofs,exports.determineIfHaveUnstableJoints=determineIfHaveUnstableJoints,exports.prepareParentsAndLastBallAndWitnessListUnit=prepareParentsAndLastBallAndWitnessListUnit},{"./breadcrumbs.js":365,"./constants.js":371,"./db.js":372,"./graph.js":379,"./mutex.js":388,"./object_hash.js":392,"./parent_composer.js":396,"./storage.js":402,"./validation.js":404,"./validation_utils.js":405,"./witness_proof.js":410,"./writer.js":411,async:26}],384:[function(require,module,exports){"use strict";function setLightVendorHost(light_vendor_host){network.light_vendor_url=conf.WS_PROTOCOL+light_vendor_host,conf.bLight&&(refreshLightClientHistory(),setInterval(reconnectToLightVendor,RECONNECT_TO_LIGHT_VENDOR_PERIOD),eventBus.on("connected",reconnectToLightVendor))}function reconnectToLightVendor(){network.findOutboundPeerOrConnect(network.light_vendor_url,function(err,ws){return err?console.log("reconnectToLightVendor: "+err):ws.bLightVendor?console.log("already connected to light vendor"):ws.bRefreshingHistory?console.log("already refreshing history"):void refreshLightClientHistory()})}function readListOfUnstableUnits(handleUnits){db.query("SELECT unit FROM units WHERE is_stable=0",function(rows){var arrUnits=rows.map(function(row){return row.unit});handleUnits(arrUnits)})}function prepareRequestForHistory(handleResult){myWitnesses.readMyWitnesses(function(arrWitnesses){if(0===arrWitnesses.length)return handleResult(null);var objHistoryRequest={witnesses:arrWitnesses};walletGeneral.readMyAddresses(function(arrAddresses){arrAddresses.length>0&&(objHistoryRequest.addresses=arrAddresses),readListOfUnstableUnits(function(arrUnits){if(arrUnits.length>0&&(objHistoryRequest.requested_joints=arrUnits),!objHistoryRequest.addresses&&!objHistoryRequest.requested_joints)return handleResult(null);if(!objHistoryRequest.addresses)return handleResult(objHistoryRequest);objHistoryRequest.last_stable_mci=0;var strAddressList=arrAddresses.map(db.escape).join(", ");db.query("SELECT unit FROM unit_authors JOIN units USING(unit) WHERE is_stable=1 AND address IN("+strAddressList+") \n\t\t\t\t\tUNION \n\t\t\t\t\tSELECT unit FROM outputs JOIN units USING(unit) WHERE is_stable=1 AND address IN("+strAddressList+")",function(rows){rows.length&&(objHistoryRequest.known_stable_units=rows.map(function(row){return row.unit})),handleResult(objHistoryRequest)})})})},"wait")}function refreshLightClientHistory(){if(conf.bLight){if(!network.light_vendor_url)return console.log("refreshLightClientHistory called too early: light_vendor_url not set yet");eventBus.emit("refresh_light_started"),network.findOutboundPeerOrConnect(network.light_vendor_url,function(err,ws){var finish=function(msg){msg&&console.log(msg),ws&&(ws.bRefreshingHistory=!1),eventBus.emit("refresh_light_done")};return err?finish("refreshLightClientHistory: "+err):(console.log("refreshLightClientHistory connected"),ws.bRefreshingHistory?console.log("previous refresh not finished yet"):(ws.bRefreshingHistory=!0,void prepareRequestForHistory(function(objRequest){return objRequest?void network.sendRequest(ws,"light/get_history",objRequest,!1,function(ws,request,response){if(response.error)return finish(response.error);ws.bLightVendor=!0;var interval=setInterval(function(){eventBus.emit("maybe_new_transactions")},500);light.processHistory(response,{ifError:function(err){clearInterval(interval),network.sendError(ws,err),finish()},ifOk:function(){clearInterval(interval),finish(),eventBus.emit("maybe_new_transactions")}})}):finish()})))})}}var db=require("./db.js"),conf=require("./conf.js"),myWitnesses=require("./my_witnesses.js"),network=require("./network.js"),walletGeneral=require("./wallet_general.js"),light=require("./light.js"),eventBus=require("./event_bus.js"),RECONNECT_TO_LIGHT_VENDOR_PERIOD=6e4;exports.setLightVendorHost=setLightVendorHost,exports.refreshLightClientHistory=refreshLightClientHistory},{"./conf.js":370,"./db.js":372,"./event_bus.js":378,"./light.js":383,"./my_witnesses.js":389,"./network.js":391,"./wallet_general.js":409}],385:[function(require,module,exports){(function(process){"use strict";function updateMainChain(conn,last_unit,onDone){function findNextUpMainChainUnit(unit,handleUnit){function handleProps(props){if(null===props.best_parent_unit)throw Error("best parent is null");console.log("unit "+unit+", best parent "+props.best_parent_unit+", wlevel "+props.witnessed_level),handleUnit(props.best_parent_unit)}function readLastUnitProps(handleLastUnitProps){conn.query("SELECT unit AS best_parent_unit, witnessed_level \n\t\t\t\tFROM units WHERE is_free=1 \n\t\t\t\tORDER BY witnessed_level DESC, \n\t\t\t\t\tlevel-witnessed_level ASC, \n\t\t\t\t\tunit ASC \n\t\t\t\tLIMIT 1",function(rows){if(0===rows.length)throw Error("no free units?");handleLastUnitProps(rows[0])})}unit?storage.readStaticUnitProps(conn,unit,handleProps):readLastUnitProps(handleProps)}function goUpFromUnit(unit){return storage.isGenesisUnit(unit)?checkNotRebuildingStableMainChainAndGoDown(0,unit):(profiler.start(),void findNextUpMainChainUnit(unit,function(best_parent_unit){storage.readUnitProps(conn,best_parent_unit,function(objBestParentUnitProps){objBestParentUnitProps.is_on_main_chain?(profiler.stop("mc-goUpFromUnit"),null===unit?updateLatestIncludedMcIndex(objBestParentUnitProps.main_chain_index,!1):checkNotRebuildingStableMainChainAndGoDown(objBestParentUnitProps.main_chain_index,best_parent_unit)):conn.query("UPDATE units SET is_on_main_chain=1, main_chain_index=NULL WHERE unit=?",[best_parent_unit],function(){profiler.stop("mc-goUpFromUnit"),goUpFromUnit(best_parent_unit)})})}))}function checkNotRebuildingStableMainChainAndGoDown(last_main_chain_index,last_main_chain_unit){console.log("checkNotRebuildingStableMainChainAndGoDown "+last_unit),profiler.start(),conn.query("SELECT unit FROM units WHERE is_on_main_chain=1 AND main_chain_index>? AND is_stable=1 LIMIT 1",[last_main_chain_index],function(rows){if(profiler.stop("mc-checkNotRebuilding"),rows.length>0)throw Error("removing stable witnessed unit "+rows[0].unit+" from main chain");goDownAndUpdateMainChainIndex(last_main_chain_index,last_main_chain_unit)})}function goDownAndUpdateMainChainIndex(last_main_chain_index,last_main_chain_unit){profiler.start(),conn.query("UPDATE units SET is_on_main_chain=0, main_chain_index=NULL WHERE main_chain_index>?",[last_main_chain_index],function(){var main_chain_index=last_main_chain_index;conn.query("SELECT unit FROM units WHERE is_on_main_chain=1 AND main_chain_index IS NULL ORDER BY level",function(rows){if(0===rows.length)throw Error("no unindexed MC units?");async.eachSeries(rows,function(row,cb){function goUp(arrStartUnits){conn.query("SELECT unit \n\t\t\t\t\t\t\t\t\t\tFROM parenthoods JOIN units ON parent_unit=unit \n\t\t\t\t\t\t\t\t\t\tWHERE child_unit IN(?) AND main_chain_index IS NULL",[arrStartUnits],function(rows){if(0===rows.length)return updateMc();var arrNewStartUnits=rows.map(function(row){return row.unit});arrUnits=arrUnits.concat(arrNewStartUnits),goUp(arrNewStartUnits)})}function updateMc(){conn.query("UPDATE units SET main_chain_index=? WHERE unit IN(?)",[main_chain_index,arrUnits],function(){cb()})}main_chain_index++;var arrUnits=[row.unit];goUp(arrUnits)},function(err){if(console.log("goDownAndUpdateMainChainIndex done"),err)throw Error("goDownAndUpdateMainChainIndex eachSeries failed");profiler.stop("mc-goDown"),updateLatestIncludedMcIndex(last_main_chain_index,!0)})})})}function updateLatestIncludedMcIndex(last_main_chain_index,bRebuiltMc){function checkAllLatestIncludedMcIndexesAreSet(){profiler.start(),conn.query("SELECT unit FROM units WHERE latest_included_mc_index IS NULL AND level!=0",function(rows){if(rows.length>0)throw Error(rows.length+" units have latest_included_mc_index=NULL, e.g. unit "+rows[0].unit);profiler.stop("mc-limci-check"),updateStableMcFlag()})}function propagateLIMCI(){console.log("propagateLIMCI "+last_main_chain_index),profiler.start(),conn.query("SELECT punits.latest_included_mc_index, chunits.unit \n\t\t\t\tFROM units AS punits \n\t\t\t\tJOIN parenthoods ON punits.unit=parent_unit \n\t\t\t\tJOIN units AS chunits ON child_unit=chunits.unit \n\t\t\t\tWHERE (chunits.main_chain_index > ? OR chunits.main_chain_index IS NULL) \n\t\t\t\t\tAND (chunits.latest_included_mc_index IS NULL OR chunits.latest_included_mc_index < punits.latest_included_mc_index)",[last_main_chain_index],function(rows){return profiler.stop("mc-limci-select-propagate"),0===rows.length?checkAllLatestIncludedMcIndexesAreSet():(profiler.start(),void async.eachSeries(rows,function(row,cb){conn.query("UPDATE units SET latest_included_mc_index=? WHERE unit=?",[row.latest_included_mc_index,row.unit],function(){cb()})},function(){profiler.stop("mc-limci-update-propagate"),propagateLIMCI()}))})}console.log("updateLatestIncludedMcIndex "+last_main_chain_index),profiler.start(),conn.query("UPDATE units SET latest_included_mc_index=NULL WHERE main_chain_index>? OR main_chain_index IS NULL",[last_main_chain_index],function(res){console.log("update LIMCI=NULL done, matched rows: "+res.affectedRows),profiler.stop("mc-limci-set-null"),profiler.start(),conn.query("SELECT chunits.unit, punits.main_chain_index \n\t\t\t\tFROM units AS punits \n\t\t\t\tJOIN parenthoods ON punits.unit=parent_unit \n\t\t\t\tJOIN units AS chunits ON child_unit=chunits.unit \n\t\t\t\tWHERE punits.is_on_main_chain=1 \n\t\t\t\t\tAND (chunits.main_chain_index > ? OR chunits.main_chain_index IS NULL) \n\t\t\t\t\tAND chunits.latest_included_mc_index IS NULL",[last_main_chain_index],function(rows){if(console.log(rows.length+" rows"),profiler.stop("mc-limci-select-initial"),profiler.start(),0===rows.length&&bRebuiltMc)throw Error("no latest_included_mc_index updated, last_mci="+last_main_chain_index+", affected="+res.affectedRows);async.eachSeries(rows,function(row,cb){console.log(row.main_chain_index,row.unit),conn.query("UPDATE units SET latest_included_mc_index=? WHERE unit=?",[row.main_chain_index,row.unit],function(){cb()})},function(){profiler.stop("mc-limci-update-initial"),propagateLIMCI()})})})}function readLastStableMcUnit(handleLastStableMcUnit){conn.query("SELECT unit FROM units WHERE is_on_main_chain=1 AND is_stable=1 ORDER BY main_chain_index DESC LIMIT 1",function(rows){if(0===rows.length)throw Error("no units on stable MC?");handleLastStableMcUnit(rows[0].unit)})}function updateStableMcFlag(){console.log("updateStableMcFlag"),profiler.start(),readLastStableMcUnit(function(last_stable_mc_unit){console.log("last stable mc unit "+last_stable_mc_unit),storage.readWitnesses(conn,last_stable_mc_unit,function(arrWitnesses){conn.query("SELECT unit, is_on_main_chain, main_chain_index, level FROM units WHERE best_parent_unit=?",[last_stable_mc_unit],function(rows){function advanceLastStableMcUnitAndTryNext(){profiler.stop("mc-stableFlag"),markMcIndexStable(conn,first_unstable_mc_index,updateStableMcFlag)}if(0===rows.length)throw Error("no best children of last stable MC unit "+last_stable_mc_unit+"?");var arrMcRows=rows.filter(function(row){return 1===row.is_on_main_chain}),arrAltRows=rows.filter(function(row){return 0===row.is_on_main_chain;
});if(1!==arrMcRows.length)throw Error("not a single MC child?");var first_unstable_mc_index=(arrMcRows[0].unit,arrMcRows[0].main_chain_index),first_unstable_mc_level=arrMcRows[0].level,arrAltBranchRootUnits=arrAltRows.map(function(row){return row.unit});conn.query("SELECT witnessed_level FROM units WHERE is_free=1 AND is_on_main_chain=1",function(wl_rows){if(1!==wl_rows.length)throw Error("not a single mc wl");var mc_end_witnessed_level=wl_rows[0].witnessed_level;conn.query("SELECT MIN(witnessed_level) AS min_mc_wl FROM units LEFT JOIN unit_authors USING(unit) \n\t\t\t\t\t\t\tWHERE is_on_main_chain=1 AND level>=? AND address IN(?)",[mc_end_witnessed_level,arrWitnesses],function(min_wl_rows){if(1!==min_wl_rows.length)throw Error("not a single min mc wl");var min_mc_wl=min_wl_rows[0].min_mc_wl;return 0===arrAltBranchRootUnits.length?min_mc_wl>=first_unstable_mc_level?advanceLastStableMcUnitAndTryNext():finish():void createListOfBestChildren(arrAltBranchRootUnits,function(arrAltBestChildren){conn.query("SELECT MAX(units.level) AS max_alt_level \n\t\t\t\t\t\t\t\t\t\tFROM units \n\t\t\t\t\t\t\t\t\t\tLEFT JOIN parenthoods ON units.unit=child_unit \n\t\t\t\t\t\t\t\t\t\tLEFT JOIN units AS punits ON parent_unit=punits.unit AND punits.witnessed_level >= units.witnessed_level \n\t\t\t\t\t\t\t\t\t\tWHERE units.unit IN(?) AND punits.unit IS NULL AND ( \n\t\t\t\t\t\t\t\t\t\t\tSELECT COUNT(*) \n\t\t\t\t\t\t\t\t\t\t\tFROM unit_witnesses \n\t\t\t\t\t\t\t\t\t\t\tWHERE unit_witnesses.unit IN(units.unit, units.witness_list_unit) AND unit_witnesses.address IN(?) \n\t\t\t\t\t\t\t\t\t\t)>=?",[arrAltBestChildren,arrWitnesses,constants.COUNT_WITNESSES-constants.MAX_WITNESS_LIST_MUTATIONS],function(max_alt_rows){if(1!==max_alt_rows.length)throw Error("not a single max alt level");var max_alt_level=max_alt_rows[0].max_alt_level;min_mc_wl>max_alt_level?advanceLastStableMcUnitAndTryNext():finish()})})})})})})})}function createListOfBestChildren(arrParentUnits,handleBestChildrenList){function goDownAndCollectBestChildren(arrStartUnits,cb){conn.query("SELECT unit, is_free FROM units WHERE best_parent_unit IN(?)",[arrStartUnits],function(rows){return 0===rows.length?cb():void async.eachSeries(rows,function(row,cb2){arrBestChildren.push(row.unit),1===row.is_free?cb2():goDownAndCollectBestChildren([row.unit],cb2)},cb)})}if(0===arrParentUnits.length)return handleBestChildrenList([]);var arrBestChildren=arrParentUnits.slice();goDownAndCollectBestChildren(arrParentUnits,function(){handleBestChildrenList(arrBestChildren)})}function finish(){profiler.stop("mc-stableFlag"),console.log("done updating MC\n"),onDone&&onDone()}console.log("\nwill update MC"),goUpFromUnit(last_unit)}function determineIfStableInLaterUnits(conn,earlier_unit,arrLaterUnits,handleResult){return storage.isGenesisUnit(earlier_unit)?handleResult(!0):"LGFzduLJNQNzEqJqUXdkXr58wDYx77V8WurDF3+GIws="===earlier_unit&&"6O4t3j8kW0/Lo7n2nuS8ITDv2UbOhlL9fF1M6j/PrJ4="===arrLaterUnits.join(",")?handleResult(!0):void storage.readPropsOfUnits(conn,earlier_unit,arrLaterUnits,function(objEarlierUnitProps,arrLaterUnitProps){if(1===objEarlierUnitProps.is_free)return handleResult(!1);var max_later_limci=Math.max.apply(null,arrLaterUnitProps.map(function(objLaterUnitProps){return objLaterUnitProps.latest_included_mc_index}));readBestParentAndItsWitnesses(conn,earlier_unit,function(best_parent_unit,arrWitnesses){conn.query("SELECT unit, is_on_main_chain, main_chain_index, level FROM units WHERE best_parent_unit=?",[best_parent_unit],function(rows){function findMinMcWitnessedLevel(handleMinMcWl){function goUp(start_unit){conn.query("SELECT best_parent_unit, witnessed_level, \n\t\t\t\t\t\t\t\t(SELECT COUNT(*) FROM unit_authors WHERE unit_authors.unit=units.unit AND address IN(?)) AS count \n\t\t\t\t\t\t\tFROM units WHERE unit=?",[arrWitnesses,start_unit],function(rows){if(1!==rows.length)throw Error("findMinMcWitnessedLevel: not 1 row");var row=rows[0];row.count>0&&row.witnessed_level<min_mc_wl&&(min_mc_wl=row.witnessed_level),count+=row.count,count<constants.MAJORITY_OF_WITNESSES?goUp(row.best_parent_unit):handleMinMcWl(min_mc_wl)})}var min_mc_wl=Number.MAX_VALUE,count=0;conn.query("SELECT witnessed_level, best_parent_unit, \n\t\t\t\t\t\t\t(SELECT COUNT(*) FROM unit_authors WHERE unit_authors.unit=units.unit AND address IN(?)) AS count \n\t\t\t\t\t\tFROM units \n\t\t\t\t\t\tWHERE unit IN(?) \n\t\t\t\t\t\tORDER BY witnessed_level DESC, \n\t\t\t\t\t\t\tlevel-witnessed_level ASC, \n\t\t\t\t\t\t\tunit ASC \n\t\t\t\t\t\tLIMIT 1",[arrWitnesses,arrLaterUnits],function(rows){var row=rows[0];row.count>0&&(min_mc_wl=row.witnessed_level),count+=row.count,goUp(row.best_parent_unit)})}function determineIfHasAltBranches(handleHasAltBranchesResult){return 0===arrAltBranchRootUnits.length?handleHasAltBranchesResult(!1):void async.eachSeries(arrAltBranchRootUnits,function(alt_root_unit,cb){graph.determineIfIncludedOrEqual(conn,alt_root_unit,arrLaterUnits,function(bIncluded){bIncluded?cb("included"):cb()})},function(err){handleHasAltBranchesResult(!!err)})}function createListOfBestChildrenIncludedByLaterUnits(arrAltBranchRootUnits,handleBestChildrenList){function goDownAndCollectBestChildren(arrStartUnits,cb){conn.query("SELECT unit, is_free, main_chain_index FROM units WHERE best_parent_unit IN(?)",[arrStartUnits],function(rows){return 0===rows.length?cb():void async.eachSeries(rows,function(row,cb2){function addUnit(){arrBestChildren.push(row.unit),1===row.is_free?cb2():goDownAndCollectBestChildren([row.unit],cb2)}null!==row.main_chain_index&&row.main_chain_index<=max_later_limci?addUnit():graph.determineIfIncludedOrEqual(conn,row.unit,arrLaterUnits,function(bIncluded){bIncluded?addUnit():cb2()})},cb)})}function filterAltBranchRootUnits(cb){var arrFilteredAltBranchRootUnits=[];conn.query("SELECT unit, is_free, main_chain_index FROM units WHERE unit IN(?)",[arrAltBranchRootUnits],function(rows){if(0===rows.length)throw Error("no alt branch root units?");async.eachSeries(rows,function(row,cb2){function addUnit(){arrBestChildren.push(row.unit),arrFilteredAltBranchRootUnits.push(row.unit),cb2()}null!==row.main_chain_index&&row.main_chain_index<=max_later_limci?addUnit():graph.determineIfIncludedOrEqual(conn,row.unit,arrLaterUnits,function(bIncluded){bIncluded?addUnit():cb2()})},function(){goDownAndCollectBestChildren(arrFilteredAltBranchRootUnits,cb)})})}if(0===arrAltBranchRootUnits.length)return handleBestChildrenList([]);var arrBestChildren=[];filterAltBranchRootUnits(function(){handleBestChildrenList(arrBestChildren)})}if(0===rows.length)throw Error("no best children of "+best_parent_unit+"?");var arrMcRows=rows.filter(function(row){return 1===row.is_on_main_chain}),arrAltRows=rows.filter(function(row){return 0===row.is_on_main_chain});if(1!==arrMcRows.length)throw Error("not a single MC child?");var first_unstable_mc_unit=arrMcRows[0].unit;if(first_unstable_mc_unit!==earlier_unit)throw Error("first unstable MC unit is not our input unit");var first_unstable_mc_level=(arrMcRows[0].main_chain_index,arrMcRows[0].level),arrAltBranchRootUnits=arrAltRows.map(function(row){return row.unit});findMinMcWitnessedLevel(function(min_mc_wl){determineIfHasAltBranches(function(bHasAltBranches){return bHasAltBranches?void createListOfBestChildrenIncludedByLaterUnits(arrAltBranchRootUnits,function(arrAltBestChildren){conn.query("SELECT MAX(units.level) AS max_alt_level \n\t\t\t\t\t\t\t\tFROM units \n\t\t\t\t\t\t\t\tLEFT JOIN parenthoods ON units.unit=child_unit \n\t\t\t\t\t\t\t\tLEFT JOIN units AS punits ON parent_unit=punits.unit AND punits.witnessed_level >= units.witnessed_level \n\t\t\t\t\t\t\t\tWHERE units.unit IN(?) AND punits.unit IS NULL AND ( \n\t\t\t\t\t\t\t\t\tSELECT COUNT(*) \n\t\t\t\t\t\t\t\t\tFROM unit_witnesses \n\t\t\t\t\t\t\t\t\tWHERE unit_witnesses.unit IN(units.unit, units.witness_list_unit) AND unit_witnesses.address IN(?) \n\t\t\t\t\t\t\t\t)>=?",[arrAltBestChildren,arrWitnesses,constants.COUNT_WITNESSES-constants.MAX_WITNESS_LIST_MUTATIONS],function(max_alt_rows){if(1!==max_alt_rows.length)throw Error("not a single max alt level");var max_alt_level=max_alt_rows[0].max_alt_level;handleResult(min_mc_wl>=max_alt_level)})}):handleResult(min_mc_wl>=first_unstable_mc_level?!0:!1)})})})})})}function determineIfStableInLaterUnitsAndUpdateStableMcFlag(conn,earlier_unit,arrLaterUnits,bStableInDb,handleResult){determineIfStableInLaterUnits(conn,earlier_unit,arrLaterUnits,function(bStable){return console.log("determineIfStableInLaterUnits",earlier_unit,arrLaterUnits,bStable),bStable?bStable&&bStableInDb?handleResult(bStable):(breadcrumbs.add("stable in parents, will wait for write lock"),void mutex.lock(["write"],function(unlock){breadcrumbs.add("stable in parents, got write lock"),storage.readLastStableMcIndex(conn,function(last_stable_mci){storage.readUnitProps(conn,earlier_unit,function(objEarlierUnitProps){function advanceLastStableMcUnitAndStepForward(){mci++,mci<=new_last_stable_mci?markMcIndexStable(conn,mci,advanceLastStableMcUnitAndStepForward):(unlock(),handleResult(bStable))}var new_last_stable_mci=objEarlierUnitProps.main_chain_index;if(new_last_stable_mci<=last_stable_mci)throw Error("new last stable mci expected to be higher than existing");var mci=last_stable_mci;advanceLastStableMcUnitAndStepForward()})})})):handleResult(bStable)})}function readBestParentAndItsWitnesses(conn,unit,handleBestParentAndItsWitnesses){storage.readStaticUnitProps(conn,unit,function(props){storage.readWitnesses(conn,props.best_parent_unit,function(arrWitnesses){handleBestParentAndItsWitnesses(props.best_parent_unit,arrWitnesses)})})}function markMcIndexStable(conn,mci,onDone){function handleNonserialUnits(){conn.query("SELECT * FROM units WHERE main_chain_index=? AND sequence!='good' ORDER BY unit",[mci],function(rows){async.eachSeries(rows,function(row,cb){if("final-bad"===row.sequence)return row.content_hash?cb():setContentHash(row.unit,cb);if(row.content_hash)throw Error("temp-bad and with content_hash?");findStableConflictingUnits(row,function(arrConflictingUnits){var sequence=arrConflictingUnits.length>0?"final-bad":"good";console.log("unit "+row.unit+" has competitors "+arrConflictingUnits+", it becomes "+sequence),conn.query("UPDATE units SET sequence=? WHERE unit=?",[sequence,row.unit],function(){"good"===sequence?conn.query("UPDATE inputs SET is_unique=1 WHERE unit=?",[row.unit],function(){cb()}):setContentHash(row.unit,cb)})})},function(){addBalls()})})}function setContentHash(unit,onSet){storage.readJoint(conn,unit,{ifNotFound:function(){throw Error("bad unit not found: "+unit)},ifFound:function(objJoint){var content_hash=objectHash.getUnitContentHash(objJoint.unit);conn.query("UPDATE units SET content_hash=? WHERE unit=?",[content_hash,unit],function(){onSet()})}})}function findStableConflictingUnits(objUnitProps,handleConflictingUnits){conn.query("SELECT competitor_units.* \n\t\t\tFROM unit_authors AS this_unit_authors \n\t\t\tJOIN unit_authors AS competitor_unit_authors USING(address) \n\t\t\tJOIN units AS competitor_units ON competitor_unit_authors.unit=competitor_units.unit \n\t\t\tJOIN units AS this_unit ON this_unit_authors.unit=this_unit.unit \n\t\t\tWHERE this_unit_authors.unit=? AND competitor_units.is_stable=1 AND +competitor_units.sequence='good' \n\t\t\t\t-- if it were main_chain_index <= this_unit_limci, the competitor would've been included \n\t\t\t\tAND (competitor_units.main_chain_index > this_unit.latest_included_mc_index) \n\t\t\t\tAND (competitor_units.main_chain_index <= this_unit.main_chain_index)",[objUnitProps.unit],function(rows){var arrConflictingUnits=[];async.eachSeries(rows,function(row,cb){graph.compareUnitsByProps(conn,row,objUnitProps,function(result){null===result&&arrConflictingUnits.push(row.unit),cb()})},function(){handleConflictingUnits(arrConflictingUnits)})})}function addBalls(){conn.query("SELECT units.*, ball FROM units LEFT JOIN balls USING(unit) \n\t\t\tWHERE main_chain_index=? ORDER BY level",[mci],function(unit_rows){async.eachSeries(unit_rows,function(objUnitProps,cb){var unit=objUnitProps.unit;conn.query("SELECT ball FROM parenthoods LEFT JOIN balls ON parent_unit=unit WHERE child_unit=? ORDER BY ball",[unit],function(parent_ball_rows){function addBall(){var ball=objectHash.getBallHash(unit,arrParentBalls,arrSkiplistBalls.sort(),"final-bad"===objUnitProps.sequence);if(objUnitProps.ball){if(objUnitProps.ball!==ball)throw Error("stored and calculated ball hashes do not match, ball="+ball+", objUnitProps="+JSON.stringify(objUnitProps));return cb()}conn.query("INSERT INTO balls (ball, unit) VALUES(?,?)",[ball,unit],function(){conn.query("DELETE FROM hash_tree_balls WHERE ball=?",[ball],function(){return 0===arrSkiplistUnits.length?cb():void conn.query("INSERT INTO skiplist_units (unit, skiplist_unit) VALUES "+arrSkiplistUnits.map(function(skiplist_unit){return"("+conn.escape(unit)+", "+conn.escape(skiplist_unit)+")"}),function(){cb()})})})}if(parent_ball_rows.some(function(parent_ball_row){return null===parent_ball_row.ball}))throw Error("some parent balls not found for unit "+unit);var arrParentBalls=parent_ball_rows.map(function(parent_ball_row){return parent_ball_row.ball}),arrSimilarMcis=getSimilarMcis(mci),arrSkiplistUnits=[],arrSkiplistBalls=[];1===objUnitProps.is_on_main_chain&&arrSimilarMcis.length>0?conn.query("SELECT units.unit, ball FROM units LEFT JOIN balls USING(unit) \n\t\t\t\t\t\t\t\t\t\tWHERE is_on_main_chain=1 AND main_chain_index IN(?)",[arrSimilarMcis],function(rows){rows.forEach(function(row){var skiplist_unit=row.unit,skiplist_ball=row.ball;if(!skiplist_ball)throw Error("no skiplist ball");arrSkiplistUnits.push(skiplist_unit),arrSkiplistBalls.push(skiplist_ball)}),addBall()}):addBall()})},function(){updateRetrievable()})})}function updateRetrievable(){storage.updateMinRetrievableMciAfterStabilizingMci(conn,mci,function(min_retrievable_mci){profiler.stop("mc-mark-stable"),calcCommissions()})}function calcCommissions(){async.series([function(cb){profiler.start(),headers_commission.calcHeadersCommissions(conn,cb)},function(cb){profiler.stop("mc-headers-commissions"),paid_witnessing.updatePaidWitnesses(conn,cb)}],function(){process.nextTick(function(){eventBus.emit("mci_became_stable",mci)}),onDone()})}profiler.start(),conn.query("UPDATE units SET is_stable=1 WHERE is_stable=0 AND main_chain_index=?",[mci],function(){handleNonserialUnits()})}function getSimilarMcis(mci){for(var arrSimilarMcis=[],divisor=10;;){if(mci%divisor!==0)return arrSimilarMcis;arrSimilarMcis.push(mci-divisor),divisor*=10}}var async=(require("lodash"),require("async")),constants=(require("./db.js"),require("./constants.js")),storage=require("./storage.js"),graph=require("./graph.js"),objectHash=require("./object_hash.js"),paid_witnessing=require("./paid_witnessing.js"),headers_commission=require("./headers_commission.js"),mutex=require("./mutex.js"),eventBus=require("./event_bus.js"),profiler=require("./profiler.js"),breadcrumbs=require("./breadcrumbs.js");exports.updateMainChain=updateMainChain,exports.determineIfStableInLaterUnitsAndUpdateStableMcFlag=determineIfStableInLaterUnitsAndUpdateStableMcFlag,exports.determineIfStableInLaterUnits=determineIfStableInLaterUnits}).call(this,require("_process"))},{"./breadcrumbs.js":365,"./constants.js":371,"./db.js":372,"./event_bus.js":378,"./graph.js":379,"./headers_commission.js":380,"./mutex.js":388,"./object_hash.js":392,"./paid_witnessing.js":395,"./profiler.js":398,"./storage.js":402,_process:309,async:26,lodash:271}],386:[function(require,module,exports){"use strict";function readNextSpendableMcIndex(conn,type,address,arrConflictingUnits,handleNextSpendableMcIndex){conn.query("SELECT to_main_chain_index FROM inputs CROSS JOIN units USING(unit) \n\t\tWHERE type=? AND address=? AND sequence='good' "+(arrConflictingUnits&&arrConflictingUnits.length>0?" AND unit NOT IN("+arrConflictingUnits.map(function(unit){return db.escape(unit)}).join(", ")+") ":"")+" \n\t\tORDER BY to_main_chain_index DESC LIMIT 1",[type,address],function(rows){var mci=rows.length>0?rows[0].to_main_chain_index+1:0;handleNextSpendableMcIndex(mci)})}function readMaxSpendableMcIndex(conn,type,handleMaxSpendableMcIndex){var table=type+"_outputs";conn.query("SELECT MAX(main_chain_index) AS max_mc_index FROM "+table,function(rows){var max_mc_index=rows[0].max_mc_index||0;handleMaxSpendableMcIndex(max_mc_index)})}function findMcIndexIntervalToTargetAmount(conn,type,address,max_mci,target_amount,callbacks){var table=type+"_outputs";readNextSpendableMcIndex(conn,type,address,null,function(from_mci){return from_mci>max_mci?callbacks.ifNothing():void readMaxSpendableMcIndex(conn,type,function(max_spendable_mci){if(max_spendable_mci<=0)return callbacks.ifNothing();if(max_spendable_mci>max_mci&&(max_spendable_mci=max_mci),target_amount===1/0&&(target_amount=1e15),"mysql"===conf.storage)conn.query("SELECT main_chain_index, accumulated, has_sufficient \n\t\t\t\t\tFROM ( \n\t\t\t\t\t\tSELECT main_chain_index, @sum:=@sum+amount AS accumulated, @has_sufficient:=(@sum>?) AS has_sufficient  \n\t\t\t\t\t\tFROM "+table+", (SELECT @sum:=0, @has_sufficient:=0) AS unused \n\t\t\t\t\t\tWHERE is_spent=0 AND address=? AND main_chain_index>=? AND main_chain_index<=? \n\t\t\t\t\t\tORDER BY main_chain_index \n\t\t\t\t\t) AS t \n\t\t\t\t\tWHERE IF(@has_sufficient, has_sufficient, 1) \n\t\t\t\t\tORDER BY IF(@has_sufficient, accumulated, -accumulated) LIMIT 1",[target_amount,address,from_mci,max_spendable_mci],function(rows){if(0===rows.length)return callbacks.ifNothing();var bHasSufficient=rows[0].has_sufficient,accumulated=rows[0].accumulated,to_mci=rows[0].main_chain_index;callbacks.ifFound(from_mci,to_mci,accumulated,bHasSufficient)});else{var MIN_MC_OUTPUT="witnessing"===type?11:344,max_count_outputs=Math.ceil(target_amount/MIN_MC_OUTPUT);conn.query("SELECT main_chain_index, amount \n\t\t\t\t\tFROM "+table+" \n\t\t\t\t\tWHERE is_spent=0 AND address=? AND main_chain_index>=? AND main_chain_index<=? \n\t\t\t\t\tORDER BY main_chain_index LIMIT ?",[address,from_mci,max_spendable_mci,max_count_outputs],function(rows){if(0===rows.length)return callbacks.ifNothing();for(var to_mci,accumulated=0,bHasSufficient=!1,i=0;i<rows.length;i++)if(accumulated+=rows[i].amount,to_mci=rows[i].main_chain_index,accumulated>target_amount){bHasSufficient=!0;break}callbacks.ifFound(from_mci,to_mci,accumulated,bHasSufficient)})}})})}function calcEarnings(conn,type,from_main_chain_index,to_main_chain_index,address,callbacks){var table=type+"_outputs";conn.query("SELECT SUM(amount) AS total \n\t\tFROM "+table+" \n\t\tWHERE main_chain_index>=? AND main_chain_index<=? AND address=?",[from_main_chain_index,to_main_chain_index,address],function(rows){var total=rows[0].total;if(null===total&&(total=0),"number"!=typeof total)throw Error("mc outputs total is not a number");callbacks.ifOk(total)})}var db=(require("lodash"),require("async"),require("./db.js")),conf=require("./conf.js");exports.readNextSpendableMcIndex=readNextSpendableMcIndex,exports.readMaxSpendableMcIndex=readMaxSpendableMcIndex,exports.findMcIndexIntervalToTargetAmount=findMcIndexIntervalToTargetAmount,exports.calcEarnings=calcEarnings},{"./conf.js":370,"./db.js":372,async:26,lodash:271}],387:[function(require,module,exports){"use strict";function hash(str){return crypto.createHash("sha256").update(str,"utf8").digest("base64")}function getMerkleRoot(arrElements){for(var arrHashes=arrElements.map(hash);arrHashes.length>1;){for(var arrOverHashes=[],i=0;i<arrHashes.length;i+=2){var hash2_index=i+1<arrHashes.length?i+1:i;arrOverHashes.push(hash(arrHashes[i]+arrHashes[hash2_index]))}arrHashes=arrOverHashes}return arrHashes[0]}function getMerkleProof(arrElements,element_index){if(index<0||index>=arrElements.length)throw Error("invalid index");for(var arrHashes=arrElements.map(hash),index=element_index,arrSiblings=[];arrHashes.length>1;){for(var arrOverHashes=[],overIndex=null,i=0;i<arrHashes.length;i+=2){var hash2_index=i+1<arrHashes.length?i+1:i;i===index?(arrSiblings.push(arrHashes[hash2_index]),overIndex=i/2):hash2_index===index&&(arrSiblings.push(arrHashes[i]),overIndex=i/2),arrOverHashes.push(hash(arrHashes[i]+arrHashes[hash2_index]))}if(arrHashes=arrOverHashes,null===overIndex)throw Error("overIndex not defined");index=overIndex}return{root:arrHashes[0],siblings:arrSiblings,index:element_index}}function serializeMerkleProof(proof){var serialized_proof=proof.index;return proof.siblings.length>0&&(serialized_proof+="-"+proof.siblings.join("-")),serialized_proof+="-"+proof.root}function deserializeMerkleProof(serialized_proof){var arr=serialized_proof.split("-"),proof={};return proof.root=arr.pop(),proof.index=arr.shift(),proof.siblings=arr,proof}function verifyMerkleProof(element,proof){for(var index=proof.index,the_other_sibling=hash(element),i=0;i<proof.siblings.length;i++)the_other_sibling=hash(index%2===0?the_other_sibling+proof.siblings[i]:proof.siblings[i]+the_other_sibling),index=Math.floor(index/2);return the_other_sibling===proof.root}var crypto=require("crypto");exports.getMerkleRoot=getMerkleRoot,exports.getMerkleProof=getMerkleProof,exports.verifyMerkleProof=verifyMerkleProof,exports.serializeMerkleProof=serializeMerkleProof,exports.deserializeMerkleProof=deserializeMerkleProof},{crypto:181}],388:[function(require,module,exports){"use strict";function getCountOfQueuedJobs(){return arrQueuedJobs.length}function getCountOfLocks(){return arrLockedKeyArrays.length}function isAnyOfKeysLocked(arrKeys){for(var i=0;i<arrLockedKeyArrays.length;i++)for(var arrLockedKeys=arrLockedKeyArrays[i],j=0;j<arrLockedKeys.length;j++)if(arrKeys.indexOf(arrLockedKeys[j])!==-1)return!0;return!1}function release(arrKeys){for(var i=0;i<arrLockedKeyArrays.length;i++)if(_.isEqual(arrKeys,arrLockedKeyArrays[i]))return void arrLockedKeyArrays.splice(i,1)}function exec(arrKeys,proc,next_proc){arrLockedKeyArrays.push(arrKeys),console.log("lock acquired",arrKeys);var bLocked=!0;proc(function(){if(!bLocked)throw Error("double unlock?");bLocked=!1,release(arrKeys),console.log("lock released",arrKeys),next_proc&&next_proc.apply(next_proc,arguments),handleQueue()})}function handleQueue(){console.log("handleQueue "+arrQueuedJobs.length+" items");for(var i=0;i<arrQueuedJobs.length;i++){var job=arrQueuedJobs[i];isAnyOfKeysLocked(job.arrKeys)||(arrQueuedJobs.splice(i,1),console.log("starting job held by keys",job.arrKeys),exec(job.arrKeys,job.proc,job.next_proc),i--)}console.log("handleQueue done "+arrQueuedJobs.length+" items")}function lock(arrKeys,proc,next_proc){isAnyOfKeysLocked(arrKeys)?(console.log("queuing job held by keys",arrKeys),arrQueuedJobs.push({arrKeys:arrKeys,proc:proc,next_proc:next_proc,ts:Date.now()})):exec(arrKeys,proc,next_proc)}function lockOrSkip(arrKeys,proc,next_proc){isAnyOfKeysLocked(arrKeys)?(console.log("skipping job held by keys",arrKeys),next_proc&&next_proc()):exec(arrKeys,proc,next_proc)}var _=require("lodash");require("./enforce_singleton.js");var arrQueuedJobs=[],arrLockedKeyArrays=[];setInterval(function(){console.log("queued jobs: "+JSON.stringify(arrQueuedJobs.map(function(job){return job.arrKeys}))+", locked keys: "+JSON.stringify(arrLockedKeyArrays))},1e4),exports.lock=lock,exports.lockOrSkip=lockOrSkip,exports.getCountOfQueuedJobs=getCountOfQueuedJobs,exports.getCountOfLocks=getCountOfLocks},{"./enforce_singleton.js":377,lodash:271,util:418}],389:[function(require,module,exports){"use strict";function readMyWitnesses(handleWitnesses,actionIfEmpty){db.query("SELECT address FROM my_witnesses ORDER BY address",function(rows){var arrWitnesses=rows.map(function(row){return row.address});if(("2"===constants.alt&&arrWitnesses.indexOf("5K7CSLTRPC5LFLOS3D34GBHG7RFD4TPO")>=0||"1.0"===constants.version&&arrWitnesses.indexOf("2FF7PSL7FYXVU5UIQHCVDTTPUOOG75GX")>=0)&&(console.log("deleting old witnesses"),db.query("DELETE FROM my_witnesses"),arrWitnesses=[]),0===arrWitnesses.length){if("ignore"===actionIfEmpty)return handleWitnesses([]);if("wait"===actionIfEmpty)return console.log("no witnesses yet, will retry later"),void setTimeout(function(){readMyWitnesses(handleWitnesses,actionIfEmpty)},1e3)}if(arrWitnesses.length!==constants.COUNT_WITNESSES)throw Error("wrong number of my witnesses: "+arrWitnesses.length);handleWitnesses(arrWitnesses)})}function replaceWitness(old_witness,new_witness,handleResult){return ValidationUtils.isValidAddress(new_witness)?void readMyWitnesses(function(arrWitnesses){if(arrWitnesses.indexOf(old_witness)===-1)return handleResult("old witness not known");if(arrWitnesses.indexOf(new_witness)>=0)return handleResult("new witness already present");var doReplace=function(){db.query("UPDATE my_witnesses SET address=? WHERE address=?",[new_witness,old_witness],function(){handleResult()})};return conf.bLight?doReplace():void db.query("SELECT 1 FROM unit_authors CROSS JOIN units USING(unit) WHERE address=? AND sequence='good' AND is_stable=1 LIMIT 1",[new_witness],function(rows){return 0===rows.length?handleResult("no stable messages from the new witness yet"):void storage.determineIfWitnessAddressDefinitionsHaveReferences(db,[new_witness],function(bHasReferences){return bHasReferences?handleResult("address definition of the new witness has or had references"):void doReplace()})})}):handleResult("new witness address is invalid")}function insertWitnesses(arrWitnesses,onDone){if(arrWitnesses.length!==constants.COUNT_WITNESSES)throw Error("attempting to insert wrong number of witnesses: "+arrWitnesses.length);var placeholders=Array.apply(null,Array(arrWitnesses.length)).map(function(){return"(?)"}).join(",");console.log("will insert witnesses",arrWitnesses),db.query("INSERT INTO my_witnesses (address) VALUES "+placeholders,arrWitnesses,function(){console.log("inserted witnesses"),onDone&&onDone()})}var db=require("./db.js"),conf=require("./conf.js"),constants=require("./constants.js"),storage=require("./storage.js"),ValidationUtils=require("./validation_utils.js");exports.readMyWitnesses=readMyWitnesses,exports.replaceWitness=replaceWitness,exports.insertWitnesses=insertWitnesses},{"./conf.js":370,"./constants.js":371,"./db.js":372,"./storage.js":402,"./validation_utils.js":405}],390:[function(require,module,exports){"use strict";require("mysql");module.exports=function(connection_or_pool){console.log("constructor");var safe_connection=connection_or_pool;return safe_connection.original_query=safe_connection.query,safe_connection.original_release=safe_connection.release,safe_connection.query=function(){var last_arg=arguments[arguments.length-1],bHasCallback="function"==typeof last_arg;bHasCallback||(last_arg=function(){});for(var q,count_arguments_without_callback=bHasCallback?arguments.length-1:arguments.length,new_args=[],i=0;i<count_arguments_without_callback;i++)new_args.push(arguments[i]);return new_args.push(function(err,results,fields){if(err)throw console.error("\nfailed query: "+q.sql),err;last_arg(results,fields)}),q=connection_or_pool.original_query.apply(connection_or_pool,new_args)},safe_connection.release=function(){connection_or_pool.original_release()},safe_connection.addQuery=function(arr){for(var query_args=[],i=1;i<arguments.length;i++)query_args.push(arguments[i]);arr.push(function(callback){if("function"!=typeof query_args[query_args.length-1])query_args.push(function(){callback()});else{var f=query_args[query_args.length-1];query_args[query_args.length-1]=function(){f.apply(f,arguments),callback()}}safe_connection.query.apply(safe_connection,query_args)})},safe_connection.takeConnectionFromPool=function(handleConnection){connection_or_pool.getConnection(function(err,new_connection){if(err)throw err;console.log("got connection from pool"),handleConnection(new_connection.original_query?new_connection:module.exports(new_connection))})},safe_connection.getCountUsedConnections=function(){return safe_connection._allConnections.length-safe_connection._freeConnections.length},safe_connection.close=function(cb){connection_or_pool.end(cb)},safe_connection.addTime=function(interval){return"NOW() + INTERVAL "+interval},safe_connection.getNow=function(){return"NOW()"},safe_connection.getFromUnixTime=function(ts){return"FROM_UNIXTIME("+ts+")"},safe_connection.getRandom=function(){return"RAND()"},safe_connection.forceIndex=function(index){return"FORCE INDEX ("+index+")"},safe_connection.dropTemporaryTable=function(table){return"DROP TEMPORARY TABLE IF EXISTS "+table},safe_connection.getIgnore=function(){return"IGNORE"},safe_connection.getUnixTimestamp=function(date){return"UNIX_TIMESTAMP("+date+")"},safe_connection}},{mysql:void 0}],391:[function(require,module,exports){(function(process,global){"use strict";function setMyDeviceProps(device_address,objTempPubkey){my_device_address=device_address,objMyTempPubkeyPackage=objTempPubkey}function sendMessage(ws,type,content){var message=JSON.stringify([type,content]);return ws.readyState!==ws.OPEN?console.log("readyState="+ws.readyState+" on peer "+ws.peer+", will not send "+message):(console.log("SENDING "+message+" to "+ws.peer),void ws.send(message))}function sendJustsaying(ws,subject,body){sendMessage(ws,"justsaying",{subject:subject,body:body})}function sendError(ws,error){sendJustsaying(ws,"error",error)}function sendInfo(ws,content){sendJustsaying(ws,"info",content)}function sendResult(ws,content){sendJustsaying(ws,"result",content)}function sendErrorResult(ws,unit,error){sendResult(ws,{unit:unit,result:"error",error:error})}function sendVersion(ws){var libraryPackageJson=require("./package.json");sendJustsaying(ws,"version",{protocol_version:constants.version,alt:constants.alt,library:libraryPackageJson.name,library_version:libraryPackageJson.version,program:conf.program,program_version:conf.program_version})}function sendResponse(ws,tag,response){delete ws.assocInPreparingResponse[tag],sendMessage(ws,"response",{tag:tag,response:response})}function sendErrorResponse(ws,tag,error){sendResponse(ws,tag,{error:error})}function sendRequest(ws,command,params,bReroutable,responseHandler){var request={command:command};params&&(request.params=params);var content=_.clone(request),tag=objectHash.getBase64Hash(request);if(ws.assocPendingRequests[tag])console.log("already sent a "+command+" request to "+ws.peer+", will add one more response handler rather than sending a duplicate request to the wire"),ws.assocPendingRequests[tag].responseHandlers.push(responseHandler);else{content.tag=tag;var reroute=bReroutable?function(){return console.log("will try to reroute a "+command+" request stalled at "+ws.peer),ws.assocPendingRequests[tag]?(ws.assocPendingRequests[tag].bRerouted=!0,void findNextPeer(ws,function(next_ws){return ws.assocPendingRequests[tag]?next_ws===ws||assocReroutedConnectionsByTag[tag]&&assocReroutedConnectionsByTag[tag].indexOf(next_ws)>=0?(console.log("will not reroute "+command+" to the same peer, will rather wait for a new connection"),void eventBus.once("connected_to_source",function(){console.log("got new connection, retrying reroute "+command),reroute()})):(console.log("rerouting "+command+" from "+ws.peer+" to "+next_ws.peer),ws.assocPendingRequests[tag].responseHandlers.forEach(function(rh){sendRequest(next_ws,command,params,bReroutable,rh)}),assocReroutedConnectionsByTag[tag]||(assocReroutedConnectionsByTag[tag]=[ws]),void assocReroutedConnectionsByTag[tag].push(next_ws)):console.log("will not reroute after findNextPeer - the request was already handled by another peer")})):console.log("will not reroute - the request was already handled by another peer")}:null,reroute_timer=bReroutable?setTimeout(reroute,STALLED_TIMEOUT):null,cancel_timer=bReroutable?null:setTimeout(function(){ws.assocPendingRequests[tag].responseHandlers.forEach(function(rh){rh(ws,request,{error:"[internal] response timeout"})}),delete ws.assocPendingRequests[tag]},RESPONSE_TIMEOUT);ws.assocPendingRequests[tag]={request:request,responseHandlers:[responseHandler],reroute:reroute,reroute_timer:reroute_timer,cancel_timer:cancel_timer},sendMessage(ws,"request",content)}}function handleResponse(ws,tag,response){
var pendingRequest=ws.assocPendingRequests[tag];return pendingRequest?(pendingRequest.responseHandlers.forEach(function(responseHandler){process.nextTick(function(){responseHandler(ws,pendingRequest.request,response)})}),clearTimeout(pendingRequest.reroute_timer),clearTimeout(pendingRequest.cancel_timer),delete ws.assocPendingRequests[tag],void(assocReroutedConnectionsByTag[tag]&&(assocReroutedConnectionsByTag[tag].forEach(function(client){client.assocPendingRequests[tag]&&(clearTimeout(client.assocPendingRequests[tag].reroute_timer),clearTimeout(client.assocPendingRequests[tag].cancel_timer),delete client.assocPendingRequests[tag])}),delete assocReroutedConnectionsByTag[tag]))):console.log("no req by tag "+tag)}function cancelRequestsOnClosedConnection(ws){console.log("websocket closed, will complete all outstanding requests");for(var tag in ws.assocPendingRequests){var pendingRequest=ws.assocPendingRequests[tag];clearTimeout(pendingRequest.reroute_timer),clearTimeout(pendingRequest.cancel_timer),pendingRequest.reroute?pendingRequest.bRerouted||pendingRequest.reroute():(pendingRequest.responseHandlers.forEach(function(rh){rh(ws,pendingRequest.request,{error:"[internal] connection closed"})}),delete ws.assocPendingRequests[tag])}printConnectionStatus()}function findNextPeer(ws,handleNextPeer){tryFindNextPeer(ws,function(next_ws){if(next_ws)return handleNextPeer(next_ws);var peer=ws?ws.peer:"[none]";console.log("findNextPeer after "+peer+" found no appropriate peer, will wait for a new connection"),eventBus.once("connected_to_source",function(new_ws){console.log("got new connection, retrying findNextPeer after "+peer),findNextPeer(ws,handleNextPeer)})})}function tryFindNextPeer(ws,handleNextPeer){var arrOutboundSources=arrOutboundPeers.filter(function(outbound_ws){return outbound_ws.bSource}),len=arrOutboundSources.length;if(len>0){var peer_index=arrOutboundSources.indexOf(ws),next_peer_index=peer_index===-1?getRandomInt(0,len-1):(peer_index+1)%len;handleNextPeer(arrOutboundSources[next_peer_index])}else findRandomInboundPeer(handleNextPeer)}function getRandomInt(min,max){return Math.floor(Math.random()*(max+1-min))+min}function findRandomInboundPeer(handleInboundPeer){var arrInboundSources=wss.clients.filter(function(inbound_ws){return inbound_ws.bSource});if(0===arrInboundSources.length)return handleInboundPeer(null);var arrInboundHosts=arrInboundSources.map(function(ws){return ws.host});db.query("SELECT peer_host FROM peer_host_urls JOIN peer_hosts USING(peer_host) \n\t\tWHERE is_active=1 AND peer_host IN(?) \n\t\t\tAND (count_invalid_joints/count_new_good_joints<? \n\t\t\tOR count_new_good_joints=0 AND count_nonserial_joints=0 AND count_invalid_joints=0) \n\t\tORDER BY (count_new_good_joints=0), "+db.getRandom()+" LIMIT 1",[arrInboundHosts,conf.MAX_TOLERATED_INVALID_RATIO],function(rows){if(console.log(rows.length+" inbound peers"),0===rows.length)return handleInboundPeer(null);var host=rows[0].peer_host;console.log("selected inbound peer "+host);var ws=arrInboundSources.filter(function(ws){return ws.host===host})[0];if(!ws)throw Error("inbound ws not found");handleInboundPeer(ws)})}function checkIfHaveEnoughOutboundPeersAndAdd(){var arrOutboundPeerUrls=arrOutboundPeers.map(function(ws){return ws.peer});db.query("SELECT peer FROM peers JOIN peer_hosts USING(peer_host) \n\t\tWHERE count_new_good_joints>0 AND count_invalid_joints/count_new_good_joints<? AND peer IN(?)",[conf.MAX_TOLERATED_INVALID_RATIO,arrOutboundPeerUrls.length>0?arrOutboundPeerUrls:null],function(rows){var count_good_peers=rows.length;if(!(count_good_peers>=conf.MIN_COUNT_GOOD_PEERS)&&0!==count_good_peers)for(var arrGoodPeerUrls=rows.map(function(row){return row.peer}),i=0;i<arrOutboundPeers.length;i++){var ws=arrOutboundPeers[i];arrGoodPeerUrls.indexOf(ws.peer)!==-1&&requestPeers(ws)}})}function connectToPeer(url,onOpen){addPeer(url);var options={};socks&&conf.socksHost&&conf.socksPort&&(options.agent=new socks.Agent({proxy:{ipaddress:conf.socksHost,port:conf.socksPort,type:5}},/^wss/i.test(url)));var ws=options.agent?new WebSocket(url,options):new WebSocket(url);assocConnectingOutboundWebsockets[url]=ws,setTimeout(function(){assocConnectingOutboundWebsockets[url]&&(console.log("abandoning connection to "+url+" due to timeout"),delete assocConnectingOutboundWebsockets[url])},5e3),ws.setMaxListeners(20),ws.once("open",function(){if(breadcrumbs.add("connected to "+url),delete assocConnectingOutboundWebsockets[url],ws.assocPendingRequests={},ws.assocInPreparingResponse={},!ws.url)throw Error("no url on ws");if(ws.url!==url&&ws.url!==url+"/")throw Error("url is different: "+ws.url);var another_ws_to_same_peer=getOutboundPeerWsByUrl(url);return another_ws_to_same_peer?(console.log("already have a connection to "+url+", will keep the old one and close the duplicate"),ws.close(1e3,"duplicate connection"),void(onOpen&&onOpen(null,another_ws_to_same_peer))):(ws.peer=url,ws.host=getHostByPeer(ws.peer),ws.bOutbound=!0,ws.last_ts=Date.now(),console.log("connected to "+url+", host "+ws.host),arrOutboundPeers.push(ws),sendVersion(ws),conf.myUrl&&sendJustsaying(ws,"my_url",conf.myUrl),conf.bLight||subscribe(ws),onOpen&&onOpen(null,ws),eventBus.emit("connected",ws),void eventBus.emit("open-"+url))}),ws.on("close",function(){var i=arrOutboundPeers.indexOf(ws);console.log("close event, removing "+i+": "+url),i!==-1&&arrOutboundPeers.splice(i,1),cancelRequestsOnClosedConnection(ws),options.agent&&options.agent.destroy&&options.agent.destroy()}),ws.on("error",function(e){delete assocConnectingOutboundWebsockets[url],console.log("error from server "+url+": "+e);var err=e.toString();!ws.bOutbound&&onOpen&&onOpen(err),ws.bOutbound||eventBus.emit("open-"+url,err)}),ws.on("message",onWebsocketMessage),console.log("connectToPeer done")}function addOutboundPeers(multiplier){if(multiplier||(multiplier=1),!(multiplier>=32)){var order_by=multiplier<=4?"count_new_good_joints DESC":db.getRandom(),arrOutboundPeerUrls=arrOutboundPeers.map(function(ws){return ws.peer}),arrInboundHosts=wss.clients.map(function(ws){return ws.host}),max_new_outbound_peers=Math.min(conf.MAX_OUTBOUND_CONNECTIONS-arrOutboundPeerUrls.length,5);max_new_outbound_peers<=0||db.query("SELECT peer \n\t\tFROM peers \n\t\tJOIN peer_hosts USING(peer_host) \n\t\tLEFT JOIN peer_host_urls ON peer=url AND is_active=1 \n\t\tWHERE (count_invalid_joints/count_new_good_joints<? \n\t\t\tOR count_new_good_joints=0 AND count_nonserial_joints=0 AND count_invalid_joints=0) \n\t\t\t"+(arrOutboundPeerUrls.length>0?"AND peer NOT IN("+db.escape(arrOutboundPeerUrls)+") \n":"")+"\n\t\t\t"+(arrInboundHosts.length>0?"AND (peer_host_urls.peer_host IS NULL OR peer_host_urls.peer_host NOT IN("+db.escape(arrInboundHosts)+")) \n":"")+"\n\t\t\tAND is_self=0 \n\t\tORDER BY "+order_by+" LIMIT ?",[conf.MAX_TOLERATED_INVALID_RATIO*multiplier,max_new_outbound_peers],function(rows){for(var i=0;i<rows.length;i++)assocKnownPeers[rows[i].peer]=!0,findOutboundPeerOrConnect(rows[i].peer);0===arrOutboundPeerUrls.length&&0===rows.length&&addOutboundPeers(2*multiplier)})}}function getHostByPeer(peer){var matches=peer.match(/^wss?:\/\/(.*)$/i);return matches&&(peer=matches[1]),matches=peer.match(/^(.*?)[:\/]/),matches?matches[1]:peer}function addPeerHost(host,onDone){db.query("INSERT "+db.getIgnore()+" INTO peer_hosts (peer_host) VALUES (?)",[host],function(){onDone&&onDone()})}function addPeer(peer){if(!assocKnownPeers[peer]){assocKnownPeers[peer]=!0;var host=getHostByPeer(peer);addPeerHost(host,function(){console.log("will insert peer "+peer),db.query("INSERT "+db.getIgnore()+" INTO peers (peer_host, peer) VALUES (?,?)",[host,peer])})}}function getOutboundPeerWsByUrl(url){console.log("outbound peers: "+arrOutboundPeers.map(function(o){return o.peer}).join(", "));for(var i=0;i<arrOutboundPeers.length;i++)if(arrOutboundPeers[i].peer===url)return arrOutboundPeers[i];return null}function getPeerWebSocket(peer){for(var i=0;i<arrOutboundPeers.length;i++)if(arrOutboundPeers[i].peer===peer)return arrOutboundPeers[i];for(var i=0;i<wss.clients.length;i++)if(wss.clients[i].peer===peer)return wss.clients[i];return null}function findOutboundPeerOrConnect(url,onOpen){if(!url)throw Error("no url");onOpen||(onOpen=function(){}),url=url.toLowerCase();var ws=getOutboundPeerWsByUrl(url);return ws?onOpen(null,ws):(ws=assocConnectingOutboundWebsockets[url])?(breadcrumbs.add("already connecting to "+url),eventBus.once("open-"+url,function(err){return console.log("second open "+url+", err="+err),err?onOpen(err):void(ws.readyState===ws.OPEN?onOpen(null,ws):(console.log("in second onOpen, websocket already closed"),onOpen("[internal] websocket already closed")))})):(console.log("will connect to "+url),void connectToPeer(url,onOpen))}function purgePeerEvents(){"sqlite"===conf.storage&&(console.log("will purge peer events"),db.query("DELETE FROM peer_events WHERE event_date <= datetime('now', '-3 day')",function(){console.log("deleted some old peer_events")}))}function purgeDeadPeers(){if("sqlite"===conf.storage){console.log("will purge dead peers");var arrOutboundPeerUrls=arrOutboundPeers.map(function(ws){return ws.peer});db.query("SELECT rowid, "+db.getUnixTimestamp("event_date")+" AS ts FROM peer_events ORDER BY rowid DESC LIMIT 1",function(lrows){if(0!==lrows.length){var last_rowid=lrows[0].rowid,last_event_ts=lrows[0].ts;db.query("SELECT peer, peer_host FROM peers",function(rows){async.eachSeries(rows,function(row,cb){return arrOutboundPeerUrls.indexOf(row.peer)>=0?cb():void db.query("SELECT MAX(rowid) AS max_rowid, MAX("+db.getUnixTimestamp("event_date")+") AS max_event_ts FROM peer_events WHERE peer_host=?",[row.peer_host],function(mrows){var max_rowid=mrows[0].max_rowid||0,max_event_ts=mrows[0].max_event_ts||0,count_other_events=last_rowid-max_rowid,days_since_last_event=(last_event_ts-max_event_ts)/24/3600;return count_other_events<2e4||days_since_last_event<7?cb():(console.log("peer "+row.peer+" is dead, will delete"),void db.query("DELETE FROM peers WHERE peer=?",[row.peer],function(){delete assocKnownPeers[row.peer],cb()}))})})})}})}}function requestPeers(ws){sendRequest(ws,"get_peers",null,!1,handleNewPeers)}function handleNewPeers(ws,request,arrPeerUrls){if(arrPeerUrls.error)return console.log("get_peers failed: "+arrPeerUrls.error);if(!Array.isArray(arrPeerUrls))return sendError(ws,"peer urls is not an array");for(var arrQueries=[],i=0;i<arrPeerUrls.length;i++){var url=arrPeerUrls[i];if(!conf.myUrl||conf.myUrl.toLowerCase()!==url.toLowerCase()){var regexp="wss://"===conf.WS_PROTOCOL?/^wss:\/\//:/^wss?:\/\//;if(url.match(regexp)){var host=getHostByPeer(url);db.addQuery(arrQueries,"INSERT "+db.getIgnore()+" INTO peer_hosts (peer_host) VALUES (?)",[host]),db.addQuery(arrQueries,"INSERT "+db.getIgnore()+" INTO peers (peer_host, peer, learnt_from_peer_host) VALUES(?,?,?)",[host,url,ws.host])}else console.log("ignoring new peer "+url+" because of incompatible ws protocol")}}async.series(arrQueries)}function heartbeat(){var bJustResumed="undefined"!=typeof window&&window&&window.cordova&&Date.now()-last_hearbeat_wake_ts>2*HEARTBEAT_TIMEOUT;last_hearbeat_wake_ts=Date.now(),wss.clients.concat(arrOutboundPeers).forEach(function(ws){if(!ws.bSleeping){var elapsed_since_last_received=Date.now()-ws.last_ts;if(!(elapsed_since_last_received<HEARTBEAT_TIMEOUT)){if(!ws.last_sent_heartbeat_ts||bJustResumed)return ws.last_sent_heartbeat_ts=Date.now(),sendRequest(ws,"heartbeat",null,!1,handleHeartbeatResponse);var elapsed_since_last_sent_heartbeat=Date.now()-ws.last_sent_heartbeat_ts;elapsed_since_last_sent_heartbeat<HEARTBEAT_RESPONSE_TIMEOUT||(console.log("will disconnect peer "+ws.peer+" who was silent for "+elapsed_since_last_received+"ms"),ws.close(1e3,"lost connection"))}}})}function handleHeartbeatResponse(ws,request,response){delete ws.last_sent_heartbeat_ts,"sleep"===response&&(ws.bSleeping=!0)}function requestFromLightVendor(command,params,responseHandler){return exports.light_vendor_url?void findOutboundPeerOrConnect(exports.light_vendor_url,function(err,ws){return err?responseHandler(null,null,{error:"[connect to light vendor failed]: "+err}):void sendRequest(ws,command,params,!1,responseHandler)}):(console.log("light_vendor_url not set yet"),setTimeout(function(){requestFromLightVendor(command,params,responseHandler)},1e3))}function printConnectionStatus(){console.log(wss.clients.length+" incoming connections, "+arrOutboundPeers.length+" outgoing connections, "+Object.keys(assocConnectingOutboundWebsockets).length+" outgoing connections being opened")}function subscribe(ws){ws.subscription_id=crypto.randomBytes(30).toString("base64"),storage.readLastMainChainIndex(function(last_mci){sendRequest(ws,"subscribe",{subscription_id:ws.subscription_id,last_mci:last_mci},!1,function(ws,request,response){delete ws.subscription_id,response.error||(ws.bSource=!0,eventBus.emit("connected_to_source",ws))})})}function sendJoint(ws,objJoint,tag){console.log("sending joint identified by unit "+objJoint.unit.unit+" to",ws.peer),tag?sendResponse(ws,tag,{joint:objJoint}):sendJustsaying(ws,"joint",objJoint)}function postJointToLightVendor(objJoint,handleResponse){console.log("posing joint identified by unit "+objJoint.unit.unit+" to light vendor"),requestFromLightVendor("post_joint",objJoint,function(ws,request,response){handleResponse(response)})}function sendFreeJoints(ws){storage.readFreeJoints(function(objJoint){sendJoint(ws,objJoint)},function(){sendJustsaying(ws,"free_joints_end",null)})}function sendJointsSinceMci(ws,mci){joint_storage.readJointsSinceMci(mci,function(objJoint){sendJoint(ws,objJoint)},function(){sendJustsaying(ws,"free_joints_end",null)})}function requestFreeJointsFromAllOutboundPeers(){for(var i=0;i<arrOutboundPeers.length;i++)sendJustsaying(arrOutboundPeers[i],"refresh",null)}function rerequestLostJoints(){bCatchingUp||joint_storage.findLostJoints(function(arrUnits){console.log("lost units",arrUnits),tryFindNextPeer(null,function(ws){ws&&(console.log("found next peer "+ws.peer),requestJoints(ws,arrUnits.filter(function(unit){return!assocUnitsInWork[unit]&&!havePendingJointRequest(unit)})))})})}function requestNewMissingJoints(ws,arrUnits){var arrNewUnits=[];async.eachSeries(arrUnits,function(unit,cb){return assocUnitsInWork[unit]?cb():havePendingJointRequest(unit)?(console.log("unit "+unit+" was already requested"),cb()):void joint_storage.checkIfNewUnit(unit,{ifNew:function(){arrNewUnits.push(unit),cb()},ifKnown:function(){console.log("known"),cb()},ifKnownUnverified:function(){console.log("known unverified"),cb()},ifKnownBad:function(error){throw Error("known bad "+unit+": "+error)}})},function(){arrNewUnits=arrNewUnits.filter(function(unit){return!assocUnitsInWork[unit]&&!havePendingJointRequest(unit)}),arrNewUnits.length>0&&requestJoints(ws,arrNewUnits)})}function requestJoints(ws,arrUnits){0!==arrUnits.length&&arrUnits.forEach(function(unit){if(assocRequestedUnits[unit]){var diff=Date.now()-assocRequestedUnits[unit];if(diff<=STALLED_TIMEOUT)return console.log("unit "+unit+" already requested "+diff+" ms ago, assocUnitsInWork="+assocUnitsInWork[unit])}ws.readyState===ws.OPEN&&(assocRequestedUnits[unit]=Date.now()),sendRequest(ws,"get_joint",unit,!0,handleResponseToJointRequest)})}function handleResponseToJointRequest(ws,request,response){if(delete assocRequestedUnits[request.params],response.joint){var objJoint=response.joint;if(!objJoint.unit||!objJoint.unit.unit)return sendError(ws,"no unit");var unit=objJoint.unit.unit;if(request.params!==unit)return sendError(ws,"I didn't request this unit from you: "+unit);conf.bLight&&objJoint.ball&&!objJoint.unit.content_hash&&(delete objJoint.ball,delete objJoint.skiplist_units),conf.bLight?handleLightOnlineJoint(ws,objJoint):handleOnlineJoint(ws,objJoint)}else{var unit=request.params;if(response.joint_not_found===unit){if(!bCatchingUp)return console.log("unit "+unit+" does not exist");db.query("SELECT 1 FROM hash_tree_balls WHERE unit=?",[unit],function(rows){return 0===rows.length?console.log("unit "+unit+" does not exist (catching up)"):void findNextPeer(ws,function(next_ws){breadcrumbs.add("found next peer to reroute joint_not_found "+unit+": "+next_ws.peer),requestJoints(next_ws,[unit])})})}}}function havePendingJointRequest(unit){for(var arrPeers=wss.clients.concat(arrOutboundPeers),i=0;i<arrPeers.length;i++){var assocPendingRequests=arrPeers[i].assocPendingRequests;for(var tag in assocPendingRequests){var request=assocPendingRequests[tag].request;if("get_joint"===request.command&&request.params===unit)return!0}}return!1}function purgeJunkUnhandledJoints(){bCatchingUp||Date.now()-coming_online_time<36e5||db.query("DELETE FROM unhandled_joints WHERE creation_date < "+db.addTime("-1 HOUR"),function(){db.query("DELETE FROM dependencies WHERE NOT EXISTS (SELECT * FROM unhandled_joints WHERE unhandled_joints.unit=dependencies.unit)")})}function purgeJointAndDependenciesAndNotifyPeers(objJoint,error,onDone){return error.indexOf("is not stable in view of your parents")>=0?(eventBus.emit("nonfatal_error","error on unit "+objJoint.unit.unit+": "+error+"; "+JSON.stringify(objJoint),new Error),onDone()):void joint_storage.purgeJointAndDependencies(objJoint,error,function(purged_unit,peer){var ws=getPeerWebSocket(peer);ws&&sendErrorResult(ws,purged_unit,"error on (indirect) parent unit "+objJoint.unit.unit+": "+error)},onDone)}function forwardJoint(ws,objJoint){wss.clients.concat(arrOutboundPeers).forEach(function(client){client!=ws&&client.bSubscribed&&sendJoint(client,objJoint)})}function handleJoint(ws,objJoint,bSaved,callbacks){var unit=objJoint.unit.unit;if(assocUnitsInWork[unit])return callbacks.ifUnitInWork();assocUnitsInWork[unit]=!0;var validate=function(){validation.validate(objJoint,{ifUnitError:function(error){console.log(objJoint.unit.unit+" validation failed: "+error),callbacks.ifUnitError(error),purgeJointAndDependenciesAndNotifyPeers(objJoint,error,function(){delete assocUnitsInWork[unit]}),ws&&"authentifier verification failed"!==error&&!error.match(/bad merkle proof at path/)&&writeEvent("invalid",ws.host),objJoint.unsigned&&eventBus.emit("validated-"+unit,!1)},ifJointError:function(error){callbacks.ifJointError(error),db.query("INSERT INTO known_bad_joints (joint, json, error) VALUES (?,?,?)",[objectHash.getJointHash(objJoint),JSON.stringify(objJoint),error],function(){delete assocUnitsInWork[unit]}),ws&&writeEvent("invalid",ws.host),objJoint.unsigned&&eventBus.emit("validated-"+unit,!1)},ifTransientError:function(error){throw Error(error)},ifNeedHashTree:function(){if(console.log("need hash tree for unit "+unit),objJoint.unsigned)throw Error("ifNeedHashTree() unsigned");callbacks.ifNeedHashTree(),delete assocUnitsInWork[unit]},ifNeedParentUnits:callbacks.ifNeedParentUnits,ifOk:function(objValidationState,validation_unlock){if(objJoint.unsigned)throw Error("ifOk() unsigned");writer.saveJoint(objJoint,objValidationState,null,function(){validation_unlock(),callbacks.ifOk(),ws&&writeEvent("good"!==objValidationState.sequence?"nonserial":"new_good",ws.host),notifyWatchers(objJoint,ws),bCatchingUp||eventBus.emit("new_joint",objJoint)})},ifOkUnsigned:function(bSerial){if(!objJoint.unsigned)throw Error("ifOkUnsigned() signed");callbacks.ifOkUnsigned(),eventBus.emit("validated-"+unit,bSerial)}})};joint_storage.checkIfNewJoint(objJoint,{ifNew:function(){bSaved?callbacks.ifNew():validate()},ifKnown:function(){callbacks.ifKnown(),delete assocUnitsInWork[unit]},ifKnownBad:function(){callbacks.ifKnownBad(),delete assocUnitsInWork[unit]},ifKnownUnverified:function(){bSaved?validate():callbacks.ifKnownUnverified()}})}function handlePostedJoint(ws,objJoint,onDone){if(!objJoint||!objJoint.unit||!objJoint.unit.unit)return onDone("no unit");var unit=objJoint.unit.unit;delete objJoint.unit.main_chain_index,handleJoint(ws,objJoint,!1,{ifUnitInWork:function(){onDone("already handling this unit")},ifUnitError:function(error){onDone(error)},ifJointError:function(error){onDone(error)},ifNeedHashTree:function(){onDone("need hash tree")},ifNeedParentUnits:function(arrMissingUnits){onDone("unknown parents")},ifOk:function(){onDone(),bCatchingUp||conf.bLight||forwardJoint(ws,objJoint),delete assocUnitsInWork[unit]},ifOkUnsigned:function(){delete assocUnitsInWork[unit],onDone("you can't send unsigned units")},ifKnown:function(){if(objJoint.unsigned)throw Error("known unsigned");onDone("known"),writeEvent("known_good",ws.host)},ifKnownBad:function(){onDone("known bad"),writeEvent("known_bad",ws.host)},ifKnownUnverified:function(){onDone("known unverified"),delete assocUnitsInWork[unit]}})}function handleOnlineJoint(ws,objJoint,onDone){onDone||(onDone=function(){});var unit=objJoint.unit.unit;delete objJoint.unit.main_chain_index,handleJoint(ws,objJoint,!1,{ifUnitInWork:onDone,ifUnitError:function(error){sendErrorResult(ws,unit,error),onDone()},ifJointError:function(error){sendErrorResult(ws,unit,error),onDone()},ifNeedHashTree:function(){bCatchingUp||bWaitingForCatchupChain||requestCatchup(ws),onDone()},ifNeedParentUnits:function(arrMissingUnits){sendInfo(ws,{unit:unit,info:"unresolved dependencies: "+arrMissingUnits.join(", ")}),joint_storage.saveUnhandledJointAndDependencies(objJoint,arrMissingUnits,ws.peer,function(){delete assocUnitsInWork[unit]}),requestNewMissingJoints(ws,arrMissingUnits),onDone()},ifOk:function(){sendResult(ws,{unit:unit,result:"accepted"}),bCatchingUp||conf.bLight||forwardJoint(ws,objJoint),delete assocUnitsInWork[unit],findAndHandleJointsThatAreReady(unit),onDone()},ifOkUnsigned:function(){delete assocUnitsInWork[unit],onDone()},ifKnown:function(){if(objJoint.unsigned)throw Error("known unsigned");sendResult(ws,{unit:unit,result:"known"}),writeEvent("known_good",ws.host),onDone()},ifKnownBad:function(){sendResult(ws,{unit:unit,result:"known_bad"}),writeEvent("known_bad",ws.host),objJoint.unsigned&&eventBus.emit("validated-"+unit,!1),onDone()},ifKnownUnverified:function(){sendResult(ws,{unit:unit,result:"known_unverified"}),delete assocUnitsInWork[unit],onDone()}})}function handleSavedJoint(objJoint,creation_ts,peer){var unit=objJoint.unit.unit,ws=getPeerWebSocket(peer);ws&&ws.readyState!==ws.OPEN&&(ws=null),handleJoint(ws,objJoint,!0,{ifUnitInWork:function(){},ifUnitError:function(error){ws&&sendErrorResult(ws,unit,error)},ifJointError:function(error){ws&&sendErrorResult(ws,unit,error)},ifNeedHashTree:function(){throw Error("handleSavedJoint: need hash tree")},ifNeedParentUnits:function(arrMissingUnits){db.query("SELECT 1 FROM archived_joints WHERE unit IN(?) LIMIT 1",[arrMissingUnits],function(rows){if(0===rows.length)throw Error("unit "+unit+" still has unresolved dependencies: "+arrMissingUnits.join(", "));breadcrumbs.add("unit "+unit+" has unresolved dependencies that were archived: "+arrMissingUnits.join(", ")),ws?requestNewMissingJoints(ws,arrMissingUnits):findNextPeer(null,function(next_ws){requestNewMissingJoints(next_ws,arrMissingUnits)}),delete assocUnitsInWork[unit]})},ifOk:function(){ws&&sendResult(ws,{unit:unit,result:"accepted"}),!bCatchingUp&&!conf.bLight&&creation_ts>Date.now()-FORWARDING_TIMEOUT&&forwardJoint(ws,objJoint),joint_storage.removeUnhandledJointAndDependencies(unit,function(){delete assocUnitsInWork[unit],findAndHandleJointsThatAreReady(unit)})},ifOkUnsigned:function(){joint_storage.removeUnhandledJointAndDependencies(unit,function(){delete assocUnitsInWork[unit]})},ifKnown:function(){},ifKnownBad:function(){},ifNew:function(){delete assocUnitsInWork[unit],console.log("new in handleSavedJoint: "+unit)}})}function handleLightOnlineJoint(ws,objJoint){mutex.lock(["light_joints"],function(unlock){breadcrumbs.add("got light_joints for handleLightOnlineJoint "+objJoint.unit.unit),handleOnlineJoint(ws,objJoint,function(){breadcrumbs.add("handleLightOnlineJoint done"),unlock()})})}function setWatchedAddresses(_arrWatchedAddresses){arrWatchedAddresses=_arrWatchedAddresses}function addWatchedAddress(address){arrWatchedAddresses.push(address)}function notifyWatchers(objJoint,source_ws){var objUnit=objJoint.unit,arrAddresses=objUnit.authors.map(function(author){return author.address});if(objUnit.messages){for(var i=0;i<objUnit.messages.length;i++){var message=objUnit.messages[i];if("payment"===message.app&&message.payload)for(var payload=message.payload,j=0;j<payload.outputs.length;j++){var address=payload.outputs[j].address;arrAddresses.indexOf(address)===-1&&arrAddresses.push(address)}}_.intersection(arrWatchedAddresses,arrAddresses).length>0?(eventBus.emit("new_my_transactions",[objJoint.unit.unit]),eventBus.emit("new_my_unit-"+objJoint.unit.unit,objJoint)):db.query("SELECT 1 FROM my_addresses WHERE address IN(?) UNION SELECT 1 FROM shared_addresses WHERE shared_address IN(?)",[arrAddresses,arrAddresses],function(rows){rows.length>0&&(eventBus.emit("new_my_transactions",[objJoint.unit.unit]),eventBus.emit("new_my_unit-"+objJoint.unit.unit,objJoint))}),conf.bLight||objJoint.ball||db.query("SELECT peer FROM watched_light_addresses WHERE address IN(?)",[arrAddresses],function(rows){0!==rows.length&&(objUnit.timestamp=Math.round(Date.now()/1e3),rows.forEach(function(row){var ws=getPeerWebSocket(row.peer);ws&&ws.readyState===ws.OPEN&&ws!==source_ws&&sendJoint(ws,objJoint)}))})}}function notifyWatchersAboutStableJoints(mci){mutex.lock(["write"],function(unlock){unlock(),notifyLocalWatchedAddressesAboutStableJoints(mci),console.log("notifyWatchersAboutStableJoints "+mci),mci<=1||storage.findLastBallMciOfMci(db,mci,function(last_ball_mci){storage.findLastBallMciOfMci(db,mci-1,function(prev_last_ball_mci){prev_last_ball_mci!==last_ball_mci&&notifyLightClientsAboutStableJoints(prev_last_ball_mci,last_ball_mci)})})})}function notifyLightClientsAboutStableJoints(from_mci,to_mci){db.query("SELECT peer FROM units JOIN unit_authors USING(unit) JOIN watched_light_addresses USING(address) \n\t\tWHERE main_chain_index>? AND main_chain_index<=? \n\t\tUNION \n\t\tSELECT peer FROM units JOIN outputs USING(unit) JOIN watched_light_addresses USING(address) \n\t\tWHERE main_chain_index>? AND main_chain_index<=? \n\t\tUNION \n\t\tSELECT peer FROM units JOIN watched_light_units USING(unit) \n\t\tWHERE main_chain_index>? AND main_chain_index<=?",[from_mci,to_mci,from_mci,to_mci,from_mci,to_mci],function(rows){rows.forEach(function(row){var ws=getPeerWebSocket(row.peer);ws&&ws.readyState===ws.OPEN&&sendJustsaying(ws,"light/have_updates")}),db.query("DELETE FROM watched_light_units \n\t\t\t\tWHERE unit IN (SELECT unit FROM units WHERE main_chain_index>? AND main_chain_index<=?)",[from_mci,to_mci],function(){})})}function notifyLocalWatchedAddressesAboutStableJoints(mci){function handleRows(rows){rows.length>0&&eventBus.emit("my_transactions_became_stable",rows.map(function(row){return row.unit}))}arrWatchedAddresses.length>0&&db.query("SELECT unit FROM units JOIN unit_authors USING(unit) WHERE main_chain_index=? AND address IN(?) \n\t\t\tUNION \n\t\t\tSELECT unit FROM units JOIN outputs USING(unit) WHERE main_chain_index=? AND address IN(?)",[mci,arrWatchedAddresses,mci,arrWatchedAddresses],handleRows),db.query("SELECT unit FROM units JOIN unit_authors USING(unit) JOIN my_addresses USING(address) WHERE main_chain_index=? \n\t\tUNION \n\t\tSELECT unit FROM units JOIN outputs USING(unit) JOIN my_addresses USING(address) WHERE main_chain_index=? \n\t\tUNION \n\t\tSELECT unit FROM units JOIN unit_authors USING(unit) JOIN shared_addresses ON address=shared_address WHERE main_chain_index=? \n\t\tUNION \n\t\tSELECT unit FROM units JOIN outputs USING(unit) JOIN shared_addresses ON address=shared_address WHERE main_chain_index=?",[mci,mci,mci,mci],handleRows)}function addLightWatchedAddress(address){conf.bLight&&exports.light_vendor_url&&findOutboundPeerOrConnect(exports.light_vendor_url,function(err,ws){err||sendJustsaying(ws,"light/new_address_to_watch",address)})}function flushEvents(forceFlushing){if(0!=peer_events_buffer.length&&(forceFlushing||100==peer_events_buffer.length)){var arrQueryParams=[],objUpdatedHosts={};peer_events_buffer.forEach(function(event_row){var host=event_row.host,event=event_row.event,event_date=event_row.event_date;if("new_good"===event){var column="count_"+event+"_joints";_.set(objUpdatedHosts,[host,column],_.get(objUpdatedHosts,[host,column],0)+1)}arrQueryParams.push("("+db.escape(host)+","+db.escape(event)+","+db.getFromUnixTime(event_date)+")")});for(var host in objUpdatedHosts){var columns_obj=objUpdatedHosts[host],sql_columns_updates=[];for(var column in columns_obj)sql_columns_updates.push(column+"="+column+"+"+columns_obj[column]);db.query("UPDATE peer_hosts SET "+sql_columns_updates.join()+" WHERE peer_host=?",[host])}db.query("INSERT INTO peer_events (peer_host, event, event_date) VALUES "+arrQueryParams.join()),peer_events_buffer=[],objUpdatedHosts={}}}function writeEvent(event,host){if("invalid"===event||"nonserial"===event){var column="count_"+event+"_joints";return db.query("UPDATE peer_hosts SET "+column+"="+column+"+1 WHERE peer_host=?",[host]),void db.query("INSERT INTO peer_events (peer_host, event) VALUES (?,?)",[host,event])}var event_date=Math.floor(Date.now()/1e3);peer_events_buffer.push({host:host,event:event,event_date:event_date}),flushEvents()}function findAndHandleJointsThatAreReady(unit){joint_storage.readDependentJointsThatAreReady(unit,handleSavedJoint),handleSavedPrivatePayments(unit)}function comeOnline(){bCatchingUp=!1,coming_online_time=Date.now(),waitTillIdle(requestFreeJointsFromAllOutboundPeers),eventBus.emit("catching_up_done")}function isIdle(){return 0===db.getCountUsedConnections()&&0===mutex.getCountOfQueuedJobs()&&0===mutex.getCountOfLocks()&&0===Object.keys(assocUnitsInWork).length}function waitTillIdle(onIdle){isIdle()?(bWaitingTillIdle=!1,onIdle()):(bWaitingTillIdle=!0,setTimeout(function(){waitTillIdle(onIdle)},100))}function broadcastJoint(objJoint){conf.bLight||(wss.clients.concat(arrOutboundPeers).forEach(function(client){client.bSubscribed&&sendJoint(client,objJoint)}),notifyWatchers(objJoint))}function checkCatchupLeftovers(){db.query("SELECT 1 FROM hash_tree_balls \n\t\tUNION \n\t\tSELECT 1 FROM catchup_chain_balls \n\t\tLIMIT 1",function(rows){return 0===rows.length?console.log("no leftovers"):(console.log("have catchup leftovers from the previous run"),void findNextPeer(null,function(ws){console.log("will request leftovers from "+ws.peer),bCatchingUp||bWaitingForCatchupChain||requestCatchup(ws)}))})}function requestCatchup(ws){console.log("will request catchup from "+ws.peer),eventBus.emit("catching_up_started"),catchup.purgeHandledBallsFromHashTree(db,function(){db.query("SELECT hash_tree_balls.unit FROM hash_tree_balls LEFT JOIN units USING(unit) WHERE units.unit IS NULL ORDER BY ball_index",function(tree_rows){return tree_rows.length>0?(bCatchingUp=!0,console.log("will request balls found in hash tree"),requestNewMissingJoints(ws,tree_rows.map(function(tree_row){return tree_row.unit})),void waitTillHashTreeFullyProcessedAndRequestNext(ws)):void db.query("SELECT 1 FROM catchup_chain_balls LIMIT 1",function(chain_rows){return chain_rows.length>0?(bCatchingUp=!0,void requestNextHashTree(ws)):(bWaitingForCatchupChain=!0,void storage.readLastStableMcIndex(db,function(last_stable_mci){storage.readLastMainChainIndex(function(last_known_mci){myWitnesses.readMyWitnesses(function(arrWitnesses){var params={witnesses:arrWitnesses,last_stable_mci:last_stable_mci,last_known_mci:last_known_mci};sendRequest(ws,"catchup",params,!0,handleCatchupChain)},"wait")})}))})})})}function handleCatchupChain(ws,request,response){if(response.error)return bWaitingForCatchupChain=!1,void console.log("catchup request got error response: "+response.error);var catchupChain=response;catchup.processCatchupChain(catchupChain,ws.peer,{ifError:function(error){bWaitingForCatchupChain=!1,sendError(ws,error)},ifOk:function(){bWaitingForCatchupChain=!1,bCatchingUp=!0,requestNextHashTree(ws)},ifCurrent:function(){bWaitingForCatchupChain=!1}})}function requestNextHashTree(ws){db.query("SELECT COUNT(1) AS count_left FROM catchup_chain_balls",function(rows){
rows.length>0&&eventBus.emit("catchup_balls_left",rows[0].count_left)}),db.query("SELECT ball FROM catchup_chain_balls ORDER BY member_index LIMIT 2",function(rows){if(0===rows.length)return comeOnline();if(1===rows.length)return void db.query("DELETE FROM catchup_chain_balls WHERE ball=?",[rows[0].ball],function(){comeOnline()});var from_ball=rows[0].ball,to_ball=rows[1].ball;for(var tag in ws.assocPendingRequests)if("get_hash_tree"===ws.assocPendingRequests[tag].request.command)return void console.log("already requested hash tree from this peer");sendRequest(ws,"get_hash_tree",{from_ball:from_ball,to_ball:to_ball},!0,handleHashTree)})}function handleHashTree(ws,request,response){if(response.error)return console.log("get_hash_tree got error response: "+response.error),void waitTillHashTreeFullyProcessedAndRequestNext(ws);var hashTree=response;catchup.processHashTree(hashTree.balls,{ifError:function(error){sendError(ws,error),waitTillHashTreeFullyProcessedAndRequestNext(ws)},ifOk:function(){requestNewMissingJoints(ws,hashTree.balls.map(function(objBall){return objBall.unit})),waitTillHashTreeFullyProcessedAndRequestNext(ws)}})}function waitTillHashTreeFullyProcessedAndRequestNext(ws){setTimeout(function(){db.query("SELECT 1 FROM hash_tree_balls LEFT JOIN units USING(unit) WHERE units.unit IS NULL LIMIT 1",function(rows){0===rows.length?findNextPeer(ws,function(next_ws){requestNextHashTree(next_ws)}):waitTillHashTreeFullyProcessedAndRequestNext(ws)})},1e3)}function sendPrivatePaymentToWs(ws,arrChains){arrChains.forEach(function(arrPrivateElements){sendJustsaying(ws,"private_payment",arrPrivateElements)})}function sendPrivatePayment(peer,arrChains){var ws=getPeerWebSocket(peer);return ws?sendPrivatePaymentToWs(ws,arrChains):void findOutboundPeerOrConnect(peer,function(err,ws){err||sendPrivatePaymentToWs(ws,arrChains)})}function handleOnlinePrivatePayment(ws,arrPrivateElements,bViaHub,callbacks){if(!ValidationUtils.isNonemptyArray(arrPrivateElements))return callbacks.ifError("private_payment content must be non-empty array");var unit=arrPrivateElements[0].unit,message_index=arrPrivateElements[0].message_index,output_index=arrPrivateElements[0].payload.denomination?arrPrivateElements[0].output_index:-1,savePrivatePayment=function(cb){db.query("INSERT "+db.getIgnore()+" INTO unhandled_private_payments (unit, message_index, output_index, json, peer) VALUES (?,?,?,?,?)",[unit,message_index,output_index,JSON.stringify(arrPrivateElements),bViaHub?"":ws.peer],function(){callbacks.ifQueued(),cb&&cb()})};return conf.bLight&&arrPrivateElements.length>1?void savePrivatePayment(function(){updateLinkProofsOfPrivateChain(arrPrivateElements,unit,message_index,output_index),rerequestLostJointsOfPrivatePayments()}):void joint_storage.checkIfNewUnit(unit,{ifKnown:function(){privatePayment.validateAndSavePrivatePaymentChain(arrPrivateElements,{ifOk:function(){callbacks.ifAccepted(unit),eventBus.emit("new_my_transactions",[unit])},ifError:function(error){callbacks.ifValidationError(unit,error)},ifWaitingForChain:function(){savePrivatePayment()}})},ifNew:function(){savePrivatePayment(),requestNewMissingJoints(ws,[unit])},ifKnownUnverified:savePrivatePayment,ifKnownBad:function(){callbacks.ifValidationError(unit,"known bad")}})}function handleSavedPrivatePayments(unit){mutex.lock(["saved_private"],function(unlock){var sql=unit?"SELECT json, peer, unit, message_index, output_index, linked FROM unhandled_private_payments WHERE unit="+db.escape(unit):"SELECT json, peer, unit, message_index, output_index, linked FROM unhandled_private_payments CROSS JOIN units USING(unit)";db.query(sql,function(rows){if(0===rows.length)return unlock();var assocNewUnits={};async.each(rows,function(row,cb){var arrPrivateElements=JSON.parse(row.json),ws=getPeerWebSocket(row.peer);ws&&ws.readyState!==ws.OPEN&&(ws=null);var validateAndSave=function(){var objHeadPrivateElement=arrPrivateElements[0],payload_hash=objectHash.getBase64Hash(objHeadPrivateElement.payload),key="private_payment_validated-"+objHeadPrivateElement.unit+"-"+payload_hash+"-"+row.output_index;privatePayment.validateAndSavePrivatePaymentChain(arrPrivateElements,{ifOk:function(){ws&&sendResult(ws,{private_payment_in_unit:row.unit,result:"accepted"}),row.peer&&eventBus.emit("new_direct_private_chains",[arrPrivateElements]),assocNewUnits[row.unit]=!0,deleteHandledPrivateChain(row.unit,row.message_index,row.output_index,cb),console.log("emit "+key),eventBus.emit(key,!0)},ifError:function(error){console.log("validation of priv: "+error),ws&&sendResult(ws,{private_payment_in_unit:row.unit,result:"error",error:error}),deleteHandledPrivateChain(row.unit,row.message_index,row.output_index,cb),eventBus.emit(key,!1)},ifWaitingForChain:function(){cb()}})};conf.bLight&&arrPrivateElements.length>1&&!row.linked?updateLinkProofsOfPrivateChain(arrPrivateElements,row.unit,row.message_index,row.output_index,cb,validateAndSave):validateAndSave()},function(){unlock();var arrNewUnits=Object.keys(assocNewUnits);arrNewUnits.length>0&&eventBus.emit("new_my_transactions",arrNewUnits)})})})}function deleteHandledPrivateChain(unit,message_index,output_index,cb){db.query("DELETE FROM unhandled_private_payments WHERE unit=? AND message_index=? AND output_index=?",[unit,message_index,output_index],function(){cb()})}function rerequestLostJointsOfPrivatePayments(){conf.bLight&&exports.light_vendor_url&&db.query("SELECT DISTINCT unhandled_private_payments.unit FROM unhandled_private_payments LEFT JOIN units USING(unit) WHERE units.unit IS NULL",function(rows){if(0!==rows.length){var arrUnits=rows.map(function(row){return row.unit});findOutboundPeerOrConnect(exports.light_vendor_url,function(err,ws){err||requestNewMissingJoints(ws,arrUnits)})}})}function requestUnfinishedPastUnitsOfPrivateChains(arrChains,onDone){onDone||(onDone=function(){}),privatePayment.findUnfinishedPastUnitsOfPrivateChains(arrChains,!0,function(arrUnits){return 0===arrUnits.length?onDone():(breadcrumbs.add(arrUnits.length+" unfinished past units of private chains"),void requestProofsOfJoints(arrUnits,onDone))})}function requestProofsOfJoints(arrUnits,onDone){onDone||(onDone=function(){}),myWitnesses.readMyWitnesses(function(arrWitnesses){var objHistoryRequest={witnesses:arrWitnesses,requested_joints:arrUnits};requestFromLightVendor("light/get_history",objHistoryRequest,function(ws,request,response){return response.error?(console.log(response.error),onDone(response.error)):void light.processHistory(response,{ifError:function(err){sendError(ws,err),onDone(err)},ifOk:function(){onDone()}})})},"wait")}function requestProofsOfJointsIfNewOrUnstable(arrUnits,onDone){onDone||(onDone=function(){}),storage.filterNewOrUnstableUnits(arrUnits,function(arrNewOrUnstableUnits){return 0===arrNewOrUnstableUnits.length?onDone():void requestProofsOfJoints(arrUnits,onDone)})}function requestUnfinishedPastUnitsOfSavedPrivateElements(){mutex.lock(["private_chains"],function(unlock){db.query("SELECT json FROM unhandled_private_payments",function(rows){if(eventBus.emit("unhandled_private_payments_left",rows.length),0===rows.length)return unlock();breadcrumbs.add(rows.length+" unhandled private payments");var arrChains=[];rows.forEach(function(row){var arrPrivateElements=JSON.parse(row.json);arrChains.push(arrPrivateElements)}),requestUnfinishedPastUnitsOfPrivateChains(arrChains,function(err){return err?unlock():(handleSavedPrivatePayments(),void setTimeout(unlock,2e3))})})})}function checkThatEachChainElementIncludesThePrevious(arrPrivateElements,handleResult){if(1===arrPrivateElements.length)return handleResult(!0);var arrUnits=arrPrivateElements.map(function(objPrivateElement){return objPrivateElement.unit});requestFromLightVendor("light/get_link_proofs",arrUnits,function(ws,request,response){if(response.error)return handleResult(null);var arrChain=response;return ValidationUtils.isNonemptyArray(arrChain)?void light.processLinkProofs(arrUnits,arrChain,{ifError:function(err){throw console.log("linkproof validation failed: "+err),Error(err)},ifOk:function(){console.log("linkproof validated ok"),handleResult(!0)}}):handleResult(null)})}function updateLinkProofsOfPrivateChain(arrPrivateElements,unit,message_index,output_index,onFailure,onSuccess){if(!conf.bLight)throw Error("not light but updateLinkProofsOfPrivateChain");onFailure||(onFailure=function(){}),onSuccess||(onSuccess=function(){}),checkThatEachChainElementIncludesThePrevious(arrPrivateElements,function(bLinked){return null===bLinked?onFailure():bLinked?void db.query("UPDATE unhandled_private_payments SET linked=1 WHERE unit=? AND message_index=?",[unit,message_index],function(){onSuccess()}):deleteHandledPrivateChain(unit,message_index,output_index,onFailure)})}function initWitnessesIfNecessary(ws,onDone){onDone=onDone||function(){},myWitnesses.readMyWitnesses(function(arrWitnesses){return arrWitnesses.length>0?onDone():void sendRequest(ws,"get_witnesses",null,!1,function(ws,request,arrWitnesses){return arrWitnesses.error?(console.log("get_witnesses returned error: "+arrWitnesses.error),onDone()):void myWitnesses.insertWitnesses(arrWitnesses,onDone)})},"ignore")}function sendStoredDeviceMessages(ws,device_address){db.query("SELECT message_hash, message FROM device_messages WHERE device_address=? ORDER BY creation_date LIMIT 100",[device_address],function(rows){rows.forEach(function(row){sendJustsaying(ws,"hub/message",{message_hash:row.message_hash,message:JSON.parse(row.message)})}),sendInfo(ws,rows.length+" messages sent"),sendJustsaying(ws,"hub/message_box_status",100===rows.length?"has_more":"empty")})}function handleJustsaying(ws,subject,body){switch(subject){case"refresh":if(bCatchingUp)return;var mci=body;return ValidationUtils.isNonnegativeInteger(mci)?sendJointsSinceMci(ws,mci):sendFreeJoints(ws);case"version":if(!body)return;if(body.protocol_version!==constants.version)return sendError(ws,"Incompatible versions, mine "+constants.version+", yours "+body.protocol_version),void ws.close(1e3,"incompatible versions");if(body.alt!==constants.alt)return sendError(ws,"Incompatible alts, mine "+constants.alt+", yours "+body.alt),void ws.close(1e3,"incompatible alts");ws.library_version=body.library_version,eventBus.emit("peer_version",ws,body);break;case"new_version":if(!body)return;(ws.bLoggingIn||ws.bLoggedIn)&&eventBus.emit("new_version",ws,body);break;case"hub/push_project_number":if(!body)return;(ws.bLoggingIn||ws.bLoggedIn)&&eventBus.emit("receivedPushProjectNumber",ws,body);break;case"bugreport":if(!body)return;if(conf.ignoreBugreportRegexp&&new RegExp(conf.ignoreBugreportRegexp).test(body.exception.toString()))return console.log("ignoring bugreport");mail.sendBugEmail(body.message,body.exception);break;case"joint":var objJoint=body;if(!objJoint||!objJoint.unit||!objJoint.unit.unit)return sendError(ws,"no unit");if(objJoint.ball&&!storage.isGenesisUnit(objJoint.unit.unit))return sendError(ws,"only requested joint can contain a ball");if(conf.bLight&&!ws.bLightVendor)return sendError(ws,"I'm a light client and you are not my vendor");db.query("SELECT 1 FROM archived_joints WHERE unit=? AND reason='uncovered'",[objJoint.unit.unit],function(rows){return rows.length>0?sendError(ws,"this unit is already known and archived"):conf.bLight?handleLightOnlineJoint(ws,objJoint):handleOnlineJoint(ws,objJoint)});case"free_joints_end":case"result":case"info":case"error":break;case"private_payment":if(!body)return;var arrPrivateElements=body;handleOnlinePrivatePayment(ws,arrPrivateElements,!1,{ifError:function(error){sendError(ws,error)},ifAccepted:function(unit){sendResult(ws,{private_payment_in_unit:unit,result:"accepted"}),eventBus.emit("new_direct_private_chains",[arrPrivateElements])},ifValidationError:function(unit,error){sendResult(ws,{private_payment_in_unit:unit,result:"error",error:error})},ifQueued:function(){}});break;case"my_url":if(!body)return;var url=body;if(ws.bOutbound)break;if(ws.bAdvertisedOwnUrl)break;if(ws.bAdvertisedOwnUrl=!0,0!==url.indexOf("ws://")&&0!==url.indexOf("wss://"))break;ws.claimed_url=url,db.query("SELECT creation_date AS latest_url_change_date, url FROM peer_host_urls WHERE peer_host=? ORDER BY creation_date DESC LIMIT 1",[ws.host],function(rows){var latest_change=rows[0];latest_change&&latest_change.url===url||(ws.sent_echo_string=crypto.randomBytes(30).toString("base64"),findOutboundPeerOrConnect(url,function(err,reverse_ws){err||sendJustsaying(reverse_ws,"want_echo",ws.sent_echo_string)}))});break;case"want_echo":var echo_string=body;if(ws.bOutbound||!echo_string)break;if(!ws.claimed_url)break;var reverse_ws=getOutboundPeerWsByUrl(ws.claimed_url);if(!reverse_ws)break;sendJustsaying(reverse_ws,"your_echo",echo_string);break;case"your_echo":var echo_string=body;if(ws.bOutbound||!echo_string)break;if(!ws.claimed_url)break;if(ws.sent_echo_string!==echo_string)break;var outbound_host=getHostByPeer(ws.claimed_url),arrQueries=[];db.addQuery(arrQueries,"INSERT "+db.getIgnore()+" INTO peer_hosts (peer_host) VALUES (?)",[outbound_host]),db.addQuery(arrQueries,"INSERT "+db.getIgnore()+" INTO peers (peer_host, peer, learnt_from_peer_host) VALUES (?,?,?)",[outbound_host,ws.claimed_url,ws.host]),db.addQuery(arrQueries,"UPDATE peer_host_urls SET is_active=NULL, revocation_date="+db.getNow()+" WHERE peer_host=?",[ws.host]),db.addQuery(arrQueries,"INSERT INTO peer_host_urls (peer_host, url) VALUES (?,?)",[ws.host,ws.claimed_url]),async.series(arrQueries),ws.sent_echo_string=null;break;case"hub/login":if(!body)return;if(!conf.bServeAsHub)return sendError(ws,"I'm not a hub");var objLogin=body;if(objLogin.challenge!==ws.challenge)return sendError(ws,"wrong challenge");if(!objLogin.pubkey||!objLogin.signature)return sendError(ws,"no login params");if(objLogin.pubkey.length!==constants.PUBKEY_LENGTH)return sendError(ws,"wrong pubkey length");if(objLogin.signature.length!==constants.SIG_LENGTH)return sendError(ws,"wrong signature length");if(!ecdsaSig.verify(objectHash.getDeviceMessageHashToSign(objLogin),objLogin.signature,objLogin.pubkey))return sendError(ws,"wrong signature");ws.device_address=objectHash.getDeviceAddress(objLogin.pubkey);var finishLogin=function(){ws.bLoginComplete=!0,ws.onLoginComplete&&(ws.onLoginComplete(),delete ws.onLoginComplete)};db.query("SELECT 1 FROM devices WHERE device_address=?",[ws.device_address],function(rows){0===rows.length?db.query("INSERT INTO devices (device_address, pubkey) VALUES (?,?)",[ws.device_address,objLogin.pubkey],function(){sendInfo(ws,"address created"),finishLogin()}):(sendStoredDeviceMessages(ws,ws.device_address),finishLogin())}),conf.pushApiProjectNumber&&conf.pushApiKey?sendJustsaying(ws,"hub/push_project_number",{projectNumber:conf.pushApiProjectNumber}):sendJustsaying(ws,"hub/push_project_number",{projectNumber:0});break;case"hub/refresh":if(!conf.bServeAsHub)return sendError(ws,"I'm not a hub");if(!ws.device_address)return sendError(ws,"please log in first");sendStoredDeviceMessages(ws,ws.device_address);break;case"hub/delete":if(!conf.bServeAsHub)return sendError(ws,"I'm not a hub");var message_hash=body;if(!message_hash)return sendError(ws,"no message hash");if(!ws.device_address)return sendError(ws,"please log in first");db.query("DELETE FROM device_messages WHERE device_address=? AND message_hash=?",[ws.device_address,message_hash],function(){sendInfo(ws,"deleted message "+message_hash)});break;case"hub/challenge":case"hub/message":case"hub/message_box_status":if(!body)return;eventBus.emit("message_from_hub",ws,subject,body);break;case"light/have_updates":if(!conf.bLight)return sendError(ws,"I'm not light");if(!ws.bLightVendor)return sendError(ws,"You are not my light vendor");eventBus.emit("message_for_light",ws,subject,body);break;case"light/new_address_to_watch":if(conf.bLight)return sendError(ws,"I'm light myself, can't serve you");if(ws.bOutbound)return sendError(ws,"light clients have to be inbound");var address=body;if(!ValidationUtils.isValidAddress(address))return sendError(ws,"address not valid");db.query("INSERT "+db.getIgnore()+" INTO watched_light_addresses (peer, address) VALUES (?,?)",[ws.peer,address],function(){sendInfo(ws,"now watching "+address),db.query("SELECT unit, is_stable FROM unit_authors JOIN units USING(unit) WHERE address=? \n\t\t\t\t\tUNION \n\t\t\t\t\tSELECT unit, is_stable FROM outputs JOIN units USING(unit) WHERE address=? \n\t\t\t\t\tORDER BY is_stable LIMIT 10",[address,address],function(rows){0!==rows.length&&((10===rows.length||rows.some(function(row){return row.is_stable}))&&sendJustsaying(ws,"light/have_updates"),rows.forEach(function(row){row.is_stable||storage.readJoint(db,row.unit,{ifFound:function(objJoint){sendJoint(ws,objJoint)},ifNotFound:function(){throw Error("watched unit "+row.unit+" not found")}})}))})})}}function handleRequest(ws,tag,command,params){if(ws.assocInPreparingResponse[tag])return console.log("ignoring identical "+command+" request");switch(ws.assocInPreparingResponse[tag]=!0,command){case"heartbeat":ws.bSleeping=!1;var bPaused="undefined"!=typeof window&&window&&window.cordova&&Date.now()-last_hearbeat_wake_ts>PAUSE_TIMEOUT;if(bPaused)return sendResponse(ws,tag,"sleep");sendResponse(ws,tag);break;case"subscribe":if(!ValidationUtils.isNonemptyObject(params))return sendErrorResponse(ws,tag,"no params");var subscription_id=params.subscription_id;if("string"!=typeof subscription_id)return sendErrorResponse(ws,tag,"no subscription_id");if(wss.clients.concat(arrOutboundPeers).some(function(other_ws){return other_ws.subscription_id===subscription_id}))return ws.bOutbound&&db.query("UPDATE peers SET is_self=1 WHERE peer=?",[ws.peer]),sendErrorResponse(ws,tag,"self-connect"),ws.close(1e3,"self-connect");if(conf.bLight)return sendErrorResponse(ws,tag,"I'm light, cannot subscribe you to updates");if(ws.bSubscribed=!0,sendResponse(ws,tag,"subscribed"),bCatchingUp)return;ValidationUtils.isNonnegativeInteger(params.last_mci)?sendJointsSinceMci(ws,params.last_mci):sendFreeJoints(ws);break;case"get_joint":var unit=params;storage.readJoint(db,unit,{ifFound:function(objJoint){sendJoint(ws,objJoint,tag)},ifNotFound:function(){sendResponse(ws,tag,{joint_not_found:unit})}});break;case"post_joint":var objJoint=params;handlePostedJoint(ws,objJoint,function(error){error?sendErrorResponse(ws,tag,error):sendResponse(ws,tag,"accepted")});break;case"catchup":var catchupRequest=params;catchup.prepareCatchupChain(catchupRequest,{ifError:function(error){sendErrorResponse(ws,tag,error)},ifOk:function(objCatchupChain){sendResponse(ws,tag,objCatchupChain)}});break;case"get_hash_tree":var hashTreeRequest=params;catchup.readHashTree(hashTreeRequest,{ifError:function(error){sendErrorResponse(ws,tag,error)},ifOk:function(arrBalls){sendResponse(ws,tag,{balls:arrBalls})}});break;case"get_peers":var arrPeerUrls=arrOutboundPeers.map(function(ws){return ws.peer});sendResponse(ws,tag,arrPeerUrls);break;case"get_witnesses":myWitnesses.readMyWitnesses(function(arrWitnesses){sendResponse(ws,tag,arrWitnesses)},"wait");break;case"get_last_mci":storage.readLastMainChainIndex(function(last_mci){sendResponse(ws,tag,last_mci)});break;case"hub/deliver":var objDeviceMessage=params;if(!(objDeviceMessage&&objDeviceMessage.signature&&objDeviceMessage.pubkey&&objDeviceMessage.to&&objDeviceMessage.encrypted_package&&objDeviceMessage.encrypted_package.dh&&objDeviceMessage.encrypted_package.dh.sender_ephemeral_pubkey&&objDeviceMessage.encrypted_package.encrypted_message&&objDeviceMessage.encrypted_package.iv&&objDeviceMessage.encrypted_package.authtag))return sendErrorResponse(ws,tag,"missing fields");var bToMe=my_device_address&&my_device_address===objDeviceMessage.to;if(!conf.bServeAsHub&&!bToMe)return sendErrorResponse(ws,tag,"I'm not a hub");if(!ecdsaSig.verify(objectHash.getDeviceMessageHashToSign(objDeviceMessage),objDeviceMessage.signature,objDeviceMessage.pubkey))return sendErrorResponse(ws,tag,"wrong message signature");if(bToMe)return sendResponse(ws,tag,"accepted"),void eventBus.emit("message_from_hub",ws,"hub/message",objDeviceMessage);db.query("SELECT 1 FROM devices WHERE device_address=?",[objDeviceMessage.to],function(rows){if(0===rows.length)return sendErrorResponse(ws,tag,"address "+objDeviceMessage.to+" not registered here");var message_hash=objectHash.getBase64Hash(objDeviceMessage);db.query("INSERT "+db.getIgnore()+" INTO device_messages (message_hash, message, device_address) VALUES (?,?,?)",[message_hash,JSON.stringify(objDeviceMessage),objDeviceMessage.to],function(){wss.clients.forEach(function(client){client.device_address===objDeviceMessage.to&&sendJustsaying(client,"hub/message",{message_hash:message_hash,message:objDeviceMessage})}),sendResponse(ws,tag,"accepted"),eventBus.emit("peer_sent_new_message",ws,objDeviceMessage)})});break;case"hub/get_temp_pubkey":var permanent_pubkey=params;if(!permanent_pubkey)return sendErrorResponse(ws,tag,"no permanent_pubkey");if(permanent_pubkey.length!==constants.PUBKEY_LENGTH)return sendErrorResponse(ws,tag,"wrong permanent_pubkey length");var device_address=objectHash.getDeviceAddress(permanent_pubkey);if(device_address===my_device_address)return sendResponse(ws,tag,objMyTempPubkeyPackage);if(!conf.bServeAsHub)return sendErrorResponse(ws,tag,"I'm not a hub");db.query("SELECT temp_pubkey_package FROM devices WHERE device_address=?",[device_address],function(rows){if(0===rows.length)return sendErrorResponse(ws,tag,"device with this pubkey is not registered here");if(!rows[0].temp_pubkey_package)return sendErrorResponse(ws,tag,"temp pub key not set yet");var objTempPubkey=JSON.parse(rows[0].temp_pubkey_package);sendResponse(ws,tag,objTempPubkey)});break;case"hub/temp_pubkey":if(!conf.bServeAsHub)return sendErrorResponse(ws,tag,"I'm not a hub");if(!ws.device_address)return sendErrorResponse(ws,tag,"please log in first");var objTempPubkey=params;if(!objTempPubkey.temp_pubkey||!objTempPubkey.pubkey||!objTempPubkey.signature)return sendErrorResponse(ws,tag,"no temp_pubkey params");if(objTempPubkey.temp_pubkey.length!==constants.PUBKEY_LENGTH)return sendErrorResponse(ws,tag,"wrong temp_pubkey length");if(objectHash.getDeviceAddress(objTempPubkey.pubkey)!==ws.device_address)return sendErrorResponse(ws,tag,"signed by another pubkey");if(!ecdsaSig.verify(objectHash.getDeviceMessageHashToSign(objTempPubkey),objTempPubkey.signature,objTempPubkey.pubkey))return sendErrorResponse(ws,tag,"wrong signature");var fnUpdate=function(onDone){db.query("UPDATE devices SET temp_pubkey_package=? WHERE device_address=?",[JSON.stringify(objTempPubkey),ws.device_address],function(){onDone&&onDone()})};fnUpdate(function(){sendResponse(ws,tag,"updated")}),ws.bLoginComplete||(ws.onLoginComplete=fnUpdate);break;case"light/get_history":if(conf.bLight)return sendErrorResponse(ws,tag,"I'm light myself, can't serve you");if(ws.bOutbound)return sendErrorResponse(ws,tag,"light clients have to be inbound");light.prepareHistory(params,{ifError:function(err){sendErrorResponse(ws,tag,err)},ifOk:function(objResponse){sendResponse(ws,tag,objResponse),params.addresses&&db.query("INSERT "+db.getIgnore()+" INTO watched_light_addresses (peer, address) VALUES "+params.addresses.map(function(address){return"("+db.escape(ws.peer)+", "+db.escape(address)+")"}).join(", ")),params.requested_joints&&storage.sliceAndExecuteQuery("SELECT unit FROM units WHERE main_chain_index >= ? AND unit IN(?)",[storage.getMinRetrievableMci(),params.requested_joints],params.requested_joints,function(rows){rows.length&&db.query("INSERT "+db.getIgnore()+" INTO watched_light_units (peer, unit) VALUES "+rows.map(function(row){return"("+db.escape(ws.peer)+", "+db.escape(row.unit)+")"}).join(", "))})}});break;case"light/get_link_proofs":if(conf.bLight)return sendErrorResponse(ws,tag,"I'm light myself, can't serve you");if(ws.bOutbound)return sendErrorResponse(ws,tag,"light clients have to be inbound");light.prepareLinkProofs(params,{ifError:function(err){sendErrorResponse(ws,tag,err)},ifOk:function(objResponse){sendResponse(ws,tag,objResponse)}});break;case"light/get_parents_and_last_ball_and_witness_list_unit":if(conf.bLight)return sendErrorResponse(ws,tag,"I'm light myself, can't serve you");if(ws.bOutbound)return sendErrorResponse(ws,tag,"light clients have to be inbound");light.prepareParentsAndLastBallAndWitnessListUnit(params.witnesses,{ifError:function(err){sendErrorResponse(ws,tag,err)},ifOk:function(objResponse){sendResponse(ws,tag,objResponse)}});break;case"hub/enable_notification":ws.device_address&&eventBus.emit("enableNotification",ws.device_address,params),sendResponse(ws,tag,"ok");break;case"hub/disable_notification":ws.device_address&&eventBus.emit("disableNotification",ws.device_address,params),sendResponse(ws,tag,"ok");break;case"hub/get_bots":db.query("SELECT id, name, pairing_code, description FROM bots ORDER BY rank DESC, id",[],function(rows){sendResponse(ws,tag,rows)})}}function onWebsocketMessage(message){var ws=this;if(ws.readyState===ws.OPEN){console.log("RECEIVED "+(message.length>1e3?message.substr(0,1e3)+"...":message)+" from "+ws.peer),ws.last_ts=Date.now();try{var arrMessage=JSON.parse(message)}catch(e){return console.log("failed to json.parse message "+message)}var message_type=arrMessage[0],content=arrMessage[1];switch(message_type){case"justsaying":return handleJustsaying(ws,content.subject,content.body);case"request":return handleRequest(ws,content.tag,content.command,content.params);case"response":return handleResponse(ws,content.tag,content.response);default:console.log("unknown type: "+message_type)}}}function startAcceptingConnections(){db.query("DELETE FROM watched_light_addresses"),db.query("DELETE FROM watched_light_units"),wss=new WebSocketServer({port:conf.port}),wss.on("connection",function(ws){var ip=ws.upgradeReq.connection.remoteAddress;if(!ip)return console.log("no ip in accepted connection"),void ws.terminate();if(ws.upgradeReq.headers["x-real-ip"]&&("127.0.0.1"===ip||ip.match(/^192\.168\./)||ip.match(/^10\.144\./)||ip.match(/^10\.212\./))&&(ip=ws.upgradeReq.headers["x-real-ip"]),ws.peer=ip+":"+ws.upgradeReq.connection.remotePort,ws.host=ip,ws.assocPendingRequests={},ws.assocInPreparingResponse={},ws.bInbound=!0,ws.last_ts=Date.now(),console.log("got connection from "+ws.peer+", host "+ws.host),wss.clients.length>=conf.MAX_INBOUND_CONNECTIONS)return console.log("inbound connections maxed out, rejecting new client "+ip),void ws.close(1e3,"inbound connections maxed out");var bStatsCheckUnderWay=!0;db.query("SELECT \n\t\t\t\tSUM(CASE WHEN event='invalid' THEN 1 ELSE 0 END) AS count_invalid, \n\t\t\t\tSUM(CASE WHEN event='new_good' THEN 1 ELSE 0 END) AS count_new_good \n\t\t\t\tFROM peer_events WHERE peer_host=? AND event_date>"+db.addTime("-1 HOUR"),[ws.host],function(rows){bStatsCheckUnderWay=!1;var stats=rows[0];return stats.count_invalid?(console.log("rejecting new client "+ws.host+" because of bad stats"),ws.terminate()):(sendVersion(ws),conf.bServeAsHub&&(ws.challenge=crypto.randomBytes(30).toString("base64"),sendJustsaying(ws,"hub/challenge",ws.challenge)),conf.bLight||subscribe(ws),void eventBus.emit("connected",ws))}),ws.on("message",function(message){function tryHandleMessage(){bStatsCheckUnderWay?setTimeout(tryHandleMessage,100):onWebsocketMessage.call(ws,message)}tryHandleMessage()}),ws.on("close",function(){db.query("DELETE FROM watched_light_addresses WHERE peer=?",[ws.peer]),db.query("DELETE FROM watched_light_units WHERE peer=?",[ws.peer]),console.log("client "+ws.peer+" disconnected"),cancelRequestsOnClosedConnection(ws)}),ws.on("error",function(e){console.log("error on client "+ws.peer+": "+e),ws.close(1e3,"received error")}),addPeerHost(ws.host)}),console.log("WSS running at port "+conf.port)}function startRelay(){process.browser||!conf.port?wss={clients:[]}:startAcceptingConnections(),checkCatchupLeftovers(),conf.bWantNewPeers&&(addOutboundPeers(),setInterval(addOutboundPeers,6e4),setTimeout(checkIfHaveEnoughOutboundPeersAndAdd,3e4),setInterval(purgeDeadPeers,18e5)),setInterval(purgePeerEvents,216e5),rerequestLostJoints(),setInterval(rerequestLostJoints,8e3),setInterval(purgeJunkUnhandledJoints,18e5),setInterval(joint_storage.purgeUncoveredNonserialJointsUnderLock,6e4),setInterval(findAndHandleJointsThatAreReady,5e3)}function startLightClient(){wss={clients:[]},rerequestLostJointsOfPrivatePayments(),setInterval(rerequestLostJointsOfPrivatePayments,5e3),setInterval(handleSavedPrivatePayments,5e3),setInterval(requestUnfinishedPastUnitsOfSavedPrivateElements,12e3)}function start(){console.log("starting network"),conf.bLight?startLightClient():startRelay(),setInterval(printConnectionStatus,6e3),setInterval(heartbeat,3e3+getRandomInt(0,1e3))}function closeAllWsConnections(){arrOutboundPeers.forEach(function(ws){ws.close(1e3,"Re-connect")})}function isConnected(){return arrOutboundPeers.length+wss.clients.length}var wss,WebSocket=process.browser?global.WebSocket:require("ws"),socks=process.browser?null:require("socks"),WebSocketServer=WebSocket.Server,crypto=require("crypto"),_=require("lodash"),async=require("async"),db=require("./db.js"),constants=require("./constants.js"),storage=require("./storage.js"),myWitnesses=require("./my_witnesses.js"),joint_storage=require("./joint_storage.js"),validation=require("./validation.js"),ValidationUtils=require("./validation_utils.js"),writer=require("./writer.js"),conf=require("./conf.js"),mutex=require("./mutex.js"),catchup=require("./catchup.js"),privatePayment=require("./private_payment.js"),objectHash=require("./object_hash.js"),ecdsaSig=require("./signature.js"),eventBus=require("./event_bus.js"),light=require("./light.js"),breadcrumbs=require("./breadcrumbs.js"),mail=process.browser?null:require("./mail.js"),FORWARDING_TIMEOUT=1e4,STALLED_TIMEOUT=5e3,RESPONSE_TIMEOUT=3e5,HEARTBEAT_TIMEOUT=conf.HEARTBEAT_TIMEOUT||1e4,HEARTBEAT_RESPONSE_TIMEOUT=6e4,PAUSE_TIMEOUT=2*HEARTBEAT_TIMEOUT,arrOutboundPeers=[],assocConnectingOutboundWebsockets={},assocUnitsInWork={},assocRequestedUnits={},bCatchingUp=!1,bWaitingForCatchupChain=!1,bWaitingTillIdle=!1,coming_online_time=Date.now(),assocReroutedConnectionsByTag={},arrWatchedAddresses=[],last_hearbeat_wake_ts=Date.now(),peer_events_buffer=[],assocKnownPeers={};process.browser&&(console.log("defining .on() on ws"),WebSocket.prototype.on=function(event,callback){var self=this;return"message"===event?void(this["on"+event]=function(event){callback.call(self,event.data)}):"open"!==event?void(this["on"+event]=callback):(this.open_handlers||(this.open_handlers=[]),this.open_handlers.push(callback),void(this["on"+event]=function(){self.open_handlers.forEach(function(cb){cb()})}))},WebSocket.prototype.once=WebSocket.prototype.on,WebSocket.prototype.setMaxListeners=function(){});var my_device_address,objMyTempPubkeyPackage;exports.light_vendor_url=null,eventBus.on("mci_became_stable",notifyWatchersAboutStableJoints),setInterval(function(){flushEvents(!0)},6e4),start(),exports.start=start,exports.postJointToLightVendor=postJointToLightVendor,exports.broadcastJoint=broadcastJoint,exports.sendPrivatePayment=sendPrivatePayment,exports.sendJustsaying=sendJustsaying,exports.sendError=sendError,exports.sendRequest=sendRequest,exports.findOutboundPeerOrConnect=findOutboundPeerOrConnect,exports.handleOnlineJoint=handleOnlineJoint,exports.handleOnlinePrivatePayment=handleOnlinePrivatePayment,exports.requestUnfinishedPastUnitsOfPrivateChains=requestUnfinishedPastUnitsOfPrivateChains,exports.requestProofsOfJointsIfNewOrUnstable=requestProofsOfJointsIfNewOrUnstable,exports.requestFromLightVendor=requestFromLightVendor,exports.addPeer=addPeer,exports.initWitnessesIfNecessary=initWitnessesIfNecessary,exports.setMyDeviceProps=setMyDeviceProps,exports.setWatchedAddresses=setWatchedAddresses,exports.addWatchedAddress=addWatchedAddress,exports.addLightWatchedAddress=addLightWatchedAddress,exports.closeAllWsConnections=closeAllWsConnections,exports.isConnected=isConnected}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./breadcrumbs.js":365,
"./catchup.js":366,"./conf.js":370,"./constants.js":371,"./db.js":372,"./event_bus.js":378,"./joint_storage.js":382,"./light.js":383,"./mutex.js":388,"./my_witnesses.js":389,"./object_hash.js":392,"./package.json":394,"./private_payment.js":397,"./signature.js":399,"./storage.js":402,"./validation.js":404,"./validation_utils.js":405,"./writer.js":411,_process:309,async:26,crypto:181,lodash:271,ws:void 0}],392:[function(require,module,exports){"use strict";function getSourceString(obj){function extractComponents(variable){if(null===variable)throw Error("null value in "+JSON.stringify(obj));switch(typeof variable){case"string":arrComponents.push("s",variable);break;case"number":arrComponents.push("n",variable.toString());break;case"boolean":arrComponents.push("b",variable.toString());break;case"object":if(Array.isArray(variable)){if(0===variable.length)throw Error("empty array in "+JSON.stringify(obj));arrComponents.push("[");for(var i=0;i<variable.length;i++)extractComponents(variable[i]);arrComponents.push("]")}else{var keys=Object.keys(variable).sort();if(0===keys.length)throw Error("empty object in "+JSON.stringify(obj));keys.forEach(function(key){if("undefined"==typeof variable[key])throw Error("undefined at "+key+" of "+JSON.stringify(obj));arrComponents.push(key),extractComponents(variable[key])})}break;default:throw Error("hash: unknown type="+typeof variable+" of "+variable+", object: "+JSON.stringify(obj))}}var arrComponents=[];return extractComponents(obj),arrComponents.join("\0")}function getChash160(obj){return chash.getChash160(getSourceString(obj))}function getChash288(obj){return chash.getChash288(getSourceString(obj))}function getHexHash(obj){return crypto.createHash("sha256").update(getSourceString(obj),"utf8").digest("hex")}function getBase64Hash(obj){return crypto.createHash("sha256").update(getSourceString(obj),"utf8").digest("base64")}function getNakedUnit(objUnit){var objNakedUnit=_.cloneDeep(objUnit);if(delete objNakedUnit.unit,delete objNakedUnit.headers_commission,delete objNakedUnit.payload_commission,delete objNakedUnit.main_chain_index,delete objNakedUnit.timestamp,objNakedUnit.messages)for(var i=0;i<objNakedUnit.messages.length;i++)delete objNakedUnit.messages[i].payload,delete objNakedUnit.messages[i].payload_uri;return objNakedUnit}function getUnitContentHash(objUnit){return getBase64Hash(getNakedUnit(objUnit))}function getUnitHash(objUnit){if(objUnit.content_hash)return getBase64Hash(getNakedUnit(objUnit));var objStrippedUnit={content_hash:getUnitContentHash(objUnit),version:objUnit.version,alt:objUnit.alt,authors:objUnit.authors.map(function(author){return{address:author.address}})};return objUnit.witness_list_unit?objStrippedUnit.witness_list_unit=objUnit.witness_list_unit:objStrippedUnit.witnesses=objUnit.witnesses,objUnit.parent_units&&(objStrippedUnit.parent_units=objUnit.parent_units,objStrippedUnit.last_ball=objUnit.last_ball,objStrippedUnit.last_ball_unit=objUnit.last_ball_unit),getBase64Hash(objStrippedUnit)}function getUnitHashToSign(objUnit){for(var objNakedUnit=getNakedUnit(objUnit),i=0;i<objNakedUnit.authors.length;i++)delete objNakedUnit.authors[i].authentifiers;return crypto.createHash("sha256").update(getSourceString(objNakedUnit),"utf8").digest()}function getBallHash(unit,arrParentBalls,arrSkiplistBalls,bNonserial){var objBall={unit:unit};return arrParentBalls&&arrParentBalls.length>0&&(objBall.parent_balls=arrParentBalls),arrSkiplistBalls&&arrSkiplistBalls.length>0&&(objBall.skiplist_balls=arrSkiplistBalls),bNonserial&&(objBall.is_nonserial=!0),getBase64Hash(objBall)}function getJointHash(objJoint){return crypto.createHash("sha256").update(JSON.stringify(objJoint),"utf8").digest("base64")}function cleanNulls(obj){Object.keys(obj).forEach(function(key){null===obj[key]&&delete obj[key]})}function getDeviceAddress(b64_pubkey){return"0"+getChash160(b64_pubkey)}function getDeviceMessageHashToSign(objDeviceMessage){var objNakedDeviceMessage=_.clone(objDeviceMessage);return delete objNakedDeviceMessage.signature,crypto.createHash("sha256").update(getSourceString(objNakedDeviceMessage),"utf8").digest()}var crypto=require("crypto"),_=require("lodash"),chash=require("./chash.js");exports.getChash160=getChash160,exports.getChash288=getChash288,exports.getHexHash=getHexHash,exports.getBase64Hash=getBase64Hash,exports.getUnitContentHash=getUnitContentHash,exports.getUnitHash=getUnitHash,exports.getUnitHashToSign=getUnitHashToSign,exports.getBallHash=getBallHash,exports.getJointHash=getJointHash,exports.cleanNulls=cleanNulls,exports.getDeviceAddress=getDeviceAddress,exports.getDeviceMessageHashToSign=getDeviceMessageHashToSign},{"./chash.js":367,crypto:181,lodash:271}],393:[function(require,module,exports){"use strict";function getLength(value){if(null===value)return 0;switch(typeof value){case"string":return value.length;case"number":return 8;case"object":var len=0;if(Array.isArray(value))value.forEach(function(element){len+=getLength(element)});else for(var key in value){if("undefined"==typeof value[key])throw Error("undefined at "+key+" of "+JSON.stringify(value));len+=getLength(value[key])}return len;case"boolean":return 1;default:throw Error("unknown type="+typeof value+" of "+value)}}function getHeadersSize(objUnit){if(objUnit.content_hash)throw Error("trying to get headers size of stripped unit");var objHeader=_.cloneDeep(objUnit);return delete objHeader.unit,delete objHeader.headers_commission,delete objHeader.payload_commission,delete objHeader.main_chain_index,delete objHeader.timestamp,delete objHeader.messages,delete objHeader.parent_units,getLength(objHeader)+PARENT_UNITS_SIZE}function getTotalPayloadSize(objUnit){if(objUnit.content_hash)throw Error("trying to get payload size of stripped unit");return getLength(objUnit.messages)}var _=require("lodash"),PARENT_UNITS_SIZE=88;exports.getHeadersSize=getHeadersSize,exports.getTotalPayloadSize=getTotalPayloadSize},{lodash:271}],394:[function(require,module,exports){module.exports={_args:[["trustnote-common@git+https://github.com/trustnote/trustnote-common.git","/home/zhangchongyang/code/hdWallet/trustnote-wallet"]],_from:"git+https://github.com/trustnote/trustnote-common.git",_id:"trustnote-common@0.1.0",_inCache:!0,_installable:!0,_location:"/trustnote-common",_phantomChildren:{},_requested:{hosted:{directUrl:"https://raw.githubusercontent.com/trustnote/trustnote-common/master/package.json",gitUrl:"git://github.com/trustnote/trustnote-common.git",httpsUrl:"git+https://github.com/trustnote/trustnote-common.git",shortcut:"github:trustnote/trustnote-common",ssh:"git@github.com:trustnote/trustnote-common.git",sshUrl:"git+ssh://git@github.com/trustnote/trustnote-common.git",type:"github"},name:"trustnote-common",raw:"trustnote-common@git+https://github.com/trustnote/trustnote-common.git",rawSpec:"git+https://github.com/trustnote/trustnote-common.git",scope:null,spec:"git+https://github.com/trustnote/trustnote-common.git",type:"hosted"},_requiredBy:["/"],_resolved:"git+https://github.com/trustnote/trustnote-common.git#7adecec4ffa56b3ab0d44e0387460ec0b6ab0a8f",_shasum:"cfd1d8d847de981885a83f24160b40c34a8403b4",_shrinkwrap:null,_spec:"trustnote-common@git+https://github.com/trustnote/trustnote-common.git",_where:"/home/zhangchongyang/code/hdWallet/trustnote-wallet",author:{name:"Trustnote"},browser:{request:"browser-request",secp256k1:"secp256k1/js"},bugs:{url:"https://gitee.com/trustnote/trustnote-common/issues"},dependencies:{async:"^1.5.2",lodash:"^4.6.1",longjohn:"^0.2.11",mysql:"^2.10.2",secp256k1:"^3.1.0",socks:"1.1.10",sqlite3:"^3.1.4","thirty-two":"^1.0.1",ws:"^1.0.1"},description:"Trustnote Common",devDependencies:{},gitHead:"7adecec4ffa56b3ab0d44e0387460ec0b6ab0a8f",homepage:"https://gitee.com/trustnote/trustnote-common",keywords:["trustnote","multisignature"],license:"MIT",name:"trustnote-common",optionalDependencies:{},readme:'# Trustnote common\r\n\r\nThis is a library used in [](https://Trustnote.org) clients.  Never used directly.  Some of the clients that require the library:\r\n\r\n* [Trustnote Wallet](../../../trustnote-wallet) - GUI wallet for Mac, Windows, Linux, iOS, and Android.\r\n* [Trustnote Headless](../../../headless) - headless wallet, primarily for server side use.\r\n\r\n## Developer guides\r\n\r\nMany of the features are not documented yet, see other [Trustnote repositories](https://github.com/Trustnote) as samples, for APIs see the `exports` of node.js modules.\r\n\r\n## Configuring\r\n\r\nThe default settings are in the library\'s [conf.js](conf.js), they can be overridden in your project root\'s conf.js (see the clients above as examples), then in conf.json in the app data folder.  The app data folder is:\r\n\r\n* macOS: `~/Library/Application Support/<appname>`\r\n* Linux: `~/.config/<appname>`\r\n* Windows: `%LOCALAPPDATA%\\<appname>`\r\n\r\n`<appname>` is `name` in your `package.json`.\r\n\r\n### Settings\r\n\r\nThis is the list of some of the settings that the library understands (your app can add more settings that only your app understands):\r\n\r\n#### conf.port\r\n\r\nThe port to listen on.  If you don\'t want to accept incoming connections at all, set port to `null`, which is the default.  If you do want to listen, you will usually have a proxy, such as nginx, accept websocket connections on standard port 443 and forward them to your Trustnote daemon that listens on port 6655 on the local interface.\r\n\r\n#### conf.storage\r\n\r\nStorage backend -- mysql or sqlite, the default is sqlite.  If sqlite, the database files are stored in the app data folder.  If mysql, you need to also initialize the database with [trustnote.sql](trustnote.sql) and set connection params, e.g. in conf.json in the app data folder:\r\n\r\n```json\r\n{\r\n\t"port": 6655,\r\n\t"storage": "mysql",\r\n\t"database": {\r\n\t\t"max_connections": 30,\r\n\t\t"host"     : "localhost",\r\n\t\t"user"     : "Trustnote",\r\n\t\t"password" : "yourmysqlpassword",\r\n\t\t"name"     : "Trustnote"\r\n\t}\r\n}\r\n```\r\n#### conf.bLight\r\n\r\nWork as light client (`true`) or full node (`false`).  The default is full client.\r\n\r\n#### conf.bServeAsHub\r\n\r\nWhether to serve as hub on the Trustnote network (store and forward e2e-encrypted messages for devices that connect to your hub).  The default is `false`.\r\n\r\n#### conf.myUrl\r\n\r\nIf your node accepts incoming connections, this is its URL.  The node will share this URL with all its outgoing peers so that they can reconnect in any direction in the future.  By default the node doesn\'t share its URL even if it accepts connections.\r\n\r\n#### conf.bWantNewPeers\r\n\r\nWhether your node wants to learn about new peers from its current peers (`true`, the default) or not (`false`).  Set it to `false` to run your node in stealth mode so that only trusted peers can see its IP address (e.g. if you have online wallets on your server and don\'t want potential attackers to learn its IP).\r\n\r\n#### conf.socksHost, conf.socksPort, and conf.socksLocalDNS\r\n\r\nSettings for connecting through optional SOCKS5 proxy.  Use them to connect through TOR and hide your IP address from peers even when making outgoing connections.  This is useful and highly recommended when you are running an online wallet on your server and want to make it harder for potential attackers to learn the IP address of the target to attack.  Set `socksLocalDNS` to `false` to route DNS queries through TOR as well.\r\n\r\n#### MySQL conf for faster syncing\r\n\r\nTo lower disk load and increase sync speed, you can optionally disable flushing to disk every transaction, instead doing it once a second. This can be done by setting `innodb_flush_log_at_trx_commit=0` in your MySQL server config file (my.ini)\r\n\r\n## Accepting incoming connections\r\n\r\nTrustnote network works over secure WebSocket protocol wss://.  To accept incoming connections, you\'ll need a valid TLS certificate (you can get a free one from [letsencrypt.org](https://letsencrypt.org)) and a domain name (you can get a free domain from [Freenom](http://www.freenom.com/)).  Then you accept connections on standard port 443 and proxy them to your locally running Trustnote daemon.\r\n\r\nThis is an example configuration for nginx to accept websocket connections at wss://trustnote.org/tn and forward them to locally running daemon that listens on port 6655:\r\n\r\n```nginx\r\nserver {\r\n\tlisten 80 default_server;\r\n\tlisten [::]:80 default_server;\r\n\tlisten 443 ssl;\r\n\tlisten [::]:443 ssl;\r\n\tssl_certificate "/etc/letsencrypt/live/trustnote.org/fullchain.pem";\r\n\tssl_certificate_key "/etc/letsencrypt/live/trustnote.one/privkey.pem";\r\n\r\n\tif ($host != "trustnote.org") {\r\n\t\trewrite ^(.*)$ https://trustnote.org$1 permanent;\r\n\t}\r\n\tif ($https != "on") {\r\n\t\trewrite ^(.*)$ https://trustnote.org$1 permanent;\r\n\t}\r\n\r\n\tlocation = /tn {\r\n\t\tproxy_pass http://localhost:6655;\r\n\t\tproxy_http_version 1.1;\r\n\t\tproxy_set_header X-Real-IP $remote_addr;\r\n\t\tproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\r\n\t\tproxy_set_header Upgrade $http_upgrade;\r\n\t\tproxy_set_header Connection "upgrade";\r\n\t}\r\n\r\n\troot /var/www/html;\r\n\tserver_name _;\r\n}\r\n```\r\n',readmeFilename:"README.md",repository:{type:"git",url:"https://gitee.com/trustnote/trustnote-common.git"},version:"0.1.0"}},{}],395:[function(require,module,exports){"use strict";function calcWitnessEarnings(conn,type,from_main_chain_index,to_main_chain_index,address,callbacks){conn.query("SELECT COUNT(*) AS count FROM units WHERE is_on_main_chain=1 AND is_stable=1 AND main_chain_index>=? AND main_chain_index<=?",[to_main_chain_index,to_main_chain_index+constants.COUNT_MC_BALLS_FOR_PAID_WITNESSING+1],function(count_rows){return count_rows[0].count!==constants.COUNT_MC_BALLS_FOR_PAID_WITNESSING+2?callbacks.ifError("not enough stable MC units after to_main_chain_index"):void mc_outputs.calcEarnings(conn,type,from_main_chain_index,to_main_chain_index,address,callbacks)})}function updatePaidWitnesses(conn,cb){console.log("updating paid witnesses"),profiler.start(),storage.readLastStableMcIndex(conn,function(last_stable_mci){profiler.stop("mc-wc-readLastStableMCI");var max_spendable_mc_index=getMaxSpendableMciForLastBallMci(last_stable_mci);max_spendable_mc_index>0?buildPaidWitnessesTillMainChainIndex(conn,max_spendable_mc_index,cb):cb()})}function buildPaidWitnessesTillMainChainIndex(conn,to_main_chain_index,cb){profiler.start();var cross="sqlite"===conf.storage?"CROSS":"";conn.query("SELECT MIN(main_chain_index) AS min_main_chain_index FROM balls "+cross+" JOIN units USING(unit) WHERE count_paid_witnesses IS NULL",function(rows){function onIndexDone(err){if(err)throw Error(err);main_chain_index++,main_chain_index>to_main_chain_index?cb():buildPaidWitnessesForMainChainIndex(conn,main_chain_index,onIndexDone)}profiler.stop("mc-wc-minMCI");var main_chain_index=rows[0].min_main_chain_index;return main_chain_index>to_main_chain_index?cb():void buildPaidWitnessesForMainChainIndex(conn,main_chain_index,onIndexDone)})}function buildPaidWitnessesForMainChainIndex(conn,main_chain_index,cb){console.log("updating paid witnesses mci "+main_chain_index),profiler.start(),conn.query("SELECT COUNT(*) AS count, SUM(CASE WHEN is_stable=1 THEN 1 ELSE 0 END) AS count_on_stable_mc \n\t\tFROM units WHERE is_on_main_chain=1 AND main_chain_index>=? AND main_chain_index<=?",[main_chain_index,main_chain_index+constants.COUNT_MC_BALLS_FOR_PAID_WITNESSING+1],function(rows){profiler.stop("mc-wc-select-count");var count=rows[0].count,count_on_stable_mc=rows[0].count_on_stable_mc;if(count!==constants.COUNT_MC_BALLS_FOR_PAID_WITNESSING+2)throw Error("main chain is not long enough yet for MC index "+main_chain_index);if(count_on_stable_mc!==count)throw Error("not enough stable MC units yet after MC index "+main_chain_index+": count_on_stable_mc="+count_on_stable_mc+", count="+count);profiler.start(),readMcUnitWitnesses(conn,main_chain_index,function(arrWitnesses){conn.query("CREATE TEMPORARY TABLE paid_witness_events_tmp ( \n\t\t\t\t\tunit CHAR(44) NOT NULL, \n\t\t\t\t\taddress CHAR(32) NOT NULL, \n\t\t\t\t\tdelay TINYINT NULL)",function(){conn.query("SELECT * FROM units WHERE main_chain_index=?",[main_chain_index],function(rows){profiler.stop("mc-wc-select-units"),et=0,rt=0,async.eachSeries(rows,function(row,cb2){buildPaidWitnesses(conn,row,arrWitnesses,cb2)},function(err){if(console.log(rt,et),err)throw Error(err);profiler.start(),conn.query("INSERT INTO witnessing_outputs (main_chain_index, address, amount) \n\t\t\t\t\t\t\t\t\t\tSELECT main_chain_index, address, \n\t\t\t\t\t\t\t\t\t\t\tSUM(CASE WHEN sequence='good' THEN ROUND(1.0*payload_commission/count_paid_witnesses) ELSE 0 END) \n\t\t\t\t\t\t\t\t\t\tFROM balls \n\t\t\t\t\t\t\t\t\t\tJOIN units USING(unit) \n\t\t\t\t\t\t\t\t\t\tJOIN paid_witness_events_tmp USING(unit) \n\t\t\t\t\t\t\t\t\t\tWHERE main_chain_index=? \n\t\t\t\t\t\t\t\t\t\tGROUP BY address",[main_chain_index],function(){conn.query(conn.dropTemporaryTable("paid_witness_events_tmp"),function(){profiler.stop("mc-wc-aggregate-events"),cb()})})})})})})})}function readMcUnitWitnesses(conn,main_chain_index,handleWitnesses){conn.query("SELECT witness_list_unit, unit FROM units WHERE main_chain_index=? AND is_on_main_chain=1",[main_chain_index],function(rows){if(1!==rows.length)throw Error("not 1 row on MC "+main_chain_index);var witness_list_unit=rows[0].witness_list_unit?rows[0].witness_list_unit:rows[0].unit;storage.readWitnessList(conn,witness_list_unit,handleWitnesses)})}function buildPaidWitnesses(conn,objUnitProps,arrWitnesses,onDone){function updateCountPaidWitnesses(count_paid_witnesses){conn.query("UPDATE balls SET count_paid_witnesses=? WHERE unit=?",[count_paid_witnesses,objUnitProps.unit],function(){profiler.stop("mc-wc-insert-events"),onDone()})}var unit=objUnitProps.unit,to_main_chain_index=objUnitProps.main_chain_index+constants.COUNT_MC_BALLS_FOR_PAID_WITNESSING,t=Date.now();graph.readDescendantUnitsByAuthorsBeforeMcIndex(conn,objUnitProps,arrWitnesses,to_main_chain_index,function(arrUnits){rt+=Date.now()-t,t=Date.now(),0===arrUnits.length&&(arrUnits=null),profiler.start(),conn.query("SELECT address, MIN(main_chain_index-?) AS delay \n\t\t\tFROM units \n\t\t\tLEFT JOIN unit_authors USING(unit) \n\t\t\tWHERE unit IN(?) AND address IN(?) AND +sequence='good' \n\t\t\tGROUP BY address",[objUnitProps.main_chain_index,arrUnits,arrWitnesses],function(rows){et+=Date.now()-t;var arrValues,count_paid_witnesses=rows.length;0===count_paid_witnesses?(count_paid_witnesses=arrWitnesses.length,arrValues=arrWitnesses.map(function(address){return"("+conn.escape(unit)+", "+conn.escape(address)+", NULL)"})):arrValues=rows.map(function(row){return"("+conn.escape(unit)+", "+conn.escape(row.address)+", "+row.delay+")"}),profiler.stop("mc-wc-select-events"),profiler.start(),conn.query("INSERT INTO paid_witness_events_tmp (unit, address, delay) VALUES "+arrValues.join(", "),function(){updateCountPaidWitnesses(count_paid_witnesses)})})})}function getMaxSpendableMciForLastBallMci(last_ball_mci){return last_ball_mci-1-constants.COUNT_MC_BALLS_FOR_PAID_WITNESSING}var et,rt,async=(require("lodash"),require("async")),storage=require("./storage.js"),graph=require("./graph.js"),constants=(require("./db.js"),require("./constants.js")),conf=require("./conf.js"),mc_outputs=require("./mc_outputs.js"),profiler=require("./profiler.js");exports.updatePaidWitnesses=updatePaidWitnesses,exports.calcWitnessEarnings=calcWitnessEarnings,exports.getMaxSpendableMciForLastBallMci=getMaxSpendableMciForLastBallMci},{"./conf.js":370,"./constants.js":371,"./db.js":372,"./graph.js":379,"./mc_outputs.js":386,"./profiler.js":398,"./storage.js":402,async:26,lodash:271}],396:[function(require,module,exports){"use strict";function pickParentUnits(conn,arrWitnesses,onDone){conn.query("SELECT \n\t\t\tunit, version, alt, ( \n\t\t\t\tSELECT COUNT(*) \n\t\t\t\tFROM unit_witnesses \n\t\t\t\tWHERE unit_witnesses.unit IN(units.unit, units.witness_list_unit) AND address IN(?) \n\t\t\t) AS count_matching_witnesses \n\t\tFROM units "+("sqlite"===conf.storage?"INDEXED BY byFree":"")+" \n\t\tLEFT JOIN archived_joints USING(unit) \n\t\tWHERE +sequence='good' AND is_free=1 AND archived_joints.unit IS NULL ORDER BY unit LIMIT ?",[arrWitnesses,constants.MAX_PARENTS_PER_UNIT],function(rows){if(rows.some(function(row){return row.version!==constants.version||row.alt!==constants.alt}))throw Error("wrong network");var count_required_matches=constants.COUNT_WITNESSES-constants.MAX_WITNESS_LIST_MUTATIONS;return 0===rows.filter(function(row){return row.count_matching_witnesses>=count_required_matches}).length?pickDeepParentUnits(conn,arrWitnesses,onDone):void onDone(null,rows.map(function(row){return row.unit}))})}function pickDeepParentUnits(conn,arrWitnesses,onDone){conn.query("SELECT unit \n\t\tFROM units \n\t\tWHERE +sequence='good' \n\t\t\tAND ( \n\t\t\t\tSELECT COUNT(*) \n\t\t\t\tFROM unit_witnesses \n\t\t\t\tWHERE unit_witnesses.unit IN(units.unit, units.witness_list_unit) AND address IN(?) \n\t\t\t)>=? \n\t\tORDER BY main_chain_index DESC LIMIT 1",[arrWitnesses,constants.COUNT_WITNESSES-constants.MAX_WITNESS_LIST_MUTATIONS],function(rows){return 0===rows.length?onDone("failed to find compatible parents: no deep units"):void onDone(null,rows.map(function(row){return row.unit}))})}function findLastStableMcBall(conn,arrWitnesses,onDone){conn.query("SELECT ball, unit, main_chain_index FROM units JOIN balls USING(unit) \n\t\tWHERE is_on_main_chain=1 AND is_stable=1 AND +sequence='good' AND ( \n\t\t\tSELECT COUNT(*) \n\t\t\tFROM unit_witnesses \n\t\t\tWHERE unit_witnesses.unit IN(units.unit, units.witness_list_unit) AND address IN(?) \n\t\t)>=? \n\t\tORDER BY main_chain_index DESC LIMIT 1",[arrWitnesses,constants.COUNT_WITNESSES-constants.MAX_WITNESS_LIST_MUTATIONS],function(rows){return 0===rows.length?onDone("failed to find last stable ball"):void onDone(null,rows[0].ball,rows[0].unit,rows[0].main_chain_index)})}function adjustLastStableMcBallAndParents(conn,last_stable_mc_ball_unit,arrParentUnits,arrWitnesses,handleAdjustedLastStableUnit){main_chain.determineIfStableInLaterUnits(conn,last_stable_mc_ball_unit,arrParentUnits,function(bStable){return bStable?void conn.query("SELECT ball, main_chain_index FROM units JOIN balls USING(unit) WHERE unit=?",[last_stable_mc_ball_unit],function(rows){if(1!==rows.length)throw Error("not 1 ball by unit "+last_stable_mc_ball_unit);var row=rows[0];handleAdjustedLastStableUnit(row.ball,last_stable_mc_ball_unit,row.main_chain_index,arrParentUnits)}):(console.log("will adjust last stable ball because "+last_stable_mc_ball_unit+" is not stable in view of parents "+arrParentUnits.join(", ")),arrParentUnits.length>1?void pickDeepParentUnits(conn,arrWitnesses,function(err,arrAdjustedParentUnits){if(err)throw Error("pickDeepParentUnits in adjust failed: "+err);adjustLastStableMcBallAndParents(conn,last_stable_mc_ball_unit,arrAdjustedParentUnits,arrWitnesses,handleAdjustedLastStableUnit)}):void storage.readStaticUnitProps(conn,last_stable_mc_ball_unit,function(objUnitProps){if(!objUnitProps.best_parent_unit)throw Error("no best parent of "+last_stable_mc_ball_unit);adjustLastStableMcBallAndParents(conn,objUnitProps.best_parent_unit,arrParentUnits,arrWitnesses,handleAdjustedLastStableUnit)}))})}function pickParentUnitsAndLastBall(conn,arrWitnesses,onDone){pickParentUnits(conn,arrWitnesses,function(err,arrParentUnits){return err?onDone(err):void findLastStableMcBall(conn,arrWitnesses,function(err,last_stable_mc_ball,last_stable_mc_ball_unit,last_stable_mc_ball_mci){return err?onDone(err):void adjustLastStableMcBallAndParents(conn,last_stable_mc_ball_unit,arrParentUnits,arrWitnesses,function(last_stable_ball,last_stable_unit,last_stable_mci,arrAdjustedParentUnits){storage.findWitnessListUnit(conn,arrWitnesses,last_stable_mci,function(witness_list_unit){var objFakeUnit={parent_units:arrAdjustedParentUnits};witness_list_unit&&(objFakeUnit.witness_list_unit=witness_list_unit),storage.determineIfHasWitnessListMutationsAlongMc(conn,objFakeUnit,last_stable_unit,arrWitnesses,function(err){return err?onDone(err):void onDone(null,arrAdjustedParentUnits,last_stable_ball,last_stable_unit,last_stable_mci)})})})})})}var constants=(require("./db.js"),require("./constants.js")),conf=require("./conf.js"),storage=require("./storage.js"),main_chain=require("./main_chain.js");exports.pickParentUnitsAndLastBall=pickParentUnitsAndLastBall},{"./conf.js":370,"./constants.js":371,"./db.js":372,"./main_chain.js":385,"./storage.js":402}],397:[function(require,module,exports){"use strict";function findUnfinishedPastUnitsOfPrivateChains(arrChains,includeLatestElement,handleUnits){var assocUnits={};arrChains.forEach(function(arrPrivateElements){assocUnits[arrPrivateElements[0].payload.asset]=!0;for(var i=includeLatestElement?0:1;i<arrPrivateElements.length;i++)assocUnits[arrPrivateElements[i].unit]=!0});var arrUnits=Object.keys(assocUnits);storage.filterNewOrUnstableUnits(arrUnits,handleUnits)}function validateAndSavePrivatePaymentChain(arrPrivateElements,callbacks){if(!ValidationUtils.isNonemptyArray(arrPrivateElements))return callbacks.ifError("no priv elements array");var headElement=arrPrivateElements[0];if(!headElement.payload)return callbacks.ifError("no payload in head element");var asset=headElement.payload.asset;if(!asset)return callbacks.ifError("no asset in head element");if(!ValidationUtils.isNonnegativeInteger(headElement.message_index))return callbacks.ifError("no message index in head private element");var validateAndSave=function(){storage.readAsset(db,asset,null,function(err,objAsset){return err?callbacks.ifError(err):!!objAsset.fixed_denominations!=!!headElement.payload.denomination?callbacks.ifError("presence of denomination field doesn't match the asset type"):void db.takeConnectionFromPool(function(conn){conn.query("BEGIN",function(){var transaction_callbacks={ifError:function(err){conn.query("ROLLBACK",function(){conn.release(),callbacks.ifError(err)})},ifOk:function(){conn.query("COMMIT",function(){conn.release(),callbacks.ifOk()})}},sql="SELECT address FROM outputs WHERE unit=? AND message_index=?",params=[headElement.unit,headElement.message_index];if(objAsset.fixed_denominations){if(!ValidationUtils.isNonnegativeInteger(headElement.output_index))return transaction_callbacks.ifError("no output index in head private element");sql+=" AND output_index=?",params.push(headElement.output_index)}conn.query(sql,params,function(rows){if(rows.length>1)throw Error("more than one output "+sql+" "+params.join(", "));if(rows.length>0&&rows[0].address)return console.log("duplicate private payment "+params.join(", ")),transaction_callbacks.ifOk();var assetModule=objAsset.fixed_denominations?indivisibleAsset:divisibleAsset;assetModule.validateAndSavePrivatePaymentChain(conn,arrPrivateElements,transaction_callbacks)})})})})};conf.bLight?findUnfinishedPastUnitsOfPrivateChains([arrPrivateElements],!1,function(arrUnfinishedUnits){arrUnfinishedUnits.length>0?callbacks.ifWaitingForChain():validateAndSave()}):validateAndSave()}var storage=(require("lodash"),require("./storage.js")),db=require("./db.js"),conf=require("./conf.js"),ValidationUtils=require("./validation_utils.js"),indivisibleAsset=require("./indivisible_asset.js"),divisibleAsset=require("./divisible_asset.js");exports.findUnfinishedPastUnitsOfPrivateChains=findUnfinishedPastUnitsOfPrivateChains,exports.validateAndSavePrivatePaymentChain=validateAndSavePrivatePaymentChain},{"./conf.js":370,"./db.js":372,"./divisible_asset.js":376,"./indivisible_asset.js":381,"./storage.js":402,"./validation_utils.js":405,lodash:271}],398:[function(require,module,exports){(function(process){"use strict";function mark_start(tag,id){}function mark_end(tag,id){}function print(){console.log("\nProfiling results:");var total=0;for(var tag in times)total+=times[tag];for(var tag in times)console.log(pad_right(tag+": ",33)+pad_left(times[tag],5)+", "+pad_left((times[tag]/count).toFixed(2),5)+" per unit, "+pad_left((100*times[tag]/total).toFixed(2),5)+"%");console.log("total: "+total),console.log(total/count+" per unit")}function print_results(){console.log("\nBenchmarking results:");for(var tag in timers_results){for(var results=timers_results[tag],sum=0,max=0,min=999999999999,i=0;i<results.length;i++){var v=results[i];sum+=v,v>max&&(max=v),v<min&&(min=v)}console.log(tag.padding(50)+": avg:"+Math.round(sum/results.length).toString().padding(8)+"max:"+Math.round(max).toString().padding(8)+"min:"+Math.round(min).toString().padding(8)+"records:"+results.length)}console.log("\n\nStart time: "+profiler_start_ts+", End time: "+Date.now()+" Elapsed ms:"+(Date.now()-profiler_start_ts))}function pad_right(str,len){return str.length>=len?str:str+" ".repeat(len-str.length)}function pad_left(str,len){return str+="",str.length>=len?str:" ".repeat(len-str.length)+str}var count=0,times={},timers_results={},profiler_start_ts=Date.now();process.on("SIGINT",function(){console.log=clog,console.log("received sigint"),print_results(),process.exit()}),String.prototype.padding=function(n,c){var val=this.valueOf();if(Math.abs(n)<=val.length)return val;var m=Math.max(Math.abs(n)-this.length||0,0),pad=Array(m+1).join(String(c||" ").charAt(0));return n<0?pad+val:val+pad};var clog=console.log;exports.print=print,exports.mark_start=mark_start,exports.mark_end=mark_end,exports.start=function(){},exports.stop=function(){},exports.increment=function(){}}).call(this,require("_process"))},{_process:309}],399:[function(require,module,exports){(function(Buffer){"use strict";var ecdsa=require("secp256k1");exports.sign=function(hash,priv_key){var res=ecdsa.sign(hash,priv_key);return res.signature.toString("base64")},exports.verify=function(hash,b64_sig,b64_pub_key){try{var signature=new Buffer(b64_sig,"base64");return ecdsa.verify(hash,signature,new Buffer(b64_pub_key,"base64"))}catch(e){return console.log("signature verification exception: "+e.toString()),!1}}}).call(this,require("buffer").Buffer)},{buffer:151,secp256k1:325}],400:[function(require,module,exports){"use strict";function migrateDb(connection,onDone){connection.db[bCordova?"query":"all"]("PRAGMA user_version",function(err,result){if(err)throw Error("PRAGMA user_version failed: "+err);var rows=bCordova?result.rows:result;if(1!==rows.length)throw Error("PRAGMA user_version returned "+rows.length+" rows");var version=rows[0].user_version;if(console.log("db version "+version+", software version "+VERSION),version>VERSION)throw Error("user version "+version+" > "+VERSION+": looks like you are using a new database with an old client");if(version===VERSION)return onDone();var arrQueries=[];version<1&&(connection.addQuery(arrQueries,"CREATE INDEX IF NOT EXISTS unitAuthorsIndexByAddressDefinitionChash ON unit_authors(address, definition_chash)"),connection.addQuery(arrQueries,"CREATE INDEX IF NOT EXISTS outputsIsSerial ON outputs(is_serial)"),connection.addQuery(arrQueries,"CREATE INDEX IF NOT EXISTS bySequence ON units(sequence)")),version<2&&(connection.addQuery(arrQueries,"CREATE UNIQUE INDEX IF NOT EXISTS hcobyAddressMci ON headers_commission_outputs(address, main_chain_index)"),connection.addQuery(arrQueries,"CREATE UNIQUE INDEX IF NOT EXISTS byWitnessAddressMci ON witnessing_outputs(address, main_chain_index)"),connection.addQuery(arrQueries,"CREATE INDEX IF NOT EXISTS inputsIndexByAddressTypeToMci ON inputs(address, type, to_main_chain_index)"),connection.addQuery(arrQueries,"DELETE FROM known_bad_joints")),version<5&&connection.addQuery(arrQueries,"CREATE TABLE IF NOT EXISTS push_registrations (registrationId TEXT, device_address TEXT NOT NULL, PRIMARY KEY (device_address))"),version<6&&(connection.addQuery(arrQueries,"CREATE TABLE IF NOT EXISTS chat_messages ( \n\t\t\t\tid INTEGER PRIMARY KEY, \n\t\t\t\tcorrespondent_address CHAR(33) NOT NULL, \n\t\t\t\tmessage LONGTEXT NOT NULL, \n\t\t\t\tcreation_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP, \n\t\t\t\tis_incoming INTEGER(1) NOT NULL, \n\t\t\t\ttype CHAR(15) NOT NULL DEFAULT 'text', \n\t\t\t\tFOREIGN KEY (correspondent_address) REFERENCES correspondent_devices(device_address) \n\t\t\t)"),
connection.addQuery(arrQueries,"CREATE INDEX IF NOT EXISTS chatMessagesIndexByDeviceAddress ON chat_messages(correspondent_address, id)"),connection.addQuery(arrQueries,"ALTER TABLE correspondent_devices ADD COLUMN my_record_pref INTEGER DEFAULT 1"),connection.addQuery(arrQueries,"ALTER TABLE correspondent_devices ADD COLUMN peer_record_pref INTEGER DEFAULT 1"),connection.addQuery(arrQueries,"DELETE FROM known_bad_joints")),version<8&&(connection.addQuery(arrQueries,"CREATE INDEX IF NOT EXISTS bySequence ON units(sequence)"),connection.addQuery(arrQueries,"DELETE FROM known_bad_joints")),version<9&&(connection.addQuery(arrQueries,"CREATE TABLE IF NOT EXISTS watched_light_units (peer VARCHAR(100) NOT NULL, unit CHAR(44) NOT NULL, creation_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP, PRIMARY KEY (peer, unit))"),connection.addQuery(arrQueries,"CREATE INDEX IF NOT EXISTS wlabyUnit ON watched_light_units(unit)")),version<10&&(connection.addQuery(arrQueries,"BEGIN TRANSACTION"),connection.addQuery(arrQueries,"ALTER TABLE chat_messages RENAME TO chat_messages_old"),connection.addQuery(arrQueries,"CREATE TABLE IF NOT EXISTS chat_messages ( \n\t\t\t\tid INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, \n\t\t\t\tcorrespondent_address CHAR(33) NOT NULL, \n\t\t\t\tmessage LONGTEXT NOT NULL, \n\t\t\t\tcreation_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP, \n\t\t\t\tis_incoming INTEGER(1) NOT NULL, \n\t\t\t\ttype CHAR(15) NOT NULL DEFAULT 'text', \n\t\t\t\tFOREIGN KEY (correspondent_address) REFERENCES correspondent_devices(device_address) ON DELETE CASCADE \n\t\t\t)"),connection.addQuery(arrQueries,"INSERT INTO chat_messages SELECT * FROM chat_messages_old"),connection.addQuery(arrQueries,"DROP TABLE chat_messages_old"),connection.addQuery(arrQueries,"CREATE INDEX chatMessagesIndexByDeviceAddress ON chat_messages(correspondent_address, id);"),connection.addQuery(arrQueries,"COMMIT"),connection.addQuery(arrQueries,"DELETE FROM known_bad_joints"),connection.addQuery(arrQueries,"DELETE FROM unhandled_joints"),connection.addQuery(arrQueries,"DELETE FROM dependencies"),connection.addQuery(arrQueries,"DELETE FROM hash_tree_balls"),connection.addQuery(arrQueries,"DELETE FROM catchup_chain_balls")),version<11&&connection.addQuery(arrQueries,"CREATE TABLE IF NOT EXISTS bots ( \n\t\t\t\tid INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, \n\t\t\t\trank INTEGER NOT NULL DEFAULT 0, \n\t\t\t\tname VARCHAR(100) NOT NULL UNIQUE, \n\t\t\t\tpairing_code VARCHAR(200) NOT NULL, \n\t\t\t\tdescription LONGTEXT NOT NULL \n\t\t\t);"),version<12&&connection.addQuery(arrQueries,"DELETE FROM known_bad_joints"),connection.addQuery(arrQueries,"PRAGMA user_version="+VERSION),async.series(arrQueries,onDone)})}var VERSION=12,async=require("async"),bCordova="object"==typeof window&&window.cordova;exports.migrateDb=migrateDb},{async:26}],401:[function(require,module,exports){(function(__dirname){"use strict";function expandArrayPlaceholders(args){var sql=args[0],params=args[1];if(Array.isArray(params)&&0!==params.length){for(var assocLengthsOfArrayParams={},i=0;i<params.length;i++)if(Array.isArray(params[i])){if(0===params[i].length)throw Error("empty array in query params");assocLengthsOfArrayParams[i]=params[i].length}if(0!==Object.keys(assocLengthsOfArrayParams).length){var arrParts=sql.split("?");if(arrParts.length-1!==params.length)throw Error("wrong parameter count");for(var expanded_sql="",i=0;i<arrParts.length&&(expanded_sql+=arrParts[i],i!==arrParts.length-1);i++){var len=assocLengthsOfArrayParams[i];expanded_sql+=len?_.fill(Array(len),"?").join(","):"?"}var flattened_params=_.flatten(params);args[0]=expanded_sql,args[1]=flattened_params}}}function getParentDirPath(){switch(window.cordova.platformId){case"ios":return window.cordova.file.applicationStorageDirectory+"/Library";case"android":default:return window.cordova.file.applicationStorageDirectory}}function getDatabaseDirName(){switch(window.cordova.platformId){case"ios":return"LocalDatabase";case"android":default:return"databases"}}function getDatabaseDirPath(){return getParentDirPath()+"/"+getDatabaseDirName()}function createDatabaseIfNecessary(db_name,onDbReady){console.log("createDatabaseIfNecessary "+db_name);var initial_db_filename="initial."+db_name;if(bCordova)console.log("will wait for deviceready"),document.addEventListener("deviceready",function(){console.log("deviceready handler"),console.log("data dir: "+window.cordova.file.dataDirectory),console.log("app dir: "+window.cordova.file.applicationDirectory),window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(fs){window.resolveLocalFileSystemURL(getDatabaseDirPath()+"/"+db_name,function(fileEntry){console.log("database file already exists"),onDbReady()},function(err){console.log("will copy initial database file"),window.resolveLocalFileSystemURL(window.cordova.file.applicationDirectory+"/www/"+initial_db_filename,function(fileEntry){console.log("got initial db fileentry"),window.resolveLocalFileSystemURL(getParentDirPath(),function(parentDirEntry){console.log("resolved parent dir"),parentDirEntry.getDirectory(getDatabaseDirName(),{create:!0},function(dbDirEntry){console.log("resolved db dir"),fileEntry.copyTo(dbDirEntry,db_name,function(){console.log("copied initial cordova database"),onDbReady()},function(err){throw Error("failed to copyTo: "+JSON.stringify(err))})},function(err){throw Error("failed to getDirectory databases: "+JSON.stringify(err))})},function(err){throw Error("failed to resolveLocalFileSystemURL of parent dir: "+JSON.stringify(err))})},function(err){throw Error("failed to getFile: "+JSON.stringify(err))})})},function(err){throw Error("failed to requestFileSystem: "+err)})},!1);else{var fs=require("fs");fs.stat(path+db_name,function(err,stats){if(console.log("stat "+err),!err)return onDbReady();console.log("will copy initial db");var mode=parseInt("700",8),parent_dir=require("path").dirname(path);fs.mkdir(parent_dir,mode,function(err){console.log("mkdir "+parent_dir+": "+err),fs.mkdir(path,mode,function(err){console.log("mkdir "+path+": "+err),fs.createReadStream(__dirname+"/"+initial_db_filename).pipe(fs.createWriteStream(path+db_name)).on("finish",onDbReady)})})})}}var sqlite3,path,cordovaSqlite,_=require("lodash"),sqlite_migrations=(require("async"),require("./sqlite_migrations")),EventEmitter=require("events").EventEmitter,bCordova="object"==typeof window&&window.cordova;bCordova||(sqlite3=require("sqlite3"),path=require("./desktop_app.js").getAppDataDir()+"/",console.log("path="+path)),module.exports=function(db_name,MAX_CONNECTIONS,bReadOnly){function openDb(cb){if(bCordova){var db=new cordovaSqlite(db_name);return db.open(cb),db}return new sqlite3.Database(path+db_name,bReadOnly?sqlite3.OPEN_READONLY:sqlite3.OPEN_READWRITE,cb)}function connect(handleConnection){console.log("opening new db connection");var db=openDb(function(err){if(err)throw Error(err);console.log("opened db"),connection.query("PRAGMA foreign_keys = 1",function(){connection.query("PRAGMA busy_timeout=30000",function(){connection.query("PRAGMA journal_mode=WAL",function(){connection.query("PRAGMA synchronous=NORMAL",function(){connection.query("PRAGMA temp_store=MEMORY",function(){sqlite_migrations.migrateDb(connection,function(){handleConnection(connection)})})})})})})}),connection={db:db,bInUse:!0,release:function(){if(this.bInUse=!1,0!==arrQueue.length){var connectionHandler=arrQueue.shift();this.bInUse=!0,connectionHandler(this)}},query:function(){if(!this.bInUse)throw Error("this connection was returned to the pool");var last_arg=arguments[arguments.length-1],bHasCallback="function"==typeof last_arg;bHasCallback||(last_arg=function(){});for(var sql=arguments[0],bSelect=!!sql.match(/^SELECT/i),count_arguments_without_callback=bHasCallback?arguments.length-1:arguments.length,new_args=[],i=0;i<count_arguments_without_callback;i++)new_args.push(arguments[i]);1===count_arguments_without_callback&&new_args.push([]),expandArrayPlaceholders(new_args),new_args.push(function(err,result){if(err)throw console.error("\nfailed query:",new_args),Error(err+"\n"+sql+"\n"+new_args[1].map(function(param){return null===param?"null":void 0===param?"undefined":param}).join(", "));bSelect||bCordova||(result={affectedRows:this.changes,insertId:this.lastID}),bSelect&&bCordova&&(result=result.rows||[]);var consumed_time=Date.now()-start_ts;consumed_time>25&&console.log("long query took "+consumed_time+"ms:\n"+new_args.filter(function(a,i){return i<new_args.length-1}).join(", ")+"\nload avg: "+require("os").loadavg().join(", ")),last_arg(result)});var start_ts=Date.now();bCordova?this.db.query.apply(this.db,new_args):bSelect?this.db.all.apply(this.db,new_args):this.db.run.apply(this.db,new_args)},addQuery:addQuery,escape:escape,addTime:addTime,getNow:getNow,getUnixTimestamp:getUnixTimestamp,getFromUnixTime:getFromUnixTime,getRandom:getRandom,getIgnore:getIgnore,forceIndex:forceIndex,dropTemporaryTable:dropTemporaryTable};arrConnections.push(connection)}function addQuery(arr){for(var self=this,query_args=[],i=1;i<arguments.length;i++)query_args.push(arguments[i]);arr.push(function(callback){if("function"!=typeof query_args[query_args.length-1])query_args.push(function(){callback()});else{var f=query_args[query_args.length-1];query_args[query_args.length-1]=function(){f.apply(f,arguments),callback()}}self.query.apply(self,query_args)})}function takeConnectionFromPool(handleConnection){if(!bReady)return console.log("takeConnectionFromPool will wait for ready"),void eventEmitter.once("ready",function(){console.log("db is now ready"),takeConnectionFromPool(handleConnection)});for(var i=0;i<arrConnections.length;i++)if(!arrConnections[i].bInUse)return arrConnections[i].bInUse=!0,handleConnection(arrConnections[i]);return arrConnections.length<MAX_CONNECTIONS?connect(handleConnection):void arrQueue.push(handleConnection)}function onDbReady(){bCordova&&!cordovaSqlite&&(cordovaSqlite=window.cordova.require("cordova-sqlite-plugin.SQLite")),bReady=!0,eventEmitter.emit("ready")}function getCountUsedConnections(){for(var count=0,i=0;i<arrConnections.length;i++)arrConnections[i].bInUse&&count++;return count}function query(){var args=arguments;takeConnectionFromPool(function(connection){var last_arg=args[args.length-1],bHasCallback="function"==typeof last_arg;bHasCallback||(last_arg=function(){});for(var count_arguments_without_callback=bHasCallback?args.length-1:args.length,new_args=[],i=0;i<count_arguments_without_callback;i++)new_args.push(args[i]);new_args.push(function(rows){connection.release(),last_arg(rows)}),connection.query.apply(connection,new_args)})}function close(cb){return cb||(cb=function(){}),bReady=!1,0===arrConnections.length?cb():(arrConnections[0].db.close(cb),void arrConnections.shift())}function addTime(interval){return"datetime('now', '"+interval+"')"}function getNow(){return"datetime('now')"}function getUnixTimestamp(date){return"strftime('%s', "+date+")"}function getFromUnixTime(ts){return"datetime("+ts+", 'unixepoch')"}function getRandom(){return"RANDOM()"}function forceIndex(index){return"INDEXED BY "+index}function dropTemporaryTable(table){return"DROP TABLE IF EXISTS "+table}function getIgnore(){return"OR IGNORE"}function escape(str){if("string"==typeof str)return"'"+str.replace(/'/g,"''")+"'";if(Array.isArray(str))return str.map(function(member){return escape(member)}).join(",");throw Error("escape: unknown type "+typeof str)}var eventEmitter=new EventEmitter,bReady=!1,arrConnections=[],arrQueue=[];createDatabaseIfNecessary(db_name,onDbReady);var pool={};return pool.query=query,pool.addQuery=addQuery,pool.takeConnectionFromPool=takeConnectionFromPool,pool.getCountUsedConnections=getCountUsedConnections,pool.close=close,pool.escape=escape,pool.addTime=addTime,pool.getNow=getNow,pool.getUnixTimestamp=getUnixTimestamp,pool.getFromUnixTime=getFromUnixTime,pool.getRandom=getRandom,pool.getIgnore=getIgnore,pool.forceIndex=forceIndex,pool.dropTemporaryTable=dropTemporaryTable,pool}}).call(this,"/node_modules/trustnote-common")},{"./sqlite_migrations":400,async:26,events:215,lodash:271,os:276,sqlite3:void 0}],402:[function(require,module,exports){"use strict";function readJoint(conn,unit,callbacks){return conf.bSaveJointJson?void conn.query("SELECT json FROM joints WHERE unit=?",[unit],function(rows){return 0===rows.length?readJointDirectly(conn,unit,callbacks):void callbacks.ifFound(JSON.parse(rows[0].json))}):readJointDirectly(conn,unit,callbacks)}function readJointDirectly(conn,unit,callbacks,bRetrying){return console.log("\nreading unit "+unit),null===min_retrievable_mci?(console.log("min_retrievable_mci not known yet"),void setTimeout(function(){readJointDirectly(conn,unit,callbacks)},1e3)):void conn.query("SELECT units.unit, version, alt, witness_list_unit, last_ball_unit, balls.ball AS last_ball, is_stable, \n\t\t\tcontent_hash, headers_commission, payload_commission, main_chain_index, "+conn.getUnixTimestamp("units.creation_date")+" AS timestamp \n\t\tFROM units LEFT JOIN balls ON last_ball_unit=balls.unit WHERE units.unit=?",[unit],function(unit_rows){if(0===unit_rows.length)return callbacks.ifNotFound();var objUnit=unit_rows[0],objJoint={unit:objUnit},main_chain_index=objUnit.main_chain_index;objUnit.timestamp=parseInt(objUnit.timestamp);var bFinalBad=!!objUnit.content_hash,bStable=objUnit.is_stable;delete objUnit.is_stable,objectHash.cleanNulls(objUnit);var bVoided=objUnit.content_hash&&main_chain_index<min_retrievable_mci,bRetrievable=main_chain_index>=min_retrievable_mci||null===main_chain_index;bVoided?(delete objUnit.headers_commission,delete objUnit.payload_commission):delete objUnit.content_hash,async.series([function(callback){conn.query("SELECT parent_unit \n\t\t\t\t\t\tFROM parenthoods \n\t\t\t\t\t\tWHERE child_unit=? \n\t\t\t\t\t\tORDER BY parent_unit",[unit],function(rows){return 0===rows.length?callback():(objUnit.parent_units=rows.map(function(row){return row.parent_unit}),void callback())})},function(callback){return bRetrievable&&!isGenesisUnit(unit)?callback():void conn.query("SELECT ball FROM balls WHERE unit=?",[unit],function(rows){return 0===rows.length?callback():(objJoint.ball=rows[0].ball,void callback())})},function(callback){return bRetrievable?callback():void conn.query("SELECT skiplist_unit FROM skiplist_units WHERE unit=? ORDER BY skiplist_unit",[unit],function(rows){return 0===rows.length?callback():(objJoint.skiplist_units=rows.map(function(row){return row.skiplist_unit}),void callback())})},function(callback){conn.query("SELECT address FROM unit_witnesses WHERE unit=? ORDER BY address",[unit],function(rows){rows.length>0&&(objUnit.witnesses=rows.map(function(row){return row.address})),callback()})},function(callback){return bVoided?callback():void conn.query("SELECT address, earned_headers_commission_share FROM earned_headers_commission_recipients \t\t\t\t\t\tWHERE unit=? ORDER BY address",[unit],function(rows){rows.length>0&&(objUnit.earned_headers_commission_recipients=rows),callback()})},function(callback){conn.query("SELECT address, definition_chash FROM unit_authors WHERE unit=? ORDER BY address",[unit],function(rows){objUnit.authors=[],async.eachSeries(rows,function(row,cb){function onAuthorDone(){objUnit.authors.push(author),cb()}var author={address:row.address};return bVoided?onAuthorDone():(author.authentifiers={},void conn.query("SELECT path, authentifier FROM authentifiers WHERE unit=? AND address=?",[unit,author.address],function(sig_rows){for(var i=0;i<sig_rows.length;i++)author.authentifiers[sig_rows[i].path]=sig_rows[i].authentifier;row.definition_chash?readDefinition(conn,row.definition_chash,{ifFound:function(arrDefinition){author.definition=arrDefinition,onAuthorDone()},ifDefinitionNotFound:function(definition_chash){throw Error("definition "+definition_chash+" not defined")}}):onAuthorDone()}))},function(){callback()})})},function(callback){return bVoided?callback():void conn.query("SELECT app, payload_hash, payload_location, payload, payload_uri, payload_uri_hash, message_index \n\t\t\t\t\t\tFROM messages WHERE unit=? ORDER BY message_index",[unit],function(rows){if(0===rows.length){if(conf.bLight)throw new Error("no messages in unit "+unit);return callback()}objUnit.messages=[],async.eachSeries(rows,function(row,cb){function addSpendProofs(){conn.query("SELECT spend_proof, address FROM spend_proofs WHERE unit=? AND message_index=? ORDER BY spend_proof_index",[unit,message_index],function(proof_rows){if(0===proof_rows.length)return cb();objMessage.spend_proofs=[];for(var i=0;i<proof_rows.length;i++){var objSpendProof=proof_rows[i];1===objUnit.authors.length&&delete objSpendProof.address,objMessage.spend_proofs.push(objSpendProof)}cb()})}var objMessage=row,message_index=row.message_index;if(delete objMessage.message_index,objectHash.cleanNulls(objMessage),objUnit.messages.push(objMessage),"inline"!==objMessage.payload_location)return addSpendProofs();switch(objMessage.app){case"address_definition_change":conn.query("SELECT definition_chash, address FROM address_definition_changes WHERE unit=? AND message_index=?",[unit,message_index],function(dch_rows){if(0===dch_rows.length)throw Error("no definition change?");objMessage.payload=dch_rows[0],1===objUnit.authors.length&&delete objMessage.payload.address,addSpendProofs()});break;case"poll":conn.query("SELECT question FROM polls WHERE unit=? AND message_index=?",[unit,message_index],function(poll_rows){if(1!==poll_rows.length)throw Error("no poll question or too many?");objMessage.payload={question:poll_rows[0].question},conn.query("SELECT choice FROM poll_choices WHERE unit=? ORDER BY choice_index",[unit],function(ch_rows){if(0===ch_rows.length)throw Error("no choices?");objMessage.payload.choices=ch_rows.map(function(choice_row){return choice_row.choice}),addSpendProofs()})});break;case"vote":conn.query("SELECT poll_unit, choice FROM votes WHERE unit=? AND message_index=?",[unit,message_index],function(vote_rows){if(1!==vote_rows.length)throw Error("no vote choice or too many?");objMessage.payload={unit:vote_rows[0].poll_unit,choice:vote_rows[0].choice},addSpendProofs()});break;case"asset":conn.query("SELECT cap, is_private, is_transferrable, auto_destroy, fixed_denominations, \n\t\t\t\t\t\t\t\t\t\t\t\t\tissued_by_definer_only, cosigned_by_definer, spender_attested, \n\t\t\t\t\t\t\t\t\t\t\t\t\tissue_condition, transfer_condition \n\t\t\t\t\t\t\t\t\t\t\t\tFROM assets WHERE unit=? AND message_index=?",[unit,message_index],function(asset_rows){if(1!==asset_rows.length)throw Error("no asset or too many?");objMessage.payload=asset_rows[0],objectHash.cleanNulls(objMessage.payload),objMessage.payload.is_private=!!objMessage.payload.is_private,objMessage.payload.is_transferrable=!!objMessage.payload.is_transferrable,objMessage.payload.auto_destroy=!!objMessage.payload.auto_destroy,objMessage.payload.fixed_denominations=!!objMessage.payload.fixed_denominations,objMessage.payload.issued_by_definer_only=!!objMessage.payload.issued_by_definer_only,objMessage.payload.cosigned_by_definer=!!objMessage.payload.cosigned_by_definer,objMessage.payload.spender_attested=!!objMessage.payload.spender_attested,objMessage.payload.issue_condition&&(objMessage.payload.issue_condition=JSON.parse(objMessage.payload.issue_condition)),objMessage.payload.transfer_condition&&(objMessage.payload.transfer_condition=JSON.parse(objMessage.payload.transfer_condition));var addAttestors=function(next){return objMessage.payload.spender_attested?void conn.query("SELECT attestor_address FROM asset_attestors \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE unit=? AND message_index=? ORDER BY attestor_address",[unit,message_index],function(att_rows){if(0===att_rows.length)throw Error("no attestors?");objMessage.payload.attestors=att_rows.map(function(att_row){return att_row.attestor_address}),next()}):next()},addDenominations=function(next){return objMessage.payload.fixed_denominations?void conn.query("SELECT denomination, count_coins FROM asset_denominations \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE asset=? ORDER BY denomination",[unit],function(denom_rows){if(0===denom_rows.length)throw Error("no denominations?");objMessage.payload.denominations=denom_rows.map(function(denom_row){var denom={denomination:denom_row.denomination};return denom_row.count_coins&&(denom.count_coins=denom_row.count_coins),denom}),next()}):next()};async.series([addAttestors,addDenominations],addSpendProofs)});break;case"asset_attestors":conn.query("SELECT attestor_address, asset FROM asset_attestors \n\t\t\t\t\t\t\t\t\t\t\t\tWHERE unit=? AND message_index=? ORDER BY attestor_address",[unit,message_index],function(att_rows){if(0===att_rows.length)throw Error("no attestors?");if(objMessage.payload={asset:att_rows[0].asset},att_rows.length>1&&att_rows.some(function(att_row){return att_row.asset!==objMessage.payload.asset}))throw Error("different assets in attestor list");objMessage.payload.attestors=att_rows.map(function(att_row){return att_row.attestor_address}),addSpendProofs()});break;case"data_feed":conn.query("SELECT feed_name, `value`, int_value FROM data_feeds WHERE unit=? AND message_index=?",[unit,message_index],function(df_rows){if(0===df_rows.length)throw Error("no data feed?");objMessage.payload={},df_rows.forEach(function(df_row){objMessage.payload[df_row.feed_name]="string"==typeof df_row.value?df_row.value:Number(df_row.int_value)}),addSpendProofs()});break;case"profile":case"attestation":case"data":case"definition_template":objMessage.payload=JSON.parse(objMessage.payload),addSpendProofs();break;case"payment":objMessage.payload={};var prev_asset,prev_denomination,readInputs=function(cb2){conn.query("SELECT type, denomination, assets.fixed_denominations, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\tsrc_unit AS unit, src_message_index AS message_index, src_output_index AS output_index, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfrom_main_chain_index, to_main_chain_index, serial_number, amount, address, asset \n\t\t\t\t\t\t\t\t\t\t\t\t\tFROM inputs \n\t\t\t\t\t\t\t\t\t\t\t\t\tLEFT JOIN assets ON asset=assets.unit \n\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE inputs.unit=? AND inputs.message_index=? \n\t\t\t\t\t\t\t\t\t\t\t\t\tORDER BY input_index",[unit,message_index],function(input_rows){objMessage.payload.inputs=[];for(var i=0;i<input_rows.length;i++){var input=input_rows[i];if(!input.address&&!conf.bLight)throw Error("readJoint: input address is NULL");var asset=input.asset,denomination=input.denomination;if(i>0){if(asset!==prev_asset)throw Error("different assets in inputs?");if(denomination!==prev_denomination)throw Error("different denominations in inputs?")}0===i&&asset&&(objMessage.payload.asset=asset,input.fixed_denominations&&(objMessage.payload.denomination=denomination)),delete input.asset,delete input.denomination,delete input.fixed_denominations,objectHash.cleanNulls(input),"transfer"!==input.type&&1!==objUnit.authors.length||delete input.address,"transfer"===input.type&&delete input.type,objMessage.payload.inputs.push(input),0===i&&(prev_asset=asset,prev_denomination=denomination)}cb2()})},readOutputs=function(cb2){objMessage.payload.outputs=[],conn.query("SELECT address, amount, asset, denomination \n\t\t\t\t\t\t\t\t\t\t\t\t\tFROM outputs WHERE unit=? AND message_index=? ORDER BY output_index",[unit,message_index],function(output_rows){for(var i=0;i<output_rows.length;i++){var output=output_rows[i];if(output.asset!==prev_asset)throw Error("different assets in outputs?");if(output.denomination!==prev_denomination)throw Error("different denominations in outputs?");delete output.asset,delete output.denomination,objMessage.payload.outputs.push(output)}cb2()})};async.series([readInputs,readOutputs],addSpendProofs);break;default:addSpendProofs()}},callback)})}],function(){if(!conf.bLight&&!isCorrectHash(objUnit,unit)){if(bRetrying)throw Error("unit hash verification failed, unit: "+unit+", objUnit: "+JSON.stringify(objUnit));return console.log("unit hash verification failed, will retry"),setTimeout(function(){readJointDirectly(conn,unit,callbacks,!0)},6e4)}return!conf.bSaveJointJson||!bStable||bFinalBad&&bRetrievable||bRetrievable?callbacks.ifFound(objJoint):void conn.query("INSERT "+db.getIgnore()+" INTO joints (unit, json) VALUES (?,?)",[unit,JSON.stringify(objJoint)],function(){callbacks.ifFound(objJoint)})})})}function isCorrectHash(objUnit,unit){try{return objectHash.getUnitHash(objUnit)===unit}catch(e){return!1}}function readJointWithBall(conn,unit,handleJoint){readJoint(conn,unit,{ifNotFound:function(){throw Error("joint not found, unit "+unit)},ifFound:function(objJoint){return objJoint.ball?handleJoint(objJoint):void conn.query("SELECT ball FROM balls WHERE unit=?",[unit],function(rows){1===rows.length&&(objJoint.ball=rows[0].ball),handleJoint(objJoint)})}})}function readWitnessList(conn,unit,handleWitnessList){var arrWitnesses=assocCachedUnitWitnesses[unit];return arrWitnesses?handleWitnessList(arrWitnesses):void conn.query("SELECT address FROM unit_witnesses WHERE unit=? ORDER BY address",[unit],function(rows){if(0===rows.length)throw Error("witness list of unit "+unit+" not found");if(rows.length!==constants.COUNT_WITNESSES)throw Error("wrong number of witnesses in unit "+unit);arrWitnesses=rows.map(function(row){return row.address}),assocCachedUnitWitnesses[unit]=arrWitnesses,handleWitnessList(arrWitnesses)})}function readWitnesses(conn,unit,handleWitnessList){var arrWitnesses=assocCachedUnitWitnesses[unit];return arrWitnesses?handleWitnessList(arrWitnesses):void conn.query("SELECT witness_list_unit FROM units WHERE unit=?",[unit],function(rows){if(0===rows.length)throw Error("unit "+unit+" not found");var witness_list_unit=rows[0].witness_list_unit;readWitnessList(conn,witness_list_unit?witness_list_unit:unit,function(arrWitnesses){assocCachedUnitWitnesses[unit]=arrWitnesses,handleWitnessList(arrWitnesses)})})}function determineIfWitnessAddressDefinitionsHaveReferences(conn,arrWitnesses,handleResult){conn.query("SELECT 1 FROM address_definition_changes JOIN definitions USING(definition_chash) \n\t\tWHERE address IN(?) AND has_references=1 \n\t\tUNION \n\t\tSELECT 1 FROM definitions WHERE definition_chash IN(?) AND has_references=1 \n\t\tLIMIT 1",[arrWitnesses,arrWitnesses],function(rows){handleResult(rows.length>0)})}function readDefinitionByAddress(conn,address,max_mci,callbacks){null===max_mci&&(max_mci=MAX_INT32),conn.query("SELECT definition_chash FROM address_definition_changes CROSS JOIN units USING(unit) \n\t\tWHERE address=? AND is_stable=1 AND sequence='good' AND main_chain_index<=? ORDER BY level DESC LIMIT 1",[address,max_mci],function(rows){var definition_chash=rows.length>0?rows[0].definition_chash:address;readDefinitionAtMci(conn,definition_chash,max_mci,callbacks)})}function readDefinitionAtMci(conn,definition_chash,max_mci,callbacks){var sql="SELECT definition FROM definitions CROSS JOIN unit_authors USING(definition_chash) CROSS JOIN units USING(unit) \n\t\tWHERE definition_chash=? AND is_stable=1 AND sequence='good' AND main_chain_index<=?",params=[definition_chash,max_mci];conn.query(sql,params,function(rows){return 0===rows.length?callbacks.ifDefinitionNotFound(definition_chash):void callbacks.ifFound(JSON.parse(rows[0].definition))})}function readDefinition(conn,definition_chash,callbacks){conn.query("SELECT definition FROM definitions WHERE definition_chash=?",[definition_chash],function(rows){return 0===rows.length?callbacks.ifDefinitionNotFound(definition_chash):void callbacks.ifFound(JSON.parse(rows[0].definition))})}function readFreeJoints(ifFoundFreeBall,onDone){db.query("SELECT units.unit FROM units LEFT JOIN archived_joints USING(unit) WHERE is_free=1 AND archived_joints.unit IS NULL",function(rows){async.each(rows,function(row,cb){readJoint(db,row.unit,{ifNotFound:function(){throw Error("free ball lost")},ifFound:function(objJoint){ifFoundFreeBall(objJoint),cb()}})},onDone)})}function isGenesisUnit(unit){return unit===constants.GENESIS_UNIT}function isGenesisBall(ball){return ball===genesis_ball}function readUnitProps(conn,unit,handleProps){conn.query("SELECT unit, level, latest_included_mc_index, main_chain_index, is_on_main_chain, is_free, is_stable FROM units WHERE unit=?",[unit],function(rows){if(1!==rows.length)throw Error("not 1 row");handleProps(rows[0])})}function readPropsOfUnits(conn,earlier_unit,arrLaterUnits,handleProps){var bEarlierInLaterUnits=arrLaterUnits.indexOf(earlier_unit)!==-1;conn.query("SELECT unit, level, latest_included_mc_index, main_chain_index, is_on_main_chain, is_free FROM units WHERE unit IN(?, ?)",[earlier_unit,arrLaterUnits],function(rows){if(rows.length!==arrLaterUnits.length+(bEarlierInLaterUnits?0:1))throw Error("wrong number of rows for earlier "+earlier_unit+", later "+arrLaterUnits);for(var objEarlierUnitProps,arrLaterUnitProps=[],i=0;i<rows.length;i++)rows[i].unit===earlier_unit?objEarlierUnitProps=rows[i]:arrLaterUnitProps.push(rows[i]);bEarlierInLaterUnits&&arrLaterUnitProps.push(objEarlierUnitProps),handleProps(objEarlierUnitProps,arrLaterUnitProps)})}function readLastStableMcUnitProps(conn,handleLastStableMcUnitProps){conn.query("SELECT units.*, ball FROM units LEFT JOIN balls USING(unit) WHERE is_on_main_chain=1 AND is_stable=1 ORDER BY main_chain_index DESC LIMIT 1",function(rows){if(0===rows.length)return handleLastStableMcUnitProps(null);if(!rows[0].ball)throw Error("no ball for last stable unit");handleLastStableMcUnitProps(rows[0])})}function readLastStableMcIndex(conn,handleLastStableMcIndex){readLastStableMcUnitProps(conn,function(objLastStableMcUnitProps){handleLastStableMcIndex(objLastStableMcUnitProps?objLastStableMcUnitProps.main_chain_index:0)})}function readLastMainChainIndex(handleLastMcIndex){db.query("SELECT MAX(main_chain_index) AS last_mc_index FROM units",function(rows){var last_mc_index=rows[0].last_mc_index;null===last_mc_index&&(last_mc_index=0),handleLastMcIndex(last_mc_index)})}function findLastBallMciOfMci(conn,mci,handleLastBallMci){if(0===mci)throw Error("findLastBallMciOfMci called with mci=0");conn.query("SELECT lb_units.main_chain_index, lb_units.is_on_main_chain \n\t\tFROM units JOIN units AS lb_units ON units.last_ball_unit=lb_units.unit \n\t\tWHERE units.is_on_main_chain=1 AND units.main_chain_index=?",[mci],function(rows){if(1!==rows.length)throw Error("last ball's mci count "+rows.length+" !== 1, mci = "+mci);if(1!==rows[0].is_on_main_chain)throw Error("lb is not on mc?");handleLastBallMci(rows[0].main_chain_index)})}function getMinRetrievableMci(){return min_retrievable_mci}function updateMinRetrievableMciAfterStabilizingMci(conn,last_stable_mci,handleMinRetrievableMci){console.log("updateMinRetrievableMciAfterStabilizingMci "+last_stable_mci),findLastBallMciOfMci(conn,last_stable_mci,function(last_ball_mci){if(last_ball_mci<=min_retrievable_mci)return handleMinRetrievableMci(min_retrievable_mci);var prev_min_retrievable_mci=min_retrievable_mci;min_retrievable_mci=last_ball_mci,conn.query("SELECT DISTINCT unit, content_hash FROM units JOIN messages USING(unit) \n\t\t\tWHERE main_chain_index<=? AND main_chain_index>=? AND sequence='final-bad'",[min_retrievable_mci,prev_min_retrievable_mci],function(unit_rows){var arrQueries=[];async.eachSeries(unit_rows,function(unit_row,cb){var unit=unit_row.unit;if(!unit_row.content_hash)throw Error("no content hash in bad unit "+unit);readJoint(conn,unit,{ifNotFound:function(){throw Error("bad unit not found: "+unit)},ifFound:function(objJoint){generateQueriesToArchiveJoint(conn,objJoint,"voided",arrQueries,cb)}})},function(){return 0===arrQueries.length?handleMinRetrievableMci(min_retrievable_mci):void async.series(arrQueries,function(){unit_rows.forEach(function(unit_row){forgetUnit(unit_row.unit)}),handleMinRetrievableMci(min_retrievable_mci)})})})})}function initializeMinRetrievableMci(){db.query("SELECT MAX(lb_units.main_chain_index) AS min_retrievable_mci \n\t\tFROM units JOIN units AS lb_units ON units.last_ball_unit=lb_units.unit \n\t\tWHERE units.is_on_main_chain=1 AND units.is_stable=1",function(rows){if(1!==rows.length)throw Error("MAX() no rows?");
min_retrievable_mci=rows[0].min_retrievable_mci,null===min_retrievable_mci&&(min_retrievable_mci=0)})}function generateQueriesToArchiveJoint(conn,objJoint,reason,arrQueries,cb){var func="uncovered"===reason?generateQueriesToRemoveJoint:generateQueriesToVoidJoint;func(conn,objJoint.unit.unit,arrQueries,function(){conn.addQuery(arrQueries,"INSERT "+conn.getIgnore()+" INTO archived_joints (unit, reason, json) VALUES (?,?,?)",[objJoint.unit.unit,reason,JSON.stringify(objJoint)]),cb()})}function generateQueriesToRemoveJoint(conn,unit,arrQueries,cb){generateQueriesToUnspendOutputsSpentInArchivedUnit(conn,unit,arrQueries,function(){conn.addQuery(arrQueries,"DELETE FROM witness_list_hashes WHERE witness_list_unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM earned_headers_commission_recipients WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM unit_witnesses WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM authentifiers WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM unit_authors WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM parenthoods WHERE child_unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM address_definition_changes WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM inputs WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM outputs WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM spend_proofs WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM data_feeds WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM poll_choices WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM polls WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM votes WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM attestations WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM asset_denominations WHERE asset=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM asset_attestors WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM assets WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM messages WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM units WHERE unit=?",[unit]),cb()})}function generateQueriesToVoidJoint(conn,unit,arrQueries,cb){generateQueriesToUnspendOutputsSpentInArchivedUnit(conn,unit,arrQueries,function(){conn.addQuery(arrQueries,"DELETE FROM witness_list_hashes WHERE witness_list_unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM earned_headers_commission_recipients WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM authentifiers WHERE unit=?",[unit]),conn.addQuery(arrQueries,"UPDATE unit_authors SET definition_chash=NULL WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM address_definition_changes WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM inputs WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM outputs WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM spend_proofs WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM data_feeds WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM poll_choices WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM polls WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM votes WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM attestations WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM asset_denominations WHERE asset=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM asset_attestors WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM assets WHERE unit=?",[unit]),conn.addQuery(arrQueries,"DELETE FROM messages WHERE unit=?",[unit]),cb()})}function generateQueriesToUnspendOutputsSpentInArchivedUnit(conn,unit,arrQueries,cb){generateQueriesToUnspendTransferOutputsSpentInArchivedUnit(conn,unit,arrQueries,function(){generateQueriesToUnspendHeadersCommissionOutputsSpentInArchivedUnit(conn,unit,arrQueries,function(){generateQueriesToUnspendWitnessingOutputsSpentInArchivedUnit(conn,unit,arrQueries,cb)})})}function generateQueriesToUnspendTransferOutputsSpentInArchivedUnit(conn,unit,arrQueries,cb){conn.query("SELECT src_unit, src_message_index, src_output_index \n\t\tFROM inputs \n\t\tWHERE inputs.unit=? \n\t\t\tAND inputs.type='transfer' \n\t\t\tAND NOT EXISTS ( \n\t\t\t\tSELECT 1 FROM inputs AS alt_inputs \n\t\t\t\tWHERE inputs.src_unit=alt_inputs.src_unit \n\t\t\t\t\tAND inputs.src_message_index=alt_inputs.src_message_index \n\t\t\t\t\tAND inputs.src_output_index=alt_inputs.src_output_index \n\t\t\t\t\tAND alt_inputs.type='transfer' \n\t\t\t\t\tAND inputs.unit!=alt_inputs.unit \n\t\t\t)",[unit],function(rows){rows.forEach(function(row){conn.addQuery(arrQueries,"UPDATE outputs SET is_spent=0 WHERE unit=? AND message_index=? AND output_index=?",[row.src_unit,row.src_message_index,row.src_output_index])}),cb()})}function generateQueriesToUnspendHeadersCommissionOutputsSpentInArchivedUnit(conn,unit,arrQueries,cb){conn.query("SELECT headers_commission_outputs.address, headers_commission_outputs.main_chain_index \n\t\tFROM inputs \n\t\tCROSS JOIN headers_commission_outputs \n\t\t\tON inputs.from_main_chain_index <= +headers_commission_outputs.main_chain_index \n\t\t\tAND inputs.to_main_chain_index >= +headers_commission_outputs.main_chain_index \n\t\t\tAND inputs.address = headers_commission_outputs.address \n\t\tWHERE inputs.unit=? \n\t\t\tAND inputs.type='headers_commission' \n\t\t\tAND NOT EXISTS ( \n\t\t\t\tSELECT 1 FROM inputs AS alt_inputs \n\t\t\t\tWHERE headers_commission_outputs.main_chain_index >= alt_inputs.from_main_chain_index \n\t\t\t\t\tAND headers_commission_outputs.main_chain_index <= alt_inputs.to_main_chain_index \n\t\t\t\t\tAND inputs.address=alt_inputs.address \n\t\t\t\t\tAND alt_inputs.type='headers_commission' \n\t\t\t\t\tAND inputs.unit!=alt_inputs.unit \n\t\t\t)",[unit],function(rows){rows.forEach(function(row){conn.addQuery(arrQueries,"UPDATE headers_commission_outputs SET is_spent=0 WHERE address=? AND main_chain_index=?",[row.address,row.main_chain_index])}),cb()})}function generateQueriesToUnspendWitnessingOutputsSpentInArchivedUnit(conn,unit,arrQueries,cb){conn.query("SELECT witnessing_outputs.address, witnessing_outputs.main_chain_index \n\t\tFROM inputs \n\t\tCROSS JOIN witnessing_outputs \n\t\t\tON inputs.from_main_chain_index <= +witnessing_outputs.main_chain_index \n\t\t\tAND inputs.to_main_chain_index >= +witnessing_outputs.main_chain_index \n\t\t\tAND inputs.address = witnessing_outputs.address \n\t\tWHERE inputs.unit=? \n\t\t\tAND inputs.type='witnessing' \n\t\t\tAND NOT EXISTS ( \n\t\t\t\tSELECT 1 FROM inputs AS alt_inputs \n\t\t\t\tWHERE witnessing_outputs.main_chain_index >= alt_inputs.from_main_chain_index \n\t\t\t\t\tAND witnessing_outputs.main_chain_index <= alt_inputs.to_main_chain_index \n\t\t\t\t\tAND inputs.address=alt_inputs.address \n\t\t\t\t\tAND alt_inputs.type='witnessing' \n\t\t\t\t\tAND inputs.unit!=alt_inputs.unit \n\t\t\t)",[unit],function(rows){rows.forEach(function(row){conn.addQuery(arrQueries,"UPDATE witnessing_outputs SET is_spent=0 WHERE address=? AND main_chain_index=?",[row.address,row.main_chain_index])}),cb()})}function archiveJointAndDescendantsIfExists(from_unit){console.log("will archive if exists from unit "+from_unit),db.query("SELECT 1 FROM units WHERE unit=?",[from_unit],function(rows){rows.length>0&&archiveJointAndDescendants(from_unit)})}function archiveJointAndDescendants(from_unit){db.executeInTransaction(function(conn,cb){function addChildren(arrParentUnits){conn.query("SELECT DISTINCT child_unit FROM parenthoods WHERE parent_unit IN(?)",[arrParentUnits],function(rows){if(0===rows.length)return archive();var arrChildUnits=rows.map(function(row){return row.child_unit});arrUnits=arrUnits.concat(arrChildUnits),addChildren(arrChildUnits)})}function archive(){arrUnits=_.uniq(arrUnits),arrUnits.reverse(),console.log("will archive",arrUnits);var arrQueries=[];async.eachSeries(arrUnits,function(unit,cb2){readJoint(conn,unit,{ifNotFound:function(){throw Error("unit to be archived not found: "+unit)},ifFound:function(objJoint){generateQueriesToArchiveJoint(conn,objJoint,"uncovered",arrQueries,cb2)}})},function(){conn.addQuery(arrQueries,"DELETE FROM known_bad_joints"),console.log("will execute "+arrQueries.length+" queries to archive"),async.series(arrQueries,function(){arrUnits.forEach(forgetUnit),cb()})})}console.log("will archive from unit "+from_unit);var arrUnits=[from_unit];addChildren([from_unit])},function(){console.log("done archiving from unit "+from_unit)})}function readAssetInfo(conn,asset,handleAssetInfo){var objAsset=assocCachedAssetInfos[asset];return objAsset?handleAssetInfo(objAsset):void conn.query("SELECT assets.*, main_chain_index, sequence, is_stable, address AS definer_address, unit AS asset \n\t\tFROM assets JOIN units USING(unit) JOIN unit_authors USING(unit) WHERE unit=?",[asset],function(rows){if(rows.length>1)throw Error("more than one asset?");if(0===rows.length)return handleAssetInfo(null);var objAsset=rows[0];objAsset.issue_condition&&(objAsset.issue_condition=JSON.parse(objAsset.issue_condition)),objAsset.transfer_condition&&(objAsset.transfer_condition=JSON.parse(objAsset.transfer_condition)),objAsset.is_stable&&(assocCachedAssetInfos[asset]=objAsset),handleAssetInfo(objAsset)})}function readAsset(conn,asset,last_ball_mci,handleAsset){if(null===last_ball_mci){if(!conf.bLight)return readLastStableMcIndex(conn,function(last_stable_mci){readAsset(conn,asset,last_stable_mci,handleAsset)});last_ball_mci=MAX_INT32}readAssetInfo(conn,asset,function(objAsset){return objAsset?objAsset.main_chain_index>last_ball_mci?handleAsset("asset definition must be before last ball"):"good"!==objAsset.sequence?handleAsset("asset definition is not serial"):objAsset.spender_attested?void conn.query("SELECT MAX(level) AS max_level FROM asset_attestors CROSS JOIN units USING(unit) \n\t\t\tWHERE asset=? AND main_chain_index<=? AND is_stable=1 AND sequence='good'",[asset,last_ball_mci],function(latest_rows){var max_level=latest_rows[0].max_level;if(!max_level)throw Error("no max level of asset attestors");conn.query("SELECT attestor_address FROM asset_attestors CROSS JOIN units USING(unit) \n\t\t\t\t\tWHERE asset=? AND level=? AND main_chain_index<=? AND is_stable=1 AND sequence='good'",[asset,max_level,last_ball_mci],function(att_rows){if(0===att_rows.length)throw Error("no attestors?");objAsset.arrAttestorAddresses=att_rows.map(function(att_row){return att_row.attestor_address}),handleAsset(null,objAsset)})}):handleAsset(null,objAsset):handleAsset("asset "+asset+" not found")})}function filterAttestedAddresses(conn,objAsset,last_ball_mci,arrAuthorAddresses,handleAttestedAddresses){conn.query("SELECT DISTINCT address FROM attestations CROSS JOIN units USING(unit) \n\t\tWHERE attestor_address IN(?) AND address IN(?) AND main_chain_index<=? AND is_stable=1 AND sequence='good'",[objAsset.arrAttestorAddresses,arrAuthorAddresses,last_ball_mci],function(addr_rows){var arrAttestedAddresses=addr_rows.map(function(addr_row){return addr_row.address});handleAttestedAddresses(arrAttestedAddresses)})}function loadAssetWithListOfAttestedAuthors(conn,asset,last_ball_mci,arrAuthorAddresses,handleAsset){readAsset(conn,asset,last_ball_mci,function(err,objAsset){return err?handleAsset(err):objAsset.spender_attested?void filterAttestedAddresses(conn,objAsset,last_ball_mci,arrAuthorAddresses,function(arrAttestedAddresses){objAsset.arrAttestedAddresses=arrAttestedAddresses,handleAsset(null,objAsset)}):handleAsset(null,objAsset)})}function findWitnessListUnit(conn,arrWitnesses,last_ball_mci,handleWitnessListUnit){conn.query("SELECT witness_list_hashes.witness_list_unit \n\t\tFROM witness_list_hashes CROSS JOIN units ON witness_list_hashes.witness_list_unit=unit \n\t\tWHERE witness_list_hash=? AND sequence='good' AND is_stable=1 AND main_chain_index<=?",[objectHash.getBase64Hash(arrWitnesses),last_ball_mci],function(rows){handleWitnessListUnit(0===rows.length?null:rows[0].witness_list_unit)})}function sliceAndExecuteQuery(query,params,largeParam,callback){if("object"!=typeof largeParam||0===largeParam.length)return callback([]);for(var newParams,CHUNK_SIZE=200,length=largeParam.length,arrParams=[],largeParamPosition=params.indexOf(largeParam),offset=0;offset<length;offset+=CHUNK_SIZE)newParams=params.slice(0),newParams[largeParamPosition]=largeParam.slice(offset,offset+CHUNK_SIZE),arrParams.push(newParams);var result=[];async.eachSeries(arrParams,function(params,cb){db.query(query,params,function(rows){result=result.concat(rows),cb()})},function(){callback(result)})}function filterNewOrUnstableUnits(arrUnits,handleFilteredUnits){sliceAndExecuteQuery("SELECT unit FROM units WHERE unit IN(?) AND is_stable=1",[arrUnits],arrUnits,function(rows){var arrKnownStableUnits=rows.map(function(row){return row.unit}),arrNewOrUnstableUnits=_.difference(arrUnits,arrKnownStableUnits);handleFilteredUnits(arrNewOrUnstableUnits)})}function determineBestParent(conn,objUnit,arrWitnesses,handleBestParent){conn.query("SELECT unit \n\t\tFROM units AS parent_units \n\t\tWHERE unit IN(?) \n\t\t\tAND (witness_list_unit=? OR ( \n\t\t\t\tSELECT COUNT(*) \n\t\t\t\tFROM unit_witnesses AS parent_witnesses \n\t\t\t\tWHERE parent_witnesses.unit IN(parent_units.unit, parent_units.witness_list_unit) AND address IN(?) \n\t\t\t)>=?) \n\t\tORDER BY witnessed_level DESC, \n\t\t\tlevel-witnessed_level ASC, \n\t\t\tunit ASC \n\t\tLIMIT 1",[objUnit.parent_units,objUnit.witness_list_unit,arrWitnesses,constants.COUNT_WITNESSES-constants.MAX_WITNESS_LIST_MUTATIONS],function(rows){if(1!==rows.length)return handleBestParent(null);var best_parent_unit=rows[0].unit;handleBestParent(best_parent_unit)})}function determineIfHasWitnessListMutationsAlongMc(conn,objUnit,last_ball_unit,arrWitnesses,handleResult){return objUnit.parent_units?void buildListOfMcUnitsWithPotentiallyDifferentWitnesslists(conn,objUnit,last_ball_unit,arrWitnesses,function(bHasBestParent,arrMcUnits){return bHasBestParent?(console.log("###### MC units ",arrMcUnits),0===arrMcUnits.length?handleResult():void conn.query("SELECT units.unit, COUNT(*) AS count_matching_witnesses \n\t\t\tFROM units CROSS JOIN unit_witnesses ON (units.unit=unit_witnesses.unit OR units.witness_list_unit=unit_witnesses.unit) AND address IN(?) \n\t\t\tWHERE units.unit IN(?) \n\t\t\tGROUP BY units.unit \n\t\t\tHAVING count_matching_witnesses<?",[arrWitnesses,arrMcUnits,constants.COUNT_WITNESSES-constants.MAX_WITNESS_LIST_MUTATIONS],function(rows){return console.log(rows),rows.length>0?handleResult("too many ("+(constants.COUNT_WITNESSES-rows[0].count_matching_witnesses)+") witness list mutations relative to MC unit "+rows[0].unit):void handleResult()})):handleResult("no compatible best parent")}):handleResult()}function buildListOfMcUnitsWithPotentiallyDifferentWitnesslists(conn,objUnit,last_ball_unit,arrWitnesses,handleList){function addAndGoUp(unit){readStaticUnitProps(conn,unit,function(props){if(objUnit.witness_list_unit&&objUnit.witness_list_unit===props.witness_list_unit)return handleList(!0,arrMcUnits);if(arrMcUnits.push(unit),unit===last_ball_unit)return handleList(!0,arrMcUnits);if(!props.best_parent_unit)throw Error("no best parent of unit "+unit+"?");addAndGoUp(props.best_parent_unit)})}var arrMcUnits=[];determineBestParent(conn,objUnit,arrWitnesses,function(best_parent_unit){return best_parent_unit?void addAndGoUp(best_parent_unit):handleList(!1)})}function readStaticUnitProps(conn,unit,handleProps){var props=assocCachedUnits[unit];return props?handleProps(props):void conn.query("SELECT level, witnessed_level, best_parent_unit, witness_list_unit FROM units WHERE unit=?",[unit],function(rows){if(1!==rows.length)throw Error("not 1 unit");props=rows[0],assocCachedUnits[unit]=props,handleProps(props)})}function readUnitAuthors(conn,unit,handleAuthors){var arrAuthors=assocCachedUnitAuthors[unit];return arrAuthors?handleAuthors(arrAuthors):void conn.query("SELECT address FROM unit_authors WHERE unit=?",[unit],function(rows){if(0===rows.length)throw Error("no authors");var arrAuthors2=rows.map(function(row){return row.address}).sort();assocCachedUnitAuthors[unit]=arrAuthors2,handleAuthors(arrAuthors2)})}function isKnownUnit(unit){return!(!assocCachedUnits[unit]&&!assocKnownUnits[unit])}function setUnitIsKnown(unit){return assocKnownUnits[unit]=!0}function forgetUnit(unit){delete assocKnownUnits[unit],delete assocCachedUnits[unit],delete assocCachedUnitAuthors[unit],delete assocCachedUnitWitnesses[unit]}function shrinkCache(){Object.keys(assocCachedAssetInfos).length>MAX_ITEMS_IN_CACHE&&(assocCachedAssetInfos={});var arrKnownUnits=Object.keys(assocKnownUnits),arrPropsUnits=Object.keys(assocCachedUnits),arrAuthorsUnits=Object.keys(assocCachedUnitAuthors),arrWitnessesUnits=Object.keys(assocCachedUnitWitnesses);if(arrPropsUnits.length<MAX_ITEMS_IN_CACHE&&arrAuthorsUnits.length<MAX_ITEMS_IN_CACHE&&arrWitnessesUnits.length<MAX_ITEMS_IN_CACHE&&arrKnownUnits.length<MAX_ITEMS_IN_CACHE)return console.log("cache is small, will not shrink");var arrUnits=_.union(arrPropsUnits,arrAuthorsUnits,arrWitnessesUnits,arrKnownUnits);console.log("will shrink cache, total units: "+arrUnits.length),readLastStableMcIndex(db,function(last_stable_mci){for(var CHUNK_SIZE=500,offset=0;offset<arrUnits.length;offset+=CHUNK_SIZE)db.query("SELECT unit FROM units WHERE unit IN(?) AND main_chain_index<? AND main_chain_index!=0",[arrUnits.slice(offset,offset+CHUNK_SIZE),last_stable_mci-100],function(rows){console.log("will remove "+rows.length+" units from cache"),rows.forEach(function(row){delete assocKnownUnits[row.unit],delete assocCachedUnits[row.unit],delete assocCachedUnitAuthors[row.unit],delete assocCachedUnitWitnesses[row.unit]})})})}var async=require("async"),_=require("lodash"),db=require("./db.js"),conf=require("./conf.js"),objectHash=require("./object_hash.js"),constants=require("./constants.js"),MAX_INT32=(require("./mutex.js"),require("./profiler.js"),Math.pow(2,31)-1),genesis_ball=objectHash.getBallHash(constants.GENESIS_UNIT),MAX_ITEMS_IN_CACHE=300,assocKnownUnits={},assocCachedUnits={},assocCachedUnitAuthors={},assocCachedUnitWitnesses={},assocCachedAssetInfos={},min_retrievable_mci=null;initializeMinRetrievableMci(),setInterval(shrinkCache,3e5),conf.bLight||archiveJointAndDescendantsIfExists("N6QadI9yg3zLxPMphfNGJcPfddW4yHPkoGMbbGZsWa0="),exports.isGenesisUnit=isGenesisUnit,exports.isGenesisBall=isGenesisBall,exports.readWitnesses=readWitnesses,exports.readWitnessList=readWitnessList,exports.findWitnessListUnit=findWitnessListUnit,exports.determineIfWitnessAddressDefinitionsHaveReferences=determineIfWitnessAddressDefinitionsHaveReferences,exports.readUnitProps=readUnitProps,exports.readPropsOfUnits=readPropsOfUnits,exports.readJoint=readJoint,exports.readJointWithBall=readJointWithBall,exports.readFreeJoints=readFreeJoints,exports.readDefinitionByAddress=readDefinitionByAddress,exports.readDefinition=readDefinition,exports.readLastMainChainIndex=readLastMainChainIndex,exports.readLastStableMcUnitProps=readLastStableMcUnitProps,exports.readLastStableMcIndex=readLastStableMcIndex,exports.findLastBallMciOfMci=findLastBallMciOfMci,exports.getMinRetrievableMci=getMinRetrievableMci,exports.updateMinRetrievableMciAfterStabilizingMci=updateMinRetrievableMciAfterStabilizingMci,exports.generateQueriesToArchiveJoint=generateQueriesToArchiveJoint,exports.readAsset=readAsset,exports.loadAssetWithListOfAttestedAuthors=loadAssetWithListOfAttestedAuthors,exports.filterNewOrUnstableUnits=filterNewOrUnstableUnits,exports.determineBestParent=determineBestParent,exports.determineIfHasWitnessListMutationsAlongMc=determineIfHasWitnessListMutationsAlongMc,exports.readStaticUnitProps=readStaticUnitProps,exports.readUnitAuthors=readUnitAuthors,exports.isKnownUnit=isKnownUnit,exports.setUnitIsKnown=setUnitIsKnown,exports.forgetUnit=forgetUnit,exports.sliceAndExecuteQuery=sliceAndExecuteQuery},{"./conf.js":370,"./constants.js":371,"./db.js":372,"./mutex.js":388,"./object_hash.js":392,"./profiler.js":398,async:26,lodash:271}],403:[function(require,module,exports){"use strict";function parseUri(uri,callbacks){var objRequest={};if(32==uri.length){var address=uri;return ValidationUtils.isValidAddress(address)?(objRequest.type="address",objRequest.address=address,callbacks.ifOk(objRequest)):callbacks.ifError("address "+address+" is invalid")}var protocol=conf.program||"trustnote",re=new RegExp("^"+protocol+":(.+)$","i"),arrMatches=uri.match(re);if(!arrMatches)return callbacks.ifError("no "+protocol+" prefix");var value=arrMatches[1],arrPairingMatches=value,flag=/^\{.*\}$/.test(arrPairingMatches);if(flag){var toObj=JSON.parse(arrPairingMatches);return"h2"!=toObj.type?callbacks.ifError("no "+protocol+" prefix"):(objRequest.type="ob_walletToPay",objRequest.text_to_sign=toObj.sign,objRequest.path=toObj.path,objRequest.to_address=toObj.addr,objRequest.amount=toObj.amount,objRequest.v=toObj.v,callbacks.ifOk(objRequest))}var arrPairingMatches=value.replace("%23","#").match(/^([\w\/+]{44})@([\w.:\/-]+)#([\w\/+-]+)$/);if(arrPairingMatches)return objRequest.type="pairing",objRequest.pubkey=arrPairingMatches[1],objRequest.hub=arrPairingMatches[2],objRequest.pairing_secret=arrPairingMatches[3],callbacks.ifOk(objRequest);var arrAuthMatches=value.match(/^auth\?(.+)$/);if(arrAuthMatches){objRequest.type="auth";var query_string=arrAuthMatches[1],assocParams=parseQueryString(query_string);if(assocParams.url){if(!assocParams.url.match(/^https?:\/\//))return callbacks.ifError("invalid url")}else{if(!assocParams.device)return callbacks.ifError("neither url nor device in auth params");if(!assocParams.pairing_secret)return callbacks.ifError("no pairing secret in auth params");if(!assocParams.app)return callbacks.ifError("no app in auth params");var arrParts=assocParams.device.split("@");if(2!==arrParts.length)return callbacks.ifError("not 2 parts in full device address");var pubkey=arrParts[0],hub=arrParts[1];if(pubkey.length!==constants.PUBKEY_LENGTH)return callbacks.ifError("pubkey length is not 44");if(hub.match(/[^\w\.:-]/))return callbacks.ifError("invalid hub address")}return objRequest.params=assocParams,callbacks.ifOk(objRequest)}var arrParts=value.split("?");if(arrParts.length>2)return callbacks.ifError("too many question marks");var address=arrParts[0],query_string=arrParts[1];if(!ValidationUtils.isValidAddress(address))return callbacks.ifError("address "+address+" is invalid");if(objRequest.type="address",objRequest.address=address,query_string){var assocParams=parseQueryString(query_string),strAmount=assocParams.amount;if("string"==typeof strAmount){var amount=parseInt(strAmount);if(amount+""!==strAmount)return callbacks.ifError("invalid amount: "+strAmount);if(!ValidationUtils.isPositiveInteger(amount))return callbacks.ifError("nonpositive amount: "+strAmount);objRequest.amount=amount}var asset=assocParams.asset;if("string"==typeof asset){if("base"!==asset&&!ValidationUtils.isValidBase64(asset,constants.HASH_LENGTH))return callbacks.ifError("invalid asset: "+asset);objRequest.asset=asset}!objRequest.asset&&objRequest.amount&&(objRequest.asset="base");var device_address=assocParams.device_address;if(device_address){if(!ValidationUtils.isValidDeviceAddress(device_address))return callbacks.ifError("invalid device address: "+device_address);objRequest.device_address=device_address}}callbacks.ifOk(objRequest)}function parseQueryString(str,delimiter){delimiter||(delimiter="&");var arrPairs=str.split(delimiter),assocParams={};return arrPairs.forEach(function(pair){var arrNameValue=pair.split("=");if(2===arrNameValue.length){var name=decodeURIComponent(arrNameValue[0]),value=decodeURIComponent(arrNameValue[1]);assocParams[name]=value}}),assocParams}var ValidationUtils=require("./validation_utils.js"),constants=require("./constants.js"),conf=require("./conf.js");exports.parseQueryString=parseQueryString,exports.parseUri=parseUri},{"./conf.js":370,"./constants.js":371,"./validation_utils.js":405}],404:[function(require,module,exports){"use strict";function hasValidHashes(objJoint){var objUnit=objJoint.unit;return objectHash.getUnitHash(objUnit)===objUnit.unit}function validate(objJoint,callbacks){var objUnit=objJoint.unit;if("object"!=typeof objUnit||null===objUnit)throw Error("no unit object");if(!objUnit.unit)throw Error("no unit");if(console.log("\nvalidating joint identified by unit "+objJoint.unit.unit),!isStringOfLength(objUnit.unit,constants.HASH_LENGTH))return callbacks.ifJointError("wrong unit length");try{if(objectHash.getUnitHash(objUnit)!==objUnit.unit)return callbacks.ifJointError("wrong unit hash: "+objectHash.getUnitHash(objUnit)+" != "+objUnit.unit)}catch(e){return callbacks.ifJointError("failed to calc unit hash: "+e)}if(objJoint.unsigned){if(hasFieldsExcept(objJoint,["unit","unsigned"]))return callbacks.ifJointError("unknown fields in unsigned unit-joint")}else if("ball"in objJoint){if(!isStringOfLength(objJoint.ball,constants.HASH_LENGTH))return callbacks.ifJointError("wrong ball length");if(hasFieldsExcept(objJoint,["unit","ball","skiplist_units"]))return callbacks.ifJointError("unknown fields in ball-joint");if("skiplist_units"in objJoint&&!isNonemptyArray(objJoint.skiplist_units))return callbacks.ifJointError("missing or empty skiplist array")}else if(hasFieldsExcept(objJoint,["unit"]))return callbacks.ifJointError("unknown fields in unit-joint");if("content_hash"in objUnit){if(!isStringOfLength(objUnit.content_hash,constants.HASH_LENGTH))return callbacks.ifUnitError("wrong content_hash length");if(hasFieldsExcept(objUnit,["unit","version","alt","timestamp","authors","witness_list_unit","witnesses","content_hash","parent_units","last_ball","last_ball_unit"]))return callbacks.ifUnitError("unknown fields in nonserial unit");if(!objJoint.ball)return callbacks.ifJointError("content_hash allowed only in finished ball")}else{if(hasFieldsExcept(objUnit,["unit","version","alt","timestamp","authors","messages","witness_list_unit","witnesses","earned_headers_commission_recipients","last_ball","last_ball_unit","parent_units","headers_commission","payload_commission"]))return callbacks.ifUnitError("unknown fields in unit");if("number"!=typeof objUnit.headers_commission)return callbacks.ifJointError("no headers_commission");if("number"!=typeof objUnit.payload_commission)return callbacks.ifJointError("no payload_commission");if(!isNonemptyArray(objUnit.messages))return callbacks.ifUnitError("missing or empty messages array");if(objUnit.messages.length>constants.MAX_MESSAGES_PER_UNIT)return callbacks.ifUnitError("too many messages");if(objectLength.getHeadersSize(objUnit)!==objUnit.headers_commission)return callbacks.ifJointError("wrong headers commission, expected "+objectLength.getHeadersSize(objUnit));if(objectLength.getTotalPayloadSize(objUnit)!==objUnit.payload_commission)return callbacks.ifJointError("wrong payload commission, unit "+objUnit.unit+", calculated "+objectLength.getTotalPayloadSize(objUnit)+", expected "+objUnit.payload_commission)}if(!isNonemptyArray(objUnit.authors))return callbacks.ifUnitError("missing or empty authors array");if(objUnit.version!==constants.version)return callbacks.ifUnitError("wrong version");if(objUnit.alt!==constants.alt)return callbacks.ifUnitError("wrong alt");if(!storage.isGenesisUnit(objUnit.unit)){if(!isNonemptyArray(objUnit.parent_units))return callbacks.ifUnitError("missing or empty parent units array");if(!isStringOfLength(objUnit.last_ball,constants.HASH_LENGTH))return callbacks.ifUnitError("wrong length of last ball");if(!isStringOfLength(objUnit.last_ball_unit,constants.HASH_LENGTH))return callbacks.ifUnitError("wrong length of last ball unit")}if("witness_list_unit"in objUnit&&"witnesses"in objUnit)return callbacks.ifUnitError("ambiguous witnesses");var arrAuthorAddresses=objUnit.authors?objUnit.authors.map(function(author){return author.address}):[],objValidationState={arrAdditionalQueries:[],arrDoubleSpendInputs:[],arrInputKeys:[]};return objJoint.unsigned&&(objValidationState.bUnsigned=!0),conf.bLight?isPositiveInteger(objUnit.timestamp)||objJoint.unsigned?objJoint.ball?callbacks.ifJointError("I'm light, can't accept stable unit "+objUnit.unit+" without proof"):objJoint.unsigned?callbacks.ifOkUnsigned(!0):callbacks.ifOk({sequence:"good",arrDoubleSpendInputs:[],arrAdditionalQueries:[]},function(){}):callbacks.ifJointError("bad timestamp"):"timestamp"in objUnit&&!isPositiveInteger(objUnit.timestamp)?callbacks.ifJointError("bad timestamp"):void mutex.lock(arrAuthorAddresses,function(unlock){var conn=null;async.series([function(cb){db.takeConnectionFromPool(function(new_conn){conn=new_conn,conn.query("BEGIN",function(){cb()})})},function(cb){profiler.start(),checkDuplicate(conn,objUnit.unit,cb)},function(cb){profiler.stop("validation-checkDuplicate"),profiler.start(),objUnit.content_hash?cb():validateHeadersCommissionRecipients(objUnit,cb)},function(cb){profiler.stop("validation-hc-recipients"),profiler.start(),objUnit.parent_units?validateHashTree(conn,objJoint,objValidationState,cb):cb()},function(cb){profiler.stop("validation-hash-tree"),profiler.start(),objUnit.parent_units?validateParents(conn,objJoint,objValidationState,cb):cb()},function(cb){profiler.stop("validation-parents"),profiler.start(),objJoint.skiplist_units?validateSkiplist(conn,objJoint.skiplist_units,cb):cb()},function(cb){profiler.stop("validation-skiplist"),validateWitnesses(conn,objUnit,objValidationState,cb)},function(cb){profiler.start(),validateAuthors(conn,objUnit.authors,objUnit,objValidationState,cb)},function(cb){profiler.stop("validation-authors"),profiler.start(),objUnit.content_hash?cb():validateMessages(conn,objUnit.messages,objUnit,objValidationState,cb)}],function(err){profiler.stop("validation-messages"),err?conn.query("ROLLBACK",function(){if(conn.release(),unlock(),"object"==typeof err)if("unresolved_dependency"===err.error_code)callbacks.ifNeedParentUnits(err.arrMissingUnits);else if("need_hash_tree"===err.error_code)callbacks.ifNeedHashTree();else if("invalid_joint"===err.error_code)callbacks.ifJointError(err.message);else{if("transient"!==err.error_code)throw Error("unknown error code");callbacks.ifTransientError(err.message)}else callbacks.ifUnitError(err)}):(profiler.start(),conn.query("COMMIT",function(){conn.release(),profiler.stop("validation-commit"),objJoint.unsigned?(unlock(),callbacks.ifOkUnsigned("good"===objValidationState.sequence)):callbacks.ifOk(objValidationState,unlock)}))})})}function checkDuplicate(conn,unit,cb){conn.query("SELECT 1 FROM units WHERE unit=?",[unit],function(rows){return 0===rows.length?cb():void cb("unit "+unit+" already exists")})}function validateHashTree(conn,objJoint,objValidationState,callback){if(!objJoint.ball)return callback();var objUnit=objJoint.unit;conn.query("SELECT unit FROM hash_tree_balls WHERE ball=?",[objJoint.ball],function(rows){return 0===rows.length?callback({error_code:"need_hash_tree",message:"ball "+objJoint.ball+" is not known in hash tree"}):rows[0].unit!==objUnit.unit?callback(createJointError("ball "+objJoint.ball+" unit "+objUnit.unit+" contradicts hash tree")):void conn.query("SELECT ball FROM hash_tree_balls WHERE unit IN(?) \n\t\t\tUNION \n\t\t\tSELECT ball FROM balls WHERE unit IN(?) \n\t\t\tORDER BY ball",[objUnit.parent_units,objUnit.parent_units],function(prows){function validateBallHash(){var hash=objectHash.getBallHash(objUnit.unit,arrParentBalls,objValidationState.arrSkiplistBalls,!!objUnit.content_hash);return hash!==objJoint.ball?callback(createJointError("ball hash is wrong")):void callback()}if(prows.length!==objUnit.parent_units.length)return callback(createJointError("some parents not found in balls nor in hash tree"));var arrParentBalls=prows.map(function(prow){return prow.ball});return objJoint.skiplist_units?void conn.query("SELECT ball FROM hash_tree_balls WHERE unit IN(?) \n\t\t\t\t\tUNION \n\t\t\t\t\tSELECT ball FROM balls WHERE unit IN(?) \n\t\t\t\t\tORDER BY ball",[objJoint.skiplist_units,objJoint.skiplist_units],function(srows){return srows.length!==objJoint.skiplist_units.length?callback(createJointError("some skiplist balls not found")):(objValidationState.arrSkiplistBalls=srows.map(function(srow){
return srow.ball}),void validateBallHash())}):validateBallHash()})})}function validateSkiplist(conn,arrSkiplistUnits,callback){var prev="";async.eachSeries(arrSkiplistUnits,function(skiplist_unit,cb){return skiplist_unit<=prev?cb(createJointError("skiplist units not ordered")):void conn.query("SELECT unit, is_stable, is_on_main_chain, main_chain_index FROM units WHERE unit=?",[skiplist_unit],function(rows){if(0===rows.length)return cb("skiplist unit "+skiplist_unit+" not found");var objSkiplistUnitProps=rows[0];if(1===objSkiplistUnitProps.is_stable){if(1!==objSkiplistUnitProps.is_on_main_chain)return cb("skiplist unit "+skiplist_unit+" is not on MC");if(objSkiplistUnitProps.main_chain_index%10!==0)return cb("skiplist unit "+skiplist_unit+" MCI is not divisible by 10")}cb()})},callback)}function validateParents(conn,objJoint,objValidationState,callback){function checkNoSameAddressInDifferentParents(){return 1===objUnit.parent_units.length?checkLastBallDidNotRetreat():void conn.query("SELECT address, COUNT(*) AS c FROM unit_authors WHERE unit IN(?) GROUP BY address HAVING c>1",[objUnit.parent_units],function(rows){return rows.length>0?callback("some addresses found more than once in parents, e.g. "+rows[0].address):checkLastBallDidNotRetreat()})}function checkLastBallDidNotRetreat(){conn.query("SELECT MAX(lb_units.main_chain_index) AS max_parent_last_ball_mci \n\t\t\tFROM units JOIN units AS lb_units ON units.last_ball_unit=lb_units.unit \n\t\t\tWHERE units.unit IN(?)",[objUnit.parent_units],function(rows){var max_parent_last_ball_mci=rows[0].max_parent_last_ball_mci;return max_parent_last_ball_mci>objValidationState.last_ball_mci?callback("last ball mci must not retreat, parents: "+objUnit.parent_units.join(", ")):void callback()})}var objUnit=objJoint.unit;if(objUnit.parent_units.length>constants.MAX_PARENTS_PER_UNIT)return callback("too many parents: "+objUnit.parent_units.length);var createError=objJoint.ball?createJointError:function(err){return err},last_ball=objUnit.last_ball,last_ball_unit=objUnit.last_ball_unit,prev="",arrMissingParentUnits=[],arrPrevParentUnitProps=[];objValidationState.max_parent_limci=0;var join=objJoint.ball?"LEFT JOIN balls USING(unit) LEFT JOIN hash_tree_balls ON units.unit=hash_tree_balls.unit":"",field=objJoint.ball?", IFNULL(balls.ball, hash_tree_balls.ball) AS ball":"";async.eachSeries(objUnit.parent_units,function(parent_unit,cb){return parent_unit<=prev?cb(createError("parent units not ordered")):(prev=parent_unit,void conn.query("SELECT units.*"+field+" FROM units "+join+" WHERE units.unit=?",[parent_unit],function(rows){if(0===rows.length)return arrMissingParentUnits.push(parent_unit),cb();var objParentUnitProps=rows[0];if(objJoint.ball&&null===objParentUnitProps.ball)throw Error("no ball corresponding to parent unit "+parent_unit);objParentUnitProps.latest_included_mc_index>objValidationState.max_parent_limci&&(objValidationState.max_parent_limci=objParentUnitProps.latest_included_mc_index),async.eachSeries(arrPrevParentUnitProps,function(objPrevParentUnitProps,cb2){graph.compareUnitsByProps(conn,objPrevParentUnitProps,objParentUnitProps,function(result){null===result?cb2():cb2("parent unit "+parent_unit+" is related to one of the other parent units")})},function(err){return err?cb(err):(arrPrevParentUnitProps.push(objParentUnitProps),void cb())})}))},function(err){if(err)return callback(err);if(arrMissingParentUnits.length>0)return void conn.query("SELECT error FROM known_bad_joints WHERE unit IN(?)",[arrMissingParentUnits],function(rows){callback(rows.length>0?"some of the unit's parents are known bad: "+rows[0].error:{error_code:"unresolved_dependency",arrMissingUnits:arrMissingParentUnits})});if(objJoint.ball){var arrParentBalls=arrPrevParentUnitProps.map(function(objParentUnitProps){return objParentUnitProps.ball}).sort(),hash=objectHash.getBallHash(objUnit.unit,arrParentBalls,objValidationState.arrSkiplistBalls,!!objUnit.content_hash);if(hash!==objJoint.ball)throw Error("ball hash is wrong")}conn.query("SELECT is_stable, is_on_main_chain, main_chain_index, ball, (SELECT MAX(main_chain_index) FROM units) AS max_known_mci \n\t\t\t\tFROM units LEFT JOIN balls USING(unit) WHERE unit=?",[last_ball_unit],function(rows){if(1!==rows.length)return callback("last ball unit "+last_ball_unit+" not found");var objLastBallUnitProps=rows[0];if(null===objLastBallUnitProps.ball&&1===objLastBallUnitProps.is_stable)throw Error("last ball unit "+last_ball_unit+" is stable but has no ball");if(1!==objLastBallUnitProps.is_on_main_chain)return callback("last ball "+last_ball+" is not on MC");if(objLastBallUnitProps.ball&&objLastBallUnitProps.ball!==last_ball)return callback("last_ball "+last_ball+" and last_ball_unit "+last_ball_unit+" do not match");if(objValidationState.last_ball_mci=objLastBallUnitProps.main_chain_index,objValidationState.max_known_mci=objLastBallUnitProps.max_known_mci,objValidationState.max_parent_limci<objValidationState.last_ball_mci)return callback("last ball unit "+last_ball_unit+" is not included in parents, unit "+objUnit.unit);if(1===objLastBallUnitProps.is_stable){if(objLastBallUnitProps.ball!==last_ball)return callback("stable: last_ball "+last_ball+" and last_ball_unit "+last_ball_unit+" do not match");if(objValidationState.last_ball_mci<=8e5)return checkNoSameAddressInDifferentParents()}main_chain.determineIfStableInLaterUnitsAndUpdateStableMcFlag(conn,last_ball_unit,objUnit.parent_units,objLastBallUnitProps.is_stable,function(bStable){if(!bStable&&1===objLastBallUnitProps.is_stable){var eventBus=require("./event_bus.js");return eventBus.emit("nonfatal_error","last ball is stable, but not stable in parents, unit "+objUnit.unit,new Error),checkNoSameAddressInDifferentParents()}return bStable?void conn.query("SELECT ball FROM balls WHERE unit=?",[last_ball_unit],function(ball_rows){if(0===ball_rows.length)throw Error("last ball unit "+last_ball_unit+" just became stable but ball not found");return ball_rows[0].ball!==last_ball?callback("last_ball "+last_ball+" and last_ball_unit "+last_ball_unit+" do not match after advancing stability point"):void checkNoSameAddressInDifferentParents()}):callback(objUnit.unit+": last ball unit "+last_ball_unit+" is not stable in view of your parents "+objUnit.parent_units)})})})}function validateWitnesses(conn,objUnit,objValidationState,callback){function validateWitnessListMutations(arrWitnesses){return objUnit.parent_units?void storage.determineIfHasWitnessListMutationsAlongMc(conn,objUnit,last_ball_unit,arrWitnesses,function(err){return err&&objValidationState.last_ball_mci>=512e3?callback(err):void checkNoReferencesInWitnessAddressDefinitions(arrWitnesses)}):callback()}function checkNoReferencesInWitnessAddressDefinitions(arrWitnesses){profiler.start();var cross="sqlite"===conf.storage?"CROSS":"";conn.query("SELECT 1 \n\t\t\tFROM address_definition_changes \n\t\t\tJOIN definitions USING(definition_chash) \n\t\t\tJOIN units AS change_units USING(unit)   -- units where the change was declared \n\t\t\tJOIN unit_authors USING(definition_chash) \n\t\t\tJOIN units AS definition_units ON unit_authors.unit=definition_units.unit   -- units where the definition was disclosed \n\t\t\tWHERE address_definition_changes.address IN(?) AND has_references=1 \n\t\t\t\tAND change_units.is_stable=1 AND change_units.main_chain_index<=? AND +change_units.sequence='good' \n\t\t\t\tAND definition_units.is_stable=1 AND definition_units.main_chain_index<=? AND +definition_units.sequence='good' \n\t\t\tUNION \n\t\t\tSELECT 1 \n\t\t\tFROM definitions \n\t\t\t"+cross+" JOIN unit_authors USING(definition_chash) \n\t\t\tJOIN units AS definition_units ON unit_authors.unit=definition_units.unit   -- units where the definition was disclosed \n\t\t\tWHERE definition_chash IN(?) AND has_references=1 \n\t\t\t\tAND definition_units.is_stable=1 AND definition_units.main_chain_index<=? AND +definition_units.sequence='good' \n\t\t\tLIMIT 1",[arrWitnesses,objValidationState.last_ball_mci,objValidationState.last_ball_mci,arrWitnesses,objValidationState.last_ball_mci],function(rows){profiler.stop("validation-witnesses-no-refs"),rows.length>0?callback("some witnesses have references in their addresses"):callback()})}profiler.start();var last_ball_unit=objUnit.last_ball_unit;if("string"==typeof objUnit.witness_list_unit)conn.query("SELECT sequence, is_stable, main_chain_index FROM units WHERE unit=?",[objUnit.witness_list_unit],function(unit_rows){if(0===unit_rows.length)return callback("witness list unit "+objUnit.witness_list_unit+" not found");var objWitnessListUnitProps=unit_rows[0];return"good"!==objWitnessListUnitProps.sequence?callback("witness list unit "+objUnit.witness_list_unit+" is not serial"):1!==objWitnessListUnitProps.is_stable?callback("witness list unit "+objUnit.witness_list_unit+" is not stable"):objWitnessListUnitProps.main_chain_index>objValidationState.last_ball_mci?callback("witness list unit "+objUnit.witness_list_unit+" must come before last ball"):void conn.query("SELECT address FROM unit_witnesses WHERE unit=? ORDER BY address",[objUnit.witness_list_unit],function(rows){if(0===rows.length)return callback("referenced witness list unit "+objUnit.witness_list_unit+" has no witnesses");var arrWitnesses=rows.map(function(row){return row.address});if(arrWitnesses.length!==constants.COUNT_WITNESSES)throw Error("wrong number of witnesses: "+arrWitnesses.length);profiler.stop("validation-witnesses-read-list"),validateWitnessListMutations(arrWitnesses)})});else{if(!Array.isArray(objUnit.witnesses)||objUnit.witnesses.length!==constants.COUNT_WITNESSES)return callback("no witnesses or not enough witnesses");for(var prev_witness=objUnit.witnesses[0],i=0;i<objUnit.witnesses.length;i++){var curr_witness=objUnit.witnesses[i];if(!chash.isChashValid(curr_witness))return cb("witness address "+curr_witness+" is invalid");if(0!==i){if(curr_witness<=prev_witness)return callback("wrong order of witnesses, or duplicates");prev_witness=curr_witness}}if(storage.isGenesisUnit(objUnit.unit))return void validateWitnessListMutations(objUnit.witnesses);conn.query("SELECT COUNT(DISTINCT address) AS count_stable_good_witnesses FROM unit_authors JOIN units USING(unit) \n\t\t\tWHERE address=definition_chash AND +sequence='good' AND is_stable=1 AND main_chain_index<=? AND address IN(?)",[objValidationState.last_ball_mci,objUnit.witnesses],function(rows){return rows[0].count_stable_good_witnesses!==constants.COUNT_WITNESSES?callback("some witnesses are not stable, not serial, or don't come before last ball"):(profiler.stop("validation-witnesses-stable"),void validateWitnessListMutations(objUnit.witnesses))})}}function validateHeadersCommissionRecipients(objUnit,cb){if(objUnit.authors.length>1&&"object"!=typeof objUnit.earned_headers_commission_recipients)return cb("must specify earned_headers_commission_recipients when more than 1 author");if("earned_headers_commission_recipients"in objUnit){if(!isNonemptyArray(objUnit.earned_headers_commission_recipients))return cb("empty earned_headers_commission_recipients array");for(var total_earned_headers_commission_share=0,prev_address="",i=0;i<objUnit.earned_headers_commission_recipients.length;i++){var recipient=objUnit.earned_headers_commission_recipients[i];if(!isPositiveInteger(recipient.earned_headers_commission_share))return cb("earned_headers_commission_share must be positive integer");if(hasFieldsExcept(recipient,["address","earned_headers_commission_share"]))return cb("unknowsn fields in recipient");if(recipient.address<=prev_address)return cb("recipient list must be sorted by address");if(!isValidAddress(recipient.address))return cb("invalid recipient address checksum");total_earned_headers_commission_share+=recipient.earned_headers_commission_share,prev_address=recipient.address}if(100!==total_earned_headers_commission_share)return cb("sum of earned_headers_commission_share is not 100")}cb()}function validateAuthors(conn,arrAuthors,objUnit,objValidationState,callback){if(arrAuthors.length>constants.MAX_AUTHORS_PER_UNIT)return callback("too many authors");objValidationState.arrAddressesWithForkedPath=[];for(var prev_address="",i=0;i<arrAuthors.length;i++){var objAuthor=arrAuthors[i];if(objAuthor.address<=prev_address)return callback("author addresses not sorted");prev_address=objAuthor.address}objValidationState.unit_hash_to_sign=objectHash.getUnitHashToSign(objUnit),async.eachSeries(arrAuthors,function(objAuthor,cb){validateAuthor(conn,objAuthor,objUnit,objValidationState,cb)},callback)}function validateAuthor(conn,objAuthor,objUnit,objValidationState,callback){function validateAuthentifiers(arrAddressDefinition){Definition.validateAuthentifiers(conn,objAuthor.address,null,arrAddressDefinition,objUnit,objValidationState,objAuthor.authentifiers,function(err,res){return err?callback(err):res?void checkSerialAddressUse():callback("authentifier verification failed")})}function findConflictingUnits(handleConflictingUnits){var cross=objValidationState.max_known_mci-objValidationState.max_parent_limci<1e3?"CROSS":"";conn.query("SELECT unit, is_stable \n\t\t\tFROM units \n\t\t\t"+cross+" JOIN unit_authors USING(unit) \n\t\t\tWHERE address=? AND (main_chain_index>? OR main_chain_index IS NULL) AND unit != ?",[objAuthor.address,objValidationState.max_parent_limci,objUnit.unit],function(rows){var arrConflictingUnitProps=[];async.eachSeries(rows,function(row,cb){graph.determineIfIncludedOrEqual(conn,row.unit,objUnit.parent_units,function(bIncluded){bIncluded||arrConflictingUnitProps.push(row),cb()})},function(){handleConflictingUnits(arrConflictingUnitProps)})})}function checkSerialAddressUse(){var next=checkNoPendingChangeOfDefinitionChash;findConflictingUnits(function(arrConflictingUnitProps){if(0===arrConflictingUnitProps.length)return objValidationState.sequence=objValidationState.sequence||"good",next();var arrConflictingUnits=arrConflictingUnitProps.map(function(objConflictingUnitProps){return objConflictingUnitProps.unit});breadcrumbs.add("========== found conflicting units "+arrConflictingUnits+" ========="),breadcrumbs.add("========== will accept a conflicting unit "+objUnit.unit+" ========="),objValidationState.arrAddressesWithForkedPath.push(objAuthor.address),objValidationState.arrConflictingUnits=(objValidationState.arrConflictingUnits||[]).concat(arrConflictingUnits),bNonserial=!0;var arrUnstableConflictingUnitProps=arrConflictingUnitProps.filter(function(objConflictingUnitProps){return 0===objConflictingUnitProps.is_stable}),bConflictsWithStableUnits=arrConflictingUnitProps.some(function(objConflictingUnitProps){return 1===objConflictingUnitProps.is_stable});"final-bad"!==objValidationState.sequence&&(objValidationState.sequence=bConflictsWithStableUnits?"final-bad":"temp-bad");var arrUnstableConflictingUnits=arrUnstableConflictingUnitProps.map(function(objConflictingUnitProps){return objConflictingUnitProps.unit});return bConflictsWithStableUnits?next():0===arrUnstableConflictingUnits.length?next():(objValidationState.arrAdditionalQueries.push({sql:"UPDATE units SET sequence='temp-bad' WHERE unit IN(?) AND +sequence='good'",params:[arrUnstableConflictingUnits]}),void next())})}function checkNoPendingChangeOfDefinitionChash(){var next=checkNoPendingDefinition;conn.query("SELECT unit FROM address_definition_changes JOIN units USING(unit) \n\t\t\tWHERE address=? AND (is_stable=0 OR main_chain_index>? OR main_chain_index IS NULL)",[objAuthor.address,objValidationState.last_ball_mci],function(rows){return 0===rows.length?next():bNonserial&&objValidationState.arrAddressesWithForkedPath.indexOf(objAuthor.address)!==-1?void async.eachSeries(rows,function(row,cb){graph.determineIfIncludedOrEqual(conn,row.unit,objUnit.parent_units,function(bIncluded){bIncluded&&console.log("checkNoPendingChangeOfDefinitionChash: unit "+row.unit+" is included"),bIncluded?cb("found"):cb()})},function(err){"found"===err?callback("you can't send anything before your last included keychange is stable and before last ball (self is nonserial)"):next()}):callback("you can't send anything before your last keychange is stable and before last ball")})}function checkNoPendingDefinition(){var next=validateDefinition,cross=objValidationState.max_known_mci-objValidationState.last_ball_mci<1e3?"CROSS":"";conn.query("SELECT unit FROM units "+cross+" JOIN unit_authors USING(unit) \n\t\t\tWHERE address=? AND definition_chash IS NOT NULL AND ( /* is_stable=0 OR */ main_chain_index>? OR main_chain_index IS NULL)",[objAuthor.address,objValidationState.last_ball_mci],function(rows){return 0===rows.length?next():bNonserial&&objValidationState.arrAddressesWithForkedPath.indexOf(objAuthor.address)!==-1?void async.eachSeries(rows,function(row,cb){graph.determineIfIncludedOrEqual(conn,row.unit,objUnit.parent_units,function(bIncluded){bIncluded&&console.log("checkNoPendingDefinition: unit "+row.unit+" is included"),bIncluded?cb("found"):cb()})},function(err){"found"===err?callback("you can't send anything before your last included definition is stable and before last ball (self is nonserial)"):next()}):callback("you can't send anything before your last definition is stable and before last ball")})}function validateDefinition(){if(!("definition"in objAuthor))return callback();var arrAddressDefinition=objAuthor.definition;storage.readDefinitionByAddress(conn,objAuthor.address,objValidationState.last_ball_mci,{ifDefinitionNotFound:function(definition_chash){return objectHash.getChash160(arrAddressDefinition)!==definition_chash?callback("wrong definition: "+objectHash.getChash160(arrAddressDefinition)+"!=="+definition_chash):void callback()},ifFound:function(arrAddressDefinition2){handleDuplicateAddressDefinition(arrAddressDefinition2)}})}function handleDuplicateAddressDefinition(arrAddressDefinition){return bNonserial&&objValidationState.arrAddressesWithForkedPath.indexOf(objAuthor.address)!==-1?objectHash.getChash160(arrAddressDefinition)!==objectHash.getChash160(objAuthor.definition)?callback("unit definition doesn't match the stored definition"):void callback():callback("duplicate definition of address "+objAuthor.address+", bNonserial="+bNonserial)}if(!isStringOfLength(objAuthor.address,32))return callback("wrong address length");if(hasFieldsExcept(objAuthor,["address","authentifiers","definition"]))return callback("unknown fields in author");if(!ValidationUtils.isNonemptyObject(objAuthor.authentifiers)&&!objUnit.content_hash)return callback("no authentifiers");for(var path in objAuthor.authentifiers){if(!isNonemptyString(objAuthor.authentifiers[path]))return callback("authentifiers must be nonempty strings");if(objAuthor.authentifiers[path].length>constants.MAX_AUTHENTIFIER_LENGTH)return callback("authentifier too long")}var bNonserial=!1,arrAddressDefinition=objAuthor.definition;if(isNonemptyArray(arrAddressDefinition))validateAuthentifiers(arrAddressDefinition);else{if("definition"in objAuthor)return callback("bad type of definition");if(!chash.isChashValid(objAuthor.address))return callback("address checksum invalid");if(objUnit.content_hash)return objValidationState.sequence="final-bad",callback();storage.readDefinitionByAddress(conn,objAuthor.address,objValidationState.last_ball_mci,{ifDefinitionNotFound:function(definition_chash){callback("definition "+definition_chash+" bound to address "+objAuthor.address+" is not defined")},ifFound:function(arrAddressDefinition){validateAuthentifiers(arrAddressDefinition)}})}}function validateMessages(conn,arrMessages,objUnit,objValidationState,callback){console.log("validateMessages "+objUnit.unit),async.forEachOfSeries(arrMessages,function(objMessage,message_index,cb){validateMessage(conn,objMessage,message_index,objUnit,objValidationState,cb)},function(err){return err?callback(err):objValidationState.bHasBasePayment?void callback():callback("no base payment message")})}function validateMessage(conn,objMessage,message_index,objUnit,objValidationState,callback){function validatePayload(cb){if("inline"===objMessage.payload_location)validateInlinePayload(conn,objMessage,message_index,objUnit,objValidationState,cb);else{if(!isValidBase64(objMessage.payload_hash,constants.HASH_LENGTH))return cb("wrong payload hash");cb()}}function validateSpendProofs(cb){if(!("spend_proofs"in objMessage))return cb();var arrEqs=objMessage.spend_proofs.map(function(objSpendProof){return"spend_proof="+conn.escape(objSpendProof.spend_proof)+" AND address="+conn.escape(objSpendProof.address?objSpendProof.address:objUnit.authors[0].address)});checkForDoublespends(conn,"spend proof","SELECT address, unit, main_chain_index, sequence FROM spend_proofs JOIN units USING(unit) WHERE unit != ? AND ("+arrEqs.join(" OR ")+")",[objUnit.unit],objUnit,objValidationState,function(cb2){cb2()},cb)}if("string"!=typeof objMessage.app)return callback("no app");if(!isStringOfLength(objMessage.payload_hash,constants.HASH_LENGTH))return callback("wrong payload hash size");if("string"!=typeof objMessage.payload_location)return callback("no payload_location");if(hasFieldsExcept(objMessage,["app","payload_hash","payload_location","payload","payload_uri","payload_uri_hash","spend_proofs"]))return callback("unknown fields in message");if("spend_proofs"in objMessage){if(!Array.isArray(objMessage.spend_proofs)||0===objMessage.spend_proofs.length||objMessage.spend_proofs.length>constants.MAX_SPEND_PROOFS_PER_MESSAGE)return callback("spend_proofs must be non-empty array max "+constants.MAX_SPEND_PROOFS_PER_MESSAGE+" elements");for(var arrAuthorAddresses=objUnit.authors.map(function(author){return author.address}),i=0;i<objMessage.spend_proofs.length;i++){var objSpendProof=objMessage.spend_proofs[i];if("object"!=typeof objSpendProof)return callback("spend_proof must be object");if(hasFieldsExcept(objSpendProof,["spend_proof","address"]))return callback("unknown fields in spend_proof");if(!isValidBase64(objSpendProof.spend_proof,constants.HASH_LENGTH))return callback("spend proof "+objSpendProof.spend_proof+" is not a valid base64");var address=null;if(1===arrAuthorAddresses.length){if("address"in objSpendProof)return cb("when single-authored, must not put address in spend proof");address=arrAuthorAddresses[0]}else{if("string"!=typeof objSpendProof.address)return cb("when multi-authored, must put address in spend_proofs");if(arrAuthorAddresses.indexOf(objSpendProof.address)===-1)return cb("spend proof address "+objSpendProof.address+" is not an author");address=objSpendProof.address}if(objValidationState.arrInputKeys.indexOf(objSpendProof.spend_proof)>=0)return cb("spend proof "+objSpendProof.spend_proof+" already used");objValidationState.arrInputKeys.push(objSpendProof.spend_proof)}if("inline"===objMessage.payload_location)return callback("you don't need spend proofs when you have inline payload")}if("inline"!==objMessage.payload_location&&"uri"!==objMessage.payload_location&&"none"!==objMessage.payload_location)return callback("wrong payload location: "+objMessage.payload_location);if("none"===objMessage.payload_location&&("payload"in objMessage||"payload_uri"in objMessage||"payload_uri_hash"in objMessage))return callback("must be no payload");if("uri"===objMessage.payload_location){if("payload"in objMessage)return callback("must not contain payload");if("string"!=typeof objMessage.payload_uri)return callback("no payload uri");if(!isStringOfLength(objMessage.payload_uri_hash,constants.HASH_LENGTH))return callback("wrong length of payload uri hash");if(objMessage.payload_uri.length>500)return callback("payload_uri too long");if(objectHash.getBase64Hash(objMessage.payload_uri)!==objMessage.payload_uri_hash)return callback("wrong payload_uri hash")}else if("payload_uri"in objMessage||"payload_uri_hash"in objMessage)return callback("must not contain payload_uri and payload_uri_hash");if("payment"===objMessage.app){if("inline"!==objMessage.payload_location&&"none"!==objMessage.payload_location)return callback("payment location must be inline or none");if("none"===objMessage.payload_location&&!objMessage.spend_proofs)return callback("private payment must come with spend proof(s)")}var arrInlineOnlyApps=["address_definition_change","data_feed","definition_template","asset","asset_attestors","attestation","poll","vote"];return arrInlineOnlyApps.indexOf(objMessage.app)>=0&&"inline"!==objMessage.payload_location?callback(objMessage.app+" must be inline"):void async.series([validateSpendProofs,validatePayload],callback)}function checkForDoublespends(conn,type,sql,arrSqlArgs,objUnit,objValidationState,onAcceptedDoublespends,cb){conn.query(sql,arrSqlArgs,function(rows){if(0===rows.length)return cb();var arrAuthorAddresses=objUnit.authors.map(function(author){return author.address});async.eachSeries(rows,function(objConflictingRecord,cb2){if(arrAuthorAddresses.indexOf(objConflictingRecord.address)===-1)throw Error("conflicting "+type+" spent from another address?");graph.determineIfIncludedOrEqual(conn,objConflictingRecord.unit,objUnit.parent_units,function(bIncluded){if(bIncluded){var error=objUnit.unit+": conflicting "+type+" in inner unit "+objConflictingRecord.unit;if(objConflictingRecord.main_chain_index>objValidationState.last_ball_mci||null===objConflictingRecord.main_chain_index)return cb2(error);if("good"===objConflictingRecord.sequence)return cb2(error);if("final-bad"===objConflictingRecord.sequence)return cb2();throw Error("unreachable code, conflicting "+type+" in unit "+objConflictingRecord.unit)}if(objValidationState.arrAddressesWithForkedPath.indexOf(objConflictingRecord.address)===-1)throw Error("double spending "+type+" without double spending address?");cb2()})},function(err){return err?cb(err):void onAcceptedDoublespends(cb)})})}function validateInlinePayload(conn,objMessage,message_index,objUnit,objValidationState,callback){var payload=objMessage.payload;if("undefined"==typeof payload)return callback("no inline payload");if(objectHash.getBase64Hash(payload)!==objMessage.payload_hash)return callback("wrong payload hash: expected "+objectHash.getBase64Hash(payload)+", got "+objMessage.payload_hash);switch(objMessage.app){case"text":return"string"!=typeof payload?callback("payload must be string"):callback();case"address_definition_change":if(hasFieldsExcept(payload,["definition_chash","address"]))return callback("unknown fields in address_definition_change");var address,arrAuthorAddresses=objUnit.authors.map(function(author){return author.address});if(objUnit.authors.length>1){if(!isValidAddress(payload.address))return callback("when multi-authored, must indicate address");if(arrAuthorAddresses.indexOf(payload.address)===-1)return callback("foreign address");address=payload.address}else{if("address"in payload)return callback("when single-authored, must not indicate address");address=arrAuthorAddresses[0]}return objValidationState.arrDefinitionChangeFlags||(objValidationState.arrDefinitionChangeFlags={}),objValidationState.arrDefinitionChangeFlags[address]?callback("can be only one definition change per address"):(objValidationState.arrDefinitionChangeFlags[address]=!0,isValidAddress(payload.definition_chash)?callback():callback("bad new definition_chash"));case"poll":if(objValidationState.bHasPoll)return callback("can be only one poll");if(objValidationState.bHasPoll=!0,"object"!=typeof payload||Array.isArray(payload))return callback("poll payload must be object");if(hasFieldsExcept(payload,["question","choices"]))return callback("unknown fields in "+objMessage.app);if("string"!=typeof payload.question)return callback("no question in poll");if(!isNonemptyArray(payload.choices))return callback("no choices in poll");if(payload.choices.length>constants.MAX_CHOICES_PER_POLL)return callback("too many choices in poll");for(var i=0;i<payload.choices.length;i++)if("string"!=typeof payload.choices[i])return callback("all choices must be strings");return callback();case"vote":if(!isStringOfLength(payload.unit,constants.HASH_LENGTH))return callback("invalid unit in vote");if("string"!=typeof payload.choice)return callback("choice must be string");if(hasFieldsExcept(payload,["unit","choice"]))return callback("unknown fields in "+objMessage.app);conn.query("SELECT main_chain_index, sequence FROM polls JOIN poll_choices USING(unit) JOIN units USING(unit) WHERE unit=? AND choice=?",[payload.unit,payload.choice],function(poll_unit_rows){if(poll_unit_rows.length>1)throw Error("more than one poll?");if(0===poll_unit_rows.length)return callback("invalid choice "+payload.choice+" or poll "+payload.unit);var objPollUnitProps=poll_unit_rows[0];return null===objPollUnitProps.main_chain_index||objPollUnitProps.main_chain_index>objValidationState.last_ball_mci?callback("poll unit must be before last ball"):"good"!==objPollUnitProps.sequence?callback("poll unit is not serial"):callback()});break;case"data_feed":if(objValidationState.bHasDataFeed)return callback("can be only one data feed");if(objValidationState.bHasDataFeed=!0,"object"!=typeof payload||Array.isArray(payload)||0===Object.keys(payload).length)return callback("data feed payload must be non-empty object");for(var feed_name in payload){if(feed_name.length>constants.MAX_DATA_FEED_NAME_LENGTH)return callback("feed name "+feed_name+" too long");var value=payload[feed_name];if("string"==typeof value){if(value.length>constants.MAX_DATA_FEED_VALUE_LENGTH)return callback("value "+value+" too long")}else{if("number"!=typeof value)return callback("data feed "+feed_name+" must be string or number");if(!isInteger(value))return callback("fractional numbers not allowed in data feeds")}}return callback();case"profile":if(1!==objUnit.authors.length)return callback("profile must be single-authored");if(objValidationState.bHasProfile)return callback("can be only one profile");objValidationState.bHasProfile=!0;case"data":return"object"!=typeof payload||null===payload?callback(objMessage.app+" payload must be object"):callback();case"definition_template":return objValidationState.bHasDefinitionTemplate?callback("can be only one definition template"):(objValidationState.bHasDefinitionTemplate=!0,ValidationUtils.isArrayOfLength(payload,2)?callback():callback(objMessage.app+" payload must be array of two elements"));case"attestation":return 1!==objUnit.authors.length?callback("attestation must be single-authored"):hasFieldsExcept(payload,["address","profile"])?callback("unknown fields in "+objMessage.app):isValidAddress(payload.address)?"object"!=typeof payload.profile||null===payload.profile?callback("attested profile must be object"):callback():callback("attesting an invalid address");case"asset":if(objValidationState.bHasAssetDefinition)return callback("can be only one asset definition");objValidationState.bHasAssetDefinition=!0,validateAssetDefinition(conn,payload,objUnit,objValidationState,callback);break;case"asset_attestors":if(objValidationState.assocHasAssetAttestors||(objValidationState.assocHasAssetAttestors={}),objValidationState.assocHasAssetAttestors[payload.asset])return callback("can be only one asset attestor list update per asset");objValidationState.assocHasAssetAttestors[payload.asset]=!0,validateAssetorListUpdate(conn,payload,objUnit,objValidationState,callback);break;case"payment":validatePayment(conn,payload,message_index,objUnit,objValidationState,callback);break;default:return callback("unknown app: "+objMessage.app)}}function validatePayment(conn,payload,message_index,objUnit,objValidationState,callback){if(!("asset"in payload))return hasFieldsExcept(payload,["inputs","outputs"])?callback("unknown fields in payment message"):objValidationState.bHasBasePayment?callback("can have only one base payment"):(objValidationState.bHasBasePayment=!0,validatePaymentInputsAndOutputs(conn,payload,null,message_index,objUnit,objValidationState,callback));if(!isStringOfLength(payload.asset,constants.HASH_LENGTH))return callback("invalid asset");var arrAuthorAddresses=objUnit.authors.map(function(author){return author.address});storage.loadAssetWithListOfAttestedAuthors(conn,payload.asset,objValidationState.last_ball_mci,arrAuthorAddresses,function(err,objAsset){
if(err)return callback(err);if(hasFieldsExcept(payload,["inputs","outputs","asset","denomination"]))return callback("unknown fields in payment message");if(!isNonemptyArray(payload.inputs))return callback("no inputs");if(!isNonemptyArray(payload.outputs))return callback("no outputs");if(objAsset.fixed_denominations){if(!isPositiveInteger(payload.denomination))return callback("no denomination")}else if("denomination"in payload)return callback("denomination in arbitrary-amounts asset");if(!!objAsset.is_private!=!!objValidationState.bPrivate)return callback("asset privacy mismatch");var issuer_address,bIssue="issue"===payload.inputs[0].type;if(bIssue){if(1===arrAuthorAddresses.length)issuer_address=arrAuthorAddresses[0];else if(issuer_address=payload.inputs[0].address,arrAuthorAddresses.indexOf(issuer_address)===-1)return callback("issuer not among authors");if(objAsset.issued_by_definer_only&&issuer_address!==objAsset.definer_address)return callback("only definer can issue this asset")}if(objAsset.cosigned_by_definer&&arrAuthorAddresses.indexOf(objAsset.definer_address)===-1)return callback("must be cosigned by definer");if(objAsset.spender_attested){if(conf.bLight&&objAsset.is_private)return callback("being light, I can't check attestations for private assets");if(0===objAsset.arrAttestedAddresses.length)return callback("none of the authors is attested");if(bIssue&&objAsset.arrAttestedAddresses.indexOf(issuer_address)===-1)return callback("issuer is not attested")}validatePaymentInputsAndOutputs(conn,payload,objAsset,message_index,objUnit,objValidationState,callback)})}function validatePaymentInputsAndOutputs(conn,payload,objAsset,message_index,objUnit,objValidationState,callback){function validateIndivisibleIssue(input,cb){conn.query("SELECT count_coins FROM asset_denominations WHERE asset=? AND denomination=?",[payload.asset,denomination],function(rows){if(0===rows.length)return cb("invalid denomination: "+denomination);if(rows.length>1)throw Error("more than one record per denomination?");var denomInfo=rows[0];if(null===denomInfo.count_coins){if(input.amount%denomination!==0)return cb("issue amount must be multiple of denomination")}else if(input.amount!==denomination*denomInfo.count_coins)return cb("wrong size of issue of denomination "+denomination);cb()})}var denomination=payload.denomination||1,arrAuthorAddresses=objUnit.authors.map(function(author){return author.address}),arrInputAddresses=[],arrOutputAddresses=[],total_input=0;if(payload.inputs.length>constants.MAX_INPUTS_PER_PAYMENT_MESSAGE)return callback("too many inputs");if(payload.outputs.length>constants.MAX_OUTPUTS_PER_PAYMENT_MESSAGE)return callback("too many outputs");if(objAsset&&objAsset.fixed_denominations&&1!==payload.inputs.length)return callback("fixed denominations payment must have 1 input");for(var total_output=0,prev_address="",prev_amount=0,count_open_outputs=0,i=0;i<payload.outputs.length;i++){var output=payload.outputs[i];if(hasFieldsExcept(output,["address","amount","blinding","output_hash"]))return callback("unknown fields in payment output");if(!isPositiveInteger(output.amount))return callback("amount must be positive integer, found "+output.amount);if(objAsset&&objAsset.fixed_denominations&&output.amount%denomination!==0)return callback("output amount must be divisible by denomination");if(objAsset&&objAsset.is_private){if("output_hash"in output!=!!objAsset.fixed_denominations)return callback("output_hash must be present with fixed denominations only");if("output_hash"in output&&!isStringOfLength(output.output_hash,constants.HASH_LENGTH))return callback("invalid output hash");if(!(objAsset.fixed_denominations||"blinding"in output&&"address"in output))return callback("no blinding or address");if("blinding"in output&&!isStringOfLength(output.blinding,16))return callback("bad blinding");if("blinding"in output!="address"in output)return callback("address and bilinding must come together");if("address"in output&&!ValidationUtils.isValidAddressAnyCase(output.address))return callback("output address "+output.address+" invalid");output.address&&count_open_outputs++}else{if("blinding"in output)return callback("public output must not have blinding");if("output_hash"in output)return callback("public output must not have output_hash");if(!ValidationUtils.isValidAddressAnyCase(output.address))return callback("output address "+output.address+" invalid");if(prev_address>output.address)return callback("output addresses not sorted");if(prev_address===output.address&&prev_amount>output.amount)return callback("output amounts for same address not sorted");prev_address=output.address,prev_amount=output.amount}output.address&&arrOutputAddresses.indexOf(output.address)===-1&&arrOutputAddresses.push(output.address),total_output+=output.amount}if(objAsset&&objAsset.is_private&&1!==count_open_outputs)return callback("found "+count_open_outputs+" open outputs, expected 1");var bIssue=!1,bHaveHeadersComissions=!1,bHaveWitnessings=!1;async.forEachOfSeries(payload.inputs,function(input,input_index,cb){function checkInputDoubleSpend(cb2){doubleSpendWhere+=" AND unit != "+conn.escape(objUnit.unit),objAsset?(doubleSpendWhere+=" AND asset=?",doubleSpendVars.push(payload.asset)):doubleSpendWhere+=" AND asset IS NULL";var doubleSpendQuery="SELECT "+doubleSpendFields+" FROM inputs JOIN units USING(unit) WHERE "+doubleSpendWhere;checkForDoublespends(conn,"divisible input",doubleSpendQuery,doubleSpendVars,objUnit,objValidationState,function(cb3){console.log("--- accepting doublespend on unit "+objUnit.unit);var sql="UPDATE inputs SET is_unique=NULL WHERE "+doubleSpendWhere+" AND (SELECT is_stable FROM units WHERE units.unit=inputs.unit)=0";return objAsset&&objAsset.is_private?void mutex.lock(["private_write"],function(unlock){console.log("--- will ununique the conflicts of unit "+objUnit.unit),conn.query(sql,doubleSpendVars,function(){console.log("--- ununique done unit "+objUnit.unit),objValidationState.arrDoubleSpendInputs.push({message_index:message_index,input_index:input_index}),unlock(),cb3()})}):(objValidationState.arrAdditionalQueries.push({sql:sql,params:doubleSpendVars}),objValidationState.arrDoubleSpendInputs.push({message_index:message_index,input_index:input_index}),cb3())},function(err){if(err&&objAsset&&objAsset.is_private)throw Error("spend proof didn't help: "+err);cb2(err)})}if(objAsset){if("type"in input&&"issue"!==input.type)return cb("non-base input can have only type=issue")}else if("type"in input&&!isNonemptyString(input.type))return cb("bad input type");var doubleSpendWhere,type=input.type||"transfer",doubleSpendFields="unit, address, message_index, input_index, main_chain_index, sequence, is_stable",doubleSpendVars=[];switch(type){case"issue":if(0!==input_index)return cb("issue must come first");if(hasFieldsExcept(input,["type","address","amount","serial_number"]))return cb("unknown fields in issue input");if(!isPositiveInteger(input.amount))return cb("amount must be positive");if(!isPositiveInteger(input.serial_number))return cb("serial_number must be positive");if((!objAsset||objAsset.cap)&&1!==input.serial_number)return cb("for capped asset serial_number must be 1");if(bIssue)return cb("only one issue per message allowed");bIssue=!0;var address=null;if(1===arrAuthorAddresses.length){if("address"in input)return cb("when single-authored, must not put address in issue input");address=arrAuthorAddresses[0]}else{if("string"!=typeof input.address)return cb("when multi-authored, must put address in issue input");if(arrAuthorAddresses.indexOf(input.address)===-1)return cb("issue input address "+input.address+" is not an author");address=input.address}if(arrInputAddresses=[address],objAsset){if(objAsset.cap&&!objAsset.fixed_denominations&&input.amount!==objAsset.cap)return cb("issue must be equal to cap")}else{if(!storage.isGenesisUnit(objUnit.unit))return cb("only genesis can issue base asset");if(input.amount!==constants.TOTAL_WHITEBYTES)return cb("issue must be equal to cap")}total_input+=input.amount;var input_key=(payload.asset||"base")+"-"+denomination+"-"+address+"-"+input.serial_number;if(objValidationState.arrInputKeys.indexOf(input_key)>=0)return callback("input "+input_key+" already used");objValidationState.arrInputKeys.push(input_key),doubleSpendWhere="type='issue'",doubleSpendVars=[],objAsset&&objAsset.fixed_denominations&&(doubleSpendWhere+=" AND denomination=?",doubleSpendVars.push(denomination)),objAsset&&(doubleSpendWhere+=" AND serial_number=?",doubleSpendVars.push(input.serial_number)),objAsset&&!objAsset.issued_by_definer_only&&(doubleSpendWhere+=" AND address=?",doubleSpendVars.push(address)),objAsset&&objAsset.fixed_denominations?validateIndivisibleIssue(input,function(err){return err?cb(err):void checkInputDoubleSpend(cb)}):checkInputDoubleSpend(cb);break;case"transfer":if(bHaveHeadersComissions||bHaveWitnessings)return cb("all transfers must come before hc and witnessings");if(hasFieldsExcept(input,["type","unit","message_index","output_index"]))return cb("unknown fields in payment input");if(!isStringOfLength(input.unit,constants.HASH_LENGTH))return cb("wrong unit length in payment input");if(!isNonnegativeInteger(input.message_index))return cb("no message_index in payment input");if(!isNonnegativeInteger(input.output_index))return cb("no output_index in payment input");var input_key=(payload.asset||"base")+"-"+input.unit+"-"+input.message_index+"-"+input.output_index;if(objValidationState.arrInputKeys.indexOf(input_key)>=0)return cb("input "+input_key+" already used");if(objValidationState.arrInputKeys.push(input_key),doubleSpendWhere="type=? AND src_unit=? AND src_message_index=? AND src_output_index=?",doubleSpendVars=[type,input.unit,input.message_index,input.output_index],objAsset&&objAsset.is_private&&objAsset.fixed_denominations){if(!objValidationState.src_coin)throw Error("no src_coin");var src_coin=objValidationState.src_coin;if(!src_coin.src_output)throw Error("no src_output");if(!isPositiveInteger(src_coin.denomination))throw Error("no denomination in src coin");if(!isPositiveInteger(src_coin.amount))throw Error("no src coin amount");var owner_address=src_coin.src_output.address;return arrAuthorAddresses.indexOf(owner_address)===-1?cb("output owner is not among authors"):denomination!==src_coin.denomination?cb("private denomination mismatch"):objAsset.auto_destroy&&owner_address===objAsset.definer_address?cb("this output was destroyed by sending to definer address"):objAsset.spender_attested&&objAsset.arrAttestedAddresses.indexOf(owner_address)===-1?cb("owner address is not attested"):(arrInputAddresses.indexOf(owner_address)===-1&&arrInputAddresses.push(owner_address),total_input+=src_coin.amount,console.log("-- val state "+JSON.stringify(objValidationState)),checkInputDoubleSpend(cb))}conn.query("SELECT amount, is_stable, sequence, address, main_chain_index, denomination, asset \n\t\t\t\t\t\tFROM outputs \n\t\t\t\t\t\tJOIN units USING(unit) \n\t\t\t\t\t\tWHERE outputs.unit=? AND message_index=? AND output_index=?",[input.unit,input.message_index,input.output_index],function(rows){if(rows.length>1)throw Error("more than 1 src output");if(0===rows.length)return cb("input unit "+input.unit+" not found");var src_output=rows[0];if("number"!=typeof src_output.amount)throw Error("src output amount is not a number");if((payload.asset||src_output.asset)&&payload.asset!==src_output.asset)return cb("asset mismatch");if((!objAsset||!objAsset.is_private)&&(src_output.main_chain_index>objValidationState.last_ball_mci||null===src_output.main_chain_index))return cb("src output must be before last ball");if("good"!==src_output.sequence)return cb("input unit "+input.unit+" is not serial");var owner_address=src_output.address;return arrAuthorAddresses.indexOf(owner_address)===-1?cb("output owner is not among authors"):denomination!==src_output.denomination?cb("denomination mismatch"):objAsset&&objAsset.auto_destroy&&owner_address===objAsset.definer_address?cb("this output was destroyed by sending it to definer address"):objAsset&&objAsset.spender_attested&&objAsset.arrAttestedAddresses.indexOf(owner_address)===-1?cb("owner address is not attested"):(arrInputAddresses.indexOf(owner_address)===-1&&arrInputAddresses.push(owner_address),total_input+=src_output.amount,objAsset&&objAsset.is_private?void graph.determineIfIncluded(conn,input.unit,[objUnit.unit],function(bIncluded){return bIncluded?void checkInputDoubleSpend(cb):cb("input "+input.unit+" is not in your genes")}):checkInputDoubleSpend(cb))});break;case"headers_commission":case"witnessing":if("headers_commission"===type){if(bHaveWitnessings)return cb("all headers commissions must come before witnessings");bHaveHeadersComissions=!0}else bHaveWitnessings=!0;if(objAsset)return cb("only base asset can have "+type);if(hasFieldsExcept(input,["type","from_main_chain_index","to_main_chain_index","address"]))return cb("unknown fields in witnessing input");if(!isNonnegativeInteger(input.from_main_chain_index))return cb("from_main_chain_index must be nonnegative int");if(!isNonnegativeInteger(input.to_main_chain_index))return cb("to_main_chain_index must be nonnegative int");if(input.from_main_chain_index>input.to_main_chain_index)return cb("from_main_chain_index > input.to_main_chain_index");if(input.to_main_chain_index>objValidationState.last_ball_mci)return cb("to_main_chain_index > last_ball_mci");if(input.from_main_chain_index>objValidationState.last_ball_mci)return cb("from_main_chain_index > last_ball_mci");var address=null;if(1===arrAuthorAddresses.length){if("address"in input)return cb("when single-authored, must not put address in "+type+" input");address=arrAuthorAddresses[0]}else{if("string"!=typeof input.address)return cb("when multi-authored, must put address in "+type+" input");if(arrAuthorAddresses.indexOf(input.address)===-1)return cb(type+" input address "+input.address+" is not an author");address=input.address}var input_key=type+"-"+address+"-"+input.from_main_chain_index;if(objValidationState.arrInputKeys.indexOf(input_key)>=0)return cb("input "+input_key+" already used");objValidationState.arrInputKeys.push(input_key),doubleSpendWhere="type=? AND from_main_chain_index=? AND address=? AND asset IS NULL",doubleSpendVars=[type,input.from_main_chain_index,address],mc_outputs.readNextSpendableMcIndex(conn,type,address,objValidationState.arrConflictingUnits,function(next_spendable_mc_index){if(input.from_main_chain_index<next_spendable_mc_index)return cb(type+" ranges must not overlap");var max_mci="headers_commission"===type?headers_commission.getMaxSpendableMciForLastBallMci(objValidationState.last_ball_mci):paid_witnessing.getMaxSpendableMciForLastBallMci(objValidationState.last_ball_mci);if(input.to_main_chain_index>max_mci)return cb(type+" to_main_chain_index is too large");var calcFunc="headers_commission"===type?mc_outputs.calcEarnings:paid_witnessing.calcWitnessEarnings;calcFunc(conn,type,input.from_main_chain_index,input.to_main_chain_index,address,{ifError:function(err){throw Error(err)},ifOk:function(commission){return 0===commission?cb("zero "+type+" commission"):(total_input+=commission,void checkInputDoubleSpend(cb))}})});break;default:return cb("unrecognized input type: "+input.type)}},function(err){if(console.log("inputs done "+payload.asset,arrInputAddresses,arrOutputAddresses),err)return callback(err);if(objAsset){if(total_input!==total_output)return callback("inputs and outputs do not balance: "+total_input+" !== "+total_output);if(!objAsset.is_transferrable&&!(1===arrInputAddresses.length&&arrInputAddresses[0]===objAsset.definer_address||1===arrOutputAddresses.length&&arrOutputAddresses[0]===objAsset.definer_address||(!objAsset.fixed_denominations||!objAsset.is_private)&&1===arrInputAddresses.length&&2===arrOutputAddresses.length&&arrOutputAddresses.indexOf(objAsset.definer_address)>=0&&arrOutputAddresses.indexOf(arrInputAddresses[0])>=0))return callback("the asset is not transferrable");var arrCondition=bIssue?objAsset.issue_condition:objAsset.transfer_condition;if(arrCondition)return void Definition.evaluateAssetCondition(conn,payload.asset,arrCondition,objUnit,objValidationState,function(cond_err,bSatisfiesCondition){return cond_err?callback(cond_err):bSatisfiesCondition?(console.log("validatePaymentInputsAndOutputs with transfer/issue conditions done"),void callback()):callback("transfer or issue condition not satisfied")})}else if(total_input!==total_output+objUnit.headers_commission+objUnit.payload_commission)return callback("inputs and outputs do not balance: "+total_input+" !== "+total_output+" + "+objUnit.headers_commission+" + "+objUnit.payload_commission);console.log("validatePaymentInputsAndOutputs done"),callback()})}function initPrivatePaymentValidationState(conn,unit,message_index,payload,onError,onDone){conn.query("SELECT payload_hash, app, units.sequence, units.is_stable, lb_units.main_chain_index AS last_ball_mci \n\t\tFROM messages JOIN units USING(unit) \n\t\tLEFT JOIN units AS lb_units ON units.last_ball_unit=lb_units.unit \n\t\tWHERE messages.unit=? AND message_index=?",[unit,message_index],function(rows){if(rows.length>1)throw Error("more than 1 message by index");if(0===rows.length)return onError("message not found");var row=rows[0];if("good"!==row.sequence&&1===row.is_stable)return onError("unit is final nonserial");var bStable=1===row.is_stable;if("payment"!==row.app)return onError("invalid app");if(objectHash.getBase64Hash(payload)!==row.payload_hash)return onError("payload hash does not match");var objValidationState={last_ball_mci:row.last_ball_mci,arrDoubleSpendInputs:[],arrInputKeys:[],bPrivate:!0},objPartialUnit={unit:unit};storage.readUnitAuthors(conn,unit,function(arrAuthors){objPartialUnit.authors=arrAuthors.map(function(address){return{address:address}}),onDone(bStable,objPartialUnit,objValidationState)})})}function validateAssetDefinition(conn,payload,objUnit,objValidationState,callback){if(1!==objUnit.authors.length)return callback("asset definition must be single-authored");if(hasFieldsExcept(payload,["cap","is_private","is_transferrable","auto_destroy","fixed_denominations","issued_by_definer_only","cosigned_by_definer","spender_attested","issue_condition","transfer_condition","attestors","denominations"]))return callback("unknown fields in asset definition");if("boolean"!=typeof payload.is_private||"boolean"!=typeof payload.is_transferrable||"boolean"!=typeof payload.auto_destroy||"boolean"!=typeof payload.fixed_denominations||"boolean"!=typeof payload.issued_by_definer_only||"boolean"!=typeof payload.cosigned_by_definer||"boolean"!=typeof payload.spender_attested)return callback("some required fields in asset definition are missing");if("cap"in payload&&!(isPositiveInteger(payload.cap)&&payload.cap<=constants.MAX_CAP))return callback("invalid cap");var err;if(payload.spender_attested&&(err=checkAttestorList(payload.attestors)))return callback(err);if(payload.fixed_denominations&&!isNonemptyArray(payload.denominations))return callback("denominations not defined");if(payload.denominations){if(payload.denominations.length>constants.MAX_DENOMINATIONS_PER_ASSET_DEFINITION)return callback("too many denominations");for(var total_cap_from_denominations=0,bHasUncappedDenominations=!1,prev_denom=0,i=0;i<payload.denominations.length;i++){var denomInfo=payload.denominations[i];if(!isPositiveInteger(denomInfo.denomination))return callback("invalid denomination");if(denomInfo.denomination<=prev_denom)return callback("denominations unsorted");if("count_coins"in denomInfo){if(!isPositiveInteger(denomInfo.count_coins))return callback("invalid count_coins");total_cap_from_denominations+=denomInfo.count_coins*denomInfo.denomination}else bHasUncappedDenominations=!0;prev_denom=denomInfo.denomination}if(bHasUncappedDenominations&&total_cap_from_denominations)return callback("some denominations are capped, some uncapped");if(bHasUncappedDenominations&&payload.cap)return callback("has cap but some denominations are uncapped");if(total_cap_from_denominations&&!payload.cap)return callback("has no cap but denominations are capped");if(total_cap_from_denominations&&payload.cap!==total_cap_from_denominations)return callback("cap doesn't match sum of denominations")}return payload.is_private&&payload.is_transferrable&&!payload.fixed_denominations?callback("if private and transferrable, must have fixed denominations"):!payload.is_private||payload.fixed_denominations||payload.auto_destroy&&!payload.is_transferrable?payload.cap&&!payload.issued_by_definer_only?callback("if capped, must be issued by definer only"):(objValidationState.bDefiningPrivateAsset=payload.is_private,void async.series([function(cb){return"issue_condition"in payload?void Definition.validateDefinition(conn,payload.issue_condition,objUnit,objValidationState,!0,cb):cb()},function(cb){return"transfer_condition"in payload?void Definition.validateDefinition(conn,payload.transfer_condition,objUnit,objValidationState,!0,cb):cb()}],callback)):callback("if private and divisible, must also be auto-destroy and non-transferrable")}function validateAssetorListUpdate(conn,payload,objUnit,objValidationState,callback){return 1!==objUnit.authors.length?callback("attestor list must be single-authored"):isStringOfLength(payload.asset,constants.HASH_LENGTH)?void storage.readAsset(conn,payload.asset,objValidationState.last_ball_mci,function(err,objAsset){return err?callback(err):objAsset.spender_attested?objUnit.authors[0].address!==objAsset.definer_address?callback("attestor list can be edited only by definer"):(err=checkAttestorList(payload.attestors))?callback(err):void callback():callback("this asset does not require attestors")}):callback("invalid asset in attestor list update")}function checkAttestorList(arrAttestors){if(!isNonemptyArray(arrAttestors))return"attestors not defined";if(arrAttestors.length>constants.MAX_ATTESTORS_PER_ASSET)return"too many attestors";for(var prev="",i=0;i<arrAttestors.length;i++){if(arrAttestors[i]<=prev)return"attestors not sorted";if(!isValidAddress(arrAttestors[i]))return"invalid attestor address: "+arrAttestors[i];prev=arrAttestors[i]}return null}function validateAuthorSignaturesWithoutReferences(objAuthor,objUnit,arrAddressDefinition,callback){var objValidationState={unit_hash_to_sign:objectHash.getUnitHashToSign(objUnit),last_ball_mci:-1,bNoReferences:!0};Definition.validateAuthentifiers(null,objAuthor.address,null,arrAddressDefinition,objUnit,objValidationState,objAuthor.authentifiers,function(err,res){return err?callback(err):res?void callback():callback("authentifier verification failed")})}function createJointError(err){return{error_code:"invalid_joint",message:err}}var async=require("async"),storage=require("./storage.js"),graph=require("./graph.js"),main_chain=require("./main_chain.js"),paid_witnessing=require("./paid_witnessing.js"),headers_commission=require("./headers_commission.js"),mc_outputs=require("./mc_outputs.js"),objectHash=require("./object_hash.js"),objectLength=require("./object_length.js"),db=require("./db.js"),chash=require("./chash.js"),mutex=require("./mutex.js"),constants=require("./constants.js"),ValidationUtils=require("./validation_utils.js"),Definition=require("./definition.js"),conf=require("./conf.js"),profiler=require("./profiler.js"),breadcrumbs=require("./breadcrumbs.js"),hasFieldsExcept=(Math.pow(2,31)-1,ValidationUtils.hasFieldsExcept),isNonemptyString=ValidationUtils.isNonemptyString,isStringOfLength=ValidationUtils.isStringOfLength,isInteger=ValidationUtils.isInteger,isNonnegativeInteger=ValidationUtils.isNonnegativeInteger,isPositiveInteger=ValidationUtils.isPositiveInteger,isNonemptyArray=ValidationUtils.isNonemptyArray,isValidAddress=ValidationUtils.isValidAddress,isValidBase64=ValidationUtils.isValidBase64;exports.validate=validate,exports.hasValidHashes=hasValidHashes,exports.validateAuthorSignaturesWithoutReferences=validateAuthorSignaturesWithoutReferences,exports.validatePayment=validatePayment,exports.initPrivatePaymentValidationState=initPrivatePaymentValidationState},{"./breadcrumbs.js":365,"./chash.js":367,"./conf.js":370,"./constants.js":371,"./db.js":372,"./definition.js":373,"./event_bus.js":378,"./graph.js":379,"./headers_commission.js":380,"./main_chain.js":385,"./mc_outputs.js":386,"./mutex.js":388,"./object_hash.js":392,"./object_length.js":393,"./paid_witnessing.js":395,"./profiler.js":398,"./storage.js":402,"./validation_utils.js":405,async:26}],405:[function(require,module,exports){(function(Buffer){"use strict";function hasFieldsExcept(obj,arrFields){for(var field in obj)if(arrFields.indexOf(field)===-1)return!0;return!1}function isInteger(int){return"number"==typeof int&&int.toString().indexOf(".")===-1&&!isNaN(int)}function isPositiveInteger(int){return"number"==typeof int&&int>0&&int.toString().indexOf(".")===-1&&!isNaN(int)}function isNonnegativeInteger(int){return"number"==typeof int&&int>=0&&int.toString().indexOf(".")===-1&&!isNaN(int)}function isNonemptyString(str){return"string"==typeof str&&str.length>0}function isStringOfLength(str,len){return"string"==typeof str&&str.length===len}function isValidChash(str,len){return isStringOfLength(str,len)&&chash.isChashValid(str)}function isValidAddressAnyCase(address){return isValidChash(address,32)}function isValidAddress(address){return"string"==typeof address&&address===address.toUpperCase()&&isValidChash(address,32)}function isValidDeviceAddress(address){return isStringOfLength(address,33)&&"0"===address[0]&&isValidAddress(address.substr(1))}function isNonemptyArray(arr){return Array.isArray(arr)&&arr.length>0}function isArrayOfLength(arr,len){return Array.isArray(arr)&&arr.length===len}function isNonemptyObject(obj){return obj&&"object"==typeof obj&&!Array.isArray(obj)&&Object.keys(obj).length>0}function isValidBase64(b64,len){return"string"==typeof b64&&b64.length===len&&b64===new Buffer(b64,"base64").toString("base64")}var chash=require("./chash.js");exports.hasFieldsExcept=hasFieldsExcept,exports.isNonemptyString=isNonemptyString,exports.isStringOfLength=isStringOfLength,exports.isInteger=isInteger,exports.isNonnegativeInteger=isNonnegativeInteger,exports.isPositiveInteger=isPositiveInteger,exports.isNonemptyObject=isNonemptyObject,exports.isNonemptyArray=isNonemptyArray,exports.isArrayOfLength=isArrayOfLength,exports.isValidAddressAnyCase=isValidAddressAnyCase,exports.isValidAddress=isValidAddress,exports.isValidDeviceAddress=isValidDeviceAddress,exports.isValidBase64=isValidBase64}).call(this,require("buffer").Buffer)},{"./chash.js":367,buffer:151}],406:[function(require,module,exports){"use strict";function handleJustsaying(ws,subject,body){switch(subject){case"hub/challenge":var challenge=body;device.handleChallenge(ws,challenge);break;case"hub/message":var objDeviceMessage=body.message,message_hash=body.message_hash,respondWithError=function(error){network.sendError(ws,error),network.sendJustsaying(ws,"hub/delete",message_hash)};if(!(message_hash&&objDeviceMessage&&objDeviceMessage.signature&&objDeviceMessage.pubkey&&objDeviceMessage.to&&objDeviceMessage.encrypted_package&&objDeviceMessage.encrypted_package.dh&&objDeviceMessage.encrypted_package.dh.sender_ephemeral_pubkey&&objDeviceMessage.encrypted_package.encrypted_message&&objDeviceMessage.encrypted_package.iv&&objDeviceMessage.encrypted_package.authtag))return network.sendError(ws,"missing fields");if(objDeviceMessage.to!==device.getMyDeviceAddress())return network.sendError(ws,"not mine");if(message_hash!==objectHash.getBase64Hash(objDeviceMessage))return network.sendError(ws,"wrong hash");if(!ecdsaSig.verify(objectHash.getDeviceMessageHashToSign(objDeviceMessage),objDeviceMessage.signature,objDeviceMessage.pubkey))return respondWithError("wrong message signature");var json=device.decryptPackage(objDeviceMessage.encrypted_package);if(!json)return respondWithError("failed to decrypt");var from_address=objectHash.getDeviceAddress(objDeviceMessage.pubkey);if(from_address!==json.from)return respondWithError("wrong message signature");var handleMessage=function(bIndirectCorrespondent){mutex.lock(["from_hub"],function(unlock){handleMessageFromHub(ws,json,objDeviceMessage.pubkey,bIndirectCorrespondent,{ifError:function(err){respondWithError(err),unlock()},ifOk:function(){network.sendJustsaying(ws,"hub/delete",message_hash),unlock()}})})};db.query("SELECT hub, is_indirect FROM correspondent_devices WHERE device_address=?",[from_address],function(rows){if(rows.length>0)json.device_hub&&json.device_hub!==rows[0].hub?db.query("UPDATE correspondent_devices SET hub=? WHERE device_address=?",[json.device_hub,from_address],function(){handleMessage(rows[0].is_indirect)}):handleMessage(rows[0].is_indirect);else{var arrSubjectsAllowedFromNoncorrespondents=["pairing","my_xpubkey","wallet_fully_approved"];if(arrSubjectsAllowedFromNoncorrespondents.indexOf(json.subject)===-1)return respondWithError("correspondent not known and not whitelisted subject");handleMessage(!1)}});break;case"hub/message_box_status":if(!ws.bLoggedIn)return respondWithError("you are not my hub");"empty"===body&&device.scheduleTempDeviceKeyRotation();break;case"light/have_updates":lightWallet.refreshLightClientHistory()}}function sendSignature(device_address,signed_text,signature,signing_path,address){device.sendMessageToDevice(device_address,"signature",{signed_text:signed_text,signature:signature,signing_path:signing_path,address:address})}function handleMessageFromHub(ws,json,device_pubkey,bIndirectCorrespondent,callbacks){var subject=json.subject,body=json.body;if(!subject||"undefined"==typeof body)return callbacks.ifError("no subject or body");var from_address=objectHash.getDeviceAddress(device_pubkey);switch(subject){case"pairing":device.handlePairingMessage(json,device_pubkey,callbacks);break;case"text":if(message_counter++,!ValidationUtils.isNonemptyString(body))return callbacks.ifError("text body must be string");eventBus.emit("text",from_address,body,message_counter),callbacks.ifOk();break;case"removed_paired_device":conf.bIgnoreUnpairRequests?callbacks.ifError("removed_paired_device ignored: "+from_address):determineIfDeviceCanBeRemoved(from_address,function(bRemovable){return bRemovable?void device.removeCorrespondentDevice(from_address,function(){eventBus.emit("removed_paired_device",from_address),callbacks.ifOk()}):callbacks.ifError("device "+from_address+" is not removable")});break;case"chat_recording_pref":message_counter++,eventBus.emit("chat_recording_pref",from_address,body,message_counter),callbacks.ifOk();break;case"create_new_wallet":walletDefinedByKeys.handleOfferToCreateNewWallet(body,from_address,callbacks);break;case"cancel_new_wallet":if(!ValidationUtils.isNonemptyString(body.wallet))return callbacks.ifError("no wallet");walletDefinedByKeys.deleteWallet(body.wallet,from_address,callbacks.ifOk);break;case"my_xpubkey":if(!ValidationUtils.isNonemptyString(body.wallet))return callbacks.ifError("no wallet");if(!ValidationUtils.isNonemptyString(body.my_xpubkey))return callbacks.ifError("no my_xpubkey");if(body.my_xpubkey.length>112)return callbacks.ifError("my_xpubkey too long");walletDefinedByKeys.addDeviceXPubKey(body.wallet,from_address,body.my_xpubkey,callbacks.ifOk);break;case"wallet_fully_approved":if(!ValidationUtils.isNonemptyString(body.wallet))return callbacks.ifError("no wallet");walletDefinedByKeys.handleNotificationThatWalletFullyApproved(body.wallet,from_address,callbacks.ifOk);break;case"new_wallet_address":if(!ValidationUtils.isNonemptyString(body.wallet))return callbacks.ifError("no wallet");if(0!==body.is_change&&1!==body.is_change)return callbacks.ifError("bad is_change");if(!ValidationUtils.isNonnegativeInteger(body.address_index))return callbacks.ifError("bad address_index");if(!ValidationUtils.isValidAddress(body.address))return callbacks.ifError("no address or bad address");walletDefinedByKeys.addNewAddress(body.wallet,body.is_change,body.address_index,body.address,function(err){return err?callbacks.ifError(err):void callbacks.ifOk()});break;
case"create_new_shared_address":if(!ValidationUtils.isArrayOfLength(body.address_definition_template,2))return callbacks.ifError("no address definition template");walletDefinedByAddresses.validateAddressDefinitionTemplate(body.address_definition_template,from_address,function(err,assocMemberDeviceAddressesBySigningPaths){return err?callbacks.ifError(err):(eventBus.emit("create_new_shared_address",body.address_definition_template,assocMemberDeviceAddressesBySigningPaths),void callbacks.ifOk())});break;case"approve_new_shared_address":if(!ValidationUtils.isValidAddress(body.address_definition_template_chash))return callbacks.ifError("invalid addr def c-hash");if(!ValidationUtils.isValidAddress(body.address))return callbacks.ifError("invalid address");if("object"!=typeof body.device_addresses_by_relative_signing_paths||0===Object.keys(body.device_addresses_by_relative_signing_paths).length)return callbacks.ifError("invalid device_addresses_by_relative_signing_paths");walletDefinedByAddresses.approvePendingSharedAddress(body.address_definition_template_chash,from_address,body.address,body.device_addresses_by_relative_signing_paths),callbacks.ifOk();break;case"reject_new_shared_address":if(!ValidationUtils.isValidAddress(body.address_definition_template_chash))return callbacks.ifError("invalid addr def c-hash");walletDefinedByAddresses.deletePendingSharedAddress(body.address_definition_template_chash),callbacks.ifOk();break;case"new_shared_address":walletDefinedByAddresses.handleNewSharedAddress(body,{ifError:callbacks.ifError,ifOk:function(){callbacks.ifOk(),eventBus.emit("maybe_new_transactions")}});break;case"sign":if(!ValidationUtils.isValidAddress(body.address))return callbacks.ifError("no address or bad address");if(!ValidationUtils.isNonemptyString(body.signing_path)||"r"!==body.signing_path.charAt(0))return callbacks.ifError("bad signing path");var objUnit=body.unsigned_unit;if("object"!=typeof objUnit)return callbacks.ifError("no unsigned unit");objUnit.authors.forEach(function(author){var authentifiers=author.authentifiers;for(var path in authentifiers)authentifiers[path]=authentifiers[path].replace(/./,"-")});var assocPrivatePayloads=body.private_payloads;if("private_payloads"in body){if("object"!=typeof assocPrivatePayloads||!assocPrivatePayloads)return callbacks.ifError("bad private payloads");for(var payload_hash in assocPrivatePayloads){var payload=assocPrivatePayloads[payload_hash],hidden_payload=_.cloneDeep(payload);payload.denomination&&hidden_payload.outputs.forEach(function(o){delete o.address,delete o.blinding});var calculated_payload_hash=objectHash.getBase64Hash(hidden_payload);if(payload_hash!==calculated_payload_hash)return callbacks.ifError("private payload hash does not match");if(!ValidationUtils.isNonemptyArray(objUnit.messages))return callbacks.ifError("no messages in unsigned unit");if(1!==objUnit.messages.filter(function(objMessage){return objMessage.payload_hash===payload_hash}).length)return callbacks.ifError("no such payload hash in the messages")}}findAddress(body.address,body.signing_path,{ifError:callbacks.ifError,ifLocal:function(objAddress){callbacks.ifOk(),objUnit.unit=objectHash.getUnitHash(objUnit);var objJoint={unit:objUnit,unsigned:!0};eventBus.once("validated-"+objUnit.unit,function(bValid){return bValid?void eventBus.emit("signing_request",objAddress,body.address,objUnit,assocPrivatePayloads,from_address,body.signing_path):void console.log("===== unit in signing request is invalid")}),network.handleOnlineJoint(ws,objJoint)},ifRemote:function(device_address){if(device_address===from_address)throw callbacks.ifError("looping signing request for address "+body.address+", path "+body.signing_path),Error("looping signing request for address "+body.address+", path "+body.signing_path);var text_to_sign=objectHash.getUnitHashToSign(body.unsigned_unit).toString("base64");eventBus.once("signature-"+device_address+"-"+body.address+"-"+body.signing_path+"-"+text_to_sign,function(sig){sendSignature(from_address,text_to_sign,sig,body.signing_path,body.address)}),device.sendMessageToDevice(device_address,subject,body),callbacks.ifOk()},ifMerkle:function(bLocal){callbacks.ifError("there is merkle proof at signing path "+body.signing_path)},ifUnknownAddress:function(){callbacks.ifError("not aware of address "+body.address+" but will see if I learn about it later"),eventBus.once("new_address-"+body.address,function(){handleMessageFromHub(ws,json,device_pubkey,bIndirectCorrespondent,{ifOk:function(){},ifError:function(){}})})}});break;case"signature":if(!ValidationUtils.isStringOfLength(body.signed_text,constants.HASH_LENGTH))return callbacks.ifError("bad signed text");if(!ValidationUtils.isStringOfLength(body.signature,constants.SIG_LENGTH)&&"[refused]"!==body.signature)return callbacks.ifError("bad signature length");if(!ValidationUtils.isNonemptyString(body.signing_path)||"r"!==body.signing_path.charAt(0))return callbacks.ifError("bad signing path");if(!ValidationUtils.isValidAddress(body.address))return callbacks.ifError("bad address");eventBus.emit("signature-"+from_address+"-"+body.address+"-"+body.signing_path+"-"+body.signed_text,body.signature),callbacks.ifOk();break;case"private_payments":var arrChains=body.chains;if(!ValidationUtils.isNonemptyArray(arrChains))return callbacks.ifError("no chains found");profiler.increment(),conf.bLight&&network.requestUnfinishedPastUnitsOfPrivateChains(arrChains);var assocValidatedByKey={},bParsingComplete=!1,cancelAllKeys=function(){for(var key in assocValidatedByKey)eventBus.removeAllListeners(key)},current_message_counter=++message_counter,checkIfAllValidated=function(){if(!assocValidatedByKey)return console.log("duplicate call of checkIfAllValidated");for(var key in assocValidatedByKey)if(!assocValidatedByKey[key])return console.log("not all private payments validated yet");assocValidatedByKey=null,body.forwarded||emitNewPrivatePaymentReceived(from_address,arrChains,current_message_counter),profiler.print()};async.eachSeries(arrChains,function(arrPrivateElements,cb){var objHeadPrivateElement=arrPrivateElements[0];if(!!objHeadPrivateElement.payload.denomination!==ValidationUtils.isNonnegativeInteger(objHeadPrivateElement.output_index))return cb("divisibility doesn't match presence of output_index");var output_index=objHeadPrivateElement.payload.denomination?objHeadPrivateElement.output_index:-1,payload_hash=objectHash.getBase64Hash(objHeadPrivateElement.payload),key="private_payment_validated-"+objHeadPrivateElement.unit+"-"+payload_hash+"-"+output_index;assocValidatedByKey[key]=!1,network.handleOnlinePrivatePayment(ws,arrPrivateElements,!0,{ifError:function(error){console.log("handleOnlinePrivatePayment error: "+error),cb("an error")},ifValidationError:function(unit,error){console.log("handleOnlinePrivatePayment validation error: "+error),cb("an error")},ifAccepted:function(unit){console.log("handleOnlinePrivatePayment accepted"),assocValidatedByKey[key]=!0,cb()},ifQueued:function(){console.log("handleOnlinePrivatePayment queued, will wait for "+key),eventBus.once(key,function(bValid){return bValid?(assocValidatedByKey[key]=!0,void(bParsingComplete?checkIfAllValidated():console.log("parsing incomplete yet"))):cancelAllKeys()}),cb()}})},function(err){return bParsingComplete=!0,err?(cancelAllKeys(),callbacks.ifError(err)):(checkIfAllValidated(),callbacks.ifOk(),void(body.forwarded||forwardPrivateChainsToOtherMembersOfOutputAddresses(arrChains)))});break;case"payment_notification":var current_message_counter=++message_counter,unit=body;if(!ValidationUtils.isStringOfLength(unit,constants.HASH_LENGTH))return callbacks.ifError("invalid unit in payment notification");var bEmitted=!1,emitPn=function(objJoint){bEmitted||(bEmitted=!0,emitNewPublicPaymentReceived(from_address,objJoint.unit,current_message_counter))};eventBus.once("saved_unit-"+unit,emitPn),storage.readJoint(db,unit,{ifNotFound:function(){console.log("received payment notification for unit "+unit+" which is not known yet, will wait for it"),callbacks.ifOk()},ifFound:function(objJoint){emitPn(objJoint),eventBus.removeListener("saved_unit-"+unit,emitPn),callbacks.ifOk()}});break;default:callbacks.ifError("unknnown subject: "+subject)}}function forwardPrivateChainsToOtherMembersOfOutputAddresses(arrChains,conn,onSaved){console.log("forwardPrivateChainsToOtherMembersOfOutputAddresses",arrChains);var assocOutputAddresses={};arrChains.forEach(function(arrPrivateElements){var objHeadPrivateElement=arrPrivateElements[0],payload=objHeadPrivateElement.payload;payload.outputs.forEach(function(output){output.address&&(assocOutputAddresses[output.address]=!0)}),objHeadPrivateElement.output&&objHeadPrivateElement.output.address&&(assocOutputAddresses[objHeadPrivateElement.output.address]=!0)});var arrOutputAddresses=Object.keys(assocOutputAddresses);console.log("output addresses",arrOutputAddresses),conn=conn||db,onSaved||(onSaved=function(){}),readWalletsByAddresses(conn,arrOutputAddresses,function(arrWallets){0===arrWallets.length&&eventBus.emit("nonfatal_error","not my wallet? output addresses: "+arrOutputAddresses.join(", "),new Error);var arrFuncs=[];arrWallets.length>0&&arrFuncs.push(function(cb){walletDefinedByKeys.forwardPrivateChainsToOtherMembersOfWallets(arrChains,arrWallets,conn,cb)}),arrFuncs.push(function(cb){walletDefinedByAddresses.forwardPrivateChainsToOtherMembersOfAddresses(arrChains,arrOutputAddresses,conn,cb)}),async.series(arrFuncs,onSaved)})}function readWalletsByAddresses(conn,arrAddresses,handleWallets){conn.query("SELECT DISTINCT wallet FROM my_addresses WHERE address IN(?)",[arrAddresses],function(rows){var arrWallets=rows.map(function(row){return row.wallet});conn.query("SELECT DISTINCT address FROM shared_address_signing_paths WHERE shared_address IN(?)",[arrAddresses],function(rows){if(0===rows.length)return handleWallets(arrWallets);var arrNewAddresses=rows.map(function(row){return row.address});readWalletsByAddresses(conn,arrNewAddresses,function(arrNewWallets){handleWallets(_.union(arrWallets,arrNewWallets))})})})}function emitNewPrivatePaymentReceived(payer_device_address,arrChains,message_counter){console.log("emitNewPrivatePaymentReceived"),walletGeneral.readMyAddresses(function(arrAddresses){var assocAmountsByAsset={},assocMyReceivingAddresses={};arrChains.forEach(function(arrPrivateElements){var objHeadPrivateElement=arrPrivateElements[0],payload=objHeadPrivateElement.payload,asset=payload.asset||"base";assocAmountsByAsset[asset]||(assocAmountsByAsset[asset]=0),payload.outputs.forEach(function(output){output.address&&arrAddresses.indexOf(output.address)>=0&&(assocAmountsByAsset[asset]+=output.amount,assocMyReceivingAddresses[output.address]=!0)});var output=objHeadPrivateElement.output;output&&output.address&&arrAddresses.indexOf(output.address)>=0&&(assocAmountsByAsset[asset]+=payload.outputs[objHeadPrivateElement.output_index].amount,assocMyReceivingAddresses[output.address]=!0)}),console.log("assocAmountsByAsset",assocAmountsByAsset);var arrMyReceivingAddresses=Object.keys(assocMyReceivingAddresses);0!==arrMyReceivingAddresses.length&&db.query("SELECT 1 FROM shared_addresses WHERE shared_address IN(?)",[arrMyReceivingAddresses],function(rows){var bToSharedAddress=rows.length>0;for(var asset in assocAmountsByAsset)assocAmountsByAsset[asset]&&eventBus.emit("received_payment",payer_device_address,assocAmountsByAsset[asset],asset,message_counter,bToSharedAddress)})})}function emitNewPublicPaymentReceived(payer_device_address,objUnit,message_counter){walletGeneral.readMyAddresses(function(arrAddresses){var assocAmountsByAsset={},assocMyReceivingAddresses={};objUnit.messages.forEach(function(message){if("payment"===message.app&&message.payload){var payload=message.payload,asset=payload.asset||"base";assocAmountsByAsset[asset]||(assocAmountsByAsset[asset]=0),payload.outputs.forEach(function(output){output.address&&arrAddresses.indexOf(output.address)>=0&&(assocAmountsByAsset[asset]+=output.amount,assocMyReceivingAddresses[output.address]=!0)})}});var arrMyReceivingAddresses=Object.keys(assocMyReceivingAddresses);0!==arrMyReceivingAddresses.length&&db.query("SELECT 1 FROM shared_addresses WHERE shared_address IN(?)",[arrMyReceivingAddresses],function(rows){var bToSharedAddress=rows.length>0;for(var asset in assocAmountsByAsset)assocAmountsByAsset[asset]&&eventBus.emit("received_payment",payer_device_address,assocAmountsByAsset[asset],asset,message_counter,bToSharedAddress)})})}function findAddress(address,signing_path,callbacks,fallback_remote_device_address){db.query("SELECT wallet, account, is_change, address_index, full_approval_date, device_address \n\t\tFROM my_addresses JOIN wallets USING(wallet) JOIN wallet_signing_paths USING(wallet) \n\t\tWHERE address=? AND signing_path=?",[address,signing_path],function(rows){if(rows.length>1)throw Error("more than 1 address found");if(1===rows.length){var row=rows[0];if(!row.full_approval_date)return callbacks.ifError("wallet of address "+address+" not approved");if(row.device_address!==device.getMyDeviceAddress())return callbacks.ifRemote(row.device_address);var objAddress={address:address,wallet:row.wallet,account:row.account,is_change:row.is_change,address_index:row.address_index};return void callbacks.ifLocal(objAddress)}db.query("SELECT address, device_address, signing_path FROM shared_address_signing_paths \n\t\t\t\tWHERE shared_address=? AND signing_path=SUBSTR(?, 1, LENGTH(signing_path))",[address,signing_path],function(sa_rows){if(rows.length>1)throw Error("more than 1 member address found for shared address "+address+" and signing path "+signing_path);if(0===sa_rows.length)return fallback_remote_device_address?callbacks.ifRemote(fallback_remote_device_address):callbacks.ifUnknownAddress();var objSharedAddress=sa_rows[0],relative_signing_path="r"+signing_path.substr(objSharedAddress.signing_path.length),bLocal=objSharedAddress.device_address===device.getMyDeviceAddress();return""===objSharedAddress.address?callbacks.ifMerkle(bLocal):void findAddress(objSharedAddress.address,relative_signing_path,callbacks,bLocal?null:objSharedAddress.device_address)})})}function readSharedBalance(wallet,handleBalance){balances.readSharedBalance(wallet,handleBalance)}function readBalance(wallet,handleBalance){balances.readBalance(wallet,function(assocBalances){if(handleBalance(assocBalances),conf.bLight){var arrAssets=Object.keys(assocBalances).filter(function(asset){return"base"!==asset});if(0===arrAssets.length)return;network.requestProofsOfJointsIfNewOrUnstable(arrAssets)}})}function readBalancesOnAddresses(walletId,handleBalancesOnAddresses){db.query("SELECT outputs.address, COALESCE(outputs.asset, 'base') as asset, sum(outputs.amount) as amount \n\tFROM outputs, my_addresses \n\tWHERE outputs.address = my_addresses.address AND my_addresses.wallet = ? AND outputs.is_spent=0 \n\tGROUP BY outputs.address, outputs.asset \n\tORDER BY my_addresses.address_index ASC",[walletId],function(rows){handleBalancesOnAddresses(rows)})}function readTransactionHistory(opts,handleHistory){var asset=opts.asset;if(opts.wallet&&opts.address||!opts.wallet&&!opts.address)throw Error("invalid wallet and address params");var wallet=opts.wallet||opts.address,walletIsAddress=ValidationUtils.isValidAddress(wallet),join_my_addresses=walletIsAddress?"":"JOIN my_addresses USING(address)",where_condition=walletIsAddress?"address=?":"wallet=?",asset_condition=asset&&"base"!==asset?"asset="+db.escape(asset):"asset IS NULL",cross="";opts.unit?where_condition+=" AND unit="+db.escape(opts.unit):opts.since_mci&&ValidationUtils.isNonnegativeInteger(opts.since_mci)&&(where_condition+=" AND main_chain_index>="+opts.since_mci,cross="CROSS"),db.query("SELECT unit, level, is_stable, sequence, address, \n\t\t\t"+db.getUnixTimestamp("units.creation_date")+" AS ts, headers_commission+payload_commission AS fee, \n\t\t\tSUM(amount) AS amount, address AS to_address, NULL AS from_address, main_chain_index AS mci \n\t\tFROM units "+cross+" JOIN outputs USING(unit) "+join_my_addresses+" \n\t\tWHERE "+where_condition+" AND "+asset_condition+" \n\t\tGROUP BY unit, address \n\t\tUNION \n\t\tSELECT unit, level, is_stable, sequence, address, \n\t\t\t"+db.getUnixTimestamp("units.creation_date")+" AS ts, headers_commission+payload_commission AS fee, \n\t\t\tNULL AS amount, NULL AS to_address, address AS from_address, main_chain_index AS mci \n\t\tFROM units "+cross+" JOIN inputs USING(unit) "+join_my_addresses+" \n\t\tWHERE "+where_condition+" AND "+asset_condition+" \n\t\tORDER BY ts DESC"+(opts.limit?" LIMIT ?":""),opts.limit?[wallet,wallet,opts.limit]:[wallet,wallet],function(rows){for(var assocMovements={},i=0;i<rows.length;i++){var row=rows[i];assocMovements[row.unit]||(assocMovements[row.unit]={plus:0,has_minus:!1,ts:row.ts,level:row.level,is_stable:row.is_stable,sequence:row.sequence,fee:row.fee,mci:row.mci}),row.to_address&&(assocMovements[row.unit].plus+=row.amount,assocMovements[row.unit].arrMyRecipients||(assocMovements[row.unit].arrMyRecipients=[]),assocMovements[row.unit].arrMyRecipients.push({my_address:row.to_address,amount:row.amount})),row.from_address&&(assocMovements[row.unit].has_minus=!0)}var arrTransactions=[];async.forEachOfSeries(assocMovements,function(movement,unit,cb){if("good"!==movement.sequence){var transaction={action:"invalid",confirmations:movement.is_stable,unit:unit,fee:movement.fee,time:movement.ts,level:movement.level,mci:movement.mci};arrTransactions.push(transaction),cb()}else if(movement.plus&&!movement.has_minus)db.query("SELECT DISTINCT address FROM inputs WHERE unit=? AND "+asset_condition+" ORDER BY address",[unit],function(address_rows){var arrPayerAddresses=address_rows.map(function(address_row){return address_row.address});movement.arrMyRecipients.forEach(function(objRecipient){var transaction={action:"received",amount:objRecipient.amount,my_address:objRecipient.my_address,arrPayerAddresses:arrPayerAddresses,confirmations:movement.is_stable,unit:unit,fee:movement.fee,time:movement.ts,level:movement.level,mci:movement.mci};arrTransactions.push(transaction)}),cb()});else if(movement.has_minus){var queryString,parameters;walletIsAddress?(queryString="SELECT address, SUM(amount) AS amount, (address!=?) AS is_external \n\t\t\t\t\t\t\t\t\t\t\tFROM outputs \n\t\t\t\t\t\t\t\t\t\t\tWHERE unit=? AND "+asset_condition+" \n\t\t\t\t\t\t\t\t\t\t\tGROUP BY address",parameters=[wallet,unit]):(queryString="SELECT outputs.address, SUM(amount) AS amount, (my_addresses.address IS NULL) AS is_external \n\t\t\t\t\t\t\t\t\t\t\tFROM outputs \n\t\t\t\t\t\t\t\t\t\t\tLEFT JOIN my_addresses ON outputs.address=my_addresses.address AND wallet=? \n\t\t\t\t\t\t\t\t\t\t\tWHERE unit=? AND "+asset_condition+" \n\t\t\t\t\t\t\t\t\t\t\tGROUP BY outputs.address",parameters=[wallet,unit]),db.query(queryString,parameters,function(payee_rows){for(var action=payee_rows.some(function(payee){return payee.is_external})?"sent":"moved",i=0;i<payee_rows.length;i++){var payee=payee_rows[i];if("sent"!==action||payee.is_external){var transaction={action:action,amount:payee.amount,addressTo:payee.address,confirmations:movement.is_stable,unit:unit,fee:movement.fee,time:movement.ts,level:movement.level,mci:movement.mci};"moved"===action&&(transaction.my_address=payee.address),arrTransactions.push(transaction)}}cb()})}},function(){arrTransactions.sort(function(a,b){return a.level<b.level?1:a.level>b.level?-1:a.time<b.time?1:a.time>b.time?-1:0}),arrTransactions.forEach(function(transaction){transaction.asset=asset}),handleHistory(arrTransactions)})})}function readFullSigningPaths(conn,address,arrSigningDeviceAddresses,handleSigningPaths){function goDeeper(member_address,path_prefix,onDone){var sql="SELECT signing_path FROM my_addresses JOIN wallet_signing_paths USING(wallet) WHERE address=?",arrParams=[member_address];arrSigningDeviceAddresses&&arrSigningDeviceAddresses.length>0&&(sql+=" AND device_address IN(?)",arrParams.push(arrSigningDeviceAddresses)),conn.query(sql,arrParams,function(rows){return rows.forEach(function(row){assocSigningPaths[path_prefix+row.signing_path.substr(1)]="key"}),rows.length>0?onDone():(sql="SELECT signing_path, address FROM shared_address_signing_paths WHERE shared_address=?",arrParams=[member_address],arrSigningDeviceAddresses&&arrSigningDeviceAddresses.length>0&&(sql+=" AND device_address IN(?)",arrParams.push(arrSigningDeviceAddresses)),void conn.query(sql,arrParams,function(rows){rows.length>0?async.eachSeries(rows,function(row,cb){return""===row.address?(assocSigningPaths[path_prefix+row.signing_path.substr(1)]="merkle",cb()):void goDeeper(row.address,path_prefix+row.signing_path.substr(1),cb)},onDone):(assocSigningPaths[path_prefix]="key",onDone())}))})}var assocSigningPaths={};goDeeper(address,"r",function(){handleSigningPaths(assocSigningPaths)})}function determineIfFixedDenominations(asset,handleResult){return asset?void storage.readAsset(db,asset,null,function(err,objAsset){if(err)throw Error(err);handleResult(objAsset.fixed_denominations)}):handleResult(!1)}function readFundedAddresses(asset,wallet,estimated_amount,handleFundedAddresses){var walletIsAddresses=ValidationUtils.isNonemptyArray(wallet);if(walletIsAddresses)return composer.readSortedFundedAddresses(asset,wallet,estimated_amount,handleFundedAddresses);if(estimated_amount&&"number"!=typeof estimated_amount)throw Error("invalid estimated amount: "+estimated_amount);var order_by=estimated_amount?"(SUM(amount)>"+estimated_amount+") DESC, ABS(SUM(amount)-"+estimated_amount+") ASC":"SUM(amount) DESC";db.query("SELECT address, SUM(amount) AS total \n\t\tFROM outputs JOIN my_addresses USING(address) \n\t\tCROSS JOIN units USING(unit) \n\t\tWHERE wallet=? AND is_stable=1 AND sequence='good' AND is_spent=0 AND "+(asset?"asset=?":"asset IS NULL")+" \n\t\t\tAND NOT EXISTS ( \n\t\t\t\tSELECT * FROM unit_authors JOIN units USING(unit) \n\t\t\t\tWHERE is_stable=0 AND unit_authors.address=outputs.address AND definition_chash IS NOT NULL \n\t\t\t) \n\t\tGROUP BY address ORDER BY "+order_by,asset?[wallet,asset]:[wallet],function(rows){determineIfFixedDenominations(asset,function(bFixedDenominations){bFixedDenominations&&(estimated_amount=0),handleFundedAddresses(composer.filterMostFundedAddresses(rows,estimated_amount))})})}function readAdditionalSigningAddresses(arrPayingAddresses,arrSigningAddresses,arrSigningDeviceAddresses,handleAdditionalSigningAddresses){var arrFromAddresses=arrPayingAddresses.concat(arrSigningAddresses),sql="SELECT DISTINCT address FROM shared_address_signing_paths \n\t\tWHERE shared_address IN(?) \n\t\t\tAND ( \n\t\t\t\tEXISTS (SELECT 1 FROM my_addresses WHERE my_addresses.address=shared_address_signing_paths.address) \n\t\t\t\tOR \n\t\t\t\tEXISTS (SELECT 1 FROM shared_addresses WHERE shared_addresses.shared_address=shared_address_signing_paths.address) \n\t\t\t) \n\t\t\tAND ( \n\t\t\t\tNOT EXISTS (SELECT 1 FROM addresses WHERE addresses.address=shared_address_signing_paths.address) \n\t\t\t\tOR ( \n\t\t\t\t\tSELECT definition \n\t\t\t\t\tFROM address_definition_changes CROSS JOIN units USING(unit) LEFT JOIN definitions USING(definition_chash) \n\t\t\t\t\tWHERE address_definition_changes.address=shared_address_signing_paths.address AND is_stable=1 AND sequence='good' \n\t\t\t\t\tORDER BY level DESC LIMIT 1 \n\t\t\t\t) IS NULL \n\t\t\t)",arrParams=[arrFromAddresses];arrSigningAddresses.length>0&&(sql+=" AND address NOT IN(?)",arrParams.push(arrSigningAddresses)),arrSigningDeviceAddresses&&arrSigningDeviceAddresses.length>0&&(sql+=" AND device_address IN(?)",arrParams.push(arrSigningDeviceAddresses)),db.query(sql,arrParams,function(rows){var arrAdditionalAddresses=rows.map(function(row){return row.address});return 0===arrAdditionalAddresses.length?handleAdditionalSigningAddresses([]):void readAdditionalSigningAddresses([],arrSigningAddresses.concat(arrAdditionalAddresses),arrSigningDeviceAddresses,function(arrMoreAddresses){handleAdditionalSigningAddresses(arrAdditionalAddresses.concat(arrMoreAddresses))})})}function readFundedAndSigningAddresses(asset,wallet,estimated_amount,fee_paying_wallet,arrSigningAddresses,arrSigningDeviceAddresses,handleFundedAndSigningAddresses){readFundedAddresses(asset,wallet,estimated_amount,function(arrFundedAddresses){if(0===arrFundedAddresses.length)return handleFundedAndSigningAddresses([],[],[]);var arrBaseFundedAddresses=[],addSigningAddressesAndReturn=function(){var arrPayingAddresses=_.union(arrFundedAddresses,arrBaseFundedAddresses);readAdditionalSigningAddresses(arrPayingAddresses,arrSigningAddresses,arrSigningDeviceAddresses,function(arrAdditionalAddresses){handleFundedAndSigningAddresses(arrFundedAddresses,arrBaseFundedAddresses,arrSigningAddresses.concat(arrAdditionalAddresses))})};return asset?void readFundedAddresses(null,wallet,TYPICAL_FEE,function(_arrBaseFundedAddresses){return _arrBaseFundedAddresses.length>0||!fee_paying_wallet||fee_paying_wallet===wallet?(arrBaseFundedAddresses=_arrBaseFundedAddresses,addSigningAddressesAndReturn()):void readFundedAddresses(null,fee_paying_wallet,TYPICAL_FEE,function(_arrBaseFundedAddresses){arrBaseFundedAddresses=_arrBaseFundedAddresses,addSigningAddressesAndReturn()})}):addSigningAddressesAndReturn()})}function sendPaymentFromWallet(asset,wallet,to_address,amount,change_address,arrSigningDeviceAddresses,recipient_device_address,signWithLocalPrivateKey,handleResult){sendMultiPayment({asset:asset,wallet:wallet,to_address:to_address,amount:amount,change_address:change_address,arrSigningDeviceAddresses:arrSigningDeviceAddresses,recipient_device_address:recipient_device_address,signWithLocalPrivateKey:signWithLocalPrivateKey},handleResult)}function sendMultiPayment(opts,handleResult){var asset=opts.asset;"base"===asset&&(asset=null);var wallet=opts.wallet,arrPayingAddresses=opts.paying_addresses,fee_paying_wallet=opts.fee_paying_wallet,arrSigningAddresses=opts.signing_addresses||[],to_address=opts.to_address,amount=opts.amount,bSendAll=opts.send_all,change_address=opts.change_address,arrSigningDeviceAddresses=opts.arrSigningDeviceAddresses,recipient_device_address=opts.recipient_device_address,signWithLocalPrivateKey=opts.signWithLocalPrivateKey,merkle_proof=opts.merkle_proof,base_outputs=opts.base_outputs,asset_outputs=opts.asset_outputs,messages=opts.messages;if(!wallet&&!arrPayingAddresses)throw Error("neither wallet id nor paying addresses");if(wallet&&arrPayingAddresses)throw Error("both wallet id and paying addresses");if((to_address||amount)&&(base_outputs||asset_outputs))throw Error("to_address and outputs at the same time");if(!asset&&asset_outputs)throw Error("base asset and asset outputs");if(amount){if("number"!=typeof amount)throw Error("amount must be a number");if(amount<0)throw Error("amount must be positive")}var estimated_amount=amount;!estimated_amount&&asset_outputs&&(estimated_amount=asset_outputs.reduce(function(acc,output){return acc+output.amount},0)),estimated_amount&&!asset&&(estimated_amount+=TYPICAL_FEE),readFundedAndSigningAddresses(asset,wallet||arrPayingAddresses,estimated_amount,fee_paying_wallet,arrSigningAddresses,arrSigningDeviceAddresses,function(arrFundedAddresses,arrBaseFundedAddresses,arrAllSigningAddresses){if(0===arrFundedAddresses.length)return handleResult("There are no funded addresses");if(asset&&0===arrBaseFundedAddresses.length)return handleResult("No bytes to pay fees");var bRequestedConfirmation=!1,signer={readSigningPaths:function(conn,address,handleLengthsBySigningPaths){readFullSigningPaths(conn,address,arrSigningDeviceAddresses,function(assocTypesBySigningPaths){var assocLengthsBySigningPaths={};for(var signing_path in assocTypesBySigningPaths){var type=assocTypesBySigningPaths[signing_path];if("key"===type)assocLengthsBySigningPaths[signing_path]=constants.SIG_LENGTH;else{if("merkle"!==type)throw Error("unknown type "+type+" at "+signing_path);merkle_proof&&(assocLengthsBySigningPaths[signing_path]=merkle_proof.length)}}handleLengthsBySigningPaths(assocLengthsBySigningPaths)})},readDefinition:function(conn,address,handleDefinition){conn.query("SELECT definition FROM my_addresses WHERE address=? UNION SELECT definition FROM shared_addresses WHERE shared_address=?",[address,address],function(rows){if(1!==rows.length)throw Error("definition not found");handleDefinition(null,JSON.parse(rows[0].definition))})},sign:function(objUnsignedUnit,assocPrivatePayloads,address,signing_path,handleSignature){var buf_to_sign=objectHash.getUnitHashToSign(objUnsignedUnit);findAddress(address,signing_path,{ifError:function(err){throw Error(err)},ifUnknownAddress:function(err){throw Error("unknown address "+address+" at "+signing_path)},ifLocal:function(objAddress){signWithLocalPrivateKey(objAddress.wallet,objAddress.account,objAddress.is_change,objAddress.address_index,buf_to_sign,function(sig){handleSignature(null,sig)})},ifRemote:function(device_address){eventBus.once("signature-"+device_address+"-"+address+"-"+signing_path+"-"+buf_to_sign.toString("base64"),function(sig){handleSignature(null,sig),"[refused]"===sig&&eventBus.emit("refused_to_sign",device_address)}),walletGeneral.sendOfferToSign(device_address,address,signing_path,objUnsignedUnit,assocPrivatePayloads),bRequestedConfirmation||(eventBus.emit("confirm_on_other_devices"),bRequestedConfirmation=!0)},ifMerkle:function(bLocal){if(!bLocal)throw Error("merkle proof at path "+signing_path+" should be provided by another device");if(!merkle_proof)throw Error("merkle proof at path "+signing_path+" not provided");handleSignature(null,merkle_proof)}})}},params={available_paying_addresses:arrFundedAddresses,signing_addresses:arrAllSigningAddresses,messages:messages,signer:signer,callbacks:{ifNotEnoughFunds:function(err){handleResult(err)},ifError:function(err){handleResult(err)},ifOk:function(objJoint,arrChainsOfRecipientPrivateElements,arrChainsOfCosignerPrivateElements){network.broadcastJoint(objJoint),!arrChainsOfRecipientPrivateElements&&recipient_device_address&&walletGeneral.sendPaymentNotification(recipient_device_address,objJoint.unit.unit),handleResult(null,objJoint.unit.unit)}}};if(asset){if(bSendAll)throw Error("send_all with asset");params.asset=asset,params.available_fee_paying_addresses=arrBaseFundedAddresses,to_address?(params.to_address=to_address,params.amount=amount):(params.asset_outputs=asset_outputs,params.base_outputs=base_outputs),params.change_address=change_address,storage.readAsset(db,asset,null,function(err,objAsset){if(err)throw Error(err);objAsset.is_private&&(params.callbacks.preCommitCb=function(conn,arrChainsOfRecipientPrivateElements,arrChainsOfCosignerPrivateElements,cb){if(!arrChainsOfRecipientPrivateElements||!arrChainsOfCosignerPrivateElements)throw Error("no private elements");var sendToRecipients=function(cb2){recipient_device_address?walletGeneral.sendPrivatePayments(recipient_device_address,arrChainsOfRecipientPrivateElements,!1,conn,cb2):forwardPrivateChainsToOtherMembersOfOutputAddresses(arrChainsOfRecipientPrivateElements,conn,cb2)},sendToCosigners=function(cb2){wallet?walletDefinedByKeys.forwardPrivateChainsToOtherMembersOfWallets(arrChainsOfCosignerPrivateElements,[wallet],conn,cb2):walletDefinedByAddresses.forwardPrivateChainsToOtherMembersOfAddresses(arrChainsOfCosignerPrivateElements,arrPayingAddresses,conn,cb2)};async.series([sendToRecipients,sendToCosigners],cb)}),objAsset.fixed_denominations?(params.tolerance_plus=0,params.tolerance_minus=0,indivisibleAsset.composeAndSaveMinimalIndivisibleAssetPaymentJoint(params)):divisibleAsset.composeAndSaveMinimalDivisibleAssetPaymentJoint(params)})}else bSendAll?(params.send_all=bSendAll,params.outputs=[{address:to_address,amount:0}]):(params.outputs=to_address?[{address:to_address,amount:amount}]:base_outputs||[],params.outputs.push({address:change_address,amount:0})),composer.composeAndSaveMinimalJoint(params)})}function readDeviceAddressesUsedInSigningPaths(onDone){var sql="SELECT DISTINCT device_address FROM shared_address_signing_paths ";sql+="UNION SELECT DISTINCT device_address FROM wallet_signing_paths ",
sql+="UNION SELECT DISTINCT device_address FROM pending_shared_address_signing_paths",db.query(sql,function(rows){var arrDeviceAddress=rows.map(function(r){return r.device_address});onDone(arrDeviceAddress)})}function determineIfDeviceCanBeRemoved(device_address,handleResult){device.readCorrespondent(device_address,function(correspondent){return correspondent?void readDeviceAddressesUsedInSigningPaths(function(arrDeviceAddresses){handleResult(arrDeviceAddresses.indexOf(device_address)===-1)}):handleResult(!1)})}var async=require("async"),_=require("lodash"),db=require("./db.js"),constants=require("./constants.js"),conf=require("./conf.js"),mutex=require("./mutex.js"),objectHash=require("./object_hash.js"),ecdsaSig=require("./signature.js"),network=require("./network.js"),storage=require("./storage.js"),device=require("./device.js"),walletGeneral=require("./wallet_general.js"),lightWallet=require("./light_wallet.js"),walletDefinedByKeys=require("./wallet_defined_by_keys.js"),walletDefinedByAddresses=require("./wallet_defined_by_addresses.js"),eventBus=require("./event_bus.js"),ValidationUtils=require("./validation_utils.js"),composer=require("./composer.js"),indivisibleAsset=require("./indivisible_asset.js"),divisibleAsset=require("./divisible_asset.js"),profiler=require("./profiler.js"),balances=(require("./breadcrumbs.js"),require("./balances")),message_counter=0;eventBus.on("message_from_hub",handleJustsaying),eventBus.on("message_for_light",handleJustsaying),eventBus.on("new_direct_private_chains",forwardPrivateChainsToOtherMembersOfOutputAddresses);var TYPICAL_FEE=1e3;exports.sendSignature=sendSignature,exports.readSharedBalance=readSharedBalance,exports.readBalance=readBalance,exports.readBalancesOnAddresses=readBalancesOnAddresses,exports.readTransactionHistory=readTransactionHistory,exports.sendPaymentFromWallet=sendPaymentFromWallet,exports.sendMultiPayment=sendMultiPayment,exports.readDeviceAddressesUsedInSigningPaths=readDeviceAddressesUsedInSigningPaths,exports.determineIfDeviceCanBeRemoved=determineIfDeviceCanBeRemoved},{"./balances":363,"./breadcrumbs.js":365,"./composer.js":369,"./conf.js":370,"./constants.js":371,"./db.js":372,"./device.js":375,"./divisible_asset.js":376,"./event_bus.js":378,"./indivisible_asset.js":381,"./light_wallet.js":384,"./mutex.js":388,"./network.js":391,"./object_hash.js":392,"./profiler.js":398,"./signature.js":399,"./storage.js":402,"./validation_utils.js":405,"./wallet_defined_by_addresses.js":407,"./wallet_defined_by_keys.js":408,"./wallet_general.js":409,async:26,lodash:271}],407:[function(require,module,exports){"use strict";function sendOfferToCreateNewSharedAddress(device_address,arrAddressDefinitionTemplate){device.sendMessageToDevice(device_address,"create_new_shared_address",{address_definition_template:arrAddressDefinitionTemplate})}function sendNewSharedAddress(device_address,address,arrDefinition,assocSignersByPath,bForwarded){device.sendMessageToDevice(device_address,"new_shared_address",{address:address,definition:arrDefinition,signers:assocSignersByPath,forwarded:bForwarded})}function createNewSharedAddressByTemplate(arrAddressDefinitionTemplate,my_address,assocMyDeviceAddressesByRelativeSigningPaths){validateAddressDefinitionTemplate(arrAddressDefinitionTemplate,device.getMyDeviceAddress(),function(err,assocMemberDeviceAddressesBySigningPaths){if(err)throw Error(err);var arrMemberSigningPaths=Object.keys(assocMemberDeviceAddressesBySigningPaths),address_definition_template_chash=objectHash.getChash160(arrAddressDefinitionTemplate);db.query("INSERT INTO pending_shared_addresses (definition_template_chash, definition_template) VALUES(?,?)",[address_definition_template_chash,JSON.stringify(arrAddressDefinitionTemplate)],function(){async.eachSeries(arrMemberSigningPaths,function(signing_path,cb){var device_address=assocMemberDeviceAddressesBySigningPaths[signing_path],fields="definition_template_chash, device_address, signing_path",values="?,?,?",arrParams=[address_definition_template_chash,device_address,signing_path];device_address===device.getMyDeviceAddress()&&(fields+=", address, device_addresses_by_relative_signing_paths, approval_date",values+=",?,?,"+db.getNow(),arrParams.push(my_address,JSON.stringify(assocMyDeviceAddressesByRelativeSigningPaths))),db.query("INSERT INTO pending_shared_address_signing_paths ("+fields+") VALUES("+values+")",arrParams,function(){cb()})},function(){var arrMemberDeviceAddresses=_.uniq(_.values(assocMemberDeviceAddressesBySigningPaths));arrMemberDeviceAddresses.forEach(function(device_address){device_address!==device.getMyDeviceAddress()&&sendOfferToCreateNewSharedAddress(device_address,arrAddressDefinitionTemplate)})})})})}function approvePendingSharedAddress(address_definition_template_chash,from_address,address,assocDeviceAddressesByRelativeSigningPaths){db.query("UPDATE pending_shared_address_signing_paths SET address=?, device_addresses_by_relative_signing_paths=?, approval_date="+db.getNow()+" \n\t\tWHERE definition_template_chash=? AND device_address=?",[address,JSON.stringify(assocDeviceAddressesByRelativeSigningPaths),address_definition_template_chash,from_address],function(){db.query("SELECT device_address, signing_path, address, device_addresses_by_relative_signing_paths \n\t\t\t\tFROM pending_shared_address_signing_paths \n\t\t\t\tWHERE definition_template_chash=?",[address_definition_template_chash],function(rows){if(0!==rows.length&&!rows.some(function(row){return!row.address})){var params={};rows.forEach(function(row){params["address@"+row.device_address]=row.address}),db.query("SELECT definition_template FROM pending_shared_addresses WHERE definition_template_chash=?",[address_definition_template_chash],function(templ_rows){if(1!==templ_rows.length)throw Error("template not found");var arrAddressDefinitionTemplate=JSON.parse(templ_rows[0].definition_template),arrDefinition=Definition.replaceInTemplate(arrAddressDefinitionTemplate,params),shared_address=objectHash.getChash160(arrDefinition);db.query("INSERT INTO shared_addresses (shared_address, definition) VALUES (?,?)",[shared_address,JSON.stringify(arrDefinition)],function(){var arrQueries=[],assocSignersByPath={};rows.forEach(function(row){var assocDeviceAddressesByRelativeSigningPaths=JSON.parse(row.device_addresses_by_relative_signing_paths);for(var member_signing_path in assocDeviceAddressesByRelativeSigningPaths){var full_signing_path=(assocDeviceAddressesByRelativeSigningPaths[member_signing_path],row.signing_path+member_signing_path.substring(1));db.addQuery(arrQueries,"INSERT INTO shared_address_signing_paths \n\t\t\t\t\t\t\t\t\t\t\t\t(shared_address, address, signing_path, member_signing_path, device_address) VALUES(?,?,?,?,?)",[shared_address,row.address,full_signing_path,member_signing_path,row.device_address]),assocSignersByPath[full_signing_path]={device_address:row.device_address,address:row.address,member_signing_path:member_signing_path}}}),async.series(arrQueries,function(){deletePendingSharedAddress(address_definition_template_chash),rows.forEach(function(row){row.device_address!==device.getMyDeviceAddress()&&sendNewSharedAddress(row.device_address,shared_address,arrDefinition,assocSignersByPath)}),forwardNewSharedAddressToCosignersOfMyMemberAddresses(shared_address,arrDefinition,assocSignersByPath),conf.bLight&&network.addLightWatchedAddress(shared_address)})})})}})})}function deletePendingSharedAddress(address_definition_template_chash){db.query("DELETE FROM pending_shared_address_signing_paths WHERE definition_template_chash=?",[address_definition_template_chash],function(){db.query("DELETE FROM pending_shared_addresses WHERE definition_template_chash=?",[address_definition_template_chash],function(){})})}function addNewSharedAddress(address,arrDefinition,assocSignersByPath,bForwarded,onDone){db.query("INSERT "+db.getIgnore()+" INTO shared_addresses (shared_address, definition) VALUES (?,?)",[address,JSON.stringify(arrDefinition)],function(){var arrQueries=[];for(var signing_path in assocSignersByPath){var signerInfo=assocSignersByPath[signing_path];db.addQuery(arrQueries,"INSERT "+db.getIgnore()+" INTO shared_address_signing_paths \n\t\t\t\t\t(shared_address, address, signing_path, member_signing_path, device_address) VALUES (?,?,?,?,?)",[address,signerInfo.address,signing_path,signerInfo.member_signing_path,signerInfo.device_address])}async.series(arrQueries,function(){console.log("added new shared address "+address),eventBus.emit("new_address-"+address),conf.bLight&&network.addLightWatchedAddress(address),bForwarded||forwardNewSharedAddressToCosignersOfMyMemberAddresses(address,arrDefinition,assocSignersByPath),onDone&&onDone()})})}function includesMyDeviceAddress(assocSignersByPath){for(var signing_path in assocSignersByPath){var signerInfo=assocSignersByPath[signing_path];if(signerInfo.device_address===device.getMyDeviceAddress())return!0}return!1}function determineIfIncludesMe(assocSignersByPath,handleResult){var assocMemberAddresses={};for(var signing_path in assocSignersByPath){var signerInfo=assocSignersByPath[signing_path];signerInfo.address&&(assocMemberAddresses[signerInfo.address]=!0)}var arrMemberAddresses=Object.keys(assocMemberAddresses);return 0===arrMemberAddresses.length?handleResult("no member addresses?"):void db.query("SELECT address FROM my_addresses WHERE address IN(?) UNION SELECT shared_address AS address FROM shared_addresses WHERE shared_address IN(?)",[arrMemberAddresses,arrMemberAddresses],function(rows){handleResult(rows.length>0?null:"I am not a member of this shared address")})}function forwardNewSharedAddressToCosignersOfMyMemberAddresses(address,arrDefinition,assocSignersByPath){var assocMyMemberAddresses={};for(var signing_path in assocSignersByPath){var signerInfo=assocSignersByPath[signing_path];signerInfo.device_address===device.getMyDeviceAddress()&&signerInfo.address&&(assocMyMemberAddresses[signerInfo.address]=!0)}var arrMyMemberAddresses=Object.keys(assocMyMemberAddresses);if(0===arrMyMemberAddresses.length)throw Error("my member addresses not found");db.query("SELECT DISTINCT device_address FROM my_addresses JOIN wallet_signing_paths USING(wallet) WHERE address IN(?) AND device_address!=?",[arrMyMemberAddresses,device.getMyDeviceAddress()],function(rows){rows.forEach(function(row){sendNewSharedAddress(row.device_address,address,arrDefinition,assocSignersByPath,!0)})})}function handleNewSharedAddress(body,callbacks){if(!ValidationUtils.isArrayOfLength(body.definition,2))return callbacks.ifError("invalid definition");if("object"!=typeof body.signers||0===Object.keys(body.signers).length)return callbacks.ifError("invalid signers");if(body.address!==objectHash.getChash160(body.definition))return callbacks.ifError("definition doesn't match its c-hash");for(var signing_path in body.signers){var signerInfo=body.signers[signing_path];if(signerInfo.address&&!ValidationUtils.isValidAddress(signerInfo.address))return callbacks.ifError("invalid member address: "+signerInfo.address)}determineIfIncludesMe(body.signers,function(err){return err?callbacks.ifError(err):void validateAddressDefinition(body.definition,function(err){return err?callbacks.ifError(err):void addNewSharedAddress(body.address,body.definition,body.signers,body.forwarded,callbacks.ifOk)})})}function createNewSharedAddress(arrDefinition,assocSignersByPath,callbacks){if(!includesMyDeviceAddress(assocSignersByPath))return callbacks.ifError("my device address not mentioned");var address=objectHash.getChash160(arrDefinition);handleNewSharedAddress({address:address,definition:arrDefinition,signers:assocSignersByPath},{ifError:callbacks.ifError,ifOk:function(){var arrDeviceAddresses=[];for(var signing_path in assocSignersByPath){var signerInfo=assocSignersByPath[signing_path];signerInfo.device_address!==device.getMyDeviceAddress()&&arrDeviceAddresses.indexOf(signerInfo.device_address)===-1&&arrDeviceAddresses.push(signerInfo.device_address)}arrDeviceAddresses.forEach(function(device_address){sendNewSharedAddress(device_address,address,arrDefinition,assocSignersByPath)}),callbacks.ifOk(address)}})}function getMemberDeviceAddressesBySigningPaths(arrAddressDefinitionTemplate){function evaluate(arr,path){var op=arr[0],args=arr[1];if(args)switch(op){case"or":case"and":for(var i=0;i<args.length;i++)evaluate(args[i],path+"."+i);break;case"r of set":if(!ValidationUtils.isNonemptyArray(args.set))return;for(var i=0;i<args.set.length;i++)evaluate(args.set[i],path+"."+i);break;case"weighted and":if(!ValidationUtils.isNonemptyArray(args.set))return;for(var i=0;i<args.set.length;i++)evaluate(args.set[i].value,path+"."+i);break;case"address":var address=args,prefix="$address@";if(!ValidationUtils.isNonemptyString(address)||address.substr(0,prefix.length)!==prefix)return;var device_address=address.substr(prefix.length);assocMemberDeviceAddressesBySigningPaths[path]=device_address;break;case"definition template":throw Error(op+" not supported yet")}}var assocMemberDeviceAddressesBySigningPaths={};return evaluate(arrAddressDefinitionTemplate,"r"),assocMemberDeviceAddressesBySigningPaths}function validateAddressDefinitionTemplate(arrDefinitionTemplate,from_address,handleResult){var assocMemberDeviceAddressesBySigningPaths=getMemberDeviceAddressesBySigningPaths(arrDefinitionTemplate),arrDeviceAddresses=_.uniq(_.values(assocMemberDeviceAddressesBySigningPaths));if(arrDeviceAddresses.length<2)return handleResult("less than 2 member devices");if(arrDeviceAddresses.indexOf(device.getMyDeviceAddress())===-1)return handleResult("my device address not mentioned in the definition");if(arrDeviceAddresses.indexOf(from_address)===-1)return handleResult("sender device address not mentioned in the definition");var params={},fake_address=device.getMyDeviceAddress().substr(1);arrDeviceAddresses.forEach(function(device_address){params["address@"+device_address]=fake_address});try{var arrFakeDefinition=Definition.replaceInTemplate(arrDefinitionTemplate,params)}catch(e){return handleResult(e.toString())}var objFakeUnit={authors:[{address:fake_address,definition:["sig",{pubkey:device.getMyDevicePubKey()}]}]},objFakeValidationState={last_ball_mci:MAX_INT32};Definition.validateDefinition(db,arrFakeDefinition,objFakeUnit,objFakeValidationState,!1,function(err){return err?handleResult(err):void handleResult(null,assocMemberDeviceAddressesBySigningPaths)})}function validateAddressDefinition(arrDefinition,handleResult){var objFakeUnit={authors:[]},objFakeValidationState={last_ball_mci:MAX_INT32,bAllowUnresolvedInnerDefinitions:!0};Definition.validateDefinition(db,arrDefinition,objFakeUnit,objFakeValidationState,!1,function(err){return err?handleResult(err):void handleResult()})}function forwardPrivateChainsToOtherMembersOfAddresses(arrChains,arrAddresses,conn,onSaved){conn=conn||db,conn.query("SELECT device_address FROM shared_address_signing_paths WHERE shared_address IN(?) AND device_address!=?",[arrAddresses,device.getMyDeviceAddress()],function(rows){console.log("shared address devices: "+rows.length),async.eachSeries(rows,function(row,cb){console.log("forwarding to device "+row.device_address),walletGeneral.sendPrivatePayments(row.device_address,arrChains,!0,conn,cb)},function(){onSaved&&onSaved()})})}function readSharedAddressDefinition(shared_address,handleDefinition){db.query("SELECT definition, "+db.getUnixTimestamp("creation_date")+" AS creation_ts FROM shared_addresses WHERE shared_address=?",[shared_address],function(rows){if(1!==rows.length)throw Error("shared definition not found "+shared_address);var arrDefinition=JSON.parse(rows[0].definition);handleDefinition(arrDefinition,rows[0].creation_ts)})}function readSharedAddressCosigners(shared_address,handleCosigners){db.query("SELECT DISTINCT device_address, name, "+db.getUnixTimestamp("shared_addresses.creation_date")+" AS creation_ts \n\t\tFROM shared_address_signing_paths \n\t\tJOIN correspondent_devices USING(device_address) \n\t\tJOIN shared_addresses USING(shared_address) \n\t\tWHERE shared_address=? AND device_address!=?",[shared_address,device.getMyDeviceAddress()],function(rows){handleCosigners(rows)})}function determineIfHasMerkle(shared_address,handleResult){db.query("SELECT 1 FROM shared_address_signing_paths WHERE shared_address=? AND device_address=? AND address=''",[shared_address,device.getMyDeviceAddress()],function(rows){handleResult(rows.length>0)})}var async=require("async"),db=require("./db.js"),conf=(require("./constants.js"),require("./conf.js")),objectHash=(require("./composer.js"),require("./object_hash.js")),_=require("lodash"),network=require("./network.js"),device=require("./device.js"),walletGeneral=require("./wallet_general.js"),eventBus=require("./event_bus.js"),Definition=require("./definition.js"),ValidationUtils=require("./validation_utils.js"),MAX_INT32=(require("./indivisible_asset.js"),require("./divisible_asset.js"),Math.pow(2,31)-1);exports.validateAddressDefinitionTemplate=validateAddressDefinitionTemplate,exports.approvePendingSharedAddress=approvePendingSharedAddress,exports.deletePendingSharedAddress=deletePendingSharedAddress,exports.validateAddressDefinition=validateAddressDefinition,exports.handleNewSharedAddress=handleNewSharedAddress,exports.forwardPrivateChainsToOtherMembersOfAddresses=forwardPrivateChainsToOtherMembersOfAddresses,exports.readSharedAddressCosigners=readSharedAddressCosigners,exports.readSharedAddressDefinition=readSharedAddressDefinition,exports.determineIfHasMerkle=determineIfHasMerkle,exports.createNewSharedAddress=createNewSharedAddress,exports.createNewSharedAddressByTemplate=createNewSharedAddressByTemplate},{"./composer.js":369,"./conf.js":370,"./constants.js":371,"./db.js":372,"./definition.js":373,"./device.js":375,"./divisible_asset.js":376,"./event_bus.js":378,"./indivisible_asset.js":381,"./network.js":391,"./object_hash.js":392,"./validation_utils.js":405,"./wallet_general.js":409,async:26,lodash:271}],408:[function(require,module,exports){"use strict";function loadBitcoreFromNearestParent(mod){if(!mod)throw Error("reached root but bitcore not found");try{return require(mod.paths[0]+"/bitcore-lib")}catch(e){return console.log("bitcore-lib not found from "+mod.filename+", will try from its parent"),loadBitcoreFromNearestParent(mod.parent)}}function sendOfferToCreateNewWallet(device_address,wallet,arrWalletDefinitionTemplate,walletName,arrOtherCosigners,callbacks){var body={wallet:wallet,wallet_definition_template:arrWalletDefinitionTemplate,wallet_name:walletName,other_cosigners:arrOtherCosigners};device.sendMessageToDevice(device_address,"create_new_wallet",body,callbacks)}function sendCommandToCancelNewWallet(device_address,wallet,callbacks){device.sendMessageToDevice(device_address,"cancel_new_wallet",{wallet:wallet},callbacks)}function sendMyXPubKey(device_address,wallet,my_xpubkey){device.sendMessageToDevice(device_address,"my_xpubkey",{wallet:wallet,my_xpubkey:my_xpubkey})}function sendNotificationThatWalletFullyApproved(device_address,wallet){device.sendMessageToDevice(device_address,"wallet_fully_approved",{wallet:wallet})}function sendNewWalletAddress(device_address,wallet,is_change,address_index,address){device.sendMessageToDevice(device_address,"new_wallet_address",{wallet:wallet,address:address,is_change:is_change,address_index:address_index})}function handleOfferToCreateNewWallet(body,from_address,callbacks){return ValidationUtils.isNonemptyString(body.wallet)?ValidationUtils.isNonemptyString(body.wallet_name)?body.wallet.length>constants.HASH_LENGTH?callbacks.ifError("wallet too long"):body.wallet_name.length>200?callbacks.ifError("wallet_name too long"):ValidationUtils.isArrayOfLength(body.wallet_definition_template,2)?ValidationUtils.isNonemptyArray(body.other_cosigners)?void validateWalletDefinitionTemplate(body.wallet_definition_template,from_address,function(err,arrDeviceAddresses){if(err)return callbacks.ifError(err);if(body.other_cosigners.length!==arrDeviceAddresses.length-1)return callbacks.ifError("wrong length of other_cosigners");var arrOtherDeviceAddresses=_.uniq(body.other_cosigners.map(function(cosigner){return cosigner.device_address}));if(arrOtherDeviceAddresses.push(from_address),!_.isEqual(arrDeviceAddresses.sort(),arrOtherDeviceAddresses.sort()))return callbacks.ifError("wrong other_cosigners");for(var i=0;i<body.other_cosigners.length;i++){var cosigner=body.other_cosigners[i];if(!ValidationUtils.isStringOfLength(cosigner.pubkey,constants.PUBKEY_LENGTH))return callbacks.ifError("bad pubkey");if(cosigner.device_address!==objectHash.getDeviceAddress(cosigner.pubkey))return callbacks.ifError("bad cosigner device address");if(!ValidationUtils.isNonemptyString(cosigner.name))return callbacks.ifError("no cosigner name");if(cosigner.name.length>100)return callbacks.ifError("cosigner name too long");if(!ValidationUtils.isNonemptyString(cosigner.hub))return callbacks.ifError("no cosigner hub");if(cosigner.hub.length>100)return callbacks.ifError("cosigner hub too long")}eventBus.emit("create_new_wallet",body.wallet,body.wallet_definition_template,arrDeviceAddresses,body.wallet_name,body.other_cosigners),callbacks.ifOk()}):callbacks.ifError("no other_cosigners"):callbacks.ifError("no definition template"):callbacks.ifError("no wallet_name"):callbacks.ifError("no wallet")}function readNextAccount(handleAccount){db.query("SELECT MAX(account) AS max_account FROM wallets",function(rows){var account=0===rows.length?0:rows[0].max_account+1;handleAccount(account)})}function checkAndFinalizeWallet(wallet,onDone){db.query("SELECT member_ready_date FROM wallets LEFT JOIN extended_pubkeys USING(wallet) WHERE wallets.wallet=?",[wallet],function(rows){return 0===rows.length?(console.log("no wallet in checkAndFinalizeWallet"),onDone?onDone():null):rows.some(function(row){return!row.member_ready_date})?onDone?onDone():null:void db.query("UPDATE wallets SET ready_date="+db.getNow()+" WHERE wallet=? AND ready_date IS NULL",[wallet],function(){onDone&&onDone(),eventBus.emit("wallet_completed",wallet)})})}function checkAndFullyApproveWallet(wallet,onDone){db.query("SELECT approval_date FROM wallets LEFT JOIN extended_pubkeys USING(wallet) WHERE wallets.wallet=?",[wallet],function(rows){return 0===rows.length?onDone?onDone():null:rows.some(function(row){return!row.approval_date})?onDone?onDone():null:void db.query("UPDATE wallets SET full_approval_date="+db.getNow()+" WHERE wallet=? AND full_approval_date IS NULL",[wallet],function(){db.query("UPDATE extended_pubkeys SET member_ready_date="+db.getNow()+" WHERE wallet=? AND device_address=?",[wallet,device.getMyDeviceAddress()],function(){db.query("SELECT device_address FROM extended_pubkeys WHERE wallet=? AND device_address!=?",[wallet,device.getMyDeviceAddress()],function(rows){rows.forEach(function(row){sendNotificationThatWalletFullyApproved(row.device_address,wallet)}),checkAndFinalizeWallet(wallet,onDone)})})})})}function addWallet(wallet,xPubKey,account,arrWalletDefinitionTemplate,onDone){var assocDeviceAddressesBySigningPaths=getDeviceAddressesBySigningPaths(arrWalletDefinitionTemplate),arrDeviceAddresses=_.uniq(_.values(assocDeviceAddressesBySigningPaths));async.series([function(cb){var fields="wallet, account, definition_template",values="?,?,?";1===arrDeviceAddresses.length&&(fields+=", full_approval_date, ready_date",values+=", "+db.getNow()+", "+db.getNow()),db.query("INSERT INTO wallets ("+fields+") VALUES ("+values+")",[wallet,account,JSON.stringify(arrWalletDefinitionTemplate)],function(){cb()})},function(cb){async.eachSeries(arrDeviceAddresses,function(device_address,cb2){console.log("adding device "+device_address+" to wallet "+wallet);var fields="wallet, device_address",values="?,?",arrParams=[wallet,device_address];device_address!==device.getMyDeviceAddress()&&1!==arrDeviceAddresses.length||(fields+=", extended_pubkey, approval_date",values+=",?,"+db.getNow(),arrParams.push(xPubKey),1===arrDeviceAddresses.length&&(fields+=", member_ready_date",values+=", "+db.getNow())),db.query("INSERT "+db.getIgnore()+" INTO extended_pubkeys ("+fields+") VALUES ("+values+")",arrParams,function(){cb2()})},cb)},function(cb){var arrSigningPaths=Object.keys(assocDeviceAddressesBySigningPaths);async.eachSeries(arrSigningPaths,function(signing_path,cb2){console.log("adding signing path "+signing_path+" to wallet "+wallet);var device_address=assocDeviceAddressesBySigningPaths[signing_path];db.query("INSERT INTO wallet_signing_paths (wallet, signing_path, device_address) VALUES (?,?,?)",[wallet,signing_path,device_address],function(){cb2()})},cb)}],function(){console.log("addWallet done "+wallet),1===arrDeviceAddresses.length?onDone():checkAndFullyApproveWallet(wallet,onDone)})}function createWallet(xPubKey,account,arrWalletDefinitionTemplate,walletName,handleWallet){var wallet=crypto.createHash("sha256").update(xPubKey,"utf8").digest("base64");console.log("will create wallet "+wallet);var arrDeviceAddresses=getDeviceAddresses(arrWalletDefinitionTemplate);addWallet(wallet,xPubKey,account,arrWalletDefinitionTemplate,function(){handleWallet(wallet),1!==arrDeviceAddresses.length&&(console.log("will send offers"),device.readCorrespondentsByDeviceAddresses(arrDeviceAddresses,function(arrOtherCosigners){if(arrOtherCosigners.length!==arrDeviceAddresses.length-1)throw Error("incorrect length of other cosigners");arrDeviceAddresses.forEach(function(device_address){device_address!==device.getMyDeviceAddress()&&(console.log("sending offer to "+device_address),sendOfferToCreateNewWallet(device_address,wallet,arrWalletDefinitionTemplate,walletName,arrOtherCosigners),sendMyXPubKey(device_address,wallet,xPubKey))})}))})}function createMultisigWallet(xPubKey,account,count_required_signatures,arrDeviceAddresses,walletName,handleWallet){if(count_required_signatures>arrDeviceAddresses.length)throw Error("required > length");var set=arrDeviceAddresses.map(function(device_address){return["sig",{pubkey:"$pubkey@"+device_address}]}),arrDefinitionTemplate=["r of set",{required:count_required_signatures,set:set}];createWallet(xPubKey,account,arrDefinitionTemplate,walletName,handleWallet)}function createSinglesigWallet(xPubKey,account,walletName,handleWallet){if(walletName.indexOf("(*)")>=0)var arrDefinitionTemplate=["sig",{pubkey:"$pubkey@"+device.getMyColdDeviceAddress()}];else var arrDefinitionTemplate=["sig",{pubkey:"$pubkey@"+device.getMyDeviceAddress()}];createWallet(xPubKey,account,arrDefinitionTemplate,walletName,handleWallet)}function createSinglesigWalletWithExternalPrivateKey(xPubKey,account,device_address,handleWallet){var arrDefinitionTemplate=["sig",{pubkey:"$pubkey@"+device_address}];createWallet(xPubKey,account,arrDefinitionTemplate,"unused wallet name",handleWallet)}function createWalletByDevices(xPubKey,account,count_required_signatures,arrOtherDeviceAddresses,walletName,handleWallet){console.log("createWalletByDevices: xPubKey="+xPubKey+", account="+account),0===arrOtherDeviceAddresses.length?createSinglesigWallet(xPubKey,account,walletName,handleWallet):createMultisigWallet(xPubKey,account,count_required_signatures,[device.getMyDeviceAddress()].concat(arrOtherDeviceAddresses),walletName,handleWallet)}function approveWallet(wallet,xPubKey,account,arrWalletDefinitionTemplate,arrOtherCosigners,onDone){var arrDeviceAddresses=getDeviceAddresses(arrWalletDefinitionTemplate);device.addIndirectCorrespondents(arrOtherCosigners,function(){addWallet(wallet,xPubKey,account,arrWalletDefinitionTemplate,function(){arrDeviceAddresses.forEach(function(device_address){device_address!==device.getMyDeviceAddress()&&sendMyXPubKey(device_address,wallet,xPubKey)}),onDone&&onDone()})})}function cancelWallet(wallet,arrDeviceAddresses,arrOtherCosigners){console.log("canceling wallet "+wallet);var arrOtherDeviceAddresses=_.uniq(arrOtherCosigners.map(function(cosigner){return cosigner.device_address})),arrInitiatorDeviceAddresses=_.difference(arrDeviceAddresses,arrOtherDeviceAddresses);if(1!==arrInitiatorDeviceAddresses.length)throw Error("not one initiator?");var initiator_device_address=arrInitiatorDeviceAddresses[0];sendCommandToCancelNewWallet(initiator_device_address,wallet),arrOtherCosigners.forEach(function(cosigner){cosigner.device_address!==device.getMyDeviceAddress()&&device.sendMessageToHub(cosigner.hub,cosigner.pubkey,"cancel_new_wallet",{wallet:wallet})}),db.query("DELETE FROM extended_pubkeys WHERE wallet=?",[wallet],function(){db.query("DELETE FROM wallet_signing_paths WHERE wallet=?",[wallet],function(){})})}function deleteWallet(wallet,rejector_device_address,onDone){db.query("SELECT approval_date FROM extended_pubkeys WHERE wallet=? AND device_address=?",[wallet,rejector_device_address],function(rows){return 0===rows.length?onDone():rows[0].approval_date?onDone():void db.query("SELECT device_address FROM extended_pubkeys WHERE wallet=?",[wallet],function(rows){var arrMemberAddresses=rows.map(function(row){return row.device_address}),arrQueries=[];db.addQuery(arrQueries,"DELETE FROM extended_pubkeys WHERE wallet=?",[wallet]),db.addQuery(arrQueries,"DELETE FROM wallet_signing_paths WHERE wallet=?",[wallet]),db.addQuery(arrQueries,"DELETE FROM wallets WHERE wallet=?",[wallet]),db.addQuery(arrQueries,"DELETE FROM correspondent_devices WHERE is_indirect=1 AND device_address IN(?) AND NOT EXISTS ( \n\t\t\t\t\tSELECT * FROM extended_pubkeys WHERE extended_pubkeys.device_address=correspondent_devices.device_address \n\t\t\t\t)",[arrMemberAddresses]),async.series(arrQueries,function(){eventBus.emit("wallet_declined",wallet,rejector_device_address),onDone()})})})}function addDeviceXPubKey(wallet,device_address,xPubKey,onDone){db.query("INSERT "+db.getIgnore()+" INTO extended_pubkeys (wallet, device_address) VALUES(?,?)",[wallet,device_address],function(){db.query("UPDATE extended_pubkeys SET extended_pubkey=?, approval_date="+db.getNow()+" WHERE wallet=? AND device_address=?",[xPubKey,wallet,device_address],function(){eventBus.emit("wallet_approved",wallet,device_address),checkAndFullyApproveWallet(wallet,onDone)})})}function handleNotificationThatWalletFullyApproved(wallet,device_address,onDone){db.query("INSERT "+db.getIgnore()+" INTO extended_pubkeys (wallet, device_address) VALUES(?,?)",[wallet,device_address],function(){db.query("UPDATE extended_pubkeys SET member_ready_date="+db.getNow()+" WHERE wallet=? AND device_address=?",[wallet,device_address],function(){checkAndFinalizeWallet(wallet,onDone)})})}function readCosigners(wallet,handleCosigners){db.query("SELECT extended_pubkeys.device_address, name, approval_date, extended_pubkey \n\t\tFROM extended_pubkeys LEFT JOIN correspondent_devices USING(device_address) WHERE wallet=?",[wallet],function(rows){rows.forEach(function(row){if(row.device_address===device.getMyDeviceAddress()){if(null!==row.name)throw Error("found self in correspondents");row.me=!0}else if(null===row.name)throw Error("cosigner not found among correspondents, cosigner="+row.device_address+", my="+device.getMyDeviceAddress())}),handleCosigners(rows)})}function addNewAddress(wallet,is_change,address_index,address,handleError){breadcrumbs.add("addNewAddress is_change="+is_change+", index="+address_index+", address="+address),db.query("SELECT 1 FROM wallets WHERE wallet=?",[wallet],function(rows){return 0===rows.length?handleError("wallet "+wallet+" does not exist"):void deriveAddress(wallet,is_change,address_index,function(new_address,arrDefinition){return new_address!==address?handleError("I derived address "+new_address+", your address "+address):void recordAddress(wallet,is_change,address_index,address,arrDefinition,function(){eventBus.emit("new_wallet_address",address),handleError()})})})}function getDeviceAddresses(arrWalletDefinitionTemplate){return _.uniq(_.values(getDeviceAddressesBySigningPaths(arrWalletDefinitionTemplate)))}function getDeviceAddressesBySigningPaths(arrWalletDefinitionTemplate){function evaluate(arr,path){var op=arr[0],args=arr[1];if(args){var prefix="$pubkey@";switch(op){case"sig":if(!args.pubkey||args.pubkey.substr(0,prefix.length)!==prefix)return;
var device_address=args.pubkey.substr(prefix.length);assocDeviceAddressesBySigningPaths[path]=device_address;break;case"hash":if(!args.hash||args.hash.substr(0,prefix.length)!==prefix)return;var device_address=args.hash.substr(prefix.length);assocDeviceAddressesBySigningPaths[path]=device_address;break;case"or":case"and":for(var i=0;i<args.length;i++)evaluate(args[i],path+"."+i);break;case"r of set":if(!ValidationUtils.isNonemptyArray(args.set))return;for(var i=0;i<args.set.length;i++)evaluate(args.set[i],path+"."+i);break;case"weighted and":if(!ValidationUtils.isNonemptyArray(args.set))return;for(var i=0;i<args.set.length;i++)evaluate(args.set[i].value,path+"."+i);break;case"address":case"definition template":throw Error(op+" not supported yet")}}}var assocDeviceAddressesBySigningPaths={};return evaluate(arrWalletDefinitionTemplate,"r"),assocDeviceAddressesBySigningPaths}function validateWalletDefinitionTemplate(arrWalletDefinitionTemplate,from_address,handleResult){var arrDeviceAddresses=getDeviceAddresses(arrWalletDefinitionTemplate);if(arrDeviceAddresses.indexOf(device.getMyDeviceAddress())===-1)return handleResult("my device address not mentioned in the definition");if(arrDeviceAddresses.indexOf(from_address)===-1)return handleResult("sender device address not mentioned in the definition");var params={};arrDeviceAddresses.forEach(function(device_address){params["pubkey@"+device_address]=device.getMyDevicePubKey()});try{var arrFakeDefinition=Definition.replaceInTemplate(arrWalletDefinitionTemplate,params)}catch(e){return handleResult(e.toString())}var objFakeUnit={authors:[]},objFakeValidationState={last_ball_mci:MAX_INT32};Definition.validateDefinition(db,arrFakeDefinition,objFakeUnit,objFakeValidationState,!1,function(err){return err?handleResult(err):void handleResult(null,arrDeviceAddresses)})}function readNextAddressIndex(wallet,is_change,handleNextAddressIndex){db.query("SELECT MAX(address_index) AS last_used_index FROM my_addresses WHERE wallet=? AND is_change=?",[wallet,is_change],function(rows){var last_used_index=rows[0].last_used_index;handleNextAddressIndex(null===last_used_index?0:last_used_index+1)})}function readLastUsedAddressIndex(wallet,is_change,handleLastUsedAddressIndex){db.query("SELECT MAX(address_index) AS last_used_index FROM my_addresses JOIN outputs USING(address) WHERE wallet=? AND is_change=?",[wallet,is_change],function(rows){var last_used_index=rows[0].last_used_index;handleLastUsedAddressIndex(last_used_index)})}function derivePubkey(xPubKey,path){var hdPubKey=new Bitcore.HDPublicKey(xPubKey);return hdPubKey.derive(path).publicKey.toBuffer().toString("base64")}function deriveAddress(wallet,is_change,address_index,handleNewAddress){db.query("SELECT definition_template, full_approval_date FROM wallets WHERE wallet=?",[wallet],function(wallet_rows){if(0===wallet_rows.length)throw Error("wallet not found: "+wallet+", is_change="+is_change+", index="+address_index);if(!wallet_rows[0].full_approval_date)throw Error("wallet not fully approved yet: "+wallet);var arrDefinitionTemplate=JSON.parse(wallet_rows[0].definition_template);db.query("SELECT device_address, extended_pubkey FROM extended_pubkeys WHERE wallet=?",[wallet],function(rows){var path="m/"+is_change+"/"+address_index,params={};rows.forEach(function(row){if(!row.extended_pubkey)throw Error("no extended_pubkey for wallet "+wallet);params["pubkey@"+row.device_address]=derivePubkey(row.extended_pubkey,path),console.log("pubkey for wallet "+wallet+" path "+path+" device "+row.device_address+" xpub "+row.extended_pubkey+": "+params["pubkey@"+row.device_address])});var arrDefinition=Definition.replaceInTemplate(arrDefinitionTemplate,params),address=objectHash.getChash160(arrDefinition);handleNewAddress(address,arrDefinition)})})}function recordAddress(wallet,is_change,address_index,address,arrDefinition,onDone){if("string"==typeof address_index&&is_change)throw Error("address with string index cannot be change address");var address_index_column_name="string"==typeof address_index?"app":"address_index";db.query("INSERT "+db.getIgnore()+" INTO my_addresses (wallet, is_change, "+address_index_column_name+", address, definition) VALUES (?,?,?,?,?)",[wallet,is_change,address_index,address,JSON.stringify(arrDefinition)],function(){eventBus.emit("new_address-"+address),onDone&&onDone(),conf.bLight&&!is_change&&network.addLightWatchedAddress(address)})}function deriveAndRecordAddress(wallet,is_change,address_index,handleNewAddress){deriveAddress(wallet,is_change,address_index,function(address,arrDefinition){recordAddress(wallet,is_change,address_index,address,arrDefinition,function(){handleNewAddress(address)})})}function issueAddress(wallet,is_change,address_index,handleNewAddress){breadcrumbs.add("issueAddress wallet="+wallet+", is_change="+is_change+", index="+address_index),deriveAndRecordAddress(wallet,is_change,address_index,function(address){db.query("SELECT device_address FROM extended_pubkeys WHERE wallet=?",[wallet],function(rows){rows.forEach(function(row){row.device_address!==device.getMyDeviceAddress()&&sendNewWalletAddress(row.device_address,wallet,is_change,address_index,address)}),handleNewAddress({address:address,is_change:is_change,address_index:address_index,creation_ts:parseInt(Date.now()/1e3)})})}),setTimeout(function(){checkAddress(0,0,0)},5e3)}function issueAddressSync(wallet,is_change,address_index,handleNewAddress){breadcrumbs.add("issueAddress wallet="+wallet+", is_change="+is_change+", index="+address_index),deriveAndRecordAddress(wallet,is_change,address_index,function(address){handleNewAddress({address:address,is_change:is_change,address_index:address_index,creation_ts:parseInt(Date.now()/1e3)})}),setTimeout(function(){checkAddress(0,0,0)},5e3)}function readAddressByIndex(wallet,is_change,address_index,handleAddress){db.query("SELECT address, address_index, "+db.getUnixTimestamp("creation_date")+" AS creation_ts \n\t\tFROM my_addresses WHERE wallet=? AND is_change=? AND address_index=?",[wallet,is_change,address_index],function(rows){handleAddress(rows[0])})}function selectRandomAddress(wallet,is_change,from_index,handleAddress){null===from_index&&(from_index=-1),db.query("SELECT address, address_index, "+db.getUnixTimestamp("creation_date")+" AS creation_ts \n\t\tFROM my_addresses WHERE wallet=? AND is_change=? AND address_index>? ORDER BY "+db.getRandom()+" LIMIT 1",[wallet,is_change,from_index],function(rows){handleAddress(rows[0])})}function issueNextAddress(wallet,is_change,handleAddress){readNextAddressIndex(wallet,is_change,function(next_index){issueAddress(wallet,is_change,next_index,handleAddress)})}function issueOrSelectNextAddress(wallet,is_change,handleAddress){readNextAddressIndex(wallet,is_change,function(next_index){return next_index<MAX_BIP44_GAP?issueAddress(wallet,is_change,next_index,handleAddress):void readLastUsedAddressIndex(wallet,is_change,function(last_used_index){null===last_used_index||next_index-last_used_index>=MAX_BIP44_GAP?selectRandomAddress(wallet,is_change,last_used_index,handleAddress):issueAddress(wallet,is_change,next_index,handleAddress)})})}function issueOrSelectNextChangeAddress(wallet,handleAddress){readNextAddressIndex(wallet,1,function(next_index){readLastUsedAddressIndex(wallet,1,function(last_used_index){var first_unused_index=null===last_used_index?0:last_used_index+1;if(first_unused_index>next_index)throw Error("unued > next");first_unused_index<next_index?readAddressByIndex(wallet,1,first_unused_index,handleAddress):issueAddress(wallet,1,next_index,handleAddress)})})}function checkAddress(account,is_change,address_index){db.query("SELECT wallet, extended_pubkey FROM wallets JOIN extended_pubkeys USING(wallet) WHERE account=?",[account],function(rows){if(!(0===rows.length||rows.length>1)){var row=rows[0],pubkey=derivePubkey(row.extended_pubkey,"m/"+is_change+"/"+address_index),arrDefinition=["sig",{pubkey:pubkey}],address=objectHash.getChash160(arrDefinition);db.query("SELECT address, definition FROM my_addresses WHERE wallet=? AND is_change=? AND address_index=?",[row.wallet,is_change,address_index],function(address_rows){if(0!==address_rows.length){var address_row=address_rows[0],db_pubkey=JSON.parse(address_row.definition)[1].pubkey;if(db_pubkey!==pubkey)throw Error("pubkey mismatch, derived: "+pubkey+", db: "+db_pubkey);if(address_row.address!==address)throw Error("address mismatch, derived: "+address+", db: "+address_row.address);breadcrumbs.add("addresses match")}})}})}function readAddresses(wallet,opts,handleAddresses){var sql="SELECT address, address_index, is_change, "+db.getUnixTimestamp("creation_date")+" AS creation_ts \n\t\tFROM my_addresses WHERE wallet=?";0!==opts.is_change&&1!==opts.is_change||(sql+=" AND is_change="+opts.is_change),sql+=" ORDER BY creation_ts",opts.reverse&&(sql+=" DESC"),opts.limit&&(sql+=" LIMIT "+opts.limit),db.query(sql,[wallet],function(rows){handleAddresses(rows)}),checkAddress(0,0,0)}function readExternalAddresses(wallet,opts,handleAddresses){opts.is_change=0,readAddresses(wallet,opts,handleAddresses)}function readChangeAddresses(wallet,handleAddresses){readAddresses(wallet,{is_change:1,reverse:1},handleAddresses)}function readAddressInfo(address,handleAddress){db.query("SELECT address_index, is_change FROM my_addresses WHERE address=?",[address],function(rows){return 0===rows.length?handleAddress("address "+address+" not found"):void handleAddress(null,rows[0])})}function readAllAddressesAndIndex(wallet,handleAddresses){db.query("SELECT is_change, address_index, address FROM my_addresses WHERE wallet=? order by is_change,address_index",[wallet],function(rows){handleAddresses(rows.map(function(row){return row.is_change+"-"+row.address_index+"-"+row.address}))})}function forwardPrivateChainsToOtherMembersOfWallets(arrChains,arrWallets,conn,onSaved){console.log("forwardPrivateChainsToOtherMembersOfWallets",arrWallets),conn=conn||db,conn.query("SELECT device_address FROM extended_pubkeys WHERE wallet IN(?) AND device_address!=?",[arrWallets,device.getMyDeviceAddress()],function(rows){console.log("devices: "+rows.length),async.eachSeries(rows,function(row,cb){console.log("forwarding to device "+row.device_address),walletGeneral.sendPrivatePayments(row.device_address,arrChains,!0,conn,cb)},function(){onSaved&&onSaved()})})}var async=require("async"),crypto=require("crypto"),db=require("./db.js"),constants=require("./constants.js"),conf=require("./conf.js"),objectHash=(require("./composer.js"),require("./object_hash.js")),_=require("lodash"),network=(require("./storage.js"),require("./network.js")),device=require("./device.js"),walletGeneral=require("./wallet_general.js"),eventBus=require("./event_bus.js"),Definition=require("./definition.js"),ValidationUtils=require("./validation_utils.js"),breadcrumbs=require("./breadcrumbs.js");try{var Bitcore=require("bitcore-lib")}catch(e){var Bitcore=loadBitcoreFromNearestParent(module.parent)}var MAX_BIP44_GAP=20,MAX_INT32=Math.pow(2,31)-1;exports.readNextAccount=readNextAccount,exports.createWalletByDevices=createWalletByDevices,exports.createSinglesigWalletWithExternalPrivateKey=createSinglesigWalletWithExternalPrivateKey,exports.approveWallet=approveWallet,exports.cancelWallet=cancelWallet,exports.handleOfferToCreateNewWallet=handleOfferToCreateNewWallet,exports.deleteWallet=deleteWallet,exports.addDeviceXPubKey=addDeviceXPubKey,exports.handleNotificationThatWalletFullyApproved=handleNotificationThatWalletFullyApproved,exports.addNewAddress=addNewAddress,exports.readNextAddressIndex=readNextAddressIndex,exports.issueNextAddress=issueNextAddress,exports.readAddressByIndex=readAddressByIndex,exports.issueOrSelectNextAddress=issueOrSelectNextAddress,exports.issueOrSelectNextChangeAddress=issueOrSelectNextChangeAddress,exports.readAddresses=readAddresses,exports.readExternalAddresses=readExternalAddresses,exports.readChangeAddresses=readChangeAddresses,exports.readAddressInfo=readAddressInfo,exports.readAllAddressesAndIndex=readAllAddressesAndIndex,exports.forwardPrivateChainsToOtherMembersOfWallets=forwardPrivateChainsToOtherMembersOfWallets,exports.readCosigners=readCosigners,exports.derivePubkey=derivePubkey,exports.issueAddress=issueAddress,exports.issueAddressSync=issueAddressSync},{"./breadcrumbs.js":365,"./composer.js":369,"./conf.js":370,"./constants.js":371,"./db.js":372,"./definition.js":373,"./device.js":375,"./event_bus.js":378,"./network.js":391,"./object_hash.js":392,"./storage.js":402,"./validation_utils.js":405,"./wallet_general.js":409,async:26,"bitcore-lib":34,crypto:181,lodash:271}],409:[function(require,module,exports){"use strict";function sendOfferToSign(device_address,address,signing_path,objUnsignedUnit,assocPrivatePayloads){var body={address:address,signing_path:signing_path,unsigned_unit:objUnsignedUnit};assocPrivatePayloads&&Object.keys(assocPrivatePayloads).length>0&&(body.private_payloads=assocPrivatePayloads),device.sendMessageToDevice(device_address,"sign",body)}function sendPrivatePayments(device_address,arrChains,bForwarded,conn,onSaved){var body={chains:arrChains};bForwarded&&(body.forwarded=!0),device.sendMessageToDevice(device_address,"private_payments",body,{ifOk:function(){},ifError:function(){},onSaved:onSaved},conn)}function sendPaymentNotification(device_address,unit){device.sendMessageToDevice(device_address,"payment_notification",unit)}function readMyAddresses(handleAddresses){db.query("SELECT address FROM my_addresses UNION SELECT shared_address AS address FROM shared_addresses",function(rows){var arrAddresses=rows.map(function(row){return row.address});handleAddresses(arrAddresses)})}var db=require("./db.js"),device=require("./device.js");exports.sendOfferToSign=sendOfferToSign,exports.sendPrivatePayments=sendPrivatePayments,exports.sendPaymentNotification=sendPaymentNotification,exports.readMyAddresses=readMyAddresses},{"./db.js":372,"./device.js":375}],410:[function(require,module,exports){"use strict";function prepareWitnessProof(arrWitnesses,last_stable_mci,handleResult){var arrWitnessChangeAndDefinitionJoints=[],arrUnstableMcJoints=[],arrLastBallUnits=[],last_ball_unit=null,last_ball_mci=null;async.series([function(cb){storage.determineIfWitnessAddressDefinitionsHaveReferences(db,arrWitnesses,function(bWithReferences){bWithReferences?cb("some witnesses have references in their addresses, please change your witness list"):cb()})},function(cb){var arrFoundWitnesses=[];db.query("SELECT unit FROM units WHERE is_on_main_chain=1 AND is_stable=0 ORDER BY main_chain_index DESC",function(rows){async.eachSeries(rows,function(row,cb2){storage.readJointWithBall(db,row.unit,function(objJoint){delete objJoint.ball,arrUnstableMcJoints.push(objJoint);for(var i=0;i<objJoint.unit.authors.length;i++){var address=objJoint.unit.authors[i].address;arrWitnesses.indexOf(address)>=0&&arrFoundWitnesses.indexOf(address)===-1&&arrFoundWitnesses.push(address)}objJoint.unit.last_ball_unit&&arrFoundWitnesses.length>=constants.MAJORITY_OF_WITNESSES&&arrLastBallUnits.push(objJoint.unit.last_ball_unit),cb2()})},cb)})},function(cb){return 0===arrLastBallUnits.length?cb("your witness list might be too much off, too few witness authored units"):void db.query("SELECT unit, main_chain_index FROM units WHERE unit IN(?) ORDER BY main_chain_index DESC LIMIT 1",[arrLastBallUnits],function(rows){last_ball_unit=rows[0].unit,last_ball_mci=rows[0].main_chain_index,last_stable_mci>=last_ball_mci?cb("already_current"):cb()})},function(cb){var after_last_stable_mci_cond=last_stable_mci>0?"latest_included_mc_index>="+last_stable_mci:"1";db.query("SELECT unit, `level` \n\t\t\t\tFROM unit_authors "+db.forceIndex("unitAuthorsIndexByAddressDefinitionChash")+" \n\t\t\t\tCROSS JOIN units USING(unit) \n\t\t\t\tWHERE address IN(?) AND definition_chash IS NOT NULL AND "+after_last_stable_mci_cond+" AND is_stable=1 AND sequence='good' \n\t\t\t\tUNION \n\t\t\t\tSELECT unit, `level` \n\t\t\t\tFROM address_definition_changes \n\t\t\t\tCROSS JOIN units USING(unit) \n\t\t\t\tWHERE address_definition_changes.address IN(?) AND "+after_last_stable_mci_cond+" AND is_stable=1 AND sequence='good' \n\t\t\t\tORDER BY `level`",[arrWitnesses,arrWitnesses],function(rows){async.eachSeries(rows,function(row,cb2){storage.readJoint(db,row.unit,{ifNotFound:function(){throw Error("prepareWitnessProof definition changes: not found "+row.unit)},ifFound:function(objJoint){arrWitnessChangeAndDefinitionJoints.push(objJoint),cb2()}})},cb)})}],function(err){return err?handleResult(err):void handleResult(null,arrUnstableMcJoints,arrWitnessChangeAndDefinitionJoints,last_ball_unit,last_ball_mci)})}function processWitnessProof(arrUnstableMcJoints,arrWitnessChangeAndDefinitionJoints,bFromCurrent,handleResult){myWitnesses.readMyWitnesses(function(arrWitnesses){function validateUnit(objUnit,bRequireDefinitionOrChange,cb2){var bFound=!1;async.eachSeries(objUnit.authors,function(author,cb3){function handleAuthor(){validation.validateAuthorSignaturesWithoutReferences(author,objUnit,assocDefinitions[definition_chash],function(err){if(err)return cb3(err);for(var i=0;i<objUnit.messages.length;i++){var message=objUnit.messages[i];"address_definition_change"===message.app&&(message.payload.address===address||1===objUnit.authors.length&&objUnit.authors[0].address===address)&&(assocDefinitionChashes[address]=message.payload.definition_chash,bFound=!0)}cb3()})}var address=author.address;if(arrWitnesses.indexOf(address)===-1)return cb3();var definition_chash=assocDefinitionChashes[address];if(!definition_chash)throw Error("definition chash not known for address "+address);if(author.definition){if(objectHash.getChash160(author.definition)!==definition_chash)return cb3("definition doesn't hash to the expected value");assocDefinitions[definition_chash]=author.definition,bFound=!0}return assocDefinitions[definition_chash]?handleAuthor():void storage.readDefinition(db,definition_chash,{ifFound:function(arrDefinition){assocDefinitions[definition_chash]=arrDefinition,handleAuthor()},ifDefinitionNotFound:function(d){throw Error("definition "+definition_chash+" not found, address "+address)}})},function(err){return err?cb2(err):bRequireDefinitionOrChange&&!bFound?cb2("neither definition nor change"):void cb2()})}for(var arrParentUnits=null,arrFoundWitnesses=[],arrLastBallUnits=[],assocLastBallByLastBallUnit={},arrWitnessJoints=[],i=0;i<arrUnstableMcJoints.length;i++){var objJoint=arrUnstableMcJoints[i],objUnit=objJoint.unit;if(objJoint.ball)return handleResult("unstable mc but has ball");if(!validation.hasValidHashes(objJoint))return handleResult("invalid hash");if(arrParentUnits&&arrParentUnits.indexOf(objUnit.unit)===-1)return handleResult("not in parents");for(var bAddedJoint=!1,j=0;j<objUnit.authors.length;j++){var address=objUnit.authors[j].address;arrWitnesses.indexOf(address)>=0&&(arrFoundWitnesses.indexOf(address)===-1&&arrFoundWitnesses.push(address),bAddedJoint||arrWitnessJoints.push(objJoint),bAddedJoint=!0)}arrParentUnits=objUnit.parent_units,objUnit.last_ball_unit&&arrFoundWitnesses.length>=constants.MAJORITY_OF_WITNESSES&&(arrLastBallUnits.push(objUnit.last_ball_unit),assocLastBallByLastBallUnit[objUnit.last_ball_unit]=objUnit.last_ball)}if(arrFoundWitnesses.length<constants.MAJORITY_OF_WITNESSES)return handleResult("not enough witnesses");if(0===arrLastBallUnits.length)throw Error("processWitnessProof: no last ball units");for(var i=0;i<arrWitnessChangeAndDefinitionJoints.length;i++){var objJoint=arrWitnessChangeAndDefinitionJoints[i],objUnit=objJoint.unit;if(!objJoint.ball)return handleResult("witness_change_and_definition_joints: joint without ball");if(!validation.hasValidHashes(objJoint))return handleResult("witness_change_and_definition_joints: invalid hash");for(var bAuthoredByWitness=!1,j=0;j<objUnit.authors.length;j++){var address=objUnit.authors[j].address;arrWitnesses.indexOf(address)>=0&&(bAuthoredByWitness=!0)}if(!bAuthoredByWitness)return handleResult("not authored by my witness")}var assocDefinitions={},assocDefinitionChashes={};async.series([function(cb){return bFromCurrent?void async.eachSeries(arrWitnesses,function(address,cb2){storage.readDefinitionByAddress(db,address,null,{ifFound:function(arrDefinition){var definition_chash=objectHash.getChash160(arrDefinition);assocDefinitions[definition_chash]=arrDefinition,assocDefinitionChashes[address]=definition_chash,cb2()},ifDefinitionNotFound:function(definition_chash){assocDefinitionChashes[address]=definition_chash,cb2()}})},cb):(arrWitnesses.forEach(function(address){assocDefinitionChashes[address]=address}),cb())},function(cb){async.eachSeries(arrWitnessChangeAndDefinitionJoints,function(objJoint,cb2){var objUnit=objJoint.unit;return bFromCurrent?void db.query("SELECT 1 FROM units WHERE unit=? AND is_stable=1",[objUnit.unit],function(rows){return rows.length>0?cb2():void validateUnit(objUnit,!0,cb2)}):validateUnit(objUnit,!0,cb2)},cb)},function(cb){async.eachSeries(arrWitnessJoints.reverse(),function(objJoint,cb2){validateUnit(objJoint.unit,!1,cb2)},cb)}],function(err){err?handleResult(err):handleResult(null,arrLastBallUnits,assocLastBallByLastBallUnit)})})}var async=require("async"),storage=require("./storage.js"),myWitnesses=require("./my_witnesses.js"),objectHash=require("./object_hash.js"),db=require("./db.js"),constants=require("./constants.js"),validation=require("./validation.js");exports.prepareWitnessProof=prepareWitnessProof,exports.processWitnessProof=processWitnessProof},{"./constants.js":371,"./db.js":372,"./my_witnesses.js":389,"./object_hash.js":392,"./storage.js":402,"./validation.js":404,async:26}],411:[function(require,module,exports){"use strict";function saveJoint(objJoint,objValidationState,preCommitCallback,onDone){var objUnit=objJoint.unit;console.log("\nsaving unit "+objUnit.unit),profiler.start(),db.takeConnectionFromPool(function(conn){function determineInputAddressFromSrcOutput(asset,denomination,input,handleAddress){conn.query("SELECT address, denomination, asset FROM outputs WHERE unit=? AND message_index=? AND output_index=?",[input.unit,input.message_index,input.output_index],function(rows){if(rows.length>1)throw Error("multiple src outputs found");if(0===rows.length){if(conf.bLight)return handleAddress(null);throw Error("src output not found")}var row=rows[0];if((asset||row.asset)&&asset!==row.asset)throw Error("asset doesn't match");if(denomination!==row.denomination)throw Error("denomination doesn't match");var address=row.address;if(arrAuthorAddresses.indexOf(address)===-1)throw Error("src output address not among authors");handleAddress(address)})}function addInlinePaymentQueries(cb){async.forEachOfSeries(objUnit.messages,function(message,i,cb2){if("inline"!==message.payload_location)return cb2();var payload=message.payload;if("payment"!==message.app)return cb2();var denomination=payload.denomination||1;async.forEachOfSeries(payload.inputs,function(input,j,cb3){var type=input.type||"transfer",src_unit="transfer"===type?input.unit:null,src_message_index="transfer"===type?input.message_index:null,src_output_index="transfer"===type?input.output_index:null,from_main_chain_index="witnessing"===type||"headers_commission"===type?input.from_main_chain_index:null,to_main_chain_index="witnessing"===type||"headers_commission"===type?input.to_main_chain_index:null,determineInputAddress=function(handleAddress){return"headers_commission"===type||"witnessing"===type||"issue"===type?handleAddress(1===arrAuthorAddresses.length?arrAuthorAddresses[0]:input.address):1===arrAuthorAddresses.length?handleAddress(arrAuthorAddresses[0]):void determineInputAddressFromSrcOutput(payload.asset,denomination,input,handleAddress)};determineInputAddress(function(address){var is_unique=objValidationState.arrDoubleSpendInputs.some(function(ds){return ds.message_index===i&&ds.input_index===j})?null:1;switch(conn.addQuery(arrQueries,"INSERT INTO inputs \n\t\t\t\t\t\t\t\t\t\t(unit, message_index, input_index, type, \n\t\t\t\t\t\t\t\t\t\tsrc_unit, src_message_index, src_output_index, \t\t\t\t\t\t\t\t\t\tfrom_main_chain_index, to_main_chain_index, \n\t\t\t\t\t\t\t\t\t\tdenomination, amount, serial_number, \n\t\t\t\t\t\t\t\t\t\tasset, is_unique, address) VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)",[objUnit.unit,i,j,type,src_unit,src_message_index,src_output_index,from_main_chain_index,to_main_chain_index,denomination,input.amount,input.serial_number,payload.asset,is_unique,address]),type){case"transfer":conn.addQuery(arrQueries,"UPDATE outputs SET is_spent=1 WHERE unit=? AND message_index=? AND output_index=?",[src_unit,src_message_index,src_output_index]);break;case"headers_commission":case"witnessing":var table=type+"_outputs";conn.addQuery(arrQueries,"UPDATE "+table+" SET is_spent=1 \n\t\t\t\t\t\t\t\t\t\t\tWHERE main_chain_index>=? AND main_chain_index<=? AND address=?",[from_main_chain_index,to_main_chain_index,address])}cb3()})},function(){for(var j=0;j<payload.outputs.length;j++){var output=payload.outputs[j];conn.addQuery(arrQueries,"INSERT INTO outputs \n\t\t\t\t\t\t\t\t\t(unit, message_index, output_index, address, amount, asset, denomination, is_serial) VALUES(?,?,?,?,?,?,?,1)",[objUnit.unit,i,j,output.address,parseInt(output.amount),payload.asset,denomination])}cb2()})},cb)}function updateBestParent(cb){conn.query("SELECT unit \n\t\t\t\tFROM units AS parent_units \n\t\t\t\tWHERE unit IN(?) \n\t\t\t\t\tAND (witness_list_unit=? OR ( \n\t\t\t\t\t\tSELECT COUNT(*) \n\t\t\t\t\t\tFROM unit_witnesses \n\t\t\t\t\t\tJOIN unit_witnesses AS parent_witnesses USING(address) \n\t\t\t\t\t\tWHERE parent_witnesses.unit IN(parent_units.unit, parent_units.witness_list_unit) \n\t\t\t\t\t\t\tAND unit_witnesses.unit IN(?, ?) \n\t\t\t\t\t)>=?) \n\t\t\t\tORDER BY witnessed_level DESC, \n\t\t\t\t\tlevel-witnessed_level ASC, \n\t\t\t\t\tunit ASC \n\t\t\t\tLIMIT 1",[objUnit.parent_units,objUnit.witness_list_unit,objUnit.unit,objUnit.witness_list_unit,constants.COUNT_WITNESSES-constants.MAX_WITNESS_LIST_MUTATIONS],function(rows){if(1!==rows.length)throw Error("zero or more than one best parent unit?");my_best_parent_unit=rows[0].unit,conn.query("UPDATE units SET best_parent_unit=? WHERE unit=?",[my_best_parent_unit,objUnit.unit],function(){cb()})})}function updateLevel(cb){conn.query("SELECT MAX(level) AS max_level FROM units WHERE unit IN(?)",[objUnit.parent_units],function(rows){if(1!==rows.length)throw Error("not a single max level?");conn.query("UPDATE units SET level=? WHERE unit=?",[rows[0].max_level+1,objUnit.unit],function(){cb()})})}function updateWitnessedLevel(cb){objUnit.witnesses?updateWitnessedLevelByWitnesslist(objUnit.witnesses,cb):storage.readWitnessList(conn,objUnit.witness_list_unit,function(arrWitnesses){updateWitnessedLevelByWitnesslist(arrWitnesses,cb)})}function updateWitnessedLevelByWitnesslist(arrWitnesses,cb){function setWitnessedLevel(witnessed_level){profiler.start(),conn.query("UPDATE units SET witnessed_level=? WHERE unit=?",[witnessed_level,objUnit.unit],function(){profiler.stop("write-wl-update"),cb()})}function addWitnessesAndGoUp(start_unit){profiler.start(),storage.readStaticUnitProps(conn,start_unit,function(props){profiler.stop("write-wl-select-bp");var best_parent_unit=props.best_parent_unit,level=props.level;if(null===level)throw Error("null level in updateWitnessedLevel");return 0===level?setWitnessedLevel(0):(profiler.start(),void storage.readUnitAuthors(conn,start_unit,function(arrAuthors){profiler.stop("write-wl-select-authors"),profiler.start();for(var i=0;i<arrAuthors.length;i++){var address=arrAuthors[i];arrWitnesses.indexOf(address)!==-1&&arrCollectedWitnesses.indexOf(address)===-1&&arrCollectedWitnesses.push(address)}profiler.stop("write-wl-search"),arrCollectedWitnesses.length<constants.MAJORITY_OF_WITNESSES?addWitnessesAndGoUp(best_parent_unit):setWitnessedLevel(level)}))})}var arrCollectedWitnesses=[];profiler.stop("write-update"),addWitnessesAndGoUp(my_best_parent_unit)}var arrQueries=[];conn.addQuery(arrQueries,"BEGIN");for(var i=0;i<objValidationState.arrAdditionalQueries.length;i++){var objAdditionalQuery=objValidationState.arrAdditionalQueries[i];console.log("----- applying additional queries: "+objAdditionalQuery.sql),conn.addQuery(arrQueries,objAdditionalQuery.sql,objAdditionalQuery.params)}var fields="unit, version, alt, witness_list_unit, last_ball_unit, headers_commission, payload_commission, sequence, content_hash",values="?,?,?,?,?,?,?,?,?",params=[objUnit.unit,objUnit.version,objUnit.alt,objUnit.witness_list_unit,objUnit.last_ball_unit,objUnit.headers_commission||0,objUnit.payload_commission||0,objValidationState.sequence,objUnit.content_hash];if(conf.bLight&&(fields+=", main_chain_index, creation_date",values+=",?,"+conn.getFromUnixTime("?"),params.push(objUnit.main_chain_index,objUnit.timestamp)),conn.addQuery(arrQueries,"INSERT INTO units ("+fields+") VALUES ("+values+")",params),objJoint.ball&&!conf.bLight&&(conn.addQuery(arrQueries,"INSERT INTO balls (ball, unit) VALUES(?,?)",[objJoint.ball,objUnit.unit]),conn.addQuery(arrQueries,"DELETE FROM hash_tree_balls WHERE ball=? AND unit=?",[objJoint.ball,objUnit.unit]),objJoint.skiplist_units))for(var i=0;i<objJoint.skiplist_units.length;i++)conn.addQuery(arrQueries,"INSERT INTO skiplist_units (unit, skiplist_unit) VALUES (?,?)",[objUnit.unit,objJoint.skiplist_units[i]]);if(objUnit.parent_units)for(var i=0;i<objUnit.parent_units.length;i++)conn.addQuery(arrQueries,"INSERT INTO parenthoods (child_unit, parent_unit) VALUES(?,?)",[objUnit.unit,objUnit.parent_units[i]]);if(storage.isGenesisUnit(objUnit.unit)?conn.addQuery(arrQueries,"UPDATE units SET is_on_main_chain=1, main_chain_index=0, is_stable=1, level=0, witnessed_level=0 \n\t\t\t\tWHERE unit=?",[objUnit.unit]):conn.addQuery(arrQueries,"UPDATE units SET is_free=0 WHERE unit IN(?)",[objUnit.parent_units],function(result){var count_consumed_free_units=result.affectedRows;console.log(count_consumed_free_units+" free units consumed")}),Array.isArray(objUnit.witnesses)){for(var i=0;i<objUnit.witnesses.length;i++){var address=objUnit.witnesses[i];conn.addQuery(arrQueries,"INSERT INTO unit_witnesses (unit, address) VALUES(?,?)",[objUnit.unit,address])}conn.addQuery(arrQueries,"INSERT "+conn.getIgnore()+" INTO witness_list_hashes (witness_list_unit, witness_list_hash) VALUES (?,?)",[objUnit.unit,objectHash.getBase64Hash(objUnit.witnesses)])}for(var arrAuthorAddresses=[],i=0;i<objUnit.authors.length;i++){var author=objUnit.authors[i];arrAuthorAddresses.push(author.address);var definition=author.definition,definition_chash=null;if(definition?(definition_chash=objectHash.getChash160(definition),conn.addQuery(arrQueries,"INSERT "+conn.getIgnore()+" INTO definitions (definition_chash, definition, has_references) VALUES (?,?,?)",[definition_chash,JSON.stringify(definition),Definition.hasReferences(definition)?1:0]),definition_chash===author.address&&conn.addQuery(arrQueries,"INSERT "+conn.getIgnore()+" INTO addresses (address) VALUES(?)",[author.address])):objUnit.content_hash&&conn.addQuery(arrQueries,"INSERT "+conn.getIgnore()+" INTO addresses (address) VALUES(?)",[author.address]),conn.addQuery(arrQueries,"INSERT INTO unit_authors (unit, address, definition_chash) VALUES(?,?,?)",[objUnit.unit,author.address,definition_chash]),!objUnit.content_hash)for(var path in author.authentifiers)conn.addQuery(arrQueries,"INSERT INTO authentifiers (unit, address, path, authentifier) VALUES(?,?,?,?)",[objUnit.unit,author.address,path,author.authentifiers[path]])}if(!objUnit.content_hash)for(var i=0;i<objUnit.messages.length;i++){var message=objUnit.messages[i],text_payload=null;if("text"===message.app?text_payload=message.payload:"data"!==message.app&&"profile"!==message.app&&"attestation"!==message.app&&"definition_template"!==message.app||(text_payload=JSON.stringify(message.payload)),conn.addQuery(arrQueries,"INSERT INTO messages \n\t\t\t\t\t(unit, message_index, app, payload_hash, payload_location, payload, payload_uri, payload_uri_hash) VALUES(?,?,?,?,?,?,?,?)",[objUnit.unit,i,message.app,message.payload_hash,message.payload_location,text_payload,message.payload_uri,message.payload_uri_hash]),
"inline"===message.payload_location)switch(message.app){case"address_definition_change":var definition_chash=message.payload.definition_chash,address=message.payload.address||objUnit.authors[0].address;conn.addQuery(arrQueries,"INSERT INTO address_definition_changes (unit, message_index, address, definition_chash) VALUES(?,?,?,?)",[objUnit.unit,i,address,definition_chash]);break;case"poll":var poll=message.payload;conn.addQuery(arrQueries,"INSERT INTO polls (unit, message_index, question) VALUES(?,?,?)",[objUnit.unit,i,poll.question]);for(var j=0;j<poll.choices.length;j++)conn.addQuery(arrQueries,"INSERT INTO poll_choices (unit, choice_index, choice) VALUES(?,?,?)",[objUnit.unit,j,poll.choices[j]]);break;case"vote":var vote=message.payload;conn.addQuery(arrQueries,"INSERT INTO votes (unit, message_index, poll_unit, choice) VALUES (?,?,?,?)",[objUnit.unit,i,vote.unit,vote.choice]);break;case"attestation":var attestation=message.payload;conn.addQuery(arrQueries,"INSERT INTO attestations (unit, message_index, attestor_address, address) VALUES(?,?,?,?)",[objUnit.unit,i,objUnit.authors[0].address,attestation.address]);break;case"asset":var asset=message.payload;if(conn.addQuery(arrQueries,"INSERT INTO assets (unit, message_index, \n\t\t\t\t\t\t\t\tcap, is_private, is_transferrable, auto_destroy, fixed_denominations, \n\t\t\t\t\t\t\t\tissued_by_definer_only, cosigned_by_definer, spender_attested, \n\t\t\t\t\t\t\t\tissue_condition, transfer_condition) VALUES(?,?,?,?,?,?,?,?,?,?,?,?)",[objUnit.unit,i,asset.cap,asset.is_private?1:0,asset.is_transferrable?1:0,asset.auto_destroy?1:0,asset.fixed_denominations?1:0,asset.issued_by_definer_only?1:0,asset.cosigned_by_definer?1:0,asset.spender_attested?1:0,asset.issue_condition?JSON.stringify(asset.issue_condition):null,asset.transfer_condition?JSON.stringify(asset.transfer_condition):null]),asset.attestors)for(var j=0;j<asset.attestors.length;j++)conn.addQuery(arrQueries,"INSERT INTO asset_attestors (unit, message_index, asset, attestor_address) VALUES(?,?,?,?)",[objUnit.unit,i,objUnit.unit,asset.attestors[j]]);if(asset.denominations)for(var j=0;j<asset.denominations.length;j++)conn.addQuery(arrQueries,"INSERT INTO asset_denominations (asset, denomination, count_coins) VALUES(?,?,?)",[objUnit.unit,asset.denominations[j].denomination,asset.denominations[j].count_coins]);break;case"asset_attestors":for(var asset_attestors=message.payload,j=0;j<asset_attestors.attestors.length;j++)conn.addQuery(arrQueries,"INSERT INTO asset_attestors (unit, message_index, asset, attestor_address) VALUES(?,?,?,?)",[objUnit.unit,i,asset_attestors.asset,asset_attestors.attestors[j]]);break;case"data_feed":var data=message.payload;for(var feed_name in data){var value=data[feed_name],field_name="string"==typeof value?"`value`":"int_value";conn.addQuery(arrQueries,"INSERT INTO data_feeds (unit, message_index, feed_name, "+field_name+") VALUES(?,?,?,?)",[objUnit.unit,i,feed_name,value])}break;case"payment":}if("spend_proofs"in message)for(var j=0;j<message.spend_proofs.length;j++){var objSpendProof=message.spend_proofs[j];conn.addQuery(arrQueries,"INSERT INTO spend_proofs (unit, message_index, spend_proof_index, spend_proof, address) VALUES(?,?,?,?,?)",[objUnit.unit,i,j,objSpendProof.spend_proof,objSpendProof.address||arrAuthorAddresses[0]])}}if("earned_headers_commission_recipients"in objUnit)for(var i=0;i<objUnit.earned_headers_commission_recipients.length;i++){var recipient=objUnit.earned_headers_commission_recipients[i];conn.addQuery(arrQueries,"INSERT INTO earned_headers_commission_recipients (unit, address, earned_headers_commission_share) VALUES(?,?,?)",[objUnit.unit,recipient.address,recipient.earned_headers_commission_share])}var my_best_parent_unit;mutex.lock(["write"],function(unlock){console.log("got lock to write "+objUnit.unit),addInlinePaymentQueries(function(){async.series(arrQueries,function(){profiler.stop("write-raw"),profiler.start();var arrOps=[];objUnit.parent_units&&(conf.bLight||(arrOps.push(updateBestParent),arrOps.push(updateLevel),arrOps.push(updateWitnessedLevel),arrOps.push(function(cb){console.log("updating MC after adding "+objUnit.unit),main_chain.updateMainChain(conn,null,cb)})),preCommitCallback&&arrOps.push(function(cb){console.log("executing pre-commit callback"),preCommitCallback(conn,cb)})),async.series(arrOps,function(err){profiler.start(),conn.query(err?"ROLLBACK":"COMMIT",function(){conn.release(),console.log((err?err+", therefore rolled back unit ":"committed unit ")+objUnit.unit),profiler.stop("write-commit"),profiler.increment(),unlock(),err||eventBus.emit("saved_unit-"+objUnit.unit,objJoint),onDone&&onDone(err),count_writes++,"sqlite"===conf.storage&&updateSqliteStats()})})})})})})}function readCountOfAnalyzedUnits(handleCount){return count_units_in_prev_analyze?handleCount(count_units_in_prev_analyze):void db.query("SELECT * FROM sqlite_master WHERE type='table' AND name='sqlite_stat1'",function(rows){return 0===rows.length?handleCount(0):void db.query("SELECT stat FROM sqlite_stat1 WHERE tbl='units' AND idx='sqlite_autoindex_units_1'",function(rows){return 1!==rows.length?(console.log("no stat for sqlite_autoindex_units_1"),handleCount(0)):void handleCount(parseInt(rows[0].stat.split(" ")[0]))})})}function updateSqliteStats(){count_writes%100===0&&db.query("SELECT MAX(rowid) AS count_units FROM units",function(rows){var count_units=rows[0].count_units;readCountOfAnalyzedUnits(function(count_analyzed_units){console.log("count analyzed units: "+count_analyzed_units),count_units<2*count_analyzed_units||(count_units_in_prev_analyze=count_units,console.log("will update sqlite stats"),db.query("ANALYZE",function(){db.query("ANALYZE sqlite_master",function(){console.log("sqlite stats updated")})}))})})}var async=(require("lodash"),require("async")),constants=require("./constants.js"),conf=require("./conf.js"),storage=require("./storage.js"),db=require("./db.js"),objectHash=require("./object_hash.js"),mutex=require("./mutex.js"),main_chain=require("./main_chain.js"),Definition=require("./definition.js"),eventBus=require("./event_bus.js"),profiler=require("./profiler.js"),count_writes=0,count_units_in_prev_analyze=0;exports.saveJoint=saveJoint},{"./conf.js":370,"./constants.js":371,"./db.js":372,"./definition.js":373,"./event_bus.js":378,"./main_chain.js":385,"./mutex.js":388,"./object_hash.js":392,"./profiler.js":398,"./storage.js":402,async:26,lodash:271}],412:[function(require,module,exports){!function(root){"use strict";function fromCache(next,cp,needFeature){var ret=cache[cp];return ret||(ret=next(cp,needFeature),ret.feature&&++cacheCounter[cp>>8&255]>CACHE_THRESHOLD&&(cache[cp]=ret)),ret}function fromData(next,cp,needFeature){var hash=65280&cp,dunit=UChar.udata[hash]||{},f=dunit[cp];return f?new UChar(cp,f):new UChar(cp,DEFAULT_FEATURE)}function fromCpOnly(next,cp,needFeature){return needFeature?next(cp,needFeature):new UChar(cp,null)}function fromRuleBasedJamo(next,cp,needFeature){var j;if(cp<LBase||LBase+LCount<=cp&&cp<SBase||SBase+SCount<cp)return next(cp,needFeature);if(LBase<=cp&&cp<LBase+LCount){var c={},base=(cp-LBase)*VCount;for(j=0;j<VCount;++j)c[VBase+j]=SBase+TCount*(j+base);return new UChar(cp,[,,c])}var SIndex=cp-SBase,TIndex=SIndex%TCount,feature=[];if(0!==TIndex)feature[0]=[SBase+SIndex-TIndex,TBase+TIndex];else for(feature[0]=[LBase+Math.floor(SIndex/NCount),VBase+Math.floor(SIndex%NCount/TCount)],feature[2]={},j=1;j<TCount;++j)feature[2][TBase+j]=cp+j;return new UChar(cp,feature)}function fromCpFilter(next,cp,needFeature){return cp<60||13311<cp&&cp<42607?new UChar(cp,DEFAULT_FEATURE):next(cp,needFeature)}function nfd(str){return normalize("NFD",str)}function nfkd(str){return normalize("NFKD",str)}function nfc(str){return normalize("NFC",str)}function nfkc(str){return normalize("NFKC",str)}for(var DEFAULT_FEATURE=[null,0,{}],CACHE_THRESHOLD=10,SBase=44032,LBase=4352,VBase=4449,TBase=4519,LCount=19,VCount=21,TCount=28,NCount=VCount*TCount,SCount=LCount*NCount,UChar=function(cp,feature){this.codepoint=cp,this.feature=feature},cache={},cacheCounter=[],i=0;i<=255;++i)cacheCounter[i]=0;var strategies=[fromCpFilter,fromCache,fromCpOnly,fromRuleBasedJamo,fromData];UChar.fromCharCode=strategies.reduceRight(function(next,strategy){return function(cp,needFeature){return strategy(next,cp,needFeature)}},null),UChar.isHighSurrogate=function(cp){return cp>=55296&&cp<=56319},UChar.isLowSurrogate=function(cp){return cp>=56320&&cp<=57343},UChar.prototype.prepFeature=function(){this.feature||(this.feature=UChar.fromCharCode(this.codepoint,!0).feature)},UChar.prototype.toString=function(){if(this.codepoint<65536)return String.fromCharCode(this.codepoint);var x=this.codepoint-65536;return String.fromCharCode(Math.floor(x/1024)+55296,x%1024+56320)},UChar.prototype.getDecomp=function(){return this.prepFeature(),this.feature[0]||null},UChar.prototype.isCompatibility=function(){return this.prepFeature(),!!this.feature[1]&&256&this.feature[1]},UChar.prototype.isExclude=function(){return this.prepFeature(),!!this.feature[1]&&512&this.feature[1]},UChar.prototype.getCanonicalClass=function(){return this.prepFeature(),this.feature[1]?255&this.feature[1]:0},UChar.prototype.getComposite=function(following){if(this.prepFeature(),!this.feature[2])return null;var cp=this.feature[2][following.codepoint];return cp?UChar.fromCharCode(cp):null};var UCharIterator=function(str){this.str=str,this.cursor=0};UCharIterator.prototype.next=function(){if(this.str&&this.cursor<this.str.length){var d,cp=this.str.charCodeAt(this.cursor++);return UChar.isHighSurrogate(cp)&&this.cursor<this.str.length&&UChar.isLowSurrogate(d=this.str.charCodeAt(this.cursor))&&(cp=1024*(cp-55296)+(d-56320)+65536,++this.cursor),UChar.fromCharCode(cp)}return this.str=null,null};var RecursDecompIterator=function(it,cano){this.it=it,this.canonical=cano,this.resBuf=[]};RecursDecompIterator.prototype.next=function(){function recursiveDecomp(cano,uchar){var decomp=uchar.getDecomp();if(!decomp||cano&&uchar.isCompatibility())return[uchar];for(var ret=[],i=0;i<decomp.length;++i){var a=recursiveDecomp(cano,UChar.fromCharCode(decomp[i]));ret=ret.concat(a)}return ret}if(0===this.resBuf.length){var uchar=this.it.next();if(!uchar)return null;this.resBuf=recursiveDecomp(this.canonical,uchar)}return this.resBuf.shift()};var DecompIterator=function(it){this.it=it,this.resBuf=[]};DecompIterator.prototype.next=function(){var cc;if(0===this.resBuf.length)do{var uchar=this.it.next();if(!uchar)break;cc=uchar.getCanonicalClass();var inspt=this.resBuf.length;if(0!==cc)for(;inspt>0;--inspt){var uchar2=this.resBuf[inspt-1],cc2=uchar2.getCanonicalClass();if(cc2<=cc)break}this.resBuf.splice(inspt,0,uchar)}while(0!==cc);return this.resBuf.shift()};var CompIterator=function(it){this.it=it,this.procBuf=[],this.resBuf=[],this.lastClass=null};CompIterator.prototype.next=function(){for(;0===this.resBuf.length;){var uchar=this.it.next();if(!uchar){this.resBuf=this.procBuf,this.procBuf=[];break}if(0===this.procBuf.length)this.lastClass=uchar.getCanonicalClass(),this.procBuf.push(uchar);else{var starter=this.procBuf[0],composite=starter.getComposite(uchar),cc=uchar.getCanonicalClass();composite&&(this.lastClass<cc||0===this.lastClass)?this.procBuf[0]=composite:(0===cc&&(this.resBuf=this.procBuf,this.procBuf=[]),this.lastClass=cc,this.procBuf.push(uchar))}}return this.resBuf.shift()};var createIterator=function(mode,str){switch(mode){case"NFD":return new DecompIterator(new RecursDecompIterator(new UCharIterator(str),(!0)));case"NFKD":return new DecompIterator(new RecursDecompIterator(new UCharIterator(str),(!1)));case"NFC":return new CompIterator(new DecompIterator(new RecursDecompIterator(new UCharIterator(str),(!0))));case"NFKC":return new CompIterator(new DecompIterator(new RecursDecompIterator(new UCharIterator(str),(!1))))}throw mode+" is invalid"},normalize=function(mode,str){for(var uchar,it=createIterator(mode,str),ret="";uchar=it.next();)ret+=uchar.toString();return ret};UChar.udata={0:{60:[,,{824:8814}],61:[,,{824:8800}],62:[,,{824:8815}],65:[,,{768:192,769:193,770:194,771:195,772:256,774:258,775:550,776:196,777:7842,778:197,780:461,783:512,785:514,803:7840,805:7680,808:260}],66:[,,{775:7682,803:7684,817:7686}],67:[,,{769:262,770:264,775:266,780:268,807:199}],68:[,,{775:7690,780:270,803:7692,807:7696,813:7698,817:7694}],69:[,,{768:200,769:201,770:202,771:7868,772:274,774:276,775:278,776:203,777:7866,780:282,783:516,785:518,803:7864,807:552,808:280,813:7704,816:7706}],70:[,,{775:7710}],71:[,,{769:500,770:284,772:7712,774:286,775:288,780:486,807:290}],72:[,,{770:292,775:7714,776:7718,780:542,803:7716,807:7720,814:7722}],73:[,,{768:204,769:205,770:206,771:296,772:298,774:300,775:304,776:207,777:7880,780:463,783:520,785:522,803:7882,808:302,816:7724}],74:[,,{770:308}],75:[,,{769:7728,780:488,803:7730,807:310,817:7732}],76:[,,{769:313,780:317,803:7734,807:315,813:7740,817:7738}],77:[,,{769:7742,775:7744,803:7746}],78:[,,{768:504,769:323,771:209,775:7748,780:327,803:7750,807:325,813:7754,817:7752}],79:[,,{768:210,769:211,770:212,771:213,772:332,774:334,775:558,776:214,777:7886,779:336,780:465,783:524,785:526,795:416,803:7884,808:490}],80:[,,{769:7764,775:7766}],82:[,,{769:340,775:7768,780:344,783:528,785:530,803:7770,807:342,817:7774}],83:[,,{769:346,770:348,775:7776,780:352,803:7778,806:536,807:350}],84:[,,{775:7786,780:356,803:7788,806:538,807:354,813:7792,817:7790}],85:[,,{768:217,769:218,770:219,771:360,772:362,774:364,776:220,777:7910,778:366,779:368,780:467,783:532,785:534,795:431,803:7908,804:7794,808:370,813:7798,816:7796}],86:[,,{771:7804,803:7806}],87:[,,{768:7808,769:7810,770:372,775:7814,776:7812,803:7816}],88:[,,{775:7818,776:7820}],89:[,,{768:7922,769:221,770:374,771:7928,772:562,775:7822,776:376,777:7926,803:7924}],90:[,,{769:377,770:7824,775:379,780:381,803:7826,817:7828}],97:[,,{768:224,769:225,770:226,771:227,772:257,774:259,775:551,776:228,777:7843,778:229,780:462,783:513,785:515,803:7841,805:7681,808:261}],98:[,,{775:7683,803:7685,817:7687}],99:[,,{769:263,770:265,775:267,780:269,807:231}],100:[,,{775:7691,780:271,803:7693,807:7697,813:7699,817:7695}],101:[,,{768:232,769:233,770:234,771:7869,772:275,774:277,775:279,776:235,777:7867,780:283,783:517,785:519,803:7865,807:553,808:281,813:7705,816:7707}],102:[,,{775:7711}],103:[,,{769:501,770:285,772:7713,774:287,775:289,780:487,807:291}],104:[,,{770:293,775:7715,776:7719,780:543,803:7717,807:7721,814:7723,817:7830}],105:[,,{768:236,769:237,770:238,771:297,772:299,774:301,776:239,777:7881,780:464,783:521,785:523,803:7883,808:303,816:7725}],106:[,,{770:309,780:496}],107:[,,{769:7729,780:489,803:7731,807:311,817:7733}],108:[,,{769:314,780:318,803:7735,807:316,813:7741,817:7739}],109:[,,{769:7743,775:7745,803:7747}],110:[,,{768:505,769:324,771:241,775:7749,780:328,803:7751,807:326,813:7755,817:7753}],111:[,,{768:242,769:243,770:244,771:245,772:333,774:335,775:559,776:246,777:7887,779:337,780:466,783:525,785:527,795:417,803:7885,808:491}],112:[,,{769:7765,775:7767}],114:[,,{769:341,775:7769,780:345,783:529,785:531,803:7771,807:343,817:7775}],115:[,,{769:347,770:349,775:7777,780:353,803:7779,806:537,807:351}],116:[,,{775:7787,776:7831,780:357,803:7789,806:539,807:355,813:7793,817:7791}],117:[,,{768:249,769:250,770:251,771:361,772:363,774:365,776:252,777:7911,778:367,779:369,780:468,783:533,785:535,795:432,803:7909,804:7795,808:371,813:7799,816:7797}],118:[,,{771:7805,803:7807}],119:[,,{768:7809,769:7811,770:373,775:7815,776:7813,778:7832,803:7817}],120:[,,{775:7819,776:7821}],121:[,,{768:7923,769:253,770:375,771:7929,772:563,775:7823,776:255,777:7927,778:7833,803:7925}],122:[,,{769:378,770:7825,775:380,780:382,803:7827,817:7829}],160:[[32],256],168:[[32,776],256,{768:8173,769:901,834:8129}],170:[[97],256],175:[[32,772],256],178:[[50],256],179:[[51],256],180:[[32,769],256],181:[[956],256],184:[[32,807],256],185:[[49],256],186:[[111],256],188:[[49,8260,52],256],189:[[49,8260,50],256],190:[[51,8260,52],256],192:[[65,768]],193:[[65,769]],194:[[65,770],,{768:7846,769:7844,771:7850,777:7848}],195:[[65,771]],196:[[65,776],,{772:478}],197:[[65,778],,{769:506}],198:[,,{769:508,772:482}],199:[[67,807],,{769:7688}],200:[[69,768]],201:[[69,769]],202:[[69,770],,{768:7872,769:7870,771:7876,777:7874}],203:[[69,776]],204:[[73,768]],205:[[73,769]],206:[[73,770]],207:[[73,776],,{769:7726}],209:[[78,771]],210:[[79,768]],211:[[79,769]],212:[[79,770],,{768:7890,769:7888,771:7894,777:7892}],213:[[79,771],,{769:7756,772:556,776:7758}],214:[[79,776],,{772:554}],216:[,,{769:510}],217:[[85,768]],218:[[85,769]],219:[[85,770]],220:[[85,776],,{768:475,769:471,772:469,780:473}],221:[[89,769]],224:[[97,768]],225:[[97,769]],226:[[97,770],,{768:7847,769:7845,771:7851,777:7849}],227:[[97,771]],228:[[97,776],,{772:479}],229:[[97,778],,{769:507}],230:[,,{769:509,772:483}],231:[[99,807],,{769:7689}],232:[[101,768]],233:[[101,769]],234:[[101,770],,{768:7873,769:7871,771:7877,777:7875}],235:[[101,776]],236:[[105,768]],237:[[105,769]],238:[[105,770]],239:[[105,776],,{769:7727}],241:[[110,771]],242:[[111,768]],243:[[111,769]],244:[[111,770],,{768:7891,769:7889,771:7895,777:7893}],245:[[111,771],,{769:7757,772:557,776:7759}],246:[[111,776],,{772:555}],248:[,,{769:511}],249:[[117,768]],250:[[117,769]],251:[[117,770]],252:[[117,776],,{768:476,769:472,772:470,780:474}],253:[[121,769]],255:[[121,776]]},256:{256:[[65,772]],257:[[97,772]],258:[[65,774],,{768:7856,769:7854,771:7860,777:7858}],259:[[97,774],,{768:7857,769:7855,771:7861,777:7859}],260:[[65,808]],261:[[97,808]],262:[[67,769]],263:[[99,769]],264:[[67,770]],265:[[99,770]],266:[[67,775]],267:[[99,775]],268:[[67,780]],269:[[99,780]],270:[[68,780]],271:[[100,780]],274:[[69,772],,{768:7700,769:7702}],275:[[101,772],,{768:7701,769:7703}],276:[[69,774]],277:[[101,774]],278:[[69,775]],279:[[101,775]],280:[[69,808]],281:[[101,808]],282:[[69,780]],283:[[101,780]],284:[[71,770]],285:[[103,770]],286:[[71,774]],287:[[103,774]],288:[[71,775]],289:[[103,775]],290:[[71,807]],291:[[103,807]],292:[[72,770]],293:[[104,770]],296:[[73,771]],297:[[105,771]],298:[[73,772]],299:[[105,772]],300:[[73,774]],301:[[105,774]],302:[[73,808]],303:[[105,808]],304:[[73,775]],306:[[73,74],256],307:[[105,106],256],308:[[74,770]],309:[[106,770]],310:[[75,807]],311:[[107,807]],313:[[76,769]],314:[[108,769]],315:[[76,807]],316:[[108,807]],317:[[76,780]],318:[[108,780]],319:[[76,183],256],320:[[108,183],256],323:[[78,769]],324:[[110,769]],325:[[78,807]],326:[[110,807]],327:[[78,780]],328:[[110,780]],329:[[700,110],256],332:[[79,772],,{768:7760,769:7762}],333:[[111,772],,{768:7761,769:7763}],334:[[79,774]],335:[[111,774]],336:[[79,779]],337:[[111,779]],340:[[82,769]],341:[[114,769]],342:[[82,807]],343:[[114,807]],344:[[82,780]],345:[[114,780]],346:[[83,769],,{775:7780}],347:[[115,769],,{775:7781}],348:[[83,770]],349:[[115,770]],350:[[83,807]],351:[[115,807]],352:[[83,780],,{775:7782}],353:[[115,780],,{775:7783}],354:[[84,807]],355:[[116,807]],356:[[84,780]],357:[[116,780]],360:[[85,771],,{769:7800}],361:[[117,771],,{769:7801}],362:[[85,772],,{776:7802}],363:[[117,772],,{776:7803}],364:[[85,774]],365:[[117,774]],366:[[85,778]],367:[[117,778]],368:[[85,779]],369:[[117,779]],370:[[85,808]],371:[[117,808]],372:[[87,770]],373:[[119,770]],374:[[89,770]],375:[[121,770]],376:[[89,776]],377:[[90,769]],378:[[122,769]],379:[[90,775]],380:[[122,775]],381:[[90,780]],382:[[122,780]],383:[[115],256,{775:7835}],416:[[79,795],,{768:7900,769:7898,771:7904,777:7902,803:7906}],417:[[111,795],,{768:7901,769:7899,771:7905,777:7903,803:7907}],431:[[85,795],,{768:7914,769:7912,771:7918,777:7916,803:7920}],432:[[117,795],,{768:7915,769:7913,771:7919,777:7917,803:7921}],439:[,,{780:494}],452:[[68,381],256],453:[[68,382],256],454:[[100,382],256],455:[[76,74],256],456:[[76,106],256],457:[[108,106],256],458:[[78,74],256],459:[[78,106],256],460:[[110,106],256],461:[[65,780]],462:[[97,780]],463:[[73,780]],464:[[105,780]],465:[[79,780]],466:[[111,780]],467:[[85,780]],468:[[117,780]],469:[[220,772]],470:[[252,772]],471:[[220,769]],472:[[252,769]],473:[[220,780]],474:[[252,780]],475:[[220,768]],476:[[252,768]],478:[[196,772]],479:[[228,772]],480:[[550,772]],481:[[551,772]],482:[[198,772]],483:[[230,772]],486:[[71,780]],487:[[103,780]],488:[[75,780]],489:[[107,780]],490:[[79,808],,{772:492}],491:[[111,808],,{772:493}],492:[[490,772]],493:[[491,772]],494:[[439,780]],495:[[658,780]],496:[[106,780]],497:[[68,90],256],498:[[68,122],256],499:[[100,122],256],500:[[71,769]],501:[[103,769]],504:[[78,768]],505:[[110,768]],506:[[197,769]],507:[[229,769]],508:[[198,769]],509:[[230,769]],510:[[216,769]],511:[[248,769]],66045:[,220]},512:{512:[[65,783]],513:[[97,783]],514:[[65,785]],515:[[97,785]],516:[[69,783]],517:[[101,783]],518:[[69,785]],519:[[101,785]],520:[[73,783]],521:[[105,783]],522:[[73,785]],523:[[105,785]],524:[[79,783]],525:[[111,783]],526:[[79,785]],527:[[111,785]],528:[[82,783]],529:[[114,783]],530:[[82,785]],531:[[114,785]],532:[[85,783]],533:[[117,783]],534:[[85,785]],535:[[117,785]],536:[[83,806]],537:[[115,806]],538:[[84,806]],539:[[116,806]],542:[[72,780]],543:[[104,780]],550:[[65,775],,{772:480}],551:[[97,775],,{772:481}],552:[[69,807],,{774:7708}],553:[[101,807],,{774:7709}],554:[[214,772]],555:[[246,772]],556:[[213,772]],557:[[245,772]],558:[[79,775],,{772:560}],559:[[111,775],,{772:561}],560:[[558,772]],561:[[559,772]],562:[[89,772]],563:[[121,772]],658:[,,{780:495}],688:[[104],256],689:[[614],256],690:[[106],256],691:[[114],256],692:[[633],256],693:[[635],256],694:[[641],256],695:[[119],256],696:[[121],256],728:[[32,774],256],729:[[32,775],256],730:[[32,778],256],731:[[32,808],256],732:[[32,771],256],733:[[32,779],256],736:[[611],256],737:[[108],256],738:[[115],256],739:[[120],256],740:[[661],256],66272:[,220]},768:{768:[,230],769:[,230],770:[,230],771:[,230],772:[,230],773:[,230],774:[,230],775:[,230],776:[,230,{769:836}],777:[,230],778:[,230],779:[,230],780:[,230],781:[,230],782:[,230],783:[,230],784:[,230],785:[,230],786:[,230],787:[,230],788:[,230],789:[,232],790:[,220],791:[,220],792:[,220],793:[,220],794:[,232],795:[,216],796:[,220],797:[,220],798:[,220],799:[,220],800:[,220],801:[,202],802:[,202],803:[,220],804:[,220],805:[,220],806:[,220],807:[,202],808:[,202],809:[,220],810:[,220],811:[,220],812:[,220],813:[,220],814:[,220],815:[,220],816:[,220],817:[,220],818:[,220],819:[,220],820:[,1],821:[,1],822:[,1],823:[,1],824:[,1],825:[,220],826:[,220],827:[,220],828:[,220],829:[,230],830:[,230],831:[,230],832:[[768],230],833:[[769],230],834:[,230],835:[[787],230],836:[[776,769],230],837:[,240],838:[,230],839:[,220],840:[,220],841:[,220],842:[,230],843:[,230],844:[,230],845:[,220],846:[,220],848:[,230],849:[,230],850:[,230],851:[,220],852:[,220],853:[,220],854:[,220],855:[,230],856:[,232],857:[,220],858:[,220],859:[,230],860:[,233],861:[,234],862:[,234],863:[,233],864:[,234],865:[,234],866:[,233],867:[,230],868:[,230],869:[,230],870:[,230],871:[,230],872:[,230],873:[,230],874:[,230],875:[,230],876:[,230],877:[,230],878:[,230],879:[,230],884:[[697]],890:[[32,837],256],894:[[59]],900:[[32,769],256],901:[[168,769]],902:[[913,769]],903:[[183]],904:[[917,769]],905:[[919,769]],906:[[921,769]],908:[[927,769]],910:[[933,769]],911:[[937,769]],912:[[970,769]],913:[,,{768:8122,769:902,772:8121,774:8120,787:7944,788:7945,837:8124}],917:[,,{768:8136,769:904,787:7960,788:7961}],919:[,,{768:8138,769:905,787:7976,788:7977,837:8140}],921:[,,{768:8154,769:906,772:8153,774:8152,776:938,787:7992,788:7993}],927:[,,{768:8184,769:908,787:8008,788:8009}],929:[,,{788:8172}],933:[,,{768:8170,769:910,772:8169,774:8168,776:939,788:8025}],937:[,,{768:8186,769:911,787:8040,788:8041,837:8188}],938:[[921,776]],939:[[933,776]],940:[[945,769],,{837:8116}],941:[[949,769]],942:[[951,769],,{837:8132}],943:[[953,769]],944:[[971,769]],945:[,,{768:8048,769:940,772:8113,774:8112,787:7936,788:7937,834:8118,837:8115}],949:[,,{768:8050,769:941,787:7952,788:7953}],951:[,,{768:8052,769:942,787:7968,788:7969,834:8134,837:8131}],953:[,,{768:8054,769:943,772:8145,774:8144,776:970,787:7984,788:7985,834:8150}],959:[,,{768:8056,769:972,787:8e3,788:8001}],961:[,,{787:8164,788:8165}],965:[,,{768:8058,769:973,772:8161,774:8160,776:971,787:8016,788:8017,834:8166}],969:[,,{768:8060,769:974,787:8032,788:8033,834:8182,837:8179}],970:[[953,776],,{768:8146,769:912,834:8151}],971:[[965,776],,{768:8162,769:944,834:8167}],972:[[959,769]],973:[[965,769]],974:[[969,769],,{837:8180}],976:[[946],256],977:[[952],256],978:[[933],256,{769:979,776:980}],979:[[978,769]],980:[[978,776]],981:[[966],256],982:[[960],256],1008:[[954],256],1009:[[961],256],1010:[[962],256],1012:[[920],256],1013:[[949],256],1017:[[931],256],66422:[,230],66423:[,230],66424:[,230],66425:[,230],66426:[,230]},1024:{1024:[[1045,768]],1025:[[1045,776]],1027:[[1043,769]],1030:[,,{776:1031}],1031:[[1030,776]],1036:[[1050,769]],1037:[[1048,768]],1038:[[1059,774]],1040:[,,{774:1232,776:1234}],1043:[,,{769:1027}],1045:[,,{768:1024,774:1238,776:1025}],1046:[,,{774:1217,776:1244}],1047:[,,{776:1246}],1048:[,,{768:1037,772:1250,774:1049,776:1252}],1049:[[1048,774]],1050:[,,{769:1036}],1054:[,,{776:1254}],1059:[,,{772:1262,774:1038,776:1264,779:1266}],1063:[,,{776:1268}],1067:[,,{776:1272}],1069:[,,{776:1260}],1072:[,,{774:1233,776:1235}],1075:[,,{769:1107}],1077:[,,{768:1104,774:1239,776:1105}],1078:[,,{774:1218,776:1245}],1079:[,,{776:1247}],1080:[,,{768:1117,772:1251,774:1081,776:1253}],1081:[[1080,774]],1082:[,,{769:1116}],1086:[,,{776:1255}],1091:[,,{772:1263,774:1118,776:1265,779:1267}],1095:[,,{776:1269}],1099:[,,{776:1273}],1101:[,,{776:1261}],1104:[[1077,768]],1105:[[1077,776]],1107:[[1075,769]],1110:[,,{776:1111}],1111:[[1110,776]],1116:[[1082,769]],1117:[[1080,768]],1118:[[1091,774]],1140:[,,{783:1142}],1141:[,,{783:1143}],1142:[[1140,783]],1143:[[1141,783]],1155:[,230],1156:[,230],1157:[,230],1158:[,230],1159:[,230],1217:[[1046,774]],1218:[[1078,774]],1232:[[1040,774]],1233:[[1072,774]],1234:[[1040,776]],1235:[[1072,776]],1238:[[1045,774]],1239:[[1077,774]],1240:[,,{776:1242}],1241:[,,{776:1243}],1242:[[1240,776]],1243:[[1241,776]],1244:[[1046,776]],1245:[[1078,776]],1246:[[1047,776]],1247:[[1079,776]],1250:[[1048,772]],1251:[[1080,772]],1252:[[1048,776]],1253:[[1080,776]],1254:[[1054,776]],1255:[[1086,776]],1256:[,,{776:1258}],1257:[,,{776:1259}],1258:[[1256,776]],1259:[[1257,776]],1260:[[1069,776]],1261:[[1101,776]],1262:[[1059,772]],1263:[[1091,772]],1264:[[1059,776]],1265:[[1091,776]],1266:[[1059,779]],1267:[[1091,779]],1268:[[1063,776]],1269:[[1095,776]],1272:[[1067,776]],1273:[[1099,776]]},1280:{1415:[[1381,1410],256],1425:[,220],1426:[,230],1427:[,230],1428:[,230],1429:[,230],1430:[,220],1431:[,230],1432:[,230],1433:[,230],1434:[,222],1435:[,220],1436:[,230],1437:[,230],1438:[,230],1439:[,230],1440:[,230],1441:[,230],1442:[,220],1443:[,220],1444:[,220],1445:[,220],1446:[,220],1447:[,220],1448:[,230],1449:[,230],1450:[,220],1451:[,230],1452:[,230],1453:[,222],1454:[,228],1455:[,230],1456:[,10],1457:[,11],1458:[,12],1459:[,13],1460:[,14],1461:[,15],1462:[,16],1463:[,17],1464:[,18],1465:[,19],1466:[,19],1467:[,20],1468:[,21],1469:[,22],1471:[,23],1473:[,24],1474:[,25],1476:[,230],1477:[,220],1479:[,18]},1536:{1552:[,230],1553:[,230],1554:[,230],1555:[,230],1556:[,230],1557:[,230],1558:[,230],1559:[,230],1560:[,30],1561:[,31],1562:[,32],1570:[[1575,1619]],1571:[[1575,1620]],1572:[[1608,1620]],1573:[[1575,1621]],1574:[[1610,1620]],1575:[,,{1619:1570,1620:1571,1621:1573}],1608:[,,{1620:1572}],1610:[,,{1620:1574}],1611:[,27],1612:[,28],1613:[,29],1614:[,30],1615:[,31],1616:[,32],1617:[,33],1618:[,34],1619:[,230],1620:[,230],1621:[,220],1622:[,220],1623:[,230],1624:[,230],1625:[,230],1626:[,230],1627:[,230],1628:[,220],1629:[,230],1630:[,230],1631:[,220],1648:[,35],1653:[[1575,1652],256],1654:[[1608,1652],256],1655:[[1735,1652],256],1656:[[1610,1652],256],1728:[[1749,1620]],1729:[,,{1620:1730}],1730:[[1729,1620]],1746:[,,{1620:1747}],1747:[[1746,1620]],1749:[,,{1620:1728}],1750:[,230],1751:[,230],1752:[,230],1753:[,230],1754:[,230],1755:[,230],1756:[,230],1759:[,230],1760:[,230],1761:[,230],1762:[,230],1763:[,220],1764:[,230],1767:[,230],1768:[,230],1770:[,220],1771:[,230],1772:[,230],1773:[,220]},1792:{1809:[,36],1840:[,230],1841:[,220],1842:[,230],1843:[,230],1844:[,220],1845:[,230],1846:[,230],1847:[,220],1848:[,220],1849:[,220],1850:[,230],1851:[,220],1852:[,220],1853:[,230],1854:[,220],1855:[,230],1856:[,230],1857:[,230],1858:[,220],1859:[,230],1860:[,220],1861:[,230],1862:[,220],1863:[,230],1864:[,220],1865:[,230],1866:[,230],2027:[,230],2028:[,230],2029:[,230],2030:[,230],2031:[,230],2032:[,230],2033:[,230],2034:[,220],2035:[,230]},2048:{2070:[,230],2071:[,230],2072:[,230],2073:[,230],2075:[,230],2076:[,230],2077:[,230],2078:[,230],2079:[,230],2080:[,230],2081:[,230],2082:[,230],2083:[,230],2085:[,230],2086:[,230],2087:[,230],2089:[,230],2090:[,230],2091:[,230],2092:[,230],2093:[,230],2137:[,220],2138:[,220],2139:[,220],2276:[,230],2277:[,230],2278:[,220],2279:[,230],2280:[,230],2281:[,220],2282:[,230],2283:[,230],2284:[,230],2285:[,220],2286:[,220],2287:[,220],2288:[,27],2289:[,28],2290:[,29],2291:[,230],2292:[,230],2293:[,230],2294:[,220],2295:[,230],2296:[,230],2297:[,220],2298:[,220],2299:[,230],2300:[,230],2301:[,230],2302:[,230],2303:[,230]},2304:{2344:[,,{2364:2345}],2345:[[2344,2364]],2352:[,,{2364:2353}],2353:[[2352,2364]],2355:[,,{2364:2356}],2356:[[2355,2364]],2364:[,7],2381:[,9],2385:[,230],2386:[,220],2387:[,230],2388:[,230],2392:[[2325,2364],512],2393:[[2326,2364],512],2394:[[2327,2364],512],2395:[[2332,2364],512],2396:[[2337,2364],512],2397:[[2338,2364],512],2398:[[2347,2364],512],2399:[[2351,2364],512],2492:[,7],2503:[,,{2494:2507,2519:2508}],2507:[[2503,2494]],2508:[[2503,2519]],2509:[,9],2524:[[2465,2492],512],2525:[[2466,2492],512],2527:[[2479,2492],512]},2560:{2611:[[2610,2620],512],2614:[[2616,2620],512],2620:[,7],2637:[,9],2649:[[2582,2620],512],2650:[[2583,2620],512],2651:[[2588,2620],512],2654:[[2603,2620],512],2748:[,7],2765:[,9],68109:[,220],68111:[,230],68152:[,230],68153:[,1],68154:[,220],68159:[,9],68325:[,230],68326:[,220]},2816:{2876:[,7],2887:[,,{2878:2891,2902:2888,2903:2892}],2888:[[2887,2902]],2891:[[2887,2878]],2892:[[2887,2903]],2893:[,9],2908:[[2849,2876],512],2909:[[2850,2876],512],2962:[,,{3031:2964}],2964:[[2962,3031]],3014:[,,{3006:3018,3031:3020}],3015:[,,{3006:3019}],3018:[[3014,3006]],3019:[[3015,3006]],3020:[[3014,3031]],3021:[,9]},3072:{3142:[,,{3158:3144}],3144:[[3142,3158]],3149:[,9],3157:[,84],3158:[,91],3260:[,7],3263:[,,{3285:3264}],3264:[[3263,3285]],3270:[,,{3266:3274,3285:3271,3286:3272}],3271:[[3270,3285]],3272:[[3270,3286]],3274:[[3270,3266],,{3285:3275}],3275:[[3274,3285]],3277:[,9]},3328:{3398:[,,{3390:3402,3415:3404}],3399:[,,{3390:3403}],3402:[[3398,3390]],3403:[[3399,3390]],3404:[[3398,3415]],3405:[,9],3530:[,9],3545:[,,{3530:3546,3535:3548,3551:3550}],3546:[[3545,3530]],3548:[[3545,3535],,{3530:3549}],3549:[[3548,3530]],3550:[[3545,3551]]},3584:{3635:[[3661,3634],256],3640:[,103],3641:[,103],3642:[,9],3656:[,107],3657:[,107],3658:[,107],3659:[,107],3763:[[3789,3762],256],3768:[,118],3769:[,118],3784:[,122],3785:[,122],3786:[,122],3787:[,122],3804:[[3755,3737],256],3805:[[3755,3745],256]},3840:{3852:[[3851],256],3864:[,220],3865:[,220],3893:[,220],3895:[,220],3897:[,216],3907:[[3906,4023],512],3917:[[3916,4023],512],3922:[[3921,4023],512],3927:[[3926,4023],512],3932:[[3931,4023],512],3945:[[3904,4021],512],3953:[,129],3954:[,130],3955:[[3953,3954],512],3956:[,132],3957:[[3953,3956],512],3958:[[4018,3968],512],3959:[[4018,3969],256],3960:[[4019,3968],512],3961:[[4019,3969],256],3962:[,130],3963:[,130],3964:[,130],3965:[,130],3968:[,130],3969:[[3953,3968],512],3970:[,230],3971:[,230],3972:[,9],3974:[,230],3975:[,230],3987:[[3986,4023],512],3997:[[3996,4023],512],4002:[[4001,4023],512],4007:[[4006,4023],512],4012:[[4011,4023],512],4025:[[3984,4021],512],4038:[,220]},4096:{4133:[,,{4142:4134}],4134:[[4133,4142]],4151:[,7],4153:[,9],4154:[,9],4237:[,220],4348:[[4316],256],69702:[,9],69759:[,9],69785:[,,{69818:69786}],69786:[[69785,69818]],
69787:[,,{69818:69788}],69788:[[69787,69818]],69797:[,,{69818:69803}],69803:[[69797,69818]],69817:[,9],69818:[,7]},4352:{69888:[,230],69889:[,230],69890:[,230],69934:[[69937,69927]],69935:[[69938,69927]],69937:[,,{69927:69934}],69938:[,,{69927:69935}],69939:[,9],69940:[,9],70003:[,7],70080:[,9]},4608:{70197:[,9],70198:[,7],70377:[,7],70378:[,9]},4864:{4957:[,230],4958:[,230],4959:[,230],70460:[,7],70471:[,,{70462:70475,70487:70476}],70475:[[70471,70462]],70476:[[70471,70487]],70477:[,9],70502:[,230],70503:[,230],70504:[,230],70505:[,230],70506:[,230],70507:[,230],70508:[,230],70512:[,230],70513:[,230],70514:[,230],70515:[,230],70516:[,230]},5120:{70841:[,,{70832:70844,70842:70843,70845:70846}],70843:[[70841,70842]],70844:[[70841,70832]],70846:[[70841,70845]],70850:[,9],70851:[,7]},5376:{71096:[,,{71087:71098}],71097:[,,{71087:71099}],71098:[[71096,71087]],71099:[[71097,71087]],71103:[,9],71104:[,7]},5632:{71231:[,9],71350:[,9],71351:[,7]},5888:{5908:[,9],5940:[,9],6098:[,9],6109:[,230]},6144:{6313:[,228]},6400:{6457:[,222],6458:[,230],6459:[,220]},6656:{6679:[,230],6680:[,220],6752:[,9],6773:[,230],6774:[,230],6775:[,230],6776:[,230],6777:[,230],6778:[,230],6779:[,230],6780:[,230],6783:[,220],6832:[,230],6833:[,230],6834:[,230],6835:[,230],6836:[,230],6837:[,220],6838:[,220],6839:[,220],6840:[,220],6841:[,220],6842:[,220],6843:[,230],6844:[,230],6845:[,220]},6912:{6917:[,,{6965:6918}],6918:[[6917,6965]],6919:[,,{6965:6920}],6920:[[6919,6965]],6921:[,,{6965:6922}],6922:[[6921,6965]],6923:[,,{6965:6924}],6924:[[6923,6965]],6925:[,,{6965:6926}],6926:[[6925,6965]],6929:[,,{6965:6930}],6930:[[6929,6965]],6964:[,7],6970:[,,{6965:6971}],6971:[[6970,6965]],6972:[,,{6965:6973}],6973:[[6972,6965]],6974:[,,{6965:6976}],6975:[,,{6965:6977}],6976:[[6974,6965]],6977:[[6975,6965]],6978:[,,{6965:6979}],6979:[[6978,6965]],6980:[,9],7019:[,230],7020:[,220],7021:[,230],7022:[,230],7023:[,230],7024:[,230],7025:[,230],7026:[,230],7027:[,230],7082:[,9],7083:[,9],7142:[,7],7154:[,9],7155:[,9]},7168:{7223:[,7],7376:[,230],7377:[,230],7378:[,230],7380:[,1],7381:[,220],7382:[,220],7383:[,220],7384:[,220],7385:[,220],7386:[,230],7387:[,230],7388:[,220],7389:[,220],7390:[,220],7391:[,220],7392:[,230],7394:[,1],7395:[,1],7396:[,1],7397:[,1],7398:[,1],7399:[,1],7400:[,1],7405:[,220],7412:[,230],7416:[,230],7417:[,230]},7424:{7468:[[65],256],7469:[[198],256],7470:[[66],256],7472:[[68],256],7473:[[69],256],7474:[[398],256],7475:[[71],256],7476:[[72],256],7477:[[73],256],7478:[[74],256],7479:[[75],256],7480:[[76],256],7481:[[77],256],7482:[[78],256],7484:[[79],256],7485:[[546],256],7486:[[80],256],7487:[[82],256],7488:[[84],256],7489:[[85],256],7490:[[87],256],7491:[[97],256],7492:[[592],256],7493:[[593],256],7494:[[7426],256],7495:[[98],256],7496:[[100],256],7497:[[101],256],7498:[[601],256],7499:[[603],256],7500:[[604],256],7501:[[103],256],7503:[[107],256],7504:[[109],256],7505:[[331],256],7506:[[111],256],7507:[[596],256],7508:[[7446],256],7509:[[7447],256],7510:[[112],256],7511:[[116],256],7512:[[117],256],7513:[[7453],256],7514:[[623],256],7515:[[118],256],7516:[[7461],256],7517:[[946],256],7518:[[947],256],7519:[[948],256],7520:[[966],256],7521:[[967],256],7522:[[105],256],7523:[[114],256],7524:[[117],256],7525:[[118],256],7526:[[946],256],7527:[[947],256],7528:[[961],256],7529:[[966],256],7530:[[967],256],7544:[[1085],256],7579:[[594],256],7580:[[99],256],7581:[[597],256],7582:[[240],256],7583:[[604],256],7584:[[102],256],7585:[[607],256],7586:[[609],256],7587:[[613],256],7588:[[616],256],7589:[[617],256],7590:[[618],256],7591:[[7547],256],7592:[[669],256],7593:[[621],256],7594:[[7557],256],7595:[[671],256],7596:[[625],256],7597:[[624],256],7598:[[626],256],7599:[[627],256],7600:[[628],256],7601:[[629],256],7602:[[632],256],7603:[[642],256],7604:[[643],256],7605:[[427],256],7606:[[649],256],7607:[[650],256],7608:[[7452],256],7609:[[651],256],7610:[[652],256],7611:[[122],256],7612:[[656],256],7613:[[657],256],7614:[[658],256],7615:[[952],256],7616:[,230],7617:[,230],7618:[,220],7619:[,230],7620:[,230],7621:[,230],7622:[,230],7623:[,230],7624:[,230],7625:[,230],7626:[,220],7627:[,230],7628:[,230],7629:[,234],7630:[,214],7631:[,220],7632:[,202],7633:[,230],7634:[,230],7635:[,230],7636:[,230],7637:[,230],7638:[,230],7639:[,230],7640:[,230],7641:[,230],7642:[,230],7643:[,230],7644:[,230],7645:[,230],7646:[,230],7647:[,230],7648:[,230],7649:[,230],7650:[,230],7651:[,230],7652:[,230],7653:[,230],7654:[,230],7655:[,230],7656:[,230],7657:[,230],7658:[,230],7659:[,230],7660:[,230],7661:[,230],7662:[,230],7663:[,230],7664:[,230],7665:[,230],7666:[,230],7667:[,230],7668:[,230],7669:[,230],7676:[,233],7677:[,220],7678:[,230],7679:[,220]},7680:{7680:[[65,805]],7681:[[97,805]],7682:[[66,775]],7683:[[98,775]],7684:[[66,803]],7685:[[98,803]],7686:[[66,817]],7687:[[98,817]],7688:[[199,769]],7689:[[231,769]],7690:[[68,775]],7691:[[100,775]],7692:[[68,803]],7693:[[100,803]],7694:[[68,817]],7695:[[100,817]],7696:[[68,807]],7697:[[100,807]],7698:[[68,813]],7699:[[100,813]],7700:[[274,768]],7701:[[275,768]],7702:[[274,769]],7703:[[275,769]],7704:[[69,813]],7705:[[101,813]],7706:[[69,816]],7707:[[101,816]],7708:[[552,774]],7709:[[553,774]],7710:[[70,775]],7711:[[102,775]],7712:[[71,772]],7713:[[103,772]],7714:[[72,775]],7715:[[104,775]],7716:[[72,803]],7717:[[104,803]],7718:[[72,776]],7719:[[104,776]],7720:[[72,807]],7721:[[104,807]],7722:[[72,814]],7723:[[104,814]],7724:[[73,816]],7725:[[105,816]],7726:[[207,769]],7727:[[239,769]],7728:[[75,769]],7729:[[107,769]],7730:[[75,803]],7731:[[107,803]],7732:[[75,817]],7733:[[107,817]],7734:[[76,803],,{772:7736}],7735:[[108,803],,{772:7737}],7736:[[7734,772]],7737:[[7735,772]],7738:[[76,817]],7739:[[108,817]],7740:[[76,813]],7741:[[108,813]],7742:[[77,769]],7743:[[109,769]],7744:[[77,775]],7745:[[109,775]],7746:[[77,803]],7747:[[109,803]],7748:[[78,775]],7749:[[110,775]],7750:[[78,803]],7751:[[110,803]],7752:[[78,817]],7753:[[110,817]],7754:[[78,813]],7755:[[110,813]],7756:[[213,769]],7757:[[245,769]],7758:[[213,776]],7759:[[245,776]],7760:[[332,768]],7761:[[333,768]],7762:[[332,769]],7763:[[333,769]],7764:[[80,769]],7765:[[112,769]],7766:[[80,775]],7767:[[112,775]],7768:[[82,775]],7769:[[114,775]],7770:[[82,803],,{772:7772}],7771:[[114,803],,{772:7773}],7772:[[7770,772]],7773:[[7771,772]],7774:[[82,817]],7775:[[114,817]],7776:[[83,775]],7777:[[115,775]],7778:[[83,803],,{775:7784}],7779:[[115,803],,{775:7785}],7780:[[346,775]],7781:[[347,775]],7782:[[352,775]],7783:[[353,775]],7784:[[7778,775]],7785:[[7779,775]],7786:[[84,775]],7787:[[116,775]],7788:[[84,803]],7789:[[116,803]],7790:[[84,817]],7791:[[116,817]],7792:[[84,813]],7793:[[116,813]],7794:[[85,804]],7795:[[117,804]],7796:[[85,816]],7797:[[117,816]],7798:[[85,813]],7799:[[117,813]],7800:[[360,769]],7801:[[361,769]],7802:[[362,776]],7803:[[363,776]],7804:[[86,771]],7805:[[118,771]],7806:[[86,803]],7807:[[118,803]],7808:[[87,768]],7809:[[119,768]],7810:[[87,769]],7811:[[119,769]],7812:[[87,776]],7813:[[119,776]],7814:[[87,775]],7815:[[119,775]],7816:[[87,803]],7817:[[119,803]],7818:[[88,775]],7819:[[120,775]],7820:[[88,776]],7821:[[120,776]],7822:[[89,775]],7823:[[121,775]],7824:[[90,770]],7825:[[122,770]],7826:[[90,803]],7827:[[122,803]],7828:[[90,817]],7829:[[122,817]],7830:[[104,817]],7831:[[116,776]],7832:[[119,778]],7833:[[121,778]],7834:[[97,702],256],7835:[[383,775]],7840:[[65,803],,{770:7852,774:7862}],7841:[[97,803],,{770:7853,774:7863}],7842:[[65,777]],7843:[[97,777]],7844:[[194,769]],7845:[[226,769]],7846:[[194,768]],7847:[[226,768]],7848:[[194,777]],7849:[[226,777]],7850:[[194,771]],7851:[[226,771]],7852:[[7840,770]],7853:[[7841,770]],7854:[[258,769]],7855:[[259,769]],7856:[[258,768]],7857:[[259,768]],7858:[[258,777]],7859:[[259,777]],7860:[[258,771]],7861:[[259,771]],7862:[[7840,774]],7863:[[7841,774]],7864:[[69,803],,{770:7878}],7865:[[101,803],,{770:7879}],7866:[[69,777]],7867:[[101,777]],7868:[[69,771]],7869:[[101,771]],7870:[[202,769]],7871:[[234,769]],7872:[[202,768]],7873:[[234,768]],7874:[[202,777]],7875:[[234,777]],7876:[[202,771]],7877:[[234,771]],7878:[[7864,770]],7879:[[7865,770]],7880:[[73,777]],7881:[[105,777]],7882:[[73,803]],7883:[[105,803]],7884:[[79,803],,{770:7896}],7885:[[111,803],,{770:7897}],7886:[[79,777]],7887:[[111,777]],7888:[[212,769]],7889:[[244,769]],7890:[[212,768]],7891:[[244,768]],7892:[[212,777]],7893:[[244,777]],7894:[[212,771]],7895:[[244,771]],7896:[[7884,770]],7897:[[7885,770]],7898:[[416,769]],7899:[[417,769]],7900:[[416,768]],7901:[[417,768]],7902:[[416,777]],7903:[[417,777]],7904:[[416,771]],7905:[[417,771]],7906:[[416,803]],7907:[[417,803]],7908:[[85,803]],7909:[[117,803]],7910:[[85,777]],7911:[[117,777]],7912:[[431,769]],7913:[[432,769]],7914:[[431,768]],7915:[[432,768]],7916:[[431,777]],7917:[[432,777]],7918:[[431,771]],7919:[[432,771]],7920:[[431,803]],7921:[[432,803]],7922:[[89,768]],7923:[[121,768]],7924:[[89,803]],7925:[[121,803]],7926:[[89,777]],7927:[[121,777]],7928:[[89,771]],7929:[[121,771]]},7936:{7936:[[945,787],,{768:7938,769:7940,834:7942,837:8064}],7937:[[945,788],,{768:7939,769:7941,834:7943,837:8065}],7938:[[7936,768],,{837:8066}],7939:[[7937,768],,{837:8067}],7940:[[7936,769],,{837:8068}],7941:[[7937,769],,{837:8069}],7942:[[7936,834],,{837:8070}],7943:[[7937,834],,{837:8071}],7944:[[913,787],,{768:7946,769:7948,834:7950,837:8072}],7945:[[913,788],,{768:7947,769:7949,834:7951,837:8073}],7946:[[7944,768],,{837:8074}],7947:[[7945,768],,{837:8075}],7948:[[7944,769],,{837:8076}],7949:[[7945,769],,{837:8077}],7950:[[7944,834],,{837:8078}],7951:[[7945,834],,{837:8079}],7952:[[949,787],,{768:7954,769:7956}],7953:[[949,788],,{768:7955,769:7957}],7954:[[7952,768]],7955:[[7953,768]],7956:[[7952,769]],7957:[[7953,769]],7960:[[917,787],,{768:7962,769:7964}],7961:[[917,788],,{768:7963,769:7965}],7962:[[7960,768]],7963:[[7961,768]],7964:[[7960,769]],7965:[[7961,769]],7968:[[951,787],,{768:7970,769:7972,834:7974,837:8080}],7969:[[951,788],,{768:7971,769:7973,834:7975,837:8081}],7970:[[7968,768],,{837:8082}],7971:[[7969,768],,{837:8083}],7972:[[7968,769],,{837:8084}],7973:[[7969,769],,{837:8085}],7974:[[7968,834],,{837:8086}],7975:[[7969,834],,{837:8087}],7976:[[919,787],,{768:7978,769:7980,834:7982,837:8088}],7977:[[919,788],,{768:7979,769:7981,834:7983,837:8089}],7978:[[7976,768],,{837:8090}],7979:[[7977,768],,{837:8091}],7980:[[7976,769],,{837:8092}],7981:[[7977,769],,{837:8093}],7982:[[7976,834],,{837:8094}],7983:[[7977,834],,{837:8095}],7984:[[953,787],,{768:7986,769:7988,834:7990}],7985:[[953,788],,{768:7987,769:7989,834:7991}],7986:[[7984,768]],7987:[[7985,768]],7988:[[7984,769]],7989:[[7985,769]],7990:[[7984,834]],7991:[[7985,834]],7992:[[921,787],,{768:7994,769:7996,834:7998}],7993:[[921,788],,{768:7995,769:7997,834:7999}],7994:[[7992,768]],7995:[[7993,768]],7996:[[7992,769]],7997:[[7993,769]],7998:[[7992,834]],7999:[[7993,834]],8e3:[[959,787],,{768:8002,769:8004}],8001:[[959,788],,{768:8003,769:8005}],8002:[[8e3,768]],8003:[[8001,768]],8004:[[8e3,769]],8005:[[8001,769]],8008:[[927,787],,{768:8010,769:8012}],8009:[[927,788],,{768:8011,769:8013}],8010:[[8008,768]],8011:[[8009,768]],8012:[[8008,769]],8013:[[8009,769]],8016:[[965,787],,{768:8018,769:8020,834:8022}],8017:[[965,788],,{768:8019,769:8021,834:8023}],8018:[[8016,768]],8019:[[8017,768]],8020:[[8016,769]],8021:[[8017,769]],8022:[[8016,834]],8023:[[8017,834]],8025:[[933,788],,{768:8027,769:8029,834:8031}],8027:[[8025,768]],8029:[[8025,769]],8031:[[8025,834]],8032:[[969,787],,{768:8034,769:8036,834:8038,837:8096}],8033:[[969,788],,{768:8035,769:8037,834:8039,837:8097}],8034:[[8032,768],,{837:8098}],8035:[[8033,768],,{837:8099}],8036:[[8032,769],,{837:8100}],8037:[[8033,769],,{837:8101}],8038:[[8032,834],,{837:8102}],8039:[[8033,834],,{837:8103}],8040:[[937,787],,{768:8042,769:8044,834:8046,837:8104}],8041:[[937,788],,{768:8043,769:8045,834:8047,837:8105}],8042:[[8040,768],,{837:8106}],8043:[[8041,768],,{837:8107}],8044:[[8040,769],,{837:8108}],8045:[[8041,769],,{837:8109}],8046:[[8040,834],,{837:8110}],8047:[[8041,834],,{837:8111}],8048:[[945,768],,{837:8114}],8049:[[940]],8050:[[949,768]],8051:[[941]],8052:[[951,768],,{837:8130}],8053:[[942]],8054:[[953,768]],8055:[[943]],8056:[[959,768]],8057:[[972]],8058:[[965,768]],8059:[[973]],8060:[[969,768],,{837:8178}],8061:[[974]],8064:[[7936,837]],8065:[[7937,837]],8066:[[7938,837]],8067:[[7939,837]],8068:[[7940,837]],8069:[[7941,837]],8070:[[7942,837]],8071:[[7943,837]],8072:[[7944,837]],8073:[[7945,837]],8074:[[7946,837]],8075:[[7947,837]],8076:[[7948,837]],8077:[[7949,837]],8078:[[7950,837]],8079:[[7951,837]],8080:[[7968,837]],8081:[[7969,837]],8082:[[7970,837]],8083:[[7971,837]],8084:[[7972,837]],8085:[[7973,837]],8086:[[7974,837]],8087:[[7975,837]],8088:[[7976,837]],8089:[[7977,837]],8090:[[7978,837]],8091:[[7979,837]],8092:[[7980,837]],8093:[[7981,837]],8094:[[7982,837]],8095:[[7983,837]],8096:[[8032,837]],8097:[[8033,837]],8098:[[8034,837]],8099:[[8035,837]],8100:[[8036,837]],8101:[[8037,837]],8102:[[8038,837]],8103:[[8039,837]],8104:[[8040,837]],8105:[[8041,837]],8106:[[8042,837]],8107:[[8043,837]],8108:[[8044,837]],8109:[[8045,837]],8110:[[8046,837]],8111:[[8047,837]],8112:[[945,774]],8113:[[945,772]],8114:[[8048,837]],8115:[[945,837]],8116:[[940,837]],8118:[[945,834],,{837:8119}],8119:[[8118,837]],8120:[[913,774]],8121:[[913,772]],8122:[[913,768]],8123:[[902]],8124:[[913,837]],8125:[[32,787],256],8126:[[953]],8127:[[32,787],256,{768:8141,769:8142,834:8143}],8128:[[32,834],256],8129:[[168,834]],8130:[[8052,837]],8131:[[951,837]],8132:[[942,837]],8134:[[951,834],,{837:8135}],8135:[[8134,837]],8136:[[917,768]],8137:[[904]],8138:[[919,768]],8139:[[905]],8140:[[919,837]],8141:[[8127,768]],8142:[[8127,769]],8143:[[8127,834]],8144:[[953,774]],8145:[[953,772]],8146:[[970,768]],8147:[[912]],8150:[[953,834]],8151:[[970,834]],8152:[[921,774]],8153:[[921,772]],8154:[[921,768]],8155:[[906]],8157:[[8190,768]],8158:[[8190,769]],8159:[[8190,834]],8160:[[965,774]],8161:[[965,772]],8162:[[971,768]],8163:[[944]],8164:[[961,787]],8165:[[961,788]],8166:[[965,834]],8167:[[971,834]],8168:[[933,774]],8169:[[933,772]],8170:[[933,768]],8171:[[910]],8172:[[929,788]],8173:[[168,768]],8174:[[901]],8175:[[96]],8178:[[8060,837]],8179:[[969,837]],8180:[[974,837]],8182:[[969,834],,{837:8183}],8183:[[8182,837]],8184:[[927,768]],8185:[[908]],8186:[[937,768]],8187:[[911]],8188:[[937,837]],8189:[[180]],8190:[[32,788],256,{768:8157,769:8158,834:8159}]},8192:{8192:[[8194]],8193:[[8195]],8194:[[32],256],8195:[[32],256],8196:[[32],256],8197:[[32],256],8198:[[32],256],8199:[[32],256],8200:[[32],256],8201:[[32],256],8202:[[32],256],8209:[[8208],256],8215:[[32,819],256],8228:[[46],256],8229:[[46,46],256],8230:[[46,46,46],256],8239:[[32],256],8243:[[8242,8242],256],8244:[[8242,8242,8242],256],8246:[[8245,8245],256],8247:[[8245,8245,8245],256],8252:[[33,33],256],8254:[[32,773],256],8263:[[63,63],256],8264:[[63,33],256],8265:[[33,63],256],8279:[[8242,8242,8242,8242],256],8287:[[32],256],8304:[[48],256],8305:[[105],256],8308:[[52],256],8309:[[53],256],8310:[[54],256],8311:[[55],256],8312:[[56],256],8313:[[57],256],8314:[[43],256],8315:[[8722],256],8316:[[61],256],8317:[[40],256],8318:[[41],256],8319:[[110],256],8320:[[48],256],8321:[[49],256],8322:[[50],256],8323:[[51],256],8324:[[52],256],8325:[[53],256],8326:[[54],256],8327:[[55],256],8328:[[56],256],8329:[[57],256],8330:[[43],256],8331:[[8722],256],8332:[[61],256],8333:[[40],256],8334:[[41],256],8336:[[97],256],8337:[[101],256],8338:[[111],256],8339:[[120],256],8340:[[601],256],8341:[[104],256],8342:[[107],256],8343:[[108],256],8344:[[109],256],8345:[[110],256],8346:[[112],256],8347:[[115],256],8348:[[116],256],8360:[[82,115],256],8400:[,230],8401:[,230],8402:[,1],8403:[,1],8404:[,230],8405:[,230],8406:[,230],8407:[,230],8408:[,1],8409:[,1],8410:[,1],8411:[,230],8412:[,230],8417:[,230],8421:[,1],8422:[,1],8423:[,230],8424:[,220],8425:[,230],8426:[,1],8427:[,1],8428:[,220],8429:[,220],8430:[,220],8431:[,220],8432:[,230]},8448:{8448:[[97,47,99],256],8449:[[97,47,115],256],8450:[[67],256],8451:[[176,67],256],8453:[[99,47,111],256],8454:[[99,47,117],256],8455:[[400],256],8457:[[176,70],256],8458:[[103],256],8459:[[72],256],8460:[[72],256],8461:[[72],256],8462:[[104],256],8463:[[295],256],8464:[[73],256],8465:[[73],256],8466:[[76],256],8467:[[108],256],8469:[[78],256],8470:[[78,111],256],8473:[[80],256],8474:[[81],256],8475:[[82],256],8476:[[82],256],8477:[[82],256],8480:[[83,77],256],8481:[[84,69,76],256],8482:[[84,77],256],8484:[[90],256],8486:[[937]],8488:[[90],256],8490:[[75]],8491:[[197]],8492:[[66],256],8493:[[67],256],8495:[[101],256],8496:[[69],256],8497:[[70],256],8499:[[77],256],8500:[[111],256],8501:[[1488],256],8502:[[1489],256],8503:[[1490],256],8504:[[1491],256],8505:[[105],256],8507:[[70,65,88],256],8508:[[960],256],8509:[[947],256],8510:[[915],256],8511:[[928],256],8512:[[8721],256],8517:[[68],256],8518:[[100],256],8519:[[101],256],8520:[[105],256],8521:[[106],256],8528:[[49,8260,55],256],8529:[[49,8260,57],256],8530:[[49,8260,49,48],256],8531:[[49,8260,51],256],8532:[[50,8260,51],256],8533:[[49,8260,53],256],8534:[[50,8260,53],256],8535:[[51,8260,53],256],8536:[[52,8260,53],256],8537:[[49,8260,54],256],8538:[[53,8260,54],256],8539:[[49,8260,56],256],8540:[[51,8260,56],256],8541:[[53,8260,56],256],8542:[[55,8260,56],256],8543:[[49,8260],256],8544:[[73],256],8545:[[73,73],256],8546:[[73,73,73],256],8547:[[73,86],256],8548:[[86],256],8549:[[86,73],256],8550:[[86,73,73],256],8551:[[86,73,73,73],256],8552:[[73,88],256],8553:[[88],256],8554:[[88,73],256],8555:[[88,73,73],256],8556:[[76],256],8557:[[67],256],8558:[[68],256],8559:[[77],256],8560:[[105],256],8561:[[105,105],256],8562:[[105,105,105],256],8563:[[105,118],256],8564:[[118],256],8565:[[118,105],256],8566:[[118,105,105],256],8567:[[118,105,105,105],256],8568:[[105,120],256],8569:[[120],256],8570:[[120,105],256],8571:[[120,105,105],256],8572:[[108],256],8573:[[99],256],8574:[[100],256],8575:[[109],256],8585:[[48,8260,51],256],8592:[,,{824:8602}],8594:[,,{824:8603}],8596:[,,{824:8622}],8602:[[8592,824]],8603:[[8594,824]],8622:[[8596,824]],8653:[[8656,824]],8654:[[8660,824]],8655:[[8658,824]],8656:[,,{824:8653}],8658:[,,{824:8655}],8660:[,,{824:8654}]},8704:{8707:[,,{824:8708}],8708:[[8707,824]],8712:[,,{824:8713}],8713:[[8712,824]],8715:[,,{824:8716}],8716:[[8715,824]],8739:[,,{824:8740}],8740:[[8739,824]],8741:[,,{824:8742}],8742:[[8741,824]],8748:[[8747,8747],256],8749:[[8747,8747,8747],256],8751:[[8750,8750],256],8752:[[8750,8750,8750],256],8764:[,,{824:8769}],8769:[[8764,824]],8771:[,,{824:8772}],8772:[[8771,824]],8773:[,,{824:8775}],8775:[[8773,824]],8776:[,,{824:8777}],8777:[[8776,824]],8781:[,,{824:8813}],8800:[[61,824]],8801:[,,{824:8802}],8802:[[8801,824]],8804:[,,{824:8816}],8805:[,,{824:8817}],8813:[[8781,824]],8814:[[60,824]],8815:[[62,824]],8816:[[8804,824]],8817:[[8805,824]],8818:[,,{824:8820}],8819:[,,{824:8821}],8820:[[8818,824]],8821:[[8819,824]],8822:[,,{824:8824}],8823:[,,{824:8825}],8824:[[8822,824]],8825:[[8823,824]],8826:[,,{824:8832}],8827:[,,{824:8833}],8828:[,,{824:8928}],8829:[,,{824:8929}],8832:[[8826,824]],8833:[[8827,824]],8834:[,,{824:8836}],8835:[,,{824:8837}],8836:[[8834,824]],8837:[[8835,824]],8838:[,,{824:8840}],8839:[,,{824:8841}],8840:[[8838,824]],8841:[[8839,824]],8849:[,,{824:8930}],8850:[,,{824:8931}],8866:[,,{824:8876}],8872:[,,{824:8877}],8873:[,,{824:8878}],8875:[,,{824:8879}],8876:[[8866,824]],8877:[[8872,824]],8878:[[8873,824]],8879:[[8875,824]],8882:[,,{824:8938}],8883:[,,{824:8939}],8884:[,,{824:8940}],8885:[,,{824:8941}],8928:[[8828,824]],8929:[[8829,824]],8930:[[8849,824]],8931:[[8850,824]],8938:[[8882,824]],8939:[[8883,824]],8940:[[8884,824]],8941:[[8885,824]]},8960:{9001:[[12296]],9002:[[12297]]},9216:{9312:[[49],256],9313:[[50],256],9314:[[51],256],9315:[[52],256],9316:[[53],256],9317:[[54],256],9318:[[55],256],9319:[[56],256],9320:[[57],256],9321:[[49,48],256],9322:[[49,49],256],9323:[[49,50],256],9324:[[49,51],256],9325:[[49,52],256],9326:[[49,53],256],9327:[[49,54],256],9328:[[49,55],256],9329:[[49,56],256],9330:[[49,57],256],9331:[[50,48],256],9332:[[40,49,41],256],9333:[[40,50,41],256],9334:[[40,51,41],256],9335:[[40,52,41],256],9336:[[40,53,41],256],9337:[[40,54,41],256],9338:[[40,55,41],256],9339:[[40,56,41],256],9340:[[40,57,41],256],9341:[[40,49,48,41],256],9342:[[40,49,49,41],256],9343:[[40,49,50,41],256],9344:[[40,49,51,41],256],9345:[[40,49,52,41],256],9346:[[40,49,53,41],256],9347:[[40,49,54,41],256],9348:[[40,49,55,41],256],9349:[[40,49,56,41],256],9350:[[40,49,57,41],256],9351:[[40,50,48,41],256],9352:[[49,46],256],9353:[[50,46],256],9354:[[51,46],256],9355:[[52,46],256],9356:[[53,46],256],9357:[[54,46],256],9358:[[55,46],256],9359:[[56,46],256],9360:[[57,46],256],9361:[[49,48,46],256],9362:[[49,49,46],256],9363:[[49,50,46],256],9364:[[49,51,46],256],9365:[[49,52,46],256],9366:[[49,53,46],256],9367:[[49,54,46],256],9368:[[49,55,46],256],9369:[[49,56,46],256],9370:[[49,57,46],256],9371:[[50,48,46],256],9372:[[40,97,41],256],9373:[[40,98,41],256],9374:[[40,99,41],256],9375:[[40,100,41],256],9376:[[40,101,41],256],9377:[[40,102,41],256],9378:[[40,103,41],256],9379:[[40,104,41],256],9380:[[40,105,41],256],9381:[[40,106,41],256],9382:[[40,107,41],256],9383:[[40,108,41],256],9384:[[40,109,41],256],9385:[[40,110,41],256],9386:[[40,111,41],256],9387:[[40,112,41],256],9388:[[40,113,41],256],9389:[[40,114,41],256],9390:[[40,115,41],256],9391:[[40,116,41],256],9392:[[40,117,41],256],9393:[[40,118,41],256],9394:[[40,119,41],256],9395:[[40,120,41],256],9396:[[40,121,41],256],9397:[[40,122,41],256],9398:[[65],256],9399:[[66],256],9400:[[67],256],9401:[[68],256],9402:[[69],256],9403:[[70],256],9404:[[71],256],9405:[[72],256],9406:[[73],256],9407:[[74],256],9408:[[75],256],9409:[[76],256],9410:[[77],256],9411:[[78],256],9412:[[79],256],9413:[[80],256],9414:[[81],256],9415:[[82],256],9416:[[83],256],9417:[[84],256],9418:[[85],256],9419:[[86],256],9420:[[87],256],9421:[[88],256],9422:[[89],256],9423:[[90],256],9424:[[97],256],9425:[[98],256],9426:[[99],256],9427:[[100],256],9428:[[101],256],9429:[[102],256],9430:[[103],256],9431:[[104],256],9432:[[105],256],9433:[[106],256],9434:[[107],256],9435:[[108],256],9436:[[109],256],9437:[[110],256],9438:[[111],256],9439:[[112],256],9440:[[113],256],9441:[[114],256],9442:[[115],256],9443:[[116],256],9444:[[117],256],9445:[[118],256],9446:[[119],256],9447:[[120],256],9448:[[121],256],9449:[[122],256],9450:[[48],256]},10752:{10764:[[8747,8747,8747,8747],256],10868:[[58,58,61],256],10869:[[61,61],256],10870:[[61,61,61],256],10972:[[10973,824],512]},11264:{11388:[[106],256],11389:[[86],256],11503:[,230],11504:[,230],11505:[,230]},11520:{11631:[[11617],256],11647:[,9],11744:[,230],11745:[,230],11746:[,230],11747:[,230],11748:[,230],11749:[,230],11750:[,230],11751:[,230],11752:[,230],11753:[,230],11754:[,230],11755:[,230],11756:[,230],11757:[,230],11758:[,230],11759:[,230],11760:[,230],11761:[,230],11762:[,230],11763:[,230],11764:[,230],11765:[,230],11766:[,230],11767:[,230],11768:[,230],11769:[,230],11770:[,230],11771:[,230],11772:[,230],11773:[,230],11774:[,230],11775:[,230]},11776:{11935:[[27597],256],12019:[[40863],256]},12032:{12032:[[19968],256],12033:[[20008],256],12034:[[20022],256],12035:[[20031],256],12036:[[20057],256],12037:[[20101],256],12038:[[20108],256],12039:[[20128],256],12040:[[20154],256],12041:[[20799],256],12042:[[20837],256],12043:[[20843],256],12044:[[20866],256],12045:[[20886],256],12046:[[20907],256],12047:[[20960],256],12048:[[20981],256],12049:[[20992],256],12050:[[21147],256],12051:[[21241],256],12052:[[21269],256],12053:[[21274],256],12054:[[21304],256],12055:[[21313],256],12056:[[21340],256],12057:[[21353],256],12058:[[21378],256],12059:[[21430],256],12060:[[21448],256],12061:[[21475],256],12062:[[22231],256],12063:[[22303],256],12064:[[22763],256],12065:[[22786],256],12066:[[22794],256],12067:[[22805],256],12068:[[22823],256],12069:[[22899],256],12070:[[23376],256],12071:[[23424],256],12072:[[23544],256],12073:[[23567],256],12074:[[23586],256],12075:[[23608],256],12076:[[23662],256],12077:[[23665],256],12078:[[24027],256],12079:[[24037],256],12080:[[24049],256],12081:[[24062],256],12082:[[24178],256],12083:[[24186],256],12084:[[24191],256],12085:[[24308],256],12086:[[24318],256],12087:[[24331],256],12088:[[24339],256],12089:[[24400],256],12090:[[24417],256],12091:[[24435],256],12092:[[24515],256],12093:[[25096],256],12094:[[25142],256],12095:[[25163],256],12096:[[25903],256],12097:[[25908],256],12098:[[25991],256],12099:[[26007],256],12100:[[26020],256],12101:[[26041],256],12102:[[26080],256],12103:[[26085],256],12104:[[26352],256],12105:[[26376],256],12106:[[26408],256],12107:[[27424],256],12108:[[27490],256],12109:[[27513],256],12110:[[27571],256],12111:[[27595],256],12112:[[27604],256],12113:[[27611],256],12114:[[27663],256],12115:[[27668],256],12116:[[27700],256],12117:[[28779],256],12118:[[29226],256],12119:[[29238],256],12120:[[29243],256],12121:[[29247],256],12122:[[29255],256],12123:[[29273],256],12124:[[29275],256],12125:[[29356],256],12126:[[29572],256],12127:[[29577],256],12128:[[29916],256],12129:[[29926],256],12130:[[29976],256],12131:[[29983],256],12132:[[29992],256],12133:[[3e4],256],12134:[[30091],256],12135:[[30098],256],12136:[[30326],256],12137:[[30333],256],12138:[[30382],256],12139:[[30399],256],12140:[[30446],256],12141:[[30683],256],12142:[[30690],256],12143:[[30707],256],12144:[[31034],256],12145:[[31160],256],12146:[[31166],256],12147:[[31348],256],12148:[[31435],256],12149:[[31481],256],12150:[[31859],256],12151:[[31992],256],12152:[[32566],256],12153:[[32593],256],12154:[[32650],256],12155:[[32701],256],12156:[[32769],256],12157:[[32780],256],12158:[[32786],256],12159:[[32819],256],12160:[[32895],256],12161:[[32905],256],12162:[[33251],256],12163:[[33258],256],12164:[[33267],256],12165:[[33276],256],12166:[[33292],256],12167:[[33307],256],12168:[[33311],256],12169:[[33390],256],12170:[[33394],256],12171:[[33400],256],12172:[[34381],256],12173:[[34411],256],12174:[[34880],256],12175:[[34892],256],12176:[[34915],256],12177:[[35198],256],12178:[[35211],256],12179:[[35282],256],12180:[[35328],256],12181:[[35895],256],12182:[[35910],256],12183:[[35925],256],12184:[[35960],256],12185:[[35997],256],12186:[[36196],256],12187:[[36208],256],12188:[[36275],256],12189:[[36523],256],12190:[[36554],256],12191:[[36763],256],12192:[[36784],256],12193:[[36789],256],12194:[[37009],256],12195:[[37193],256],12196:[[37318],256],12197:[[37324],256],12198:[[37329],256],12199:[[38263],256],12200:[[38272],256],12201:[[38428],256],12202:[[38582],256],12203:[[38585],256],12204:[[38632],256],12205:[[38737],256],12206:[[38750],256],12207:[[38754],256],12208:[[38761],256],12209:[[38859],256],12210:[[38893],256],12211:[[38899],256],12212:[[38913],256],12213:[[39080],256],12214:[[39131],256],12215:[[39135],256],12216:[[39318],256],12217:[[39321],256],12218:[[39340],256],12219:[[39592],256],12220:[[39640],256],12221:[[39647],256],12222:[[39717],256],12223:[[39727],256],12224:[[39730],256],12225:[[39740],256],12226:[[39770],256],12227:[[40165],256],12228:[[40565],256],12229:[[40575],256],12230:[[40613],256],12231:[[40635],256],12232:[[40643],256],12233:[[40653],256],12234:[[40657],256],12235:[[40697],256],12236:[[40701],256],12237:[[40718],256],12238:[[40723],256],12239:[[40736],256],12240:[[40763],256],12241:[[40778],256],12242:[[40786],256],12243:[[40845],256],12244:[[40860],256],12245:[[40864],256]},12288:{12288:[[32],256],12330:[,218],12331:[,228],12332:[,232],12333:[,222],12334:[,224],12335:[,224],12342:[[12306],256],12344:[[21313],256],12345:[[21316],256],12346:[[21317],256],12358:[,,{12441:12436}],12363:[,,{12441:12364}],12364:[[12363,12441]],12365:[,,{12441:12366}],12366:[[12365,12441]],12367:[,,{12441:12368}],12368:[[12367,12441]],12369:[,,{12441:12370}],12370:[[12369,12441]],12371:[,,{12441:12372}],12372:[[12371,12441]],12373:[,,{12441:12374}],12374:[[12373,12441]],12375:[,,{12441:12376}],12376:[[12375,12441]],12377:[,,{12441:12378}],12378:[[12377,12441]],12379:[,,{12441:12380}],12380:[[12379,12441]],12381:[,,{12441:12382}],12382:[[12381,12441]],12383:[,,{12441:12384}],12384:[[12383,12441]],12385:[,,{12441:12386}],12386:[[12385,12441]],12388:[,,{12441:12389}],12389:[[12388,12441]],12390:[,,{12441:12391}],12391:[[12390,12441]],12392:[,,{12441:12393}],12393:[[12392,12441]],12399:[,,{12441:12400,12442:12401}],12400:[[12399,12441]],12401:[[12399,12442]],12402:[,,{12441:12403,12442:12404}],12403:[[12402,12441]],12404:[[12402,12442]],12405:[,,{12441:12406,12442:12407}],12406:[[12405,12441]],12407:[[12405,12442]],12408:[,,{12441:12409,12442:12410}],12409:[[12408,12441]],12410:[[12408,12442]],12411:[,,{12441:12412,12442:12413}],12412:[[12411,12441]],12413:[[12411,12442]],12436:[[12358,12441]],12441:[,8],12442:[,8],12443:[[32,12441],256],12444:[[32,12442],256],12445:[,,{12441:12446}],12446:[[12445,12441]],12447:[[12424,12426],256],12454:[,,{12441:12532}],12459:[,,{12441:12460}],12460:[[12459,12441]],12461:[,,{12441:12462}],12462:[[12461,12441]],12463:[,,{12441:12464}],12464:[[12463,12441]],12465:[,,{12441:12466}],12466:[[12465,12441]],12467:[,,{12441:12468}],12468:[[12467,12441]],12469:[,,{12441:12470}],12470:[[12469,12441]],12471:[,,{12441:12472}],12472:[[12471,12441]],12473:[,,{12441:12474}],12474:[[12473,12441]],12475:[,,{12441:12476}],12476:[[12475,12441]],12477:[,,{12441:12478}],12478:[[12477,12441]],12479:[,,{12441:12480}],12480:[[12479,12441]],12481:[,,{12441:12482}],12482:[[12481,12441]],12484:[,,{12441:12485}],12485:[[12484,12441]],12486:[,,{12441:12487}],12487:[[12486,12441]],12488:[,,{12441:12489}],12489:[[12488,12441]],12495:[,,{12441:12496,12442:12497}],12496:[[12495,12441]],12497:[[12495,12442]],12498:[,,{12441:12499,12442:12500}],12499:[[12498,12441]],12500:[[12498,12442]],12501:[,,{12441:12502,12442:12503}],12502:[[12501,12441]],12503:[[12501,12442]],12504:[,,{12441:12505,12442:12506}],12505:[[12504,12441]],12506:[[12504,12442]],12507:[,,{12441:12508,12442:12509}],12508:[[12507,12441]],12509:[[12507,12442]],12527:[,,{12441:12535}],12528:[,,{12441:12536}],12529:[,,{12441:12537}],12530:[,,{12441:12538}],12532:[[12454,12441]],12535:[[12527,12441]],12536:[[12528,12441]],12537:[[12529,12441]],12538:[[12530,12441]],12541:[,,{12441:12542}],12542:[[12541,12441]],12543:[[12467,12488],256]},12544:{12593:[[4352],256],12594:[[4353],256],12595:[[4522],256],12596:[[4354],256],12597:[[4524],256],12598:[[4525],256],12599:[[4355],256],12600:[[4356],256],12601:[[4357],256],12602:[[4528],256],12603:[[4529],256],12604:[[4530],256],12605:[[4531],256],12606:[[4532],256],12607:[[4533],256],12608:[[4378],256],12609:[[4358],256],12610:[[4359],256],12611:[[4360],256],12612:[[4385],256],12613:[[4361],256],12614:[[4362],256],12615:[[4363],256],12616:[[4364],256],12617:[[4365],256],12618:[[4366],256],12619:[[4367],256],12620:[[4368],256],12621:[[4369],256],12622:[[4370],256],12623:[[4449],256],12624:[[4450],256],12625:[[4451],256],12626:[[4452],256],12627:[[4453],256],12628:[[4454],256],12629:[[4455],256],12630:[[4456],256],12631:[[4457],256],12632:[[4458],256],12633:[[4459],256],12634:[[4460],256],12635:[[4461],256],12636:[[4462],256],12637:[[4463],256],12638:[[4464],256],12639:[[4465],256],12640:[[4466],256],12641:[[4467],256],12642:[[4468],256],12643:[[4469],256],12644:[[4448],256],12645:[[4372],256],12646:[[4373],256],12647:[[4551],256],12648:[[4552],256],12649:[[4556],256],12650:[[4558],256],12651:[[4563],256],12652:[[4567],256],12653:[[4569],256],12654:[[4380],256],12655:[[4573],256],12656:[[4575],256],12657:[[4381],256],12658:[[4382],256],12659:[[4384],256],12660:[[4386],256],12661:[[4387],256],12662:[[4391],256],12663:[[4393],256],12664:[[4395],256],12665:[[4396],256],12666:[[4397],256],12667:[[4398],256],12668:[[4399],256],12669:[[4402],256],12670:[[4406],256],12671:[[4416],256],12672:[[4423],256],12673:[[4428],256],12674:[[4593],256],12675:[[4594],256],12676:[[4439],256],12677:[[4440],256],12678:[[4441],256],12679:[[4484],256],12680:[[4485],256],12681:[[4488],256],12682:[[4497],256],12683:[[4498],256],
12684:[[4500],256],12685:[[4510],256],12686:[[4513],256],12690:[[19968],256],12691:[[20108],256],12692:[[19977],256],12693:[[22235],256],12694:[[19978],256],12695:[[20013],256],12696:[[19979],256],12697:[[30002],256],12698:[[20057],256],12699:[[19993],256],12700:[[19969],256],12701:[[22825],256],12702:[[22320],256],12703:[[20154],256]},12800:{12800:[[40,4352,41],256],12801:[[40,4354,41],256],12802:[[40,4355,41],256],12803:[[40,4357,41],256],12804:[[40,4358,41],256],12805:[[40,4359,41],256],12806:[[40,4361,41],256],12807:[[40,4363,41],256],12808:[[40,4364,41],256],12809:[[40,4366,41],256],12810:[[40,4367,41],256],12811:[[40,4368,41],256],12812:[[40,4369,41],256],12813:[[40,4370,41],256],12814:[[40,4352,4449,41],256],12815:[[40,4354,4449,41],256],12816:[[40,4355,4449,41],256],12817:[[40,4357,4449,41],256],12818:[[40,4358,4449,41],256],12819:[[40,4359,4449,41],256],12820:[[40,4361,4449,41],256],12821:[[40,4363,4449,41],256],12822:[[40,4364,4449,41],256],12823:[[40,4366,4449,41],256],12824:[[40,4367,4449,41],256],12825:[[40,4368,4449,41],256],12826:[[40,4369,4449,41],256],12827:[[40,4370,4449,41],256],12828:[[40,4364,4462,41],256],12829:[[40,4363,4457,4364,4453,4523,41],256],12830:[[40,4363,4457,4370,4462,41],256],12832:[[40,19968,41],256],12833:[[40,20108,41],256],12834:[[40,19977,41],256],12835:[[40,22235,41],256],12836:[[40,20116,41],256],12837:[[40,20845,41],256],12838:[[40,19971,41],256],12839:[[40,20843,41],256],12840:[[40,20061,41],256],12841:[[40,21313,41],256],12842:[[40,26376,41],256],12843:[[40,28779,41],256],12844:[[40,27700,41],256],12845:[[40,26408,41],256],12846:[[40,37329,41],256],12847:[[40,22303,41],256],12848:[[40,26085,41],256],12849:[[40,26666,41],256],12850:[[40,26377,41],256],12851:[[40,31038,41],256],12852:[[40,21517,41],256],12853:[[40,29305,41],256],12854:[[40,36001,41],256],12855:[[40,31069,41],256],12856:[[40,21172,41],256],12857:[[40,20195,41],256],12858:[[40,21628,41],256],12859:[[40,23398,41],256],12860:[[40,30435,41],256],12861:[[40,20225,41],256],12862:[[40,36039,41],256],12863:[[40,21332,41],256],12864:[[40,31085,41],256],12865:[[40,20241,41],256],12866:[[40,33258,41],256],12867:[[40,33267,41],256],12868:[[21839],256],12869:[[24188],256],12870:[[25991],256],12871:[[31631],256],12880:[[80,84,69],256],12881:[[50,49],256],12882:[[50,50],256],12883:[[50,51],256],12884:[[50,52],256],12885:[[50,53],256],12886:[[50,54],256],12887:[[50,55],256],12888:[[50,56],256],12889:[[50,57],256],12890:[[51,48],256],12891:[[51,49],256],12892:[[51,50],256],12893:[[51,51],256],12894:[[51,52],256],12895:[[51,53],256],12896:[[4352],256],12897:[[4354],256],12898:[[4355],256],12899:[[4357],256],12900:[[4358],256],12901:[[4359],256],12902:[[4361],256],12903:[[4363],256],12904:[[4364],256],12905:[[4366],256],12906:[[4367],256],12907:[[4368],256],12908:[[4369],256],12909:[[4370],256],12910:[[4352,4449],256],12911:[[4354,4449],256],12912:[[4355,4449],256],12913:[[4357,4449],256],12914:[[4358,4449],256],12915:[[4359,4449],256],12916:[[4361,4449],256],12917:[[4363,4449],256],12918:[[4364,4449],256],12919:[[4366,4449],256],12920:[[4367,4449],256],12921:[[4368,4449],256],12922:[[4369,4449],256],12923:[[4370,4449],256],12924:[[4366,4449,4535,4352,4457],256],12925:[[4364,4462,4363,4468],256],12926:[[4363,4462],256],12928:[[19968],256],12929:[[20108],256],12930:[[19977],256],12931:[[22235],256],12932:[[20116],256],12933:[[20845],256],12934:[[19971],256],12935:[[20843],256],12936:[[20061],256],12937:[[21313],256],12938:[[26376],256],12939:[[28779],256],12940:[[27700],256],12941:[[26408],256],12942:[[37329],256],12943:[[22303],256],12944:[[26085],256],12945:[[26666],256],12946:[[26377],256],12947:[[31038],256],12948:[[21517],256],12949:[[29305],256],12950:[[36001],256],12951:[[31069],256],12952:[[21172],256],12953:[[31192],256],12954:[[30007],256],12955:[[22899],256],12956:[[36969],256],12957:[[20778],256],12958:[[21360],256],12959:[[27880],256],12960:[[38917],256],12961:[[20241],256],12962:[[20889],256],12963:[[27491],256],12964:[[19978],256],12965:[[20013],256],12966:[[19979],256],12967:[[24038],256],12968:[[21491],256],12969:[[21307],256],12970:[[23447],256],12971:[[23398],256],12972:[[30435],256],12973:[[20225],256],12974:[[36039],256],12975:[[21332],256],12976:[[22812],256],12977:[[51,54],256],12978:[[51,55],256],12979:[[51,56],256],12980:[[51,57],256],12981:[[52,48],256],12982:[[52,49],256],12983:[[52,50],256],12984:[[52,51],256],12985:[[52,52],256],12986:[[52,53],256],12987:[[52,54],256],12988:[[52,55],256],12989:[[52,56],256],12990:[[52,57],256],12991:[[53,48],256],12992:[[49,26376],256],12993:[[50,26376],256],12994:[[51,26376],256],12995:[[52,26376],256],12996:[[53,26376],256],12997:[[54,26376],256],12998:[[55,26376],256],12999:[[56,26376],256],13e3:[[57,26376],256],13001:[[49,48,26376],256],13002:[[49,49,26376],256],13003:[[49,50,26376],256],13004:[[72,103],256],13005:[[101,114,103],256],13006:[[101,86],256],13007:[[76,84,68],256],13008:[[12450],256],13009:[[12452],256],13010:[[12454],256],13011:[[12456],256],13012:[[12458],256],13013:[[12459],256],13014:[[12461],256],13015:[[12463],256],13016:[[12465],256],13017:[[12467],256],13018:[[12469],256],13019:[[12471],256],13020:[[12473],256],13021:[[12475],256],13022:[[12477],256],13023:[[12479],256],13024:[[12481],256],13025:[[12484],256],13026:[[12486],256],13027:[[12488],256],13028:[[12490],256],13029:[[12491],256],13030:[[12492],256],13031:[[12493],256],13032:[[12494],256],13033:[[12495],256],13034:[[12498],256],13035:[[12501],256],13036:[[12504],256],13037:[[12507],256],13038:[[12510],256],13039:[[12511],256],13040:[[12512],256],13041:[[12513],256],13042:[[12514],256],13043:[[12516],256],13044:[[12518],256],13045:[[12520],256],13046:[[12521],256],13047:[[12522],256],13048:[[12523],256],13049:[[12524],256],13050:[[12525],256],13051:[[12527],256],13052:[[12528],256],13053:[[12529],256],13054:[[12530],256]},13056:{13056:[[12450,12497,12540,12488],256],13057:[[12450,12523,12501,12449],256],13058:[[12450,12531,12506,12450],256],13059:[[12450,12540,12523],256],13060:[[12452,12491,12531,12464],256],13061:[[12452,12531,12481],256],13062:[[12454,12457,12531],256],13063:[[12456,12473,12463,12540,12489],256],13064:[[12456,12540,12459,12540],256],13065:[[12458,12531,12473],256],13066:[[12458,12540,12512],256],13067:[[12459,12452,12522],256],13068:[[12459,12521,12483,12488],256],13069:[[12459,12525,12522,12540],256],13070:[[12460,12525,12531],256],13071:[[12460,12531,12510],256],13072:[[12462,12460],256],13073:[[12462,12491,12540],256],13074:[[12461,12517,12522,12540],256],13075:[[12462,12523,12480,12540],256],13076:[[12461,12525],256],13077:[[12461,12525,12464,12521,12512],256],13078:[[12461,12525,12513,12540,12488,12523],256],13079:[[12461,12525,12527,12483,12488],256],13080:[[12464,12521,12512],256],13081:[[12464,12521,12512,12488,12531],256],13082:[[12463,12523,12476,12452,12525],256],13083:[[12463,12525,12540,12493],256],13084:[[12465,12540,12473],256],13085:[[12467,12523,12490],256],13086:[[12467,12540,12509],256],13087:[[12469,12452,12463,12523],256],13088:[[12469,12531,12481,12540,12512],256],13089:[[12471,12522,12531,12464],256],13090:[[12475,12531,12481],256],13091:[[12475,12531,12488],256],13092:[[12480,12540,12473],256],13093:[[12487,12471],256],13094:[[12489,12523],256],13095:[[12488,12531],256],13096:[[12490,12494],256],13097:[[12494,12483,12488],256],13098:[[12495,12452,12484],256],13099:[[12497,12540,12475,12531,12488],256],13100:[[12497,12540,12484],256],13101:[[12496,12540,12524,12523],256],13102:[[12500,12450,12473,12488,12523],256],13103:[[12500,12463,12523],256],13104:[[12500,12467],256],13105:[[12499,12523],256],13106:[[12501,12449,12521,12483,12489],256],13107:[[12501,12451,12540,12488],256],13108:[[12502,12483,12471,12455,12523],256],13109:[[12501,12521,12531],256],13110:[[12504,12463,12479,12540,12523],256],13111:[[12506,12477],256],13112:[[12506,12491,12498],256],13113:[[12504,12523,12484],256],13114:[[12506,12531,12473],256],13115:[[12506,12540,12472],256],13116:[[12505,12540,12479],256],13117:[[12509,12452,12531,12488],256],13118:[[12508,12523,12488],256],13119:[[12507,12531],256],13120:[[12509,12531,12489],256],13121:[[12507,12540,12523],256],13122:[[12507,12540,12531],256],13123:[[12510,12452,12463,12525],256],13124:[[12510,12452,12523],256],13125:[[12510,12483,12495],256],13126:[[12510,12523,12463],256],13127:[[12510,12531,12471,12519,12531],256],13128:[[12511,12463,12525,12531],256],13129:[[12511,12522],256],13130:[[12511,12522,12496,12540,12523],256],13131:[[12513,12460],256],13132:[[12513,12460,12488,12531],256],13133:[[12513,12540,12488,12523],256],13134:[[12516,12540,12489],256],13135:[[12516,12540,12523],256],13136:[[12518,12450,12531],256],13137:[[12522,12483,12488,12523],256],13138:[[12522,12521],256],13139:[[12523,12500,12540],256],13140:[[12523,12540,12502,12523],256],13141:[[12524,12512],256],13142:[[12524,12531,12488,12466,12531],256],13143:[[12527,12483,12488],256],13144:[[48,28857],256],13145:[[49,28857],256],13146:[[50,28857],256],13147:[[51,28857],256],13148:[[52,28857],256],13149:[[53,28857],256],13150:[[54,28857],256],13151:[[55,28857],256],13152:[[56,28857],256],13153:[[57,28857],256],13154:[[49,48,28857],256],13155:[[49,49,28857],256],13156:[[49,50,28857],256],13157:[[49,51,28857],256],13158:[[49,52,28857],256],13159:[[49,53,28857],256],13160:[[49,54,28857],256],13161:[[49,55,28857],256],13162:[[49,56,28857],256],13163:[[49,57,28857],256],13164:[[50,48,28857],256],13165:[[50,49,28857],256],13166:[[50,50,28857],256],13167:[[50,51,28857],256],13168:[[50,52,28857],256],13169:[[104,80,97],256],13170:[[100,97],256],13171:[[65,85],256],13172:[[98,97,114],256],13173:[[111,86],256],13174:[[112,99],256],13175:[[100,109],256],13176:[[100,109,178],256],13177:[[100,109,179],256],13178:[[73,85],256],13179:[[24179,25104],256],13180:[[26157,21644],256],13181:[[22823,27491],256],13182:[[26126,27835],256],13183:[[26666,24335,20250,31038],256],13184:[[112,65],256],13185:[[110,65],256],13186:[[956,65],256],13187:[[109,65],256],13188:[[107,65],256],13189:[[75,66],256],13190:[[77,66],256],13191:[[71,66],256],13192:[[99,97,108],256],13193:[[107,99,97,108],256],13194:[[112,70],256],13195:[[110,70],256],13196:[[956,70],256],13197:[[956,103],256],13198:[[109,103],256],13199:[[107,103],256],13200:[[72,122],256],13201:[[107,72,122],256],13202:[[77,72,122],256],13203:[[71,72,122],256],13204:[[84,72,122],256],13205:[[956,8467],256],13206:[[109,8467],256],13207:[[100,8467],256],13208:[[107,8467],256],13209:[[102,109],256],13210:[[110,109],256],13211:[[956,109],256],13212:[[109,109],256],13213:[[99,109],256],13214:[[107,109],256],13215:[[109,109,178],256],13216:[[99,109,178],256],13217:[[109,178],256],13218:[[107,109,178],256],13219:[[109,109,179],256],13220:[[99,109,179],256],13221:[[109,179],256],13222:[[107,109,179],256],13223:[[109,8725,115],256],13224:[[109,8725,115,178],256],13225:[[80,97],256],13226:[[107,80,97],256],13227:[[77,80,97],256],13228:[[71,80,97],256],13229:[[114,97,100],256],13230:[[114,97,100,8725,115],256],13231:[[114,97,100,8725,115,178],256],13232:[[112,115],256],13233:[[110,115],256],13234:[[956,115],256],13235:[[109,115],256],13236:[[112,86],256],13237:[[110,86],256],13238:[[956,86],256],13239:[[109,86],256],13240:[[107,86],256],13241:[[77,86],256],13242:[[112,87],256],13243:[[110,87],256],13244:[[956,87],256],13245:[[109,87],256],13246:[[107,87],256],13247:[[77,87],256],13248:[[107,937],256],13249:[[77,937],256],13250:[[97,46,109,46],256],13251:[[66,113],256],13252:[[99,99],256],13253:[[99,100],256],13254:[[67,8725,107,103],256],13255:[[67,111,46],256],13256:[[100,66],256],13257:[[71,121],256],13258:[[104,97],256],13259:[[72,80],256],13260:[[105,110],256],13261:[[75,75],256],13262:[[75,77],256],13263:[[107,116],256],13264:[[108,109],256],13265:[[108,110],256],13266:[[108,111,103],256],13267:[[108,120],256],13268:[[109,98],256],13269:[[109,105,108],256],13270:[[109,111,108],256],13271:[[80,72],256],13272:[[112,46,109,46],256],13273:[[80,80,77],256],13274:[[80,82],256],13275:[[115,114],256],13276:[[83,118],256],13277:[[87,98],256],13278:[[86,8725,109],256],13279:[[65,8725,109],256],13280:[[49,26085],256],13281:[[50,26085],256],13282:[[51,26085],256],13283:[[52,26085],256],13284:[[53,26085],256],13285:[[54,26085],256],13286:[[55,26085],256],13287:[[56,26085],256],13288:[[57,26085],256],13289:[[49,48,26085],256],13290:[[49,49,26085],256],13291:[[49,50,26085],256],13292:[[49,51,26085],256],13293:[[49,52,26085],256],13294:[[49,53,26085],256],13295:[[49,54,26085],256],13296:[[49,55,26085],256],13297:[[49,56,26085],256],13298:[[49,57,26085],256],13299:[[50,48,26085],256],13300:[[50,49,26085],256],13301:[[50,50,26085],256],13302:[[50,51,26085],256],13303:[[50,52,26085],256],13304:[[50,53,26085],256],13305:[[50,54,26085],256],13306:[[50,55,26085],256],13307:[[50,56,26085],256],13308:[[50,57,26085],256],13309:[[51,48,26085],256],13310:[[51,49,26085],256],13311:[[103,97,108],256]},27136:{92912:[,1],92913:[,1],92914:[,1],92915:[,1],92916:[,1]},27392:{92976:[,230],92977:[,230],92978:[,230],92979:[,230],92980:[,230],92981:[,230],92982:[,230]},42496:{42607:[,230],42612:[,230],42613:[,230],42614:[,230],42615:[,230],42616:[,230],42617:[,230],42618:[,230],42619:[,230],42620:[,230],42621:[,230],42652:[[1098],256],42653:[[1100],256],42655:[,230],42736:[,230],42737:[,230]},42752:{42864:[[42863],256],43e3:[[294],256],43001:[[339],256]},43008:{43014:[,9],43204:[,9],43232:[,230],43233:[,230],43234:[,230],43235:[,230],43236:[,230],43237:[,230],43238:[,230],43239:[,230],43240:[,230],43241:[,230],43242:[,230],43243:[,230],43244:[,230],43245:[,230],43246:[,230],43247:[,230],43248:[,230],43249:[,230]},43264:{43307:[,220],43308:[,220],43309:[,220],43347:[,9],43443:[,7],43456:[,9]},43520:{43696:[,230],43698:[,230],43699:[,230],43700:[,220],43703:[,230],43704:[,230],43710:[,230],43711:[,230],43713:[,230],43766:[,9]},43776:{43868:[[42791],256],43869:[[43831],256],43870:[[619],256],43871:[[43858],256],44013:[,9]},48128:{113822:[,1]},53504:{119134:[[119127,119141],512],119135:[[119128,119141],512],119136:[[119135,119150],512],119137:[[119135,119151],512],119138:[[119135,119152],512],119139:[[119135,119153],512],119140:[[119135,119154],512],119141:[,216],119142:[,216],119143:[,1],119144:[,1],119145:[,1],119149:[,226],119150:[,216],119151:[,216],119152:[,216],119153:[,216],119154:[,216],119163:[,220],119164:[,220],119165:[,220],119166:[,220],119167:[,220],119168:[,220],119169:[,220],119170:[,220],119173:[,230],119174:[,230],119175:[,230],119176:[,230],119177:[,230],119178:[,220],119179:[,220],119210:[,230],119211:[,230],119212:[,230],119213:[,230],119227:[[119225,119141],512],119228:[[119226,119141],512],119229:[[119227,119150],512],119230:[[119228,119150],512],119231:[[119227,119151],512],119232:[[119228,119151],512]},53760:{119362:[,230],119363:[,230],119364:[,230]},54272:{119808:[[65],256],119809:[[66],256],119810:[[67],256],119811:[[68],256],119812:[[69],256],119813:[[70],256],119814:[[71],256],119815:[[72],256],119816:[[73],256],119817:[[74],256],119818:[[75],256],119819:[[76],256],119820:[[77],256],119821:[[78],256],119822:[[79],256],119823:[[80],256],119824:[[81],256],119825:[[82],256],119826:[[83],256],119827:[[84],256],119828:[[85],256],119829:[[86],256],119830:[[87],256],119831:[[88],256],119832:[[89],256],119833:[[90],256],119834:[[97],256],119835:[[98],256],119836:[[99],256],119837:[[100],256],119838:[[101],256],119839:[[102],256],119840:[[103],256],119841:[[104],256],119842:[[105],256],119843:[[106],256],119844:[[107],256],119845:[[108],256],119846:[[109],256],119847:[[110],256],119848:[[111],256],119849:[[112],256],119850:[[113],256],119851:[[114],256],119852:[[115],256],119853:[[116],256],119854:[[117],256],119855:[[118],256],119856:[[119],256],119857:[[120],256],119858:[[121],256],119859:[[122],256],119860:[[65],256],119861:[[66],256],119862:[[67],256],119863:[[68],256],119864:[[69],256],119865:[[70],256],119866:[[71],256],119867:[[72],256],119868:[[73],256],119869:[[74],256],119870:[[75],256],119871:[[76],256],119872:[[77],256],119873:[[78],256],119874:[[79],256],119875:[[80],256],119876:[[81],256],119877:[[82],256],119878:[[83],256],119879:[[84],256],119880:[[85],256],119881:[[86],256],119882:[[87],256],119883:[[88],256],119884:[[89],256],119885:[[90],256],119886:[[97],256],119887:[[98],256],119888:[[99],256],119889:[[100],256],119890:[[101],256],119891:[[102],256],119892:[[103],256],119894:[[105],256],119895:[[106],256],119896:[[107],256],119897:[[108],256],119898:[[109],256],119899:[[110],256],119900:[[111],256],119901:[[112],256],119902:[[113],256],119903:[[114],256],119904:[[115],256],119905:[[116],256],119906:[[117],256],119907:[[118],256],119908:[[119],256],119909:[[120],256],119910:[[121],256],119911:[[122],256],119912:[[65],256],119913:[[66],256],119914:[[67],256],119915:[[68],256],119916:[[69],256],119917:[[70],256],119918:[[71],256],119919:[[72],256],119920:[[73],256],119921:[[74],256],119922:[[75],256],119923:[[76],256],119924:[[77],256],119925:[[78],256],119926:[[79],256],119927:[[80],256],119928:[[81],256],119929:[[82],256],119930:[[83],256],119931:[[84],256],119932:[[85],256],119933:[[86],256],119934:[[87],256],119935:[[88],256],119936:[[89],256],119937:[[90],256],119938:[[97],256],119939:[[98],256],119940:[[99],256],119941:[[100],256],119942:[[101],256],119943:[[102],256],119944:[[103],256],119945:[[104],256],119946:[[105],256],119947:[[106],256],119948:[[107],256],119949:[[108],256],119950:[[109],256],119951:[[110],256],119952:[[111],256],119953:[[112],256],119954:[[113],256],119955:[[114],256],119956:[[115],256],119957:[[116],256],119958:[[117],256],119959:[[118],256],119960:[[119],256],119961:[[120],256],119962:[[121],256],119963:[[122],256],119964:[[65],256],119966:[[67],256],119967:[[68],256],119970:[[71],256],119973:[[74],256],119974:[[75],256],119977:[[78],256],119978:[[79],256],119979:[[80],256],119980:[[81],256],119982:[[83],256],119983:[[84],256],119984:[[85],256],119985:[[86],256],119986:[[87],256],119987:[[88],256],119988:[[89],256],119989:[[90],256],119990:[[97],256],119991:[[98],256],119992:[[99],256],119993:[[100],256],119995:[[102],256],119997:[[104],256],119998:[[105],256],119999:[[106],256],12e4:[[107],256],120001:[[108],256],120002:[[109],256],120003:[[110],256],120005:[[112],256],120006:[[113],256],120007:[[114],256],120008:[[115],256],120009:[[116],256],120010:[[117],256],120011:[[118],256],120012:[[119],256],120013:[[120],256],120014:[[121],256],120015:[[122],256],120016:[[65],256],120017:[[66],256],120018:[[67],256],120019:[[68],256],120020:[[69],256],120021:[[70],256],120022:[[71],256],120023:[[72],256],120024:[[73],256],120025:[[74],256],120026:[[75],256],120027:[[76],256],120028:[[77],256],120029:[[78],256],120030:[[79],256],120031:[[80],256],120032:[[81],256],120033:[[82],256],120034:[[83],256],120035:[[84],256],120036:[[85],256],120037:[[86],256],120038:[[87],256],120039:[[88],256],120040:[[89],256],120041:[[90],256],120042:[[97],256],120043:[[98],256],120044:[[99],256],120045:[[100],256],120046:[[101],256],120047:[[102],256],120048:[[103],256],120049:[[104],256],120050:[[105],256],120051:[[106],256],120052:[[107],256],120053:[[108],256],120054:[[109],256],120055:[[110],256],120056:[[111],256],120057:[[112],256],120058:[[113],256],120059:[[114],256],120060:[[115],256],120061:[[116],256],120062:[[117],256],120063:[[118],256]},54528:{120064:[[119],256],120065:[[120],256],120066:[[121],256],120067:[[122],256],120068:[[65],256],120069:[[66],256],120071:[[68],256],120072:[[69],256],120073:[[70],256],120074:[[71],256],120077:[[74],256],120078:[[75],256],120079:[[76],256],120080:[[77],256],120081:[[78],256],120082:[[79],256],120083:[[80],256],120084:[[81],256],120086:[[83],256],120087:[[84],256],120088:[[85],256],120089:[[86],256],120090:[[87],256],120091:[[88],256],120092:[[89],256],120094:[[97],256],120095:[[98],256],120096:[[99],256],120097:[[100],256],120098:[[101],256],120099:[[102],256],120100:[[103],256],120101:[[104],256],120102:[[105],256],120103:[[106],256],120104:[[107],256],120105:[[108],256],120106:[[109],256],120107:[[110],256],120108:[[111],256],120109:[[112],256],120110:[[113],256],120111:[[114],256],120112:[[115],256],120113:[[116],256],120114:[[117],256],120115:[[118],256],120116:[[119],256],120117:[[120],256],120118:[[121],256],120119:[[122],256],120120:[[65],256],120121:[[66],256],120123:[[68],256],120124:[[69],256],120125:[[70],256],120126:[[71],256],120128:[[73],256],120129:[[74],256],120130:[[75],256],120131:[[76],256],120132:[[77],256],120134:[[79],256],120138:[[83],256],120139:[[84],256],120140:[[85],256],120141:[[86],256],120142:[[87],256],120143:[[88],256],120144:[[89],256],120146:[[97],256],120147:[[98],256],120148:[[99],256],120149:[[100],256],120150:[[101],256],120151:[[102],256],120152:[[103],256],120153:[[104],256],120154:[[105],256],120155:[[106],256],120156:[[107],256],120157:[[108],256],120158:[[109],256],120159:[[110],256],120160:[[111],256],120161:[[112],256],120162:[[113],256],120163:[[114],256],120164:[[115],256],120165:[[116],256],120166:[[117],256],120167:[[118],256],120168:[[119],256],120169:[[120],256],120170:[[121],256],120171:[[122],256],120172:[[65],256],120173:[[66],256],120174:[[67],256],120175:[[68],256],120176:[[69],256],120177:[[70],256],120178:[[71],256],120179:[[72],256],120180:[[73],256],120181:[[74],256],120182:[[75],256],120183:[[76],256],120184:[[77],256],120185:[[78],256],120186:[[79],256],120187:[[80],256],120188:[[81],256],120189:[[82],256],120190:[[83],256],120191:[[84],256],120192:[[85],256],120193:[[86],256],120194:[[87],256],120195:[[88],256],120196:[[89],256],120197:[[90],256],120198:[[97],256],120199:[[98],256],120200:[[99],256],120201:[[100],256],120202:[[101],256],120203:[[102],256],120204:[[103],256],120205:[[104],256],120206:[[105],256],120207:[[106],256],120208:[[107],256],120209:[[108],256],120210:[[109],256],120211:[[110],256],120212:[[111],256],120213:[[112],256],120214:[[113],256],120215:[[114],256],120216:[[115],256],120217:[[116],256],120218:[[117],256],120219:[[118],256],120220:[[119],256],120221:[[120],256],120222:[[121],256],120223:[[122],256],120224:[[65],256],120225:[[66],256],120226:[[67],256],120227:[[68],256],120228:[[69],256],120229:[[70],256],120230:[[71],256],120231:[[72],256],120232:[[73],256],120233:[[74],256],120234:[[75],256],120235:[[76],256],120236:[[77],256],120237:[[78],256],120238:[[79],256],120239:[[80],256],120240:[[81],256],120241:[[82],256],120242:[[83],256],120243:[[84],256],120244:[[85],256],120245:[[86],256],120246:[[87],256],120247:[[88],256],120248:[[89],256],120249:[[90],256],120250:[[97],256],120251:[[98],256],120252:[[99],256],120253:[[100],256],120254:[[101],256],120255:[[102],256],120256:[[103],256],120257:[[104],256],120258:[[105],256],120259:[[106],256],120260:[[107],256],120261:[[108],256],120262:[[109],256],120263:[[110],256],120264:[[111],256],120265:[[112],256],120266:[[113],256],120267:[[114],256],120268:[[115],256],120269:[[116],256],120270:[[117],256],120271:[[118],256],120272:[[119],256],120273:[[120],256],120274:[[121],256],120275:[[122],256],120276:[[65],256],120277:[[66],256],120278:[[67],256],120279:[[68],256],120280:[[69],256],120281:[[70],256],120282:[[71],256],120283:[[72],256],120284:[[73],256],120285:[[74],256],120286:[[75],256],120287:[[76],256],120288:[[77],256],120289:[[78],256],120290:[[79],256],120291:[[80],256],120292:[[81],256],120293:[[82],256],120294:[[83],256],120295:[[84],256],120296:[[85],256],120297:[[86],256],120298:[[87],256],120299:[[88],256],120300:[[89],256],120301:[[90],256],120302:[[97],256],120303:[[98],256],120304:[[99],256],120305:[[100],256],120306:[[101],256],120307:[[102],256],120308:[[103],256],120309:[[104],256],120310:[[105],256],120311:[[106],256],120312:[[107],256],120313:[[108],256],120314:[[109],256],120315:[[110],256],120316:[[111],256],120317:[[112],256],120318:[[113],256],120319:[[114],256]},54784:{120320:[[115],256],120321:[[116],256],120322:[[117],256],120323:[[118],256],120324:[[119],256],120325:[[120],256],120326:[[121],256],120327:[[122],256],120328:[[65],256],120329:[[66],256],120330:[[67],256],120331:[[68],256],120332:[[69],256],120333:[[70],256],120334:[[71],256],120335:[[72],256],120336:[[73],256],120337:[[74],256],120338:[[75],256],120339:[[76],256],120340:[[77],256],120341:[[78],256],120342:[[79],256],120343:[[80],256],120344:[[81],256],120345:[[82],256],120346:[[83],256],120347:[[84],256],120348:[[85],256],120349:[[86],256],120350:[[87],256],120351:[[88],256],120352:[[89],256],120353:[[90],256],120354:[[97],256],120355:[[98],256],120356:[[99],256],120357:[[100],256],120358:[[101],256],120359:[[102],256],120360:[[103],256],120361:[[104],256],120362:[[105],256],120363:[[106],256],120364:[[107],256],120365:[[108],256],120366:[[109],256],120367:[[110],256],120368:[[111],256],120369:[[112],256],120370:[[113],256],120371:[[114],256],120372:[[115],256],120373:[[116],256],120374:[[117],256],120375:[[118],256],120376:[[119],256],120377:[[120],256],120378:[[121],256],120379:[[122],256],120380:[[65],256],120381:[[66],256],120382:[[67],256],120383:[[68],256],120384:[[69],256],120385:[[70],256],120386:[[71],256],120387:[[72],256],120388:[[73],256],120389:[[74],256],120390:[[75],256],120391:[[76],256],120392:[[77],256],120393:[[78],256],120394:[[79],256],120395:[[80],256],120396:[[81],256],120397:[[82],256],120398:[[83],256],120399:[[84],256],120400:[[85],256],120401:[[86],256],120402:[[87],256],120403:[[88],256],120404:[[89],256],120405:[[90],256],120406:[[97],256],120407:[[98],256],120408:[[99],256],120409:[[100],256],120410:[[101],256],120411:[[102],256],120412:[[103],256],120413:[[104],256],120414:[[105],256],120415:[[106],256],120416:[[107],256],120417:[[108],256],120418:[[109],256],120419:[[110],256],120420:[[111],256],120421:[[112],256],120422:[[113],256],120423:[[114],256],120424:[[115],256],120425:[[116],256],120426:[[117],256],120427:[[118],256],120428:[[119],256],120429:[[120],256],120430:[[121],256],120431:[[122],256],120432:[[65],256],120433:[[66],256],120434:[[67],256],120435:[[68],256],120436:[[69],256],120437:[[70],256],120438:[[71],256],120439:[[72],256],120440:[[73],256],120441:[[74],256],120442:[[75],256],120443:[[76],256],120444:[[77],256],120445:[[78],256],120446:[[79],256],120447:[[80],256],120448:[[81],256],120449:[[82],256],120450:[[83],256],120451:[[84],256],120452:[[85],256],120453:[[86],256],120454:[[87],256],120455:[[88],256],120456:[[89],256],120457:[[90],256],120458:[[97],256],120459:[[98],256],120460:[[99],256],120461:[[100],256],120462:[[101],256],120463:[[102],256],120464:[[103],256],120465:[[104],256],120466:[[105],256],120467:[[106],256],120468:[[107],256],120469:[[108],256],120470:[[109],256],120471:[[110],256],120472:[[111],256],120473:[[112],256],120474:[[113],256],120475:[[114],256],120476:[[115],256],120477:[[116],256],120478:[[117],256],120479:[[118],256],120480:[[119],256],120481:[[120],256],120482:[[121],256],120483:[[122],256],120484:[[305],256],120485:[[567],256],120488:[[913],256],120489:[[914],256],120490:[[915],256],120491:[[916],256],120492:[[917],256],120493:[[918],256],120494:[[919],256],120495:[[920],256],120496:[[921],256],120497:[[922],256],120498:[[923],256],120499:[[924],256],120500:[[925],256],120501:[[926],256],120502:[[927],256],120503:[[928],256],120504:[[929],256],120505:[[1012],256],120506:[[931],256],120507:[[932],256],120508:[[933],256],120509:[[934],256],120510:[[935],256],120511:[[936],256],120512:[[937],256],120513:[[8711],256],120514:[[945],256],120515:[[946],256],120516:[[947],256],120517:[[948],256],120518:[[949],256],120519:[[950],256],120520:[[951],256],120521:[[952],256],120522:[[953],256],120523:[[954],256],120524:[[955],256],120525:[[956],256],120526:[[957],256],120527:[[958],256],120528:[[959],256],120529:[[960],256],120530:[[961],256],120531:[[962],256],120532:[[963],256],120533:[[964],256],120534:[[965],256],120535:[[966],256],120536:[[967],256],120537:[[968],256],120538:[[969],256],120539:[[8706],256],120540:[[1013],256],120541:[[977],256],120542:[[1008],256],120543:[[981],256],120544:[[1009],256],120545:[[982],256],120546:[[913],256],120547:[[914],256],120548:[[915],256],120549:[[916],256],120550:[[917],256],120551:[[918],256],120552:[[919],256],120553:[[920],256],120554:[[921],256],120555:[[922],256],120556:[[923],256],120557:[[924],256],120558:[[925],256],120559:[[926],256],120560:[[927],256],120561:[[928],256],120562:[[929],256],120563:[[1012],256],120564:[[931],256],120565:[[932],256],120566:[[933],256],120567:[[934],256],120568:[[935],256],120569:[[936],256],120570:[[937],256],120571:[[8711],256],120572:[[945],256],120573:[[946],256],120574:[[947],256],120575:[[948],256]},55040:{120576:[[949],256],120577:[[950],256],120578:[[951],256],120579:[[952],256],120580:[[953],256],120581:[[954],256],120582:[[955],256],120583:[[956],256],120584:[[957],256],120585:[[958],256],120586:[[959],256],120587:[[960],256],120588:[[961],256],120589:[[962],256],120590:[[963],256],120591:[[964],256],120592:[[965],256],120593:[[966],256],120594:[[967],256],120595:[[968],256],120596:[[969],256],120597:[[8706],256],120598:[[1013],256],120599:[[977],256],120600:[[1008],256],120601:[[981],256],120602:[[1009],256],120603:[[982],256],120604:[[913],256],120605:[[914],256],120606:[[915],256],120607:[[916],256],120608:[[917],256],120609:[[918],256],120610:[[919],256],120611:[[920],256],120612:[[921],256],120613:[[922],256],120614:[[923],256],120615:[[924],256],120616:[[925],256],120617:[[926],256],120618:[[927],256],120619:[[928],256],120620:[[929],256],120621:[[1012],256],120622:[[931],256],120623:[[932],256],120624:[[933],256],120625:[[934],256],120626:[[935],256],120627:[[936],256],120628:[[937],256],120629:[[8711],256],120630:[[945],256],120631:[[946],256],120632:[[947],256],120633:[[948],256],120634:[[949],256],120635:[[950],256],120636:[[951],256],120637:[[952],256],120638:[[953],256],120639:[[954],256],120640:[[955],256],120641:[[956],256],120642:[[957],256],120643:[[958],256],120644:[[959],256],120645:[[960],256],120646:[[961],256],120647:[[962],256],120648:[[963],256],120649:[[964],256],120650:[[965],256],120651:[[966],256],120652:[[967],256],120653:[[968],256],120654:[[969],256],120655:[[8706],256],120656:[[1013],256],120657:[[977],256],120658:[[1008],256],120659:[[981],256],120660:[[1009],256],120661:[[982],256],120662:[[913],256],120663:[[914],256],120664:[[915],256],120665:[[916],256],120666:[[917],256],120667:[[918],256],120668:[[919],256],120669:[[920],256],120670:[[921],256],120671:[[922],256],120672:[[923],256],120673:[[924],256],120674:[[925],256],120675:[[926],256],120676:[[927],256],120677:[[928],256],120678:[[929],256],120679:[[1012],256],120680:[[931],256],120681:[[932],256],120682:[[933],256],120683:[[934],256],120684:[[935],256],120685:[[936],256],120686:[[937],256],120687:[[8711],256],120688:[[945],256],120689:[[946],256],120690:[[947],256],120691:[[948],256],120692:[[949],256],120693:[[950],256],120694:[[951],256],120695:[[952],256],120696:[[953],256],120697:[[954],256],120698:[[955],256],120699:[[956],256],120700:[[957],256],120701:[[958],256],120702:[[959],256],120703:[[960],256],120704:[[961],256],120705:[[962],256],120706:[[963],256],120707:[[964],256],120708:[[965],256],120709:[[966],256],120710:[[967],256],120711:[[968],256],120712:[[969],256],120713:[[8706],256],120714:[[1013],256],120715:[[977],256],120716:[[1008],256],120717:[[981],256],120718:[[1009],256],120719:[[982],256],120720:[[913],256],120721:[[914],256],120722:[[915],256],120723:[[916],256],120724:[[917],256],120725:[[918],256],120726:[[919],256],120727:[[920],256],120728:[[921],256],120729:[[922],256],120730:[[923],256],120731:[[924],256],120732:[[925],256],120733:[[926],256],120734:[[927],256],120735:[[928],256],120736:[[929],256],120737:[[1012],256],120738:[[931],256],120739:[[932],256],120740:[[933],256],120741:[[934],256],120742:[[935],256],120743:[[936],256],120744:[[937],256],120745:[[8711],256],120746:[[945],256],120747:[[946],256],120748:[[947],256],120749:[[948],256],120750:[[949],256],120751:[[950],256],120752:[[951],256],120753:[[952],256],120754:[[953],256],120755:[[954],256],
120756:[[955],256],120757:[[956],256],120758:[[957],256],120759:[[958],256],120760:[[959],256],120761:[[960],256],120762:[[961],256],120763:[[962],256],120764:[[963],256],120765:[[964],256],120766:[[965],256],120767:[[966],256],120768:[[967],256],120769:[[968],256],120770:[[969],256],120771:[[8706],256],120772:[[1013],256],120773:[[977],256],120774:[[1008],256],120775:[[981],256],120776:[[1009],256],120777:[[982],256],120778:[[988],256],120779:[[989],256],120782:[[48],256],120783:[[49],256],120784:[[50],256],120785:[[51],256],120786:[[52],256],120787:[[53],256],120788:[[54],256],120789:[[55],256],120790:[[56],256],120791:[[57],256],120792:[[48],256],120793:[[49],256],120794:[[50],256],120795:[[51],256],120796:[[52],256],120797:[[53],256],120798:[[54],256],120799:[[55],256],120800:[[56],256],120801:[[57],256],120802:[[48],256],120803:[[49],256],120804:[[50],256],120805:[[51],256],120806:[[52],256],120807:[[53],256],120808:[[54],256],120809:[[55],256],120810:[[56],256],120811:[[57],256],120812:[[48],256],120813:[[49],256],120814:[[50],256],120815:[[51],256],120816:[[52],256],120817:[[53],256],120818:[[54],256],120819:[[55],256],120820:[[56],256],120821:[[57],256],120822:[[48],256],120823:[[49],256],120824:[[50],256],120825:[[51],256],120826:[[52],256],120827:[[53],256],120828:[[54],256],120829:[[55],256],120830:[[56],256],120831:[[57],256]},59392:{125136:[,220],125137:[,220],125138:[,220],125139:[,220],125140:[,220],125141:[,220],125142:[,220]},60928:{126464:[[1575],256],126465:[[1576],256],126466:[[1580],256],126467:[[1583],256],126469:[[1608],256],126470:[[1586],256],126471:[[1581],256],126472:[[1591],256],126473:[[1610],256],126474:[[1603],256],126475:[[1604],256],126476:[[1605],256],126477:[[1606],256],126478:[[1587],256],126479:[[1593],256],126480:[[1601],256],126481:[[1589],256],126482:[[1602],256],126483:[[1585],256],126484:[[1588],256],126485:[[1578],256],126486:[[1579],256],126487:[[1582],256],126488:[[1584],256],126489:[[1590],256],126490:[[1592],256],126491:[[1594],256],126492:[[1646],256],126493:[[1722],256],126494:[[1697],256],126495:[[1647],256],126497:[[1576],256],126498:[[1580],256],126500:[[1607],256],126503:[[1581],256],126505:[[1610],256],126506:[[1603],256],126507:[[1604],256],126508:[[1605],256],126509:[[1606],256],126510:[[1587],256],126511:[[1593],256],126512:[[1601],256],126513:[[1589],256],126514:[[1602],256],126516:[[1588],256],126517:[[1578],256],126518:[[1579],256],126519:[[1582],256],126521:[[1590],256],126523:[[1594],256],126530:[[1580],256],126535:[[1581],256],126537:[[1610],256],126539:[[1604],256],126541:[[1606],256],126542:[[1587],256],126543:[[1593],256],126545:[[1589],256],126546:[[1602],256],126548:[[1588],256],126551:[[1582],256],126553:[[1590],256],126555:[[1594],256],126557:[[1722],256],126559:[[1647],256],126561:[[1576],256],126562:[[1580],256],126564:[[1607],256],126567:[[1581],256],126568:[[1591],256],126569:[[1610],256],126570:[[1603],256],126572:[[1605],256],126573:[[1606],256],126574:[[1587],256],126575:[[1593],256],126576:[[1601],256],126577:[[1589],256],126578:[[1602],256],126580:[[1588],256],126581:[[1578],256],126582:[[1579],256],126583:[[1582],256],126585:[[1590],256],126586:[[1592],256],126587:[[1594],256],126588:[[1646],256],126590:[[1697],256],126592:[[1575],256],126593:[[1576],256],126594:[[1580],256],126595:[[1583],256],126596:[[1607],256],126597:[[1608],256],126598:[[1586],256],126599:[[1581],256],126600:[[1591],256],126601:[[1610],256],126603:[[1604],256],126604:[[1605],256],126605:[[1606],256],126606:[[1587],256],126607:[[1593],256],126608:[[1601],256],126609:[[1589],256],126610:[[1602],256],126611:[[1585],256],126612:[[1588],256],126613:[[1578],256],126614:[[1579],256],126615:[[1582],256],126616:[[1584],256],126617:[[1590],256],126618:[[1592],256],126619:[[1594],256],126625:[[1576],256],126626:[[1580],256],126627:[[1583],256],126629:[[1608],256],126630:[[1586],256],126631:[[1581],256],126632:[[1591],256],126633:[[1610],256],126635:[[1604],256],126636:[[1605],256],126637:[[1606],256],126638:[[1587],256],126639:[[1593],256],126640:[[1601],256],126641:[[1589],256],126642:[[1602],256],126643:[[1585],256],126644:[[1588],256],126645:[[1578],256],126646:[[1579],256],126647:[[1582],256],126648:[[1584],256],126649:[[1590],256],126650:[[1592],256],126651:[[1594],256]},61696:{127232:[[48,46],256],127233:[[48,44],256],127234:[[49,44],256],127235:[[50,44],256],127236:[[51,44],256],127237:[[52,44],256],127238:[[53,44],256],127239:[[54,44],256],127240:[[55,44],256],127241:[[56,44],256],127242:[[57,44],256],127248:[[40,65,41],256],127249:[[40,66,41],256],127250:[[40,67,41],256],127251:[[40,68,41],256],127252:[[40,69,41],256],127253:[[40,70,41],256],127254:[[40,71,41],256],127255:[[40,72,41],256],127256:[[40,73,41],256],127257:[[40,74,41],256],127258:[[40,75,41],256],127259:[[40,76,41],256],127260:[[40,77,41],256],127261:[[40,78,41],256],127262:[[40,79,41],256],127263:[[40,80,41],256],127264:[[40,81,41],256],127265:[[40,82,41],256],127266:[[40,83,41],256],127267:[[40,84,41],256],127268:[[40,85,41],256],127269:[[40,86,41],256],127270:[[40,87,41],256],127271:[[40,88,41],256],127272:[[40,89,41],256],127273:[[40,90,41],256],127274:[[12308,83,12309],256],127275:[[67],256],127276:[[82],256],127277:[[67,68],256],127278:[[87,90],256],127280:[[65],256],127281:[[66],256],127282:[[67],256],127283:[[68],256],127284:[[69],256],127285:[[70],256],127286:[[71],256],127287:[[72],256],127288:[[73],256],127289:[[74],256],127290:[[75],256],127291:[[76],256],127292:[[77],256],127293:[[78],256],127294:[[79],256],127295:[[80],256],127296:[[81],256],127297:[[82],256],127298:[[83],256],127299:[[84],256],127300:[[85],256],127301:[[86],256],127302:[[87],256],127303:[[88],256],127304:[[89],256],127305:[[90],256],127306:[[72,86],256],127307:[[77,86],256],127308:[[83,68],256],127309:[[83,83],256],127310:[[80,80,86],256],127311:[[87,67],256],127338:[[77,67],256],127339:[[77,68],256],127376:[[68,74],256]},61952:{127488:[[12411,12363],256],127489:[[12467,12467],256],127490:[[12469],256],127504:[[25163],256],127505:[[23383],256],127506:[[21452],256],127507:[[12487],256],127508:[[20108],256],127509:[[22810],256],127510:[[35299],256],127511:[[22825],256],127512:[[20132],256],127513:[[26144],256],127514:[[28961],256],127515:[[26009],256],127516:[[21069],256],127517:[[24460],256],127518:[[20877],256],127519:[[26032],256],127520:[[21021],256],127521:[[32066],256],127522:[[29983],256],127523:[[36009],256],127524:[[22768],256],127525:[[21561],256],127526:[[28436],256],127527:[[25237],256],127528:[[25429],256],127529:[[19968],256],127530:[[19977],256],127531:[[36938],256],127532:[[24038],256],127533:[[20013],256],127534:[[21491],256],127535:[[25351],256],127536:[[36208],256],127537:[[25171],256],127538:[[31105],256],127539:[[31354],256],127540:[[21512],256],127541:[[28288],256],127542:[[26377],256],127543:[[26376],256],127544:[[30003],256],127545:[[21106],256],127546:[[21942],256],127552:[[12308,26412,12309],256],127553:[[12308,19977,12309],256],127554:[[12308,20108,12309],256],127555:[[12308,23433,12309],256],127556:[[12308,28857,12309],256],127557:[[12308,25171,12309],256],127558:[[12308,30423,12309],256],127559:[[12308,21213,12309],256],127560:[[12308,25943,12309],256],127568:[[24471],256],127569:[[21487],256]},63488:{194560:[[20029]],194561:[[20024]],194562:[[20033]],194563:[[131362]],194564:[[20320]],194565:[[20398]],194566:[[20411]],194567:[[20482]],194568:[[20602]],194569:[[20633]],194570:[[20711]],194571:[[20687]],194572:[[13470]],194573:[[132666]],194574:[[20813]],194575:[[20820]],194576:[[20836]],194577:[[20855]],194578:[[132380]],194579:[[13497]],194580:[[20839]],194581:[[20877]],194582:[[132427]],194583:[[20887]],194584:[[20900]],194585:[[20172]],194586:[[20908]],194587:[[20917]],194588:[[168415]],194589:[[20981]],194590:[[20995]],194591:[[13535]],194592:[[21051]],194593:[[21062]],194594:[[21106]],194595:[[21111]],194596:[[13589]],194597:[[21191]],194598:[[21193]],194599:[[21220]],194600:[[21242]],194601:[[21253]],194602:[[21254]],194603:[[21271]],194604:[[21321]],194605:[[21329]],194606:[[21338]],194607:[[21363]],194608:[[21373]],194609:[[21375]],194610:[[21375]],194611:[[21375]],194612:[[133676]],194613:[[28784]],194614:[[21450]],194615:[[21471]],194616:[[133987]],194617:[[21483]],194618:[[21489]],194619:[[21510]],194620:[[21662]],194621:[[21560]],194622:[[21576]],194623:[[21608]],194624:[[21666]],194625:[[21750]],194626:[[21776]],194627:[[21843]],194628:[[21859]],194629:[[21892]],194630:[[21892]],194631:[[21913]],194632:[[21931]],194633:[[21939]],194634:[[21954]],194635:[[22294]],194636:[[22022]],194637:[[22295]],194638:[[22097]],194639:[[22132]],194640:[[20999]],194641:[[22766]],194642:[[22478]],194643:[[22516]],194644:[[22541]],194645:[[22411]],194646:[[22578]],194647:[[22577]],194648:[[22700]],194649:[[136420]],194650:[[22770]],194651:[[22775]],194652:[[22790]],194653:[[22810]],194654:[[22818]],194655:[[22882]],194656:[[136872]],194657:[[136938]],194658:[[23020]],194659:[[23067]],194660:[[23079]],194661:[[23e3]],194662:[[23142]],194663:[[14062]],194664:[[14076]],194665:[[23304]],194666:[[23358]],194667:[[23358]],194668:[[137672]],194669:[[23491]],194670:[[23512]],194671:[[23527]],194672:[[23539]],194673:[[138008]],194674:[[23551]],194675:[[23558]],194676:[[24403]],194677:[[23586]],194678:[[14209]],194679:[[23648]],194680:[[23662]],194681:[[23744]],194682:[[23693]],194683:[[138724]],194684:[[23875]],194685:[[138726]],194686:[[23918]],194687:[[23915]],194688:[[23932]],194689:[[24033]],194690:[[24034]],194691:[[14383]],194692:[[24061]],194693:[[24104]],194694:[[24125]],194695:[[24169]],194696:[[14434]],194697:[[139651]],194698:[[14460]],194699:[[24240]],194700:[[24243]],194701:[[24246]],194702:[[24266]],194703:[[172946]],194704:[[24318]],194705:[[140081]],194706:[[140081]],194707:[[33281]],194708:[[24354]],194709:[[24354]],194710:[[14535]],194711:[[144056]],194712:[[156122]],194713:[[24418]],194714:[[24427]],194715:[[14563]],194716:[[24474]],194717:[[24525]],194718:[[24535]],194719:[[24569]],194720:[[24705]],194721:[[14650]],194722:[[14620]],194723:[[24724]],194724:[[141012]],194725:[[24775]],194726:[[24904]],194727:[[24908]],194728:[[24910]],194729:[[24908]],194730:[[24954]],194731:[[24974]],194732:[[25010]],194733:[[24996]],194734:[[25007]],194735:[[25054]],194736:[[25074]],194737:[[25078]],194738:[[25104]],194739:[[25115]],194740:[[25181]],194741:[[25265]],194742:[[25300]],194743:[[25424]],194744:[[142092]],194745:[[25405]],194746:[[25340]],194747:[[25448]],194748:[[25475]],194749:[[25572]],194750:[[142321]],194751:[[25634]],194752:[[25541]],194753:[[25513]],194754:[[14894]],194755:[[25705]],194756:[[25726]],194757:[[25757]],194758:[[25719]],194759:[[14956]],194760:[[25935]],194761:[[25964]],194762:[[143370]],194763:[[26083]],194764:[[26360]],194765:[[26185]],194766:[[15129]],194767:[[26257]],194768:[[15112]],194769:[[15076]],194770:[[20882]],194771:[[20885]],194772:[[26368]],194773:[[26268]],194774:[[32941]],194775:[[17369]],194776:[[26391]],194777:[[26395]],194778:[[26401]],194779:[[26462]],194780:[[26451]],194781:[[144323]],194782:[[15177]],194783:[[26618]],194784:[[26501]],194785:[[26706]],194786:[[26757]],194787:[[144493]],194788:[[26766]],194789:[[26655]],194790:[[26900]],194791:[[15261]],194792:[[26946]],194793:[[27043]],194794:[[27114]],194795:[[27304]],194796:[[145059]],194797:[[27355]],194798:[[15384]],194799:[[27425]],194800:[[145575]],194801:[[27476]],194802:[[15438]],194803:[[27506]],194804:[[27551]],194805:[[27578]],194806:[[27579]],194807:[[146061]],194808:[[138507]],194809:[[146170]],194810:[[27726]],194811:[[146620]],194812:[[27839]],194813:[[27853]],194814:[[27751]],194815:[[27926]]},63744:{63744:[[35912]],63745:[[26356]],63746:[[36554]],63747:[[36040]],63748:[[28369]],63749:[[20018]],63750:[[21477]],63751:[[40860]],63752:[[40860]],63753:[[22865]],63754:[[37329]],63755:[[21895]],63756:[[22856]],63757:[[25078]],63758:[[30313]],63759:[[32645]],63760:[[34367]],63761:[[34746]],63762:[[35064]],63763:[[37007]],63764:[[27138]],63765:[[27931]],63766:[[28889]],63767:[[29662]],63768:[[33853]],63769:[[37226]],63770:[[39409]],63771:[[20098]],63772:[[21365]],63773:[[27396]],63774:[[29211]],63775:[[34349]],63776:[[40478]],63777:[[23888]],63778:[[28651]],63779:[[34253]],63780:[[35172]],63781:[[25289]],63782:[[33240]],63783:[[34847]],63784:[[24266]],63785:[[26391]],63786:[[28010]],63787:[[29436]],63788:[[37070]],63789:[[20358]],63790:[[20919]],63791:[[21214]],63792:[[25796]],63793:[[27347]],63794:[[29200]],63795:[[30439]],63796:[[32769]],63797:[[34310]],63798:[[34396]],63799:[[36335]],63800:[[38706]],63801:[[39791]],63802:[[40442]],63803:[[30860]],63804:[[31103]],63805:[[32160]],63806:[[33737]],63807:[[37636]],63808:[[40575]],63809:[[35542]],63810:[[22751]],63811:[[24324]],63812:[[31840]],63813:[[32894]],63814:[[29282]],63815:[[30922]],63816:[[36034]],63817:[[38647]],63818:[[22744]],63819:[[23650]],63820:[[27155]],63821:[[28122]],63822:[[28431]],63823:[[32047]],63824:[[32311]],63825:[[38475]],63826:[[21202]],63827:[[32907]],63828:[[20956]],63829:[[20940]],63830:[[31260]],63831:[[32190]],63832:[[33777]],63833:[[38517]],63834:[[35712]],63835:[[25295]],63836:[[27138]],63837:[[35582]],63838:[[20025]],63839:[[23527]],63840:[[24594]],63841:[[29575]],63842:[[30064]],63843:[[21271]],63844:[[30971]],63845:[[20415]],63846:[[24489]],63847:[[19981]],63848:[[27852]],63849:[[25976]],63850:[[32034]],63851:[[21443]],63852:[[22622]],63853:[[30465]],63854:[[33865]],63855:[[35498]],63856:[[27578]],63857:[[36784]],63858:[[27784]],63859:[[25342]],63860:[[33509]],63861:[[25504]],63862:[[30053]],63863:[[20142]],63864:[[20841]],63865:[[20937]],63866:[[26753]],63867:[[31975]],63868:[[33391]],63869:[[35538]],63870:[[37327]],63871:[[21237]],63872:[[21570]],63873:[[22899]],63874:[[24300]],63875:[[26053]],63876:[[28670]],63877:[[31018]],63878:[[38317]],63879:[[39530]],63880:[[40599]],63881:[[40654]],63882:[[21147]],63883:[[26310]],63884:[[27511]],63885:[[36706]],63886:[[24180]],63887:[[24976]],63888:[[25088]],63889:[[25754]],63890:[[28451]],63891:[[29001]],63892:[[29833]],63893:[[31178]],63894:[[32244]],63895:[[32879]],63896:[[36646]],63897:[[34030]],63898:[[36899]],63899:[[37706]],63900:[[21015]],63901:[[21155]],63902:[[21693]],63903:[[28872]],63904:[[35010]],63905:[[35498]],63906:[[24265]],63907:[[24565]],63908:[[25467]],63909:[[27566]],63910:[[31806]],63911:[[29557]],63912:[[20196]],63913:[[22265]],63914:[[23527]],63915:[[23994]],63916:[[24604]],63917:[[29618]],63918:[[29801]],63919:[[32666]],63920:[[32838]],63921:[[37428]],63922:[[38646]],63923:[[38728]],63924:[[38936]],63925:[[20363]],63926:[[31150]],63927:[[37300]],63928:[[38584]],63929:[[24801]],63930:[[20102]],63931:[[20698]],63932:[[23534]],63933:[[23615]],63934:[[26009]],63935:[[27138]],63936:[[29134]],63937:[[30274]],63938:[[34044]],63939:[[36988]],63940:[[40845]],63941:[[26248]],63942:[[38446]],63943:[[21129]],63944:[[26491]],63945:[[26611]],63946:[[27969]],63947:[[28316]],63948:[[29705]],63949:[[30041]],63950:[[30827]],63951:[[32016]],63952:[[39006]],63953:[[20845]],63954:[[25134]],63955:[[38520]],63956:[[20523]],63957:[[23833]],63958:[[28138]],63959:[[36650]],63960:[[24459]],63961:[[24900]],63962:[[26647]],63963:[[29575]],63964:[[38534]],63965:[[21033]],63966:[[21519]],63967:[[23653]],63968:[[26131]],63969:[[26446]],63970:[[26792]],63971:[[27877]],63972:[[29702]],63973:[[30178]],63974:[[32633]],63975:[[35023]],63976:[[35041]],63977:[[37324]],63978:[[38626]],63979:[[21311]],63980:[[28346]],63981:[[21533]],63982:[[29136]],63983:[[29848]],63984:[[34298]],63985:[[38563]],63986:[[40023]],63987:[[40607]],63988:[[26519]],63989:[[28107]],63990:[[33256]],63991:[[31435]],63992:[[31520]],63993:[[31890]],63994:[[29376]],63995:[[28825]],63996:[[35672]],63997:[[20160]],63998:[[33590]],63999:[[21050]],194816:[[27966]],194817:[[28023]],194818:[[27969]],194819:[[28009]],194820:[[28024]],194821:[[28037]],194822:[[146718]],194823:[[27956]],194824:[[28207]],194825:[[28270]],194826:[[15667]],194827:[[28363]],194828:[[28359]],194829:[[147153]],194830:[[28153]],194831:[[28526]],194832:[[147294]],194833:[[147342]],194834:[[28614]],194835:[[28729]],194836:[[28702]],194837:[[28699]],194838:[[15766]],194839:[[28746]],194840:[[28797]],194841:[[28791]],194842:[[28845]],194843:[[132389]],194844:[[28997]],194845:[[148067]],194846:[[29084]],194847:[[148395]],194848:[[29224]],194849:[[29237]],194850:[[29264]],194851:[[149e3]],194852:[[29312]],194853:[[29333]],194854:[[149301]],194855:[[149524]],194856:[[29562]],194857:[[29579]],194858:[[16044]],194859:[[29605]],194860:[[16056]],194861:[[16056]],194862:[[29767]],194863:[[29788]],194864:[[29809]],194865:[[29829]],194866:[[29898]],194867:[[16155]],194868:[[29988]],194869:[[150582]],194870:[[30014]],194871:[[150674]],194872:[[30064]],194873:[[139679]],194874:[[30224]],194875:[[151457]],194876:[[151480]],194877:[[151620]],194878:[[16380]],194879:[[16392]],194880:[[30452]],194881:[[151795]],194882:[[151794]],194883:[[151833]],194884:[[151859]],194885:[[30494]],194886:[[30495]],194887:[[30495]],194888:[[30538]],194889:[[16441]],194890:[[30603]],194891:[[16454]],194892:[[16534]],194893:[[152605]],194894:[[30798]],194895:[[30860]],194896:[[30924]],194897:[[16611]],194898:[[153126]],194899:[[31062]],194900:[[153242]],194901:[[153285]],194902:[[31119]],194903:[[31211]],194904:[[16687]],194905:[[31296]],194906:[[31306]],194907:[[31311]],194908:[[153980]],194909:[[154279]],194910:[[154279]],194911:[[31470]],194912:[[16898]],194913:[[154539]],194914:[[31686]],194915:[[31689]],194916:[[16935]],194917:[[154752]],194918:[[31954]],194919:[[17056]],194920:[[31976]],194921:[[31971]],194922:[[32e3]],194923:[[155526]],194924:[[32099]],194925:[[17153]],194926:[[32199]],194927:[[32258]],194928:[[32325]],194929:[[17204]],194930:[[156200]],194931:[[156231]],194932:[[17241]],194933:[[156377]],194934:[[32634]],194935:[[156478]],194936:[[32661]],194937:[[32762]],194938:[[32773]],194939:[[156890]],194940:[[156963]],194941:[[32864]],194942:[[157096]],194943:[[32880]],194944:[[144223]],194945:[[17365]],194946:[[32946]],194947:[[33027]],194948:[[17419]],194949:[[33086]],194950:[[23221]],194951:[[157607]],194952:[[157621]],194953:[[144275]],194954:[[144284]],194955:[[33281]],194956:[[33284]],194957:[[36766]],194958:[[17515]],194959:[[33425]],194960:[[33419]],194961:[[33437]],194962:[[21171]],194963:[[33457]],194964:[[33459]],194965:[[33469]],194966:[[33510]],194967:[[158524]],194968:[[33509]],194969:[[33565]],194970:[[33635]],194971:[[33709]],194972:[[33571]],194973:[[33725]],194974:[[33767]],194975:[[33879]],194976:[[33619]],194977:[[33738]],194978:[[33740]],194979:[[33756]],194980:[[158774]],194981:[[159083]],194982:[[158933]],194983:[[17707]],194984:[[34033]],194985:[[34035]],194986:[[34070]],194987:[[160714]],194988:[[34148]],194989:[[159532]],194990:[[17757]],194991:[[17761]],194992:[[159665]],194993:[[159954]],194994:[[17771]],194995:[[34384]],194996:[[34396]],194997:[[34407]],194998:[[34409]],194999:[[34473]],195e3:[[34440]],195001:[[34574]],195002:[[34530]],195003:[[34681]],195004:[[34600]],195005:[[34667]],195006:[[34694]],195007:[[17879]],195008:[[34785]],195009:[[34817]],195010:[[17913]],195011:[[34912]],195012:[[34915]],195013:[[161383]],195014:[[35031]],195015:[[35038]],195016:[[17973]],195017:[[35066]],195018:[[13499]],195019:[[161966]],195020:[[162150]],195021:[[18110]],195022:[[18119]],195023:[[35488]],195024:[[35565]],195025:[[35722]],195026:[[35925]],195027:[[162984]],195028:[[36011]],195029:[[36033]],195030:[[36123]],195031:[[36215]],195032:[[163631]],195033:[[133124]],195034:[[36299]],195035:[[36284]],195036:[[36336]],195037:[[133342]],195038:[[36564]],195039:[[36664]],195040:[[165330]],195041:[[165357]],195042:[[37012]],195043:[[37105]],195044:[[37137]],195045:[[165678]],195046:[[37147]],195047:[[37432]],195048:[[37591]],195049:[[37592]],195050:[[37500]],195051:[[37881]],195052:[[37909]],195053:[[166906]],195054:[[38283]],195055:[[18837]],195056:[[38327]],195057:[[167287]],195058:[[18918]],195059:[[38595]],195060:[[23986]],195061:[[38691]],195062:[[168261]],195063:[[168474]],195064:[[19054]],195065:[[19062]],195066:[[38880]],195067:[[168970]],195068:[[19122]],195069:[[169110]],195070:[[38923]],195071:[[38923]]},64e3:{64e3:[[20999]],64001:[[24230]],64002:[[25299]],64003:[[31958]],64004:[[23429]],64005:[[27934]],64006:[[26292]],64007:[[36667]],64008:[[34892]],64009:[[38477]],64010:[[35211]],64011:[[24275]],64012:[[20800]],64013:[[21952]],64016:[[22618]],64018:[[26228]],64021:[[20958]],64022:[[29482]],64023:[[30410]],64024:[[31036]],64025:[[31070]],64026:[[31077]],64027:[[31119]],64028:[[38742]],64029:[[31934]],64030:[[32701]],64032:[[34322]],64034:[[35576]],64037:[[36920]],64038:[[37117]],64042:[[39151]],64043:[[39164]],64044:[[39208]],64045:[[40372]],64046:[[37086]],64047:[[38583]],64048:[[20398]],64049:[[20711]],64050:[[20813]],64051:[[21193]],64052:[[21220]],64053:[[21329]],64054:[[21917]],64055:[[22022]],64056:[[22120]],64057:[[22592]],64058:[[22696]],64059:[[23652]],64060:[[23662]],64061:[[24724]],64062:[[24936]],64063:[[24974]],64064:[[25074]],64065:[[25935]],64066:[[26082]],64067:[[26257]],64068:[[26757]],64069:[[28023]],64070:[[28186]],64071:[[28450]],64072:[[29038]],64073:[[29227]],64074:[[29730]],64075:[[30865]],64076:[[31038]],64077:[[31049]],64078:[[31048]],64079:[[31056]],64080:[[31062]],64081:[[31069]],64082:[[31117]],64083:[[31118]],64084:[[31296]],64085:[[31361]],64086:[[31680]],64087:[[32244]],64088:[[32265]],64089:[[32321]],64090:[[32626]],64091:[[32773]],64092:[[33261]],64093:[[33401]],64094:[[33401]],64095:[[33879]],64096:[[35088]],64097:[[35222]],64098:[[35585]],64099:[[35641]],64100:[[36051]],64101:[[36104]],64102:[[36790]],64103:[[36920]],64104:[[38627]],64105:[[38911]],64106:[[38971]],64107:[[24693]],64108:[[148206]],64109:[[33304]],64112:[[20006]],64113:[[20917]],64114:[[20840]],64115:[[20352]],64116:[[20805]],64117:[[20864]],64118:[[21191]],64119:[[21242]],64120:[[21917]],64121:[[21845]],64122:[[21913]],64123:[[21986]],64124:[[22618]],64125:[[22707]],64126:[[22852]],64127:[[22868]],64128:[[23138]],64129:[[23336]],64130:[[24274]],64131:[[24281]],64132:[[24425]],64133:[[24493]],64134:[[24792]],64135:[[24910]],64136:[[24840]],64137:[[24974]],64138:[[24928]],64139:[[25074]],64140:[[25140]],64141:[[25540]],64142:[[25628]],64143:[[25682]],64144:[[25942]],64145:[[26228]],64146:[[26391]],64147:[[26395]],64148:[[26454]],64149:[[27513]],64150:[[27578]],64151:[[27969]],64152:[[28379]],64153:[[28363]],64154:[[28450]],64155:[[28702]],64156:[[29038]],64157:[[30631]],64158:[[29237]],64159:[[29359]],64160:[[29482]],64161:[[29809]],64162:[[29958]],64163:[[30011]],64164:[[30237]],64165:[[30239]],64166:[[30410]],64167:[[30427]],64168:[[30452]],64169:[[30538]],64170:[[30528]],64171:[[30924]],64172:[[31409]],64173:[[31680]],64174:[[31867]],64175:[[32091]],64176:[[32244]],64177:[[32574]],64178:[[32773]],64179:[[33618]],64180:[[33775]],64181:[[34681]],64182:[[35137]],64183:[[35206]],64184:[[35222]],64185:[[35519]],64186:[[35576]],64187:[[35531]],64188:[[35585]],64189:[[35582]],64190:[[35565]],64191:[[35641]],64192:[[35722]],64193:[[36104]],64194:[[36664]],64195:[[36978]],64196:[[37273]],64197:[[37494]],64198:[[38524]],64199:[[38627]],64200:[[38742]],64201:[[38875]],64202:[[38911]],64203:[[38923]],64204:[[38971]],64205:[[39698]],64206:[[40860]],64207:[[141386]],64208:[[141380]],64209:[[144341]],64210:[[15261]],64211:[[16408]],64212:[[16441]],64213:[[152137]],64214:[[154832]],64215:[[163539]],64216:[[40771]],64217:[[40846]],195072:[[38953]],195073:[[169398]],195074:[[39138]],195075:[[19251]],195076:[[39209]],195077:[[39335]],195078:[[39362]],195079:[[39422]],195080:[[19406]],195081:[[170800]],195082:[[39698]],195083:[[4e4]],195084:[[40189]],195085:[[19662]],195086:[[19693]],195087:[[40295]],195088:[[172238]],195089:[[19704]],195090:[[172293]],195091:[[172558]],195092:[[172689]],195093:[[40635]],195094:[[19798]],195095:[[40697]],195096:[[40702]],195097:[[40709]],195098:[[40719]],195099:[[40726]],195100:[[40763]],195101:[[173568]]},64256:{64256:[[102,102],256],64257:[[102,105],256],64258:[[102,108],256],64259:[[102,102,105],256],64260:[[102,102,108],256],64261:[[383,116],256],64262:[[115,116],256],64275:[[1396,1398],256],64276:[[1396,1381],256],64277:[[1396,1387],256],64278:[[1406,1398],256],64279:[[1396,1389],256],64285:[[1497,1460],512],64286:[,26],64287:[[1522,1463],512],64288:[[1506],256],64289:[[1488],256],64290:[[1491],256],64291:[[1492],256],64292:[[1499],256],64293:[[1500],256],64294:[[1501],256],64295:[[1512],256],64296:[[1514],256],64297:[[43],256],64298:[[1513,1473],512],64299:[[1513,1474],512],64300:[[64329,1473],512],64301:[[64329,1474],512],64302:[[1488,1463],512],64303:[[1488,1464],512],64304:[[1488,1468],512],64305:[[1489,1468],512],64306:[[1490,1468],512],64307:[[1491,1468],512],64308:[[1492,1468],512],64309:[[1493,1468],512],64310:[[1494,1468],512],64312:[[1496,1468],512],64313:[[1497,1468],512],64314:[[1498,1468],512],64315:[[1499,1468],512],64316:[[1500,1468],512],64318:[[1502,1468],512],64320:[[1504,1468],512],64321:[[1505,1468],512],64323:[[1507,1468],512],64324:[[1508,1468],512],64326:[[1510,1468],512],64327:[[1511,1468],512],64328:[[1512,1468],512],64329:[[1513,1468],512],64330:[[1514,1468],512],64331:[[1493,1465],512],64332:[[1489,1471],512],64333:[[1499,1471],512],64334:[[1508,1471],512],64335:[[1488,1500],256],64336:[[1649],256],64337:[[1649],256],64338:[[1659],256],64339:[[1659],256],64340:[[1659],256],64341:[[1659],256],64342:[[1662],256],64343:[[1662],256],64344:[[1662],256],64345:[[1662],256],64346:[[1664],256],64347:[[1664],256],64348:[[1664],256],64349:[[1664],256],64350:[[1658],256],64351:[[1658],256],64352:[[1658],256],64353:[[1658],256],64354:[[1663],256],64355:[[1663],256],64356:[[1663],256],64357:[[1663],256],64358:[[1657],256],64359:[[1657],256],64360:[[1657],256],64361:[[1657],256],64362:[[1700],256],64363:[[1700],256],64364:[[1700],256],64365:[[1700],256],64366:[[1702],256],64367:[[1702],256],64368:[[1702],256],64369:[[1702],256],64370:[[1668],256],64371:[[1668],256],64372:[[1668],256],64373:[[1668],256],64374:[[1667],256],64375:[[1667],256],64376:[[1667],256],64377:[[1667],256],64378:[[1670],256],64379:[[1670],256],64380:[[1670],256],64381:[[1670],256],64382:[[1671],256],64383:[[1671],256],64384:[[1671],256],64385:[[1671],256],64386:[[1677],256],64387:[[1677],256],64388:[[1676],256],64389:[[1676],256],64390:[[1678],256],64391:[[1678],256],64392:[[1672],256],64393:[[1672],256],64394:[[1688],256],64395:[[1688],256],64396:[[1681],256],64397:[[1681],256],64398:[[1705],256],64399:[[1705],256],64400:[[1705],256],64401:[[1705],256],64402:[[1711],256],64403:[[1711],256],64404:[[1711],256],64405:[[1711],256],64406:[[1715],256],64407:[[1715],256],64408:[[1715],256],64409:[[1715],256],64410:[[1713],256],64411:[[1713],256],64412:[[1713],256],64413:[[1713],256],64414:[[1722],256],64415:[[1722],256],64416:[[1723],256],64417:[[1723],256],64418:[[1723],256],64419:[[1723],256],64420:[[1728],256],64421:[[1728],256],64422:[[1729],256],64423:[[1729],256],64424:[[1729],256],64425:[[1729],256],64426:[[1726],256],64427:[[1726],256],64428:[[1726],256],64429:[[1726],256],64430:[[1746],256],64431:[[1746],256],64432:[[1747],256],64433:[[1747],256],64467:[[1709],256],64468:[[1709],256],64469:[[1709],256],64470:[[1709],256],64471:[[1735],256],64472:[[1735],256],64473:[[1734],256],64474:[[1734],256],64475:[[1736],256],64476:[[1736],256],64477:[[1655],256],64478:[[1739],256],64479:[[1739],256],64480:[[1733],256],64481:[[1733],256],64482:[[1737],256],64483:[[1737],256],64484:[[1744],256],64485:[[1744],256],64486:[[1744],256],64487:[[1744],256],64488:[[1609],256],64489:[[1609],256],64490:[[1574,1575],256],64491:[[1574,1575],256],64492:[[1574,1749],256],64493:[[1574,1749],256],64494:[[1574,1608],256],64495:[[1574,1608],256],64496:[[1574,1735],256],64497:[[1574,1735],256],64498:[[1574,1734],256],64499:[[1574,1734],256],64500:[[1574,1736],256],64501:[[1574,1736],256],64502:[[1574,1744],256],64503:[[1574,1744],256],64504:[[1574,1744],256],64505:[[1574,1609],256],64506:[[1574,1609],256],64507:[[1574,1609],256],64508:[[1740],256],64509:[[1740],256],64510:[[1740],256],64511:[[1740],256]},64512:{64512:[[1574,1580],256],64513:[[1574,1581],256],64514:[[1574,1605],256],64515:[[1574,1609],256],64516:[[1574,1610],256],64517:[[1576,1580],256],64518:[[1576,1581],256],64519:[[1576,1582],256],64520:[[1576,1605],256],64521:[[1576,1609],256],64522:[[1576,1610],256],64523:[[1578,1580],256],64524:[[1578,1581],256],64525:[[1578,1582],256],64526:[[1578,1605],256],64527:[[1578,1609],256],64528:[[1578,1610],256],64529:[[1579,1580],256],64530:[[1579,1605],256],64531:[[1579,1609],256],64532:[[1579,1610],256],64533:[[1580,1581],256],64534:[[1580,1605],256],64535:[[1581,1580],256],64536:[[1581,1605],256],64537:[[1582,1580],256],64538:[[1582,1581],256],64539:[[1582,1605],256],64540:[[1587,1580],256],64541:[[1587,1581],256],64542:[[1587,1582],256],64543:[[1587,1605],256],64544:[[1589,1581],256],64545:[[1589,1605],256],64546:[[1590,1580],256],64547:[[1590,1581],256],64548:[[1590,1582],256],64549:[[1590,1605],256],64550:[[1591,1581],256],64551:[[1591,1605],256],64552:[[1592,1605],256],64553:[[1593,1580],256],64554:[[1593,1605],256],64555:[[1594,1580],256],64556:[[1594,1605],256],64557:[[1601,1580],256],64558:[[1601,1581],256],64559:[[1601,1582],256],64560:[[1601,1605],256],64561:[[1601,1609],256],64562:[[1601,1610],256],64563:[[1602,1581],256],64564:[[1602,1605],256],64565:[[1602,1609],256],64566:[[1602,1610],256],64567:[[1603,1575],256],64568:[[1603,1580],256],64569:[[1603,1581],256],64570:[[1603,1582],256],64571:[[1603,1604],256],64572:[[1603,1605],256],64573:[[1603,1609],256],64574:[[1603,1610],256],64575:[[1604,1580],256],64576:[[1604,1581],256],64577:[[1604,1582],256],64578:[[1604,1605],256],64579:[[1604,1609],256],64580:[[1604,1610],256],64581:[[1605,1580],256],64582:[[1605,1581],256],64583:[[1605,1582],256],64584:[[1605,1605],256],64585:[[1605,1609],256],64586:[[1605,1610],256],64587:[[1606,1580],256],64588:[[1606,1581],256],64589:[[1606,1582],256],64590:[[1606,1605],256],64591:[[1606,1609],256],64592:[[1606,1610],256],64593:[[1607,1580],256],64594:[[1607,1605],256],64595:[[1607,1609],256],64596:[[1607,1610],256],64597:[[1610,1580],256],64598:[[1610,1581],256],64599:[[1610,1582],256],64600:[[1610,1605],256],64601:[[1610,1609],256],64602:[[1610,1610],256],64603:[[1584,1648],256],64604:[[1585,1648],256],64605:[[1609,1648],256],64606:[[32,1612,1617],256],64607:[[32,1613,1617],256],64608:[[32,1614,1617],256],64609:[[32,1615,1617],256],64610:[[32,1616,1617],256],64611:[[32,1617,1648],256],64612:[[1574,1585],256],64613:[[1574,1586],256],64614:[[1574,1605],256],64615:[[1574,1606],256],64616:[[1574,1609],256],64617:[[1574,1610],256],64618:[[1576,1585],256],64619:[[1576,1586],256],64620:[[1576,1605],256],64621:[[1576,1606],256],64622:[[1576,1609],256],64623:[[1576,1610],256],64624:[[1578,1585],256],64625:[[1578,1586],256],64626:[[1578,1605],256],64627:[[1578,1606],256],64628:[[1578,1609],256],64629:[[1578,1610],256],64630:[[1579,1585],256],64631:[[1579,1586],256],64632:[[1579,1605],256],64633:[[1579,1606],256],64634:[[1579,1609],256],64635:[[1579,1610],256],64636:[[1601,1609],256],64637:[[1601,1610],256],64638:[[1602,1609],256],64639:[[1602,1610],256],64640:[[1603,1575],256],64641:[[1603,1604],256],64642:[[1603,1605],256],64643:[[1603,1609],256],64644:[[1603,1610],256],64645:[[1604,1605],256],64646:[[1604,1609],256],64647:[[1604,1610],256],64648:[[1605,1575],256],64649:[[1605,1605],256],64650:[[1606,1585],256],64651:[[1606,1586],256],64652:[[1606,1605],256],64653:[[1606,1606],256],64654:[[1606,1609],256],64655:[[1606,1610],256],64656:[[1609,1648],256],64657:[[1610,1585],256],64658:[[1610,1586],256],64659:[[1610,1605],256],64660:[[1610,1606],256],64661:[[1610,1609],256],64662:[[1610,1610],256],64663:[[1574,1580],256],64664:[[1574,1581],256],64665:[[1574,1582],256],64666:[[1574,1605],256],64667:[[1574,1607],256],64668:[[1576,1580],256],64669:[[1576,1581],256],64670:[[1576,1582],256],64671:[[1576,1605],256],64672:[[1576,1607],256],64673:[[1578,1580],256],
64674:[[1578,1581],256],64675:[[1578,1582],256],64676:[[1578,1605],256],64677:[[1578,1607],256],64678:[[1579,1605],256],64679:[[1580,1581],256],64680:[[1580,1605],256],64681:[[1581,1580],256],64682:[[1581,1605],256],64683:[[1582,1580],256],64684:[[1582,1605],256],64685:[[1587,1580],256],64686:[[1587,1581],256],64687:[[1587,1582],256],64688:[[1587,1605],256],64689:[[1589,1581],256],64690:[[1589,1582],256],64691:[[1589,1605],256],64692:[[1590,1580],256],64693:[[1590,1581],256],64694:[[1590,1582],256],64695:[[1590,1605],256],64696:[[1591,1581],256],64697:[[1592,1605],256],64698:[[1593,1580],256],64699:[[1593,1605],256],64700:[[1594,1580],256],64701:[[1594,1605],256],64702:[[1601,1580],256],64703:[[1601,1581],256],64704:[[1601,1582],256],64705:[[1601,1605],256],64706:[[1602,1581],256],64707:[[1602,1605],256],64708:[[1603,1580],256],64709:[[1603,1581],256],64710:[[1603,1582],256],64711:[[1603,1604],256],64712:[[1603,1605],256],64713:[[1604,1580],256],64714:[[1604,1581],256],64715:[[1604,1582],256],64716:[[1604,1605],256],64717:[[1604,1607],256],64718:[[1605,1580],256],64719:[[1605,1581],256],64720:[[1605,1582],256],64721:[[1605,1605],256],64722:[[1606,1580],256],64723:[[1606,1581],256],64724:[[1606,1582],256],64725:[[1606,1605],256],64726:[[1606,1607],256],64727:[[1607,1580],256],64728:[[1607,1605],256],64729:[[1607,1648],256],64730:[[1610,1580],256],64731:[[1610,1581],256],64732:[[1610,1582],256],64733:[[1610,1605],256],64734:[[1610,1607],256],64735:[[1574,1605],256],64736:[[1574,1607],256],64737:[[1576,1605],256],64738:[[1576,1607],256],64739:[[1578,1605],256],64740:[[1578,1607],256],64741:[[1579,1605],256],64742:[[1579,1607],256],64743:[[1587,1605],256],64744:[[1587,1607],256],64745:[[1588,1605],256],64746:[[1588,1607],256],64747:[[1603,1604],256],64748:[[1603,1605],256],64749:[[1604,1605],256],64750:[[1606,1605],256],64751:[[1606,1607],256],64752:[[1610,1605],256],64753:[[1610,1607],256],64754:[[1600,1614,1617],256],64755:[[1600,1615,1617],256],64756:[[1600,1616,1617],256],64757:[[1591,1609],256],64758:[[1591,1610],256],64759:[[1593,1609],256],64760:[[1593,1610],256],64761:[[1594,1609],256],64762:[[1594,1610],256],64763:[[1587,1609],256],64764:[[1587,1610],256],64765:[[1588,1609],256],64766:[[1588,1610],256],64767:[[1581,1609],256]},64768:{64768:[[1581,1610],256],64769:[[1580,1609],256],64770:[[1580,1610],256],64771:[[1582,1609],256],64772:[[1582,1610],256],64773:[[1589,1609],256],64774:[[1589,1610],256],64775:[[1590,1609],256],64776:[[1590,1610],256],64777:[[1588,1580],256],64778:[[1588,1581],256],64779:[[1588,1582],256],64780:[[1588,1605],256],64781:[[1588,1585],256],64782:[[1587,1585],256],64783:[[1589,1585],256],64784:[[1590,1585],256],64785:[[1591,1609],256],64786:[[1591,1610],256],64787:[[1593,1609],256],64788:[[1593,1610],256],64789:[[1594,1609],256],64790:[[1594,1610],256],64791:[[1587,1609],256],64792:[[1587,1610],256],64793:[[1588,1609],256],64794:[[1588,1610],256],64795:[[1581,1609],256],64796:[[1581,1610],256],64797:[[1580,1609],256],64798:[[1580,1610],256],64799:[[1582,1609],256],64800:[[1582,1610],256],64801:[[1589,1609],256],64802:[[1589,1610],256],64803:[[1590,1609],256],64804:[[1590,1610],256],64805:[[1588,1580],256],64806:[[1588,1581],256],64807:[[1588,1582],256],64808:[[1588,1605],256],64809:[[1588,1585],256],64810:[[1587,1585],256],64811:[[1589,1585],256],64812:[[1590,1585],256],64813:[[1588,1580],256],64814:[[1588,1581],256],64815:[[1588,1582],256],64816:[[1588,1605],256],64817:[[1587,1607],256],64818:[[1588,1607],256],64819:[[1591,1605],256],64820:[[1587,1580],256],64821:[[1587,1581],256],64822:[[1587,1582],256],64823:[[1588,1580],256],64824:[[1588,1581],256],64825:[[1588,1582],256],64826:[[1591,1605],256],64827:[[1592,1605],256],64828:[[1575,1611],256],64829:[[1575,1611],256],64848:[[1578,1580,1605],256],64849:[[1578,1581,1580],256],64850:[[1578,1581,1580],256],64851:[[1578,1581,1605],256],64852:[[1578,1582,1605],256],64853:[[1578,1605,1580],256],64854:[[1578,1605,1581],256],64855:[[1578,1605,1582],256],64856:[[1580,1605,1581],256],64857:[[1580,1605,1581],256],64858:[[1581,1605,1610],256],64859:[[1581,1605,1609],256],64860:[[1587,1581,1580],256],64861:[[1587,1580,1581],256],64862:[[1587,1580,1609],256],64863:[[1587,1605,1581],256],64864:[[1587,1605,1581],256],64865:[[1587,1605,1580],256],64866:[[1587,1605,1605],256],64867:[[1587,1605,1605],256],64868:[[1589,1581,1581],256],64869:[[1589,1581,1581],256],64870:[[1589,1605,1605],256],64871:[[1588,1581,1605],256],64872:[[1588,1581,1605],256],64873:[[1588,1580,1610],256],64874:[[1588,1605,1582],256],64875:[[1588,1605,1582],256],64876:[[1588,1605,1605],256],64877:[[1588,1605,1605],256],64878:[[1590,1581,1609],256],64879:[[1590,1582,1605],256],64880:[[1590,1582,1605],256],64881:[[1591,1605,1581],256],64882:[[1591,1605,1581],256],64883:[[1591,1605,1605],256],64884:[[1591,1605,1610],256],64885:[[1593,1580,1605],256],64886:[[1593,1605,1605],256],64887:[[1593,1605,1605],256],64888:[[1593,1605,1609],256],64889:[[1594,1605,1605],256],64890:[[1594,1605,1610],256],64891:[[1594,1605,1609],256],64892:[[1601,1582,1605],256],64893:[[1601,1582,1605],256],64894:[[1602,1605,1581],256],64895:[[1602,1605,1605],256],64896:[[1604,1581,1605],256],64897:[[1604,1581,1610],256],64898:[[1604,1581,1609],256],64899:[[1604,1580,1580],256],64900:[[1604,1580,1580],256],64901:[[1604,1582,1605],256],64902:[[1604,1582,1605],256],64903:[[1604,1605,1581],256],64904:[[1604,1605,1581],256],64905:[[1605,1581,1580],256],64906:[[1605,1581,1605],256],64907:[[1605,1581,1610],256],64908:[[1605,1580,1581],256],64909:[[1605,1580,1605],256],64910:[[1605,1582,1580],256],64911:[[1605,1582,1605],256],64914:[[1605,1580,1582],256],64915:[[1607,1605,1580],256],64916:[[1607,1605,1605],256],64917:[[1606,1581,1605],256],64918:[[1606,1581,1609],256],64919:[[1606,1580,1605],256],64920:[[1606,1580,1605],256],64921:[[1606,1580,1609],256],64922:[[1606,1605,1610],256],64923:[[1606,1605,1609],256],64924:[[1610,1605,1605],256],64925:[[1610,1605,1605],256],64926:[[1576,1582,1610],256],64927:[[1578,1580,1610],256],64928:[[1578,1580,1609],256],64929:[[1578,1582,1610],256],64930:[[1578,1582,1609],256],64931:[[1578,1605,1610],256],64932:[[1578,1605,1609],256],64933:[[1580,1605,1610],256],64934:[[1580,1581,1609],256],64935:[[1580,1605,1609],256],64936:[[1587,1582,1609],256],64937:[[1589,1581,1610],256],64938:[[1588,1581,1610],256],64939:[[1590,1581,1610],256],64940:[[1604,1580,1610],256],64941:[[1604,1605,1610],256],64942:[[1610,1581,1610],256],64943:[[1610,1580,1610],256],64944:[[1610,1605,1610],256],64945:[[1605,1605,1610],256],64946:[[1602,1605,1610],256],64947:[[1606,1581,1610],256],64948:[[1602,1605,1581],256],64949:[[1604,1581,1605],256],64950:[[1593,1605,1610],256],64951:[[1603,1605,1610],256],64952:[[1606,1580,1581],256],64953:[[1605,1582,1610],256],64954:[[1604,1580,1605],256],64955:[[1603,1605,1605],256],64956:[[1604,1580,1605],256],64957:[[1606,1580,1581],256],64958:[[1580,1581,1610],256],64959:[[1581,1580,1610],256],64960:[[1605,1580,1610],256],64961:[[1601,1605,1610],256],64962:[[1576,1581,1610],256],64963:[[1603,1605,1605],256],64964:[[1593,1580,1605],256],64965:[[1589,1605,1605],256],64966:[[1587,1582,1610],256],64967:[[1606,1580,1610],256],65008:[[1589,1604,1746],256],65009:[[1602,1604,1746],256],65010:[[1575,1604,1604,1607],256],65011:[[1575,1603,1576,1585],256],65012:[[1605,1581,1605,1583],256],65013:[[1589,1604,1593,1605],256],65014:[[1585,1587,1608,1604],256],65015:[[1593,1604,1610,1607],256],65016:[[1608,1587,1604,1605],256],65017:[[1589,1604,1609],256],65018:[[1589,1604,1609,32,1575,1604,1604,1607,32,1593,1604,1610,1607,32,1608,1587,1604,1605],256],65019:[[1580,1604,32,1580,1604,1575,1604,1607],256],65020:[[1585,1740,1575,1604],256]},65024:{65040:[[44],256],65041:[[12289],256],65042:[[12290],256],65043:[[58],256],65044:[[59],256],65045:[[33],256],65046:[[63],256],65047:[[12310],256],65048:[[12311],256],65049:[[8230],256],65056:[,230],65057:[,230],65058:[,230],65059:[,230],65060:[,230],65061:[,230],65062:[,230],65063:[,220],65064:[,220],65065:[,220],65066:[,220],65067:[,220],65068:[,220],65069:[,220],65072:[[8229],256],65073:[[8212],256],65074:[[8211],256],65075:[[95],256],65076:[[95],256],65077:[[40],256],65078:[[41],256],65079:[[123],256],65080:[[125],256],65081:[[12308],256],65082:[[12309],256],65083:[[12304],256],65084:[[12305],256],65085:[[12298],256],65086:[[12299],256],65087:[[12296],256],65088:[[12297],256],65089:[[12300],256],65090:[[12301],256],65091:[[12302],256],65092:[[12303],256],65095:[[91],256],65096:[[93],256],65097:[[8254],256],65098:[[8254],256],65099:[[8254],256],65100:[[8254],256],65101:[[95],256],65102:[[95],256],65103:[[95],256],65104:[[44],256],65105:[[12289],256],65106:[[46],256],65108:[[59],256],65109:[[58],256],65110:[[63],256],65111:[[33],256],65112:[[8212],256],65113:[[40],256],65114:[[41],256],65115:[[123],256],65116:[[125],256],65117:[[12308],256],65118:[[12309],256],65119:[[35],256],65120:[[38],256],65121:[[42],256],65122:[[43],256],65123:[[45],256],65124:[[60],256],65125:[[62],256],65126:[[61],256],65128:[[92],256],65129:[[36],256],65130:[[37],256],65131:[[64],256],65136:[[32,1611],256],65137:[[1600,1611],256],65138:[[32,1612],256],65140:[[32,1613],256],65142:[[32,1614],256],65143:[[1600,1614],256],65144:[[32,1615],256],65145:[[1600,1615],256],65146:[[32,1616],256],65147:[[1600,1616],256],65148:[[32,1617],256],65149:[[1600,1617],256],65150:[[32,1618],256],65151:[[1600,1618],256],65152:[[1569],256],65153:[[1570],256],65154:[[1570],256],65155:[[1571],256],65156:[[1571],256],65157:[[1572],256],65158:[[1572],256],65159:[[1573],256],65160:[[1573],256],65161:[[1574],256],65162:[[1574],256],65163:[[1574],256],65164:[[1574],256],65165:[[1575],256],65166:[[1575],256],65167:[[1576],256],65168:[[1576],256],65169:[[1576],256],65170:[[1576],256],65171:[[1577],256],65172:[[1577],256],65173:[[1578],256],65174:[[1578],256],65175:[[1578],256],65176:[[1578],256],65177:[[1579],256],65178:[[1579],256],65179:[[1579],256],65180:[[1579],256],65181:[[1580],256],65182:[[1580],256],65183:[[1580],256],65184:[[1580],256],65185:[[1581],256],65186:[[1581],256],65187:[[1581],256],65188:[[1581],256],65189:[[1582],256],65190:[[1582],256],65191:[[1582],256],65192:[[1582],256],65193:[[1583],256],65194:[[1583],256],65195:[[1584],256],65196:[[1584],256],65197:[[1585],256],65198:[[1585],256],65199:[[1586],256],65200:[[1586],256],65201:[[1587],256],65202:[[1587],256],65203:[[1587],256],65204:[[1587],256],65205:[[1588],256],65206:[[1588],256],65207:[[1588],256],65208:[[1588],256],65209:[[1589],256],65210:[[1589],256],65211:[[1589],256],65212:[[1589],256],65213:[[1590],256],65214:[[1590],256],65215:[[1590],256],65216:[[1590],256],65217:[[1591],256],65218:[[1591],256],65219:[[1591],256],65220:[[1591],256],65221:[[1592],256],65222:[[1592],256],65223:[[1592],256],65224:[[1592],256],65225:[[1593],256],65226:[[1593],256],65227:[[1593],256],65228:[[1593],256],65229:[[1594],256],65230:[[1594],256],65231:[[1594],256],65232:[[1594],256],65233:[[1601],256],65234:[[1601],256],65235:[[1601],256],65236:[[1601],256],65237:[[1602],256],65238:[[1602],256],65239:[[1602],256],65240:[[1602],256],65241:[[1603],256],65242:[[1603],256],65243:[[1603],256],65244:[[1603],256],65245:[[1604],256],65246:[[1604],256],65247:[[1604],256],65248:[[1604],256],65249:[[1605],256],65250:[[1605],256],65251:[[1605],256],65252:[[1605],256],65253:[[1606],256],65254:[[1606],256],65255:[[1606],256],65256:[[1606],256],65257:[[1607],256],65258:[[1607],256],65259:[[1607],256],65260:[[1607],256],65261:[[1608],256],65262:[[1608],256],65263:[[1609],256],65264:[[1609],256],65265:[[1610],256],65266:[[1610],256],65267:[[1610],256],65268:[[1610],256],65269:[[1604,1570],256],65270:[[1604,1570],256],65271:[[1604,1571],256],65272:[[1604,1571],256],65273:[[1604,1573],256],65274:[[1604,1573],256],65275:[[1604,1575],256],65276:[[1604,1575],256]},65280:{65281:[[33],256],65282:[[34],256],65283:[[35],256],65284:[[36],256],65285:[[37],256],65286:[[38],256],65287:[[39],256],65288:[[40],256],65289:[[41],256],65290:[[42],256],65291:[[43],256],65292:[[44],256],65293:[[45],256],65294:[[46],256],65295:[[47],256],65296:[[48],256],65297:[[49],256],65298:[[50],256],65299:[[51],256],65300:[[52],256],65301:[[53],256],65302:[[54],256],65303:[[55],256],65304:[[56],256],65305:[[57],256],65306:[[58],256],65307:[[59],256],65308:[[60],256],65309:[[61],256],65310:[[62],256],65311:[[63],256],65312:[[64],256],65313:[[65],256],65314:[[66],256],65315:[[67],256],65316:[[68],256],65317:[[69],256],65318:[[70],256],65319:[[71],256],65320:[[72],256],65321:[[73],256],65322:[[74],256],65323:[[75],256],65324:[[76],256],65325:[[77],256],65326:[[78],256],65327:[[79],256],65328:[[80],256],65329:[[81],256],65330:[[82],256],65331:[[83],256],65332:[[84],256],65333:[[85],256],65334:[[86],256],65335:[[87],256],65336:[[88],256],65337:[[89],256],65338:[[90],256],65339:[[91],256],65340:[[92],256],65341:[[93],256],65342:[[94],256],65343:[[95],256],65344:[[96],256],65345:[[97],256],65346:[[98],256],65347:[[99],256],65348:[[100],256],65349:[[101],256],65350:[[102],256],65351:[[103],256],65352:[[104],256],65353:[[105],256],65354:[[106],256],65355:[[107],256],65356:[[108],256],65357:[[109],256],65358:[[110],256],65359:[[111],256],65360:[[112],256],65361:[[113],256],65362:[[114],256],65363:[[115],256],65364:[[116],256],65365:[[117],256],65366:[[118],256],65367:[[119],256],65368:[[120],256],65369:[[121],256],65370:[[122],256],65371:[[123],256],65372:[[124],256],65373:[[125],256],65374:[[126],256],65375:[[10629],256],65376:[[10630],256],65377:[[12290],256],65378:[[12300],256],65379:[[12301],256],65380:[[12289],256],65381:[[12539],256],65382:[[12530],256],65383:[[12449],256],65384:[[12451],256],65385:[[12453],256],65386:[[12455],256],65387:[[12457],256],65388:[[12515],256],65389:[[12517],256],65390:[[12519],256],65391:[[12483],256],65392:[[12540],256],65393:[[12450],256],65394:[[12452],256],65395:[[12454],256],65396:[[12456],256],65397:[[12458],256],65398:[[12459],256],65399:[[12461],256],65400:[[12463],256],65401:[[12465],256],65402:[[12467],256],65403:[[12469],256],65404:[[12471],256],65405:[[12473],256],65406:[[12475],256],65407:[[12477],256],65408:[[12479],256],65409:[[12481],256],65410:[[12484],256],65411:[[12486],256],65412:[[12488],256],65413:[[12490],256],65414:[[12491],256],65415:[[12492],256],65416:[[12493],256],65417:[[12494],256],65418:[[12495],256],65419:[[12498],256],65420:[[12501],256],65421:[[12504],256],65422:[[12507],256],65423:[[12510],256],65424:[[12511],256],65425:[[12512],256],65426:[[12513],256],65427:[[12514],256],65428:[[12516],256],65429:[[12518],256],65430:[[12520],256],65431:[[12521],256],65432:[[12522],256],65433:[[12523],256],65434:[[12524],256],65435:[[12525],256],65436:[[12527],256],65437:[[12531],256],65438:[[12441],256],65439:[[12442],256],65440:[[12644],256],65441:[[12593],256],65442:[[12594],256],65443:[[12595],256],65444:[[12596],256],65445:[[12597],256],65446:[[12598],256],65447:[[12599],256],65448:[[12600],256],65449:[[12601],256],65450:[[12602],256],65451:[[12603],256],65452:[[12604],256],65453:[[12605],256],65454:[[12606],256],65455:[[12607],256],65456:[[12608],256],65457:[[12609],256],65458:[[12610],256],65459:[[12611],256],65460:[[12612],256],65461:[[12613],256],65462:[[12614],256],65463:[[12615],256],65464:[[12616],256],65465:[[12617],256],65466:[[12618],256],65467:[[12619],256],65468:[[12620],256],65469:[[12621],256],65470:[[12622],256],65474:[[12623],256],65475:[[12624],256],65476:[[12625],256],65477:[[12626],256],65478:[[12627],256],65479:[[12628],256],65482:[[12629],256],65483:[[12630],256],65484:[[12631],256],65485:[[12632],256],65486:[[12633],256],65487:[[12634],256],65490:[[12635],256],65491:[[12636],256],65492:[[12637],256],65493:[[12638],256],65494:[[12639],256],65495:[[12640],256],65498:[[12641],256],65499:[[12642],256],65500:[[12643],256],65504:[[162],256],65505:[[163],256],65506:[[172],256],65507:[[175],256],65508:[[166],256],65509:[[165],256],65510:[[8361],256],65512:[[9474],256],65513:[[8592],256],65514:[[8593],256],65515:[[8594],256],65516:[[8595],256],65517:[[9632],256],65518:[[9675],256]}};var unorm={nfc:nfc,nfd:nfd,nfkc:nfkc,nfkd:nfkd};"object"==typeof module?module.exports=unorm:"function"==typeof define&&define.amd?define("unorm",function(){return unorm}):root.unorm=unorm,unorm.shimApplied=!1,String.prototype.normalize||(String.prototype.normalize=function(form){var str=""+this;if(form=void 0===form?"NFC":form,"NFC"===form)return unorm.nfc(str);if("NFD"===form)return unorm.nfd(str);if("NFKC"===form)return unorm.nfkc(str);if("NFKD"===form)return unorm.nfkd(str);throw new RangeError("Invalid normalization form: "+form)},unorm.shimApplied=!0)}(this)},{}],413:[function(require,module,exports){"use strict";function Url(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}function urlParse(url,parseQueryString,slashesDenoteHost){if(url&&util.isObject(url)&&url instanceof Url)return url;var u=new Url;return u.parse(url,parseQueryString,slashesDenoteHost),u}function urlFormat(obj){return util.isString(obj)&&(obj=urlParse(obj)),obj instanceof Url?obj.format():Url.prototype.format.call(obj)}function urlResolve(source,relative){return urlParse(source,!1,!0).resolve(relative)}function urlResolveObject(source,relative){return source?urlParse(source,!1,!0).resolveObject(relative):relative}var punycode=require("punycode"),util=require("./util");exports.parse=urlParse,exports.resolve=urlResolve,exports.resolveObject=urlResolveObject,exports.format=urlFormat,exports.Url=Url;var protocolPattern=/^([a-z0-9.+-]+:)/i,portPattern=/:[0-9]*$/,simplePathPattern=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,delims=["<",">",'"',"`"," ","\r","\n","\t"],unwise=["{","}","|","\\","^","`"].concat(delims),autoEscape=["'"].concat(unwise),nonHostChars=["%","/","?",";","#"].concat(autoEscape),hostEndingChars=["/","?","#"],hostnameMaxLen=255,hostnamePartPattern=/^[+a-z0-9A-Z_-]{0,63}$/,hostnamePartStart=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,unsafeProtocol={javascript:!0,"javascript:":!0},hostlessProtocol={javascript:!0,"javascript:":!0},slashedProtocol={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},querystring=require("querystring");Url.prototype.parse=function(url,parseQueryString,slashesDenoteHost){if(!util.isString(url))throw new TypeError("Parameter 'url' must be a string, not "+typeof url);var queryIndex=url.indexOf("?"),splitter=queryIndex!==-1&&queryIndex<url.indexOf("#")?"?":"#",uSplit=url.split(splitter),slashRegex=/\\/g;uSplit[0]=uSplit[0].replace(slashRegex,"/"),url=uSplit.join(splitter);var rest=url;if(rest=rest.trim(),!slashesDenoteHost&&1===url.split("#").length){var simplePath=simplePathPattern.exec(rest);if(simplePath)return this.path=rest,this.href=rest,this.pathname=simplePath[1],simplePath[2]?(this.search=simplePath[2],parseQueryString?this.query=querystring.parse(this.search.substr(1)):this.query=this.search.substr(1)):parseQueryString&&(this.search="",this.query={}),this}var proto=protocolPattern.exec(rest);if(proto){proto=proto[0];var lowerProto=proto.toLowerCase();this.protocol=lowerProto,rest=rest.substr(proto.length)}if(slashesDenoteHost||proto||rest.match(/^\/\/[^@\/]+@[^@\/]+/)){var slashes="//"===rest.substr(0,2);!slashes||proto&&hostlessProtocol[proto]||(rest=rest.substr(2),this.slashes=!0)}if(!hostlessProtocol[proto]&&(slashes||proto&&!slashedProtocol[proto])){for(var hostEnd=-1,i=0;i<hostEndingChars.length;i++){var hec=rest.indexOf(hostEndingChars[i]);hec!==-1&&(hostEnd===-1||hec<hostEnd)&&(hostEnd=hec)}var auth,atSign;atSign=hostEnd===-1?rest.lastIndexOf("@"):rest.lastIndexOf("@",hostEnd),atSign!==-1&&(auth=rest.slice(0,atSign),rest=rest.slice(atSign+1),this.auth=decodeURIComponent(auth)),hostEnd=-1;for(var i=0;i<nonHostChars.length;i++){var hec=rest.indexOf(nonHostChars[i]);hec!==-1&&(hostEnd===-1||hec<hostEnd)&&(hostEnd=hec)}hostEnd===-1&&(hostEnd=rest.length),this.host=rest.slice(0,hostEnd),rest=rest.slice(hostEnd),this.parseHost(),this.hostname=this.hostname||"";var ipv6Hostname="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!ipv6Hostname)for(var hostparts=this.hostname.split(/\./),i=0,l=hostparts.length;i<l;i++){var part=hostparts[i];if(part&&!part.match(hostnamePartPattern)){for(var newpart="",j=0,k=part.length;j<k;j++)newpart+=part.charCodeAt(j)>127?"x":part[j];if(!newpart.match(hostnamePartPattern)){var validParts=hostparts.slice(0,i),notHost=hostparts.slice(i+1),bit=part.match(hostnamePartStart);bit&&(validParts.push(bit[1]),notHost.unshift(bit[2])),notHost.length&&(rest="/"+notHost.join(".")+rest),this.hostname=validParts.join(".");break}}}this.hostname.length>hostnameMaxLen?this.hostname="":this.hostname=this.hostname.toLowerCase(),ipv6Hostname||(this.hostname=punycode.toASCII(this.hostname));var p=this.port?":"+this.port:"",h=this.hostname||"";this.host=h+p,this.href+=this.host,ipv6Hostname&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==rest[0]&&(rest="/"+rest))}if(!unsafeProtocol[lowerProto])for(var i=0,l=autoEscape.length;i<l;i++){var ae=autoEscape[i];if(rest.indexOf(ae)!==-1){var esc=encodeURIComponent(ae);esc===ae&&(esc=escape(ae)),rest=rest.split(ae).join(esc)}}var hash=rest.indexOf("#");hash!==-1&&(this.hash=rest.substr(hash),rest=rest.slice(0,hash));var qm=rest.indexOf("?");if(qm!==-1?(this.search=rest.substr(qm),this.query=rest.substr(qm+1),parseQueryString&&(this.query=querystring.parse(this.query)),rest=rest.slice(0,qm)):parseQueryString&&(this.search="",this.query={}),rest&&(this.pathname=rest),slashedProtocol[lowerProto]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){var p=this.pathname||"",s=this.search||"";this.path=p+s}return this.href=this.format(),this},Url.prototype.format=function(){var auth=this.auth||"";auth&&(auth=encodeURIComponent(auth),auth=auth.replace(/%3A/i,":"),auth+="@");var protocol=this.protocol||"",pathname=this.pathname||"",hash=this.hash||"",host=!1,query="";this.host?host=auth+this.host:this.hostname&&(host=auth+(this.hostname.indexOf(":")===-1?this.hostname:"["+this.hostname+"]"),this.port&&(host+=":"+this.port)),this.query&&util.isObject(this.query)&&Object.keys(this.query).length&&(query=querystring.stringify(this.query));var search=this.search||query&&"?"+query||"";return protocol&&":"!==protocol.substr(-1)&&(protocol+=":"),this.slashes||(!protocol||slashedProtocol[protocol])&&host!==!1?(host="//"+(host||""),pathname&&"/"!==pathname.charAt(0)&&(pathname="/"+pathname)):host||(host=""),hash&&"#"!==hash.charAt(0)&&(hash="#"+hash),search&&"?"!==search.charAt(0)&&(search="?"+search),pathname=pathname.replace(/[?#]/g,function(match){return encodeURIComponent(match)}),search=search.replace("#","%23"),protocol+host+pathname+search+hash},Url.prototype.resolve=function(relative){return this.resolveObject(urlParse(relative,!1,!0)).format()},Url.prototype.resolveObject=function(relative){if(util.isString(relative)){var rel=new Url;rel.parse(relative,!1,!0),relative=rel}for(var result=new Url,tkeys=Object.keys(this),tk=0;tk<tkeys.length;tk++){var tkey=tkeys[tk];result[tkey]=this[tkey]}if(result.hash=relative.hash,""===relative.href)return result.href=result.format(),result;if(relative.slashes&&!relative.protocol){for(var rkeys=Object.keys(relative),rk=0;rk<rkeys.length;rk++){var rkey=rkeys[rk];"protocol"!==rkey&&(result[rkey]=relative[rkey])}return slashedProtocol[result.protocol]&&result.hostname&&!result.pathname&&(result.path=result.pathname="/"),result.href=result.format(),result}if(relative.protocol&&relative.protocol!==result.protocol){if(!slashedProtocol[relative.protocol]){for(var keys=Object.keys(relative),v=0;v<keys.length;v++){var k=keys[v];result[k]=relative[k]}return result.href=result.format(),result}if(result.protocol=relative.protocol,relative.host||hostlessProtocol[relative.protocol])result.pathname=relative.pathname;else{for(var relPath=(relative.pathname||"").split("/");relPath.length&&!(relative.host=relPath.shift()););relative.host||(relative.host=""),relative.hostname||(relative.hostname=""),""!==relPath[0]&&relPath.unshift(""),relPath.length<2&&relPath.unshift(""),result.pathname=relPath.join("/")}if(result.search=relative.search,result.query=relative.query,result.host=relative.host||"",result.auth=relative.auth,result.hostname=relative.hostname||relative.host,result.port=relative.port,result.pathname||result.search){var p=result.pathname||"",s=result.search||"";result.path=p+s}return result.slashes=result.slashes||relative.slashes,result.href=result.format(),result}var isSourceAbs=result.pathname&&"/"===result.pathname.charAt(0),isRelAbs=relative.host||relative.pathname&&"/"===relative.pathname.charAt(0),mustEndAbs=isRelAbs||isSourceAbs||result.host&&relative.pathname,removeAllDots=mustEndAbs,srcPath=result.pathname&&result.pathname.split("/")||[],relPath=relative.pathname&&relative.pathname.split("/")||[],psychotic=result.protocol&&!slashedProtocol[result.protocol];if(psychotic&&(result.hostname="",result.port=null,result.host&&(""===srcPath[0]?srcPath[0]=result.host:srcPath.unshift(result.host)),result.host="",relative.protocol&&(relative.hostname=null,relative.port=null,relative.host&&(""===relPath[0]?relPath[0]=relative.host:relPath.unshift(relative.host)),relative.host=null),mustEndAbs=mustEndAbs&&(""===relPath[0]||""===srcPath[0])),isRelAbs)result.host=relative.host||""===relative.host?relative.host:result.host,result.hostname=relative.hostname||""===relative.hostname?relative.hostname:result.hostname,result.search=relative.search,result.query=relative.query,srcPath=relPath;else if(relPath.length)srcPath||(srcPath=[]),srcPath.pop(),srcPath=srcPath.concat(relPath),result.search=relative.search,result.query=relative.query;else if(!util.isNullOrUndefined(relative.search)){if(psychotic){result.hostname=result.host=srcPath.shift();var authInHost=!!(result.host&&result.host.indexOf("@")>0)&&result.host.split("@");authInHost&&(result.auth=authInHost.shift(),result.host=result.hostname=authInHost.shift())}return result.search=relative.search,result.query=relative.query,util.isNull(result.pathname)&&util.isNull(result.search)||(result.path=(result.pathname?result.pathname:"")+(result.search?result.search:"")),result.href=result.format(),result}if(!srcPath.length)return result.pathname=null,result.search?result.path="/"+result.search:result.path=null,result.href=result.format(),result;for(var last=srcPath.slice(-1)[0],hasTrailingSlash=(result.host||relative.host||srcPath.length>1)&&("."===last||".."===last)||""===last,up=0,i=srcPath.length;i>=0;i--)last=srcPath[i],"."===last?srcPath.splice(i,1):".."===last?(srcPath.splice(i,1),up++):up&&(srcPath.splice(i,1),up--);if(!mustEndAbs&&!removeAllDots)for(;up--;up)srcPath.unshift("..");!mustEndAbs||""===srcPath[0]||srcPath[0]&&"/"===srcPath[0].charAt(0)||srcPath.unshift(""),hasTrailingSlash&&"/"!==srcPath.join("/").substr(-1)&&srcPath.push("");var isAbsolute=""===srcPath[0]||srcPath[0]&&"/"===srcPath[0].charAt(0);if(psychotic){result.hostname=result.host=isAbsolute?"":srcPath.length?srcPath.shift():"";var authInHost=!!(result.host&&result.host.indexOf("@")>0)&&result.host.split("@");authInHost&&(result.auth=authInHost.shift(),result.host=result.hostname=authInHost.shift())}return mustEndAbs=mustEndAbs||result.host&&srcPath.length,mustEndAbs&&!isAbsolute&&srcPath.unshift(""),srcPath.length?result.pathname=srcPath.join("/"):(result.pathname=null,result.path=null),util.isNull(result.pathname)&&util.isNull(result.search)||(result.path=(result.pathname?result.pathname:"")+(result.search?result.search:"")),result.auth=relative.auth||result.auth,result.slashes=result.slashes||relative.slashes,result.href=result.format(),result},Url.prototype.parseHost=function(){var host=this.host,port=portPattern.exec(host);port&&(port=port[0],":"!==port&&(this.port=port.substr(1)),host=host.substr(0,host.length-port.length)),host&&(this.hostname=host)}},{"./util":414,punycode:316,querystring:319}],414:[function(require,module,exports){"use strict";module.exports={isString:function(arg){return"string"==typeof arg},isObject:function(arg){return"object"==typeof arg&&null!==arg},isNull:function(arg){return null===arg},isNullOrUndefined:function(arg){return null==arg}}},{}],415:[function(require,module,exports){(function(global){function deprecate(fn,msg){function deprecated(){if(!warned){if(config("throwDeprecation"))throw new Error(msg);config("traceDeprecation")?console.trace(msg):console.warn(msg),warned=!0}return fn.apply(this,arguments)}if(config("noDeprecation"))return fn;var warned=!1;return deprecated}function config(name){try{if(!global.localStorage)return!1}catch(_){return!1}var val=global.localStorage[name];return null!=val&&"true"===String(val).toLowerCase()}module.exports=deprecate}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],416:[function(require,module,exports){arguments[4][104][0].apply(exports,arguments)},{dup:104}],417:[function(require,module,exports){module.exports=function(arg){return arg&&"object"==typeof arg&&"function"==typeof arg.copy&&"function"==typeof arg.fill&&"function"==typeof arg.readUInt8}},{}],418:[function(require,module,exports){(function(process,global){function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};return arguments.length>=3&&(ctx.depth=arguments[2]),arguments.length>=4&&(ctx.colors=arguments[3]),isBoolean(opts)?ctx.showHidden=opts:opts&&exports._extend(ctx,opts),isUndefined(ctx.showHidden)&&(ctx.showHidden=!1),isUndefined(ctx.depth)&&(ctx.depth=2),isUndefined(ctx.colors)&&(ctx.colors=!1),isUndefined(ctx.customInspect)&&(ctx.customInspect=!0),ctx.colors&&(ctx.stylize=stylizeWithColor),formatValue(ctx,obj,ctx.depth)}function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];return style?"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m":str}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};return array.forEach(function(val,idx){hash[val]=!0}),hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&(!value.constructor||value.constructor.prototype!==value)){var ret=value.inspect(recurseTimes,ctx);return isString(ret)||(ret=formatValue(ctx,ret,recurseTimes)),ret}var primitive=formatPrimitive(ctx,value);if(primitive)return primitive;var keys=Object.keys(value),visibleKeys=arrayToHash(keys);if(ctx.showHidden&&(keys=Object.getOwnPropertyNames(value)),isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0))return formatError(value);if(0===keys.length){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value))return ctx.stylize(RegExp.prototype.toString.call(value),"regexp");if(isDate(value))return ctx.stylize(Date.prototype.toString.call(value),"date");if(isError(value))return formatError(value)}var base="",array=!1,braces=["{","}"];if(isArray(value)&&(array=!0,braces=["[","]"]),isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)&&(base=" "+RegExp.prototype.toString.call(value)),isDate(value)&&(base=" "+Date.prototype.toUTCString.call(value)),isError(value)&&(base=" "+formatError(value)),0===keys.length&&(!array||0==value.length))return braces[0]+base+braces[1];if(recurseTimes<0)return isRegExp(value)?ctx.stylize(RegExp.prototype.toString.call(value),"regexp"):ctx.stylize("[Object]","special");ctx.seen.push(value);var output;return output=array?formatArray(ctx,value,recurseTimes,visibleKeys,keys):keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)}),ctx.seen.pop(),reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";
return ctx.stylize(simple,"string")}return isNumber(value)?ctx.stylize(""+value,"number"):isBoolean(value)?ctx.stylize(""+value,"boolean"):isNull(value)?ctx.stylize("null","null"):void 0}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){for(var output=[],i=0,l=value.length;i<l;++i)hasOwnProperty(value,String(i))?output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),!0)):output.push("");return keys.forEach(function(key){key.match(/^\d+$/)||output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,!0))}),output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;if(desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]},desc.get?str=desc.set?ctx.stylize("[Getter/Setter]","special"):ctx.stylize("[Getter]","special"):desc.set&&(str=ctx.stylize("[Setter]","special")),hasOwnProperty(visibleKeys,key)||(name="["+key+"]"),str||(ctx.seen.indexOf(desc.value)<0?(str=isNull(recurseTimes)?formatValue(ctx,desc.value,null):formatValue(ctx,desc.value,recurseTimes-1),str.indexOf("\n")>-1&&(str=array?str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2):"\n"+str.split("\n").map(function(line){return"   "+line}).join("\n"))):str=ctx.stylize("[Circular]","special")),isUndefined(name)){if(array&&key.match(/^\d+$/))return str;name=JSON.stringify(""+key),name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(name=name.substr(1,name.length-2),name=ctx.stylize(name,"name")):(name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),name=ctx.stylize(name,"string"))}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0,length=output.reduce(function(prev,cur){return numLinesEst++,cur.indexOf("\n")>=0&&numLinesEst++,prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);return length>60?braces[0]+(""===base?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]:braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}function isBoolean(arg){return"boolean"==typeof arg}function isNull(arg){return null===arg}function isNullOrUndefined(arg){return null==arg}function isNumber(arg){return"number"==typeof arg}function isString(arg){return"string"==typeof arg}function isSymbol(arg){return"symbol"==typeof arg}function isUndefined(arg){return void 0===arg}function isRegExp(re){return isObject(re)&&"[object RegExp]"===objectToString(re)}function isObject(arg){return"object"==typeof arg&&null!==arg}function isDate(d){return isObject(d)&&"[object Date]"===objectToString(d)}function isError(e){return isObject(e)&&("[object Error]"===objectToString(e)||e instanceof Error)}function isFunction(arg){return"function"==typeof arg}function isPrimitive(arg){return null===arg||"boolean"==typeof arg||"number"==typeof arg||"string"==typeof arg||"symbol"==typeof arg||"undefined"==typeof arg}function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return n<10?"0"+n.toString(10):n.toString(10)}function timestamp(){var d=new Date,time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){for(var objects=[],i=0;i<arguments.length;i++)objects.push(inspect(arguments[i]));return objects.join(" ")}for(var i=1,args=arguments,len=args.length,str=String(f).replace(formatRegExp,function(x){if("%%"===x)return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}}),x=args[i];i<len;x=args[++i])str+=isNull(x)||!isObject(x)?" "+x:" "+inspect(x);return str},exports.deprecate=function(fn,msg){function deprecated(){if(!warned){if(process.throwDeprecation)throw new Error(msg);process.traceDeprecation?console.trace(msg):console.error(msg),warned=!0}return fn.apply(this,arguments)}if(isUndefined(global.process))return function(){return exports.deprecate(fn,msg).apply(this,arguments)};if(process.noDeprecation===!0)return fn;var warned=!1;return deprecated};var debugEnviron,debugs={};exports.debuglog=function(set){if(isUndefined(debugEnviron)&&(debugEnviron=process.env.NODE_DEBUG||""),set=set.toUpperCase(),!debugs[set])if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else debugs[set]=function(){};return debugs[set]},exports.inspect=inspect,inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},inspect.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"},exports.isArray=isArray,exports.isBoolean=isBoolean,exports.isNull=isNull,exports.isNullOrUndefined=isNullOrUndefined,exports.isNumber=isNumber,exports.isString=isString,exports.isSymbol=isSymbol,exports.isUndefined=isUndefined,exports.isRegExp=isRegExp,exports.isObject=isObject,exports.isDate=isDate,exports.isError=isError,exports.isFunction=isFunction,exports.isPrimitive=isPrimitive,exports.isBuffer=require("./support/isBuffer");var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))},exports.inherits=require("inherits"),exports._extend=function(origin,add){if(!add||!isObject(add))return origin;for(var keys=Object.keys(add),i=keys.length;i--;)origin[keys[i]]=add[keys[i]];return origin}}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./support/isBuffer":417,_process:309,inherits:416}],419:[function(require,module,exports){function Context(){}var indexOf=function(xs,item){if(xs.indexOf)return xs.indexOf(item);for(var i=0;i<xs.length;i++)if(xs[i]===item)return i;return-1},Object_keys=function(obj){if(Object.keys)return Object.keys(obj);var res=[];for(var key in obj)res.push(key);return res},forEach=function(xs,fn){if(xs.forEach)return xs.forEach(fn);for(var i=0;i<xs.length;i++)fn(xs[i],i,xs)},defineProp=function(){try{return Object.defineProperty({},"_",{}),function(obj,name,value){Object.defineProperty(obj,name,{writable:!0,enumerable:!1,configurable:!0,value:value})}}catch(e){return function(obj,name,value){obj[name]=value}}}(),globals=["Array","Boolean","Date","Error","EvalError","Function","Infinity","JSON","Math","NaN","Number","Object","RangeError","ReferenceError","RegExp","String","SyntaxError","TypeError","URIError","decodeURI","decodeURIComponent","encodeURI","encodeURIComponent","escape","eval","isFinite","isNaN","parseFloat","parseInt","undefined","unescape"];Context.prototype={};var Script=exports.Script=function(code){return this instanceof Script?void(this.code=code):new Script(code)};Script.prototype.runInContext=function(context){if(!(context instanceof Context))throw new TypeError("needs a 'context' argument.");var iframe=document.createElement("iframe");iframe.style||(iframe.style={}),iframe.style.display="none",document.body.appendChild(iframe);var win=iframe.contentWindow,wEval=win.eval,wExecScript=win.execScript;!wEval&&wExecScript&&(wExecScript.call(win,"null"),wEval=win.eval),forEach(Object_keys(context),function(key){win[key]=context[key]}),forEach(globals,function(key){context[key]&&(win[key]=context[key])});var winKeys=Object_keys(win),res=wEval.call(win,this.code);return forEach(Object_keys(win),function(key){(key in context||indexOf(winKeys,key)===-1)&&(context[key]=win[key])}),forEach(globals,function(key){key in context||defineProp(context,key,win[key])}),document.body.removeChild(iframe),res},Script.prototype.runInThisContext=function(){return eval(this.code)},Script.prototype.runInNewContext=function(context){var ctx=Script.createContext(context),res=this.runInContext(ctx);return context&&forEach(Object_keys(ctx),function(key){context[key]=ctx[key]}),res},forEach(Object_keys(Script.prototype),function(name){exports[name]=Script[name]=function(code){var s=Script(code);return s[name].apply(s,[].slice.call(arguments,1))}}),exports.createScript=function(code){return exports.Script(code)},exports.createContext=Script.createContext=function(context){var copy=new Context;return"object"==typeof context&&forEach(Object_keys(context),function(key){copy[key]=context[key]}),copy}},{}],420:[function(require,module,exports){module.exports={name:"TTT",description:"Make payment fun",author:"TrustNote",version:"1.1.6",keywords:["wallet","trustnote","decentralized","multisignature","bitcoin"],main:"public/index.html",window:{title:"TrustNote",icon:"./public/img/icons/icon-white-256.png",show:!0,visible:!0,resizable:!1,frame:!0,width:400,height:600,position:"center",fullscreen:!1},webkit:{"page-cache":!1,java:!1,plugin:!1},"chromium-args":"--proxy-server=http://127.1.2.7 --password-store=basic --disable-password-generation",homepage:"https://github.com/trustnote/trustnote-wallet",license:"MIT",repository:{url:"https://github.com/trustnote/trustnote-wallet.git",type:"git"},bugs:{url:"https://github.com/trustnote/trustnote-wallet/issues"},browser:{request:"browser-request",secp256k1:"secp256k1/js"},dependencies:{async:"^1.5.2",bip38:"^1.4.0","bitcore-lib":"^0.13.14","bitcore-mnemonic":"~1.0.0","trustnote-common":"git+https://github.com/trustnote/trustnote-common.git",grunt:"^1.0.1","grunt-angular-gettext":"^2.2.3","grunt-browserify":"^5.0.0","grunt-contrib-compress":"^1.3.0","grunt-contrib-concat":"^1.0.1","grunt-contrib-copy":"^1.0.0","grunt-contrib-uglify":"^1.0.1","grunt-contrib-watch":"^1.0.0","grunt-exec":"^1.0.0",jszip:"^3.1.3",lodash:"^4.6.1",moment:"^2.18.1",preconditions:"^1.0.8",shelljs:"^0.3.0",sjcl:"^1.0.2",unzip:"git+https://github.com/trustnote/unzip.git",zip:"git+https://github.com/xJeneKx/zip.git"},optionalDependencies:{"innosetup-compiler":"^5.5.9"},devDependencies:{"adm-zip":"^0.4.7",angular:"^1.3.14","angular-mocks":"^1.3.14",bhttp:"^1.2.1","grunt-karma":"^1.0.0","grunt-karma-coveralls":"^2.5.3","grunt-nw-builder":"^2.0.0",karma:"^1.1.0","karma-cli":"0.0.4","karma-coverage":"^0.2.7","karma-jasmine":"^0.3.5","karma-phantomjs-launcher":"^0.1.4"}}},{}],421:[function(require,module,exports){var _dir,_fs,lodash=require("lodash"),init=function(cb){function onFileSystemSuccess(fileSystem){console.log("File system started: "+fileSystem.name+", "+fileSystem.root.name),_fs=fileSystem,getDir(function(err,newDir){return err||!newDir.nativeURL?cb(err):(_dir=newDir,console.log("Got main dir: "+_dir.nativeURL),cb(null,_fs,_dir))})}function fail(evt){var msg="Could not init file system: "+evt.target.error.code;return console.log(msg),cb(msg)}return _dir?cb(null,_fs,_dir):void window.requestFileSystem(LocalFileSystem.PERSISTENT,0,onFileSystemSuccess,fail)},getDir=function(cb){if(!cordova.file)return cb("Could not write on device storage");var url=cordova.file.dataDirectory;window.resolveLocalFileSystemURL(url,function(dir){return cb(null,dir)},function(err){return console.warn(err),cb(err||"Could not resolve filesystem:"+url)})},get=function(k,cb){init(function(err,fs,dir){return err?cb(err):void dir.getFile(k,{create:!1},function(fileEntry){return fileEntry?void fileEntry.file(function(file){var reader=new FileReader;reader.onloadend=function(e){return this.result&&console.log("Read: "+this.result),cb(null,this.result)},reader.readAsText(file)}):cb()},function(err){return 1===err.code?cb():cb(err)})})},set=function(k,v,cb){init(function(err,fs,dir){return err?cb(err):void dir.getFile(k,{create:!0},function(fileEntry){fileEntry.createWriter(function(fileWriter){fileWriter.onwriteend=function(e){return console.log("Write completed."),cb()},fileWriter.onerror=function(e){var err=e.error?e.error:JSON.stringify(e);return console.log("Write failed: "+err),cb("Fail to write:"+err)},lodash.isObject(v)&&(v=JSON.stringify(v)),lodash.isString(v)||(v=v.toString()),console.log("Writing: "+k+"="+v),fileWriter.write(v)},cb)},cb)})};exports.init=init,exports.get=get,exports.set=set},{lodash:271}],422:[function(require,module,exports){(function(process,Buffer){function selectText(element){var doc=document;if(doc.body.createTextRange){var range=doc.body.createTextRange();range.moveToElementText(element),range.select()}else if(window.getSelection){var selection=window.getSelection(),range=doc.createRange();range.selectNodeContents(element),selection.removeAllRanges(),selection.addRange(range)}}function Profile(){this.version="1.0.0"}function tempHandleUri(url){console.log("saving open url "+url),window.open_url=url}var bwcModule=angular.module("bwcModule",[]);console.log("before");var Client=require("../angular-bitcore-wallet-client/bitcore-wallet-client/index.js");console.log("after"),bwcModule.constant("MODULE_VERSION","1.0.0"),bwcModule.provider("bwcService",function(){var provider={};return provider.$get=function(){var service={};return service.getBitcore=function(){return Client.Bitcore},service.getSJCL=function(){return Client.sjcl},service.getUtils=function(){return Client.Utils},service.getClient=function(walletData){var bwc=new Client({});return walletData&&bwc["import"](walletData),bwc},service},provider});var modules=["ui.router","angularMoment","angular-carousel","mm.foundation","monospaced.qrcode","monospaced.elastic","gettext","ngLodash","uiSwitch","bwcModule","copayApp.filters","copayApp.services","copayApp.controllers","copayApp.directives","copayApp.addons","ct.ui.router.extras"];window.copayApp=angular.module("copayApp",modules);angular.module("copayApp.filters",[]),angular.module("copayApp.services",[]),angular.module("copayApp.controllers",[]),angular.module("copayApp.directives",[]),angular.module("copayApp.addons",[]);var unsupported,isaosp,breadcrumbs=require("trustnote-common/breadcrumbs.js");if(window&&window.navigator){var rxaosp=window.navigator.userAgent.match(/Android.*AppleWebKit\/([\d.]+)/);isaosp=rxaosp&&rxaosp[1]<537,!window.cordova&&isaosp&&(unsupported=!0),unsupported&&(window.location="#/unsupported")}angular.module("copayApp").config(function(historicLogProvider,$provide,$logProvider,$stateProvider,$urlRouterProvider,$compileProvider){$urlRouterProvider.otherwise("/"),$logProvider.debugEnabled(!0),$provide.decorator("$log",["$delegate",function($delegate){var historicLog=historicLogProvider.$get();return["debug","info","warn","error","log"].forEach(function(level){var orig=$delegate[level];$delegate[level]=function(){"error"==level&&console.log(arguments);var args=[].slice.call(arguments);Array.isArray(args)||(args=[args]),args=args.map(function(v){try{"undefined"==typeof v&&(v="undefined"),v||(v="null"),"object"==typeof v&&(v=v.message?v.message:JSON.stringify(v)),window.cordova&&(v=v.toString(),v.length>1e3&&(v=v.substr(0,997)+"..."))}catch(e){console.log("Error at log decorator:",e),v="undefined"}return v});try{window.cordova&&console.log(args.join(" ")),historicLog.add(level,args.join(" ")),orig.apply(null,args)}catch(e){console.log("ERROR (at log decorator):",e,args[0])}}}),$delegate}]),$compileProvider.imgSrcSanitizationWhitelist(/^\s*((https?|ftp|file|blob|chrome-extension):|data:image\/)/),$stateProvider.state("splash",{url:"/splash",needProfile:!1,views:{main:{templateUrl:"views/splash.html"}}}).state("backupWaring",{url:"/backupWaring",needProfile:!1,views:{main:{templateUrl:"views/includes/backupWaring.html"}}}),$stateProvider.state("walletHome",{url:"/",walletShouldBeComplete:!0,needProfile:!0,deepStateRedirect:!0,sticky:!0,views:{main:{templateUrl:"views/walletHome.html"}}}).state("unsupported",{url:"/unsupported",needProfile:!1,views:{main:{templateUrl:"views/unsupported.html"}}}).state("create",{url:"/create",templateUrl:"views/create.html",needProfile:!0,modal:!0,views:{main:{templateUrl:"views/create.html"}}}).state("copayers",{url:"/copayers",needProfile:!0,views:{main:{templateUrl:"views/copayers.html"}}}).state("correspondentDevices",{url:"/correspondentDevices",walletShouldBeComplete:!1,needProfile:!0,deepStateRedirect:!0,sticky:!0,views:{chat:{templateUrl:"views/correspondentDevices.html"}}}).state("mywallet",{url:"/mywallet",walletShouldBeComplete:!1,needProfile:!0,deepStateRedirect:!0,sticky:!0,views:{main:{templateUrl:"views/mywallet.html"}}}).state("correspondentDevices.correspondentDevice",{url:"/device",walletShouldBeComplete:!1,needProfile:!0,views:{dialog:{templateUrl:"views/correspondentDevice.html"}}}).state("correspondentDevices.correspondentDevice.editCorrespondentDevice",{url:"/edit",walletShouldBeComplete:!1,needProfile:!0,views:{"dialog@correspondentDevices":{templateUrl:"views/editCorrespondentDevice.html"}}}).state("correspondentDevices.addCorrespondentDevice",{url:"/add",needProfile:!0,views:{dialog:{templateUrl:"views/addCorrespondentDevice.html"}}}).state("correspondentDevices.addCorrespondentDevice.inviteCorrespondentDevice",{url:"/invite",walletShouldBeComplete:!1,needProfile:!0,views:{"dialog@correspondentDevices":{templateUrl:"views/inviteCorrespondentDevice.html"}}}).state("correspondentDevices.addCorrespondentDevice.acceptCorrespondentInvitation",{url:"/acceptCorrespondentInvitation",walletShouldBeComplete:!1,needProfile:!0,views:{"dialog@correspondentDevices":{templateUrl:"views/acceptCorrespondentInvitation.html"}}}).state("correspondentDevices.bot",{url:"/bot/:id",walletShouldBeComplete:!1,needProfile:!0,views:{dialog:{templateUrl:"views/bot.html"}}}).state("authConfirmation",{url:"/authConfirmation",walletShouldBeComplete:!0,needProfile:!0,views:{main:{templateUrl:"views/authConfirmation.html"}}}).state("preferences",{url:"/preferences",templateUrl:"views/preferences.html",walletShouldBeComplete:!0,needProfile:!0,modal:!0,views:{main:{templateUrl:"views/preferences.html"}}}).state("preferences.preferencesColor",{url:"/color",templateUrl:"views/preferencesColor.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/preferencesColor.html"}}}).state("preferences.preferencesCold",{url:"/cold",templateUrl:"views/preferencesCold.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/preferencesCold.html"}}}).state("preferences.preferencesTcode",{url:"/tcode",templateUrl:"views/preferencesTcode.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/preferencesTcode.html"}}}).state("preferences.preferencesTcode.send",{url:"/airDrop",templateUrl:"views/includes/airDrop.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/includes/airDrop.html"}}}).state("preferences.preferencesTcode.receive",{url:"/airDropReceive",templateUrl:"views/includes/airDropReceive.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/includes/airDropReceive.html"}}}).state("preferences.preferencesTcode.preferencesRecords",{url:"/records",templateUrl:"views/preferencesRecords.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/preferencesRecords.html"}}}).state("preferences.preferencesAlias",{url:"/alias",templateUrl:"views/preferencesAlias.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/preferencesAlias.html"}}}).state("preferences.preferencesAdvanced",{url:"/advanced",templateUrl:"views/preferencesAdvanced.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/preferencesAdvanced.html"}}}).state("preferences.preferencesAdvanced.preferencesInformation",{url:"/information",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/preferencesInformation.html"}}}).state("preferences.preferencesAdvanced.paperWallet",{url:"/paperWallet",templateUrl:"views/paperWallet.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/paperWallet.html"}}}).state("preferences.preferencesAdvanced.preferencesDeleteWallet",{url:"/delete",templateUrl:"views/preferencesDeleteWallet.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/preferencesDeleteWallet.html"}}}).state("preferencesGlobal",{url:"/preferencesGlobal",needProfile:!0,modal:!0,views:{main:{templateUrl:"views/preferencesGlobal.html"}}}).state("preferencesGlobal.preferencesDeviceName",{url:"/deviceName",walletShouldBeComplete:!1,needProfile:!1,views:{"main@":{templateUrl:"views/preferencesDeviceName.html"}}}).state("preferencesGlobal.preferencesHub",{url:"/hub",walletShouldBeComplete:!1,needProfile:!1,views:{"main@":{templateUrl:"views/preferencesHub.html"}}}).state("preferencesGlobal.preferencesTor",{url:"/tor",templateUrl:"views/preferencesTor.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/preferencesTor.html"}}}).state("preferencesGlobal.preferencesLanguage",{url:"/language",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/preferencesLanguage.html"}}}).state("preferencesGlobal.preferencesUnit",{url:"/unit",templateUrl:"views/preferencesUnit.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/preferencesUnit.html"}}}).state("preferencesGlobal.preferencesBbUnit",{url:"/bbUnit",templateUrl:"views/preferencesBbUnit.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/preferencesBbUnit.html"}}}).state("preferencesGlobal.preferencesEmail",{url:"/email",templateUrl:"views/preferencesEmail.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/preferencesEmail.html"}}}).state("preferencesGlobal.preferencesWitnesses",{url:"/witnesses",templateUrl:"views/preferencesWitnesses.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/preferencesWitnesses.html"}}}).state("preferencesGlobal.preferencesWitnesses.preferencesEditWitness",{url:"/edit",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/preferencesEditWitness.html"}}}).state("preferencesGlobal.backup",{url:"/backup",templateUrl:"views/backup.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/backup.html"}}}).state("preferencesGlobal.recoveryFromSeed",{url:"/recoveryFromSeed",templateUrl:"views/recoveryFromSeed.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/recoveryFromSeed.html"}}}).state("preferencesGlobal.recoveryFromSeeddir",{url:"/recoveryFromSeeddir",templateUrl:"views/recoverFormSeedDir.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/recoverFormSeedDir.html"}}}).state("preferencesGlobal.synchronization",{url:"/synchronization",templateUrl:"views/synchronization.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/synchronization.html"}}}).state("preferencesGlobal.export",{url:"/export",templateUrl:"views/export.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/export.html"}}}).state("preferencesGlobal.import",{url:"/import",needProfile:!0,views:{"main@":{templateUrl:"views/import.html"}}}).state("preferencesGlobal.preferencesAbout",{url:"/about",templateUrl:"views/preferencesAbout.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/preferencesAbout.html"}}}).state("preferencesGlobal.preferencesAbout.disclaimer",{url:"/disclaimer",needProfile:!1,views:{"main@":{templateUrl:"views/disclaimer.html"}}}).state("preferencesGlobal.preferencesAbout.translators",{url:"/translators",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/translators.html"}}}).state("preferencesGlobal.preferencesAbout.preferencesLogs",{url:"/logs",templateUrl:"views/preferencesLogs.html",walletShouldBeComplete:!0,needProfile:!0,views:{"main@":{templateUrl:"views/preferencesLogs.html"}}}).state("add",{url:"/add",needProfile:!0,views:{main:{templateUrl:"views/add.html"}}}).state("cordova",{url:"/cordova/:status/:isHome",views:{main:{controller:function($rootScope,$state,$stateParams,$timeout,go,isCordova){switch(console.log("cordova status: "+$stateParams.status),$stateParams.status){case"resume":$rootScope.$emit("Local/Resume");break;case"backbutton":isCordova&&"true"==$stateParams.isHome&&!$rootScope.modalOpened?navigator.app.exitApp():$rootScope.$emit("closeModal")}}}},needProfile:!1})}).run(function($rootScope,$state,$log,uriHandler,isCordova,profileService,storageService,$timeout,nodeWebkit,uxLanguage,animationService){FastClick.attach(document.body),uxLanguage.init(),isCordova||uriHandler.register(),$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){if(!profileService.profile&&toState.needProfile){if(event.preventDefault(),profileService.assocVisitedFromStates||(profileService.assocVisitedFromStates={}),breadcrumbs.add("$stateChangeStart no profile from "+fromState.name+" to "+toState.name),profileService.assocVisitedFromStates[fromState.name]&&!fromState.name)return breadcrumbs.add("already loading profile, ignoring duplicate $stateChangeStart from "+fromState.name);profileService.assocVisitedFromStates[fromState.name]=!0,profileService.loadAndBindProfile(function(err){if(delete profileService.assocVisitedFromStates[fromState.name],err)if(err.message&&err.message.match("NOPROFILE"))$log.debug("No profile... redirecting"),$state.transitionTo("splash");else{if(!err.message||!err.message.match("NONAGREEDDISCLAIMER"))throw new Error(err);$log.debug("Display disclaimer... redirecting"),$state.transitionTo("preferencesGlobal.preferencesAbout.disclaimer")}else $log.debug("Profile loaded ... Starting UX."),storageService.gethaschoosen(function(err,val){1==val?($log.debug("No choosen... redirecting"),$state.transitionTo("backupWaring")):$state.transitionTo(toState.name||toState,toParams)})})}profileService.focusedClient&&!profileService.focusedClient.isComplete()&&toState.walletShouldBeComplete&&($state.transitionTo("copayers"),event.preventDefault()),animationService.transitionAnimated(fromState,toState)||(event.preventDefault(),setTimeout(function(){$state.transitionTo(toState)},50))})}),angular.module("copayApp.directives").directive("validAddress",["$rootScope","profileService",function($rootScope,profileService){return{require:"ngModel",link:function(scope,elem,attrs,ctrl){var ValidationUtils=require("trustnote-common/validation_utils.js"),validator=function(value){if(profileService.focusedClient){if("undefined"==typeof value)return void(ctrl.$pristine=!0);if(/^https?:\/\//.test(value))return ctrl.$setValidity("validAddress",!0),value;var conf=require("trustnote-common/conf.js"),re=new RegExp("^"+conf.program+":([A-Z2-7]{32})\b","i"),arrMatches=value.match(re);return arrMatches?(ctrl.$setValidity("validAddress",ValidationUtils.isValidAddress(arrMatches[1])),value):(ctrl.$setValidity("validAddress",ValidationUtils.isValidAddress(value)),value)}};ctrl.$parsers.unshift(validator),ctrl.$formatters.unshift(validator)}}}]).directive("validUrl",[function(){return{require:"ngModel",link:function(scope,elem,attrs,ctrl){var validator=function(value){return/^https?:\/\//.test(value)?(ctrl.$setValidity("validUrl",!0),value):(ctrl.$setValidity("validUrl",!1),value)};ctrl.$parsers.unshift(validator),ctrl.$formatters.unshift(validator)}}}]).directive("validAmount",["configService",function(configService){return{require:"ngModel",link:function(scope,element,attrs,ctrl){var val=function(value){var constants=require("trustnote-common/constants.js"),asset=attrs.validAmount,settings=configService.getSync().wallet.settings,unitValue=1,decimals=0;"base"===asset?(unitValue=settings.unitValue,decimals=Number(settings.unitDecimals)):asset===constants.BLACKBYTES_ASSET&&(unitValue=settings.bbUnitValue,decimals=Number(settings.bbUnitDecimals));var vNum=Number((value*unitValue).toFixed(0));if("undefined"!=typeof value&&0!=value||(ctrl.$pristine=!0),"number"==typeof vNum&&vNum>0){var sep_index=(""+value).indexOf("."),str_value=(""+value).substring(sep_index+1);sep_index>0&&str_value.length>decimals?ctrl.$setValidity("validAmount",!1):ctrl.$setValidity("validAmount",!0)}else ctrl.$setValidity("validAmount",!1);return value};ctrl.$parsers.unshift(val),ctrl.$formatters.unshift(val)}}}]).directive("validFeedName",["configService",function(configService){return{require:"ngModel",link:function(scope,elem,attrs,ctrl){var validator=function(value){var oracle=configService.oracles[attrs.validFeedName];if(!oracle||!oracle.feednames_filter)return ctrl.$setValidity("validFeedName",!0),value;for(var i in oracle.feednames_filter){var matcher=new RegExp(oracle.feednames_filter[i],"g");if(matcher.test(value))return ctrl.$setValidity("validFeedName",!0),value}return ctrl.$setValidity("validFeedName",!1),value};ctrl.$parsers.unshift(validator),ctrl.$formatters.unshift(validator)}}}]).directive("validFeedValue",["configService",function(configService){return{require:"ngModel",link:function(scope,elem,attrs,ctrl){var validator=function(value){var oracle=configService.oracles[attrs.validFeedValue];if(!oracle||!oracle.feedvalues_filter)return ctrl.$setValidity("validFeedValue",!0),value;for(var i in oracle.feedvalues_filter){var matcher=new RegExp(oracle.feedvalues_filter[i],"g");if(matcher.test(value))return ctrl.$setValidity("validFeedValue",!0),value}return ctrl.$setValidity("validFeedValue",!1),value};ctrl.$parsers.unshift(validator),ctrl.$formatters.unshift(validator)}}}]).directive("loading",function(){return{restrict:"A",link:function($scope,element,attr){var a=element.html(),text=attr.loading;element.on("click",function(){element.html('<i class="size-21 fi-bitcoin-circle icon-rotate spinner"></i> '+text+"...")}),$scope.$watch("loading",function(val){val||element.html(a)})}}}).directive("ngFileSelect",function(){return{link:function($scope,el){el.bind("change",function(e){$scope.file=(e.srcElement||e.target).files[0],$scope.getFile()})}}}).directive("contact",["addressbookService",function(addressbookService){return{restrict:"E",link:function(scope,element,attrs){var addr=attrs.address;addressbookService.getLabel(addr,function(label){label?element.append(label):element.append(addr)})}}}]).directive("highlightOnChange",function(){return{restrict:"A",link:function(scope,element,attrs){scope.$watch(attrs.highlightOnChange,function(newValue,oldValue){element.addClass("highlight"),setTimeout(function(){element.removeClass("highlight")},500)})}}}).directive("checkStrength",function(){return{replace:!1,restrict:"EACM",require:"ngModel",link:function(scope,element,attrs){function evaluateMeter(password){var text,passwordStrength=0;return password.length>0&&(passwordStrength=1),password.length>=MIN_LENGTH?(password.match(/[a-z]/)&&password.match(/[A-Z]/)?passwordStrength++:text=", add mixed case",password.match(/\d+/)?passwordStrength++:text||(text=", add numerals"),password.match(/.[!,@,#,$,%,^,&,*,?,_,~,-,(,)]/)?passwordStrength++:text||(text=", add punctuation"),password.length>12?passwordStrength++:text||(text=", add characters")):text=", that's short",text||(text=""),{strength:passwordStrength,message:MESSAGES[passwordStrength]+text,color:COLOR[passwordStrength]}}var MIN_LENGTH=8,MESSAGES=["Very Weak","Very Weak","Weak","Medium","Strong","Very Strong"],COLOR=["#dd514c","#dd514c","#faa732","#faa732","#16A085","#16A085"];scope.$watch(attrs.ngModel,function(newValue,oldValue){if(newValue&&""!==newValue){var info=evaluateMeter(newValue);scope[attrs.checkStrength]=info}})}}}).directive("showFocus",function($timeout){return function(scope,element,attrs){scope.$watch(attrs.showFocus,function(newValue){$timeout(function(){newValue&&element[0].focus()})},!0)}}).directive("match",function(){return{require:"ngModel",restrict:"A",scope:{match:"="},link:function(scope,elem,attrs,ctrl){scope.$watch(function(){
return ctrl.$pristine&&angular.isUndefined(ctrl.$modelValue)||scope.match===ctrl.$modelValue},function(currentValue){ctrl.$setValidity("match",currentValue)})}}}).directive("clipCopy",function(){return{restrict:"A",scope:{clipCopy:"=clipCopy"},link:function(scope,elm){elm.attr("tooltip","Press Ctrl+C to Copy"),elm.attr("tooltip-placement","top"),elm.bind("click",function(){selectText(elm[0])})}}}).directive("menuToggle",function(){return{restrict:"E",replace:!0,templateUrl:"views/includes/menu-toggle.html"}}).directive("logo",function(){return{restrict:"E",scope:{width:"@",negative:"="},controller:function($scope){$scope.logo_url=$scope.negative?"img/icons/icon-white-32.png":"img/icons/icon-black-32.png"},replace:!0,template:'<div><img ng-src="{{ logo_url }}" alt="Trustnote"><br>Trustnote</div>'}}).directive("availableBalance",function(){return{restrict:"E",replace:!0,templateUrl:"views/includes/available-balance.html"}}).directive("selectable",function($rootScope,$timeout){return{restrict:"A",scope:{bindObj:"=model",bindProp:"@prop",targetProp:"@exclusionBind"},link:function(scope,elem,attrs){$timeout(function(){var dropdown=angular.element(document.querySelector(attrs.selectable));dropdown.find("li").on("click",function(e){var li=angular.element(this);elem.html(li.find("a").find("span").eq(0).html()),scope.bindObj[scope.bindProp]=li.attr("data-value"),$rootScope.$$phase||$rootScope.$digest()}),scope.$watch(function(scope){return scope.bindObj[scope.bindProp]},function(newValue,oldValue){angular.forEach(dropdown.find("li"),function(element){var li=angular.element(element);li.attr("data-value")==newValue?(elem.html(li.find("a").find("span").eq(0).html()),li.addClass("selected")):li.removeClass("selected")})});var selected=!1;angular.forEach(dropdown.find("li"),function(el){var li=angular.element(el),a=angular.element(li.find("a"));a.append('<i class="fi-check check"></i>'),scope.bindObj[scope.bindProp]==li.attr("data-value")&&(a[0].click(),selected=!0)}),selected||"undefined"!=typeof attrs.notSelected||dropdown.find("a").eq(0)[0].click(),scope.targetProp&&scope.$watch(function(scope){return scope.bindObj[scope.targetProp]},function(newValue,oldValue){angular.forEach(dropdown.find("li"),function(element){var li=angular.element(element);li.attr("data-value")!=newValue&&(li[0].click(),scope.bindObj[scope.bindProp]=li.attr("data-value"))})})})}}}).directive("keyboard",["$compile",function($compile){return{restrict:"A",replace:!0,transclude:!0,template:"<input />",link:function(scope,element,attrs){var keylist1=["q","w","e","r","t","y","u","i","o","p"],keylist2=["a","s","d","f","g","h","j","k","l"],keylist3=["z","x","c","v","b","n","m"],calculator='<div class="ngcalculator_area"><div class="calculator"><div class="inputarea"><input type="text" id="text" ng-tap="getInput()" ng-change="'+attrs.ngChange+'" class="'+attrs["class"]+'" ng-model="'+attrs.ngModel+'"></div><div class="con"><div class="line1">';$.each(keylist1,function(k,v){calculator+='<div class="keyboard num key1" value="'+v+'">'+v+"</div>"}),calculator+='</div><div class="line2">',$.each(keylist2,function(k,v){calculator+='<div class="keyboard num key2" value="'+v+'">'+v+"</div>"}),calculator+='</div><div class="line3"><div class="keyboard blueIcon ensure"></div>',$.each(keylist3,function(k,v){calculator+='<div class="keyboard num key3" value="'+v+'">'+v+"</div>"}),calculator+='<div class="keyboard blueIcon backstep">&nbsp;</div></div></div></div></div>',calculator=$compile(calculator)(scope),element.bind("focus",function(){$(".ngcalculator_area").removeClass("keyboardHidden"),$(".ngcalculator_area").addClass("keyboardShow"),document.body.appendChild(calculator[0]),document.activeElement.blur(),$(".inptMnemonic").removeClass("active"),element.addClass("active")}),$(calculator[0]).find("input").focus(function(){document.activeElement.blur()}),$(calculator[0]).find(".close").click(function(){calculator[0].remove();var callback=attrs.callback;"undefined"!=typeof callback&&scope[callback]()}),$(".keyCloseFlag").click(function(){$(".ngcalculator_area").removeClass("keyboardShow"),$(".ngcalculator_area").addClass("keyboardHidden"),$(".inptMnemonic").removeClass("active")}),$(calculator[0]).find(".backstep").click(function(){"undefined"==typeof $(calculator[0]).find("input").val()&&$(calculator[0]).find("input").val(""),$(calculator[0]).find("input").val($(calculator[0]).find("input").val().substring(0,$(calculator[0]).find("input").val().length-1)).trigger("change")}),$(calculator[0]).find(".cleanup").click(function(){$(calculator[0]).find("input").val("").trigger("change")}),$(calculator[0]).find(".num").click(function(){var val=$(calculator[0]).find("input").val(),filter=attrs.filter;val="undefined"!=typeof filter?scope[filter](val,$(this).attr("value")):val+""+$(this).attr("value"),$(calculator[0]).find("input").val(val).trigger("change"),element.val(val).trigger("ngChange")}),$(calculator[0]).find(".ensure").click(function(){$(".ngcalculator_area").removeClass("keyboardShow"),$(".ngcalculator_area").addClass("keyboardHidden"),$(".inptMnemonic").removeClass("active")}),$(calculator[0]).find(".keyboard").click(function(){$(this).addClass("keydown");var that=this;setTimeout(function(){$(that).removeClass("keydown")},100)})}}}]);var breadcrumbs=require("trustnote-common/breadcrumbs.js");angular.module("copayApp.directives").directive("qrScanner",["$rootScope","$timeout","$modal","isCordova","gettextCatalog",function($rootScope,$timeout,$modal,isCordova,gettextCatalog){var controller=function($scope){$scope.cordovaOpenScanner=function(){window.ignoreMobilePause=!0,window.plugins.spinnerDialog.show(null,gettextCatalog.getString("Preparing camera..."),!0),$timeout(function(){cordova.plugins.barcodeScanner.scan(function(result){$timeout(function(){window.plugins.spinnerDialog.hide(),window.ignoreMobilePause=!1},100),result.cancelled||$timeout(function(){var data=result.text;$scope.onScan({data:data})},1e3)},function(error){$timeout(function(){window.ignoreMobilePause=!1,window.plugins.spinnerDialog.hide()},100),alert("Open camera permissions")}),$scope.beforeScan&&$scope.beforeScan()},100)},$scope.modalOpenScanner=function(){var parentScope=$scope,ModalInstanceCtrl=function($scope,$rootScope,$modalInstance){var video,canvas,$video,context,localMediaStream,prevResult,_scan=function(evt){if(localMediaStream){context.drawImage(video,0,0,300,225);try{qrcode.decode()}catch(e){}}$timeout(_scan,800)},_scanStop=function(){if(localMediaStream&&localMediaStream.active)for(var localMediaStreamTrack=localMediaStream.getTracks(),i=0;i<localMediaStreamTrack.length;i++)localMediaStreamTrack[i].stop();else try{localMediaStream.stop()}catch(e){}localMediaStream=null,video&&(video.src="")};qrcode.callback=function(data){return prevResult!=data?void(prevResult=data):(_scanStop(),void $modalInstance.close(data))};var _successCallback=function(stream){video.src=window.URL&&window.URL.createObjectURL(stream)||stream,localMediaStream=stream,video.play(),$timeout(_scan,1e3)},_videoError=function(err){breadcrumbs.add("qr scanner video error"),$scope.cancel()},setScanner=function(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL};$scope.init=function(){setScanner(),$timeout(function(){parentScope.beforeScan&&parentScope.beforeScan(),canvas=document.getElementById("qr-canvas"),canvas&&(context=canvas.getContext("2d"),video=document.getElementById("qrcode-scanner-video"),$video=angular.element(video),canvas.width=300,canvas.height=225,context.clearRect(0,0,300,225),navigator.getUserMedia({video:!0},_successCallback,_videoError))},500)},$scope.cancel=function(){breadcrumbs.add("qr scanner cancel"),_scanStop();try{$modalInstance.dismiss("cancel")}catch(e){e.bIgnore=!0}}},modalInstance=$modal.open({templateUrl:"views/modals/scanner.html",windowClass:"full",controller:ModalInstanceCtrl,backdrop:"static",keyboard:!1});modalInstance.result.then(function(data){parentScope.onScan({data:data})})},$scope.openScanner=function(){isCordova?$scope.cordovaOpenScanner():$scope.modalOpenScanner()}};return{restrict:"E",scope:{onScan:"&",beforeScan:"&"},controller:controller,replace:!0,template:'<a id="camera-icon" class="p10" ng-click="openScanner()"><i class="icon-scan size-24"></i></a>'}}]);var breadcrumbs=require("trustnote-common/breadcrumbs.js");angular.module("copayApp.directives").directive("qrScannerCold",["$rootScope","$timeout","$modal","isCordova","gettextCatalog",function($rootScope,$timeout,$modal,isCordova,gettextCatalog){var controller=function($scope){$scope.cordovaOpenScanner=function(){window.ignoreMobilePause=!0,window.plugins.spinnerDialog.show(null,gettextCatalog.getString("Preparing camera..."),!0),$timeout(function(){cordova.plugins.barcodeScanner.scan(function(result){$timeout(function(){window.plugins.spinnerDialog.hide(),window.ignoreMobilePause=!1},100),result.cancelled||$timeout(function(){var data=result.text;$scope.onScan({data:data})},1e3)},function(error){$timeout(function(){window.ignoreMobilePause=!1,window.plugins.spinnerDialog.hide()},100),alert("Open camera permissions")}),$scope.beforeScan&&$scope.beforeScan()},100)},$scope.modalOpenScanner=function(){var parentScope=$scope,ModalInstanceCtrl=function($scope,$rootScope,$modalInstance){var video,canvas,$video,context,localMediaStream,prevResult,_scan=function(evt){if(localMediaStream){context.drawImage(video,0,0,300,225);try{qrcode.decode()}catch(e){}}$timeout(_scan,800)},_scanStop=function(){if(localMediaStream&&localMediaStream.active)for(var localMediaStreamTrack=localMediaStream.getTracks(),i=0;i<localMediaStreamTrack.length;i++)localMediaStreamTrack[i].stop();else try{localMediaStream.stop()}catch(e){}localMediaStream=null,video&&(video.src="")};qrcode.callback=function(data){return prevResult!=data?void(prevResult=data):(_scanStop(),void $modalInstance.close(data))};var _successCallback=function(stream){video.src=window.URL&&window.URL.createObjectURL(stream)||stream,localMediaStream=stream,video.play(),$timeout(_scan,1e3)},_videoError=function(err){breadcrumbs.add("qr scanner video error"),$scope.cancel()},setScanner=function(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL};$scope.init=function(){setScanner(),$timeout(function(){parentScope.beforeScan&&parentScope.beforeScan(),canvas=document.getElementById("qr-canvas"),canvas&&(context=canvas.getContext("2d"),video=document.getElementById("qrcode-scanner-video"),$video=angular.element(video),canvas.width=300,canvas.height=225,context.clearRect(0,0,300,225),navigator.getUserMedia({video:!0},_successCallback,_videoError))},500)},$scope.cancel=function(){breadcrumbs.add("qr scanner cancel"),_scanStop();try{$modalInstance.dismiss("cancel")}catch(e){e.bIgnore=!0}}},modalInstance=$modal.open({templateUrl:"views/modals/scanner.html",windowClass:"full",controller:ModalInstanceCtrl,backdrop:"static",keyboard:!1});modalInstance.result.then(function(data){parentScope.onScan({data:data})})},$scope.openScanner=function(){isCordova?$scope.cordovaOpenScanner():$scope.modalOpenScanner()}};return{restrict:"E",scope:{onScan:"&",beforeScan:"&"},controller:controller,replace:!0,template:'<a id="camera-icon" class="p10" ng-click="openScanner()"><i class="icon-scan size-24"></i></a>'}}]),angular.module("copayApp.filters",[]).filter("amTimeAgo",["amMoment",function(amMoment){return function(input){return amMoment.preprocessDate(input).fromNow()}}]).filter("paged",function(){return function(elements){return!!elements&&elements.filter(Boolean)}}).filter("removeEmpty",function(){return function(elements){return elements=elements||[],elements.filter(function(e){return!e.isChange||e.balance>0})}}).filter("noFractionNumber",["$filter","$locale","configService",function(filter,locale,configService){var numberFilter=filter("number"),formats=locale.NUMBER_FORMATS,config=configService.getSync().wallet.settings;return function(amount,n){if("undefined"==typeof n&&!config)return amount;var fractionSize="undefined"!=typeof n?n:config.unitValue.toString().length-1,value=numberFilter(amount,fractionSize),sep=value.indexOf(formats.DECIMAL_SEP),group=value.indexOf(formats.GROUP_SEP);if(amount>=0){if(group>0){if(sep<0)return value;var intValue=value.substring(0,sep),floatValue=parseFloat(value.substring(sep));0===floatValue?floatValue="":(floatValue%1===0&&(floatValue=floatValue.toFixed(0)),floatValue=floatValue.toString().substring(1));var finalValue=intValue+floatValue;return finalValue}return value=parseFloat(value),value%1===0&&(value=value.toFixed(0)),value}return 0}}]),Profile.create=function(opts){opts=opts||{};var x=new Profile;if(x.createdOn=Date.now(),x.credentials=opts.credentials||[],!opts.xPrivKey&&!opts.xPrivKeyEncrypted)throw Error("no xPrivKey, even encrypted");if(!opts.mnemonic&&!opts.mnemonicEncrypted)throw Error("no mnemonic, even encrypted");if(!opts.tempDeviceKey)throw Error("no tempDeviceKey");return x.xPrivKey=opts.xPrivKey,x.mnemonic=opts.mnemonic,x.xPrivKeyEncrypted=opts.xPrivKeyEncrypted,x.mnemonicEncrypted=opts.mnemonicEncrypted,x.tempDeviceKey=opts.tempDeviceKey,x.prevTempDeviceKey=opts.prevTempDeviceKey,x.my_device_address=opts.my_device_address,x},Profile.fromObj=function(obj){var x=new Profile;if(x.createdOn=obj.createdOn,x.credentials=obj.credentials,x.credentials[0]&&"object"!=typeof x.credentials[0])throw"credentials should be an object";if(!obj.xPrivKey&&!obj.xPrivKeyEncrypted)throw Error("no xPrivKey, even encrypted");if(!obj.tempDeviceKey)throw Error("no tempDeviceKey");return x.xPrivKey=obj.xPrivKey,x.mnemonic=obj.mnemonic,x.xPrivKeyEncrypted=obj.xPrivKeyEncrypted,x.mnemonicEncrypted=obj.mnemonicEncrypted,x.tempDeviceKey=obj.tempDeviceKey,x.prevTempDeviceKey=obj.prevTempDeviceKey,x.my_device_address=obj.my_device_address,x},Profile.fromString=function(str){return Profile.fromObj(JSON.parse(str))},Profile.prototype.toObj=function(){return JSON.stringify(this)},angular.module("copayApp.services").service("addonManager",function(lodash){var addons=[];this.registerAddon=function(addonSpec){addons.push(addonSpec)},this.addonMenuItems=function(){return lodash.map(addons,function(addonSpec){return addonSpec.menuItem})},this.addonViews=function(){return lodash.map(addons,function(addonSpec){return addonSpec.view})},this.formatPendingTxp=function(txp){lodash.each(addons,function(addon){addon.formatPendingTxp&&addon.formatPendingTxp(txp)})},this.txTemplateUrl=function(){var addon=lodash.find(addons,"txTemplateUrl");return addon?addon.txTemplateUrl():null}}),angular.module("copayApp.services").factory("addressbookService",function(storageService,profileService){var root={};return root.getLabel=function(addr,cb){var fc=profileService.focusedClient;storageService.getAddressbook(fc.credentials.network,function(err,ab){return ab?(ab=JSON.parse(ab),ab[addr]?cb(ab[addr]):cb()):cb()})},root.list=function(cb){var fc=profileService.focusedClient;storageService.getAddressbook(fc.credentials.network,function(err,ab){return err?cb("Could not get the Addressbook"):(ab&&(ab=JSON.parse(ab)),cb(err,ab))})},root.add=function(entry,cb){var fc=profileService.focusedClient;root.list(function(err,ab){return err?cb(err):(ab||(ab={}),ab[entry.address]?cb("Entry already exist"):(ab[entry.address]=entry.label,void storageService.setAddressbook(fc.credentials.network,JSON.stringify(ab),function(err,ab){return err?cb("Error adding new entry"):void root.list(function(err,ab){return cb(err,ab)})})))})},root.remove=function(addr,cb){var fc=profileService.focusedClient;root.list(function(err,ab){if(err)return cb(err);if(ab){if(!ab[addr])return cb("Entry does not exist");delete ab[addr],storageService.setAddressbook(fc.credentials.network,JSON.stringify(ab),function(err){return err?cb("Error deleting entry"):void root.list(function(err,ab){return cb(err,ab)})})}})},root.removeAll=function(){var fc=profileService.focusedClient;storageService.removeAddressbook(fc.credentials.network,function(err){return err?cb("Error deleting addressbook"):cb()})},root}),angular.module("copayApp.services").factory("addressService",function(profileService,$log,$timeout,lodash,gettextCatalog){var root={};return root.expireAddress=function(walletId,cb){$log.debug("Cleaning Address "+walletId),cb()},root._createAddress=function(walletId,cb){var client=profileService.getClient(walletId);$log.debug("Creating address for wallet:",walletId),client.createAddress(0,function(err,addr){if(err)throw"impossible err creating address";return cb(null,addr.address)})},root.getAddress=function(walletId,forceNew,cb){if(forceNew)root._createAddress(walletId,function(err,addr){return err?cb(err):void cb(null,addr)});else{var client=profileService.getClient(walletId);client.getAddresses({reverse:!1,limit:1,is_change:0},function(err,addr){return err?cb(err):addr.length>0?cb(null,addr[0].address):void root.getAddress(walletId,!0,cb)})}},root}),angular.module("copayApp.services").factory("animationService",function(isCordova){function cleanUpLater(e,e2){var timeoutID,cleanedUp=!1,cleanUp=function(){cleanedUp||(cleanedUp=!0,e2.parentNode&&e2.parentNode.removeChild(e2),e2.innerHTML="",e.className="",cachedBackPanel=null,cachedTransitionState="",timeoutID&&(timeoutID=null,window.clearTimeout(timeoutID)))};e.addEventListener("animationend",cleanUp,!0),e2.addEventListener("animationend",cleanUp,!0),e.addEventListener("webkitAnimationEnd",cleanUp,!0),e2.addEventListener("webkitAnimationEnd",cleanUp,!0),timeoutID=setTimeout(cleanUp,500)}var cachedTransitionState,cachedBackPanel,root={};root.modalAnimated={slideUp:isCordova?"full animated slideInUp":"full",slideRight:isCordova?"full animated slideInRight":"full",slideOutDown:isCordova?"slideOutDown":"hideModal",slideOutRight:isCordova?"slideOutRight":"hideModal"};var pageWeight={walletHome:0,copayers:-1,cordova:-1,payment:-1,preferences:11,"preferences.preferencesColor":12,"preferencesGlobal.backup":12,"preferences.preferencesAdvanced":12,"preferencesGlobal.preferencesAbout":12,"preferences.preferencesAdvanced.preferencesDeleteWallet":13,"preferencesGlobal.preferencesDeviceName":12,"preferencesGlobal.preferencesLanguage":12,"preferencesGlobal.preferencesUnit":12,preferencesFee:12,preferencesAltCurrency:12,"preferences.preferencesAlias":12,"preferencesGlobal.preferencesEmail":12,"preferencesGlobal.export":13,"preferences.preferencesAdvanced.paperWallet":13,"preferencesGlobal.preferencesAbout.preferencesLogs":13,"preferences.preferencesAdvanced.preferencesInformation":13,"preferencesGlobal.preferencesAbout.translators":13,"preferencesGlobal.preferencesAbout.disclaimer":13,add:11,create:12,"preferencesGlobal.import":12,importLegacy:13};return root.transitionAnimated=function(fromState,toState,event){if(isaosp)return!0;var x=document.getElementById("mainSectionDup");if(x&&!cachedTransitionState)return console.log("Anim in progress"),!0;var fromName=fromState.name,toName=toState.name;if(!fromName||!toName)return!0;var fromWeight=pageWeight[fromName],toWeight=pageWeight[toName],entering=null,leaving=null;if(isCordova&&fromWeight&&toWeight)fromWeight>toWeight?leaving="CslideOutRight":entering="CslideInRight";else{if(!(isCordova&&fromName&&fromWeight>=0&&toWeight>=0))return!0;toWeight?entering="CslideInUp":leaving="CslideOutDown"}var e=document.getElementById("mainSection"),desiredTransitionState=(fromName||"-")+":"+(toName||"-");if(desiredTransitionState==cachedTransitionState)return e.className=entering||"",cachedBackPanel.className=leaving||"",cleanUpLater(e,cachedBackPanel),!0;var sc,contentDiv=e.getElementsByClassName("content");contentDiv&&contentDiv[0]&&(sc=contentDiv[0].scrollTop),cachedBackPanel=e.cloneNode(!0),cachedBackPanel.id="mainSectionDup";var c=document.getElementById("sectionContainer");return c.appendChild(cachedBackPanel),sc&&(cachedBackPanel.getElementsByClassName("content")[0].scrollTop=sc),cachedTransitionState=desiredTransitionState,!1},root}),angular.module("copayApp.services").factory("applicationService",function($rootScope,$timeout,isCordova,nodeWebkit,go){var root={};return root.restart=function(){var hashIndex=window.location.href.indexOf("#/");isCordova?(window.location=window.location.href.substr(0,hashIndex),$timeout(function(){$rootScope.$digest()},1)):nodeWebkit.isDefined()?(go.walletHome(),$timeout(function(){var win=require("nw.gui").Window.get();win.reload(3),win.reloadDev()},100)):window.location=window.location.href.substr(0,hashIndex)},root}),angular.module("copayApp.services").factory("authService",function(){var root={};return root.objRequest=null,root}),angular.module("copayApp.services").factory("autoUpdatingWitnessesList",function($timeout,$modal,$rootScope,configService){var root={};return root.autoUpdate=!0,root.timerNextCheck=null,root.checkChangeWitnesses=function(){if(root.autoUpdate){var device=require("trustnote-common/device.js"),myWitnesses=require("trustnote-common/my_witnesses.js");device.getWitnessesFromHub(function(err,arrWitnessesFromHub){arrWitnessesFromHub?myWitnesses.readMyWitnesses(function(arrWitnesses){if(root.addWitnesses=arrWitnessesFromHub.filter(function(witness){return arrWitnesses.indexOf(witness)==-1}),root.delWitnesses=arrWitnesses.filter(function(witness){return arrWitnessesFromHub.indexOf(witness)==-1}),0!=root.addWitnesses.length){var modalInstance=$modal.open({templateUrl:"views/modals/approveNewWitnesses.html",controller:"approveNewWitnesses"});$rootScope.$on("closeModal",function(){modalInstance.dismiss("cancel")})}root.timerNextCheck&&$timeout.cancel(root.timerNextCheck),root.timerNextCheck=$timeout(root.checkChangeWitnesses,864e5)},"wait"):(root.timerNextCheck&&$timeout.cancel(root.timerNextCheck),root.timerNextCheck=$timeout(root.checkChangeWitnesses,6e4))})}},root.setAutoUpdate=function(bAutoUpdate){configService.set({autoUpdateWitnessesList:bAutoUpdate},function(){}),root.autoUpdate=bAutoUpdate},configService.get(function(err,conf){void 0===conf.autoUpdateWitnessesList?root.setAutoUpdate(!0):root.autoUpdate=conf.autoUpdateWitnessesList,root.checkChangeWitnesses()}),root}),angular.module("copayApp.services").factory("backButton",function($log,$rootScope,gettextCatalog,$deepStateRedirect,$document,$timeout,go,$state,lodash,profileService){function back(){if(body.hasClass("modal-open"))$rootScope.$emit("closeModal");else if(root.showQrcode)$rootScope.$emit("closeQrcode");else if(root.menuOpened)go.swipe(),root.menuOpened=!1;else if("undefined"==typeof profileService.haschoosen||2!=profileService.haschoosen)askAndExit();else{var currentState=arrHistory.pop();if(currentState&&""!=currentState.from){var parent_state=$state.get("^");if(parent_state.name)$deepStateRedirect.reset(parent_state.name),$state.go(parent_state);else{var targetState=$state.get(currentState.from);targetState.modal||"walletHome"==currentState.to&&"walletHome"==$rootScope.tab?(arrHistory.push(currentState),askAndExit()):currentState.from.indexOf(currentState.to)!=-1?go.walletHome():$state.go(currentState.from,currentState.fromParams)}}else arrHistory.push(currentState),askAndExit()}}function askAndExit(){shownExitMessage?navigator.app.exitApp():(shownExitMessage=!0,window.plugins.toast.showShortBottom(gettextCatalog.getString("Press again to exit")),$timeout(function(){shownExitMessage=!1},2e3))}function clearHistory(){arrHistory.splice(1)}var root={};root.menuOpened=!1,root.dontDeletePath=!1;var arrHistory=[],body=$document.find("body").eq(0),shownExitMessage=!1;return $rootScope.$on("$stateChangeSuccess",function(event,to,toParams,from,fromParams){lastState=arrHistory.length?arrHistory[arrHistory.length-1]:null,"correspondentDevices"!=to.name&&"mywallet"!=to.name||(arrHistory=[],arrHistory.push({to:to.name,toParams:toParams,from:"",fromParams:fromParams})),""!=from.name&&(!lastState||to.name==lastState.to&&lodash.isEqual(toParams,lastState.toParams))||"correspondentDevices"!=to.name&&"mywallet"!=to.name&&arrHistory.push({to:to.name,toParams:toParams,from:from.name,fromParams:fromParams}),"walletHome"==to.name&&$rootScope.$emit("Local/SetTab","walletHome",!0),root.menuOpened=!1}),document.addEventListener("backbutton",back,!1),root.back=back,root.arrHistory=arrHistory,root.clearHistory=clearHistory,root}),angular.module("copayApp.services").factory("backupService",function($log,$timeout,profileService,sjcl){var root={},_download=function(ew,filename,cb){var NewBlob=function(data,datatype){var out;try{out=new Blob([data],{type:datatype}),$log.debug("case 1")}catch(e){if(window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,"TypeError"==e.name&&window.BlobBuilder){var bb=new BlobBuilder;bb.append(data),out=bb.getBlob(datatype),$log.debug("case 2")}else"InvalidStateError"==e.name?(out=new Blob([data],{type:datatype}),$log.debug("case 3")):$log.debug("Errore")}return out},a=document.createElement("a");document.body.appendChild(a),a.style.display="none";var blob=new NewBlob(ew,"text/plain;charset=utf-8"),url=window.URL.createObjectURL(blob);return a.href=url,a.download=filename,a.click(),$timeout(function(){window.URL.revokeObjectURL(url)},250),cb()};return root.addMetadata=function(b,opts){return b=JSON.parse(b),opts.historyCache&&(b.historyCache=opts.historyCache),opts.addressBook&&(b.addressBook=opts.addressBook),JSON.stringify(b)},root.walletExport=function(password,opts){if(!password)return null;var fc=profileService.focusedClient;try{opts=opts||{};var b=fc["export"](opts);(opts.historyCache||opts.addressBook)&&(b=root.addMetadata(b,opts));var e=sjcl.encrypt(password,b,{iter:1e4});return e}catch(err){return $log.debug("Error exporting wallet: ",err),null}},root.walletDownload=function(password,opts,cb){var fc=profileService.focusedClient,ew=root.walletExport(password,opts);if(!ew)return cb("Could not create backup");var walletName=(fc.alias||"")+(fc.alias?"-":"")+fc.credentials.walletName;opts.noSign&&(walletName+="-noSign");var filename=walletName+"-Copaybackup.aes.json";_download(ew,filename,cb)},root}),angular.module("copayApp.services").factory("bitcore",function(bwcService){var bitcore=bwcService.getBitcore();return bitcore}),angular.module("copayApp.services").factory("configService",function(storageService,lodash,$log,isCordova){function migrateLocalConfig(localConfig){if(localConfig){try{var _config=JSON.parse(localConfig)}catch(err){var _config={}}_config.wallet||(_config.wallet=defaultConfig.wallet),_config.wallet.settings.unitCode||(_config.wallet.settings.unitCode=defaultConfig.wallet.settings.unitCode),_config.wallet.settings.unitValue||(_config.wallet.settings.unitToBytes?_config.wallet.settings.unitValue=_config.wallet.settings.unitToBytes:_config.wallet.settings.unitValue=defaultConfig.wallet.settings.unitValue),_config.wallet.settings.bbUnitName||(_config.wallet.settings.bbUnitName=defaultConfig.wallet.settings.bbUnitName),_config.wallet.settings.bbUnitValue||(_config.wallet.settings.bbUnitValue=defaultConfig.wallet.settings.bbUnitValue),_config.wallet.settings.bbUnitDecimals||(_config.wallet.settings.bbUnitDecimals=defaultConfig.wallet.settings.bbUnitDecimals),_config.wallet.settings.bbUnitCode||(_config.wallet.settings.bbUnitCode=defaultConfig.wallet.settings.bbUnitCode),_config.pushNotifications||(_config.pushNotifications=defaultConfig.pushNotifications),_config.hub||(_config.hub=defaultConfig.hub),_config.deviceName||(_config.deviceName=defaultConfig.getDeviceName()),checkAndReplaceOldUnitCode(_config.wallet.settings)}else _config=lodash.clone(defaultConfig),_config.deviceName=defaultConfig.getDeviceName();return _config}function checkAndReplaceOldUnitCode(setting){switch(setting.unitCode){case"byte":setting.unitCode="one",setting.unitValue=1;break;case"kB":setting.unitCode="kilo",setting.unitValue=1e3;break;case"MB":setting.unitCode="mega",setting.unitValue=1e6;break;case"GB":setting.unitCode="giga",setting.unitValue=1e9}}var root={};root.colorOpts=["#0095ff","#0745bc","#DD4B39","#F38F12","#FAA77F","#FADA58","#9EDD72","#77DADA","#4A90E2","#484ED3","#9B59B6","#E856EF","#FF599E","#7A8C9E"];var constants=require("trustnote-common/constants.js");constants.version.match(/t$/);root.TIMESTAMPER_ADDRESS="Q24ZGPFDUG7OCJJF7LA4PUIKSHQ4D4QG",root.oracles={FOPUBEUPBC6YLIQDLKL6EW775BMV7YOH:{name:"Bitcoin Oracle",feednames_filter:["^bitcoin_merkle$","^random[\\d]+$"],feedvalues_filter:["^[13][a-km-zA-HJ-NP-Z1-9]{25,34}\\:[0-9\\.]+$","^\\d{1,6}$"]},JPQKPRI5FMTQRJF4ZZMYZYDQVRD55OTC:{name:"Crypto exchange rates",feednames_filter:["^[\\dA-Z]+_[\\dA-Z]+$"],feedvalues_filter:["^[\\d\\.]+$"]},GFK3RDAPQLLNCMQEVGGD2KCPZTLSG3HN:{name:"Flight delay tracker",feednames_filter:["^[\\w\\d]+-\\d{4}-\\d{2}-\\d{2}$"],feedvalues_filter:["^[\\d]+$"]},TKT4UESIKTTRALRRLWS4SENSTJX6ODCW:{name:"Sports betting on soccer",feednames_filter:["^[\\w\\d]+_[\\w\\d]+_\\d{4}-\\d{2}-\\d{2}$"],feedvalues_filter:["^[\\w\\d]+$"]},I2ADHGP4HL6J37NQAD73J7E5SKFIXJOT:{name:"Timestamp",feednames_filter:["^timestamp$"],feedvalues_filter:["^\\d{13,}$"]}},root.hub=["shawtest.trustnote.org","raytest.trustnote.org"],root.stableHub="raytest.trustnote.org/tn";var defaultConfig={limits:{totalCosigners:6},hub:root.hub[Math.floor(Math.random()*root.hub.length)],getDeviceName:function(){return isCordova?cordova.plugins.deviceName.name:require("os").hostname()},wallet:{requiredCosigners:2,totalCosigners:3,spendUnconfirmed:!1,reconnectDelay:5e3,idleDurationMin:4,settings:{unitName:"MN",unitValue:1e6,unitDecimals:6,unitCode:"mega",bbUnitName:"blacknotes",bbUnitValue:1,bbUnitDecimals:0,bbUnitCode:"one",alternativeName:"US Dollar",alternativeIsoCode:"USD"}},rates:{url:"https://insight.bitpay.com:443/api/rates"},pushNotifications:{enabled:!0,config:{android:{icon:"push",iconColor:"#2F4053"},ios:{alert:"true",badge:"true",sound:"true"},windows:{}}},autoUpdateWitnessesList:!0},configCache=null;return root.getSync=function(){if(!configCache)throw new Error("configService#getSync called when cache is not initialized");return configCache},root.get=function(cb){storageService.getConfig(function(err,localConfig){return configCache=migrateLocalConfig(localConfig),$log.debug("Preferences read:",configCache),cb(err,configCache)})},root.set=function(newOpts,cb){var config=defaultConfig;storageService.getConfig(function(err,oldOpts){if(lodash.isString(oldOpts)&&(oldOpts=JSON.parse(oldOpts)),lodash.isString(config)&&(config=JSON.parse(config)),lodash.isString(newOpts))try{newOpts=JSON.parse(newOpts)}catch(e){newOpts=oldOpts}lodash.merge(config,oldOpts,newOpts),checkAndReplaceOldUnitCode(config.wallet.settings),configCache=config,storageService.storeConfig(JSON.stringify(config),cb)})},root.reset=function(cb){configCache=lodash.clone(defaultConfig),storageService.removeConfig(cb)},root.getDefaults=function(){return lodash.clone(defaultConfig)},window.config?configCache=migrateLocalConfig(window.config):root.get(function(){}),root}),angular.module("copayApp.services").factory("confirmDialog",function($log,$timeout,gettextCatalog,isCordova){var root={},acceptMsg=gettextCatalog.getString("Accept"),cancelMsg=gettextCatalog.getString("Cancel"),confirmMsg=gettextCatalog.getString("Confirm");return root.show=function(msg,cb){return isCordova?void navigator.notification.confirm(msg,function(buttonIndex){return 1!=buttonIndex?cb(!1):void $timeout(function(){return cb(!0)},1)},confirmMsg,[acceptMsg,cancelMsg]):cb(confirm(msg))},root});var constants=require("trustnote-common/constants.js"),eventBus=require("trustnote-common/event_bus.js"),ValidationUtils=require("trustnote-common/validation_utils.js"),objectHash=require("trustnote-common/object_hash.js");angular.module("copayApp.services").factory("correspondentListService",function($state,$rootScope,$sce,$compile,configService,storageService,profileService,go,lodash,$stickyState,$deepStateRedirect,$timeout,gettext){
function addIncomingMessageEvent(from_address,body,message_counter){var walletGeneral=require("trustnote-common/wallet_general.js");walletGeneral.readMyAddresses(function(arrMyAddresses){body=highlightActions(escapeHtml(body),arrMyAddresses),body=text2html(body),console.log("body with markup: "+body),addMessageEvent(!0,from_address,body,message_counter)})}function addMessageEvent(bIncoming,peer_address,body,message_counter,skip_history_load){if(!root.messageEventsByCorrespondent[peer_address]&&!skip_history_load)return loadMoreHistory({device_address:peer_address},function(){addMessageEvent(bIncoming,peer_address,body,message_counter,!0)});bIncoming&&(peer_address in $rootScope.newMessagesCount?$rootScope.newMessagesCount[peer_address]++:$rootScope.newMessagesCount[peer_address]=1,1!=$rootScope.newMessagesCount[peer_address]||$state.is("correspondentDevices.correspondentDevice")&&root.currentCorrespondent.device_address==peer_address||root.messageEventsByCorrespondent[peer_address].push({bIncoming:!1,message:"new messages",type:"system",new_message_delim:!0}));var msg_obj={bIncoming:bIncoming,message:body,timestamp:Math.floor(Date.now()/1e3),message_counter:message_counter};checkAndInsertDate(root.messageEventsByCorrespondent[peer_address],msg_obj),insertMsg(root.messageEventsByCorrespondent[peer_address],msg_obj),$state.is("walletHome")&&"walletHome"==$rootScope.tab?setCurrentCorrespondent(peer_address,function(bAnotherCorrespondent){$stickyState.reset("correspondentDevices.correspondentDevice"),go.path("correspondentDevices.correspondentDevice")}):$rootScope.$digest()}function insertMsg(messages,msg_obj){for(var i=messages.length-1;i>=0&&msg_obj.message_counter;i--){var message=messages[i];if(void 0===message.message_counter||message.message_counter&&msg_obj.message_counter>message.message_counter)return void messages.splice(i+1,0,msg_obj)}messages.push(msg_obj)}function highlightActions(text,arrMyAddresses){return text.replace(/\b[2-7A-Z]{32}\b(?!(\?(amount|asset|device_address)|"))/g,function(address){return ValidationUtils.isValidAddress(address)?'<a dropdown-toggle="#pop'+address+'">'+address+'</a><ul id="pop'+address+'" class="f-dropdown" style="left:0px" data-dropdown-content><li><a ng-click="sendPayment(\''+address+"')\" translate>Pay to this address</a></li></ul>":address}).replace(payment_request_regexp,function(str,address,query_string){if(!ValidationUtils.isValidAddress(address))return str;var objPaymentRequest=parsePaymentRequestQueryString(query_string);return objPaymentRequest?"<a ng-click=\"sendPayment('"+address+"', "+objPaymentRequest.amount+", '"+objPaymentRequest.asset+"', '"+objPaymentRequest.device_address+"')\">"+objPaymentRequest.amountStr+"</a>":str}).replace(/\[(.+?)\]\(command:(.+?)\)/g,function(str,description,command){return"<a ng-click=\"sendCommand('"+escapeQuotes(command)+"', '"+escapeQuotes(description)+'\')" class="command">'+description+"</a>"}).replace(/\[(.+?)\]\(payment:(.+?)\)/g,function(str,description,paymentJsonBase64){var arrMovements=getMovementsFromJsonBase64PaymentRequest(paymentJsonBase64,!0);return arrMovements?(description="Payment request: "+arrMovements.join(", "),"<a ng-click=\"sendMultiPayment('"+paymentJsonBase64+"')\">"+description+"</a>"):"[invalid payment request]"}).replace(/\[(.+?)\]\(vote:(.+?)\)/g,function(str,description,voteJsonBase64){var objVote=getVoteFromJsonBase64(voteJsonBase64);return objVote?"<a ng-click=\"sendVote('"+voteJsonBase64+"')\">"+objVote.choice+"</a>":"[invalid vote request]"}).replace(/\bhttps?:\/\/\S+/g,function(str){return"<a ng-click=\"openExternalLink('"+escapeQuotes(str)+'\')" class="external-link">'+str+"</a>"})}function getMovementsFromJsonBase64PaymentRequest(paymentJsonBase64,bAggregatedByAsset){var paymentJson=Buffer(paymentJsonBase64,"base64").toString("utf8");console.log(paymentJson);try{var objMultiPaymentRequest=JSON.parse(paymentJson)}catch(e){return null}if(objMultiPaymentRequest.definitions)for(var destinationAddress in objMultiPaymentRequest.definitions){var arrDefinition=objMultiPaymentRequest.definitions[destinationAddress].definition;if(destinationAddress!==objectHash.getChash160(arrDefinition))return null}try{var assocPaymentsByAsset=getPaymentsByAsset(objMultiPaymentRequest)}catch(e){return null}var arrMovements=[];if(bAggregatedByAsset)for(var asset in assocPaymentsByAsset)arrMovements.push(getAmountText(assocPaymentsByAsset[asset],asset));else arrMovements=objMultiPaymentRequest.payments.map(function(objPayment){return getAmountText(objPayment.amount,objPayment.asset||"base")+" to "+objPayment.address});return arrMovements}function getVoteFromJsonBase64(voteJsonBase64){var voteJson=Buffer(voteJsonBase64,"base64").toString("utf8");console.log(voteJson);try{var objVote=JSON.parse(voteJson)}catch(e){return null}return ValidationUtils.isStringOfLength(objVote.poll_unit,44)&&"string"==typeof objVote.choice?objVote:null}function getPaymentsByAsset(objMultiPaymentRequest){var assocPaymentsByAsset={};return objMultiPaymentRequest.payments.forEach(function(objPayment){var asset=objPayment.asset||"base";if("base"!==asset&&!ValidationUtils.isValidBase64(asset,constants.HASH_LENGTH))throw Error("asset "+asset+" is not valid");if(!ValidationUtils.isPositiveInteger(objPayment.amount))throw Error("amount "+objPayment.amount+" is not valid");assocPaymentsByAsset[asset]||(assocPaymentsByAsset[asset]=0),assocPaymentsByAsset[asset]+=objPayment.amount}),assocPaymentsByAsset}function formatOutgoingMessage(text){return escapeHtmlAndInsertBr(text).replace(payment_request_regexp,function(str,address,query_string){if(!ValidationUtils.isValidAddress(address))return str;var objPaymentRequest=parsePaymentRequestQueryString(query_string);return objPaymentRequest?"<i>"+objPaymentRequest.amountStr+" to "+address+"</i>":str}).replace(/\[(.+?)\]\(payment:(.+?)\)/g,function(str,description,paymentJsonBase64){var arrMovements=getMovementsFromJsonBase64PaymentRequest(paymentJsonBase64);return arrMovements?"<i>Payment request: "+arrMovements.join(", ")+"</i>":"[invalid payment request]"}).replace(/\[(.+?)\]\(vote:(.+?)\)/g,function(str,description,voteJsonBase64){var objVote=getVoteFromJsonBase64(voteJsonBase64);return objVote?"<i>Vote request: "+objVote.choice+"</i>":"[invalid vote request]"}).replace(/\bhttps?:\/\/\S+/g,function(str){return"<a ng-click=\"openExternalLink('"+escapeQuotes(str)+'\')" class="external-link">'+str+"</a>"})}function parsePaymentRequestQueryString(query_string){var URI=require("trustnote-common/uri.js"),assocParams=URI.parseQueryString(query_string,"&amp;"),strAmount=assocParams.amount;if(!strAmount)return null;var amount=parseInt(strAmount);if(amount+""!==strAmount)return null;if(!ValidationUtils.isPositiveInteger(amount))return null;var asset=assocParams.asset||"base";if(console.log("asset="+asset),"base"!==asset&&!ValidationUtils.isValidBase64(asset,constants.HASH_LENGTH))return null;var device_address=assocParams.device_address||"";if(device_address&&!ValidationUtils.isValidDeviceAddress(device_address))return null;var amountStr="Payment request: "+getAmountText(amount,asset);return{amount:amount,asset:asset,device_address:device_address,amountStr:amountStr}}function text2html(text){return text.replace(/\r/g,"").replace(/\n/g,"<br>").replace(/\t/g," &nbsp; &nbsp; ")}function escapeHtml(text){return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function escapeHtmlAndInsertBr(text){return text2html(escapeHtml(text))}function escapeQuotes(text){return text.replace(/(['\\])/g,"\\$1").replace(/"/g,"&quot;")}function setCurrentCorrespondent(correspondent_device_address,onDone){root.currentCorrespondent&&correspondent_device_address===root.currentCorrespondent.device_address?onDone(!1):device.readCorrespondent(correspondent_device_address,function(correspondent){root.currentCorrespondent=correspondent,onDone(!0)})}function getAmountText(amount,asset){if("base"===asset){var walletSettings=configService.getSync().wallet.settings,unitValue=walletSettings.unitValue,unitName=walletSettings.unitName;return"all"!==amount&&(amount/=unitValue),amount+" "+unitName}if(asset===constants.BLACKBYTES_ASSET){var walletSettings=configService.getSync().wallet.settings,bbUnitValue=walletSettings.bbUnitValue,bbUnitName=walletSettings.bbUnitName;return amount/=bbUnitValue,amount+" "+bbUnitName}return amount+" of "+asset}function getHumanReadableDefinition(arrDefinition,arrMyAddresses,arrMyPubKeys,bWithLinks){function parse(arrSubdefinition){var op=arrSubdefinition[0],args=arrSubdefinition[1];switch(op){case"sig":var pubkey=args.pubkey;return"signed by "+(arrMyPubKeys.indexOf(pubkey)>=0?"you":"public key "+pubkey);case"address":var address=args;return"signed by "+(arrMyAddresses.indexOf(address)>=0?"you":address);case"cosigned by":var address=args;return"co-signed by "+(arrMyAddresses.indexOf(address)>=0?"you":address);case"not":return'<span class="size-18">not</span>'+parseAndIndent(args);case"or":case"and":return args.map(parseAndIndent).join('<span class="size-18">'+op+"</span>");case"r of set":return"at least "+args.required+" of the following is true:<br>"+args.set.map(parseAndIndent).join(",");case"weighted and":return"the total weight of the true conditions below is at least "+args.required+":<br>"+args.set.map(function(arg){return arg.weight+": "+parseAndIndent(arg.value)}).join(",");case"in data feed":var arrAddresses=args[0],feed_name=args[1],relation=args[2],value=args[3],min_mci=args[4];if("timestamp"===feed_name&&">"===relation)return"after "+("number"==typeof value?new Date(value).toString():value);var str="Oracle "+arrAddresses.join(", ")+" posted "+feed_name+" "+relation+" "+value;return min_mci&&(str+=" after MCI "+min_mci),str;case"in merkle":var arrAddresses=args[0],feed_name=args[1],value=args[2],min_mci=args[3],str="A proof is provided that oracle "+arrAddresses.join(", ")+" posted "+value+" in "+feed_name;return min_mci&&(str+=" after MCI "+min_mci),str;case"has":return"output"===args.what&&args.asset&&args.amount_at_least&&args.address?"sends at least "+getAmountText(args.amount_at_least,args.asset)+" to "+(arrMyAddresses.indexOf(args.address)>=0?"you":args.address):"output"===args.what&&args.asset&&args.amount&&args.address?"sends "+getAmountText(args.amount,args.asset)+" to "+(arrMyAddresses.indexOf(args.address)>=0?"you":args.address):JSON.stringify(arrSubdefinition);case"seen":if("output"===args.what&&args.asset&&args.amount&&args.address){var dest_address="this address"===args.address?objectHash.getChash160(arrDefinition):args.address,bOwnAddress=arrMyAddresses.indexOf(args.address)>=0,display_dest_address=bOwnAddress?"you":args.address,expected_payment=getAmountText(args.amount,args.asset)+" to "+display_dest_address;return"there was a transaction that sends "+(bWithLinks&&!bOwnAddress?"<a ng-click=\"sendPayment('"+dest_address+"', "+args.amount+", '"+args.asset+"')\">"+expected_payment+"</a>":expected_payment)}if("input"===args.what&&(args.asset&&args.amount||!args.asset&&!args.amount)&&args.address){var how_much=args.asset&&args.amount?getAmountText(args.amount,args.asset):"";return"there was a transaction that spends "+how_much+" from "+args.address}return JSON.stringify(arrSubdefinition);default:return JSON.stringify(arrSubdefinition)}}function parseAndIndent(arrSubdefinition){return'<div class="indent">'+parse(arrSubdefinition)+"</div>\n"}return parse(arrDefinition,0)}function loadMoreHistory(correspondent,cb){if(historyEndForCorrespondent[correspondent.device_address])return void(cb&&cb());root.messageEventsByCorrespondent[correspondent.device_address]||(root.messageEventsByCorrespondent[correspondent.device_address]=[]);var messageEvents=root.messageEventsByCorrespondent[correspondent.device_address],limit=10,last_msg_ts=null,last_msg_id=90071992547411;messageEvents.length&&messageEvents[0].id&&(last_msg_ts=new Date(1e3*messageEvents[0].timestamp),last_msg_id=messageEvents[0].id),chatStorage.load(correspondent.device_address,last_msg_id,limit,function(messages){for(var i in messages)messages[i]=parseMessage(messages[i]);var walletGeneral=require("trustnote-common/wallet_general.js");walletGeneral.readMyAddresses(function(arrMyAddresses){messages.length<limit&&(historyEndForCorrespondent[correspondent.device_address]=!0);for(var i in messages){var message=messages[i],msg_ts=new Date(message.creation_date.replace(" ","T")+".000Z");last_msg_ts&&last_msg_ts.getDay()!=msg_ts.getDay()&&messageEvents.unshift({type:"system",bIncoming:!1,message:last_msg_ts.toLocaleDateString(),timestamp:Math.floor(msg_ts.getTime()/1e3)}),last_msg_ts=msg_ts,"text"==message.type&&(message.is_incoming?(message.message=highlightActions(escapeHtml(message.message),arrMyAddresses),message.message=text2html(message.message)):message.message=formatOutgoingMessage(message.message)),messageEvents.unshift({id:message.id,type:message.type,bIncoming:message.is_incoming,message:message.message,timestamp:Math.floor(msg_ts.getTime()/1e3),chat_recording_status:message.chat_recording_status})}historyEndForCorrespondent[correspondent.device_address]&&messageEvents.length>1&&messageEvents.unshift({type:"system",bIncoming:!1,message:(last_msg_ts?last_msg_ts:new Date).toLocaleDateString(),timestamp:Math.floor((last_msg_ts?last_msg_ts:new Date).getTime()/1e3)}),$rootScope.$digest(),cb&&cb()})})}function checkAndInsertDate(messageEvents,message){if(0!=messageEvents.length&&"undefined"!=typeof messageEvents[messageEvents.length-1].timestamp){var msg_ts=new Date(1e3*message.timestamp),last_msg_ts=new Date(1e3*messageEvents[messageEvents.length-1].timestamp);last_msg_ts.getDay()!=msg_ts.getDay()&&messageEvents.push({type:"system",bIncoming:!1,message:msg_ts.toLocaleDateString(),timestamp:Math.floor(msg_ts.getTime()/1e3)})}}function parseMessage(message){switch(message.type){case"system":message.message=JSON.parse(message.message),message.message="chat recording",message.chat_recording_status=!0}return message}var root={},device=require("trustnote-common/device.js"),chatStorage=(require("trustnote-common/wallet.js"),require("trustnote-common/chat_storage.js"));if($rootScope.newMessagesCount={},$rootScope.newMsgCounterEnabled=!1,"undefined"!=typeof nw){var win=nw.Window.get();win.on("focus",function(){$rootScope.newMsgCounterEnabled=!1}),win.on("blur",function(){$rootScope.newMsgCounterEnabled=!0}),$rootScope.$watch("newMessagesCount",function(counters){var sum=lodash.sum(lodash.values(counters));sum?win.setBadgeLabel(""+sum):win.setBadgeLabel("")},!0)}$rootScope.$watch("newMessagesCount",function(counters){$rootScope.totalNewMsgCnt=lodash.sum(lodash.values(counters))},!0);var payment_request_regexp=/\[.*?\]\(TTT:([0-9A-Z]{32})\?([\w=&;+%]+)\)/g,historyEndForCorrespondent={};return eventBus.on("text",function(from_address,body,message_counter){device.readCorrespondent(from_address,function(correspondent){root.messageEventsByCorrespondent[correspondent.device_address]||loadMoreHistory(correspondent),addIncomingMessageEvent(correspondent.device_address,body,message_counter),correspondent.my_record_pref&&correspondent.peer_record_pref&&chatStorage.store(from_address,body,1)})}),eventBus.on("chat_recording_pref",function(correspondent_address,enabled,message_counter){device.readCorrespondent(correspondent_address,function(correspondent){var oldState=correspondent.peer_record_pref&&correspondent.my_record_pref;correspondent.peer_record_pref=enabled;var newState=correspondent.peer_record_pref&&correspondent.my_record_pref;if(device.updateCorrespondentProps(correspondent),newState!=oldState){root.messageEventsByCorrespondent[correspondent_address]||(root.messageEventsByCorrespondent[correspondent_address]=[]);var message={type:"system",message:JSON.stringify({state:newState}),timestamp:Math.floor(Date.now()/1e3),chat_recording_status:!0,message_counter:message_counter};insertMsg(root.messageEventsByCorrespondent[correspondent_address],parseMessage(message)),$rootScope.$digest(),chatStorage.store(correspondent_address,JSON.stringify({state:newState}),0,"system")}root.currentCorrespondent&&root.currentCorrespondent.device_address==correspondent_address&&(root.currentCorrespondent.peer_record_pref=enabled?1:0)})}),eventBus.on("sent_payment",function(peer_address,amount,asset,bToSharedAddress){var title=bToSharedAddress?"Payment to smart address":"Payment";setCurrentCorrespondent(peer_address,function(bAnotherCorrespondent){var body="<a ng-click=\"showPayment('"+asset+'\')" class="payment">'+title+": "+getAmountText(amount,asset)+"</a>";addMessageEvent(!1,peer_address,body),device.readCorrespondent(peer_address,function(correspondent){correspondent.my_record_pref&&correspondent.peer_record_pref&&chatStorage.store(peer_address,body,0,"html")}),go.path("correspondentDevices.correspondentDevice")})}),eventBus.on("received_payment",function(peer_address,amount,asset,message_counter,bToSharedAddress){var title=bToSharedAddress?"Payment to smart address":"Payment",body="<a ng-click=\"showPayment('"+asset+'\')" class="payment">'+title+": "+getAmountText(amount,asset)+"</a>";addMessageEvent(!0,peer_address,body,message_counter),device.readCorrespondent(peer_address,function(correspondent){correspondent.my_record_pref&&correspondent.peer_record_pref&&chatStorage.store(peer_address,body,1,"html")})}),eventBus.on("paired",function(device_address){return $state.is("correspondentDevices")?$state.reload():void($state.is("correspondentDevices.correspondentDevice")&&root.currentCorrespondent&&device_address===root.currentCorrespondent.device_address&&device.readCorrespondent(device_address,function(correspondent){root.currentCorrespondent.name=correspondent.name,$rootScope.$digest()}))}),eventBus.on("removed_paired_device",function(device_address){return $state.is("correspondentDevices")?$state.reload():void($state.is("correspondentDevices.correspondentDevice")&&root.currentCorrespondent&&device_address===root.currentCorrespondent.device_address&&($deepStateRedirect.reset("correspondentDevices"),go.path("correspondentDevices"),$timeout(function(){$rootScope.$digest()})))}),$rootScope.$on("Local/CorrespondentInvitation",function(event,device_pubkey,device_hub,pairing_secret){console.log("CorrespondentInvitation",device_pubkey,device_hub,pairing_secret),root.acceptInvitation(device_hub,device_pubkey,pairing_secret,function(){})}),root.getPaymentsByAsset=getPaymentsByAsset,root.getAmountText=getAmountText,root.setCurrentCorrespondent=setCurrentCorrespondent,root.formatOutgoingMessage=formatOutgoingMessage,root.getHumanReadableDefinition=getHumanReadableDefinition,root.loadMoreHistory=loadMoreHistory,root.checkAndInsertDate=checkAndInsertDate,root.parseMessage=parseMessage,root.escapeHtmlAndInsertBr=escapeHtmlAndInsertBr,root.addMessageEvent=addMessageEvent,root.list=function(cb){device.readCorrespondents(function(arrCorrespondents){cb(null,arrCorrespondents)})},root.startWaitingForPairing=function(cb){device.startWaitingForPairing(function(pairingInfo){cb(pairingInfo)})},root.acceptInvitation=function(hub_host,device_pubkey,pairing_secret,cb){return device_pubkey===device.getMyDevicePubKey()?cb("cannot pair with myself"):device.isValidPubKey(device_pubkey)?void device.addUnconfirmedCorrespondent(device_pubkey,hub_host,"New",function(device_address){device.startWaitingForPairing(function(reversePairingInfo){device.sendPairingMessage(hub_host,device_pubkey,pairing_secret,reversePairingInfo.pairing_secret,{ifOk:cb,ifError:cb})}),device.readCorrespondent(device_address,function(correspondent){root.currentCorrespondent=correspondent,$state.is("correspondentDevices.correspondentDevice")?($stickyState.reset("correspondentDevices.correspondentDevice"),$state.reload()):go.path("correspondentDevices.correspondentDevice")})}):cb("invalid peer public key")},root.currentCorrespondent=null,root.messageEventsByCorrespondent={},root}),angular.module("copayApp.services").factory("derivationPathHelper",function(lodash){var root={};return root["default"]="m/44'/0'/0'",root.parse=function(str){var arr=str.split("/"),ret={};if("m"!=arr[0])return!1;switch(arr[1]){case"44'":ret.derivationStrategy="BIP44";break;case"48'":ret.derivationStrategy="BIP48";break;default:return!1}switch(arr[2]){case"0'":ret.networkName="livenet";break;case"1'":ret.networkName="testnet";break;default:return!1}var match=arr[3].match(/(\d+)'/);return!!match&&(ret.account=+match[1],ret)},root}),angular.module("copayApp.services").factory("fileStorageService",function(){var fileStorage=require("./fileStorage.js"),root={};return root.get=function(k,cb){fileStorage.get(k,cb)},root.set=function(k,v,cb){fileStorage.set(k,v,cb)},root.remove=function(k,cb){fileStorage.init(function(err,fs,dir){return err?cb(err):void dir.getFile(k,{create:!1},function(fileEntry){fileEntry.remove(function(){return console.log("File removed."),cb()},cb)},cb)})},root.create=function(name,value,callback){fileStorage.get(name,function(err,data){return data?callback("EEXISTS"):fileStorage.set(name,value,callback)})},root}),angular.module("copayApp.services").factory("fileSystemService",function($log,isCordova){function _cordovaWriteFile(dirEntry,name,data,cb){"string"!=typeof data&&(data=data.buffer),dirEntry.getFile(name,{create:!0,exclusive:!1},function(file){file.createWriter(function(writer){writer.onwriteend=function(){cb(null)},writer.write(data)},cb)},cb)}var root={},bFsInitialized=!1,fs=require("fs");try{var desktopApp=require("trustnote-common/desktop_app.js")}catch(e){}return root.init=function(cb){function onFileSystemSuccess(fileSystem){return console.log("File system started: ",fileSystem.name,fileSystem.root.name),bFsInitialized=!0,cb(null)}function fail(evt){var msg="Could not init file system: "+evt.target.error.code;return console.log(msg),cb(msg)}return bFsInitialized?cb(null):void window.requestFileSystem(LocalFileSystem.PERSISTENT,0,onFileSystemSuccess,fail)},root.readFileFromForm=function(file,cb){if(!isCordova)return cb(null,fs.createReadStream(file.path));var reader=new FileReader;reader.onloadend=function(){var fileBuffer=Buffer.from(new Uint8Array(this.result));cb(null,fileBuffer)},reader.readAsArrayBuffer(file)},root.readFile=function(path,cb){isCordova?root.init(function(){window.resolveLocalFileSystemURL(path,function(fileEntry){fileEntry.file(function(file){root.readFileFromForm(file,cb)})},function(e){throw new Error("error: "+JSON.stringify(e))})}):fs.readFile(path,function(err,data){return err?cb(err):cb(null,data)})},root.getPath=function(path,cb){return cb(null,path.replace(/\\/g,"/"))},root.nwWriteFile=function(path,data,cb){isCordova?cb("use cordovaWriteFile"):fs.writeFile(path,data,function(err){return cb(err?err:null)})},root.cordovaWriteFile=function(cordovaFile,path,fileName,data,cb){isCordova?root.init(function(){window.resolveLocalFileSystemURL(cordovaFile,function(dirEntry){path&&"."!=path&&"/"!=path?dirEntry.getDirectory(path,{create:!0,exclusive:!1},function(dirEntry1){_cordovaWriteFile(dirEntry1,fileName,data,cb)},cb):_cordovaWriteFile(dirEntry,fileName,data,cb)},cb)}):cb("use nwWriteFile")},root.readdir=function(path,cb){isCordova?root.init(function(){window.resolveLocalFileSystemURL(path,function(fileSystem){var reader=fileSystem.createReader();reader.readEntries(function(entries){cb(null,entries.map(function(entry){return entry.name}))},function(err){cb(err)})},function(err){cb(err)})}):fs.readdir(path,function(err,entries){return err?cb(err):cb(null,entries)})},root.nwMoveFile=function(oldPath,newPath,cb){var read=fs.createReadStream(oldPath),write=fs.createWriteStream(newPath);read.pipe(write),read.on("end",function(){fs.unlink(oldPath,cb)})},root.nwUnlink=function(path,cb){fs.unlink(path,cb)},root.nwRmDir=function(path,cb){fs.rmdir(path,cb)},root.nwExistsSync=function(path){return fs.existsSync(path)},root.getParentDirPath=function(){if(!isCordova)return!1;switch(window.cordova.platformId){case"ios":return window.cordova.file.applicationStorageDirectory+"/Library";case"android":default:return window.cordova.file.applicationStorageDirectory}},root.getDatabaseDirName=function(){if(!isCordova)return!1;switch(window.cordova.platformId){case"ios":return"LocalDatabase";case"android":default:return"databases"}},root.getDatabaseDirPath=function(){return isCordova?root.getParentDirPath()+"/"+root.getDatabaseDirName():desktopApp.getAppDataDir()},root.recursiveMkdir=function(path,mode,callback){var parentDir=require("path").dirname(path);fs.stat(parentDir,function(err,stats){if(err&&"ENOENT"!==err.code)throw Error("failed to stat dir: "+err);err&&"ENOENT"===err.code?root.recursiveMkdir(parentDir,mode,function(err){err?callback(err):fs.mkdir(path,mode,callback)}):fs.mkdir(path,mode,callback)})},root});var eventBus=require("trustnote-common/event_bus.js");angular.module("copayApp.services").factory("go",function($window,$rootScope,$location,$state,profileService,fileSystemService,nodeWebkit,notification,gettextCatalog,authService,$deepStateRedirect,$stickyState){function handleUri(uri){console.log("handleUri "+uri),require("trustnote-common/uri.js").parseUri(uri,{ifError:function(err){console.log(err),notification.error(err)},ifOk:function(objRequest){if("address"===objRequest.type)root.send(function(){$rootScope.$emit("paymentRequest",objRequest.address,objRequest.amount,objRequest.asset)});else if("ob_walletToPay"===objRequest.type)root.toPay=1,root.objDetail={to_address:objRequest.to_address,amount:objRequest.amount,v:objRequest.v},root.paths=objRequest.path,root.text_to_sign=new Buffer(objRequest.text_to_sign,"base64");else if("pairing"===objRequest.type)$rootScope.$emit("Local/CorrespondentInvitation",objRequest.pubkey,objRequest.hub,objRequest.pairing_secret);else{if("auth"!==objRequest.type)throw Error("unknown url type: "+objRequest.type);authService.objRequest=objRequest,root.path("authConfirmation")}}})}function extractTrustnoteArgFromCommandLine(commandLine){for(var conf=require("trustnote-common/conf.js"),re=new RegExp("^"+conf.program+":","i"),arrParts=commandLine.split(" "),i=0;i<arrParts.length;i++){var part=arrParts[i].trim();if(part.match(re))return part}return null}function registerWindowsProtocolHandler(){}function createLinuxDesktopFile(){console.log("will write .desktop file");var fs=require("fs"),path=require("path"),child_process=require("child_process"),package=require("../package.json"),applicationsDir=process.env.HOME+"/.local/share/applications";fileSystemService.recursiveMkdir(applicationsDir,parseInt("700",8),function(err){console.log("mkdir applications: "+err),fs.writeFile(applicationsDir+"/"+package.name+".desktop","[Desktop Entry]\nType=Application\nVersion=1.0\nName="+package.name+"\nComment="+package.description+"\nExec="+process.execPath.replace(/ /g,"\\ ")+" %u\nIcon="+path.dirname(process.execPath)+"/public/img/icons/icon-white-outline.iconset/icon_256x256.png\nTerminal=false\nCategories=Office;Finance;\nMimeType=x-scheme-handler/"+package.name+";\nX-Ubuntu-Touch=true\nX-Ubuntu-StageHint=SideStage\n",{mode:493},function(err){if(err)throw Error("failed to write desktop file: "+err);child_process.exec("update-desktop-database ~/.local/share/applications",function(err){if(err)throw Error("failed to exec update-desktop-database: "+err);console.log(".desktop done")})})})}var root={};root.toPay=0;var hideSidebars=function(){if("undefined"!=typeof document){var elem=document.getElementById("off-canvas-wrap");elem.className="off-canvas-wrap"}},toggleSidebar=function(invert){if("undefined"!=typeof document){var elem=document.getElementById("off-canvas-wrap"),leftbarActive=elem.className.indexOf("move-right")>=0;invert?profileService.profile&&!$rootScope.hideNavigation&&(elem.className="off-canvas-wrap move-right"):leftbarActive&&hideSidebars()}};root.openExternalLink=function(url,target){if(nodeWebkit.isDefined())nodeWebkit.openExternalLink(url);else{target=target||"_blank";window.open(url,target,"location=no")}},root.path=function(path,cb){$state.go(path).then(function(){if(console.log("transition done "+path),cb)return cb()},function(){if(console.log("transition failed "+path),cb)return cb("animation in progress")})},root.swipe=function(invert){toggleSidebar(invert)},root.walletHome=function(){var fc=profileService.focusedClient;fc&&!fc.isComplete()?root.path("copayers"):root.path("walletHome",function(){$rootScope.$emit("Local/SetTab","walletHome",!0)})},root.send=function(cb){$stickyState.reset("walletHome"),root.path("walletHome",function(){$rootScope.$emit("Local/SetTab","send"),cb&&cb()})},root.wallet=function(){var fc=profileService.focusedClient;fc&&!fc.isComplete()?root.path("copayers"):root.path("mywallet",function(){$rootScope.$emit("Local/SetTab","mywallet",!0)})},root.history=function(cb){root.path("walletHome",function(){$rootScope.$emit("Local/SetTab","walletHome"),cb&&cb()})},root.addWallet=function(){$state.go("add")},root.preferences=function(){$state.go("preferences")},root.preferencesGlobal=function(){$state.go("preferencesGlobal")},root.reload=function(){$state.reload()},$rootScope.go=function(path,resetState){var targetState=$state.get(path);resetState&&$deepStateRedirect.reset(targetState.name),root.path(path)},$rootScope.openExternalLink=function(url,target){root.openExternalLink(url,target)},root.observed=0;var gui;try{gui=require("nw.gui")}catch(e){}if(gui){var removeListenerForOnopen=$rootScope.$on("Local/BalanceUpdatedAndWalletUnlocked",function(){removeListenerForOnopen(),gui.App.on("open",function(commandLine){if(console.log("Open url: "+commandLine),commandLine){var file=extractTrustnoteArgFromCommandLine(commandLine);if(!file)return console.log("no TTT: arg found");handleUri(file),gui.Window.get().focus()}})});if(console.log("argv: "+gui.App.argv),gui.App.argv[0])var removeListener=$rootScope.$on("Local/BalanceUpdatedAndWalletUnlocked",function(){setTimeout(function(){handleUri(gui.App.argv[0])},100),removeListener()});if("win32"===process.platform||"linux"===process.platform)var removeRegListener=$rootScope.$on("Local/BalanceUpdated",function(){setTimeout(function(){"win32"===process.platform?registerWindowsProtocolHandler():createLinuxDesktopFile(),gui.desktop=process.env.HOME+"/.local/share/applications"},200),removeRegListener()})}else if(window.cordova){var removeListener=$rootScope.$on("Local/BalanceUpdatedAndWalletUnlocked",function(){console.log("setting permanent handleOpenURL"),window.handleOpenURL=handleUri,window.open_url&&(console.log("using cached open url "+window.open_url),setTimeout(function(){handleUri(window.open_url)},100)),removeListener()});document.addEventListener("resume",function(){console.log("resume"),$rootScope.$emit("Local/Resume")},!1)}return root.handleUri=handleUri,root}).factory("$exceptionHandler",function($log){return function(exception,cause){console.log("angular $exceptionHandler"),$log.error(exception,cause),eventBus.emit("uncaught_error","An exception occurred: "+exception+"; cause: "+cause,exception)}}),console.log("parsing go.js"),window.cordova&&(console.log("go file: setting temp handleOpenURL"),window.handleOpenURL=tempHandleUri),process.on("uncaughtException",function(e){console.log("uncaughtException"),eventBus.emit("uncaught_error","Uncaught exception: "+e,e)});var logs=[];angular.module("copayApp.services").factory("historicLog",function(){var root={};return root.add=function(level,msg){logs.push({level:level,msg:msg})},root.get=function(){return logs},root}),angular.module("copayApp.services").value("isCordova",!!window.cordova);var isMobile={Android:function(){return!!navigator.userAgent.match(/Android/i)},BlackBerry:function(){return!!navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return!!navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return!!navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return!!navigator.userAgent.match(/IEMobile/i)},Safari:function(){return Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0},any:function(){return isMobile.Android()||isMobile.BlackBerry()||isMobile.iOS()||isMobile.Opera()||isMobile.Windows();
}};angular.module("copayApp.services").value("isMobile",isMobile),angular.module("copayApp.services").factory("localStorageService",function($timeout){var root={},ls="undefined"!=typeof window.localStorage?window.localStorage:null;if(!ls)throw new Error("localstorage not available");return root.get=function(k,cb){return cb(null,ls.getItem(k))},root.create=function(name,value,callback){root.get(name,function(err,data){return data?callback("EEXISTS"):root.set(name,value,callback)})},root.set=function(k,v,cb){return ls.setItem(k,v),cb()},root.remove=function(k,cb){return ls.removeItem(k),cb()},root}),angular.module("copayApp.services").factory("logHeader",function($log,isCordova,nodeWebkit){return $log.info("Starting Trustnote v"+window.version+" #"+window.commitHash),$log.info("Client: isCordova:",isCordova,"isNodeWebkit:",nodeWebkit.isDefined()),$log.info("Navigator:",navigator.userAgent),{}});var eventBus=require("trustnote-common/event_bus.js");angular.module("copayApp.services").factory("newVersion",function(storageService){var root={};return root.showUpdate=0,eventBus.on("new_version",function(ws,data){root.hasChoosen=0,storageService.gethaschoosen(function(err,val){root.hasChoosen=val,2!=root.hasChoosen}),data.msg&&("string"==typeof data.msg&&(root.msg=JSON.parse(data.msg)),root.msg=data.msg),0==root.showUpdate&&(root.showUpdate=1)}),root}),angular.module("copayApp.services").factory("nodeWebkit",function(){var root={},isNodeWebkit=function(){var isNode="undefined"!=typeof process&&"undefined"!=typeof require;if(isNode)try{return"undefined"!=typeof require("nw.gui")}catch(e){return!1}};return root.isDefined=function(){return isNodeWebkit()},root.readFromClipboard=function(){if(isNodeWebkit()){var gui=require("nw.gui"),clipboard=gui.Clipboard.get();return clipboard.get()}},root.writeToClipboard=function(text){if(isNodeWebkit()){var gui=require("nw.gui"),clipboard=gui.Clipboard.get();return clipboard.set(text)}},root.openExternalLink=function(url){if(isNodeWebkit()){var gui=require("nw.gui");return gui.Shell.openExternal(url)}},root}),angular.module("copayApp.services").factory("notification",["$timeout",function($timeout){function html5Notify(icon,title,content,ondisplay,onclose){if(window.webkitNotifications&&0===window.webkitNotifications.checkPermission()){icon||(icon="img/icons/favicon-white.ico");var noti=window.webkitNotifications.createNotification(icon,title,content);"function"==typeof ondisplay&&(noti.ondisplay=ondisplay),"function"==typeof onclose&&(noti.onclose=onclose),noti.show()}else settings.html5Mode=!1}var notifications=[],queue=[],settings={info:{duration:6e3,enabled:!0},funds:{duration:7e3,enabled:!0},version:{duration:6e4,enabled:!0},warning:{duration:7e3,enabled:!0},error:{duration:7e3,enabled:!0},success:{duration:5e3,enabled:!0},progress:{duration:0,enabled:!0},custom:{duration:35e3,enabled:!0},details:!0,localStorage:!1,html5Mode:!1,html5DefaultIcon:"img/icons/favicon-white.ico"};return{disableHtml5Mode:function(){settings.html5Mode=!1},disableType:function(notificationType){settings[notificationType].enabled=!1},enableHtml5Mode:function(){settings.html5Mode=this.requestHtml5ModePermissions()},enableType:function(notificationType){settings[notificationType].enabled=!0},getSettings:function(){return settings},toggleType:function(notificationType){settings[notificationType].enabled=!settings[notificationType].enabled},toggleHtml5Mode:function(){settings.html5Mode=!settings.html5Mode},requestHtml5ModePermissions:function(){return!!window.webkitNotifications&&(0===window.webkitNotifications.checkPermission()||(window.webkitNotifications.requestPermission(function(){0===window.webkitNotifications.checkPermission()?settings.html5Mode=!0:settings.html5Mode=!1}),!1))},getAll:function(){return notifications},getQueue:function(){return queue},info:function(title,content,userData){return this.awesomeNotify("info","fi-info",title,content,userData)},funds:function(title,content,userData){return this.awesomeNotify("funds","icon-receive",title,content,userData)},version:function(title,content,severe){return this.awesomeNotify("version",severe?"fi-alert":"fi-flag",title,content)},error:function(title,content,userData){return this.awesomeNotify("error","fi-x",title,content,userData)},success:function(title,content,userData){return this.awesomeNotify("success","fi-check",title,content,userData)},warning:function(title,content,userData){return this.awesomeNotify("warning","fi-alert",title,content,userData)},"new":function(title,content,userData){return this.awesomeNotify("warning","fi-plus",title,content,userData)},sent:function(title,content,userData){return this.awesomeNotify("warning","icon-paperplane",title,content,userData)},awesomeNotify:function(type,icon,title,content,userData){return this.makeNotification(type,!1,icon,title,content,userData)},notify:function(image,title,content,userData){return this.makeNotification("custom",image,!0,title,content,userData)},makeNotification:function(type,image,icon,title,content,userData){var notification={type:type,image:image,icon:icon,title:title,content:content,timestamp:+new Date,userData:userData};return notifications.push(notification),settings.html5Mode&&html5Notify(image,title,content,function(){},function(){}),settings.html5Mode||(queue.push(notification),$timeout(function(){queue.splice(queue.indexOf(notification),1)},settings[type].duration)),window&&window.navigator&&window.navigator.vibrate&&window.navigator.vibrate([200,100,200]),!document.hidden||"info"!=type&&"funds"!=type||new window.Notification(title,{body:content,icon:"img/notification.png"}),this.save(),notification},save:function(){settings.localStorage&&localStorage.setItem("notifications",JSON.stringify(notifications))},restore:function(){},clear:function(){notifications=[],this.save()}}}]).directive("notifications",function(notification,$compile){function link(scope,element,attrs){var position=attrs.notifications;position=position.split(" "),element.addClass("dr-notification-container");for(var i=0;i<position.length;i++)element.addClass(position[i])}return{restrict:"A",scope:{},templateUrl:"views/includes/notifications.html",link:link,controller:["$scope",function($scope){$scope.queue=notification.getQueue(),$scope.removeNotification=function(noti){$scope.queue.splice($scope.queue.indexOf(noti),1)}}]}});var breadcrumbs=require("trustnote-common/breadcrumbs.js");angular.module("copayApp.services").factory("profileService",function($rootScope,$location,$timeout,$filter,$log,lodash,storageService,bwcService,configService,pushNotificationsService,isCordova,gettext,gettextCatalog,nodeWebkit,uxLanguage){function saveTempKeys(tempDeviceKey,prevTempDeviceKey,onDone){$timeout(function(){console.log("will save temp device keys"),root.profile.tempDeviceKey=tempDeviceKey.toString("base64"),prevTempDeviceKey&&(root.profile.prevTempDeviceKey=prevTempDeviceKey.toString("base64")),storageService.storeProfile(root.profile,function(err){onDone(err)})})}function unlockWalletAndInitDevice(){breadcrumbs.add("unlockWalletAndInitDevice");var mainSectionElement=angular.element(document.querySelector("#mainSection"));mainSectionElement.css("visibility","hidden");var removeListener=$rootScope.$on("Local/BalanceUpdated",function(){removeListener(),breadcrumbs.add("unlockWalletAndInitDevice BalanceUpdated"),root.insistUnlockFC(null,function(){breadcrumbs.add("unlockWalletAndInitDevice unlocked");var mainSectionElement=angular.element(document.querySelector("#mainSection"));if(mainSectionElement.css("visibility","visible"),!root.focusedClient.credentials.xPrivKey)throw Error("xPrivKey still not set after unlock");var config=configService.getSync();root.focusedClient.initDeviceProperties(root.focusedClient.credentials.xPrivKey,root.profile.my_device_address,config.hub,config.deviceName),$rootScope.$emit("Local/BalanceUpdatedAndWalletUnlocked")})})}var root={};return root.profile=null,root.focusedClient=null,root.walletClients={},root.Utils=bwcService.getUtils(),root.formatAmount=function(amount,asset,opts){var config=configService.getSync().wallet.settings;return"blackbytes"==asset?this.Utils.formatAmount(amount,config.bbUnitCode,opts):"base"==asset?this.Utils.formatAmount(amount,config.unitCode,opts):amount},root._setFocus=function(walletId,option,cb){return $log.debug("Set focus:",walletId),walletId?root.focusedClient=root.walletClients[walletId]:root.focusedClient=[],lodash.isEmpty(root.focusedClient)&&(root.focusedClient=root.walletClients[lodash.keys(root.walletClients)[0]]),lodash.isEmpty(root.focusedClient)?void $rootScope.$emit("Local/NoWallets"):($rootScope.$emit("Local/NewFocusedWallet",option),cb())},root.setAndStoreFocus=function(walletId,option,cb){root._setFocus(walletId,option,function(){storageService.storeFocusedWalletId(walletId,cb)})},root.setWalletClient=function(credentials){if(!root.walletClients[credentials.walletId]||!root.walletClients[credentials.walletId].started){var client=bwcService.getClient(JSON.stringify(credentials));client.credentials.xPrivKey=root.profile.xPrivKey,client.credentials.mnemonic=root.profile.mnemonic,client.credentials.xPrivKeyEncrypted=root.profile.xPrivKeyEncrypted,client.credentials.mnemonicEncrypted=root.profile.mnemonicEncrypted,root.walletClients[credentials.walletId]=client,"observed"in credentials&&(root.walletClients[credentials.walletId].observed=!0),root.walletClients[credentials.walletId].started=!0,client.initialize({},function(err){})}},root.setWalletClients=function(){var credentials=root.profile.credentials;lodash.each(credentials,function(credentials){root.setWalletClient(credentials)}),$rootScope.$emit("Local/WalletListUpdated")},root.bindProfile=function(profile,cb){breadcrumbs.add("bindProfile"),root.profile=profile,configService.get(function(err){return $log.debug("Preferences read"),err?cb(err):(root.setWalletClients(),void storageService.getFocusedWalletId(function(err,focusedWalletId){return err?cb(err):void root._setFocus(focusedWalletId,!0,function(){console.log("focusedWalletId",focusedWalletId),require("trustnote-common/wallet.js");var device=require("trustnote-common/device.js"),config=configService.getSync();root.walletClients[lodash.keys(root.walletClients)[0]];if(root.profile.xPrivKeyEncrypted)console.log("priv key is encrypted, will wait for UI and request password"),unlockWalletAndInitDevice(),device.setDeviceAddress(root.profile.my_device_address),device.setDeviceName(config.deviceName),device.setDeviceHub(config.hub);else{if(!root.profile.xPrivKey)throw Error("neither xPrivKey nor xPrivKeyEncrypted");root.focusedClient.initDeviceProperties(profile.xPrivKey,root.profile.my_device_address,config.hub,config.deviceName)}var tempDeviceKey=Buffer.from(profile.tempDeviceKey,"base64"),prevTempDeviceKey=profile.prevTempDeviceKey?Buffer.from(profile.prevTempDeviceKey,"base64"):null;return device.setTempKeys(tempDeviceKey,prevTempDeviceKey,saveTempKeys),$rootScope.$emit("Local/ProfileBound"),cb()})}))})},root.loadAndBindProfile=function(cb){breadcrumbs.add("loadAndBindProfile"),storageService.gethaschoosen(function(err,val){root.haschoosen=val}),storageService.getDisclaimerFlag(function(err,val){return val?void storageService.getProfile(function(err,profile){return err?($rootScope.$emit("Local/DeviceError",err),cb(err)):profile?($log.debug("Profile read"),root.bindProfile(profile,cb)):(breadcrumbs.add("no profile"),cb(new Error("NOPROFILE: No profile")))}):(breadcrumbs.add("Non agreed disclaimer"),cb(new Error("NONAGREEDDISCLAIMER: Non agreed disclaimer")))})},root._seedWallet=function(opts,cb){opts=opts||{};var walletClient=bwcService.getClient(),network=opts.networkName||"livenet";if(opts.mnemonic)try{opts.mnemonic=root._normalizeMnemonic(opts.mnemonic),walletClient.seedFromMnemonic(opts.mnemonic,{network:network,passphrase:opts.passphrase,account:opts.account||0,derivationStrategy:opts.derivationStrategy||"BIP44"})}catch(ex){return $log.info(ex),cb(gettext("Could not create: Invalid wallet seed"))}else if(opts.extendedPrivateKey)try{walletClient.seedFromExtendedPrivateKey(opts.extendedPrivateKey,opts.account||0)}catch(ex){return $log.warn(ex),cb(gettext("Could not create using the specified extended private key"))}else if(opts.extendedPublicKey)try{walletClient.seedFromExtendedPublicKey(opts.extendedPublicKey,opts.externalSource,opts.entropySource,{account:opts.account||0,derivationStrategy:opts.derivationStrategy||"BIP44"})}catch(ex){return $log.warn("Creating wallet from Extended Public Key Arg:",ex,opts),cb(gettext("Could not create using the specified extended public key"))}else{var lang=uxLanguage.getCurrentLanguage();console.log("will seedFromRandomWithMnemonic for language "+lang);try{walletClient.seedFromRandomWithMnemonic({network:network,passphrase:opts.passphrase,language:lang,account:opts.account||0})}catch(e){if($log.info("Error creating seed: "+e.message),!(e.message.indexOf("language")>0))return cb(e);$log.info("Using default language for mnemonic"),walletClient.seedFromRandomWithMnemonic({network:network,passphrase:opts.passphrase,account:opts.account||0})}}return cb(null,walletClient)},root._createNewProfile=function(opts,cb){return console.log("_createNewProfile"),opts.noWallet?cb(null,Profile.create()):void root._seedWallet({},function(err,walletClient){if(err)return cb(err);var config=configService.getSync();require("trustnote-common/wallet.js");var device=require("trustnote-common/device.js"),tempDeviceKey=device.genPrivKey();walletClient.initDeviceProperties(walletClient.credentials.xPrivKey,null,config.hub,config.deviceName);var walletName=gettextCatalog.getString("TTT Wallet");walletClient.createWallet(walletName,1,1,{network:"livenet"},function(err){if(err)return cb(gettext("Error creating wallet")+": "+err);console.log("created wallet, client: ",JSON.stringify(walletClient));var xPrivKey=walletClient.credentials.xPrivKey,mnemonic=walletClient.credentials.mnemonic;console.log("mnemonic: "+mnemonic+", xPrivKey: "+xPrivKey);var p=Profile.create({credentials:[JSON.parse(walletClient["export"]())],xPrivKey:xPrivKey,mnemonic:mnemonic,tempDeviceKey:tempDeviceKey.toString("base64"),my_device_address:device.getMyDeviceAddress()});return device.setTempKeys(tempDeviceKey,null,saveTempKeys),cb(null,p)})})},root.createWallet=function(opts,cb){if($log.debug("Creating Wallet:",opts),!root.focusedClient.credentials.xPrivKey)return root.unlockFC(null,function(err){return err?cb(err.message):void root.createWallet(opts,cb)}),console.log("need password to create new wallet");var walletDefinedByKeys=require("trustnote-common/wallet_defined_by_keys.js");walletDefinedByKeys.readNextAccount(function(account){if(console.log("next account = "+account),!opts.extendedPrivateKey&&!opts.mnemonic){if(!root.focusedClient.credentials.xPrivKey)throw Error("no root.focusedClient.credentials.xPrivKey");$log.debug("reusing xPrivKey from focused client"),opts.extendedPrivateKey=root.focusedClient.credentials.xPrivKey,opts.mnemonic=root.profile.mnemonic,opts.account=account}root._seedWallet(opts,function(err,walletClient){return err?cb(err):void walletClient.createWallet(opts.name,opts.m,opts.n,{network:opts.networkName,account:opts.account,cosigners:opts.cosigners},function(err){return err?cb(gettext("Error creating wallet")+": "+err):void root._addWalletClient(walletClient,opts,cb)})})})},root.createColdWallet=function(opts,addr,cb){$log.debug("Creating ColdWallet:",opts);var device=require("trustnote-common/device.js");device.setMyColdDeviceAddress(addr);var walletClient=bwcService.getClient();walletClient["import"](JSON.stringify(opts)),walletClient.createWallet(opts.name,opts.m,opts.n,{network:opts.network,account:opts.account,cosigners:opts.cosigners},function(err){return err?cb(gettext("Error creating wallet")+": "+err):(opts.observed=!0,void root._addWalletClient(walletClient,opts,cb))})},root.synchronization=function(opts,cb){if($log.debug("synchronization :",opts),console.log(opts.extendedPrivateKey),!root.focusedClient.credentials.xPrivKey)return root.unlockFC(null,function(err){return err?cb(err.message):void root.createWallet(opts,cb)}),console.log("need password to create new wallet");var walletDefinedByKeys=require("trustnote-common/wallet_defined_by_keys.js");walletDefinedByKeys.readNextAccount(function(account){opts.extendedPrivateKey=root.focusedClient.credentials.xPrivKey,console.log(opts.extendedPrivateKey),root._seedWallet(opts,function(err,walletClient){return err?cb(err):void walletClient.createWallet(opts.name,opts.m,opts.n,{network:opts.networkName,account:opts.account,cosigners:opts.cosigners},function(err){return err?cb(gettext("Error creating wallet")+": "+err):void root._addWalletClient(walletClient,opts,cb)})})})},root.getClient=function(walletId){return root.walletClients[walletId]},root.deleteWallet=function(opts,cb){var client=opts.client||root.focusedClient,walletId=client.credentials.walletId,isObserved=client.observed;$log.debug("Deleting Wallet:",client.credentials.walletName),breadcrumbs.add("Deleting Wallet: "+client.credentials.walletName),root.profile.credentials=lodash.reject(root.profile.credentials,{walletId:walletId}),delete root.walletClients[walletId],root.focusedClient=null,storageService.clearBackupFlag(walletId,function(err){err&&$log.warn(err)}),$timeout(function(){root.setWalletClients(),root.setAndStoreFocus(null,!0,function(){storageService.storeProfile(root.profile,function(err){return err?cb(null,err):cb(isObserved?walletId:null)})})})},root.setMetaData=function(walletClient,addressBook,cb){storageService.getAddressbook(walletClient.credentials.network,function(err,localAddressBook){var localAddressBook1={};try{localAddressBook1=JSON.parse(localAddressBook)}catch(ex){$log.warn(ex)}lodash.merge(addressBook,localAddressBook1);storageService.setAddressbook(walletClient.credentials.network,JSON.stringify(addressBook),function(err){return cb(err?err:null)})})},root._addWalletClient=function(walletClient,opts,cb){var walletId=walletClient.credentials.walletId,w=lodash.find(root.profile.credentials,{walletId:walletId});if(w)return cb(gettext("Wallet already in trustnote: ")+w.walletName);root.profile.credentials.push(JSON.parse(walletClient["export"]())),opts.observed&&(root.profile.credentials[root.profile.credentials.length-1].observed=opts.observed),root.setWalletClients();var color=configService.colorOpts[walletId.charCodeAt(0)%configService.colorOpts.length],configOpts={colorFor:{}};configOpts.colorFor[walletId]=color,configService.set(configOpts,function(err){root.setAndStoreFocus(walletId,!0,function(){storageService.storeProfile(root.profile,function(err){configService.getSync();return cb(err,walletId)})})})},root.importWallet=function(str,opts,cb){var walletClient=bwcService.getClient();$log.debug("Importing Wallet:",opts);try{walletClient["import"](str,{compressed:opts.compressed,password:opts.password})}catch(err){return cb(gettext("Could not import. Check input file and password"))}str=JSON.parse(str);var addressBook=str.addressBook||{};root._addWalletClient(walletClient,opts,function(err,walletId){return err?cb(err):void root.setMetaData(walletClient,addressBook,function(error){return error&&console.log(error),cb(err,walletId)})})},root.importExtendedPrivateKey=function(xPrivKey,opts,cb){var walletClient=bwcService.getClient();$log.debug("Importing Wallet xPrivKey"),walletClient.importFromExtendedPrivateKey(xPrivKey,function(err){return err?cb(gettext("Could not import")+": "+err):void root._addWalletClient(walletClient,opts,cb)})},root._normalizeMnemonic=function(words){var isJA=words.indexOf("")>-1,wordList=words.split(/[\u3000\s]+/);return wordList.join(isJA?"":" ")},root.importMnemonic=function(words,opts,cb){var walletClient=bwcService.getClient();$log.debug("Importing Wallet Mnemonic"),words=root._normalizeMnemonic(words),walletClient.importFromMnemonic(words,{network:opts.networkName,passphrase:opts.passphrase,account:opts.account||0},function(err){return err?cb(gettext("Could not import")+": "+err):void root._addWalletClient(walletClient,opts,cb)})},root.importExtendedPublicKey=function(opts,cb){var walletClient=bwcService.getClient();$log.debug("Importing Wallet XPubKey"),walletClient.importFromExtendedPublicKey(opts.extendedPublicKey,opts.externalSource,opts.entropySource,{account:opts.account||0,derivationStrategy:opts.derivationStrategy||"BIP44"},function(err){return err?("NOT_AUTHORIZED"==err.code&&(err.code="WALLET_DOES_NOT_EXIST"),cb(gettext("Could not import")+": "+err)):void root._addWalletClient(walletClient,opts,cb)})},root.create=function(opts,cb){$log.info("Creating profile",opts);configService.getDefaults();configService.get(function(err){root._createNewProfile(opts,function(err,p){return err?cb(err):void root.bindProfile(p,function(err){storageService.storeNewProfile(p,function(err){return cb(err)})})})})},root.updateCredentialsFC=function(cb){var fc=root.focusedClient,newCredentials=lodash.reject(root.profile.credentials,{walletId:fc.credentials.walletId});newCredentials.push(JSON.parse(fc["export"]())),root.profile.credentials=newCredentials,storageService.storeProfile(root.profile,cb)},root.clearMnemonic=function(cb){delete root.profile.mnemonic,delete root.profile.mnemonicEncrypted;for(var wid in root.walletClients)root.walletClients[wid].clearMnemonic();storageService.storeProfile(root.profile,cb)},root.setPrivateKeyEncryptionFC=function(password,cb){var fc=root.focusedClient;if($log.debug("Encrypting private key for",fc.credentials.walletName),fc.setPrivateKeyEncryption(password),!fc.credentials.xPrivKeyEncrypted)throw Error("no xPrivKeyEncrypted after setting encryption");root.profile.xPrivKeyEncrypted=fc.credentials.xPrivKeyEncrypted,root.profile.mnemonicEncrypted=fc.credentials.mnemonicEncrypted,delete root.profile.xPrivKey,delete root.profile.mnemonic,root.lockFC();for(var wid in root.walletClients)root.walletClients[wid].credentials.xPrivKeyEncrypted=root.profile.xPrivKeyEncrypted,delete root.walletClients[wid].credentials.xPrivKey;storageService.storeProfile(root.profile,function(){return $log.debug("Wallet encrypted"),cb()})},root.disablePrivateKeyEncryptionFC=function(cb){var fc=root.focusedClient;$log.debug("Disabling private key encryption for",fc.credentials.walletName);try{fc.disablePrivateKeyEncryption()}catch(e){return cb(e)}if(!fc.credentials.xPrivKey)throw Error("no xPrivKey after disabling encryption");root.profile.xPrivKey=fc.credentials.xPrivKey,root.profile.mnemonic=fc.credentials.mnemonic,delete root.profile.xPrivKeyEncrypted,delete root.profile.mnemonicEncrypted;for(var wid in root.walletClients)root.walletClients[wid].credentials.xPrivKey=root.profile.xPrivKey,delete root.walletClients[wid].credentials.xPrivKeyEncrypted;storageService.storeProfile(root.profile,function(){return $log.debug("Wallet encryption disabled"),cb()})},root.lockFC=function(){var fc=root.focusedClient;try{fc.lock()}catch(e){}},root.unlockFC=function(error_message,cb){$log.debug("Wallet is encrypted"),$rootScope.$emit("Local/NeedsPassword",!1,error_message,function(err2,password){if(err2||!password)return cb({message:err2||gettext("Password needed")});var fc=root.focusedClient;try{fc.unlock(password),breadcrumbs.add("unlocked "+fc.credentials.walletId),root.password=password}catch(e){return $log.debug(e),cb({message:gettext("Wrong password")})}var autolock=function(){if(root.password&&delete root.password,root.bKeepUnlocked)return console.log("keeping unlocked"),breadcrumbs.add("keeping unlocked"),void $timeout(autolock,3e4);if(console.log("time to auto-lock wallet",fc.credentials),fc.hasPrivKeyEncrypted()){$log.debug("Locking wallet automatically");try{fc.lock(),breadcrumbs.add("locked "+fc.credentials.walletId)}catch(e){}}};return $timeout(autolock,3e4),cb()})},root.insistUnlockFC=function(error_message,cb){root.unlockFC(error_message,function(err){return err?void $timeout(function(){root.insistUnlockFC(err.message,cb)},100):cb()})},root.checkPassClose=!1,root.passWrongUnlockFC=function(error_message,cb){return root.checkPassClose?cb("cancel"):void root.unlockFC(error_message,function(err){return err?void $timeout(function(){root.passWrongUnlockFC(err.message,cb)},100):cb()})},root.getWallets=function(network){if(!root.profile)return[];var config=configService.getSync();config.colorFor=config.colorFor||{},config.aliasFor=config.aliasFor||{};var ret=lodash.map(root.profile.credentials,function(c){return{m:c.m,n:c.n,is_complete:c.publicKeyRing&&c.publicKeyRing.length===c.n,name:config.aliasFor[c.walletId]||c.walletName,id:c.walletId,network:c.network,color:config.colorFor[c.walletId]||"#2C3E50"}});return ret=lodash.filter(ret,function(w){return w.network==network&&w.is_complete}),lodash.sortBy(ret,"name")},root.requestTouchid=function(cb){var fc=root.focusedClient,config=configService.getSync();return config.touchIdFor=config.touchIdFor||{},window.touchidAvailable&&config.touchIdFor[fc.credentials.walletId]?void $rootScope.$emit("Local/RequestTouchid",cb):cb()},root.replaceProfile=function(xPrivKey,mnemonic,myDeviceAddress,cb){var device=require("trustnote-common/device.js");root.profile.credentials=[],root.profile.xPrivKey=xPrivKey,root.profile.mnemonic=mnemonic,root.profile.my_device_address=myDeviceAddress,device.setNewDeviceAddress(myDeviceAddress),storageService.storeProfile(root.profile,function(){return cb()})},root}),angular.module("copayApp.services").factory("pushNotificationsService",function($http,$rootScope,$log,isMobile,$timeout,storageService,configService,lodash,isCordova){function sendRequestEnableNotification(ws,registrationId){var network=require("trustnote-common/network.js");network.sendRequest(ws,"hub/enable_notification",registrationId,!1,function(ws,request,response){if(!response||response&&"ok"!==response)return $log.error("Error sending push info")})}function disable_notification(){storageService.getPushInfo(function(err,pushInfo){storageService.removePushInfo(function(){var network=require("trustnote-common/network.js");network.sendRequest(_ws,"hub/disable_notification",pushInfo.registrationId,!1,function(ws,request,response){if(!response||response&&"ok"!==response)return $log.error("Error sending push info")})})}),configService.set({pushNotifications:{enabled:!1}},function(err){err&&$log.debug(err)})}var projectNumber,_ws,root={},usePushNotifications=(configService.getDefaults(),isCordova&&!isMobile.Windows()&&isMobile.Android()),eventBus=require("trustnote-common/event_bus.js");return window.onNotification=function(data){return"registered"===data.event&&void storageService.setPushInfo(projectNumber,data.regid,!0,function(){sendRequestEnableNotification(_ws,data.regid)})},eventBus.on("receivedPushProjectNumber",function(ws,data){usePushNotifications&&(_ws=ws,data&&void 0!==data.projectNumber&&$timeout(function(){storageService.getPushInfo(function(err,pushInfo){var config=configService.getSync();projectNumber=data.projectNumber+"",pushInfo&&"0"===projectNumber?root.pushNotificationsUnregister(function(){}):projectNumber&&config.pushNotifications.enabled&&root.pushNotificationsInit()})}))}),root.pushNotificationsInit=function(){usePushNotifications&&(window.plugins.pushNotification.register(function(data){},function(e){alert("err= "+e)},{senderID:projectNumber,ecb:"onNotification"}),configService.set({pushNotifications:{enabled:!0}},function(err){err&&$log.debug(err)}))},root.pushNotificationsUnregister=function(){usePushNotifications&&window.plugins.pushNotification.unregister(function(){disable_notification()},function(){disable_notification()})},root}),angular.module("copayApp.services").factory("sjcl",function(bwcService){var sjcl=bwcService.getSJCL();return sjcl}),angular.module("copayApp.services").factory("storageService",function(logHeader,fileStorageService,localStorageService,sjcl,$log,lodash,isCordova){function getSafeWalletId(walletId){return walletId.replace(/[\/+=]/g,"")}var root={},shouldUseFileStorage=isCordova&&!isMobile.Windows();$log.debug("Using file storage:",shouldUseFileStorage);var storage=shouldUseFileStorage?fileStorageService:localStorageService,getUUID=function(cb){return window&&window.plugins&&window.plugins.uniqueDeviceID?void window.plugins.uniqueDeviceID.get(function(uuid){return cb(uuid)},cb):cb(null)},encryptOnMobile=function(text,cb){return cb(null,text)},decryptOnMobile=function(text,cb){var json;try{json=JSON.parse(text)}catch(e){}return json?json.iter&&json.ct?($log.debug("Profile is encrypted"),void getUUID(function(uuid){if($log.debug("Device UUID:"+uuid),!uuid)return cb("Could not decrypt storage: could not get device ID");try{return text=sjcl.decrypt(uuid,text),$log.info("Migrating to unencrypted profile"),storage.set("profile",text,function(err){return cb(err,text)})}catch(e){return $log.warn("Decrypt error: ",e),cb("Could not decrypt storage: device ID mismatch")}return cb(null,text)})):($log.debug("Profile is not encrypted"),cb(null,text)):cb("Could not access storage")};return root.storeNewProfile=function(profile,cb){encryptOnMobile(profile.toObj(),function(err,x){storage.create("profile",x,cb)})},root.storeProfile=function(profile,cb){encryptOnMobile(profile.toObj(),function(err,x){storage.set("profile",x,cb)})},root.getProfile=function(cb){storage.get("profile",function(err,str){return err||!str?cb(err):void decryptOnMobile(str,function(err,str){if(err)return cb(err);var p,err;try{p=Profile.fromString(str)}catch(e){$log.debug("Could not read profile:",e),err=new Error("Could not read profile:"+e)}return cb(err,p)})})},root.deleteProfile=function(cb){storage.remove("profile",cb)},root.storeFocusedWalletId=function(id,cb){storage.set("focusedWalletId",id||"",cb)},root.getFocusedWalletId=function(cb){storage.get("focusedWalletId",cb)},root.setBackupFlag=function(walletId,cb){storage.set("backup-"+getSafeWalletId(walletId),Date.now(),cb)},root.getBackupFlag=function(walletId,cb){storage.get("backup-"+getSafeWalletId(walletId),cb)},root.clearBackupFlag=function(walletId,cb){storage.remove("backup-"+getSafeWalletId(walletId),cb)},root.getConfig=function(cb){storage.get("config",cb)},root.storeConfig=function(val,cb){$log.debug("Storing Preferences",val),storage.set("config",val,cb)},root.clearConfig=function(cb){storage.remove("config",cb)},root.setDisclaimerFlag=function(cb){storage.set("agreeDisclaimer",!0,cb)},root.getDisclaimerFlag=function(cb){storage.get("agreeDisclaimer",cb)},root.setRemotePrefsStoredFlag=function(cb){storage.set("remotePrefStored",!0,cb)},root.getRemotePrefsStoredFlag=function(cb){storage.get("remotePrefStored",cb)},root.setAddressbook=function(network,addressbook,cb){storage.set("addressbook-"+network,addressbook,cb)},root.getAddressbook=function(network,cb){storage.get("addressbook-"+network,cb)},root.removeAddressbook=function(network,cb){storage.remove("addressbook-"+network,cb)},root.setPushInfo=function(projectNumber,registrationId,enabled,cb){storage.set("pushToken",JSON.stringify({projectNumber:projectNumber,registrationId:registrationId,enabled:enabled}),cb)},root.getPushInfo=function(cb){storage.get("pushToken",function(err,data){err?cb(err):cb(null,data?JSON.parse(data):data)})},root.removePushInfo=function(cb){storage.remove("pushToken",cb)},root.hashaschoosen=function(value,cb){storage.set("haschoosen",value,cb)},root.gethaschoosen=function(cb){storage.get("haschoosen",cb)},root.setCandySendHistory=function(value,cb){storage.set("candySendHistory",value,cb)},root.getCandySendHistory=function(cb){storage.get("candySendHistory",cb)},root}),angular.module("copayApp.services").factory("$swipemodified",[function(){function getCoordinates(event){var originalEvent=event.originalEvent||event,touches=originalEvent.touches&&originalEvent.touches.length?originalEvent.touches:[originalEvent],e=originalEvent.changedTouches&&originalEvent.changedTouches[0]||touches[0];return{x:e.clientX,y:e.clientY}}function getEvents(pointerTypes,eventType){var res=[];return angular.forEach(pointerTypes,function(pointerType){var eventName=POINTER_EVENTS[pointerType][eventType];
eventName&&res.push(eventName)}),res.join(" ")}var MOVE_BUFFER_RADIUS=10,POINTER_EVENTS={touch:{start:"touchstart",move:"touchmove",end:"touchend",cancel:"touchcancel"}};return{bind:function(element,eventHandlers,pointerTypes){var totalX,totalY,startCoords,lastPos,active=!1;pointerTypes=pointerTypes||["touch"],element.on(getEvents(pointerTypes,"start"),function(event){startCoords=getCoordinates(event),active=!0,totalX=0,totalY=0,lastPos=startCoords,eventHandlers.start&&eventHandlers.start(startCoords,event)});var events=getEvents(pointerTypes,"cancel");events&&element.on(events,function(event){active=!1,eventHandlers.cancel&&eventHandlers.cancel(event)}),element.on(getEvents(pointerTypes,"move"),function(event){if(active&&startCoords){var coords=getCoordinates(event);if(totalX+=Math.abs(coords.x-lastPos.x),totalY+=Math.abs(coords.y-lastPos.y),lastPos=coords,!(totalX<MOVE_BUFFER_RADIUS&&totalY<MOVE_BUFFER_RADIUS))return totalY>totalX?(active=!1,void(eventHandlers.cancel&&eventHandlers.cancel(event))):(event.preventDefault(),void(eventHandlers.move&&eventHandlers.move(coords,event)))}}),element.on(getEvents(pointerTypes,"end"),function(event){active&&(active=!1,eventHandlers.end&&eventHandlers.end(getCoordinates(event),event))})}}}]);var constants=require("trustnote-common/constants.js");angular.module("copayApp.services").factory("txFormatService",function(profileService,configService,lodash){var root={},formatAmountStr=function(amount,asset){if(amount){if("base"!==asset&&asset!==constants.BLACKBYTES_ASSET)return amount;var config=configService.getSync().wallet.settings,assetName="base"!==asset?"blackbytes":"base",unitName="base"!==asset?config.bbUnitName:config.unitName;return profileService.formatAmount(amount,assetName)+" "+unitName}},formatFeeStr=function(fee){if(fee)return fee/1e6+" MN"};return root.processTx=function(tx){if(tx){var outputs=tx.outputs?tx.outputs.length:0;return outputs>1&&"received"!=tx.action&&(tx.hasMultiplesOutputs=!0,tx.recipientCount=outputs,tx.amount=lodash.reduce(tx.outputs,function(total,o){return o.amountStr=formatAmountStr(o.amount,tx.asset),total+o.amount},0)),tx.amountStr=formatAmountStr(tx.amount,tx.asset),tx.feeStr=formatFeeStr(tx.fee||tx.fees),tx}},root}),angular.module("copayApp.services").factory("txStatus",function($modal,lodash,profileService,$timeout){var root={};root.notify=function(txp,cb){var type,status=(profileService.focusedClient,txp.status);if("broadcasted"!=status)throw Error("unsupported status");type="broadcasted",openModal(type,txp,cb)},root._templateUrl=function(type,txp){return"views/modals/tx-status.html"};var openModal=function(type,txp,cb){var ModalInstanceCtrl=function($scope,$modalInstance){$scope.type=type,$scope.cancel=function(){$modalInstance.dismiss("cancel")},cb&&$timeout(cb,100)},modalInstance=$modal.open({templateUrl:root._templateUrl(type,txp),windowClass:"popup-tx-status full",controller:ModalInstanceCtrl});modalInstance.result["finally"](function(){var m=angular.element(document.getElementsByClassName("reveal-modal"));m.addClass("hideModal")})};return root});var UriHandler=function(){};UriHandler.prototype.register=function(){var base=window.location.origin+"/",url=base+"#/uri-payment/%s";navigator.registerProtocolHandler&&navigator.registerProtocolHandler("bitcoin",url,"Copay")},angular.module("copayApp.services").value("uriHandler",new UriHandler),angular.module("copayApp.services").factory("uxLanguage",function($log,lodash,gettextCatalog,amMoment,configService){var root={};return root.availableLanguages=[{name:"English",isoCode:"en"},{name:"",isoCode:"zh_CN",useIdeograms:!0}],root.currentLanguage=null,root._detect=function(){var userLang,androidLang;userLang=navigator&&navigator.userAgent&&(androidLang=navigator.userAgent.match(/android.*\W(\w\w)-(\w\w)\W/i))?androidLang[1]:navigator.userLanguage||navigator.language,userLang=userLang?userLang.split("-",1)[0]||"en":"en";for(var i=0;i<root.availableLanguages.length;i++){var isoCode=root.availableLanguages[i].isoCode;if(userLang===isoCode.substr(0,2))return isoCode}return"en"},root._set=function(lang){$log.debug("Setting default language: "+lang),gettextCatalog.setCurrentLanguage(lang),"en"!==lang&&gettextCatalog.loadRemote("languages/"+lang+".json"),amMoment.changeLocale(lang),root.currentLanguage=lang},root.getCurrentLanguage=function(){return root.currentLanguage},root.getCurrentLanguageName=function(){return root.getName(root.currentLanguage)},root.getCurrentLanguageInfo=function(){return lodash.find(root.availableLanguages,{isoCode:root.currentLanguage})},root.getLanguages=function(){return root.availableLanguages},root.init=function(){root._set(root._detect())},root.update=function(){var userLang=configService.getSync().wallet.settings.defaultLanguage;return userLang||(userLang=root._detect()),userLang!=gettextCatalog.getCurrentLanguage()&&root._set(userLang),userLang},root.getName=function(lang){return lodash.result(lodash.find(root.availableLanguages,{isoCode:lang}),"name")},root}),angular.module("copayApp.services").factory("witnessListService",function($state,$rootScope,go){var root={};return console.log("witnessListService"),root.currentWitness=null,root}),angular.module("copayApp.controllers").controller("acceptCorrespondentInvitationController",function($scope,$rootScope,$timeout,configService,profileService,isCordova,go,correspondentListService){function handleCode(code){var conf=require("trustnote-common/conf.js"),re=new RegExp("^"+conf.program+":","i");code=code.replace(re,"");var matches=code.match(/^([\w\/+]+)@([\w.:\/-]+)#([\w\/+-]+)$/);if(!matches)return setError("Invalid pairing code");var pubkey=matches[1],hub=matches[2],pairing_secret=matches[3];return 44!==pubkey.length?setError("Invalid pubkey length"):(console.log(pubkey,hub,pairing_secret),self.setOngoingProcess("pairing"),void correspondentListService.acceptInvitation(hub,pubkey,pairing_secret,function(err){self.setOngoingProcess(),err&&($scope.error=err)}))}function setError(error){$scope.error=error}var self=this;console.log("acceptCorrespondentInvitationController");var fc=profileService.focusedClient;$scope.backgroundColor=fc.backgroundColor,$scope.beforeQrCodeScan=function(){console.log("beforeQrCodeScan"),$scope.error=null},$scope.onQrCodeScanned=function(data,pairingCodeForm){console.log("onQrCodeScanned",data),handleCode(data)},$scope.pair=function(){$scope.error=null,handleCode($scope.code)},this.setOngoingProcess=function(name){isCordova?name?(window.plugins.spinnerDialog.hide(),window.plugins.spinnerDialog.show(null,name+"...",!0)):window.plugins.spinnerDialog.hide():($scope.onGoingProcess=name,$timeout(function(){$rootScope.$apply()}))}}),angular.module("copayApp.controllers").controller("airDrop",function($scope,$rootScope,go,profileService,$timeout,gettext,gettextCatalog,isCordova,configService,storageService,nodeWebkit,uxLanguage){function CurentTime(){var now=new Date,year=now.getFullYear(),month=now.getMonth()+1,day=now.getDate(),hh=now.getHours(),mm=now.getMinutes(),ss=now.getSeconds(),clock=year+"-";return month<10&&(clock+="0"),clock+=month+"-",day<10&&(clock+="0"),clock+=day+" ",hh<10&&(clock+="0"),clock+=hh+":",mm<10&&(clock+="0"),clock+=mm+":",ss<10&&(clock+="0"),clock+=ss}var self=this,indexScope=$scope.index,config=configService.getSync(),configWallet=config.wallet,walletSettings=configWallet.settings,Mnemonic=require("bitcore-mnemonic"),Bitcore=require("bitcore-lib"),objectHash=require("trustnote-common/object_hash.js"),breadcrumbs=require("trustnote-common/breadcrumbs.js"),constants=require("trustnote-common/constants.js"),eventBus=require("trustnote-common/event_bus.js"),crypto=require("crypto"),db=require("trustnote-common/db.js");self.unitValue=walletSettings.unitValue,self.bbUnitValue=walletSettings.bbUnitValue,self.candyTokenArr=[],self.candyOutputArr=[],self.candyHistoryList=[],self.candyAmount="",self.redPacketCount="",self.candyTotalCount=0,self.bSendAll=!1,self.showSeedList=!1,self.showSeedFlag="",self.curentHistorySeed=[],self.seeds="",self.mnemonic=new Mnemonic("fury car kingdom design boat please trust enrich empower era paper erase"),self.token="",self.T_count_placeholder=gettextCatalog.getString("Enter number"),self.hasClicked=0,self.amountWarring=!1,self.countWarring=!1,self.amountWarringMsg="",self.countWarringMsg="",self.submitAble=!0,self.submitText=gettextCatalog.getString("Generate"),self.language="zh_CN",self.isEnough=1,"en"==uxLanguage.getCurrentLanguage()?self.language="en":self.language="zh_CN",self.getCandyTokens=function(num){for(var i=0;i<num;i++)self.candyTokenArr[i]=crypto.randomBytes(32).toString("base64").substr(0,16)},self.checkNumMN=function(){return"number"!=typeof self.candyAmount?(self.amountWarring=!0,self.amountWarringMsg=gettextCatalog.getString("Invalid amount"),!1):self.candyAmount<.01?(self.amountWarring=!0,self.amountWarringMsg=gettextCatalog.getString("Invalid amount"),!1):100*self.candyAmount%1!=0?(self.amountWarring=!0,self.amountWarringMsg=gettextCatalog.getString("Invalid amount"),!1):self.candyAmount>200?(self.amountWarring=!0,self.amountWarringMsg=gettextCatalog.getString("Single T Code should less than 200"),!1):void(self.amountWarring=!1)},self.checkNumX=function(){if(isCordova){if("number"!=typeof self.redPacketCount)return self.countWarring=!0,self.countWarringMsg=gettextCatalog.getString("Invalid count"),!1;if(self.redPacketCount<1)return self.countWarring=!0,self.countWarringMsg=gettextCatalog.getString("You are naughty. Please send 1 at least "),!1;if(self.redPacketCount>20)return self.countWarring=!0,self.countWarringMsg=gettextCatalog.getString("Maximum T Code number 20"),!1;self.countWarring=!1}else{if("number"!=typeof self.redPacketCount)return self.countWarring=!0,self.countWarringMsg=gettextCatalog.getString("Invalid count"),!1;if(self.redPacketCount<1)return self.countWarring=!0,self.countWarringMsg=gettextCatalog.getString("You are naughty. Please send 1 at least "),!1;if(self.redPacketCount>100)return self.countWarring=!0,self.countWarringMsg=gettextCatalog.getString("Maximum T Code number 100"),!1;self.countWarring=!1}self.checkAbleisEnough()},self.isAbleToClick=function(){return self.redPacketCount&&self.candyAmount&&0==self.hasClicked&&!self.countWarring&&!self.amountWarring&&1==self.isEnough},self.checkAbleisEnough=function(){self.redPacketCount*(1e6*self.candyAmount+40)+548>$scope.index.arrMainWalletBalances[0].stable?(self.submitAble=!1,self.isEnough=0,$timeout(function(){self.submitAble=!0},2e3)):self.isEnough=1},self.submitForm=function(){var fc=profileService.focusedClient;if(fc.isPrivKeyEncrypted())return void profileService.unlockFC(null,function(err){return err?(self.hasClicked=0,$timeout(function(){$scope.$apply()},10),self.setSendError(gettextCatalog.getString(err.message))):self.submitForm()});if(1==self.hasClicked)return!1;self.geneding=1,self.hasClicked=1,$timeout(function(){$scope.$apply()},10),self.candyOutputArr=[],self.showSeedFlag="new";var xPrivKey="",wallet_xPubKey="",candyAddress="",form=$scope.sendCandyForm,amount=form.candyAmount.$modelValue,redPacketCount=form.redPacketCount.$modelValue;if(self.getCandyTokens(redPacketCount),0===$scope.index.arrBalances.length)return console.log("send payment: no balances yet");var unitValue=self.unitValue,bbUnitValue=self.bbUnitValue;return form?form.$invalid?void(this.error=gettext("Unable to send transaction proposal")):(indexScope.setOngoingProcess(gettext("sending"),!0),void $timeout(function(){function composeAndSend(to_address){var arrSigningDeviceAddresses=[];fc.credentials.m<fc.credentials.n?$scope.index.copayers.forEach(function(copayer){(copayer.me||copayer.signs)&&arrSigningDeviceAddresses.push(copayer.device_address)}):indexScope.shared_address&&(arrSigningDeviceAddresses=indexScope.copayers.map(function(copayer){return copayer.device_address})),breadcrumbs.add("sending payment in "+asset),profileService.bKeepUnlocked=!0;var opts={shared_address:indexScope.shared_address,merkle_proof:merkle_proof,asset:asset,to_address:to_address,amount:amount*redPacketCount,send_all:self.bSendAll,arrSigningDeviceAddresses:arrSigningDeviceAddresses,recipient_device_address:recipient_device_address,candyOutput:self.candyOutputArr};self.sendtoaddress=opts.to_address;var eventListeners=eventBus.listenerCount("apiTowalletHome");self.reCallApiToWalletHome=function(account,is_change,address_index,text_to_sign,cb){var coin="livenet"==profileService.focusedClient.credentials.network?"0":"1",path="m/44'/"+coin+"'/"+account+"'/"+is_change+"/"+address_index,xPrivKey=new Bitcore.HDPrivateKey.fromString(profileService.focusedClient.credentials.xPrivKey),privateKey=xPrivKey.derive(path).privateKey,privKeyBuf=privateKey.bn.toBuffer({size:32}),signature=ecdsaSig.sign(text_to_sign,privKeyBuf);cb(signature),eventBus.once("apiTowalletHome",self.reCallApiToWalletHome)},self.callApiToWalletHome=function(account,is_change,address_index,text_to_sign,cb){var coin="livenet"==profileService.focusedClient.credentials.network?"0":"1",path="m/44'/"+coin+"'/"+account+"'/"+is_change+"/"+address_index,obj={type:"h2",sign:text_to_sign.toString("base64"),path:path,addr:opts.to_address,amount:opts.amount,v:Math.floor(9e3*Math.random()+1e3)};self.text_to_sign_qr="TTT:"+JSON.stringify(obj),$timeout(function(){profileService.tempNum2=obj.v,$scope.$apply()},10),eventBus.once("apiTowalletHome",self.callApiToWalletHome);var finishListener=eventBus.listenerCount("finishScaned");finishListener>0&&eventBus.removeAllListeners("finishScaned"),eventBus.once("finishScaned",function(signature){cb(signature)})},eventListeners>0?(eventBus.removeAllListeners("apiTowalletHome"),fc.observed?eventBus.once("apiTowalletHome",self.callApiToWalletHome):eventBus.once("apiTowalletHome",self.reCallApiToWalletHome)):fc.observed?eventBus.once("apiTowalletHome",self.callApiToWalletHome):eventBus.once("apiTowalletHome",self.reCallApiToWalletHome),fc.sendMultiPayment(opts,function(err){if(indexScope.setOngoingProcess(gettext("sending"),!1),breadcrumbs.add("done payment in "+asset+", err="+err),delete self.current_payment_key,profileService.bKeepUnlocked=!1,err)return self.hasClicked=0,self.geneding=0,$timeout(function(){$scope.$apply()},10),"object"==typeof err?(err=JSON.stringify(err),eventBus.emit("nonfatal_error","error object from sendMultiPayment: "+err,new Error)):err.match(/device address/)?err="This is a private asset, please send it only by clicking links from chat":err.match(/no funded/)?err=gettextCatalog.getString("Not enough spendable funds"):err.match(/connection closed/)?err=gettextCatalog.getString("[internal] connection closed"):err.match(/one of the cosigners refused to sign/)?err=gettextCatalog.getString("one of the cosigners refused to sign"):err.match(/funds from/)?err=err.substring(err.indexOf("from")+4,err.indexOf("for"))+gettextCatalog.getString(err.substr(0,err.indexOf("from")))+gettextCatalog.getString(". It needs atleast ")+parseInt(err.substring(err.indexOf("for")+3,err.length))/1e6+"MN":"close"==err&&(err="suspend transaction."),self.setSendError(err);self.showSeedList=!0,self.candyHistoryList.unshift({amount:amount*redPacketCount/1e6,time:CurentTime(),seeds:self.candyTokenArr});for(var arrValues=[],walletId=profileService.focusedClient.credentials.walletId,creation_date=CurentTime(),i=0;i<self.candyTokenArr.length;i++)arrValues.push("('"+walletId+"','"+self.candyTokenArr[0]+"','"+self.candyTokenArr[i]+"',"+amount+",0,'"+creation_date+"')");var strValues=arrValues.join(",");db.query("INSERT INTO tcode (wallet,num,code,amount,is_spent,creation_date) values"+strValues,function(){$timeout(function(){self.gened=1,self.redPacketCount="",self.candyAmount="",self.hasClicked=0,self.geneding=0},10),$timeout(function(){self.gened=0},3e3),$rootScope.$emit("NewOutgoingTx")})})}var address,asset=$scope.index.arrBalances[0].asset;1==redPacketCount&&(xPrivKey=self.mnemonic.toHDPrivateKey(self.candyTokenArr[0]),wallet_xPubKey=self.walletPubKey(xPrivKey,0),address=self.walletAddress(wallet_xPubKey,0,0));var assocDeviceAddressesByPaymentAddress={},recipient_device_address=assocDeviceAddressesByPaymentAddress[address],merkle_proof="";if(form.merkle_proof&&form.merkle_proof.$modelValue&&(merkle_proof=form.merkle_proof.$modelValue.trim()),"base"===asset&&(amount*=unitValue),asset===constants.BLACKBYTES_ASSET&&(amount*=bbUnitValue),amount=Math.round(amount),redPacketCount>1)for(var i=0;i<self.candyTokenArr.length;i++)xPrivKey=self.mnemonic.toHDPrivateKey(self.candyTokenArr[i]),wallet_xPubKey=self.walletPubKey(xPrivKey,0),candyAddress=self.walletAddress(wallet_xPubKey,0,0),console.log(candyAddress),self.candyOutputArr.push({address:candyAddress,amount:amount});var current_payment_key=""+asset+address+amount;return current_payment_key===self.current_payment_key?$rootScope.$emit("Local/ShowErrorAlert","This payment is already under way"):(self.current_payment_key=current_payment_key,void composeAndSend(address))},100)):console.log("form is gone")},self.xPrivKey=function(mnemonic){try{var xPrivKey=new Mnemonic(mnemonic).toHDPrivateKey();return xPrivKey.toString()}catch(error){return 0}},self.walletPubKey=function(xPrivKey,num){try{var wallet_xPubKey=Bitcore.HDPublicKey(xPrivKey.derive("m/44'/0'/"+num+"'"));return wallet_xPubKey.toString()}catch(error){return 0}},self.walletAddress=function(wallet_xPubKey,change,num){try{wallet_xPubKey=Bitcore.HDPublicKey.fromString(wallet_xPubKey);var wallet_xPubKey_base64=wallet_xPubKey.derive("m/"+change+"/"+num).publicKey.toBuffer().toString("base64"),address=objectHash.getChash160(["sig",{pubkey:wallet_xPubKey_base64}]);return address}catch(error){return 0}},self.setSendError=function(err){var fc=profileService.focusedClient,prefix=fc.credentials.m>1?gettextCatalog.getString("Could not create payment proposal"):gettextCatalog.getString("Could not send payment");self.error=prefix+": "+err,console.log(this.error),$timeout(function(){$scope.$digest()},1)},self.resetError=function(){self.error=null},self.getHistoryList=function(){var fcWalletId=profileService.focusedClient.credentials.walletId;db.query("SELECT wallet,num,sum(amount) as amount,creation_date from tcode where wallet='"+fcWalletId+"' GROUP BY num ORDER BY creation_date DESC;",function(rows){self.recordsList=rows,$timeout(function(){$scope.$apply()},100)})},self.getHistoryList(),self.clicked=function(num){var txId=self.recordsList[num].num;db.query("SELECT wallet,num,amount,code,creation_date from tcode where num='"+txId+"' ORDER BY creation_date DESC;",function(rows){self.detileList=rows,$timeout(function(){$scope.$apply()},100)})},self.copyall=function(){self.temStr="";for(var i=0;i<self.detileList.length;i++)self.detileList[i]&&(self.temStr=self.temStr+"\n"+self.detileList[i].code);self.copyedToBoard=gettextCatalog.getString("Enter T code to redeem your asset at 'TrustNote Wallet/Wallet/Wallet-setting/Redeem T Code'")+self.temStr,isCordova?(window.cordova.plugins.clipboard.copy(self.copyedToBoard),$timeout(function(){self.showCopied=1,$scope.$apply()},10),$timeout(function(){self.showCopied=0},1500)):nodeWebkit.isDefined()&&(nodeWebkit.writeToClipboard(self.copyedToBoard),$timeout(function(){self.showCopied=1,$scope.$apply()},10),$timeout(function(){self.showCopied=0},1500))}}),angular.module("copayApp.controllers").controller("airDropReceive",function($scope,$rootScope,go,profileService,gettextCatalog,addressService,$timeout){var self=this,wallet_defined_by_keys=require("trustnote-common/wallet_defined_by_keys.js"),myWitnesses=require("trustnote-common/my_witnesses"),network=require("trustnote-common/network"),Bitcore=require("bitcore-lib"),Mnemonic=require("bitcore-mnemonic"),objectHash=(require("crypto"),require("trustnote-common/object_hash.js")),ecdsaSig=require("trustnote-common/signature.js");self.successful=0,self.Redeeming=0,self.errTextList=[],self.showMask=0,self.placeholderText=gettextCatalog.getString("Please enter T Code"),self.isAvailable=0,self.checkTword=function(){return self.mnemonicStr.length<1?self.isAvailable=0:self.isAvailable=1},self.clickOK=function(){return self.showMask=0,1==self.isAvailable?(self.isAvailable=1,!1):(self.mnemonicStr="",void(self.isAvailable=0))},self.receiveCandy=function(cb){if(0==self.isAvailable)return!1;if(16!=self.mnemonicStr.length)return self.errTextList[0]=gettextCatalog.getString("Incorrect T code, please re-enter"),self.showMask=1,$timeout(function(){$scope.$apply()},10),!1;self.Redeeming=1,self.isAvailable=0,self.mnemonic="fury car kingdom design boat please trust enrich empower era paper erase";var mnemonic=new Mnemonic(self.mnemonic),xPrivKey=mnemonic.toHDPrivateKey(self.mnemonicStr),wallet_xPubKey=Bitcore.HDPublicKey(xPrivKey.derive("m/44'/0'/0'")).toString(),tempAddress=[];tempAddress[0]=objectHash.getChash160(["sig",{pubkey:wallet_defined_by_keys.derivePubkey(wallet_xPubKey,"m/0/0")}]),myWitnesses.readMyWitnesses(function(arrWitnesses){return arrWitnesses&&12==arrWitnesses.length?void network.requestFromLightVendor("light/get_history",{addresses:tempAddress,witnesses:arrWitnesses},function(ws,request,response){if(!response.joints)return self.errTextList[0]=gettextCatalog.getString("You are too late,"),self.errTextList[1]=gettextCatalog.getString("the T code has been claimed by other people"),self.Redeeming=0,self.showMask=1,$timeout(function(){$scope.$apply()},10),!1;if(!response.joints[0].unit.unit||!response.joints[0].unit.messages[0].payload.outputs||!response.joints[0].unit.witness_list_unit)return self.errTextList[0]=gettextCatalog.getString("You are too late,"),self.errTextList[1]=gettextCatalog.getString("the T code has been claimed by other people"),self.Redeeming=0,self.showMask=1,$timeout(function(){$scope.$apply()},10),!1;for(var j=0;j<response.unstable_mc_joints.length;j++)if(response.unstable_mc_joints[j].unit.unit==response.joints[0].unit.unit)return self.errTextList[0]=gettextCatalog.getString("T Code is not stable, please try again later"),self.Redeeming=0,self.isAvailable=1,self.showMask=1,$timeout(function(){$scope.$apply()},10),!1;var inputUnit=response.joints[0].unit.unit,tempArr=response.joints[0].unit.messages[0].payload.outputs;if(tempArr){for(var i=0;i<tempArr.length;i++)if(tempAddress[0]==tempArr[i].address){self.tmpAddr=tempArr[i].address,self.tmpAmount=tempArr[i].amount;break}var output_index=i}if(void 0==self.tmpAddr)return self.errTextList[0]=gettextCatalog.getString("You are too late,"),self.errTextList[1]=gettextCatalog.getString("the T code has been claimed by other people"),self.Redeeming=0,self.showMask=1,$timeout(function(){$scope.$apply()},10),!1;var witness_list_unit=response.joints[0].unit.witness_list_unit;network.requestFromLightVendor("light/get_parents_and_last_ball_and_witness_list_unit",{witnesses:arrWitnesses},function(ws,request,response){return response.error?(self.errTextList[0]=response.error,self.Redeeming=0,self.showMask=1,$timeout(function(){$scope.$apply()},10),!1):response.parent_units&&response.last_stable_mc_ball&&response.last_stable_mc_ball_unit&&"number"==typeof response.last_stable_mc_ball_mci?(self.parent_units=response.parent_units,self.last_ball=response.last_stable_mc_ball,self.last_ball_unit=response.last_stable_mc_ball_unit,void addressService.getAddress(profileService.focusedClient.credentials.walletId,!1,function(err,addr){if(err)return self.errTextList[0]=gettextCatalog.getString("Error: my wallet address is not found"),self.Redeeming=0,self.showMask=1;addr&&(self.to_address=addr);var objUnit={version:"1.0",alt:"1",messages:[{app:"payment",payload_location:"inline",payload_hash:"-------------------------------------------=",payload:{outputs:[{address:self.to_address,amount:0}],inputs:[{unit:inputUnit,message_index:0,output_index:output_index}]}}],authors:[{address:self.tmpAddr,authentifiers:{r:"----------------------------------------------------------------------------------------"},definition:["sig",{pubkey:"--------------------------------------------"}]}],parent_units:self.parent_units,last_ball:self.last_ball,last_ball_unit:self.last_ball_unit,witness_list_unit:witness_list_unit,headers_commission:0,payload_commission:0},objectLength=require("trustnote-common/object_length"),numHeadersCommission=objectLength.getHeadersSize(objUnit);objUnit.headers_commission=numHeadersCommission;var numPayloadCommission=objectLength.getTotalPayloadSize(objUnit);if(objUnit.payload_commission=numPayloadCommission,objUnit.messages[0].payload.outputs[0].amount=self.tmpAmount-numPayloadCommission-numHeadersCommission,objUnit.messages[0].payload.outputs[0].amount<=0)return self.errTextList[0]=gettextCatalog.getString("You are too late,"),self.errTextList[1]=gettextCatalog.getString("the T code has been claimed by other people"),self.Redeeming=0,self.showMask=1,$timeout(function(){$scope.$apply()},10),!1;var payload_hash=objectHash.getBase64Hash(objUnit.messages[0].payload);objUnit.messages[0].payload_hash=payload_hash;var walletxPubKey=Bitcore.HDPublicKey(xPrivKey.derive("m/44'/0'/0'")),pubkey=walletxPubKey.derive("m/0/0").publicKey.toBuffer().toString("base64");objUnit.authors[0].definition[1].pubkey=pubkey;var text_to_sign=objectHash.getUnitHashToSign(objUnit),path="m/44'/0'/0'/0/0",privateKey=xPrivKey.derive(path).privateKey,privKeyBuf=privateKey.bn.toBuffer({size:32});self.signature=ecdsaSig.sign(text_to_sign,privKeyBuf),objUnit.authors[0].authentifiers.r=self.signature,objUnit.unit=objectHash.getUnitHash(objUnit);var obj={unit:objUnit};obj.unit.timestamp=Math.round(Date.now()/1e3);var network=require("trustnote-common/network.js");network.postJointToLightVendor(obj,function(response){return"accepted"!==response?(self.errTextList[0]=response.error,self.Redeeming=0,self.showMask=1):(self.Redeeming=0,self.successful=1,self.mnemonicStr="",self.isAvailable=0,$timeout(function(){$scope.index.updateAll(),$scope.index.updateHistoryFromNetwork(),$scope.$apply()},10),$timeout(function(){self.successful=0},3e3),void 0)})})):(self.errTextList[0]=gettextCatalog.getString("Incorrect T code, please re-enter"),self.Redeeming=0,self.showMask=1,$timeout(function(){$scope.$apply()},10),!1)})}):(self.errTextList[0]=gettextCatalog.getString("arrWitnesses error: try it later."),self.Redeeming=0,self.showMask=1,$timeout(function(){$scope.$apply()},10),!1)})}}),angular.module("copayApp.controllers").controller("approveNewWitnesses",function($scope,$modalInstance,$document,autoUpdatingWitnessesList){$scope.addWitnesses=autoUpdatingWitnessesList.addWitnesses,$scope.delWitnesses=autoUpdatingWitnessesList.delWitnesses,$scope.replace=function(){function replaceWitness(n,oldWitnesses,newWitnesses){var myWitnesses=require("trustnote-common/my_witnesses.js");myWitnesses.replaceWitness(oldWitnesses[n],newWitnesses[n],function(err){l<n?replaceWitness(n++,oldWitnesses,newWitnesses):$modalInstance.close("closed result")})}var oldWitnesses=$scope.delWitnesses,newWitnesses=$scope.addWitnesses,n=0,l=newWitnesses.length;replaceWitness(n,oldWitnesses,newWitnesses)},$scope.later=function(){$modalInstance.close("closed result")}});var ecdsaSig=require("trustnote-common/signature.js");angular.module("copayApp.controllers").controller("authConfirmationController",function($scope,$timeout,configService,profileService,go,authService){function extractDomainFromUrl(url){var domain_with_path=url.replace(/^https?:\/\//i,""),domain=domain_with_path.replace(/\/.*$/,"");return domain=domain.replace(/^www\./i,"")}var bbWallet=require("trustnote-common/wallet.js");$scope.walletId=profileService.focusedClient.credentials.walletId;var objRequest=authService.objRequest;if(!objRequest)throw Error("no request");var app_name;if(objRequest.app)app_name=objRequest.app;else{if(!objRequest.url)throw Error("neither app nor url");app_name=extractDomainFromUrl(objRequest.url)}objRequest.question?$scope.question=objRequest.question:$scope.question="Log in to "+app_name+"?";var arrSigningDeviceAddresses=[];$scope.yes=function(){console.log("yes");var credentials=lodash.find(profileService.profile.credentials,{walletId:$scope.walletId});if(!credentials)throw Error("unknown wallet: "+$scope.walletId);var coin="livenet"==credentials.network?"0":"1",signWithLocalPrivateKey=function(wallet_id,account,is_change,address_index,text_to_sign,handleSig){var path="m/44'/"+coin+"'/"+account+"'/"+is_change+"/"+address_index,xPrivKey=new Bitcore.HDPrivateKey.fromString(profileService.focusedClient.credentials.xPrivKey),privateKey=xPrivKey.derive(path).privateKey,privKeyBuf=privateKey.bn.toBuffer({size:32});handleSig(ecdsaSig.sign(text_to_sign,privKeyBuf))};bbWallet.issueOrSelectAddressForApp(credentials.walletId,app_name,function(address){bbWallet.signAuthRequest(credentials.walletId,objRequest,arrSigningDeviceAddresses,signWithLocalPrivateKey,function(err){go.walletHome()})})},$scope.no=function(){console.log("no"),go.walletHome()}}),angular.module("copayApp.controllers").controller("wordsController",function($rootScope,$scope,$timeout,profileService,go,gettext,gettextCatalog,confirmDialog,notification,$log,isCordova,storageService){function setWords(words){words&&(self.mnemonicWords=words.split(/[\u3000\s]+/),self.mnemonicHasPassphrase=fc.mnemonicHasPassphrase(),self.useIdeograms=words.indexOf("")>=0)}var msg=gettextCatalog.getString("Are you sure you want to delete the backup words?"),successMsg=gettext("Backup words deleted"),self=this;self.show=!1;var fc=profileService.focusedClient,reg=new RegExp(/^[a-z]+$/);if("undefined"==typeof window.cordova?this.isIOS=!1:this.isIOS=window.cordova.platformId,self.step="show_waring",self.delseed=!1,self.gono00=function(){self.step="show_jietu00"},self.gono=function(){self.step="show_jietu"},self.showword=function(){self.step="show_word"},self.showinput=function(){self.step="show_input"},self.del=function(){self.delseed=!self.delseed},self.gorukou2=function(){self.step="rukou2"},self.dis=function(){return self.value!=fc.getMnemonic()},self.value="",self.items=[],self.m1=0,self.num=-1,self.jumpNum=1,self.jumpNext=function(){window.clearTimeout(self.t);var inputList=document.getElementsByClassName("inptMnemonic2");12!=self.jumpNum&&(self.t=setTimeout(function(){inputList[self.jumpNum].focus(),self.jumpNum++},100))},self.hideUlclearItems=function(){self.m1=0,self.items=[],self.strMnemonic(),self.jumpNext()},self.funReg1=function(){self.items=[],self.m1=self.jumpNum=1,reg.test(self.mnemonic1)&&(self.str=self.mnemonic1,self.funReg(),self.strMnemonic(),self.compare())},self.funReg2=function(){self.items=[],self.m1=self.jumpNum=2,reg.test(self.mnemonic2)&&(self.str=self.mnemonic2,self.funReg(),self.strMnemonic(),self.compare())},self.funReg3=function(){self.items=[],self.m1=self.jumpNum=3,reg.test(self.mnemonic3)&&(self.str=self.mnemonic3,self.funReg(),self.strMnemonic(),self.compare())},self.funReg4=function(){self.items=[],self.m1=self.jumpNum=4,reg.test(self.mnemonic4)&&(self.str=self.mnemonic4,self.funReg(),self.strMnemonic(),self.compare())},self.funReg5=function(){self.items=[],self.m1=self.jumpNum=5,reg.test(self.mnemonic5)&&(self.str=self.mnemonic5,self.funReg(),self.strMnemonic(),self.compare())},self.funReg6=function(){self.items=[],self.m1=self.jumpNum=6,reg.test(self.mnemonic6)&&(self.str=self.mnemonic6,self.funReg(),self.strMnemonic(),self.compare())},self.funReg7=function(){self.items=[],self.m1=self.jumpNum=7,reg.test(self.mnemonic7)&&(self.str=self.mnemonic7,self.funReg(),self.strMnemonic(),self.compare())},self.funReg8=function(){self.items=[],self.m1=self.jumpNum=8,reg.test(self.mnemonic8)&&(self.str=self.mnemonic8,self.funReg(),self.strMnemonic(),self.compare())},self.funReg9=function(){self.items=[],self.m1=self.jumpNum=9,reg.test(self.mnemonic9)&&(self.str=self.mnemonic9,self.funReg(),self.strMnemonic(),self.compare())},self.funReg10=function(){self.items=[],self.m1=self.jumpNum=10,reg.test(self.mnemonic10)&&(self.str=self.mnemonic10,self.funReg(),self.strMnemonic(),self.compare())},self.funReg11=function(){self.items=[],self.m1=self.jumpNum=11,reg.test(self.mnemonic11)&&(self.str=self.mnemonic11,self.funReg(),
self.strMnemonic(),self.compare())},self.funReg12=function(){self.items=[],self.m1=self.jumpNum=12,reg.test(self.mnemonic12)&&(self.str=self.mnemonic12,self.funReg(),self.strMnemonic(),self.compare())},self.strMnemonic=function(){return self.value=self.mnemonic1+" "+self.mnemonic2+" "+self.mnemonic3+" "+self.mnemonic4+" "+self.mnemonic5+" "+self.mnemonic6+" "+self.mnemonic7+" "+self.mnemonic8+" "+self.mnemonic9+" "+self.mnemonic10+" "+self.mnemonic11+" "+self.mnemonic12},self.compare=function(){self.value==fc.getMnemonic()&&(self.m1=0)},self.handleKeyboard=function(e){40!=e.keyCode&&32!=e.keyCode||(self.num>=self.items.length-1?self.num=0:self.num++),38==e.keyCode&&(0==self.num?self.num=self.items.length-1:self.num--)},self.handleKeyboard1=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic1+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard2=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic2+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard3=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic3+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard4=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic4+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard5=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic5+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard6=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic6+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard7=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic7+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard8=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic8+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard9=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic9+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard10=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic10+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard11=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic11+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard12=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic12+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.funReg=function(){self.num=-1},!isCordova){var desktopApp=require("trustnote-common/desktop_app.js");self.appDataDir=desktopApp.getAppDataDir()}self.isCordova=isCordova,fc.isPrivKeyEncrypted()?self.credentialsEncrypted=!0:setWords(fc.getMnemonic()),!fc.credentials||fc.credentials.mnemonicEncrypted||fc.credentials.mnemonic||(self.deleted=!0),self.toggle=function(){self.error="",self.credentialsEncrypted||(self.show||$rootScope.$emit("Local/BackupDone"),self.show=!self.show),self.credentialsEncrypted&&self.passwordRequest(),$timeout(function(){$scope.$apply()},1)},self["delete"]=function(){confirmDialog.show(msg,function(ok){ok&&(fc.clearMnemonic(),profileService.clearMnemonic(function(){self.deleted=!0,notification.success(successMsg),go.walletHome()}))})},self.delteConfirm=function(){fc.clearMnemonic(),profileService.clearMnemonic(function(){self.deleted=!0,notification.success(successMsg),go.walletHome()})},$scope.$on("$destroy",function(){profileService.lockFC()}),self.passwordRequest=function(){try{setWords(fc.getMnemonic())}catch(e){e.message&&e.message.match(/encrypted/)&&fc.isPrivKeyEncrypted()&&(self.credentialsEncrypted=!0,$timeout(function(){$scope.$apply()},1),profileService.unlockFC(null,function(err){return err?(self.error=gettextCatalog.getString("Could not decrypt")+": "+err.message,void $log.warn("Error decrypting credentials:",self.error)):(!self.show&&self.credentialsEncrypted&&(self.show=!self.show),self.credentialsEncrypted=!1,setWords(fc.getMnemonic()),void $rootScope.$emit("Local/BackupDone"))}))}},self.haschoosen=function(){storageService.hashaschoosen(2,function(err){$scope.index.splashClick=!1,$timeout(function(){$scope.$apply()},1),go.walletHome()})}}),angular.module("copayApp.controllers").controller("botController",function($stateParams,$scope,$rootScope,$timeout,configService,profileService,isCordova,go,correspondentListService){var bots=require("trustnote-common/bots.js"),fc=profileService.focusedClient;$scope.backgroundColor=fc.backgroundColor,$scope.$root=$rootScope;var id=$stateParams.id;bots.getBotByID(id,function(bot){bot.description=correspondentListService.escapeHtmlAndInsertBr(bot.description),$scope.bot=bot,$timeout(function(){$scope.$digest()})}),$scope.pair=function(bot){var matches=bot.pairing_code.match(/^([\w\/+]+)@([\w.:\/-]+)#([\w\/+-]+)$/),pubkey=matches[1],hub=matches[2],pairing_secret=matches[3];$scope.index.setOngoingProcess("pairing",!0),correspondentListService.acceptInvitation(hub,pubkey,pairing_secret,function(err){$scope.index.setOngoingProcess("pairing",!1)})},$scope.open=function(bot){correspondentListService.setCurrentCorrespondent(bot.device_address,function(){go.path("correspondentDevices.correspondentDevice")})}}),angular.module("copayApp.controllers").controller("copayersController",function($scope,$rootScope,$timeout,$log,$modal,profileService,go,notification,isCordova,gettext,gettextCatalog,animationService){var self=this,delete_msg=gettextCatalog.getString("Are you sure you want to delete this wallet?"),accept_msg=gettextCatalog.getString("Accept"),cancel_msg=gettextCatalog.getString("Cancel"),confirm_msg=gettextCatalog.getString("Confirm");self.init=function(){var fc=profileService.focusedClient;return fc.isComplete()?($log.debug("Wallet Complete...redirecting"),void go.walletHome()):(self.loading=!1,self.isCordova=isCordova,$rootScope.$emit("Local/BalanceUpdated",{}),void(self.isCordova&&!wallet.clientCompleteLoaded()&&wallet.showCompleteClient()))};var _modalDeleteWallet=function(){var ModalInstanceCtrl=function($scope,$modalInstance,$sce,gettext){$scope.title=$sce.trustAsHtml(delete_msg),$scope.yes_icon="fi-trash",$scope.yes_button_class="warning",$scope.cancel_button_class="light-gray outline",$scope.loading=!1,$scope.ok=function(){$scope.loading=!0,$modalInstance.close(accept_msg)},$scope.cancel=function(){$modalInstance.dismiss(cancel_msg)}},modalInstance=$modal.open({templateUrl:"views/modals/confirmation.html",windowClass:animationService.modalAnimated.slideUp,controller:ModalInstanceCtrl});modalInstance.result["finally"](function(){var m=angular.element(document.getElementsByClassName("reveal-modal"));m.addClass(animationService.modalAnimated.slideOutDown)}),modalInstance.result.then(function(ok){ok&&_deleteWallet()})},_deleteWallet=function(){profileService.focusedClient;$timeout(function(){var fc=profileService.focusedClient,walletName=fc.credentials.walletName;profileService.deleteWallet({},function(err){err?(this.error=err.message||err,console.log(err),$timeout(function(){$scope.$digest()})):(go.walletHome(),$timeout(function(){notification.success(gettextCatalog.getString("Success"),gettextCatalog.getString('The wallet "{{walletName}}" was deleted',{walletName:walletName}))}))})},100)};self.deleteWallet=function(){profileService.focusedClient;isCordova?navigator.notification.confirm(delete_msg,function(buttonIndex){1==buttonIndex&&_deleteWallet()},confirm_msg,[accept_msg,cancel_msg]):_modalDeleteWallet()}});var constants=require("trustnote-common/constants.js");angular.module("copayApp.controllers").controller("correspondentDeviceController",function($scope,$rootScope,$timeout,$sce,$modal,configService,profileService,animationService,isCordova,go,correspondentListService,addressService,lodash,$deepStateRedirect,$state,backButton){function setError(error){console.log("send error:",error),$scope.error=error}function readLastMainChainIndex(cb){if(conf.bLight){var network=require("trustnote-common/network.js");network.requestFromLightVendor("get_last_mci",null,function(ws,request,response){response.error?cb(response.error):cb(null,response)})}else storage.readLastMainChainIndex(function(last_mci){cb(null,last_mci)})}function readMyPaymentAddress(cb){return indexScope.shared_address?cb(indexScope.shared_address):void addressService.getAddress(profileService.focusedClient.credentials.walletId,!1,function(err,address){cb(address)})}function issueNextAddress(cb){var walletDefinedByKeys=require("trustnote-common/wallet_defined_by_keys.js");walletDefinedByKeys.issueNextAddress(profileService.focusedClient.credentials.walletId,0,function(addressInfo){cb&&cb(addressInfo.address)})}function appendText(text){if($scope.message||($scope.message=""),$scope.message&&" "!==$scope.message.charAt($scope.message.length-1)&&($scope.message+=" "),$scope.message+=text,$scope.message+=" ",document.chatForm&&document.chatForm.message){var msgField=document.chatForm.message;$timeout(function(){$rootScope.$digest()}),msgField.selectionStart=msgField.selectionEnd=msgField.value.length}}function appendMyPaymentAddress(myPaymentAddress){appendText(myPaymentAddress)}function showRequestPaymentModal(myPaymentAddress){$rootScope.modalOpened=!0;var fc=profileService.focusedClient,ModalInstanceCtrl=function($scope,$modalInstance){var config=configService.getSync(),configWallet=config.wallet,walletSettings=configWallet.settings;$scope.unitValue=walletSettings.unitValue,$scope.unitName=walletSettings.unitName,$scope.bbUnitValue=walletSettings.bbUnitValue,$scope.bbUnitName=walletSettings.bbUnitName,$scope.color=fc.backgroundColor,$scope.isCordova=isCordova,$scope.buttonLabel="Request payment",Object.defineProperty($scope,"_customAmount",{get:function(){return $scope.customAmount},set:function(newValue){$scope.customAmount=newValue},enumerable:!0,configurable:!0}),$scope.submitForm=function(form){if(0===$scope.index.arrBalances.length)return console.log("showRequestPaymentModal: no balances yet");var amount=form.amount.$modelValue,asset=$scope.index.arrBalances[$scope.index.assetIndex].asset;if(!asset)throw Error("no asset");var amountInSmallestUnits="base"===asset?parseInt((amount*$scope.unitValue).toFixed(0)):asset===constants.BLACKBYTES_ASSET?parseInt((amount*$scope.bbUnitValue).toFixed(0)):amount,params="amount="+amountInSmallestUnits;"base"!==asset&&(params+="&asset="+encodeURIComponent(asset));var units="base"===asset?$scope.unitName:asset===constants.BLACKBYTES_ASSET?$scope.bbUnitName:"of "+asset;appendText("["+amount+" "+units+"](TTT:"+myPaymentAddress+"?"+params+")"),$modalInstance.dismiss("cancel")},$scope.cancel=function(){$modalInstance.dismiss("cancel")}},modalInstance=$modal.open({templateUrl:"views/modals/customized-amount.html",windowClass:animationService.modalAnimated.slideUp,controller:ModalInstanceCtrl,scope:$scope}),disableCloseModal=$rootScope.$on("closeModal",function(){modalInstance.dismiss("cancel")});modalInstance.result["finally"](function(){$rootScope.modalOpened=!1,disableCloseModal();var m=angular.element(document.getElementsByClassName("reveal-modal"));m.addClass(animationService.modalAnimated.slideOutDown)})}function setOngoingProcess(name){isCordova?name?(window.plugins.spinnerDialog.hide(),window.plugins.spinnerDialog.show(null,name+"...",!0)):window.plugins.spinnerDialog.hide():($scope.onGoingProcess=name,$timeout(function(){$rootScope.$apply()}))}var chatStorage=require("trustnote-common/chat_storage.js");console.log("correspondentDeviceController");var device=require("trustnote-common/device.js"),eventBus=require("trustnote-common/event_bus.js"),conf=require("trustnote-common/conf.js"),storage=require("trustnote-common/storage.js"),breadcrumbs=require("trustnote-common/breadcrumbs.js"),chatScope=(profileService.focusedClient,$scope),indexScope=$scope.index;$rootScope.tab=$scope.index.tab="chat";var correspondent=correspondentListService.currentCorrespondent;$scope.correspondent=correspondent,document.chatForm&&document.chatForm.message&&document.chatForm.message.focus(),correspondentListService.messageEventsByCorrespondent[correspondent.device_address]||(correspondentListService.messageEventsByCorrespondent[correspondent.device_address]=[]),$scope.messageEvents=correspondentListService.messageEventsByCorrespondent[correspondent.device_address],$scope.$watch("correspondent.my_record_pref",function(pref,old_pref){if(pref!=old_pref){var device=require("trustnote-common/device.js");device.sendMessageToDevice(correspondent.device_address,"chat_recording_pref",pref,{ifOk:function(){device.updateCorrespondentProps(correspondent);var oldState=correspondent.peer_record_pref&&!correspondent.my_record_pref,newState=correspondent.peer_record_pref&&correspondent.my_record_pref;if(newState!=oldState){var message={type:"system",message:JSON.stringify({state:newState}),timestamp:Math.floor(Date.now()/1e3),chat_recording_status:!0};$scope.autoScrollEnabled=!0,$scope.messageEvents.push(correspondentListService.parseMessage(message)),$timeout(function(){$scope.$digest()}),chatStorage.store(correspondent.device_address,JSON.stringify({state:newState}),0,"system")}},ifError:function(){}})}});var removeNewMessagesDelim=function(){for(var i in $scope.messageEvents)$scope.messageEvents[i].new_message_delim&&$scope.messageEvents.splice(i,1)};$scope.$watch("newMessagesCount['"+correspondent.device_address+"']",function(counter){!$scope.newMsgCounterEnabled&&$state.is("correspondentDevices.correspondentDevice")&&($scope.newMessagesCount[$scope.correspondent.device_address]=0)}),$scope.$on("$stateChangeStart",function(evt,toState,toParams,fromState){"correspondentDevices.correspondentDevice"===toState.name?($rootScope.tab=$scope.index.tab="chat",$scope.newMessagesCount[correspondentListService.currentCorrespondent.device_address]=0):removeNewMessagesDelim()}),$scope.send=function(){if($scope.error=null,$scope.message){setOngoingProcess("sending");var message=lodash.clone($scope.message);device.sendMessageToDevice(correspondent.device_address,"text",message,{ifOk:function(){setOngoingProcess(),$scope.autoScrollEnabled=!0;var msg_obj={bIncoming:!1,message:correspondentListService.formatOutgoingMessage(message),timestamp:Math.floor(Date.now()/1e3)};correspondentListService.checkAndInsertDate($scope.messageEvents,msg_obj),$scope.messageEvents.push(msg_obj),$scope.message="",$timeout(function(){$scope.$apply()}),correspondent.my_record_pref&&correspondent.peer_record_pref&&chatStorage.store(correspondent.device_address,message,0)},ifError:function(error){setOngoingProcess(),setError(error)}})}},$scope.insertMyAddress=function(){return profileService.focusedClient.credentials.isComplete()?(readMyPaymentAddress(appendMyPaymentAddress),void(document.getElementById("drop").style.display="none")):$rootScope.$emit("Local/ShowErrorAlert","The wallet is not approved yet")},$scope.requestPayment=function(){return profileService.focusedClient.credentials.isComplete()?(readMyPaymentAddress(showRequestPaymentModal),void(document.getElementById("drop").style.display="none")):$rootScope.$emit("Local/ShowErrorAlert","The wallet is not approved yet")},$scope.sendPayment=function(address,amount,asset){return console.log("will send payment to "+address),asset&&0===$scope.index.arrBalances.filter(function(balance){return balance.asset===asset}).length?void console.log("i do not own anything of asset "+asset):(backButton.dontDeletePath=!0,void go.send(function(){$rootScope.$emit("paymentRequest",address,amount,asset,correspondent.device_address)}))},$scope.showPayment=function(asset){if(console.log("will show payment in asset "+asset),!asset)throw Error("no asset in showPayment");if(asset&&0===$scope.index.arrBalances.filter(function(balance){return balance.asset===asset}).length)return void console.log("i do not own anything of asset "+asset);var assetIndex=lodash.findIndex($scope.index.arrBalances,{asset:asset});if(assetIndex<0)throw Error("failed to find asset index of asset "+asset);$scope.index.assetIndex=assetIndex,go.history()},$scope.offerContract=function(address){var walletDefinedByAddresses=require("trustnote-common/wallet_defined_by_addresses.js");$rootScope.modalOpened=!0;var fc=profileService.focusedClient;$scope.oracles=configService.oracles;var ModalInstanceCtrl=function($scope,$modalInstance){var config=configService.getSync(),configWallet=config.wallet,walletSettings=configWallet.settings;$scope.unitValue=walletSettings.unitValue,$scope.unitName=walletSettings.unitName,$scope.color=fc.backgroundColor,$scope.bWorking=!1,$scope.arrRelations=["=",">","<",">=","<=","!="],$scope.arrParties=[{value:"me",display_value:"I"},{value:"peer",display_value:"the peer"}],$scope.arrPeerPaysTos=[{value:"me",display_value:"me"},{value:"contract",display_value:"this contract"}],$scope.arrAssetInfos=indexScope.arrBalances.map(function(b){var info={asset:b.asset,is_private:b.is_private};return"base"===b.asset?info.displayName=walletSettings.unitName:b.asset===constants.BLACKBYTES_ASSET?info.displayName=walletSettings.bbUnitName:info.displayName="of "+b.asset.substr(0,4),info}),$scope.arrPublicAssetInfos=$scope.arrAssetInfos.filter(function(b){return!b.is_private});var contract={timeout:4,myAsset:"base",peerAsset:"base",peer_pays_to:"contract",relation:">",expiry:7,data_party:"me",expiry_party:"peer"};$scope.contract=contract,$scope.onDataPartyUpdated=function(){console.log("onDataPartyUpdated"),contract.expiry_party="me"===contract.data_party?"peer":"me"},$scope.onExpiryPartyUpdated=function(){console.log("onExpiryPartyUpdated"),contract.data_party="me"===contract.expiry_party?"peer":"me"},$scope.payAndOffer=function(){return console.log("payAndOffer"),$scope.error="",fc.isPrivKeyEncrypted()?void profileService.unlockFC(null,function(err){return err?($scope.error=err.message,void $timeout(function(){$scope.$apply()})):void $scope.payAndOffer()}):void profileService.requestTouchid(function(err){function composeAndSend(shared_address,arrDefinition,assocSignersByPath,my_address){var arrSigningDeviceAddresses=[];fc.credentials.m<fc.credentials.n?indexScope.copayers.forEach(function(copayer){(copayer.me||copayer.signs)&&arrSigningDeviceAddresses.push(copayer.device_address)}):indexScope.shared_address&&(arrSigningDeviceAddresses=indexScope.copayers.map(function(copayer){return copayer.device_address})),profileService.bKeepUnlocked=!0;var opts={shared_address:indexScope.shared_address,asset:contract.myAsset,to_address:shared_address,amount:my_amount,arrSigningDeviceAddresses:arrSigningDeviceAddresses,recipient_device_address:correspondent.device_address};fc.sendMultiPayment(opts,function(err){if($scope.bWorking=!1,profileService.bKeepUnlocked=!1,err)return err.match(/device address/)&&(err="This is a private asset, please send it only by clicking links from chat"),err.match(/no funded/)&&(err="Not enough spendable funds, make sure all your funds are confirmed"),void($scope&&($scope.error=err));$rootScope.$emit("NewOutgoingTx"),eventBus.emit("sent_payment",correspondent.device_address,my_amount,contract.myAsset,!0);var paymentRequestCode;if("contract"===contract.peer_pays_to){var arrPayments=[{address:shared_address,amount:peer_amount,asset:contract.peerAsset}],assocDefinitions={};assocDefinitions[shared_address]={definition:arrDefinition,signers:assocSignersByPath};var objPaymentRequest={payments:arrPayments,definitions:assocDefinitions},paymentJson=JSON.stringify(objPaymentRequest),paymentJsonBase64=Buffer(paymentJson).toString("base64");paymentRequestCode="payment:"+paymentJsonBase64}else paymentRequestCode="TTT:"+my_address+"?amount="+peer_amount+"&asset="+encodeURIComponent(contract.peerAsset);var paymentRequestText="[your share of payment to the contract]("+paymentRequestCode+")";device.sendMessageToDevice(correspondent.device_address,"text",paymentRequestText);var body=correspondentListService.formatOutgoingMessage(paymentRequestText);correspondentListService.addMessageEvent(!1,correspondent.device_address,body),correspondent.my_record_pref&&correspondent.peer_record_pref&&chatStorage.store(correspondent.device_address,body,0,"html"),"me"===contract.peer_pays_to&&issueNextAddress()}),$modalInstance.dismiss("cancel")}if(err)return profileService.lockFC(),$scope.error=err,void $timeout(function(){$scope.$digest()},1);if($scope.bWorking)return console.log("already working");var my_amount=contract.myAmount;"base"===contract.myAsset&&(my_amount*=walletSettings.unitValue),contract.myAsset===constants.BLACKBYTES_ASSET&&(my_amount*=walletSettings.bbUnitValue),my_amount=Math.round(my_amount);var peer_amount=contract.peerAmount;if("base"===contract.peerAsset&&(peer_amount*=walletSettings.unitValue),contract.peerAsset===constants.BLACKBYTES_ASSET)throw Error("peer asset cannot be blackbytes");if(peer_amount=Math.round(peer_amount),my_amount===peer_amount&&contract.myAsset===contract.peerAsset&&"contract"===contract.peer_pays_to)return $scope.error="The amounts are equal, you cannot require the peer to pay to the contract.  Please either change the amounts slightly or fund the entire contract yourself and require the peer to pay his half to you.",void $timeout(function(){$scope.$digest()},1);var fnReadMyAddress="contract"===contract.peer_pays_to?readMyPaymentAddress:issueNextAddress;fnReadMyAddress(function(my_address){var arrSeenCondition=["seen",{what:"output",address:"contract"===contract.peer_pays_to?"this address":my_address,asset:contract.peerAsset,amount:peer_amount}];readLastMainChainIndex(function(err,last_mci){if(err)return $scope.error=err,void $timeout(function(){$scope.$digest()},1);var arrExplicitEventCondition=["in data feed",[[contract.oracle_address],contract.feed_name,contract.relation,contract.feed_value+"",last_mci]],arrEventCondition=arrExplicitEventCondition,data_address="me"===contract.data_party?my_address:address,expiry_address="me"===contract.expiry_party?my_address:address,data_device_address="me"===contract.data_party?device.getMyDeviceAddress():correspondent.device_address,expiry_device_address="me"===contract.expiry_party?device.getMyDeviceAddress():correspondent.device_address,arrDefinition=["or",[["and",[arrSeenCondition,["or",[["and",[["address",data_address],arrEventCondition]],["and",[["address",expiry_address],["in data feed",[[configService.TIMESTAMPER_ADDRESS],"timestamp",">",Date.now()+Math.round(24*contract.expiry*3600*1e3)]]]]]]]],["and",[["address",my_address],["not",arrSeenCondition],["in data feed",[[configService.TIMESTAMPER_ADDRESS],"timestamp",">",Date.now()+Math.round(3600*contract.timeout*1e3)]]]]]],assocSignersByPath={"r.0.1.0.0":{address:data_address,member_signing_path:"r",device_address:data_device_address},"r.0.1.1.0":{address:expiry_address,member_signing_path:"r",device_address:expiry_device_address},"r.1.0":{address:my_address,member_signing_path:"r",device_address:device.getMyDeviceAddress()}};walletDefinedByAddresses.createNewSharedAddress(arrDefinition,assocSignersByPath,{ifError:function(err){$scope.bWorking=!1,$scope.error=err,$timeout(function(){$scope.$digest()})},ifOk:function(shared_address){composeAndSend(shared_address,arrDefinition,assocSignersByPath,my_address)}})})})})},$scope.cancel=function(){$modalInstance.dismiss("cancel")}},modalInstance=$modal.open({templateUrl:"views/modals/offer-contract.html",windowClass:animationService.modalAnimated.slideUp,controller:ModalInstanceCtrl,scope:$scope}),disableCloseModal=$rootScope.$on("closeModal",function(){modalInstance.dismiss("cancel")});modalInstance.result["finally"](function(){$rootScope.modalOpened=!1,disableCloseModal();var m=angular.element(document.getElementsByClassName("reveal-modal"));m.addClass(animationService.modalAnimated.slideOutDown)})},$scope.sendMultiPayment=function(paymentJsonBase64){function extractAddressesFromDefinition(arrDefinition){function parse(arrSubdefinition){var op=arrSubdefinition[0];switch(op){case"address":case"cosigned by":assocAddresses[arrSubdefinition[1]]=!0;break;case"or":case"and":arrSubdefinition[1].forEach(parse);break;case"r of set":arrSubdefinition[1].set.forEach(parse);break;case"weighted and":arrSubdefinition[1].set.forEach(function(arg){parse(arg.value)})}}var assocAddresses={};return parse(arrDefinition),Object.keys(assocAddresses)}var async=require("async"),db=require("trustnote-common/db.js"),walletDefinedByAddresses=require("trustnote-common/wallet_defined_by_addresses.js"),paymentJson=Buffer(paymentJsonBase64,"base64").toString("utf8");console.log("multi "+paymentJson);var objMultiPaymentRequest=JSON.parse(paymentJson);$rootScope.modalOpened=!0;var fc=profileService.focusedClient,ModalInstanceCtrl=function($scope,$modalInstance){function insertSharedAddress(shared_address,arrDefinition,signers,cb){db.query("SELECT 1 FROM shared_addresses WHERE shared_address=?",[shared_address],function(rows){return rows.length>0?(console.log("shared address "+shared_address+" already known"),cb()):void walletDefinedByAddresses.handleNewSharedAddress({address:shared_address,definition:arrDefinition,signers:signers},{ifOk:cb,ifError:function(err){throw Error("failed to create shared address "+shared_address+": "+err)}})})}var config=configService.getSync(),configWallet=config.wallet,walletSettings=configWallet.settings;$scope.unitValue=walletSettings.unitValue,$scope.unitName=walletSettings.unitName,$scope.color=fc.backgroundColor,$scope.bDisabled=!0;var assocSharedDestinationAddresses={},createMovementLines=function(){$scope.arrMovements=objMultiPaymentRequest.payments.map(function(objPayment){var text=correspondentListService.getAmountText(objPayment.amount,objPayment.asset||"base")+" to "+objPayment.address;return assocSharedDestinationAddresses[objPayment.address]&&(text+=" (smart address, see below)"),text})};if(objMultiPaymentRequest.definitions){var arrAllMemberAddresses=[],arrFuncs=[],assocMemberAddressesByDestAddress={};for(var destinationAddress in objMultiPaymentRequest.definitions){var arrDefinition=objMultiPaymentRequest.definitions[destinationAddress].definition,arrMemberAddresses=extractAddressesFromDefinition(arrDefinition);assocMemberAddressesByDestAddress[destinationAddress]=arrMemberAddresses,arrAllMemberAddresses=arrAllMemberAddresses.concat(arrMemberAddresses),arrFuncs.push(function(cb){walletDefinedByAddresses.validateAddressDefinition(arrDefinition,cb)})}if(arrAllMemberAddresses=lodash.uniq(arrAllMemberAddresses),0===arrAllMemberAddresses.length)throw Error("no member addresses in "+paymentJson);var findMyAddresses=function(cb){db.query("SELECT address FROM my_addresses WHERE address IN(?) \n                            UNION \n                            SELECT shared_address AS address FROM shared_addresses WHERE shared_address IN(?)",[arrAllMemberAddresses,arrAllMemberAddresses],function(rows){var arrMyAddresses=rows.map(function(row){return row.address});for(var destinationAddress in assocMemberAddressesByDestAddress){var arrMemberAddresses=assocMemberAddressesByDestAddress[destinationAddress];lodash.intersection(arrMemberAddresses,arrMyAddresses).length>0&&(assocSharedDestinationAddresses[destinationAddress]=!0)}createMovementLines(),$scope.arrHumanReadableDefinitions=[];for(var destinationAddress in objMultiPaymentRequest.definitions){var arrDefinition=objMultiPaymentRequest.definitions[destinationAddress].definition;$scope.arrHumanReadableDefinitions.push({destinationAddress:destinationAddress,humanReadableDefinition:correspondentListService.getHumanReadableDefinition(arrDefinition,arrMyAddresses,[])})}cb()})},checkDuplicatePayment=function(cb){var objFirstPayment=objMultiPaymentRequest.payments[0];db.query("SELECT 1 FROM outputs JOIN unit_authors USING(unit) JOIN my_addresses ON unit_authors.address=my_addresses.address \n                            WHERE outputs.address=? AND amount=? LIMIT 1",[objFirstPayment.address,objFirstPayment.amount],function(rows){$scope.bAlreadyPaid=rows.length>0,cb()})};arrFuncs.push(findMyAddresses),arrFuncs.push(checkDuplicatePayment),async.series(arrFuncs,function(err){err?$scope.error=err:$scope.bDisabled=!1,$timeout(function(){$scope.$apply()})})}else $scope.bDisabled=!1;$scope.pay=function(){return console.log("pay"),fc.isPrivKeyEncrypted()?void profileService.unlockFC(null,function(err){return err?($scope.error=err.message,void $timeout(function(){$scope.$apply()})):void $scope.pay()}):void profileService.requestTouchid(function(err){if(err)return profileService.lockFC(),$scope.error=err,void $timeout(function(){$scope.$digest()},1);var arrFuncs=[];for(var destinationAddress in assocSharedDestinationAddresses)!function(){var da=destinationAddress;arrFuncs.push(function(cb){var objDefinitionAndSigners=objMultiPaymentRequest.definitions[da];insertSharedAddress(da,objDefinitionAndSigners.definition,objDefinitionAndSigners.signers,cb)})}();async.series(arrFuncs,function(){var assocOutputsByAsset={};objMultiPaymentRequest.payments.forEach(function(objPayment){var asset=objPayment.asset||"base";assocOutputsByAsset[asset]||(assocOutputsByAsset[asset]=[]),assocOutputsByAsset[asset].push({address:objPayment.address,amount:objPayment.amount})});var arrNonBaseAssets=Object.keys(assocOutputsByAsset).filter(function(asset){return"base"!==asset});if(arrNonBaseAssets.length>1)return $scope.error="more than 1 non-base asset not supported",void $timeout(function(){$scope.$apply()});var asset=arrNonBaseAssets.length>0?arrNonBaseAssets[0]:null,arrBaseOutputs=assocOutputsByAsset.base||[],arrAssetOutputs=asset?assocOutputsByAsset[asset]:null,arrSigningDeviceAddresses=[];fc.credentials.m<fc.credentials.n?indexScope.copayers.forEach(function(copayer){(copayer.me||copayer.signs)&&arrSigningDeviceAddresses.push(copayer.device_address)}):indexScope.shared_address&&(arrSigningDeviceAddresses=indexScope.copayers.map(function(copayer){return copayer.device_address}));var current_multi_payment_key=require("crypto").createHash("sha256").update(paymentJson).digest("base64");if(current_multi_payment_key===indexScope.current_multi_payment_key)return $rootScope.$emit("Local/ShowErrorAlert","This payment is already under way"),void $modalInstance.dismiss("cancel");indexScope.current_multi_payment_key=current_multi_payment_key;var recipient_device_address=lodash.clone(correspondent.device_address);fc.sendMultiPayment({asset:asset,arrSigningDeviceAddresses:arrSigningDeviceAddresses,recipient_device_address:recipient_device_address,base_outputs:arrBaseOutputs,asset_outputs:arrAssetOutputs},function(err){if(delete indexScope.current_multi_payment_key,err)return void(chatScope&&(setError(err),$timeout(function(){chatScope.$apply()})));$rootScope.$emit("NewOutgoingTx");var assocPaymentsByAsset=correspondentListService.getPaymentsByAsset(objMultiPaymentRequest),bToSharedAddress=objMultiPaymentRequest.payments.some(function(objPayment){return assocSharedDestinationAddresses[objPayment.address]});for(var asset in assocPaymentsByAsset)eventBus.emit("sent_payment",recipient_device_address,assocPaymentsByAsset[asset],asset,bToSharedAddress)}),$modalInstance.dismiss("cancel")})})},$scope.cancel=function(){$modalInstance.dismiss("cancel")}},modalInstance=$modal.open({templateUrl:"views/modals/multi-payment.html",windowClass:animationService.modalAnimated.slideUp,controller:ModalInstanceCtrl,scope:$scope}),disableCloseModal=$rootScope.$on("closeModal",function(){modalInstance.dismiss("cancel")});modalInstance.result["finally"](function(){$rootScope.modalOpened=!1,disableCloseModal();var m=angular.element(document.getElementsByClassName("reveal-modal"));
m.addClass(animationService.modalAnimated.slideOutDown)})},$scope.sendVote=function(voteJsonBase64){var db=(require("async"),require("trustnote-common/db.js")),objectHash=require("trustnote-common/object_hash.js"),network=require("trustnote-common/network.js"),voteJson=Buffer(voteJsonBase64,"base64").toString("utf8");console.log("vote "+voteJson);var objVote=JSON.parse(voteJson);$rootScope.modalOpened=!0;var fc=profileService.focusedClient,ModalInstanceCtrl=function($scope,$modalInstance){function setPollQuestion(bFirstAttempt){db.query("SELECT question FROM polls WHERE unit=?",[objVote.poll_unit],function(rows){if(rows.length>1)throw Error("more than 1 poll?");0===rows.length?conf.bLight&&bFirstAttempt?($scope.question="[Fetching the question...]",network.requestProofsOfJointsIfNewOrUnstable([objVote.poll_unit],function(err){return err?($scope.error=err,scopeApply()):void setPollQuestion()})):$scope.question="[No such poll: "+objVote.poll_unit+"]":($scope.question=rows[0].question,$scope.bDisabled=!1),scopeApply()})}function scopeApply(){$timeout(function(){$scope.$apply()})}function readVotingAddresses(handleAddresses){return indexScope.shared_address?handleAddresses([indexScope.shared_address]):void db.query("SELECT address, SUM(amount) AS total FROM my_addresses JOIN outputs USING(address) \n                        WHERE wallet=? AND is_spent=0 AND asset IS NULL GROUP BY address ORDER BY total DESC LIMIT 16",[fc.credentials.walletId],function(rows){var arrAddresses=rows.map(function(row){return row.address});handleAddresses(arrAddresses)})}$scope.choice=objVote.choice,$scope.color=fc.backgroundColor,$scope.bDisabled=!0,setPollQuestion(!0),$scope.vote=function(){return console.log("vote"),fc.isPrivKeyEncrypted()?void profileService.unlockFC(null,function(err){return err?($scope.error=err.message,scopeApply()):void $scope.vote()}):void profileService.requestTouchid(function(err){return err?(profileService.lockFC(),$scope.error=err,scopeApply()):void readVotingAddresses(function(arrAddresses){if(0===arrAddresses.length)return $scope.error="Cannot vote, no funded addresses.",scopeApply();var payload={unit:objVote.poll_unit,choice:objVote.choice},objMessage={app:"vote",payload_location:"inline",payload_hash:objectHash.getBase64Hash(payload),payload:payload},arrSigningDeviceAddresses=[];fc.credentials.m<fc.credentials.n?indexScope.copayers.forEach(function(copayer){(copayer.me||copayer.signs)&&arrSigningDeviceAddresses.push(copayer.device_address)}):indexScope.shared_address&&(arrSigningDeviceAddresses=indexScope.copayers.map(function(copayer){return copayer.device_address}));var current_vote_key=require("crypto").createHash("sha256").update(voteJson).digest("base64");if(current_vote_key===indexScope.current_vote_key)return $rootScope.$emit("Local/ShowErrorAlert","This vote is already under way"),void $modalInstance.dismiss("cancel");var recipient_device_address=lodash.clone(correspondent.device_address);indexScope.current_vote_key=current_vote_key,fc.sendMultiPayment({arrSigningDeviceAddresses:arrSigningDeviceAddresses,paying_addresses:arrAddresses,signing_addresses:arrAddresses,shared_address:indexScope.shared_address,change_address:arrAddresses[0],messages:[objMessage]},function(err){if(delete indexScope.current_vote_key,err)return void(chatScope&&(setError(err),$timeout(function(){chatScope.$apply()})));var body="voted:"+objVote.choice;device.sendMessageToDevice(recipient_device_address,"text",body),correspondentListService.addMessageEvent(!1,recipient_device_address,body),$rootScope.$emit("NewOutgoingTx")}),$modalInstance.dismiss("cancel")})})},$scope.cancel=function(){$modalInstance.dismiss("cancel")}},modalInstance=$modal.open({templateUrl:"views/modals/vote.html",windowClass:animationService.modalAnimated.slideUp,controller:ModalInstanceCtrl,scope:$scope}),disableCloseModal=$rootScope.$on("closeModal",function(){modalInstance.dismiss("cancel")});modalInstance.result["finally"](function(){$rootScope.modalOpened=!1,disableCloseModal();var m=angular.element(document.getElementsByClassName("reveal-modal"));m.addClass(animationService.modalAnimated.slideOutDown)})},$scope.sendCommand=function(command,description){console.log("will send command "+command),$scope.message=command,$scope.send()},$scope.openExternalLink=function(url){"undefined"!=typeof nw?nw.Shell.openExternal(url):isCordova&&cordova.InAppBrowser.open(url,"_system")},$scope.editCorrespondent=function(){go.path("correspondentDevices.correspondentDevice.editCorrespondentDevice")},$scope.loadMoreHistory=function(cb){correspondentListService.loadMoreHistory(correspondent,cb)},$scope.autoScrollEnabled=!0,$scope.loadMoreHistory(function(){for(var i in $scope.messageEvents){var message=$scope.messageEvents[i];if(message.chat_recording_status)return}breadcrumbs.add("correspondent with empty chat opened: "+correspondent.device_address);var message={type:"system",bIncoming:!1,message:JSON.stringify({state:!(!correspondent.peer_record_pref||!correspondent.my_record_pref)}),timestamp:Math.floor(+new Date/1e3),chat_recording_status:!0};chatStorage.store(correspondent.device_address,message.message,0,"system"),$scope.messageEvents.push(correspondentListService.parseMessage(message))}),$scope.goToCorrespondentDevices=function(){$deepStateRedirect.reset("correspondentDevices"),go.path("correspondentDevices")}}).directive("sendPayment",function($compile){return console.log("sendPayment directive"),{replace:!0,link:function($scope,element,attrs){console.log("link called",attrs,element),element.bind("click",function(){console.log("clicked",attrs),$scope.sendPayment(attrs.address)})}}}).directive("dynamic",function($compile){return{restrict:"A",replace:!0,link:function(scope,ele,attrs){scope.$watch(attrs.dynamic,function(html){ele.html(html),$compile(ele.contents())(scope)})}}}).directive("scrollBottom",function($timeout){return{link:function(scope,element){scope.$watchCollection("messageEvents",function(newCollection){newCollection&&$timeout(function(){scope.autoScrollEnabled&&(element[0].scrollTop=element[0].scrollHeight)},100)})}}}).directive("bindToHeight",function($window){return{restrict:"A",link:function(scope,elem,attrs){var attributes=scope.$eval(attrs.bindToHeight),targetElem=angular.element(document.querySelector(attributes[1]));scope.$watch(function(){return targetElem[0].clientHeight},function(newValue,oldValue){newValue!=oldValue&&0!=newValue&&elem.css(attributes[0],newValue+"px")})}}}).directive("ngEnter",function(){return function(scope,element,attrs){element.bind("keydown",function(e){13!==e.which||e.shiftKey||(scope.$apply(function(){scope.$eval(attrs.ngEnter,{e:e})}),e.preventDefault())})}}).directive("whenScrolled",["$timeout",function($timeout){function ScrollPosition(node){this.node=node,this.previousScrollHeightMinusTop=0,this.readyFor="up"}return ScrollPosition.prototype.restore=function(){"up"===this.readyFor&&(this.node.scrollTop=this.node.scrollHeight-this.previousScrollHeightMinusTop)},ScrollPosition.prototype.prepareFor=function(direction){this.readyFor=direction||"up",this.previousScrollHeightMinusTop=this.node.scrollHeight-this.node.scrollTop},function(scope,elm,attr){var raw=elm[0],chatScrollPosition=new ScrollPosition(raw);$timeout(function(){raw.scrollTop=raw.scrollHeight}),elm.bind("scroll",function(){raw.scrollTop+raw.offsetHeight!=raw.scrollHeight?scope.autoScrollEnabled=!1:scope.autoScrollEnabled=!0,raw.scrollTop<=20&&!scope.loadingHistory&&(scope.loadingHistory=!0,chatScrollPosition.prepareFor("up"),scope[attr.whenScrolled](function(){scope.$digest(),chatScrollPosition.restore(),scope.loadingHistory=!1}))})}}]),angular.module("copayApp.controllers").controller("correspondentDevicesController",function($scope,$timeout,configService,profileService,go,correspondentListService,$state,$rootScope){var wallet=require("trustnote-common/wallet.js"),bots=require("trustnote-common/bots.js"),mutex=require("trustnote-common/mutex.js");$scope.editCorrespondentList=!1,$scope.selectedCorrespondentList={};var fc=profileService.focusedClient;$scope.backgroundColor=fc.backgroundColor,$scope.state=$state,$scope.hideRemove=!0;var listScrollTop=0;$scope.$on("$stateChangeStart",function(evt,toState,toParams,fromState){"correspondentDevices"===toState.name&&($scope.readList(),setTimeout(function(){document.querySelector("[ui-view=chat]").scrollTop=listScrollTop,$rootScope.$emit("Local/SetTab","chat",!0)},5))}),$scope.showCorrespondent=function(correspondent){console.log("showCorrespondent",correspondent),correspondentListService.currentCorrespondent=correspondent,listScrollTop=document.querySelector("[ui-view=chat]").scrollTop,go.path("correspondentDevices.correspondentDevice")},$scope.showBot=function(bot){$state.go("correspondentDevices.bot",{id:bot.id})},$scope.toggleEditCorrespondentList=function(){$scope.editCorrespondentList=!$scope.editCorrespondentList,$scope.selectedCorrespondentList={}},$scope.toggleSelectCorrespondentList=function(addr){$scope.selectedCorrespondentList[addr]=!$scope.selectedCorrespondentList[addr]},$scope.newMsgByAddressComparator=function(correspondent){return-$scope.newMessagesCount[correspondent.device_address]||correspondent.name.toLowerCase()},$scope.beginAddCorrespondent=function(){console.log("beginAddCorrespondent"),listScrollTop=document.querySelector("[ui-view=chat]").scrollTop,go.path("correspondentDevices.addCorrespondentDevice")},$scope.readList=function(){$scope.error=null,correspondentListService.list(function(err,ab){return err?void($scope.error=err):(wallet.readDeviceAddressesUsedInSigningPaths(function(arrNotRemovableDeviceAddresses){for(var length=ab.length,i=0;i<length;i++){corrDev=ab[i],corrDevAddr=corrDev.device_address;var ix=arrNotRemovableDeviceAddresses.indexOf(corrDevAddr);corrDev.removable=ix==-1}}),$scope.list=ab,void bots.load(function(err,rows){err&&($scope.botsError=err.toString()),$scope.bots=rows,$scope.$digest()}))})},$scope.hideRemoveButton=function(removable){return $scope.hideRemove||!removable},$scope.remove=function(device_address){mutex.lock(["remove_device"],function(unlock){wallet.determineIfDeviceCanBeRemoved(device_address,function(bRemovable){if(!bRemovable)return unlock(),console.log("device "+device_address+" is not removable");var device=require("trustnote-common/device.js");device.sendMessageToDevice(device_address,"removed_paired_device","removed"),device.removeCorrespondentDevice(device_address,function(){unlock(),$scope.hideRemove=!0,correspondentListService.currentCorrespondent=null,$scope.readList(),$rootScope.$emit("Local/SetTab","chat",!0),setTimeout(function(){document.querySelector("[ui-view=chat]").scrollTop=listScrollTop},5)})})})},$scope.cancel=function(){console.log("cancel clicked"),go.walletHome()}}),angular.module("copayApp.controllers").controller("createController",function($scope,$rootScope,$location,$timeout,$log,lodash,go,profileService,configService,isCordova,gettext,isMobile,derivationPathHelper,correspondentListService){function setError(error){self.error=gettext(error)}var self=this,defaults=configService.getDefaults();this.isWindowsPhoneApp=isMobile.Windows()&&isCordova,$scope.account=1;var defaults=configService.getDefaults();$scope.derivationPath=derivationPathHelper["default"],this.getNumber=function(num){return new Array(num)};var updateRCSelect=function(n){$scope.totalCosigners=n,self.RCValues=lodash.range(1,n+1),($scope.requiredCosigners>n||!$scope.requiredCosigners)&&($scope.requiredCosigners=parseInt(n/2+1))},updateSeedSourceSelect=function(n){self.seedOptions=[{id:"new",label:gettext("New Random Seed")},{id:"set",label:gettext("Specify Seed...")}],$scope.seedSource=self.seedOptions[0]};this.TCValues=lodash.range(2,defaults.limits.totalCosigners+1),$scope.totalCosigners=defaults.wallet.totalCosigners,this.cosigners=[];for(var i=0;i<$scope.totalCosigners-1;i++)this.cosigners.push({});correspondentListService.list(function(err,ab){self.candidate_cosigners=ab,$scope.$digest()}),this.setTotalCosigners=function(tc){var oldLen=self.cosigners.length,newLen=tc-1;if(newLen>oldLen)for(var i=oldLen;i<newLen;i++)self.cosigners.push({});else newLen<oldLen&&(self.cosigners.length=newLen);updateRCSelect(tc),updateSeedSourceSelect(tc),self.seedSourceId=$scope.seedSource.id},this.setMultisig=function(){this.setTotalCosigners(3),$scope.requiredCosigners=2},this.onCorrespondentSelected=function(device_address){console.log(device_address),"new"===device_address&&go.path("correspondentDevices.addCorrespondentDevice")},this.setSeedSource=function(src){self.seedSourceId=$scope.seedSource.id,$timeout(function(){$rootScope.$apply()})},this.create=function(form){if(form&&form.$invalid)return void(this.error=gettext("Please enter the required fields"));if(self.cosigners.length!==$scope.totalCosigners-1)return setError("invalid number of cosigners");var opts={m:$scope.requiredCosigners,n:$scope.totalCosigners,name:form.walletName.$modelValue,networkName:"livenet",cosigners:[]};if($scope.totalCosigners>1){if(opts.cosigners=lodash.uniq(self.cosigners.map(function(cosigner){return cosigner.device_address})),opts.cosigners.length!==$scope.totalCosigners-1)return setError("Please select different co-signers");for(var i=0;i<opts.cosigners.length;i++)if(!opts.cosigners[i]||33!==opts.cosigners[i].length)return setError("Please fill all co-signers")}self._create(opts)},this._create=function(opts){self.loading=!0,$timeout(function(){profileService.createWallet(opts,function(err,walletId){return self.loading=!1,err?($log.warn(err),self.error=err,void $timeout(function(){$rootScope.$apply()})):void(opts.externalSource&&1==opts.n&&$rootScope.$emit("Local/WalletImported",walletId))})},100)},this.formFocus=function(what){this.isWindowsPhoneApp&&(what&&"my-name"==what?(this.hideWalletName=!0,this.hideTabs=!0):what&&"wallet-name"==what?this.hideTabs=!0:(this.hideWalletName=!1,this.hideTabs=!1),$timeout(function(){$rootScope.$digest()},1))},$scope.$on("$destroy",function(){$rootScope.hideWalletNavigation=!1}),updateSeedSourceSelect(1),self.setSeedSource("new"),self.finishHot=0;var crypto=require("crypto");this.BeforeScan=function(){},this.handleQrcode=function(str,callbacks){var re=new RegExp("^TTT:(.+)$","i"),arrMatches=str.match(re);if(!arrMatches)return void(self.isErr=1);str=arrMatches[1];try{var obj_from_coldWallet=JSON.parse(str)}catch(e){return void(self.isErr=1)}if(obj_from_coldWallet.type)switch(obj_from_coldWallet.type){case"c1":self.qrCodeColdwallet1="TTT:"+JSON.stringify(obj_from_coldWallet),self.isErr=0,self.isExists=0,$scope.index.askColdwalletQrcode=!1;break;case"c2":if(self.tempValue==obj_from_coldWallet.v){var opts={m:1,n:1,name:"TTT(*)",xPubKey:self.tempPubKey,account:self.tempAccount,network:"livenet",cosigners:[]},coldDeviceAddr=obj_from_coldWallet.addr;$timeout(function(){profileService.createColdWallet(opts,coldDeviceAddr,function(err,walletId){return err?($log.warn(err),self.error=err,void $timeout(function(){$rootScope.$apply()})):void(opts.externalSource&&1==opts.n&&$rootScope.$emit("Local/WalletImported",walletId))})},100)}else self.isErr=1;break;default:self.isErr=1}},self.isError=function(){if(self.qrCodeColdwallet1)return 0},self.askColdwalletQrcode=function(){if(self.isExists=0,self.isErr=0,0==self.isError()){var re=new RegExp("^TTT:(.+)$","i"),arrMatches=self.qrCodeColdwallet1.match(re);if(!arrMatches)return void(self.isErr=1);var objForColdwallet=arrMatches[1];try{objForColdwallet=JSON.parse(objForColdwallet)}catch(e){return void(self.isErr=1)}if("c1"!=objForColdwallet.type)return void(self.isErr=1);if(!objForColdwallet.v||!objForColdwallet.pub)return void(self.isErr=1);self.tempValue=objForColdwallet.v,self.tempPubKey=objForColdwallet.pub,self.tempAccount=objForColdwallet.n,self.wallet_Id=crypto.createHash("sha256").update(self.tempPubKey.toString(),"utf8").digest("base64"),self.obj_to_sign={type:"h1",id:self.wallet_Id,v:self.tempValue};for(var i=0;i<profileService.profile.credentials.length;i++)if(self.wallet_Id==profileService.profile.credentials[i].walletId)return void(self.isExists=1);self.qrCodeColdwallet2="TTT:"+JSON.stringify(self.obj_to_sign),$scope.index.askColdwalletQrcode=!0,self.finishHot=1}}}),angular.module("copayApp.controllers").controller("disclaimerController",function($scope,$timeout,storageService,applicationService,gettextCatalog,isCordova,uxLanguage,go,$rootScope){!isCordova&&"win32"===process.platform&&navigator.userAgent.indexOf("Windows NT 5.1")>=0&&$rootScope.$emit("Local/ShowAlert","Windows XP is not supported","fi-alert",function(){process.exit()}),$scope.agree=function(){isCordova&&window.plugins.spinnerDialog.show(null,gettextCatalog.getString("Loading..."),!0),$scope.loading=!0,$timeout(function(){storageService.setDisclaimerFlag(function(err){$timeout(function(){isCordova&&window.plugins.spinnerDialog.hide(),go.path("splash")},200)})},100)},$scope.init=function(){storageService.getDisclaimerFlag(function(err,val){$scope.lang=uxLanguage.currentLanguage,$scope.agreed=val,$timeout(function(){$scope.$digest()},1)})}}),angular.module("copayApp.controllers").controller("editCorrespondentDeviceController",function($scope,$rootScope,$timeout,configService,profileService,isCordova,go,correspondentListService,$modal,animationService,gettextCatalog){var fc=profileService.focusedClient;$scope.backgroundColor=fc.backgroundColor;var correspondent=correspondentListService.currentCorrespondent;$scope.correspondent=correspondent,$scope.name=correspondent.name,$scope.hub=correspondent.hub,$scope.save=function(){$scope.error=null,correspondent.name=$scope.name,correspondent.hub=$scope.hub;var device=require("trustnote-common/device.js");device.updateCorrespondentProps(correspondent,function(){go.path("correspondentDevices.correspondentDevice")})},$scope.purge_chat=function(){var ModalInstanceCtrl=function($scope,$modalInstance,$sce,gettext){$scope.title=$sce.trustAsHtml(gettextCatalog.getString("Delete the whole chat history with {{ name }} ?",{name:correspondent.name})),$scope.ok=function(){$modalInstance.close(!0),go.path("correspondentDevices.correspondentDevice")},$scope.cancel=function(){$modalInstance.dismiss("cancel"),go.path("correspondentDevices.correspondentDevice.editCorrespondentDevice")}},modalInstance=$modal.open({templateUrl:"views/modals/confirmation.html",windowClass:animationService.modalAnimated.slideUp,controller:ModalInstanceCtrl});modalInstance.result["finally"](function(){var m=angular.element(document.getElementsByClassName("reveal-modal"));m.addClass(animationService.modalAnimated.slideOutDown)}),modalInstance.result.then(function(ok){if(ok){var chatStorage=require("trustnote-common/chat_storage.js");chatStorage.purge(correspondent.device_address),correspondentListService.messageEventsByCorrespondent[correspondent.device_address]=[]}})}}),angular.module("copayApp.controllers").controller("exportController",function($rootScope,$scope,$timeout,$log,$filter,backupService,storageService,fileSystemService,isCordova,isMobile,gettextCatalog,notification){function addDBAndConfToZip(cb){var dbDirPath=fileSystemService.getDatabaseDirPath()+"/";fileSystemService.readdir(dbDirPath,function(err,listFilenames){return err?cb(err):(listFilenames=listFilenames.filter(function(name){return"conf.json"==name||/\.sqlite/.test(name)}),void(isCordova?async.forEachSeries(listFilenames,function(name,callback){fileSystemService.readFile(dbDirPath+"/"+name,function(err,data){return err?callback(err):(zip.file(name,data),void callback())})},cb):async.forEachSeries(listFilenames,function(name,callback){fileSystemService.getPath(dbDirPath+"/"+name,function(err,path){return err?callback(err):(zip.file(name,path),void callback())})},cb)))})}function checkValueFileAndChangeStatusExported(){$timeout(function(){var inputFile=document.getElementById("nwExportInputFile");!inputFile.value&&self.exporting&&(self.exporting=!1,$timeout(function(){$rootScope.$apply()})),!inputFile.value&&self.connection&&(self.connection.release(),self.connection=!1),window.removeEventListener("focus",checkValueFileAndChangeStatusExported,!0)},1e3)}function saveFile(file,cb){var backupFilename="TrustnoteBackup-"+$filter("date")(Date.now(),"yyyy-MM-dd-HH-mm-ss")+".encrypted";if(isCordova)fileSystemService.cordovaWriteFile(isMobile.iOS()?window.cordova.file.documentsDirectory:window.cordova.file.externalRootDirectory,"Trustnote",backupFilename,file,function(err){cb(err)});else{var inputFile=document.getElementById("nwExportInputFile");inputFile.setAttribute("nwsaveas",backupFilename),inputFile.click(),window.addEventListener("focus",checkValueFileAndChangeStatusExported,!0),inputFile.onchange=function(){cb(this.value)}}}function encrypt(buffer,password){password=Buffer.from(password);for(var cipher=crypto.createCipheriv("aes-256-ctr",crypto.pbkdf2Sync(password,"",1e5,32,"sha512"),crypto.createHash("sha1").update(password).digest().slice(0,16)),arrChunks=[],CHUNK_LENGTH=2003,offset=0;offset<buffer.length;offset+=CHUNK_LENGTH)arrChunks.push(cipher.update(buffer.slice(offset,Math.min(offset+CHUNK_LENGTH,buffer.length)),"utf8"));return arrChunks.push(cipher["final"]()),Buffer.concat(arrChunks)}function showError(text){return self.exporting=!1,self.error=text,$timeout(function(){$rootScope.$apply()}),!1}var zip,async=require("async"),crypto=require("crypto"),conf=require("trustnote-common/conf");if(isCordova){var JSZip=require("jszip");zip=new JSZip}else{var _zip=require("zip");zip=null}var self=this;self.error=null,self.success=null,self.password=null,self.repeatpassword=null,self.exporting=!1,self.isCordova=isCordova,self.bCompression=!1,self.connection=null,self.walletExportPC=function(connection){self.connection=connection,saveFile(null,function(path){if(path){var password=Buffer.from(self.password),cipher=crypto.createCipheriv("aes-256-ctr",crypto.pbkdf2Sync(password,"",1e5,32,"sha512"),crypto.createHash("sha1").update(password).digest().slice(0,16));zip=new _zip(path,{compressed:self.bCompression?6:0,cipher:cipher}),storageService.getProfile(function(err,profile){storageService.getConfig(function(err,config){zip.text("profile",JSON.stringify(profile)),zip.text("config",config),conf.bLight&&zip.text("light","true"),addDBAndConfToZip(function(err){return err?showError(err):void zip.end(function(){connection.release(),self.connection=null,self.exporting=!1,$timeout(function(){$rootScope.$apply(),notification.success(gettextCatalog.getString("Success"),gettextCatalog.getString("Export completed successfully",{}))})})})})})}})},self.walletExportCordova=function(connection){storageService.getProfile(function(err,profile){storageService.getConfig(function(err,config){zip.file("profile",JSON.stringify(profile)),zip.file("config",config),zip.file("light","true"),addDBAndConfToZip(function(err){if(err)return showError(err);var zipParams={type:"nodebuffer",compression:"DEFLATE",compressionOptions:{level:9}};zip.generateAsync(zipParams).then(function(zipFile){saveFile(encrypt(zipFile,self.password),function(err){return connection.release(),err?showError(err):(self.exporting=!1,void $timeout(function(){$rootScope.$apply(),notification.success(gettextCatalog.getString("Success"),gettextCatalog.getString("Export completed successfully",{}))}))})},function(err){showError(err)})})})})},self.walletExport=function(){self.exporting=!0,self.error="";var db=require("trustnote-common/db");db.takeConnectionFromPool(function(connection){isCordova?self.walletExportCordova(connection):self.walletExportPC(connection)})}}),angular.module("copayApp.controllers").controller("howtouse",function(uxLanguage){var self=this;self.isEn=function(){return"en"==uxLanguage.getCurrentLanguage()}}),angular.module("copayApp.controllers").controller("importController",function($scope,$rootScope,$location,$timeout,$log,storageService,fileSystemService,isCordova,isMobile){function generateListFilesForIos(){var backupDirPath=window.cordova.file.documentsDirectory+"/Trustnote/";fileSystemService.readdir(backupDirPath,function(err,listFilenames){listFilenames&&listFilenames.forEach(function(name){var dateNow=parseInt(name.split(" ")[1]);self.arrBackupFiles.push({name:name.replace(dateNow,new Date(dateNow).toLocaleString()),originalName:name,time:dateNow})}),$timeout(function(){$rootScope.$apply()})})}function writeDBAndFileStorageMobile(zip,cb){var db=require("trustnote-common/db"),dbDirPath=fileSystemService.getDatabaseDirPath()+"/";db.close(function(){async.forEachOfSeries(zip.files,function(objFile,key,callback){"profile"==key?zip.file(key).async("string").then(function(data){storageService.storeProfile(Profile.fromString(data),callback)}):"config"==key?zip.file(key).async("string").then(function(data){storageService.storeConfig(data,callback)}):/\.sqlite/.test(key)?zip.file(key).async("nodebuffer").then(function(data){fileSystemService.cordovaWriteFile(dbDirPath,null,key,data,callback)}):callback()},function(err){return err?cb(err):cb()})})}function writeDBAndFileStoragePC(cb){var db=require("trustnote-common/db"),dbDirPath=fileSystemService.getDatabaseDirPath()+"/";db.close(function(){async.series([function(callback){fileSystemService.readFile(dbDirPath+"temp/profile",function(err,data){return err?callback(err):void storageService.storeProfile(Profile.fromString(data.toString()),callback)})},function(callback){fileSystemService.readFile(dbDirPath+"temp/config",function(err,data){return err?callback(err):void storageService.storeConfig(data.toString(),callback)})},function(callback){fileSystemService.readdir(dbDirPath+"temp/",function(err,fileNames){fileNames=fileNames.filter(function(name){return/\.sqlite/.test(name)}),async.forEach(fileNames,function(name,callback2){fileSystemService.nwMoveFile(dbDirPath+"temp/"+name,dbDirPath+name,callback2)},function(err){return err?callback(err):void callback()})})},function(callback){var existsConfJson=fileSystemService.nwExistsSync(dbDirPath+"temp/conf.json"),existsLight=fileSystemService.nwExistsSync(dbDirPath+"temp/light");if(existsConfJson)fileSystemService.nwMoveFile(dbDirPath+"temp/conf.json",dbDirPath+"conf.json",callback);else if(existsLight&&!existsConfJson)fileSystemService.nwWriteFile(dbDirPath+"conf.json",JSON.stringify({bLight:!0},null,"\t"),callback);else if(!existsLight&&conf.bLight){var _conf=require(dbDirPath+"conf.json");_conf.bLight=!1,fileSystemService.nwWriteFile(dbDirPath+"conf.json",JSON.stringify(_conf,null,"\t"),callback)}else callback()},function(callback){fileSystemService.readdir(dbDirPath+"temp/",function(err,fileNames){async.forEach(fileNames,function(name,callback2){fileSystemService.nwUnlink(dbDirPath+"temp/"+name,callback2)},function(err){return err?callback(err):void fileSystemService.nwRmDir(dbDirPath+"temp/",function(){callback()})})})}],function(err){cb(err)})})}function decrypt(buffer,password){password=Buffer.from(password);for(var decipher=crypto.createDecipheriv("aes-256-ctr",crypto.pbkdf2Sync(password,"",1e5,32,"sha512"),crypto.createHash("sha1").update(password).digest().slice(0,16)),arrChunks=[],CHUNK_LENGTH=2003,offset=0;offset<buffer.length;offset+=CHUNK_LENGTH)arrChunks.push(decipher.update(buffer.slice(offset,Math.min(offset+CHUNK_LENGTH,buffer.length)),"utf8"));return arrChunks.push(decipher["final"]()),Buffer.concat(arrChunks)}function showError(text){return self.importing=!1,self.error=text,$timeout(function(){$rootScope.$apply()}),!1}function unzipAndWriteFiles(data,password){if(isCordova)zip.loadAsync(decrypt(data,password)).then(function(zip){zip.file("light")?writeDBAndFileStorageMobile(zip,function(err){return err?showError(err):(self.importing=!1,void $rootScope.$emit("Local/ShowAlert","Import successfully completed, please restart the application.","fi-check",function(){navigator&&navigator.app?navigator.app.exitApp():process.exit&&process.exit()}))}):(self.importing=!1,self.error="Mobile version supports only light wallets.",$timeout(function(){$rootScope.$apply()}))},function(err){showError("Incorrect password or file")});else{password=Buffer.from(password);var decipher=crypto.createDecipheriv("aes-256-ctr",crypto.pbkdf2Sync(password,"",1e5,32,"sha512"),crypto.createHash("sha1").update(password).digest().slice(0,16));data.pipe(decipher).pipe(unzip.Extract({path:fileSystemService.getDatabaseDirPath()+"/temp/"})).on("error",function(err){showError("Invalid signature in zip file"===err.message?"Incorrect password or file":err)}).on("finish",function(){setTimeout(function(){writeDBAndFileStoragePC(function(err){return err?showError(err):(self.importing=!1,void $rootScope.$emit("Local/ShowAlert","Import successfully completed, please restart the application.","fi-check",function(){navigator&&navigator.app?navigator.app.exitApp():process.exit&&process.exit()}))})},100)})}}var JSZip=require("jszip"),async=require("async"),crypto=require("crypto"),conf=require("trustnote-common/conf"),userAgent=navigator.userAgent;if(isCordova)var zip=new JSZip;else var unzip=require("unzip");var self=this;self.importing=!1,self.password="",self.error="",self.iOs=isMobile.iOS(),self.android=isMobile.Android()&&window.cordova,self.arrBackupFiles=[],self.androidVersion=isMobile.Android()?parseFloat(userAgent.slice(userAgent.indexOf("Android")+8)):null,self.oldAndroidFilePath=null,self.oldAndroidFileName="",self.iOs&&generateListFilesForIos(),self.oldAndroidInputFileClick=function(){isMobile.Android()&&self.androidVersion<5&&window.plugins.mfilechooser.open([],function(uri){self.oldAndroidFilePath="file://"+uri,self.oldAndroidFileName=uri.split("/").pop(),$timeout(function(){$rootScope.$apply()})},function(error){alert(error)})},self.walletImport=function(){self.error="",isMobile.Android()&&self.androidVersion<5?(self.importing=!0,fileSystemService.readFile(self.oldAndroidFilePath,function(err,data){unzipAndWriteFiles(data,self.password)})):$scope.file&&(self.importing=!0,fileSystemService.readFileFromForm($scope.file,function(err,data){return err?showError(err):void unzipAndWriteFiles(data,self.password)}))},self.iosWalletImportFromFile=function(fileName){$rootScope.$emit("Local/NeedsPassword",!1,null,function(err,password){if(password){var backupDirPath=window.cordova.file.documentsDirectory+"/Trustnote/";fileSystemService.readFile(backupDirPath+fileName,function(err,data){return err?showError(err):void unzipAndWriteFiles(data,password)})}})},$scope.getFile=function(){$timeout(function(){$rootScope.$apply()})}});var async=require("async"),constants=require("trustnote-common/constants.js"),mutex=require("trustnote-common/mutex.js"),eventBus=require("trustnote-common/event_bus.js"),objectHash=require("trustnote-common/object_hash.js"),ecdsaSig=require("trustnote-common/signature.js"),breadcrumbs=require("trustnote-common/breadcrumbs.js"),Bitcore=require("bitcore-lib");require("events").EventEmitter;angular.module("copayApp.controllers").controller("indexController",function($rootScope,$scope,$log,$filter,$timeout,lodash,go,profileService,configService,isCordova,storageService,addressService,gettext,gettextCatalog,amMoment,nodeWebkit,addonManager,txFormatService,uxLanguage,$state,isMobile,addressbookService,notification,animationService,$modal,bwcService,backButton,pushNotificationsService,newVersion){function updatePublicKeyRing(walletClient,onDone){var walletDefinedByKeys=require("trustnote-common/wallet_defined_by_keys.js");walletDefinedByKeys.readCosigners(walletClient.credentials.walletId,function(arrCosigners){var arrApprovedDevices=arrCosigners.filter(function(cosigner){return cosigner.approval_date}).map(function(cosigner){return cosigner.device_address});console.log("approved devices: "+arrApprovedDevices.join(", ")),walletClient.credentials.addPublicKeyRing(arrApprovedDevices);var credentialsIndex=lodash.findIndex(profileService.profile.credentials,{walletId:walletClient.credentials.walletId});if(credentialsIndex<0)throw Error("failed to find our credentials in profile");profileService.profile.credentials[credentialsIndex]=JSON.parse(walletClient["export"]()),console.log("saving profile: "+JSON.stringify(profileService.profile)),
storageService.storeProfile(profileService.profile,function(){onDone&&onDone()})})}function sendBugReport(error_message,error_object){var conf=require("trustnote-common/conf.js"),network=require("trustnote-common/network.js"),bug_sink_url=conf.WS_PROTOCOL+(conf.bug_sink_url||configService.getSync().hub);network.findOutboundPeerOrConnect(bug_sink_url,function(err,ws){if(!err){breadcrumbs.add("bugreport");var description=error_object.stack||JSON.stringify(error_object,null,"\t");error_object.bIgnore&&(description+="\n(ignored)"),description+="\n\nBreadcrumbs:\n"+breadcrumbs.get().join("\n")+"\n\n",description+="UA: "+navigator.userAgent+"\n",description+="Language: "+(navigator.userLanguage||navigator.language)+"\n",description+="Program: "+conf.program+" "+conf.program_version+"\n",network.sendJustsaying(ws,"bugreport",{message:error_message,exception:description})}})}function readLastDateString(cb){var conf=require("trustnote-common/conf.js");if("sqlite"!==conf.storage)return cb();var db=require("trustnote-common/db.js");db.query("SELECT int_value FROM unit_authors JOIN data_feeds USING(unit) \n\t\t\tWHERE address=? AND feed_name='timestamp' \n\t\t\tORDER BY unit_authors.rowid DESC LIMIT 1",[configService.TIMESTAMPER_ADDRESS],function(rows){if(0===rows.length)return cb();var ts=rows[0].int_value;cb("at "+$filter("date")(ts,"short"))})}function setSyncProgress(percent){readLastDateString(function(strProgress){self.syncProgress=strProgress||percent+"% of new units",$timeout(function(){$rootScope.$apply()})})}function determineIfAddressUsed(address,db,cb){db.query("SELECT 1 FROM outputs WHERE address = ? LIMIT 1",[address],function(outputsRows){1===outputsRows.length?cb(!0):db.query("SELECT 1 FROM unit_authors WHERE address = ? LIMIT 1",[address],function(unitAuthorsRows){cb(1===unitAuthorsRows.length)})})}function scanForAddresses(cb){function checkAndAddCurrentAddress(is_change){function checkHistory(){var address=objectHash.getChash160(["sig",{pubkey:wallet_defined_by_keys.derivePubkey(xPubKey,"m/"+is_change+"/"+currentAddressIndex)}]);determineIfAddressUsed(address,db,function(bUsed){bUsed?(lastUsedAddressIndex=currentAddressIndex,is_change?assocMaxAddressIndexes[walletId].change=currentAddressIndex:assocMaxAddressIndexes[walletId].main=currentAddressIndex,currentAddressIndex++,checkAndAddCurrentAddress(is_change)):(currentAddressIndex++,currentAddressIndex-lastUsedAddressIndex>20?is_change?(assocMaxAddressIndexes[walletId].init_main>0&&assocMaxAddressIndexes[walletId].init_main--,cb(assocMaxAddressIndexes,walletId)):(currentAddressIndex=0,lastUsedAddressIndex=-1,checkAndAddCurrentAddress(1)):checkAndAddCurrentAddress(is_change))})}assocMaxAddressIndexes[walletId]||(assocMaxAddressIndexes[walletId]={init_main:0,main:0,init_change:0,change:0}),!is_change&&!readNextAddressCount||is_change&&readNextAddressCount?wallet_defined_by_keys.readNextAddressIndex(walletId,is_change,function(index){currentAddressIndex=index,lastUsedAddressIndex=index,is_change?(assocMaxAddressIndexes[walletId].init_change=index,readNextAddressCount=0,checkHistory()):(assocMaxAddressIndexes[walletId].init_main=index,readNextAddressCount=1,checkHistory())}):checkHistory()}var wallet_defined_by_keys=require("trustnote-common/wallet_defined_by_keys.js"),db=require("trustnote-common/db.js"),fc=profileService.focusedClient,xPubKey=fc.credentials.xPubKey,walletId=fc.credentials.walletId,currentAddressIndex=0,lastUsedAddressIndex=-1,assocMaxAddressIndexes={},readNextAddressCount=0;checkAndAddCurrentAddress(0)}function scanForAddressesLignt(cb){function checkAndAddCurrentAddresses(is_change){function checkHistory(){var arrTmpAddresses=[];wallet_address_index<0&&(wallet_address_index=0);for(var i=wallet_address_index;i<wallet_address_index+20;i++){var index=(is_change?assocMaxAddressIndexes[walletId].change:assocMaxAddressIndexes[walletId].main)+i;arrTmpAddresses.push(objectHash.getChash160(["sig",{pubkey:wallet_defined_by_keys.derivePubkey(xPubKey,"m/"+is_change+"/"+index)}]))}myWitnesses.readMyWitnesses(function(arrWitnesses){network.requestFromLightVendor("light/get_history",{addresses:arrTmpAddresses,witnesses:arrWitnesses},function(ws,request,response){if(response&&response.error){var breadcrumbs=require("trustnote-common/breadcrumbs.js");return void breadcrumbs.add("Error scanForAddressesAndWalletsInLightClient: "+response.error)}Object.keys(response).length?(is_change?assocMaxAddressIndexes[walletId].change+=20:assocMaxAddressIndexes[walletId].main+=20,checkAndAddCurrentAddresses(is_change)):is_change?0===assocMaxAddressIndexes[walletId].change&&0===assocMaxAddressIndexes[walletId].main?delete assocMaxAddressIndexes[walletId]:cb(assocMaxAddressIndexes,walletId):checkAndAddCurrentAddresses(1)})})}var wallet_address_index=0;assocMaxAddressIndexes[walletId]||(assocMaxAddressIndexes[walletId]={init_main:0,main:0,init_change:0,change:0}),!is_change&&!readNextAddressCount||is_change&&readNextAddressCount?wallet_defined_by_keys.readNextAddressIndex(walletId,is_change,function(index){wallet_address_index=index,is_change?(assocMaxAddressIndexes[walletId].init_change=index,readNextAddressCount=0,checkHistory()):(assocMaxAddressIndexes[walletId].init_main=index,readNextAddressCount=1,checkHistory())}):checkHistory()}var myWitnesses=require("trustnote-common/my_witnesses"),wallet_defined_by_keys=require("trustnote-common/wallet_defined_by_keys.js"),network=require("trustnote-common/network"),fc=profileService.focusedClient,xPubKey=fc.credentials.xPubKey,walletId=fc.credentials.walletId,assocMaxAddressIndexes={},readNextAddressCount=0;checkAndAddCurrentAddresses(0)}function addAddresses(assocMaxAddressIndexes,walletId){function addAddress(wallet,is_change,index,maxIndex){console.log("\n+++++++++++++++++++++++"+is_change+"change"+index+"------"+maxIndex),wallet_defined_by_keys.issueAddress(wallet,is_change,index,function(addressInfo){if(index++,index<=maxIndex)addAddress(wallet,is_change,index,maxIndex);else{if(is_change)return;startAddToNewWallet(1)}})}function startAddToNewWallet(is_change){if(is_change){if(!assocMaxAddressIndexes[walletId].change)return;addAddress(walletId,1,assocMaxAddressIndexes[walletId].init_change,assocMaxAddressIndexes[walletId].change)}else addAddress(walletId,0,assocMaxAddressIndexes[walletId].init_main,assocMaxAddressIndexes[walletId].main)}var wallet_defined_by_keys=require("trustnote-common/wallet_defined_by_keys.js");startAddToNewWallet(0),self.updateHistory()}function getNumberOfSelectedSigners(){var count=1;return self.copayers.forEach(function(copayer){copayer.signs&&count++}),count}breadcrumbs.add("index.js");var self=this;if(self.splashClick=!0,self.BLACKBYTES_ASSET=constants.BLACKBYTES_ASSET,self.isCordova=isCordova,self.isSafari=isMobile.Safari(),self.onGoingProcess={},self.historyShowLimit=10,self.updatingTxHistory={},self.bSwipeSuspended=!1,self.arrBalances=[],self.assetIndex=0,self.assetIndexxx=0,self.$state=$state,self.usePushNotifications=isCordova&&!isMobile.Windows()&&isMobile.Android(),self.lightToHubTimeoutCount=0,self.showneikuang=!1,self.showneikuangsync=!1,self.isObserved=function(){return go.observed},self.toPay=function(){return go.toPay},self.closeToPay=function(){go.toPay=0},self.to_address=function(){return go.objDetail.to_address},self.amount=function(){return go.objDetail.amount},self.showToPay=function(){profileService.checkPassClose=!1;var path=go.paths,text_to_sign=go.text_to_sign;if(profileService.focusedClient.isPrivKeyEncrypted())return void profileService.passWrongUnlockFC(null,function(err){if("cancel"==err)profileService.checkPassClose=!0;else{if(err)return;var xPrivKey=new Bitcore.HDPrivateKey.fromString(profileService.focusedClient.credentials.xPrivKey),privateKey=xPrivKey.derive(path).privateKey,privKeyBuf=privateKey.bn.toBuffer({size:32});self.passModalMaskColdQr1=1,self.signature=ecdsaSig.sign(text_to_sign,privKeyBuf),self.signatureObj={type:"c3",sign:self.signature,v:go.objDetail.v},self.signatureObj="TTT:"+JSON.stringify(self.signatureObj)}});var xPrivKey=new Bitcore.HDPrivateKey.fromString(profileService.focusedClient.credentials.xPrivKey),privateKey=xPrivKey.derive(path).privateKey,privKeyBuf=privateKey.bn.toBuffer({size:32});self.passModalMaskColdQr1=1,self.signature=ecdsaSig.sign(text_to_sign,privKeyBuf),self.signatureObj={type:"c3",sign:self.signature,v:go.objDetail.v},self.signatureObj="TTT:"+JSON.stringify(self.signatureObj)},self.showTitle=1,self.sendBugReport=sendBugReport,isCordova&&"1.0"===constants.version){var db=require("trustnote-common/db.js");db.query("SELECT 1 FROM units WHERE version!=? LIMIT 1",[constants.version],function(rows){rows.length>0&&self.showErrorPopup("Looks like you have testnet data.  Please remove the app and reinstall.",function(){navigator&&navigator.app&&navigator.app.exitApp()})})}eventBus.on("nonfatal_error",function(error_message,error_object){console.log("nonfatal error stack",error_object.stack),error_object.bIgnore=!0,sendBugReport(error_message,error_object)}),eventBus.on("uncaught_error",function(error_message,error_object){return error_message.indexOf("ECONNREFUSED")>=0||error_message.indexOf("host is unreachable")>=0?void $rootScope.$emit("Local/ShowAlert","Error connecting to TOR","fi-alert",function(){go.path("preferencesGlobal.preferencesTor")}):void(error_message.indexOf("ttl expired")>=0||error_message.indexOf("general SOCKS server failure")>=0||(console.log("stack",error_object.stack),sendBugReport(error_message,error_object),error_object&&error_object.bIgnore||(self.showErrorPopup(error_message,function(){var db=require("trustnote-common/db.js");db.close(),self.isCordova&&navigator&&navigator.app?navigator.app.exitApp():process.exit&&process.exit()}),isCordova&&wallet.showCompleteClient())))});var catchup_balls_at_start=-1;eventBus.on("catching_up_started",function(){self.setOngoingProcess("Syncing",!0),setSyncProgress(0)}),eventBus.on("catchup_balls_left",function(count_left){self.anyOnGoingProcess||(self.anyOnGoingProcess=!0,self.onGoingProcessName="Syncing"),catchup_balls_at_start===-1&&(catchup_balls_at_start=count_left);var percent=Math.round((catchup_balls_at_start-count_left)/catchup_balls_at_start*100);setSyncProgress(percent)}),eventBus.on("catching_up_done",function(){catchup_balls_at_start=-1,self.setOngoingProcess("Syncing",!1),self.syncProgress="",scanForAddresses(addAddresses)}),eventBus.on("unhandled_private_payments_left",function(count_left){var bChanged=self.count_unhandled_private_payments!==count_left;self.count_unhandled_private_payments=count_left,bChanged&&self.setOngoingProcess("handling_private",count_left>0)}),eventBus.on("refresh_light_started",function(){console.log("refresh_light_started"),self.setOngoingProcess("Syncing",!0),$timeout(function(){self.setOngoingProcess("Syncing",!1)},6e4)}),eventBus.on("refresh_light_done",function(){console.log("refresh_light_done"),self.setOngoingProcess("Syncing",!1),scanForAddressesLignt(addAddresses)}),eventBus.on("refresh_light_timeout",function(){self.lightToHubTimeoutCount++,console.log("refresh_light_timeout"),self.setOngoingProcess("Syncing",!1);var lightWallet=require("trustnote-common/light_wallet.js");self.lightToHubTimeoutCount>3&&(self.lightToHubTimeoutCount=0,console.log("refresh_light_timeout "+configService.stableHub),lightWallet.setLightVendorHost(configService.stableHub)),lightWallet.refreshLightClientHistory()}),eventBus.on("confirm_on_other_devices",function(){$rootScope.$emit("Local/ShowAlert","Transaction created.\nPlease approve it on the other devices.","fi-key",function(){go.walletHome()})}),eventBus.on("refused_to_sign",function(device_address){var device=require("trustnote-common/device.js");device.readCorrespondent(device_address,function(correspondent){notification.success(gettextCatalog.getString("Refused"),correspondent.name+" refused to sign the transaction")})}),eventBus.on("new_my_transactions",function(){breadcrumbs.add("new_my_transactions"),self.updateAll(),self.updateTxHistory()}),eventBus.on("my_transactions_became_stable",function(){breadcrumbs.add("my_transactions_became_stable"),self.updateAll(),self.updateTxHistory()}),eventBus.on("maybe_new_transactions",function(){breadcrumbs.add("maybe_new_transactions"),self.updateAll(),self.updateTxHistory()}),eventBus.on("wallet_approved",function(walletId,device_address){console.log("wallet_approved "+walletId+" by "+device_address);var client=profileService.walletClients[walletId];if(client){var walletName=client.credentials.walletName;updatePublicKeyRing(client);var device=require("trustnote-common/device.js");device.readCorrespondent(device_address,function(correspondent){notification.success(gettextCatalog.getString("Success"),"Wallet "+walletName+" approved by "+correspondent.name)})}}),eventBus.on("wallet_declined",function(walletId,device_address){var client=profileService.walletClients[walletId];if(client){var walletName=client.credentials.walletName,device=require("trustnote-common/device.js");device.readCorrespondent(device_address,function(correspondent){notification.info(gettextCatalog.getString("Declined"),"Wallet "+walletName+" declined by "+correspondent.name)}),profileService.deleteWallet({client:client},function(err){err&&console.log(err)})}}),eventBus.on("wallet_completed",function(walletId){console.log("wallet_completed "+walletId);var client=profileService.walletClients[walletId];if(client){var walletName=client.credentials.walletName;updatePublicKeyRing(client,function(){if(!client.isComplete())throw Error("not complete");notification.success(gettextCatalog.getString("Success"),"Wallet "+walletName+" is ready"),$rootScope.$emit("Local/WalletCompleted")})}}),eventBus.on("create_new_wallet",function(walletId,arrWalletDefinitionTemplate,arrDeviceAddresses,walletName,arrOtherCosigners){var device=require("trustnote-common/device.js"),walletDefinedByKeys=require("trustnote-common/wallet_defined_by_keys.js");device.readCorrespondentsByDeviceAddresses(arrDeviceAddresses,function(arrCorrespondentInfos){var arrNames=arrCorrespondentInfos.map(function(correspondent){return correspondent.name}),name_list=arrNames.join(", "),question=gettextCatalog.getString("Create new wallet "+walletName+" together with "+name_list+" ?");requestApproval(question,{ifYes:function(){console.log("===== YES CLICKED");var createNewWallet=function(){walletDefinedByKeys.readNextAccount(function(account){var walletClient=bwcService.getClient();if(!profileService.focusedClient.credentials.xPrivKey)throw Error("no profileService.focusedClient.credentials.xPrivKeyin createNewWallet");walletClient.seedFromExtendedPrivateKey(profileService.focusedClient.credentials.xPrivKey,account),walletDefinedByKeys.approveWallet(walletId,walletClient.credentials.xPubKey,account,arrWalletDefinitionTemplate,arrOtherCosigners,function(){walletClient.credentials.walletId=walletId,walletClient.credentials.network="livenet";var n=arrDeviceAddresses.length,m=arrWalletDefinitionTemplate[1].required||n;walletClient.credentials.addWalletInfo(walletName,m,n),updatePublicKeyRing(walletClient),profileService._addWalletClient(walletClient,{},function(){console.log("switched to newly approved wallet "+walletId)})})})};profileService.focusedClient.credentials.xPrivKey?createNewWallet():profileService.insistUnlockFC(null,createNewWallet)},ifNo:function(){console.log("===== NO CLICKED"),walletDefinedByKeys.cancelWallet(walletId,arrDeviceAddresses,arrOtherCosigners)}})})});var assocChoicesByUnit={};eventBus.on("signing_request",function(objAddress,top_address,objUnit,assocPrivatePayloads,from_address,signing_path){function createAndSendSignature(){var coin="0",path="m/44'/"+coin+"'/"+objAddress.account+"'/"+objAddress.is_change+"/"+objAddress.address_index;if(console.log("path "+path),profileService.focusedClient.isPrivKeyEncrypted())return console.log("priv key is encrypted, will be back after password request"),profileService.insistUnlockFC(null,function(){createAndSendSignature()});var xPrivKey=new Bitcore.HDPrivateKey.fromString(profileService.focusedClient.credentials.xPrivKey),privateKey=xPrivKey.derive(path).privateKey;console.log("priv key:",privateKey);var privKeyBuf=privateKey.bn.toBuffer({size:32});console.log("priv key buf:",privKeyBuf);var buf_to_sign=objectHash.getUnitHashToSign(objUnit),signature=ecdsaSig.sign(buf_to_sign,privKeyBuf);bbWallet.sendSignature(from_address,buf_to_sign.toString("base64"),signature,signing_path,top_address),console.log("sent signature "+signature)}function refuseSignature(){var buf_to_sign=objectHash.getUnitHashToSign(objUnit);bbWallet.sendSignature(from_address,buf_to_sign.toString("base64"),"[refused]",signing_path,top_address),console.log("refused signature")}var bbWallet=require("trustnote-common/wallet.js"),walletDefinedByKeys=require("trustnote-common/wallet_defined_by_keys.js"),unit=objUnit.unit,credentials=lodash.find(profileService.profile.credentials,{walletId:objAddress.wallet});mutex.lock(["signing_request-"+unit],function(unlock){return assocChoicesByUnit[unit]&&!profileService.focusedClient.isPrivKeyEncrypted()?("approve"===assocChoicesByUnit[unit]?createAndSendSignature():"refuse"===assocChoicesByUnit[unit]&&refuseSignature(),unlock()):void walletDefinedByKeys.readChangeAddresses(objAddress.wallet,function(arrChangeAddressInfos){var arrAuthorAddresses=objUnit.authors.map(function(author){return author.address}),arrChangeAddresses=arrChangeAddressInfos.map(function(info){return info.address});arrChangeAddresses=arrChangeAddresses.concat(arrAuthorAddresses),arrChangeAddresses.push(top_address);var arrPaymentMessages=objUnit.messages.filter(function(objMessage){return"payment"===objMessage.app});if(0===arrPaymentMessages.length)throw Error("no payment message found");var assocAmountByAssetAndAddress={};async.eachSeries(arrPaymentMessages,function(objMessage,cb){var payload=objMessage.payload;if(payload||(payload=assocPrivatePayloads[objMessage.payload_hash]),!payload)throw Error("no inline payload and no private payload either, message="+JSON.stringify(objMessage));var asset=payload.asset||"base";if(!payload.outputs)throw Error("no outputs");assocAmountByAssetAndAddress[asset]||(assocAmountByAssetAndAddress[asset]={}),payload.outputs.forEach(function(output){arrChangeAddresses.indexOf(output.address)===-1&&(assocAmountByAssetAndAddress[asset][output.address]||(assocAmountByAssetAndAddress[asset][output.address]=0),assocAmountByAssetAndAddress[asset][output.address]+=output.amount)}),cb()},function(){var config=configService.getSync().wallet.settings,unitName=config.unitName,bbUnitName=config.bbUnitName,arrDestinations=[];for(var asset in assocAmountByAssetAndAddress){var formatted_asset=isCordova?asset:"<span class='small'>"+asset+"</span><br/>",currency="of asset "+formatted_asset,assetName=asset;"base"===asset?(currency=unitName,assetName="base"):asset===constants.BLACKBYTES_ASSET&&(currency=bbUnitName,assetName="blackbytes");for(var address in assocAmountByAssetAndAddress[asset])arrDestinations.push(profileService.formatAmount(assocAmountByAssetAndAddress[asset][address],assetName)+" "+currency+" to "+address)}var dest=arrDestinations.length>0?arrDestinations.join(", "):"to myself",question=gettextCatalog.getString("Sign transaction spending "+dest+" from wallet "+credentials.walletName+"?");requestApproval(question,{ifYes:function(){createAndSendSignature(),assocChoicesByUnit[unit]="approve",unlock()},ifNo:function(){console.log("===== NO CLICKED"),refuseSignature(),assocChoicesByUnit[unit]="refuse",unlock()}})})})})});var accept_msg=gettextCatalog.getString("Yes"),cancel_msg=gettextCatalog.getString("No"),confirm_msg=gettextCatalog.getString("Confirm"),_modalRequestApproval=function(question,callbacks){var ModalInstanceCtrl=function($scope,$modalInstance,$sce,gettext){$scope.title=$sce.trustAsHtml(question),$scope.yes_icon="fi-check",$scope.yes_button_class="primary",$scope.cancel_button_class="warning",$scope.cancel_label="No",$scope.loading=!1,$scope.ok=function(){$scope.loading=!0,$modalInstance.close(accept_msg)},$scope.cancel=function(){$modalInstance.dismiss(cancel_msg)}},modalInstance=$modal.open({templateUrl:"views/modals/confirmation.html",windowClass:animationService.modalAnimated.slideUp,controller:ModalInstanceCtrl});modalInstance.result["finally"](function(){var m=angular.element(document.getElementsByClassName("reveal-modal"));m.addClass(animationService.modalAnimated.slideOutDown)}),modalInstance.result.then(callbacks.ifYes,callbacks.ifNo)},requestApproval=function(question,callbacks){isCordova?navigator.notification.confirm(question,function(buttonIndex){1==buttonIndex?callbacks.ifYes():callbacks.ifNo()},confirm_msg,[accept_msg,cancel_msg]):_modalRequestApproval(question,callbacks)};self.openSubwalletModal=function(){$rootScope.modalOpened=!0;var fc=profileService.focusedClient,ModalInstanceCtrl=function($scope,$modalInstance){$scope.color=fc.backgroundColor,$scope.indexCtl=self;var arrSharedWallets=[];$scope.mainWalletBalanceInfo=self.arrMainWalletBalances[self.assetIndex],$scope.asset=$scope.mainWalletBalanceInfo.asset;var assocSharedByAddress=self.arrBalances[self.assetIndex].assocSharedByAddress;for(var sa in assocSharedByAddress){var objSharedWallet={};objSharedWallet.shared_address=sa,objSharedWallet.total=assocSharedByAddress[sa],"base"==$scope.asset?objSharedWallet.totalStr=profileService.formatAmount(assocSharedByAddress[sa],"base")+" "+self.unitName:$scope.asset==constants.BLACKBYTES_ASSET&&(objSharedWallet.totalStr=profileService.formatAmount(assocSharedByAddress[sa],"blackbytes")+" "+self.bbUnitName),arrSharedWallets.push(objSharedWallet)}$scope.arrSharedWallets=arrSharedWallets;var walletDefinedByAddresses=require("trustnote-common/wallet_defined_by_addresses.js");async.eachSeries(arrSharedWallets,function(objSharedWallet,cb){walletDefinedByAddresses.readSharedAddressCosigners(objSharedWallet.shared_address,function(cosigners){objSharedWallet.shared_address_cosigners=cosigners.map(function(cosigner){return cosigner.name}).join(", "),objSharedWallet.creation_ts=cosigners[0].creation_ts,cb()})},function(){arrSharedWallets.sort(function(o1,o2){return o2.creation_ts-o1.creation_ts}),$timeout(function(){$scope.$apply()})}),$scope.cancel=function(){breadcrumbs.add("openSubwalletModal cancel"),$modalInstance.dismiss("cancel")},$scope.selectSubwallet=function(shared_address){self.shared_address=shared_address,shared_address?walletDefinedByAddresses.determineIfHasMerkle(shared_address,function(bHasMerkle){self.bHasMerkle=bHasMerkle,walletDefinedByAddresses.readSharedAddressCosigners(shared_address,function(cosigners){self.shared_address_cosigners=cosigners.map(function(cosigner){return cosigner.name}).join(", "),$timeout(function(){$rootScope.$apply()})})}):self.bHasMerkle=!1,self.updateAll(),self.updateTxHistory(),$modalInstance.close()}},modalInstance=$modal.open({templateUrl:"views/modals/select-subwallet.html",windowClass:animationService.modalAnimated.slideUp,controller:ModalInstanceCtrl}),disableCloseModal=$rootScope.$on("closeModal",function(){breadcrumbs.add("openSubwalletModal on closeModal"),modalInstance.dismiss("cancel")});modalInstance.result["finally"](function(){$rootScope.modalOpened=!1,disableCloseModal();var m=angular.element(document.getElementsByClassName("reveal-modal"));m.addClass(animationService.modalAnimated.slideOutDown)})},self.goHome=function(){go.walletHome()},self.menu=[{title:gettext("Home"),icon:"icon-home",link:"walletHome"},{title:gettext("Transaction"),icon:"icon-paperplane",link:"send"},{title:gettext("Message"),icon:"icon-bubble",new_state:"correspondentDevices",link:"chat"},{title:gettext("Wallet"),icon:"icon-wallets",new_state:"mywallet",link:"mywallet"}],self.addonViews=addonManager.addonViews(),self.menu=self.menu.concat(addonManager.addonMenuItems()),self.menuItemSize=self.menu.length>5?2:3,self.txTemplateUrl=addonManager.txTemplateUrl()||"views/includes/transaction.html",self.tab="walletHome",self.setOngoingProcess=function(processName,isOn){$log.debug("onGoingProcess",processName,isOn),self[processName]=isOn,self.onGoingProcess[processName]=isOn;var name;self.anyOnGoingProcess=lodash.any(self.onGoingProcess,function(isOn,processName){return isOn&&(name=name||processName),isOn}),self.onGoingProcessName=name,$timeout(function(){$rootScope.$apply()})},self.setFocusedWallet=function(){var fc=profileService.focusedClient;if(fc){breadcrumbs.add("setFocusedWallet "+fc.credentials.walletId),self.totalBalanceBytes=null,self.lockedBalanceBytes=null,self.availableBalanceBytes=null,self.pendingAmount=null,self.spendUnconfirmed=null,self.totalBalanceStr=null,self.availableBalanceStr=null,self.lockedBalanceStr=null,self.arrBalances=[],self.assetIndex=0,self.shared_address=null,self.bHasMerkle=!1,self.txHistory=[],self.completeHistory=[],self.txProgress=0,self.historyShowShowAll=!1,self.balanceByAddress=null,self.pendingTxProposalsCountForUs=null,self.setSpendUnconfirmed();var device=require("trustnote-common/device.js");$timeout(function(){self.hasProfile=!0,storageService.gethaschoosen(function(err,val){self.haschoosen=val}),fc.observed&&device.uPMyColdDeviceAddress(fc.credentials.walletId),self.noFocusedWallet=!1,self.onGoingProcess={},self.m=fc.credentials.m,self.n=fc.credentials.n,self.network=fc.credentials.network,self.requiresMultipleSignatures=fc.credentials.m>1,self.walletName=fc.credentials.walletName,self.walletId=fc.credentials.walletId,self.isComplete=fc.isComplete(),self.canSign=fc.canSign(),self.isPrivKeyExternal=fc.isPrivKeyExternal(),self.isPrivKeyEncrypted=fc.isPrivKeyEncrypted(),self.externalSource=fc.getPrivKeyExternalSourceName(),self.account=fc.credentials.account,self.txps=[],self.copayers=[],self.updateColor(),self.updateAlias(),self.setAddressbook(),self.needsBackup=!1,self.openWallet()})}},self.setTab=function(tab,reset,tries,switchState){console.log("setTab",tab,reset,tries,switchState),tries=tries||0;var changeTab=function(tab){if(document.querySelector(".tab-in.tab-view")){var el=angular.element(document.querySelector(".tab-in.tab-view"));el.removeClass("tab-in").addClass("tab-out");var old=document.getElementById("menu-"+self.tab);old&&(old.className="")}if(document.getElementById(tab)){var el=angular.element(document.getElementById(tab));el.removeClass("tab-out").addClass("tab-in");var newe=document.getElementById("menu-"+tab);newe&&(newe.className="active")}$rootScope.tab=self.tab=tab,$rootScope.$emit("Local/TabChanged",tab)};return"object"==typeof tab?(tab.new_state||backButton.clearHistory(),tab.open?(tab.link&&($rootScope.tab=self.tab=tab.link),void tab.open()):tab.new_state?(changeTab(tab.link),$rootScope.tab=self.tab=tab.link,void go.path(tab.new_state)):self.setTab(tab.link,reset,tries,switchState)):(console.log("current tab "+self.tab+", requested to set tab "+tab+", reset="+reset),self.tab!==tab||reset?!document.getElementById("menu-"+tab)&&++tries<5?(console.log("will retry setTab later:",tab,reset,tries,switchState),$timeout(function(){self.setTab(tab,reset,tries,switchState)},1===tries?10:300)):(self.tab&&$state.is("walletHome")||($rootScope.tab=self.tab="walletHome"),switchState&&!$state.is("walletHome")?void go.path("walletHome",function(){changeTab(tab)}):void changeTab(tab)):void 0)},self.updateAll=function(opts){opts=opts||{};var fc=profileService.focusedClient;if(!fc)return breadcrumbs.add("updateAll no fc");if(!fc.isComplete())return breadcrumbs.add("updateAll not complete yet");var device=require("trustnote-common/device.js");device.loginToHub(),$timeout(function(){opts.quiet||self.setOngoingProcess("updatingStatus",!0),$log.debug("Updating Status:",fc.credentials.walletName),opts.quiet||self.setOngoingProcess("updatingStatus",!1),fc.getBalance(self.shared_address,function(err,assocBalances,assocSharedBalances){if(err)throw"impossible getBal";$log.debug("updateAll Wallet Balance:",assocBalances,assocSharedBalances),self.setBalance(assocBalances,assocSharedBalances),$rootScope.$emit("Local/BalanceUpdated",assocBalances),self.isPrivKeyEncrypted||$rootScope.$emit("Local/BalanceUpdatedAndWalletUnlocked")}),self.otherWallets=lodash.filter(profileService.getWallets(self.network),function(w){return w.id!=self.walletId||self.shared_address}),opts.triggerTxUpdate&&$timeout(function(){breadcrumbs.add("triggerTxUpdate"),self.updateTxHistory()},1);var conf=require("trustnote-common/conf.js");conf.bLight||scanForAddresses(addAddresses)})},self.setSpendUnconfirmed=function(){self.spendUnconfirmed=configService.getSync().wallet.spendUnconfirmed},self.updateBalance=function(){var fc=profileService.focusedClient;$timeout(function(){self.setOngoingProcess("updatingBalance",!0),$log.debug("Updating Balance"),fc.getBalance(self.shared_address,function(err,assocBalances,assocSharedBalances){if(self.setOngoingProcess("updatingBalance",!1),err)throw"impossible error from getBalance";$log.debug("updateBalance Wallet Balance:",assocBalances,assocSharedBalances),self.setBalance(assocBalances,assocSharedBalances)})})},self.openWallet=function(){console.log("index.openWallet called");var fc=profileService.focusedClient;breadcrumbs.add("openWallet "+fc.credentials.walletId),$timeout(function(){self.setOngoingProcess("openingWallet",!0),self.updateError=!1,fc.openWallet(function(err,walletStatus){if(self.setOngoingProcess("openingWallet",!1),err)throw"impossible error from openWallet";$log.debug("Wallet Opened"),self.updateAll(lodash.isObject(walletStatus)?{walletStatus:walletStatus}:null)})})},self.processNewTxs=function(txs){var now=(configService.getSync().wallet.settings,Math.floor(Date.now()/1e3)),ret=[];return lodash.each(txs,function(tx){tx=txFormatService.processTx(tx),tx.time>now&&(tx.time=now),ret.push(tx)}),ret},self.updateAlias=function(){var config=configService.getSync();config.aliasFor=config.aliasFor||{},self.alias=config.aliasFor[self.walletId];var fc=profileService.focusedClient;fc.alias=self.alias},self.updateColor=function(){var config=configService.getSync();config.colorFor=config.colorFor||{},self.backgroundColor=config.colorFor[self.walletId]||"#0095ff";var fc=profileService.focusedClient;fc.backgroundColor=self.backgroundColor},self.setBalance=function(assocBalances,assocSharedBalances){if(assocBalances){var config=configService.getSync().wallet.settings;self.unitValue=config.unitValue,self.unitName=config.unitName,self.bbUnitName=config.bbUnitName,self.arrBalances=[];for(var asset in assocBalances){var balanceInfo=assocBalances[asset];if(balanceInfo.asset=asset,balanceInfo.total=balanceInfo.stable+balanceInfo.pending,assocSharedBalances[asset]){balanceInfo.shared=0,balanceInfo.assocSharedByAddress={};for(var sa in assocSharedBalances[asset]){var total_on_shared_address=(assocSharedBalances[asset][sa].stable||0)+(assocSharedBalances[asset][sa].pending||0);balanceInfo.shared+=total_on_shared_address,balanceInfo.assocSharedByAddress[sa]=total_on_shared_address}}if("base"===asset||asset==self.BLACKBYTES_ASSET){var assetName="base"!==asset?"blackbytes":"base",unitName="base"!==asset?config.bbUnitName:config.unitName;balanceInfo.totalStr=profileService.formatAmount(balanceInfo.total,assetName)+" "+unitName,balanceInfo.stableStr=profileService.formatAmount(balanceInfo.stable,assetName)+" "+unitName,balanceInfo.pendingStr=profileService.formatAmount(balanceInfo.pending,assetName)+" "+unitName,"number"==typeof balanceInfo.shared&&(balanceInfo.sharedStr=profileService.formatAmount(balanceInfo.shared,assetName)+" "+unitName)}"base"!==asset||self.shared_address||(self.commonBalances=balanceInfo.totalStr),self.arrBalances.push(balanceInfo),self.arrBalances.length=1}self.assetIndex=self.assetIndex||0,self.arrBalances[self.assetIndex]||(self.assetIndex=0),self.shared_address||(self.arrMainWalletBalances=self.arrBalances),isCordova&&wallet.showCompleteClient(),console.log("========= setBalance done, balances: "+JSON.stringify(self.arrBalances)),breadcrumbs.add("setBalance done, balances: "+JSON.stringify(self.arrBalances)),$timeout(function(){$rootScope.$apply()})}},
this.csvHistory=function(){function saveFile(name,data){var chooser=document.querySelector(name);chooser.addEventListener("change",function(evt){var fs=require("fs");fs.writeFile(this.value,data,function(err){err&&$log.debug(err)})},!1),chooser.click()}function formatDate(date){var dateObj=new Date(date);return dateObj?dateObj.toJSON()?dateObj.toJSON():"":($log.debug("Error formating a date"),"DateError")}function formatString(str){return str?(str.indexOf('"')!==-1&&(str=str.replace(new RegExp('"',"g"),"'")),str='"'+str+'"'):""}if(isCordova)return void $log.info("CSV generation not available in mobile");var isNode=nodeWebkit.isDefined(),fc=profileService.focusedClient;fc.credentials;if(fc.isComplete()){var self=this;$log.debug("Generating CSV from History"),self.setOngoingProcess("generatingCSV",!0),$timeout(function(){fc.getTxHistory(self.arrBalances[self.assetIndex].asset,self.shared_address,function(txs){self.setOngoingProcess("generatingCSV",!1),$log.debug("Wallet Transaction History:",txs);var data=txs,filename="Trustnote-"+(self.alias||self.walletName)+".csv",csvContent="";isNode||(csvContent="data:text/csv;charset=utf-8,"),csvContent+="Date,Destination,Note,Amount,Currency,Spot Value,Total Value,Tax Type,Category\n";var _amount,_note,dataString;if(data.forEach(function(it,index){var amount=it.amount;"moved"==it.action&&(amount=0),_amount=("sent"==it.action?"-":"")+amount,_note=formatString((it.message?it.message:"")+" unit: "+it.unit),"moved"==it.action&&(_note+=" Moved:"+it.amount),dataString=formatDate(1e3*it.time)+","+formatString(it.addressTo)+","+_note+","+_amount/1e6+",MN,,,,",csvContent+=dataString+"\n"}),isNode)saveFile("#export_file",csvContent);else{var encodedUri=encodeURI(csvContent),link=document.createElement("a");link.setAttribute("href",encodedUri),link.setAttribute("download",filename),link.click()}$rootScope.$apply()})})}},self.updateLocalTxHistory=function(client,cb){self.updateTimeout=!0;var walletId=client.credentials.walletId;return 0===self.arrBalances.length?console.log("updateLocalTxHistory: no balances yet"):(breadcrumbs.add("index: "+self.assetIndex+"; balances: "+JSON.stringify(self.arrBalances)),client.isComplete()?($timeout(function(){if(self.updateTimeout)return cb("update timeout")},6e4),void client.getTxHistory(self.arrBalances[self.assetIndex].asset,self.shared_address,function(txs){self.updateTimeout=!1;var newHistory=self.processNewTxs(txs);return $log.debug("Tx History synced. Total Txs: "+newHistory.length),walletId==profileService.focusedClient.credentials.walletId&&(self.completeHistory=newHistory,self.txHistory=newHistory.slice(0,self.historyShowLimit),self.historyShowShowAll=newHistory.length>=self.historyShowLimit),cb()})):console.log("fc incomplete yet"))},self.showAllHistory=function(){self.historyShowShowAll=!1,self.historyRendering=!0,$timeout(function(){$rootScope.$apply(),$timeout(function(){self.historyRendering=!1,self.txHistory=self.completeHistory},100)},100)},self.updateHistory=function(){var fc=profileService.focusedClient,walletId=fc.credentials.walletId;fc.isComplete()&&!self.updatingTxHistory[walletId]&&($log.debug("Updating Transaction History"),self.txHistoryError=!1,self.updatingTxHistory[walletId]=!0,$timeout(function(){self.updateLocalTxHistory(fc,function(err){self.updatingTxHistory[walletId]=!1,err&&(self.txHistoryError=!0),$timeout(function(){$rootScope.$apply()})})}))},self.updateTxHistory=lodash.debounce(function(){self.updateHistory()},1e3),$scope.$watch("index.assetIndex",function(n,o){if(n!=o){self.updateAll();var lightWallet=require("trustnote-common/light_wallet.js");lightWallet.refreshLightClientHistory()}}),self.onClick=function(){console.log("== click"),self.oldAssetIndex=self.assetIndex},self.updateHistoryFromNetwork=lodash.throttle(function(){setTimeout(function(){if(self.assetIndex!==self.oldAssetIndex)return console.log("== swipe");console.log("== updateHistoryFromNetwork");var lightWallet=require("trustnote-common/light_wallet.js");lightWallet.refreshLightClientHistory()},500)},5e3),self.showPopup=function(msg,msg_icon,cb){$log.warn("Showing "+msg_icon+" popup:"+msg),self.showAlert={msg:msg.toString(),msg_icon:msg_icon,close:function(err){if(self.showAlert=null,cb)return cb(err)}},$timeout(function(){$rootScope.$apply()})},self.showErrorPopup=function(msg,cb){$log.warn("Showing err popup:"+msg),self.showPopup(msg,"fi-alert",cb)},self.recreate=function(cb){var fc=profileService.focusedClient;self.setOngoingProcess("recreating",!0),fc.recreateWallet(function(err){if(self.setOngoingProcess("recreating",!1),err)throw"impossible err from recreateWallet";profileService.setWalletClients(),$timeout(function(){$rootScope.$emit("Local/WalletImported",self.walletId)},100)})},self.openMenu=function(){backButton.menuOpened=!0,go.swipe(!0)},self.closeMenu=function(){backButton.menuOpened=!1,go.swipe()},self.swipeRight=function(){self.bSwipeSuspended?console.log("ignoring swipe"):self.openMenu()},self.suspendSwipe=function(){self.arrBalances.length<=1||(self.bSwipeSuspended=!0,console.log("suspending swipe"),$timeout(function(){self.bSwipeSuspended=!1,console.log("resuming swipe")},100))},self.retryScan=function(){var self=this;self.startScan(self.walletId)},self.startScan=function(walletId){$log.debug("Scanning wallet "+walletId);var c=profileService.walletClients[walletId];!c.isComplete()},self.setUxLanguage=function(){var userLang=uxLanguage.update();self.defaultLanguageIsoCode=userLang,self.defaultLanguageName=uxLanguage.getName(userLang)},self.setAddressbook=function(ab){return ab?void(self.addressbook=ab):void addressbookService.list(function(err,ab){return err?void $log.error("Error getting the addressbook"):void(self.addressbook=ab)})},self.isEnoughSignersSelected=function(){return self.m===self.n||getNumberOfSelectedSigners()>=self.m},self.getWallets=function(){return profileService.getWallets("livenet")},$rootScope.$on("Local/ClearHistory",function(event){$log.debug("The wallet transaction history has been deleted"),self.txHistory=self.completeHistory=[],self.updateHistory()}),$rootScope.$on("Local/AddressbookUpdated",function(event,ab){self.setAddressbook(ab)}),$rootScope.$on("Local/ColorUpdated",function(event){self.updateColor(),$timeout(function(){$rootScope.$apply()})}),$rootScope.$on("Local/AliasUpdated",function(event){self.updateAlias(),$timeout(function(){$rootScope.$apply()})}),$rootScope.$on("Local/SpendUnconfirmedUpdated",function(event){self.setSpendUnconfirmed(),self.updateAll()}),$rootScope.$on("Local/ProfileBound",function(){}),$rootScope.$on("Local/NewFocusedWallet",function(){self.setUxLanguage()}),$rootScope.$on("Local/LanguageSettingUpdated",function(){self.setUxLanguage()}),$rootScope.$on("Local/UnitSettingUpdated",function(event){breadcrumbs.add("UnitSettingUpdated"),self.updateAll(),self.updateTxHistory()}),$rootScope.$on("Local/NeedFreshHistory",function(event){breadcrumbs.add("NeedFreshHistory"),self.updateHistory()}),$rootScope.$on("Local/Synchronization",function(event){breadcrumbs.add("Synchronization"),self.updateAll(),self.updateTxHistory()}),$rootScope.$on("Local/WalletCompleted",function(event){self.setFocusedWallet(),go.walletHome()}),$rootScope.$on("Local/Resume",function(event){$log.debug("### Resume event");var lightWallet=require("trustnote-common/light_wallet.js");lightWallet.refreshLightClientHistory()}),$rootScope.$on("Local/BackupDone",function(event){self.needsBackup=!1,$log.debug("Backup done"),storageService.setBackupFlag("all",function(err){return err?$log.warn("setBackupFlag failed: "+JSON.stringify(err)):void $log.debug("Backup done stored")})}),$rootScope.$on("Local/DeviceError",function(event,err){self.showErrorPopup(err,function(){self.isCordova&&navigator&&navigator.app&&navigator.app.exitApp()})}),$rootScope.$on("Local/WalletImported",function(event,walletId){self.needsBackup=!1,storageService.setBackupFlag(walletId,function(){$log.debug("Backup done stored"),addressService.expireAddress(walletId,function(err){$timeout(function(){self.txHistory=self.completeHistory=[],self.startScan(walletId)},500)})})}),$rootScope.$on("NewIncomingTx",function(){self.updateAll({walletStatus:null,untilItChanges:!0,triggerTxUpdate:!0})}),$rootScope.$on("NewOutgoingTx",function(){breadcrumbs.add("NewOutgoingTx"),self.updateAll({walletStatus:null,untilItChanges:!0,triggerTxUpdate:!0})}),lodash.each(["NewTxProposal","TxProposalFinallyRejected","TxProposalRemoved","NewOutgoingTxByThirdParty","Local/NewTxProposal","Local/TxProposalAction"],function(eventName){$rootScope.$on(eventName,function(event,untilItChanges){self.updateAll({walletStatus:null,untilItChanges:untilItChanges,triggerTxUpdate:!0})})}),$rootScope.$on("ScanFinished",function(){$log.debug("Scan Finished. Updating history"),self.updateAll({walletStatus:null,triggerTxUpdate:!0})}),$rootScope.$on("Local/NoWallets",function(event){$timeout(function(){self.hasProfile=!0,self.noFocusedWallet=!0,self.isComplete=null,self.walletName=null,storageService.deleteProfile(function(){}),go.path("splash")})}),$rootScope.$on("Local/NewFocusedWallet",function(e,option){console.log("on Local/NewFocusedWallet"),self.setFocusedWallet(),option&&2==self.haschoosen&&!self.showneikuang&&go.walletHome()}),$rootScope.$on("Local/SetTab",function(event,tab,reset){console.log("SetTab "+tab+", reset "+reset),self.setTab(tab,reset)}),$rootScope.$on("Local/RequestTouchid",function(event,cb){window.plugins.touchid.verifyFingerprint(gettextCatalog.getString("Scan your fingerprint please"),function(msg){return cb()},function(msg){return cb(gettext("Invalid Touch ID"))})}),$rootScope.$on("Local/ShowAlert",function(event,msg,msg_icon,cb){self.showPopup(msg,msg_icon,cb)}),$rootScope.$on("Local/ShowErrorAlert",function(event,msg,cb){self.showErrorPopup(msg,cb)}),$rootScope.$on("Local/NeedsPassword",function(event,isSetup,error_message,cb){console.log("NeedsPassword"),self.askPassword={isSetup:isSetup,error:error_message,callback:function(err,pass){return self.askPassword=null,cb(err,pass)}},$timeout(function(){$rootScope.$apply()})}),self.showQrcode=function(){backButton.showQrcode=!0,self.askqr=!0},lodash.each(["NewCopayer","CopayerUpdated"],function(eventName){$rootScope.$on(eventName,function(){self.setFocusedWallet()})}),$rootScope.$on("Local/NewEncryptionSetting",function(){var fc=profileService.focusedClient;self.isPrivKeyEncrypted=fc.isPrivKeyEncrypted(),$timeout(function(){$rootScope.$apply()})}),$rootScope.$on("Local/pushNotificationsReady",function(){self.usePushNotifications=!0,$timeout(function(){$rootScope.$apply()})}),self.ifQr=0,this.BeforeScan=function(){},this.handleQrcode=function(str,callbacks){var re=new RegExp("^TTT:(.+)$","i"),arrMatches=str.match(re);if(!arrMatches)return void(self.scanErr=1);str=arrMatches[1];try{var obj_from_hotWallet=JSON.parse(str)}catch(e){return}if(obj_from_hotWallet.type)switch(obj_from_hotWallet.type){case"h1":var crypto=require("crypto"),xpub=profileService.focusedClient.credentials.xPubKey;if(self.wallet_Id=crypto.createHash("sha256").update(xpub.toString(),"utf8").digest("base64"),obj_from_hotWallet.v!=profileService.tmpeNum||obj_from_hotWallet.id!=self.wallet_Id)return void(self.scanErr=1);self.myDeviceAddress=require("trustnote-common/device.js").getMyDeviceAddress(),self.ifQr=1,self.objForHot={type:"c2",addr:self.myDeviceAddress,v:obj_from_hotWallet.v},self.objForHot="TTT:"+JSON.stringify(self.objForHot),self.scanErr=0;break;case"c3":profileService.tempNum2==obj_from_hotWallet.v&&eventBus.emit("finishScaned",obj_from_hotWallet.sign)}},self.openDownloadLink=function(){var link="",appPlatform="/application.html";link="https://trustnote.org"+appPlatform,"undefined"!=typeof nw?nw.Shell.openExternal(link):cordova.InAppBrowser.open(link,"_system"),navigator&&navigator.app?navigator.app.exitApp():process.exit&&process.exit()},self.cancelUpdate=function(){newVersion.showUpdate=0,$timeout(function(){newVersion.showUpdate=1},864e5)},self.showUpdate=function(){return newVersion.showUpdate},self.textToUpdate=function(){if(self.arrToUpdate=null,newVersion.msg){if(self.arrToUpdate=newVersion.msg,"en"==uxLanguage.getCurrentLanguage())return self.arrToUpdate.en;if("zh_CN"==uxLanguage.getCurrentLanguage())return self.arrToUpdate.cn}}});var eventBus=require("trustnote-common/event_bus.js");angular.module("copayApp.controllers").controller("inviteCorrespondentDeviceController",function($scope,$timeout,profileService,go,isCordova,correspondentListService,gettextCatalog){function onPaired(peer_address){correspondentListService.setCurrentCorrespondent(peer_address,function(bAnotherCorrespondent){go.path("correspondentDevices.correspondentDevice")})}var conf=require("trustnote-common/conf.js");$scope.protocol=conf.program,$scope.isCordova=isCordova;var fc=profileService.focusedClient;$scope.color=fc.backgroundColor,$scope.$on("qrcode:error",function(event,error){console.log(error)}),$scope.copyCode=function(){console.log("copyCode"),isCordova&&(window.cordova.plugins.clipboard.copy($scope.code),window.plugins.toast.showShortCenter(gettextCatalog.getString("Copied to clipboard")))},$scope.onTextClick=function($event){console.log("onTextClick"),$event.target.select()},$scope.error=null,correspondentListService.startWaitingForPairing(function(pairingInfo){function determineQRcodeVersionFromString(inputtext){for(var maxCharsforQRVersion=[0,14,26,42,62,84,106,122,152,180,213],qrversion=5,i=maxCharsforQRVersion.length-1;i>0;i--)maxCharsforQRVersion[i]>=inputtext.length&&(qrversion=i);return qrversion}console.log("beginAddCorrespondent "+pairingInfo.pairing_secret),$scope.code=pairingInfo.device_pubkey+"@"+pairingInfo.hub+"#"+pairingInfo.pairing_secret;var qrstring=$scope.protocol+":"+$scope.code;$scope.qr_version=determineQRcodeVersionFromString(qrstring),$scope.$digest();var eventName="paired_by_secret-"+pairingInfo.pairing_secret;eventBus.once(eventName,onPaired),$scope.$on("$destroy",function(){console.log("removing listener for pairing by our secret"),eventBus.removeListener(eventName,onPaired)})}),$scope.cancelAddCorrespondent=function(){go.path("correspondentDevices")}}),angular.module("copayApp.controllers").controller("paperWalletController",function($scope,$http,$timeout,$log,configService,profileService,go,addressService,txStatus,bitcore){self=this;var fc=profileService.focusedClient;self.onQrCodeScanned=function(data){$scope.inputData=data,self.onData(data)},self.onData=function(data){self.error="",self.scannedKey=data,self.isPkEncrypted="6"==data.charAt(0)},self._scanFunds=function(cb){function getPrivateKey(scannedKey,isPkEncrypted,passphrase,cb){return isPkEncrypted?void fc.decryptBIP38PrivateKey(scannedKey,passphrase,null,cb):cb(null,scannedKey)}function getBalance(privateKey,cb){fc.getBalanceFromPrivateKey(privateKey,cb)}function checkPrivateKey(privateKey){try{new bitcore.PrivateKey(privateKey,"livenet")}catch(err){return!1}return!0}getPrivateKey(self.scannedKey,self.isPkEncrypted,$scope.passphrase,function(err,privateKey){return err?cb(err):checkPrivateKey(privateKey)?void getBalance(privateKey,function(err,balance){return err?cb(err):cb(null,privateKey,balance)}):cb(new Error("Invalid private key"))})},self.scanFunds=function(){self.error="Unimplemented"},self._sweepWallet=function(cb){addressService.getAddress(fc.credentials.walletId,!0,function(err,destinationAddress){return err?cb(err):void fc.buildTxFromPrivateKey(self.privateKey,destinationAddress,null,function(err,tx){return err?cb(err):void fc.broadcastRawTx({rawTx:tx.serialize(),network:"livenet"},function(err,txid){return err?cb(err):cb(null,destinationAddress,txid)})})})},self.sweepWallet=function(){self.sending=!0,self.error="",$timeout(function(){self._sweepWallet(function(err,destinationAddress,txid){self.sending=!1,err?(self.error=err.message||err.toString(),$log.error(err)):txStatus.notify({status:"broadcasted"},function(){go.walletHome()}),$scope.$apply()})},100)}}),angular.module("copayApp.controllers").controller("passwordController",function($rootScope,$scope,$timeout,profileService,notification,go,gettext){var pass1,self=this;self.checkPassClose=profileService.checkPassClose,self.isVerification=!1;var fc=profileService.focusedClient;self.bHasMnemonic=fc.credentials&&fc.credentials.mnemonic,self.close=function(cb){return profileService.checkPassClose=!0,cb(gettext("No password given"))},self.set=function(isSetup,cb){return self.error=!1,isSetup&&!self.isVerification?(document.getElementById("passwordInput").focus(),self.isVerification=!0,pass1=self.password,self.password=null,void $timeout(function(){$rootScope.$apply()})):isSetup&&pass1!=self.password?(self.error=gettext("Passwords do not match"),self.isVerification=!1,self.password=null,void(pass1=null)):cb(null,self.password)},self.showQrcode=function(){self.askqr=!0},$rootScope.$on("Local/WalletImported",function(event,walletId){self.needsBackup=!1,storageService.setBackupFlag(walletId,function(){$log.debug("Backup done stored"),addressService.expireAddress(walletId,function(err){$timeout(function(){self.txHistory=self.completeHistory=[],self.startScan(walletId)},500)})})})}),angular.module("copayApp.controllers").controller("paymentUriController",function($rootScope,$stateParams,$location,$timeout,profileService,configService,lodash,bitcore,go){function strip(number){return parseFloat(number.toPrecision(12))}this.checkBitcoinUri=function(){var query=[];angular.forEach($location.search(),function(value,key){query.push(key+"="+value)});var queryString=query?query.join("&"):null;this.bitcoinURI=$stateParams.data+(queryString?"?"+queryString:"");var URI=bitcore.URI;URI.isValid(this.bitcoinURI);if(!URI.isValid(this.bitcoinURI))return void(this.error=!0);var uri=new URI(this.bitcoinURI);if(uri&&uri.address){var config=configService.getSync().wallet.settings,unitValue=config.unitValue,unitName=config.unitName;uri.amount&&(uri.amount=strip(uri.amount/unitValue)+" "+unitName),uri.network=uri.address.network.name,this.uri=uri}},this.getWallets=function(network){return profileService.getWallets(network)},this.selectWallet=function(wid){var self=this;wid!=profileService.focusedClient.credentials.walletId&&profileService.setAndStoreFocus(wid,!0,function(){}),go.send(),$timeout(function(){$rootScope.$emit("paymentUri",self.bitcoinURI)},100)}}),angular.module("copayApp.controllers").controller("preferencesController",function($scope,$rootScope,$filter,$timeout,$modal,$log,lodash,configService,profileService,uxLanguage){var self=this;this.init=function(){var config=configService.getSync();this.unitName=config.wallet.settings.unitName,this.currentLanguageName=uxLanguage.getCurrentLanguageName(),$scope.spendUnconfirmed=config.wallet.spendUnconfirmed;var fc=profileService.focusedClient;if(fc&&(this.externalSource=null),window.touchidAvailable){var walletId=fc.credentials.walletId;this.touchidAvailable=!0,config.touchIdFor=config.touchIdFor||{},$scope.touchid=config.touchIdFor[walletId]}};var unwatchSpendUnconfirmed=$scope.$watch("spendUnconfirmed",function(newVal,oldVal){if(newVal!=oldVal){var opts={wallet:{spendUnconfirmed:newVal}};configService.set(opts,function(err){$rootScope.$emit("Local/SpendUnconfirmedUpdated"),err&&$log.debug(err)})}}),unwatchRequestTouchid=$scope.$watch("touchid",function(newVal,oldVal){if(newVal==oldVal||$scope.touchidError)return void($scope.touchidError=!1);var walletId=profileService.focusedClient.credentials.walletId,opts={touchIdFor:{}};opts.touchIdFor[walletId]=newVal,$rootScope.$emit("Local/RequestTouchid",function(err){err?($log.debug(err),$timeout(function(){$scope.touchidError=!0,$scope.touchid=oldVal},100)):configService.set(opts,function(err){err&&($log.debug(err),$scope.touchidError=!0,$scope.touchid=oldVal)})})});$scope.$on("$destroy",function(){unwatchSpendUnconfirmed(),unwatchRequestTouchid()}),self.toShowPubKey=function(){profileService.checkPassClose=!1;var fc=profileService.focusedClient;return fc.isPrivKeyEncrypted()?void profileService.passWrongUnlockFC(null,function(err){if("cancel"==err)profileService.checkPassClose=!0;else{if(err)return;$rootScope.go("preferences.preferencesCold")}}):void $rootScope.go("preferences.preferencesCold")}}),angular.module("copayApp.controllers").controller("preferencesAbout",function(){}),angular.module("copayApp.controllers").controller("preferencesAdvancedController",function($scope){}),angular.module("copayApp.controllers").controller("preferencesAliasController",function($scope,$timeout,configService,profileService,go){var config=configService.getSync(),fc=profileService.focusedClient,walletId=fc.credentials.walletId,config=configService.getSync();config.aliasFor=config.aliasFor||{},this.alias=config.aliasFor[walletId]||fc.credentials.walletName,this.save=function(){var self=this,opts={aliasFor:{}};opts.aliasFor[walletId]=self.alias,configService.set(opts,function(err){return err?void $scope.$emit("Local/DeviceError",err):($scope.$emit("Local/AliasUpdated"),void $timeout(function(){go.path("preferences")},50))})}}),angular.module("copayApp.controllers").controller("preferencesBbUnitController",function($rootScope,$scope,$log,configService,go){var config=configService.getSync();this.bbUnitName=config.wallet.settings.bbUnitName,this.unitOpts=[{name:"blackbytes",shortName:"blacknotes",value:1,decimals:0,code:"one"},{name:"kBlackBytes (1,000 blackbytes)",shortName:"kBN",value:1e3,decimals:3,code:"kilo"},{name:"MBlackBytes (1,000,000 blackbytes)",shortName:"MBN",value:1e6,decimals:6,code:"mega"},{name:"GBlackBytes (1,000,000,000 blackbytes)",shortName:"GBN",value:1e9,decimals:9,code:"giga"}],this.save=function(newUnit){var opts={wallet:{settings:{bbUnitName:newUnit.shortName,bbUnitValue:newUnit.value,bbUnitDecimals:newUnit.decimals,bbUnitCode:newUnit.code}}};this.unitName=newUnit.shortName,configService.set(opts,function(err){err&&$log.warn(err),$scope.$emit("Local/UnitSettingUpdated"),go.preferencesGlobal()})},go.onBackButton=function(){console.log("units backbutton")}}),angular.module("copayApp.controllers").controller("preferencesColdController",function($scope,profileService,nodeWebkit,isCordova){var fc=profileService.focusedClient,self=this;self.myDeviceAddress=require("trustnote-common/device.js").getMyDeviceAddress(),self.credentials=fc.credentials,self.objQr_to_show={type:"c1",name:"TTT",pub:self.credentials.xPubKey,n:0,v:Math.floor(9e3*Math.random()+1e3)},self.qrcode="TTT:"+JSON.stringify(self.objQr_to_show),self.setTmpeNum=function(){profileService.tmpeNum=self.objQr_to_show.v,$scope.index.scanErr=0},self.setTmpeNum();var crypto=require("crypto");self.wallet_Id=crypto.createHash("sha256").update(self.credentials.xPubKey.toString(),"utf8").digest("base64"),self.copyxPubKey=function(){var xPub=self.qrcode;isCordova?(window.cordova.plugins.clipboard.copy(xPub),document.getElementsByClassName("toast_showCopy")[0].style.display="block",setTimeout(function(){document.getElementsByClassName("toast_showCopy")[0]&&(document.getElementsByClassName("toast_showCopy")[0].style.display="none")},1e3)):nodeWebkit.isDefined()&&(nodeWebkit.writeToClipboard(xPub),document.getElementsByClassName("toast_showCopy")[0].style.display="block",setTimeout(function(){document.getElementsByClassName("toast_showCopy")[0]&&(document.getElementsByClassName("toast_showCopy")[0].style.display="none")},1e3))}}),angular.module("copayApp.controllers").controller("preferencesColorController",function($scope,configService,profileService,go){var config=configService.getSync();this.colorOpts=configService.colorOpts;var fc=profileService.focusedClient,walletId=fc.credentials.walletId,config=configService.getSync();config.colorFor=config.colorFor||{},this.color=config.colorFor[walletId]||"#0095ff",this.save=function(color){var self=this,opts={colorFor:{}};opts.colorFor[walletId]=color,configService.set(opts,function(err){return err?void $scope.$emit("Local/DeviceError",err):(self.color=color,void $scope.$emit("Local/ColorUpdated"))})}}),angular.module("copayApp.controllers").controller("preferencesDeleteWalletController",function($scope,$rootScope,$filter,$timeout,$modal,$log,storageService,notification,profileService,isCordova,go,gettext,gettextCatalog,animationService){function removeAddressesAndWallets(walletId,cb){var arrQueries=[];db.addQuery(arrQueries,"DELETE FROM my_addresses WHERE wallet='"+walletId+"'"),db.addQuery(arrQueries,"DELETE FROM wallet_signing_paths WHERE wallet='"+walletId+"'"),db.addQuery(arrQueries,"DELETE FROM extended_pubkeys WHERE wallet='"+walletId+"'"),db.addQuery(arrQueries,"DELETE FROM wallets WHERE wallet='"+walletId+"'"),async.series(arrQueries,cb)}this.isCordova=isCordova,this.error=null;var async=require("async"),db=require("trustnote-common/db.js"),delete_msg=gettextCatalog.getString("Are you sure you want to delete this wallet?"),accept_msg=gettextCatalog.getString("Accept"),cancel_msg=gettextCatalog.getString("Cancel"),confirm_msg=gettextCatalog.getString("Confirm"),_modalDeleteWallet=function(){var ModalInstanceCtrl=function($scope,$modalInstance,$sce,gettext){$scope.title=$sce.trustAsHtml(delete_msg),$scope.loading=!1,$scope.ok=function(){$scope.loading=!0,$modalInstance.close(accept_msg)},$scope.cancel=function(){$modalInstance.dismiss(cancel_msg)}},modalInstance=$modal.open({templateUrl:"views/modals/confirmation.html",windowClass:animationService.modalAnimated.slideUp,controller:ModalInstanceCtrl});modalInstance.result["finally"](function(){var m=angular.element(document.getElementsByClassName("reveal-modal"));m.addClass(animationService.modalAnimated.slideOutDown)}),modalInstance.result.then(function(ok){ok&&_deleteWallet()})},_deleteWallet=function(){var fc=profileService.focusedClient,name=fc.credentials.walletName,walletName=(fc.alias||"")+" ["+name+"]",self=this;profileService.deleteWallet({},function(walletId,err){err?self.error=err.message||err:(walletId&&removeAddressesAndWallets(walletId,function(){console.log("delete wallet in datebase")}),notification.success(gettextCatalog.getString("Success"),gettextCatalog.getString('The wallet "{{walletName}}" was deleted',{walletName:walletName})))})};this.deleteWallet=function(){return 1===profileService.profile.credentials.length||1===profileService.getWallets().length?$rootScope.$emit("Local/ShowErrorAlert",gettextCatalog.getString("Can't delete the last remaining wallet")):void(isCordova?navigator.notification.confirm(delete_msg,function(buttonIndex){1==buttonIndex&&_deleteWallet()},confirm_msg,[accept_msg,cancel_msg]):_modalDeleteWallet())}}),angular.module("copayApp.controllers").controller("preferencesDeviceNameController",function($scope,$timeout,configService,go){var config=configService.getSync();this.deviceName=config.deviceName,this.save=function(){var self=this,device=require("trustnote-common/device.js");device.setDeviceName(self.deviceName);var opts={deviceName:self.deviceName};configService.set(opts,function(err){return err?void $scope.$emit("Local/DeviceError",err):void $timeout(function(){go.path("preferencesGlobal")},50)})}}),angular.module("copayApp.controllers").controller("preferencesEditWitnessController",function($scope,$timeout,go,witnessListService){function setError(error){self.error=error,$timeout(function(){$scope.$apply()},100)}function goBack(){go.path("preferencesGlobal.preferencesWitnesses")}var self=this;this.witness=witnessListService.currentWitness,this.save=function(){var new_address=this.witness.trim();if(new_address===witnessListService.currentWitness)return goBack();var myWitnesses=require("trustnote-common/my_witnesses.js");myWitnesses.replaceWitness(witnessListService.currentWitness,new_address,function(err){return console.log(err),err?setError(err):void goBack()})}}),angular.module("copayApp.controllers").controller("preferencesEmailController",function($scope,go,profileService,gettext,$log){this.save=function(form){var self=this;this.error=null;profileService.focusedClient;this.saving=!0,$scope.$emit("Local/EmailSettingUpdated",self.email,function(){self.saving=!1,go.path("preferencesGlobal")})}}),angular.module("copayApp.controllers").controller("preferencesGlobalController",function($scope,$rootScope,$log,configService,uxLanguage,pushNotificationsService,profileService){var conf=require("trustnote-common/conf.js");$scope.encrypt=!!profileService.profile.xPrivKeyEncrypted,this.init=function(){var config=configService.getSync();this.unitName=config.wallet.settings.unitName,this.bbUnitName=config.wallet.settings.bbUnitName,this.deviceName=config.deviceName,this.myDeviceAddress=require("trustnote-common/device.js").getMyDeviceAddress(),this.hub=config.hub,this.showHub=0,this.currentLanguageName=uxLanguage.getCurrentLanguageName(),this.torEnabled=conf.socksHost&&conf.socksPort,$scope.pushNotifications=config.pushNotifications.enabled,"undefined"==typeof window.cordova?this.isIOS=!1:this.isIOS=window.cordova.platformId},this.countShowHub=function(){this.showHub++};var unwatchPushNotifications=$scope.$watch("pushNotifications",function(newVal,oldVal){if(newVal!=oldVal){var opts={pushNotifications:{enabled:newVal}};configService.set(opts,function(err){opts.pushNotifications.enabled?pushNotificationsService.pushNotificationsInit():pushNotificationsService.pushNotificationsUnregister(),err&&$log.debug(err)})}}),unwatchEncrypt=$scope.$watch("encrypt",function(val){profileService.checkPassClose=!1;var fc=profileService.focusedClient;fc&&(val&&!fc.hasPrivKeyEncrypted()?$rootScope.$emit("Local/NeedsPassword",!0,null,function(err,password){return err||!password?void($scope.encrypt=!1):void profileService.setPrivateKeyEncryptionFC(password,function(){$rootScope.$emit("Local/NewEncryptionSetting"),$scope.encrypt=!0})}):!val&&fc.hasPrivKeyEncrypted()&&profileService.passWrongUnlockFC(null,function(err){return"cancel"==err&&console.log("**********cancel Unclock**********"),err?void($scope.encrypt=!0):void profileService.disablePrivateKeyEncryptionFC(function(err){return $rootScope.$emit("Local/NewEncryptionSetting"),err?($scope.encrypt=!0,void $log.error(err)):void($scope.encrypt=!1)})}))});$scope.$on("$destroy",function(){unwatchPushNotifications(),unwatchEncrypt()})}),angular.module("copayApp.controllers").controller("preferencesHubController",function($scope,$timeout,configService,go,autoUpdatingWitnessesList){var config=configService.getSync(),initHubEdit=!1;this.hub=config.hub,this.arrHub=configService.hub,this.currentAutoUpdWitnessesList=autoUpdatingWitnessesList.autoUpdate,$scope.autoUpdWitnessesList=autoUpdatingWitnessesList.autoUpdate,this.save=function(){var self=this,device=require("trustnote-common/device.js"),lightWallet=require("trustnote-common/light_wallet.js");self.hub=self.hub.replace(/^wss?:\/\//i,"").replace(/^https?:\/\//i,"");var opts={hub:self.hub};configService.set(opts,function(err){return err?void $scope.$emit("Local/DeviceError",err):($timeout(function(){device.setDeviceHub(self.hub),lightWallet.setLightVendorHost(self.hub)},800),void $timeout(function(){go.path("preferencesGlobal")},50))})};var unwatchEditHub=$scope.$watch(angular.bind(this,function(){return this.hub}),function(){initHubEdit?$scope.autoUpdWitnessesList=!1:initHubEdit=!0});$scope.$on("$destroy",function(){unwatchEditHub()})}),angular.module("copayApp.controllers").controller("preferencesInformation",function($scope,$log,$timeout,isMobile,gettextCatalog,lodash,profileService,storageService,go,configService){var constants=require("trustnote-common/constants.js"),fc=profileService.focusedClient,c=fc.credentials;this.init=function(){var basePath=c.getBaseAddressDerivationPath(),config=configService.getSync().wallet.settings;$scope.walletName=c.walletName,$scope.walletId=c.walletId,$scope.network=c.network,$scope.derivationStrategy=c.derivationStrategy||"BIP44",$scope.basePath=basePath,$scope.M=c.m,$scope.N=c.n,$scope.addrs=null,fc.getAddresses({doNotVerify:!0},function(err,addrs){return err?void $log.warn(err):($scope.addrs=addrs,void $timeout(function(){$scope.$apply()}))}),fc.getListOfBalancesOnAddresses(function(listOfBalances){listOfBalances=listOfBalances.map(function(row){
if("base"==row.asset||row.asset==constants.BLACKBYTES_ASSET){var assetName="base"!==row.asset?"blackbytes":"base",unitName="base"!==row.asset?config.bbUnitName:config.unitName;return row.amount=profileService.formatAmount(row.amount,assetName,{dontRound:!0})+" "+unitName,row}return row});var assocListOfBalances={};listOfBalances.forEach(function(row){void 0===assocListOfBalances[row.address]&&(assocListOfBalances[row.address]=[]),assocListOfBalances[row.address].push(row)}),$scope.assocListOfBalances=assocListOfBalances,$timeout(function(){$scope.$apply()})})},$scope.hasListOfBalances=function(){return!!Object.keys($scope.assocListOfBalances||{}).length},this.sendAddrs=function(){function formatDate(ts){var dateObj=new Date(1e3*ts);return dateObj?dateObj.toJSON()?dateObj.toJSON():"":($log.debug("Error formating a date"),"DateError")}var self=this;(isMobile.Android()||isMobile.Windows())&&(window.ignoreMobilePause=!0),self.loading=!0,$timeout(function(){fc.getAddresses({doNotVerify:!0},function(err,addrs){if(self.loading=!1,err)return void $log.warn(err);var body='Trustnote Wallet "'+$scope.walletName+'" Addresses.\n\n';body+="\n",body+=addrs.map(function(v){return"* "+v.address+" "+v.path+" "+formatDate(v.createdOn)}).join("\n"),window.plugins.socialsharing.shareViaEmail(body,"Trustnote Addresses",null,null,null,null,function(){},function(){}),$timeout(function(){$scope.$apply()},1e3)})},100)},this.clearTransactionHistory=function(){$scope.$emit("Local/ClearHistory"),$timeout(function(){go.walletHome()},100)}}),angular.module("copayApp.controllers").controller("preferencesLanguageController",function($scope,$log,$timeout,configService,go,uxLanguage){this.availableLanguages=uxLanguage.getLanguages(),this.save=function(newLang){var opts={wallet:{settings:{defaultLanguage:newLang}}};configService.set(opts,function(err){err&&$log.warn(err),$scope.$emit("Local/LanguageSettingUpdated"),$timeout(function(){go.preferencesGlobal()},100)})}}),angular.module("copayApp.controllers").controller("preferencesLogs",function(historicLog){this.logs=historicLog.get(),this.sendLogs=function(){var body="Trustnote Session Logs\n Be careful, this could contain sensitive private data\n\n";body+="\n\n",body+=this.logs.map(function(v){return v.msg}).join("\n"),window.plugins.socialsharing.shareViaEmail(body,"Trustnote Logs",null,null,null,null,function(){},function(){})}}),angular.module("copayApp.controllers").controller("preferencesTorController",function($scope,$log,$timeout,go,configService){function setConfAndCloseConnections(){conf.socksHost=root.socksHost,conf.socksPort=root.socksPort,conf.socksLocalDNS=root.socksLocalDNS,network.closeAllWsConnections()}function saveConfToFile(cb){var confJson,fs=require("fs"),desktopApp=require("trustnote-common/desktop_app.js"),appDataDir=desktopApp.getAppDataDir();try{confJson=require(appDataDir+"/conf.json")}catch(e){confJson={}}confJson.socksHost=root.socksHost,confJson.socksPort=root.socksPort,confJson.socksLocalDNS=root.socksLocalDNS,fs.writeFile(appDataDir+"/conf.json",JSON.stringify(confJson,null,"\t"),"utf8",function(err){return err?void $scope.$emit("Local/DeviceError",err):void cb()})}var conf=require("trustnote-common/conf.js"),network=require("trustnote-common/network.js"),bInitialized=!1,root={};root.socksHost=null,root.socksPort=null,root.socksLocalDNS=!1,$scope.errorHostInput="",$scope.errorPortInput="",$scope.torEnabled=conf.socksHost&&conf.socksPort,configService.get(function(err,confService){$scope.socksHost=conf.socksHost||confService.socksHost||"127.0.0.1",$scope.socksPort=conf.socksPort||confService.socksPort||"9150"}),$scope.save=function(close,oldVal){return $scope.socksHost=$scope.socksHost?$scope.socksHost:"127.0.0.1",$scope.socksPort=$scope.socksPort?parseInt($scope.socksPort):9150,$scope.socksPort&&$scope.socksPort>0&&$scope.socksPort<=65535?($scope.errorPortInput="",root.socksHost=$scope.torEnabled?$scope.socksHost:null,root.socksPort=$scope.torEnabled?$scope.socksPort:null,setConfAndCloseConnections(),void saveConfToFile(function(){configService.set({socksHost:$scope.socksHost,socksPort:$scope.socksPort},function(err){return err?void $scope.$emit("Local/DeviceError",err):void(close&&$timeout(function(){go.path("preferencesGlobal")},50))})})):($scope.errorPortInput="Port is invalid",void(close||oldVal||($scope.torEnabled=!1)))};var unwatchTorEnabled=$scope.$watch("torEnabled",function(newVal,oldVal){return bInitialized?void $scope.save(!1,oldVal):void(bInitialized=!0)});$scope.$on("$destroy",function(){unwatchTorEnabled()})}),angular.module("copayApp.controllers").controller("preferencesUnitController",function($rootScope,$scope,$log,configService,go){var config=configService.getSync();this.unitName=config.wallet.settings.unitName,this.unitOpts=[{name:"bytes",shortName:"notes",value:1,decimals:0,code:"one"},{name:"kBytes (1,000 bytes)",shortName:"KN",value:1e3,decimals:3,code:"kilo"},{name:"MBytes (1,000,000 bytes)",shortName:"MN",value:1e6,decimals:6,code:"mega"},{name:"GBytes (1,000,000,000 bytes)",shortName:"GN",value:1e9,decimals:9,code:"giga"}],this.save=function(newUnit){var opts={wallet:{settings:{unitName:newUnit.shortName,unitValue:newUnit.value,unitDecimals:newUnit.decimals,unitCode:newUnit.code}}};this.unitName=newUnit.shortName,configService.set(opts,function(err){err&&$log.warn(err),$scope.$emit("Local/UnitSettingUpdated"),go.preferencesGlobal()})},go.onBackButton=function(){console.log("units backbutton")}}),angular.module("copayApp.controllers").controller("preferencesWitnessesController",function($scope,go,witnessListService,autoUpdatingWitnessesList,$timeout){var self=this;this.witnesses=[],console.log("preferencesWitnessesController"),$scope.autoUpdWitnessesList=autoUpdatingWitnessesList.autoUpdate;var myWitnesses=require("trustnote-common/my_witnesses.js");myWitnesses.readMyWitnesses(function(arrWitnesses){self.witnesses=arrWitnesses,$timeout(function(){$scope.$apply()}),console.log("preferencesWitnessesController set witnesses "+arrWitnesses)},"wait"),this.edit=function(witness){$scope.autoUpdWitnessesList||(witnessListService.currentWitness=witness,go.path("preferencesGlobal.preferencesWitnesses.preferencesEditWitness"))};var unwatchAutoUpdWitnessesList=$scope.$watch("autoUpdWitnessesList",function(val){autoUpdatingWitnessesList.setAutoUpdate(val),val&&autoUpdatingWitnessesList.checkChangeWitnesses()});$scope.$on("$destroy",function(){unwatchAutoUpdWitnessesList()})});var constants=require("trustnote-common/constants.js");angular.module("copayApp.controllers").controller("qrcodeController",function($scope,$rootScope,$timeout,$filter,$modal,$log,notification,isCordova,profileService,lodash,configService,storageService,gettext,gettextCatalog,nodeWebkit,addressService,confirmDialog,animationService,backButton){var self=this,conf=require("trustnote-common/conf.js");this.protocol=conf.program;var config=configService.getSync(),configWallet=config.wallet,indexScope=$scope.index;$scope.currentSpendUnconfirmed=configWallet.spendUnconfirmed;var walletSettings=configWallet.settings;this.unitValue=walletSettings.unitValue,this.bbUnitValue=walletSettings.bbUnitValue,this.unitName=walletSettings.unitName,this.bbUnitName=walletSettings.bbUnitName,this.unitDecimals=walletSettings.unitDecimals,this.isCordova=isCordova,this.addresses=[],this.isMobile=isMobile.any(),this.isWindowsPhoneApp=isMobile.Windows()&&isCordova,this.blockUx=!1,this.isMobile=isMobile.any(),this.addr={},this.isTestnet=constants.version.match(/t$/),this.testnetName="2"===constants.alt?"[NEW TESTNET]":"[TESTNET]",this.hideQrcode=function(){document.getElementsByClassName("passModalMask")[0].style.zIndex=-1;var elem=document.getElementById("showqrcode");elem.style.display="none"},this.setAddress=function(forceNew){self.addrError=null;var fc=profileService.focusedClient;if(fc&&(forceNew||!self.addr[fc.credentials.walletId])){if(indexScope.shared_address&&forceNew)throw Error("attempt to generate for shared address");self.generatingAddress=!0,$timeout(function(){addressService.getAddress(fc.credentials.walletId,forceNew,function(err,addr){self.generatingAddress=!1,err?self.addrError=err:addr&&(self.addr[fc.credentials.walletId]=addr),$timeout(function(){$scope.$digest()})})})}},this.copyAddress=function(addr){isCordova?(window.cordova.plugins.clipboard.copy(addr),window.plugins.toast.showShortCenter(gettextCatalog.getString("Copied to clipboard"))):nodeWebkit.isDefined()&&(nodeWebkit.writeToClipboard(addr),document.getElementsByClassName("copyedd")[0].style.display="block",setTimeout(function(){document.getElementsByClassName("copyedd")[0]&&(document.getElementsByClassName("copyedd")[0].style.display="none")},1e3))},this.openCustomizedAmountModal=function(addr){$rootScope.modalOpened=!0;var self=this,fc=profileService.focusedClient,ModalInstanceCtrl=function($scope,$modalInstance){$scope.addr=addr,$scope.color=fc.backgroundColor,$scope.unitName=self.unitName,$scope.unitValue=self.unitValue,$scope.unitDecimals=self.unitDecimals,$scope.bbUnitValue=walletSettings.bbUnitValue,$scope.bbUnitName=walletSettings.bbUnitName,$scope.isCordova=isCordova,$scope.buttonLabel=gettextCatalog.getString("Generate QR Code"),$scope.protocol=conf.program,Object.defineProperty($scope,"_customAmount",{get:function(){return $scope.customAmount},set:function(newValue){$scope.customAmount=newValue},enumerable:!0,configurable:!0}),$scope.submitForm=function(form){if(0===$scope.index.arrBalances.length)return console.log("openCustomizedAmountModal: no balances yet");var amount=form.amount.$modelValue,asset=$scope.index.arrBalances[$scope.index.assetIndex].asset;if(!asset)throw Error("no asset");var amountInSmallestUnits="base"===asset?parseInt((amount*$scope.unitValue).toFixed(0)):asset===constants.BLACKBYTES_ASSET?parseInt((amount*$scope.bbUnitValue).toFixed(0)):amount;$timeout(function(){$scope.customizedAmountUnit=amount+" "+("base"===asset?$scope.unitName:asset===constants.BLACKBYTES_ASSET?$scope.bbUnitName:"of "+asset),$scope.amountInSmallestUnits=amountInSmallestUnits,$scope.asset_param="base"===asset?"":"&asset="+encodeURIComponent(asset)},1)},$scope.shareAddress=function(uri){isCordova&&((isMobile.Android()||isMobile.Windows())&&(window.ignoreMobilePause=!0),window.plugins.socialsharing.share(uri,null,null,null))},$scope.cancel=function(){document.getElementsByClassName("passModalMask")[0].style.zIndex=1099,$scope.index.askqr=!1,breadcrumbs.add("openCustomizedAmountModal: cancel"),$modalInstance.dismiss("cancel")}},modalInstance=$modal.open({templateUrl:"views/modals/customized-amount.html",windowClass:animationService.modalAnimated.slideUp,controller:ModalInstanceCtrl,scope:$scope}),disableCloseModal=$rootScope.$on("closeModal",function(){breadcrumbs.add("openCustomizedAmountModal: on closeModal"),document.getElementsByClassName("passModalMask")[0].style.zIndex=1099,$scope.index.askqr=!1,backButton.showQrcode=!1,modalInstance.dismiss("cancel")});modalInstance.result["finally"](function(){$rootScope.modalOpened=!1,backButton.showQrcode=!1,document.getElementsByClassName("passModalMask")[0].style.zIndex=1099,$scope.index.askqr=!1,disableCloseModal();var m=angular.element(document.getElementsByClassName("reveal-modal"));m.addClass(animationService.modalAnimated.slideOutDown)})},$rootScope.$on("closeQrcode",function(){backButton.showQrcode=!1,$scope.index.askqr=!1,$timeout(function(){$rootScope.$apply()})}),profileService.focusedClient&&profileService.focusedClient.isComplete()&&this.setAddress()}),angular.module("copayApp.controllers").controller("recoveryFromSeed",function($rootScope,$scope,$log,gettext,$timeout,gettextCatalog,profileService,go,notification,storageService,isCordova){function determineIfAddressUsed(address,cb){db.query("SELECT 1 FROM outputs WHERE address = ? LIMIT 1",[address],function(outputsRows){1===outputsRows.length?cb(!0):db.query("SELECT 1 FROM unit_authors WHERE address = ? LIMIT 1",[address],function(unitAuthorsRows){cb(1===unitAuthorsRows.length)})})}function scanForAddressesAndWallets(mnemonic,cb){function checkAndAddCurrentAddress(is_change){var address=objectHash.getChash160(["sig",{pubkey:wallet_defined_by_keys.derivePubkey(xPubKey,"m/"+is_change+"/"+currentAddressIndex)}]);determineIfAddressUsed(address,function(bUsed){bUsed?(lastUsedAddressIndex=currentAddressIndex,assocMaxAddressIndexes[currentWalletIndex]||(assocMaxAddressIndexes[currentWalletIndex]={main:0}),is_change?assocMaxAddressIndexes[currentWalletIndex].change=currentAddressIndex:assocMaxAddressIndexes[currentWalletIndex].main=currentAddressIndex,currentAddressIndex++,checkAndAddCurrentAddress(is_change)):(currentAddressIndex++,currentAddressIndex-lastUsedAddressIndex>20?is_change?(lastUsedAddressIndex!==-1&&(lastUsedWalletIndex=currentWalletIndex),currentWalletIndex-lastUsedWalletIndex>=20?cb(assocMaxAddressIndexes):(currentWalletIndex++,setCurrentWallet())):(lastUsedAddressIndex!==-1&&(assocMaxAddressIndexes[currentWalletIndex]||(assocMaxAddressIndexes[currentWalletIndex]={main:0}),assocMaxAddressIndexes[currentWalletIndex].main=20*Math.floor((currentAddressIndex-1)/20)),currentAddressIndex=0,checkAndAddCurrentAddress(1)):checkAndAddCurrentAddress(is_change))})}function setCurrentWallet(){xPubKey=Bitcore.HDPublicKey(self.xPrivKey.derive("m/44'/0'/"+currentWalletIndex+"'")),lastUsedAddressIndex=-1,currentAddressIndex=0,checkAndAddCurrentAddress(0)}self.xPrivKey=new Mnemonic(mnemonic).toHDPrivateKey();var xPubKey,lastUsedAddressIndex=-1,lastUsedWalletIndex=-1,currentAddressIndex=0,currentWalletIndex=0,assocMaxAddressIndexes={};setCurrentWallet()}function removeAddressesAndWallets(cb){var arrQueries=[];db.addQuery(arrQueries,"DELETE FROM pending_shared_address_signing_paths"),db.addQuery(arrQueries,"DELETE FROM shared_address_signing_paths"),db.addQuery(arrQueries,"DELETE FROM pending_shared_addresses"),db.addQuery(arrQueries,"DELETE FROM shared_addresses"),db.addQuery(arrQueries,"DELETE FROM my_addresses"),db.addQuery(arrQueries,"DELETE FROM wallet_signing_paths"),db.addQuery(arrQueries,"DELETE FROM extended_pubkeys"),db.addQuery(arrQueries,"DELETE FROM wallets"),db.addQuery(arrQueries,"DELETE FROM correspondent_devices"),async.series(arrQueries,cb)}function createAddresses(assocMaxAddressIndexes,cb){function addAddress(wallet,is_change,index,maxIndex){wallet_defined_by_keys.issueAddress(wallet,is_change,index,function(addressInfo){index++,index<=maxIndex?addAddress(wallet,is_change,index,maxIndex):is_change?(currentAccount++,currentAccount<accounts.length?startAddToNewWallet(0):cb()):startAddToNewWallet(1)})}function startAddToNewWallet(is_change){is_change?void 0!==assocMaxAddressIndexes[accounts[currentAccount]].change?addAddress(self.assocIndexesToWallets[accounts[currentAccount]],1,0,assocMaxAddressIndexes[accounts[currentAccount]].change):(currentAccount++,currentAccount<accounts.length?startAddToNewWallet(0):cb()):addAddress(self.assocIndexesToWallets[accounts[currentAccount]],0,0,assocMaxAddressIndexes[accounts[currentAccount]].main+20)}var accounts=Object.keys(assocMaxAddressIndexes),currentAccount=0;startAddToNewWallet(0)}function createWallets(arrWalletIndexes,cb){function createWallet(n){var account=parseInt(arrWalletIndexes[n]),opts={};opts.m=1,opts.n=1,opts.name="Wallet #"+account,opts.network="livenet",opts.cosigners=[],opts.extendedPrivateKey=self.xPrivKey,opts.mnemonic=self.inputMnemonic,opts.account=account,profileService.createWallet(opts,function(err,walletId){self.assocIndexesToWallets[account]=walletId,n++,n<arrWalletIndexes.length?createWallet(n):cb()})}createWallet(0)}function scanForAddressesAndWalletsInLightClient(mnemonic,cb){function checkAndAddCurrentAddresses(is_change){assocMaxAddressIndexes[currentWalletIndex]||(assocMaxAddressIndexes[currentWalletIndex]={main:0,change:0});for(var arrTmpAddresses=[],i=0;i<20;i++){var index=(is_change?assocMaxAddressIndexes[currentWalletIndex].change:assocMaxAddressIndexes[currentWalletIndex].main)+i;arrTmpAddresses.push(objectHash.getChash160(["sig",{pubkey:wallet_defined_by_keys.derivePubkey(xPubKey,"m/"+is_change+"/"+index)}]))}myWitnesses.readMyWitnesses(function(arrWitnesses){network.requestFromLightVendor("light/get_history",{addresses:arrTmpAddresses,witnesses:arrWitnesses},function(ws,request,response){if(response&&response.error){var breadcrumbs=require("trustnote-common/breadcrumbs.js");return breadcrumbs.add("Error scanForAddressesAndWalletsInLightClient: "+response.error),self.error=gettextCatalog.getString("When scanning an error occurred, please try again later."),self.scanning=!1,$scope.index.showneikuang=!1,profileService.haschoosen=2,self.password&&profileService.setPrivateKeyEncryptionFC(self.password,function(){$rootScope.$emit("Local/NewEncryptionSetting"),$scope.encrypt=!0,delete self.password}),void $timeout(function(){$rootScope.$apply()})}Object.keys(response).length?(lastUsedWalletIndex=currentWalletIndex,is_change?assocMaxAddressIndexes[currentWalletIndex].change+=20:assocMaxAddressIndexes[currentWalletIndex].main+=20,checkAndAddCurrentAddresses(is_change)):is_change?(0===assocMaxAddressIndexes[currentWalletIndex].change&&0===assocMaxAddressIndexes[currentWalletIndex].main&&delete assocMaxAddressIndexes[currentWalletIndex],currentWalletIndex++,currentWalletIndex-lastUsedWalletIndex>3?cb(assocMaxAddressIndexes):setCurrentWallet()):checkAndAddCurrentAddresses(1)})})}function setCurrentWallet(){xPubKey=Bitcore.HDPublicKey(self.xPrivKey.derive("m/44'/0'/"+currentWalletIndex+"'")),checkAndAddCurrentAddresses(0)}self.xPrivKey=new Mnemonic(mnemonic).toHDPrivateKey();var xPubKey,currentWalletIndex=0,lastUsedWalletIndex=-1,assocMaxAddressIndexes={};setCurrentWallet()}function cleanAndAddWalletsAndAddresses(assocMaxAddressIndexes){var device=require("trustnote-common/device"),arrWalletIndexes=Object.keys(assocMaxAddressIndexes);removeAddressesAndWallets(arrWalletIndexes.length?function(){var myDeviceAddress=objectHash.getDeviceAddress(ecdsa.publicKeyCreate(self.xPrivKey.derive("m/1'").privateKey.bn.toBuffer({size:32}),!0).toString("base64"));profileService.replaceProfile(self.xPrivKey.toString(),self.inputMnemonic,myDeviceAddress,function(){device.setDevicePrivateKey(self.xPrivKey.derive("m/1'").privateKey.bn.toBuffer({size:32})),createWallets(arrWalletIndexes,function(){createAddresses(assocMaxAddressIndexes,function(){self.scanning=!1,$scope.index.showneikuang=!1,self.password&&profileService.setPrivateKeyEncryptionFC(self.password,function(){$rootScope.$emit("Local/NewEncryptionSetting"),$scope.encrypt=!0,delete self.password}),$rootScope.$emit("Local/ShowAlertnei",arrWalletIndexes.length+gettextCatalog.getString(" wallets recovered, please restart the application to finish."),"fi-check",function(){navigator&&navigator.app?navigator.app.exitApp():process.exit&&process.exit()})})})})}:function(){arrWalletIndexes[0]=0;var myDeviceAddress=objectHash.getDeviceAddress(ecdsa.publicKeyCreate(self.xPrivKey.derive("m/1'").privateKey.bn.toBuffer({size:32}),!0).toString("base64"));profileService.replaceProfile(self.xPrivKey.toString(),self.inputMnemonic,myDeviceAddress,function(){device.setDevicePrivateKey(self.xPrivKey.derive("m/1'").privateKey.bn.toBuffer({size:32})),createWallets(arrWalletIndexes,function(){self.scanning=!1,$scope.index.showneikuang=!1,self.password&&profileService.setPrivateKeyEncryptionFC(self.password,function(){$rootScope.$emit("Local/NewEncryptionSetting"),$scope.encrypt=!0,delete self.password}),$rootScope.$emit("Local/ShowAlertnei",arrWalletIndexes.length+gettextCatalog.getString(" wallets recovered, please restart the application to finish."),"fi-check",function(){navigator&&navigator.app?navigator.app.exitApp():process.exit&&process.exit()})})})})}var async=require("async"),conf=require("trustnote-common/conf.js"),wallet_defined_by_keys=require("trustnote-common/wallet_defined_by_keys.js"),objectHash=require("trustnote-common/object_hash.js");try{var ecdsa=require("secp256k1")}catch(e){var ecdsa=require("trustnote-common/node_modules/secp256k1")}var Mnemonic=require("bitcore-mnemonic"),Bitcore=require("bitcore-lib"),db=require("trustnote-common/db.js"),network=require("trustnote-common/network"),myWitnesses=require("trustnote-common/my_witnesses"),fc=profileService.focusedClient,successMsg=gettext("Backup words deleted"),self=this;self.error="",self.bLight=conf.bLight,self.scanning=!1,self.inputMnemonic="",self.xPrivKey="",self.assocIndexesToWallets={},self.credentialsEncrypted=!1,self.isCordova=isCordova;var reg=new RegExp(/^[a-z]+$/);self.delteConfirm=function(){fc.clearMnemonic(),profileService.clearMnemonic(function(){notification.success(successMsg)})},self.passwordRequest=function(msg,cb){self.credentialsEncrypted=!0,$timeout(function(){$scope.$apply()}),profileService.unlockFC(msg,function(err){if("undefined"!=typeof err){if("undefined"==typeof err.message)return;return"Wrong password"===err.message&&$timeout(function(){self.passwordRequest(gettextCatalog.getString(err.message),cb)},500),void($scope.index.showneikuang=!1)}if(!err)return profileService.disablePrivateKeyEncryptionFC(function(err){if($rootScope.$emit("Local/NewEncryptionSetting"),err)return void(self.credentialsEncrypted=!0)}),profileService.password&&(self.password=profileService.password),self.credentialsEncrypted=!1,cb()})},self.showPopup=function(msg,msg_icon,cb){$log.warn("Showing "+msg_icon+" popup:"+msg),self.showAlert={msg:msg.toString(),msg_icon:msg_icon,close:function(err){if(self.showAlert=null,cb)return cb(err)}},$timeout(function(){$rootScope.$apply()})},$rootScope.$on("Local/ShowAlertnei",function(event,msg,msg_icon,cb){self.showPopup(msg,msg_icon,cb)}),self.recoveryForm=function(){self.m1=0,self.strMnemonic(),self.inputMnemonic&&(self.error="",self.inputMnemonic=self.inputMnemonic.toLowerCase(),self.inputMnemonic.split(" ").length%3===0&&Mnemonic.isValid(self.inputMnemonic)?($scope.index.showneikuang=!0,delete profileService.haschoosen,fc&&fc.hasPrivKeyEncrypted()?self.passwordRequest(gettextCatalog.getString("This will permanently delete all your existing wallets!"),function(){self.scanning=!0,self.bLight?scanForAddressesAndWalletsInLightClient(self.inputMnemonic,cleanAndAddWalletsAndAddresses):scanForAddressesAndWallets(self.inputMnemonic,cleanAndAddWalletsAndAddresses)}):(self.scanning=!0,self.bLight?scanForAddressesAndWalletsInLightClient(self.inputMnemonic,cleanAndAddWalletsAndAddresses):scanForAddressesAndWallets(self.inputMnemonic,cleanAndAddWalletsAndAddresses))):self.error=gettext("Seed is not valid"))},self.items=[],self.m1=0,self.num=-1,self.jumpNum=1,self.jumpNext=function(){window.clearTimeout(self.t);var inputList=document.getElementsByClassName("inptMnemonic3");12!=self.jumpNum&&(self.t=setTimeout(function(){inputList[self.jumpNum].focus(),self.jumpNum++},100))},self.hideUlclearItems=function(){self.m1=0,self.items=[],self.jumpNext()},self.funReg1=function(){self.items=[],self.m1=self.jumpNum=1,reg.test(self.mnemonic1)&&(self.str=self.mnemonic1,self.funReg())},self.funReg2=function(){self.items=[],self.m1=self.jumpNum=2,reg.test(self.mnemonic2)&&(self.str=self.mnemonic2,self.funReg())},self.funReg3=function(){self.items=[],self.m1=self.jumpNum=3,reg.test(self.mnemonic3)&&(self.str=self.mnemonic3,self.funReg())},self.funReg4=function(){self.items=[],self.m1=self.jumpNum=4,reg.test(self.mnemonic4)&&(self.str=self.mnemonic4,self.funReg())},self.funReg5=function(){self.items=[],self.m1=self.jumpNum=5,reg.test(self.mnemonic5)&&(self.str=self.mnemonic5,self.funReg())},self.funReg6=function(){self.items=[],self.m1=self.jumpNum=6,reg.test(self.mnemonic6)&&(self.str=self.mnemonic6,self.funReg())},self.funReg7=function(){self.items=[],self.m1=self.jumpNum=7,reg.test(self.mnemonic7)&&(self.str=self.mnemonic7,self.funReg())},self.funReg8=function(){self.items=[],self.m1=self.jumpNum=8,reg.test(self.mnemonic8)&&(self.str=self.mnemonic8,self.funReg())},self.funReg9=function(){self.items=[],self.m1=self.jumpNum=9,reg.test(self.mnemonic9)&&(self.str=self.mnemonic9,self.funReg())},self.funReg10=function(){self.items=[],self.m1=self.jumpNum=10,reg.test(self.mnemonic10)&&(self.str=self.mnemonic10,self.funReg())},self.funReg11=function(){self.items=[],self.m1=self.jumpNum=11,reg.test(self.mnemonic11)&&(self.str=self.mnemonic11,self.funReg())},self.funReg12=function(){self.items=[],self.m1=self.jumpNum=12,reg.test(self.mnemonic12)&&(self.str=self.mnemonic12,self.funReg())},self.strMnemonic=function(){return self.inputMnemonic=self.mnemonic1+" "+self.mnemonic2+" "+self.mnemonic3+" "+self.mnemonic4+" "+self.mnemonic5+" "+self.mnemonic6+" "+self.mnemonic7+" "+self.mnemonic8+" "+self.mnemonic9+" "+self.mnemonic10+" "+self.mnemonic11+" "+self.mnemonic12},self.handleKeyboard=function(e){40!=e.keyCode&&32!=e.keyCode||(self.num>=self.items.length-1?self.num=0:self.num++),38==e.keyCode&&(0==self.num?self.num=self.items.length-1:self.num--)},self.handleKeyboard1=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic1+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard2=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic2+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard3=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic3+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard4=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic4+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard5=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic5+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard6=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic6+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard7=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic7+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard8=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic8+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard9=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic9+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard10=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic10+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard11=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic11+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard12=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic12+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.funReg=function(){self.num=-1}}),angular.module("copayApp.controllers").controller("recoveryFromSeeddir",function($rootScope,$scope,$log,gettext,$timeout,gettextCatalog,profileService,go,notification,storageService){function determineIfAddressUsed(address,cb){db.query("SELECT 1 FROM outputs WHERE address = ? LIMIT 1",[address],function(outputsRows){1===outputsRows.length?cb(!0):db.query("SELECT 1 FROM unit_authors WHERE address = ? LIMIT 1",[address],function(unitAuthorsRows){cb(1===unitAuthorsRows.length)})})}function scanForAddressesAndWallets(mnemonic,cb){function checkAndAddCurrentAddress(is_change){var address=objectHash.getChash160(["sig",{pubkey:wallet_defined_by_keys.derivePubkey(xPubKey,"m/"+is_change+"/"+currentAddressIndex)}]);determineIfAddressUsed(address,function(bUsed){bUsed?(lastUsedAddressIndex=currentAddressIndex,assocMaxAddressIndexes[currentWalletIndex]||(assocMaxAddressIndexes[currentWalletIndex]={main:0}),is_change?assocMaxAddressIndexes[currentWalletIndex].change=currentAddressIndex:assocMaxAddressIndexes[currentWalletIndex].main=currentAddressIndex,currentAddressIndex++,checkAndAddCurrentAddress(is_change)):(currentAddressIndex++,currentAddressIndex-lastUsedAddressIndex>=20?is_change?(lastUsedAddressIndex!==-1&&(lastUsedWalletIndex=currentWalletIndex),currentWalletIndex-lastUsedWalletIndex>=20?cb(assocMaxAddressIndexes):(currentWalletIndex++,setCurrentWallet())):(currentAddressIndex=0,checkAndAddCurrentAddress(1)):checkAndAddCurrentAddress(is_change))})}function setCurrentWallet(){xPubKey=Bitcore.HDPublicKey(self.xPrivKey.derive("m/44'/0'/"+currentWalletIndex+"'")),lastUsedAddressIndex=-1,currentAddressIndex=0,checkAndAddCurrentAddress(0)}self.xPrivKey=new Mnemonic(mnemonic).toHDPrivateKey();var xPubKey,lastUsedAddressIndex=-1,lastUsedWalletIndex=-1,currentAddressIndex=0,currentWalletIndex=0,assocMaxAddressIndexes={};setCurrentWallet()}function removeAddressesAndWallets(cb){var arrQueries=[];db.addQuery(arrQueries,"DELETE FROM pending_shared_address_signing_paths"),db.addQuery(arrQueries,"DELETE FROM shared_address_signing_paths"),db.addQuery(arrQueries,"DELETE FROM pending_shared_addresses"),db.addQuery(arrQueries,"DELETE FROM shared_addresses"),db.addQuery(arrQueries,"DELETE FROM my_addresses"),db.addQuery(arrQueries,"DELETE FROM wallet_signing_paths"),db.addQuery(arrQueries,"DELETE FROM extended_pubkeys"),db.addQuery(arrQueries,"DELETE FROM wallets"),db.addQuery(arrQueries,"DELETE FROM correspondent_devices"),async.series(arrQueries,cb)}function createAddresses(assocMaxAddressIndexes,cb){function addAddress(wallet,is_change,index,maxIndex){wallet_defined_by_keys.issueAddress(wallet,is_change,index,function(addressInfo){index++,index<=maxIndex?addAddress(wallet,is_change,index,maxIndex):is_change?(currentAccount++,currentAccount<accounts.length?startAddToNewWallet(0):cb()):startAddToNewWallet(1)})}function startAddToNewWallet(is_change){is_change?void 0!==assocMaxAddressIndexes[accounts[currentAccount]].change?addAddress(self.assocIndexesToWallets[accounts[currentAccount]],1,0,assocMaxAddressIndexes[accounts[currentAccount]].change):(currentAccount++,currentAccount<accounts.length?startAddToNewWallet(0):cb()):addAddress(self.assocIndexesToWallets[accounts[currentAccount]],0,0,assocMaxAddressIndexes[accounts[currentAccount]].main+20)}var accounts=Object.keys(assocMaxAddressIndexes),currentAccount=0;startAddToNewWallet(0)}function createWallets(arrWalletIndexes,cb){function createWallet(n){var account=parseInt(arrWalletIndexes[n]),opts={};opts.m=1,opts.n=1,opts.name="Wallet #"+account,opts.network="livenet",opts.cosigners=[],opts.extendedPrivateKey=self.xPrivKey,opts.mnemonic=self.inputMnemonic,opts.account=account,profileService.createWallet(opts,function(err,walletId){self.assocIndexesToWallets[account]=walletId,n++,n<arrWalletIndexes.length?createWallet(n):cb()})}createWallet(0)}function scanForAddressesAndWalletsInLightClient(mnemonic,cb){function checkAndAddCurrentAddresses(is_change){assocMaxAddressIndexes[currentWalletIndex]||(assocMaxAddressIndexes[currentWalletIndex]={main:0,change:0});for(var arrTmpAddresses=[],i=0;i<20;i++){var index=(is_change?assocMaxAddressIndexes[currentWalletIndex].change:assocMaxAddressIndexes[currentWalletIndex].main)+i;arrTmpAddresses.push(objectHash.getChash160(["sig",{pubkey:wallet_defined_by_keys.derivePubkey(xPubKey,"m/"+is_change+"/"+index)}]))}myWitnesses.readMyWitnesses(function(arrWitnesses){network.requestFromLightVendor("light/get_history",{addresses:arrTmpAddresses,witnesses:arrWitnesses},function(ws,request,response){if(response&&response.error){var breadcrumbs=require("trustnote-common/breadcrumbs.js");return breadcrumbs.add("Error scanForAddressesAndWalletsInLightClient: "+response.error),self.error="When scanning an error occurred, please try again later.",
self.scanning=!1,self.show=!1,void $timeout(function(){$rootScope.$apply()})}Object.keys(response).length?(lastUsedWalletIndex=currentWalletIndex,is_change?assocMaxAddressIndexes[currentWalletIndex].change+=20:assocMaxAddressIndexes[currentWalletIndex].main+=20,checkAndAddCurrentAddresses(is_change)):is_change?(0===assocMaxAddressIndexes[currentWalletIndex].change&&0===assocMaxAddressIndexes[currentWalletIndex].main&&delete assocMaxAddressIndexes[currentWalletIndex],currentWalletIndex++,currentWalletIndex-lastUsedWalletIndex>3?cb(assocMaxAddressIndexes):setCurrentWallet()):checkAndAddCurrentAddresses(1)})},"wait")}function setCurrentWallet(){xPubKey=Bitcore.HDPublicKey(self.xPrivKey.derive("m/44'/0'/"+currentWalletIndex+"'")),checkAndAddCurrentAddresses(0)}self.xPrivKey=new Mnemonic(mnemonic).toHDPrivateKey();var xPubKey,currentWalletIndex=0,lastUsedWalletIndex=-1,assocMaxAddressIndexes={};setCurrentWallet()}function cleanAndAddWalletsAndAddresses(assocMaxAddressIndexes){var device=require("trustnote-common/device"),arrWalletIndexes=Object.keys(assocMaxAddressIndexes);removeAddressesAndWallets(arrWalletIndexes.length?function(){var myDeviceAddress=objectHash.getDeviceAddress(ecdsa.publicKeyCreate(self.xPrivKey.derive("m/1'").privateKey.bn.toBuffer({size:32}),!0).toString("base64"));profileService.replaceProfile(self.xPrivKey.toString(),self.inputMnemonic,myDeviceAddress,function(){device.setDevicePrivateKey(self.xPrivKey.derive("m/1'").privateKey.bn.toBuffer({size:32})),createWallets(arrWalletIndexes,function(){createAddresses(assocMaxAddressIndexes,function(){self.scanning=!1,self.show=!1,self.haschoosen(),$rootScope.$emit("Local/ShowAlertdir",arrWalletIndexes.length+gettextCatalog.getString(" wallets recovered, please restart the application to finish."),"fi-check",function(){navigator&&navigator.app?navigator.app.exitApp():process.exit&&process.exit()})})})})}:function(){arrWalletIndexes[0]=0;var myDeviceAddress=objectHash.getDeviceAddress(ecdsa.publicKeyCreate(self.xPrivKey.derive("m/1'").privateKey.bn.toBuffer({size:32}),!0).toString("base64"));profileService.replaceProfile(self.xPrivKey.toString(),self.inputMnemonic,myDeviceAddress,function(){device.setDevicePrivateKey(self.xPrivKey.derive("m/1'").privateKey.bn.toBuffer({size:32})),createWallets(arrWalletIndexes,function(){self.scanning=!1,self.show=!1,self.haschoosen(),$rootScope.$emit("Local/ShowAlertdir",arrWalletIndexes.length+gettextCatalog.getString(" wallets recovered, please restart the application to finish."),"fi-check",function(){navigator&&navigator.app?navigator.app.exitApp():process.exit&&process.exit()})})})})}function cleanAndAddWalletsAndAddressesdel(assocMaxAddressIndexes){var device=require("trustnote-common/device"),arrWalletIndexes=Object.keys(assocMaxAddressIndexes);removeAddressesAndWallets(arrWalletIndexes.length?function(){var myDeviceAddress=objectHash.getDeviceAddress(ecdsa.publicKeyCreate(self.xPrivKey.derive("m/1'").privateKey.bn.toBuffer({size:32}),!0).toString("base64"));profileService.replaceProfile(self.xPrivKey.toString(),self.inputMnemonic,myDeviceAddress,function(){device.setDevicePrivateKey(self.xPrivKey.derive("m/1'").privateKey.bn.toBuffer({size:32})),createWallets(arrWalletIndexes,function(){createAddresses(assocMaxAddressIndexes,function(){self.scanning=!1,self.show=!1,self.haschoosen(),$rootScope.$emit("Local/ShowAlertdir",arrWalletIndexes.length+gettextCatalog.getString(" wallets recovered, please restart the application to finish."),"fi-check",function(){self.delteConfirm(),navigator&&navigator.app?navigator.app.exitApp():process.exit&&process.exit()})})})})}:function(){arrWalletIndexes[0]=0;var myDeviceAddress=objectHash.getDeviceAddress(ecdsa.publicKeyCreate(self.xPrivKey.derive("m/1'").privateKey.bn.toBuffer({size:32}),!0).toString("base64"));profileService.replaceProfile(self.xPrivKey.toString(),self.inputMnemonic,myDeviceAddress,function(){device.setDevicePrivateKey(self.xPrivKey.derive("m/1'").privateKey.bn.toBuffer({size:32})),createWallets(arrWalletIndexes,function(){self.scanning=!1,self.show=!1,self.haschoosen(),$rootScope.$emit("Local/ShowAlertdir",arrWalletIndexes.length+gettextCatalog.getString(" wallets recovered, please restart the application to finish."),"fi-check",function(){self.delteConfirm(),navigator&&navigator.app?navigator.app.exitApp():process.exit&&process.exit()})})})})}var async=require("async"),conf=require("trustnote-common/conf.js"),wallet_defined_by_keys=require("trustnote-common/wallet_defined_by_keys.js"),objectHash=require("trustnote-common/object_hash.js");try{var ecdsa=require("secp256k1")}catch(e){var ecdsa=require("trustnote-common/node_modules/secp256k1")}var Mnemonic=require("bitcore-mnemonic"),Bitcore=require("bitcore-lib"),db=require("trustnote-common/db.js"),network=require("trustnote-common/network"),myWitnesses=require("trustnote-common/my_witnesses"),fc=profileService.focusedClient,successMsg=gettext("Backup words deleted"),self=this;self.error="",self.bLight=conf.bLight,self.scanning=!1,self.inputMnemonic="",self.xPrivKey="",self.assocIndexesToWallets={},self.credentialsEncrypted=!1;var reg=new RegExp(/^[a-z]+$/);self.show=!1,self.delteConfirm=function(){fc.clearMnemonic(),profileService.clearMnemonic(function(){notification.success(successMsg)})},self.passwordRequest=function(msg){self.credentialsEncrypted=!0,$timeout(function(){$scope.$apply()}),profileService.unlockFC(msg,function(err){if("undefined"!=typeof err){if("undefined"==typeof err.message)return;return void("Wrong password"===err.message&&$timeout(function(){self.passwordRequest(gettextCatalog.getString(err.message))},500))}err||(profileService.disablePrivateKeyEncryptionFC(function(err){if($rootScope.$emit("Local/NewEncryptionSetting"),err)return void(self.credentialsEncrypted=!0)}),self.credentialsEncrypted=!1)})},fc.isPrivKeyEncrypted()&&self.passwordRequest(gettextCatalog.getString("This will permanently delete all your existing wallets!")),self.showPopup=function(msg,msg_icon,cb){$log.warn("Showing "+msg_icon+" popup:"+msg),self.showAlert={msg:msg.toString(),msg_icon:msg_icon,close:function(err){if(self.showAlert=null,cb)return cb(err)}},$timeout(function(){$rootScope.$apply()})},$rootScope.$on("Local/ShowAlertdir",function(event,msg,msg_icon,cb){self.showPopup(msg,msg_icon,cb)}),self.recoveryForm=function(){self.m1=0,self.strMnemonic(),self.inputMnemonic&&(self.error="",self.inputMnemonic=self.inputMnemonic.toLowerCase(),self.inputMnemonic.split(" ").length%3===0&&Mnemonic.isValid(self.inputMnemonic)?(self.scanning=!0,self.show=!0,self.bLight?scanForAddressesAndWalletsInLightClient(self.inputMnemonic,cleanAndAddWalletsAndAddresses):scanForAddressesAndWallets(self.inputMnemonic,cleanAndAddWalletsAndAddresses)):self.error="Seed is not valid")},self.haschoosen=function(){storageService.hashaschoosen(2,function(err){})},self.delteConfirm=function(){fc.clearMnemonic(),profileService.clearMnemonic(function(){self.deleted=!0,notification.success(successMsg)})},self.recoveryFormdel=function(){self.m1=0,self.strMnemonic(),self.inputMnemonic&&(self.error="",self.inputMnemonic=self.inputMnemonic.toLowerCase(),self.inputMnemonic.split(" ").length%3===0&&Mnemonic.isValid(self.inputMnemonic)?(self.scanning=!0,self.show=!0,self.bLight?scanForAddressesAndWalletsInLightClient(self.inputMnemonic,cleanAndAddWalletsAndAddressesdel):scanForAddressesAndWallets(self.inputMnemonic,cleanAndAddWalletsAndAddressesdel)):self.error="Seed is not valid")},self.items=[],self.m1=0,self.num=-1,self.jumpNum=1,self.jumpNext=function(){window.clearTimeout(self.t);var inputList=document.getElementsByClassName("inptMnemonic1");12!=self.jumpNum&&(self.t=setTimeout(function(){inputList[self.jumpNum].focus(),self.jumpNum++},100))},self.hideUlclearItems=function(){self.m1=0,self.items=[],self.jumpNext()},self.funReg1=function(){self.items=[],self.m1=self.jumpNum=1,reg.test(self.mnemonic1)&&(self.str=self.mnemonic1,self.funReg())},self.funReg2=function(){self.items=[],self.m1=self.jumpNum=2,reg.test(self.mnemonic2)&&(self.str=self.mnemonic2,self.funReg())},self.funReg3=function(){self.items=[],self.m1=self.jumpNum=3,reg.test(self.mnemonic3)&&(self.str=self.mnemonic3,self.funReg())},self.funReg4=function(){self.items=[],self.m1=self.jumpNum=4,reg.test(self.mnemonic4)&&(self.str=self.mnemonic4,self.funReg())},self.funReg5=function(){self.items=[],self.m1=self.jumpNum=5,reg.test(self.mnemonic5)&&(self.str=self.mnemonic5,self.funReg())},self.funReg6=function(){self.items=[],self.m1=self.jumpNum=6,reg.test(self.mnemonic6)&&(self.str=self.mnemonic6,self.funReg())},self.funReg7=function(){self.items=[],self.m1=self.jumpNum=7,reg.test(self.mnemonic7)&&(self.items=[],self.str=self.mnemonic7,self.funReg())},self.funReg8=function(){self.items=[],self.m1=self.jumpNum=8,reg.test(self.mnemonic8)&&(self.str=self.mnemonic8,self.funReg())},self.funReg9=function(){self.items=[],self.m1=self.jumpNum=9,reg.test(self.mnemonic9)&&(self.str=self.mnemonic9,self.funReg())},self.funReg10=function(){self.items=[],self.m1=self.jumpNum=10,reg.test(self.mnemonic10)&&(self.str=self.mnemonic10,self.funReg())},self.funReg11=function(){self.items=[],self.m1=self.jumpNum=11,reg.test(self.mnemonic11)&&(self.str=self.mnemonic11,self.funReg())},self.funReg12=function(){self.items=[],self.m1=self.jumpNum=12,reg.test(self.mnemonic12)&&(self.str=self.mnemonic12,self.funReg())},self.strMnemonic=function(){return self.inputMnemonic=self.mnemonic1+" "+self.mnemonic2+" "+self.mnemonic3+" "+self.mnemonic4+" "+self.mnemonic5+" "+self.mnemonic6+" "+self.mnemonic7+" "+self.mnemonic8+" "+self.mnemonic9+" "+self.mnemonic10+" "+self.mnemonic11+" "+self.mnemonic12},self.handleKeyboard=function(e){40!=e.keyCode&&32!=e.keyCode||(self.num>=self.items.length-1?self.num=0:self.num++),38==e.keyCode&&(0==self.num?self.num=self.items.length-1:self.num--)},self.handleKeyboard1=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic1+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard2=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic2+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard3=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic3+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard4=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic4+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard5=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic5+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard6=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic6+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard7=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic7+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard8=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic8+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard9=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic9+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard10=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic10+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard11=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic11+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.handleKeyboard12=function(e){if(self.handleKeyboard(e),13==e.keyCode){if(self.num==-1)return;self.m1=0,self.mnemonic12+=self.items[self.num],self.num=-1,self.jumpNext()}self.strMnemonic()},self.funReg=function(){self.num=-1;var mnemonic=["abandon","ability","able","about","above","absent","absorb","abstract","absurd","abuse","access","accident","account","accuse","achieve","acid","acoustic","acquire","across","act","action","actor","actress","actual","adapt","add","addict","address","adjust","admit","adult","advance","advice","aerobic","affair","afford","afraid","again","age","agent","agree","ahead","aim","air","airport","aisle","alarm","album","alcohol","alert","alien","all","alley","allow","almost","alone","alpha","already","also","alter","always","amateur","amazing","among","amount","amused","analyst","anchor","ancient","anger","angle","angry","animal","ankle","announce","annual","another","answer","antenna","antique","anxiety","any","apart","apology","appear","apple","approve","april","arch","arctic","area","arena","argue","arm","armed","armor","army","around","arrange","arrest","arrive","arrow","art","artefact","artist","artwork","ask","aspect","assault","asset","assist","assume","asthma","athlete","atom","attack","attend","attitude","attract","auction","audit","august","aunt","author","auto","autumn","average","avocado","avoid","awake","aware","away","awesome","awful","awkward","axis","baby","bachelor","bacon","badge","bag","balance","balcony","ball","bamboo","banana","banner","bar","barely","bargain","barrel","base","basic","basket","battle","beach","bean","beauty","because","become","beef","before","begin","behave","behind","believe","below","belt","bench","benefit","best","betray","better","between","beyond","bicycle","bid","bike","bind","biology","bird","birth","bitter","black","blade","blame","blanket","blast","bleak","bless","blind","blood","blossom","blouse","blue","blur","blush","board","boat","body","boil","bomb","bone","bonus","book","boost","border","boring","borrow","boss","bottom","bounce","box","boy","bracket","brain","brand","brass","brave","bread","breeze","brick","bridge","brief","bright","bring","brisk","broccoli","broken","bronze","broom","brother","brown","brush","bubble","buddy","budget","buffalo","build","bulb","bulk","bullet","bundle","bunker","burden","burger","burst","bus","business","busy","butter","buyer","buzz","cabbage","cabin","cable","cactus","cage","cake","call","calm","camera","camp","can","canal","cancel","candy","cannon","canoe","canvas","canyon","capable","capital","captain","car","carbon","card","cargo","carpet","carry","cart","case","cash","casino","castle","casual","cat","catalog","catch","category","cattle","caught","cause","caution","cave","ceiling","celery","cement","census","century","cereal","certain","chair","chalk","champion","change","chaos","chapter","charge","chase","chat","cheap","check","cheese","chef","cherry","chest","chicken","chief","child","chimney","choice","choose","chronic","chuckle","chunk","churn","cigar","cinnamon","circle","citizen","city","civil","claim","clap","clarify","claw","clay","clean","clerk","clever","click","client","cliff","climb","clinic","clip","clock","clog","close","cloth","cloud","clown","club","clump","cluster","clutch","coach","coast","coconut","code","coffee","coil","coin","collect","color","column","combine","come","comfort","comic","common","company","concert","conduct","confirm","congress","connect","consider","control","convince","cook","cool","copper","copy","coral","core","corn","correct","cost","cotton","couch","country","couple","course","cousin","cover","coyote","crack","cradle","craft","cram","crane","crash","crater","crawl","crazy","cream","credit","creek","crew","cricket","crime","crisp","critic","crop","cross","crouch","crowd","crucial","cruel","cruise","crumble","crunch","crush","cry","crystal","cube","culture","cup","cupboard","curious","current","curtain","curve","cushion","custom","cute","cycle","dad","damage","damp","dance","danger","daring","dash","daughter","dawn","day","deal","debate","debris","decade","december","decide","decline","decorate","decrease","deer","defense","define","defy","degree","delay","deliver","demand","demise","denial","dentist","deny","depart","depend","deposit","depth","deputy","derive","describe","desert","design","desk","despair","destroy","detail","detect","develop","device","devote","diagram","dial","diamond","diary","dice","diesel","diet","differ","digital","dignity","dilemma","dinner","dinosaur","direct","dirt","disagree","discover","disease","dish","dismiss","disorder","display","distance","divert","divide","divorce","dizzy","doctor","document","dog","doll","dolphin","domain","donate","donkey","donor","door","dose","double","dove","draft","dragon","drama","drastic","draw","dream","dress","drift","drill","drink","drip","drive","drop","drum","dry","duck","dumb","dune","during","dust","dutch","duty","dwarf","dynamic","eager","eagle","early","earn","earth","easily","east","easy","echo","ecology","economy","edge","edit","educate","effort","egg","eight","either","elbow","elder","electric","elegant","element","elephant","elevator","elite","else","embark","embody","embrace","emerge","emotion","employ","empower","empty","enable","enact","end","endless","endorse","enemy","energy","enforce","engage","engine","enhance","enjoy","enlist","enough","enrich","enroll","ensure","enter","entire","entry","envelope","episode","equal","equip","era","erase","erode","erosion","error","erupt","escape","essay","essence","estate","eternal","ethics","evidence","evil","evoke","evolve","exact","example","excess","exchange","excite","exclude","excuse","execute","exercise","exhaust","exhibit","exile","exist","exit","exotic","expand","expect","expire","explain","expose","express","extend","extra","eye","eyebrow","fabric","face","faculty","fade","faint","faith","fall","false","fame","family","famous","fan","fancy","fantasy","farm","fashion","fat","fatal","father","fatigue","fault","favorite","feature","february","federal","fee","feed","feel","female","fence","festival","fetch","fever","few","fiber","fiction","field","figure","file","film","filter","final","find","fine","finger","finish","fire","firm","first","fiscal","fish","fit","fitness","fix","flag","flame","flash","flat","flavor","flee","flight","flip","float","flock","floor","flower","fluid","flush","fly","foam","focus","fog","foil","fold","follow","food","foot","force","forest","forget","fork","fortune","forum","forward","fossil","foster","found","fox","fragile","frame","frequent","fresh","friend","fringe","frog","front","frost","frown","frozen","fruit","fuel","fun","funny","furnace","fury","future","gadget","gain","galaxy","gallery","game","gap","garage","garbage","garden","garlic","garment","gas","gasp","gate","gather","gauge","gaze","general","genius","genre","gentle","genuine","gesture","ghost","giant","gift","giggle","ginger","giraffe","girl","give","glad","glance","glare","glass","glide","glimpse","globe","gloom","glory","glove","glow","glue","goat","goddess","gold","good","goose","gorilla","gospel","gossip","govern","gown","grab","grace","grain","grant","grape","grass","gravity","great","green","grid","grief","grit","grocery","group","grow","grunt","guard","guess","guide","guilt","guitar","gun","gym","habit","hair","half","hammer","hamster","hand","happy","harbor","hard","harsh","harvest","hat","have","hawk","hazard","head","health","heart","heavy","hedgehog","height","hello","helmet","help","hen","hero","hidden","high","hill","hint","hip","hire","history","hobby","hockey","hold","hole","holiday","hollow","home","honey","hood","hope","horn","horror","horse","hospital","host","hotel","hour","hover","hub","huge","human","humble","humor","hundred","hungry","hunt","hurdle","hurry","hurt","husband","hybrid","ice","icon","idea","identify","idle","ignore","ill","illegal","illness","image","imitate","immense","immune","impact","impose","improve","impulse","inch","include","income","increase","index","indicate","indoor","industry","infant","inflict","inform","inhale","inherit","initial","inject","injury","inmate","inner","innocent","input","inquiry","insane","insect","inside","inspire","install","intact","interest","into","invest","invite","involve","iron","island","isolate","issue","item","ivory","jacket","jaguar","jar","jazz","jealous","jeans","jelly","jewel","job","join","joke","journey","joy","judge","juice","jump","jungle","junior","junk","just","kangaroo","keen","keep","ketchup","key","kick","kid","kidney","kind","kingdom","kiss","kit","kitchen","kite","kitten","kiwi","knee","knife","knock","know","lab","label","labor","ladder","lady","lake","lamp","language","laptop","large","later","latin","laugh","laundry","lava","law","lawn","lawsuit","layer","lazy","leader","leaf","learn","leave","lecture","left","leg","legal","legend","leisure","lemon","lend","length","lens","leopard","lesson","letter","level","liar","liberty","library","license","life","lift","light","like","limb","limit","link","lion","liquid","list","little","live","lizard","load","loan","lobster","local","lock","logic","lonely","long","loop","lottery","loud","lounge","love","loyal","lucky","luggage","lumber","lunar","lunch","luxury","lyrics","machine","mad","magic","magnet","maid","mail","main","major","make","mammal","man","manage","mandate","mango","mansion","manual","maple","marble","march","margin","marine","market","marriage","mask","mass","master","match","material","math","matrix","matter","maximum","maze","meadow","mean","measure","meat","mechanic","medal","media","melody","melt","member","memory","mention","menu","mercy","merge","merit","merry","mesh","message","metal","method","middle","midnight","milk","million","mimic","mind","minimum","minor","minute","miracle","mirror","misery","miss","mistake","mix","mixed","mixture","mobile","model","modify","mom","moment","monitor","monkey","monster","month","moon","moral","more","morning","mosquito","mother","motion","motor","mountain","mouse","move","movie","much","muffin","mule","multiply","muscle","museum","mushroom","music","must","mutual","myself","mystery","myth","naive","name","napkin","narrow","nasty","nation","nature","near","neck","need","negative","neglect","neither","nephew","nerve","nest","net","network","neutral","never","news","next","nice","night","noble","noise","nominee","noodle","normal","north","nose","notable","note","nothing","notice","novel","now","nuclear","number","nurse","nut","oak","obey","object","oblige","obscure","observe","obtain","obvious","occur","ocean","october","odor","off","offer","office","often","oil","okay","old","olive","olympic","omit","once","one","onion","online","only","open","opera","opinion","oppose","option","orange","orbit","orchard","order","ordinary","organ","orient","original","orphan","ostrich","other","outdoor","outer","output","outside","oval","oven","over","own","owner","oxygen","oyster","ozone","pact","paddle","page","pair","palace","palm","panda","panel","panic","panther","paper","parade","parent","park","parrot","party","pass","patch","path","patient","patrol","pattern","pause","pave","payment","peace","peanut","pear","peasant","pelican","pen","penalty","pencil","people","pepper","perfect","permit","person","pet","phone","photo","phrase","physical","piano","picnic","picture","piece","pig","pigeon","pill","pilot","pink","pioneer","pipe","pistol","pitch","pizza","place","planet","plastic","plate","play","please","pledge","pluck","plug","plunge","poem","poet","point","polar","pole","police","pond","pony","pool","popular","portion","position","possible","post","potato","pottery","poverty","powder","power","practice","praise","predict","prefer","prepare","present","pretty","prevent","price","pride","primary","print","priority","prison","private","prize","problem","process","produce","profit","program","project","promote","proof","property","prosper","protect","proud","provide","public","pudding","pull","pulp","pulse","pumpkin","punch","pupil","puppy","purchase","purity","purpose","purse","push","put","puzzle","pyramid","quality","quantum","quarter","question","quick","quit","quiz","quote","rabbit","raccoon","race","rack","radar","radio","rail","rain","raise","rally","ramp","ranch","random","range","rapid","rare","rate","rather","raven","raw","razor","ready","real","reason","rebel","rebuild","recall","receive","recipe","record","recycle","reduce","reflect","reform","refuse","region","regret","regular","reject","relax","release","relief","rely","remain","remember","remind","remove","render","renew","rent","reopen","repair","repeat","replace","report","require","rescue","resemble","resist","resource","response","result","retire","retreat","return","reunion","reveal","review","reward","rhythm","rib","ribbon","rice","rich","ride","ridge","rifle","right","rigid","ring","riot","ripple","risk","ritual","rival","river","road","roast","robot","robust","rocket","romance","roof","rookie","room","rose","rotate","rough","round","route","royal","rubber","rude","rug","rule","run","runway","rural","sad","saddle","sadness","safe","sail","salad","salmon","salon","salt","salute","same","sample","sand","satisfy","satoshi","sauce","sausage","save","say","scale","scan","scare","scatter","scene","scheme","school","science","scissors","scorpion","scout","scrap","screen","script","scrub","sea","search","season","seat","second","secret","section","security","seed","seek","segment","select","sell","seminar","senior","sense","sentence","series","service","session","settle","setup","seven","shadow","shaft","shallow","share","shed","shell","sheriff","shield","shift","shine","ship","shiver","shock","shoe","shoot","shop","short","shoulder","shove","shrimp","shrug","shuffle","shy","sibling","sick","side","siege","sight","sign","silent","silk","silly","silver","similar","simple","since","sing","siren","sister","situate","six","size","skate","sketch","ski","skill","skin","skirt","skull","slab","slam","sleep","slender","slice","slide","slight","slim","slogan","slot","slow","slush","small","smart","smile","smoke","smooth","snack","snake","snap","sniff","snow","soap","soccer","social","sock","soda","soft","solar","soldier","solid","solution","solve","someone","song","soon","sorry","sort","soul","sound","soup","source","south","space","spare","spatial","spawn","speak","special","speed","spell","spend","sphere","spice","spider","spike","spin","spirit","split","spoil","sponsor","spoon","sport","spot","spray","spread","spring","spy","square","squeeze","squirrel","stable","stadium","staff","stage","stairs","stamp","stand","start","state","stay","steak","steel","stem","step","stereo","stick","still","sting","stock","stomach","stone","stool","story","stove","strategy","street","strike","strong","struggle","student","stuff","stumble","style","subject","submit","subway","success","such","sudden","suffer","sugar","suggest","suit","summer","sun","sunny","sunset","super","supply","supreme","sure","surface","surge","surprise","surround","survey","suspect","sustain","swallow","swamp","swap","swarm","swear","sweet","swift","swim","swing","switch","sword","symbol","symptom","syrup","system","table","tackle","tag","tail","talent","talk","tank","tape","target","task","taste","tattoo","taxi","teach","team","tell","ten","tenant","tennis","tent","term","test","text","thank","that","theme","then","theory","there","they","thing","this","thought","three","thrive","throw","thumb","thunder","ticket","tide","tiger","tilt","timber","time","tiny","tip","tired","tissue","title","toast","tobacco","today","toddler","toe","together","toilet","token","tomato","tomorrow","tone","tongue","tonight","tool","tooth","top","topic","topple","torch","tornado","tortoise","toss","total","tourist","toward","tower","town","toy","track","trade","traffic","tragic","train","transfer","trap","trash","travel","tray","treat","tree","trend","trial","tribe","trick","trigger","trim","trip","trophy","trouble","truck","true","truly","trumpet","trust","truth","try","tube","tuition","tumble","tuna","tunnel","turkey","turn","turtle","twelve","twenty","twice","twin","twist","two","type","typical","ugly","umbrella","unable","unaware","uncle","uncover","under","undo","unfair","unfold","unhappy","uniform","unique","unit","universe","unknown","unlock","until","unusual","unveil","update","upgrade","uphold","upon","upper","upset","urban","urge","usage","use","used","useful","useless","usual","utility","vacant","vacuum","vague","valid","valley","valve","van","vanish","vapor","various","vast","vault","vehicle","velvet","vendor","venture","venue","verb","verify","version","very","vessel","veteran","viable","vibrant","vicious","victory","video","view","village","vintage","violin","virtual","virus","visa","visit","visual","vital","vivid","vocal","voice","void","volcano","volume","vote","voyage","wage","wagon","wait","walk","wall","walnut","want","warfare","warm","warrior","wash","wasp","waste","water","wave","way","wealth","weapon","wear","weasel","weather","web","wedding","weekend","weird","welcome","west","wet","whale","what","wheat","wheel","when","where","whip","whisper","wide","width","wife","wild","will","win","window","wine","wing","wink","winner","winter","wire","wisdom","wise","wish","witness","wolf","woman","wonder","wood","wool","word","work","world","worry","worth","wrap","wreck","wrestle","wrist","write","wrong","yard","year","yellow","you","young","youth","zebra","zero","zone","zoo"],newlist=[],newStr="";try{for(var reg1=new RegExp("^"+self.str+".*"),i=0;i<mnemonic.length;i++)reg1.test(mnemonic[i])&&(newStr=mnemonic[i].substr(self.str.length),newlist.push(newStr))}catch(err){console.log(err)}self.items=newlist,self.items.length>3&&(self.items.length=3)}}),angular.module("copayApp.controllers").controller("sidebarController",function($rootScope,$timeout,lodash,profileService,configService,go,isMobile,isCordova,backButton){var self=this;self.isWindowsPhoneApp=isMobile.Windows()&&isCordova,self.walletSelection=!1,$rootScope.$on("Local/WalletListUpdated",function(event){self.walletSelection=!1,self.setWallets()}),$rootScope.$on("Local/ColorUpdated",function(event){self.setWallets()}),$rootScope.$on("Local/AliasUpdated",function(event){self.setWallets()}),self.signout=function(){profileService.signout()},self.switchWallet=function(selectedWalletId,currentWalletId){backButton.menuOpened=!1,selectedWalletId!=currentWalletId&&(self.walletSelection=!1,profileService.setAndStoreFocus(selectedWalletId,!0,function(){}),self.fc=profileService.focusedClient,self.fc.observed?go.observed=1:go.observed=0)},self.toggleWalletSelection=function(){self.walletSelection=!self.walletSelection,self.walletSelection&&self.setWallets()},self.setWallets=function(){if(profileService.profile){var config=configService.getSync();config.colorFor=config.colorFor||{},config.aliasFor=config.aliasFor||{};var ret=lodash.map(profileService.profile.credentials,function(c){return{m:c.m,n:c.n,name:config.aliasFor[c.walletId]||c.walletName,id:c.walletId,color:config.colorFor[c.walletId]||"#0095ff",observed:c.observed}});self.wallets=lodash.sortBy(ret,"name")}},self.setWallets(),self.goPreferences=function(itemID,currentID){profileService.tempWalletId=currentID,itemID!==currentID&&profileService.setAndStoreFocus(itemID,!1,function(){}),self.fc=profileService.focusedClient,self.fc.observed?go.observed=1:go.observed=0,$rootScope.go("preferences")}}),angular.module("copayApp.controllers").controller("splashController",function($scope,$timeout,$log,configService,profileService,storageService,go,isCordova){var self=this;this.saveDeviceName=function(){console.log("saveDeviceName: "+self.deviceName);var device=require("trustnote-common/device.js");device.setDeviceName(self.deviceName);var opts={deviceName:self.deviceName};storageService.hashaschoosen(1,function(err){}),configService.set(opts,function(err){$timeout(function(){err&&self.$emit("Local/DeviceError",err),self.bDeviceNameSet=!0})})},configService.get(function(err,config){var thistempName=config.deviceName||"TrustNote";
thistempName.length>=20&&(thistempName=thistempName.substr(0,20)),self.deviceName=thistempName}),this.step=isCordova?"device_name":"wallet_type",this.wallet_type="light",this.setWalletType=function(){var bLight="light"===self.wallet_type;if(!bLight)return void(self.step="device_name");var fs=require("fs"),desktopApp=require("trustnote-common/desktop_app.js"),appDataDir=desktopApp.getAppDataDir(),userConfFile=appDataDir+"/conf.json";fs.writeFile(userConfFile,JSON.stringify({bLight:bLight},null,"\t"),"utf8",function(err){if(err)throw Error("failed to write conf.json: "+err);var conf=require("trustnote-common/conf.js");if(!conf.bLight)throw Error("Failed to switch to light, please restart the app");self.step="device_name",$timeout(function(){$scope.$apply()})})},this.create=function(noWallet){return $scope.index.splashClick=!0,self.creatingProfile?console.log("already creating profile"):(self.creatingProfile=!0,void $timeout(function(){profileService.create({noWallet:noWallet},function(err){err&&(self.creatingProfile=!1,$log.warn(err),self.error=err,$scope.$apply()),go.path("backupWaring")})},100))},this.init=function(){storageService.getDisclaimerFlag(function(err,val){val||go.path("preferencesGlobal.preferencesAbout.disclaimer"),profileService.profile&&go.walletHome()})}}),angular.module("copayApp.controllers").controller("synchronization",function($rootScope,$scope,$log,gettext,$timeout,lodash,gettextCatalog,profileService,storageService,configService){function determineIfAddressUsed(address,cb){db.query("SELECT 1 FROM outputs WHERE address = ? LIMIT 1",[address],function(outputsRows){1===outputsRows.length?cb(!0):db.query("SELECT 1 FROM unit_authors WHERE address = ? LIMIT 1",[address],function(unitAuthorsRows){cb(1===unitAuthorsRows.length)})})}function scanForAddressesAndWallets(cb){function checkAndAddCurrentAddress(is_change){var address=objectHash.getChash160(["sig",{pubkey:wallet_defined_by_keys.derivePubkey(xPubKey,"m/"+is_change+"/"+currentAddressIndex)}]);determineIfAddressUsed(address,function(bUsed){bUsed?(lastUsedAddressIndex=currentAddressIndex,assocMaxAddressIndexes[currentWalletIndex]||(assocMaxAddressIndexes[currentWalletIndex]={main:0}),is_change?assocMaxAddressIndexes[currentWalletIndex].change=currentAddressIndex:assocMaxAddressIndexes[currentWalletIndex].main=currentAddressIndex,currentAddressIndex++,checkAndAddCurrentAddress(is_change)):(currentAddressIndex++,currentAddressIndex-lastUsedAddressIndex>40?is_change?(lastUsedAddressIndex!==-1&&(lastUsedWalletIndex=currentWalletIndex),currentWalletIndex>=self.totalWallet-1?cb(assocMaxAddressIndexes):(currentWalletIndex++,setCurrentWallet())):(lastUsedAddressIndex!==-1&&(assocMaxAddressIndexes[currentWalletIndex]||(assocMaxAddressIndexes[currentWalletIndex]={main:0}),assocMaxAddressIndexes[currentWalletIndex].main=40*Math.floor((currentAddressIndex-1)/40)),currentAddressIndex=0,checkAndAddCurrentAddress(1)):checkAndAddCurrentAddress(is_change))})}function setCurrentWallet(){xPubKey=Bitcore.HDPublicKey.fromString(self.assocWallets[currentWalletIndex]),lastUsedAddressIndex=-1,currentAddressIndex=0,checkAndAddCurrentAddress(0)}var xPubKey,lastUsedAddressIndex=-1,lastUsedWalletIndex=-1,currentAddressIndex=0,currentWalletIndex=0,assocMaxAddressIndexes={};setCurrentWallet()}function createAddresses(assocMaxAddressIndexes,cb){function addAddress(wallet,is_change,index,maxIndex){wallet_defined_by_keys.issueAddressSync(wallet,is_change,index,function(addressInfo){index++,index<=maxIndex?addAddress(wallet,is_change,index,maxIndex):is_change?(currentAccount++,currentAccount<accounts.length?startAddToNewWallet(0):cb()):startAddToNewWallet(1)})}function startAddToNewWallet(is_change){is_change?void 0!==assocMaxAddressIndexes[accounts[currentAccount]].change?addAddress(self.assocIndexesToWallets[accounts[currentAccount]],1,0,assocMaxAddressIndexes[accounts[currentAccount]].change):(currentAccount++,currentAccount<accounts.length?startAddToNewWallet(0):cb()):addAddress(self.assocIndexesToWallets[accounts[currentAccount]],0,0,assocMaxAddressIndexes[accounts[currentAccount]].main+40)}var accounts=Object.keys(assocMaxAddressIndexes),currentAccount=0;startAddToNewWallet(0)}function scanForAddressesAndWalletsInLightClient(cb){function checkAndAddCurrentAddresses(is_change){assocMaxAddressIndexes[currentWalletIndex]||(assocMaxAddressIndexes[currentWalletIndex]={main:0,change:0});for(var arrTmpAddresses=[],i=0;i<40;i++){var index=(is_change?assocMaxAddressIndexes[currentWalletIndex].change:assocMaxAddressIndexes[currentWalletIndex].main)+i;arrTmpAddresses.push(objectHash.getChash160(["sig",{pubkey:wallet_defined_by_keys.derivePubkey(xPubKey,"m/"+is_change+"/"+index)}]))}myWitnesses.readMyWitnesses(function(arrWitnesses){network.requestFromLightVendor("light/get_history",{addresses:arrTmpAddresses,witnesses:arrWitnesses},function(ws,request,response){if(response&&response.error){var breadcrumbs=require("trustnote-common/breadcrumbs.js");return breadcrumbs.add("Error scanForAddressesAndWalletsInLightClient: "+response.error),self.error=gettextCatalog.getString("please try again later."),self.scanning=!1,$scope.index.showneikuangsync=!1,void $timeout(function(){$rootScope.$apply()})}Object.keys(response).length?(lastUsedWalletIndex=currentWalletIndex,is_change?assocMaxAddressIndexes[currentWalletIndex].change+=40:assocMaxAddressIndexes[currentWalletIndex].main+=40,checkAndAddCurrentAddresses(is_change)):is_change?(0===assocMaxAddressIndexes[currentWalletIndex].change&&0===assocMaxAddressIndexes[currentWalletIndex].main&&delete assocMaxAddressIndexes[currentWalletIndex],currentWalletIndex++,currentWalletIndex>self.totalWallet-1?cb(assocMaxAddressIndexes):setCurrentWallet()):checkAndAddCurrentAddresses(1)})})}function setCurrentWallet(){xPubKey=Bitcore.HDPublicKey.fromString(self.assocWallets[currentWalletIndex]),checkAndAddCurrentAddresses(0)}var xPubKey,currentWalletIndex=0,lastUsedWalletIndex=-1,assocMaxAddressIndexes={};setCurrentWallet()}function cleanAndAddWalletsAndAddresses(assocMaxAddressIndexes){var arrWalletIndexes=Object.keys(assocMaxAddressIndexes);arrWalletIndexes.length&&createAddresses(assocMaxAddressIndexes,function(){self.scanning=!1,$scope.index.showneikuangsync=!1,$rootScope.$emit("Local/ShowAlert",gettextCatalog.getString("Synchronization completed"),"fi-check",function(){$rootScope.$emit("Local/Synchronization")})})}var conf=require("trustnote-common/conf.js"),wallet_defined_by_keys=require("trustnote-common/wallet_defined_by_keys.js"),objectHash=require("trustnote-common/object_hash.js"),Bitcore=require("bitcore-lib"),db=require("trustnote-common/db.js"),network=require("trustnote-common/network"),myWitnesses=require("trustnote-common/my_witnesses"),self=this;self.error="",self.bLight=conf.bLight,self.scanning=!1,self.xPrivKey="",self.assocIndexesToWallets={},self.assocWallets={},self.credentialsEncrypted=!1,self.totalWallet=0,self.synchronization=function(){self.scanning=!0,$scope.index.showneikuangsync=!0,delete profileService.haschoosen,self.totalWallet=profileService.profile.credentials.length;for(var i=0;i<profileService.profile.credentials.length;i++)self.assocIndexesToWallets[i]=profileService.profile.credentials[i].walletId,self.assocWallets[i]=profileService.profile.credentials[i].xPubKey;self.scanning=!0,self.bLight?scanForAddressesAndWalletsInLightClient(cleanAndAddWalletsAndAddresses):scanForAddressesAndWallets(cleanAndAddWalletsAndAddresses)}}),angular.module("copayApp.controllers").controller("topbarController",function($scope,$rootScope,go,profileService){this.onQrCodeScanned=function(data){go.handleUri(data)},this.openSendScreen=function(){go.send()},this.onBeforeScan=function(){},this.goHome=function(){go.walletHome()},this.goWallet=function(){"undefined"!=typeof profileService.tempWalletId&&profileService.tempWalletId!=$scope.index.walletId&&profileService.setAndStoreFocus(profileService.tempWalletId,!1,function(){delete profileService.tempWalletId}),go.wallet()}}),angular.module("copayApp.controllers").controller("versionController",function(){var conf=require("trustnote-common/conf.js");this.version=window.version,this.commitHash=window.commitHash,this.type=conf.bLight?"light":""}),angular.module("copayApp.controllers").controller("versionAndWalletTypeController",function(){var conf=require("trustnote-common/conf.js");this.type=conf.bLight?"light":"",this.version=window.version,this.commitHash=window.commitHash});var constants=require("trustnote-common/constants.js"),eventBus=require("trustnote-common/event_bus.js"),breadcrumbs=require("trustnote-common/breadcrumbs.js"),Bitcore=require("bitcore-lib"),objectHash=require("trustnote-common/object_hash.js"),ecdsaSig=require("trustnote-common/signature.js");angular.module("copayApp.controllers").controller("walletHomeController",function($scope,$rootScope,$timeout,$filter,$modal,$log,notification,isCordova,profileService,lodash,configService,storageService,gettext,gettextCatalog,nodeWebkit,addressService,confirmDialog,animationService,addressbookService,correspondentListService,newVersion,autoUpdatingWitnessesList,go){function onNewWalletAddress(new_address){console.log("==== NEW ADDRESSS "+new_address),self.addr={},self.setAddress()}function getAmountInSmallestUnits(amount,asset){return console.log(amount,asset,self.unitValue),"base"===asset?amount*=self.unitValue:asset===constants.BLACKBYTES_ASSET&&(amount*=self.bbUnitValue),Math.round(amount)}function getAmountInDisplayUnits(amount,asset){return"base"===asset?amount/=self.unitValue:asset===constants.BLACKBYTES_ASSET&&(amount/=self.bbUnitValue),amount}var self=this,home=this,conf=require("trustnote-common/conf.js"),chatStorage=require("trustnote-common/chat_storage.js");this.protocol=conf.program,$rootScope.hideMenuBar=!1,$rootScope.wpInputFocused=!1;var config=configService.getSync(),configWallet=config.wallet,indexScope=$scope.index;$scope.currentSpendUnconfirmed=configWallet.spendUnconfirmed;var walletSettings=configWallet.settings;this.unitValue=walletSettings.unitValue,this.bbUnitValue=walletSettings.bbUnitValue,this.unitName=walletSettings.unitName,this.bbUnitName=walletSettings.bbUnitName,this.unitDecimals=walletSettings.unitDecimals,this.isCordova=isCordova,this.addresses=[],this.isMobile=isMobile.any(),this.isWindowsPhoneApp=isMobile.Windows()&&isCordova,this.blockUx=!1,this.showScanner=!1,this.addr={},this.isTestnet=constants.version.match(/t$/),this.testnetName="2"===constants.alt?"[NEW TESTNET]":"[TESTNET]",$scope.index.tab="walletHome";var fc=profileService.focusedClient;fc.observed?go.observed=1:go.observed=0,self.observed=fc.observed,self.showTitle=0,storageService.gethaschoosen(function(err,val){val||2==val||storageService.hashaschoosen(2,function(){})});var disablePaymentRequestListener=$rootScope.$on("paymentRequest",function(event,address,amount,asset,recipient_device_address){console.log("paymentRequest event "+address+", "+amount),$rootScope.$emit("Local/SetTab","send"),self.setForm(address,amount,null,asset,recipient_device_address);var form=$scope.sendForm;form.address.$invalid&&!self.blockUx&&(console.log("invalid address, resetting form"),self.resetForm(),self.error=gettext("Could not recognize a valid Trustnote QR Code"))}),disablePaymentUriListener=$rootScope.$on("paymentUri",function(event,uri){$timeout(function(){$rootScope.$emit("Local/SetTab","send"),self.setForm(uri)},100)}),disableAddrListener=$rootScope.$on("Local/NeedNewAddress",function(){self.setAddress(!0)}),disableFocusListener=$rootScope.$on("Local/NewFocusedWallet",function(){self.addr={},self.resetForm()}),disableResumeListener=$rootScope.$on("Local/Resume",function(){}),disableTabListener=$rootScope.$on("Local/TabChanged",function(e,tab){switch(console.log("tab changed "+tab),tab){case"receive":self.setAddress();break;case"history":$rootScope.$emit("Local/NeedFreshHistory");break;case"send":self.resetError()}}),disableOngoingProcessListener=$rootScope.$on("Addon/OngoingProcess",function(e,name){self.setOngoingProcess(name)});eventBus.on("new_wallet_address",onNewWalletAddress),$scope.$on("$destroy",function(){console.log("walletHome $destroy"),disableAddrListener(),disablePaymentRequestListener(),disablePaymentUriListener(),disableTabListener(),disableFocusListener(),disableResumeListener(),disableOngoingProcessListener(),$rootScope.hideMenuBar=!1,eventBus.removeListener("new_wallet_address",onNewWalletAddress)});gettextCatalog.getString("Accept"),gettextCatalog.getString("Cancel"),gettextCatalog.getString("Confirm");$scope.openDestinationAddressModal=function(wallets,address){$rootScope.modalOpened=!0;var fc=profileService.focusedClient,ModalInstanceCtrl=function($scope,$modalInstance){$scope.wallets=wallets,$scope.editAddressbook=!1,$scope.addAddressbookEntry=!1,$scope.selectedAddressbook={},$scope.newAddress=address,$scope.addressbook={address:$scope.newAddress||"",label:""},$scope.color=fc.backgroundColor,$scope.bAllowAddressbook=self.canSendExternalPayment(),$scope.beforeQrCodeScann=function(){$scope.error=null,$scope.addAddressbookEntry=!0,$scope.editAddressbook=!1},$scope.onQrCodeScanned=function(data,addressbookForm){$timeout(function(){var form=addressbookForm;data&&form&&(data=data.replace(self.protocol+":",""),form.address.$setViewValue(data),form.address.$isValid=!0,form.address.$render()),$scope.$digest()},100)},$scope.selectAddressbook=function(addr){$modalInstance.close(addr)},$scope.toggleEditAddressbook=function(){$scope.editAddressbook=!$scope.editAddressbook,$scope.selectedAddressbook={},$scope.addAddressbookEntry=!1},$scope.toggleSelectAddressbook=function(addr){$scope.selectedAddressbook[addr]=!$scope.selectedAddressbook[addr]},$scope.toggleAddAddressbookEntry=function(){$scope.error=null,$scope.addressbook={address:$scope.newAddress||"",label:""},$scope.addAddressbookEntry=!$scope.addAddressbookEntry},$scope.listEntries=function(){$scope.error=null,addressbookService.list(function(err,ab){return err?void($scope.error=err):($scope.list=ab,void $timeout(function(){$rootScope.$apply()}))})},$scope.add=function(addressbook){$scope.error=null,$timeout(function(){addressbookService.add(addressbook,function(err,ab){return err?void($scope.error=err):($rootScope.$emit("Local/AddressbookUpdated",ab),$scope.list=ab,$scope.editAddressbook=!0,$scope.toggleEditAddressbook(),void $scope.$digest())})},100)},$scope.remove=function(addr){$scope.error=null,$timeout(function(){addressbookService.remove(addr,function(err,ab){return err?void($scope.error=err):($rootScope.$emit("Local/AddressbookUpdated",ab),$scope.list=ab,void $scope.$digest())})},100)},$scope.cancel=function(){breadcrumbs.add("openDestinationAddressModal cancel"),$modalInstance.dismiss("cancel")},$scope.selectWallet=function(walletId,walletName){$scope.selectedWalletName=walletName,addressService.getAddress(walletId,!1,function(err,addr){return $scope.gettingAddress=!1,err?(self.error=err,breadcrumbs.add("openDestinationAddressModal getAddress err: "+err),void $modalInstance.dismiss("cancel")):void $modalInstance.close(addr)})}},modalInstance=$modal.open({templateUrl:"views/modals/destination-address.html",windowClass:animationService.modalAnimated.slideUp,controller:ModalInstanceCtrl}),disableCloseModal=$rootScope.$on("closeModal",function(){breadcrumbs.add("openDestinationAddressModal on closeModal"),modalInstance.dismiss("cancel")});modalInstance.result["finally"](function(){$rootScope.modalOpened=!1,disableCloseModal();var m=angular.element(document.getElementsByClassName("reveal-modal"));m.addClass(animationService.modalAnimated.slideOutDown)}),modalInstance.result.then(function(addr){addr&&self.setToAddress(addr)})},$scope.openSharedAddressDefinitionModal=function(address){$rootScope.modalOpened=!0;var fc=profileService.focusedClient,ModalInstanceCtrl=function($scope,$modalInstance){$scope.color=fc.backgroundColor,$scope.address=address,$scope.shared_address_cosigners=indexScope.shared_address_cosigners;var walletGeneral=require("trustnote-common/wallet_general.js"),walletDefinedByAddresses=require("trustnote-common/wallet_defined_by_addresses.js");walletGeneral.readMyAddresses(function(arrMyAddresses){walletDefinedByAddresses.readSharedAddressDefinition(address,function(arrDefinition,creation_ts){$scope.humanReadableDefinition=correspondentListService.getHumanReadableDefinition(arrDefinition,arrMyAddresses,[],!0),$scope.creation_ts=creation_ts,$timeout(function(){$scope.$apply()})})}),$scope.sendPayment=function(address,amount,asset){return asset&&0===indexScope.arrBalances.filter(function(balance){return balance.asset===asset}).length?console.log("i do not own anything of asset "+asset):($modalInstance.dismiss("done"),void $timeout(function(){indexScope.shared_address=null,indexScope.updateAll(),indexScope.updateTxHistory(),$rootScope.$emit("paymentRequest",address,amount,asset)}))},$scope.cancel=function(){breadcrumbs.add("openSharedAddressDefinitionModal cancel"),$modalInstance.dismiss("cancel")}},modalInstance=$modal.open({templateUrl:"views/modals/address-definition.html",windowClass:animationService.modalAnimated.slideUp,controller:ModalInstanceCtrl}),disableCloseModal=$rootScope.$on("closeModal",function(){breadcrumbs.add("openSharedAddressDefinitionModal on closeModal"),modalInstance.dismiss("cancel")});modalInstance.result["finally"](function(){$rootScope.modalOpened=!1,disableCloseModal();var m=angular.element(document.getElementsByClassName("reveal-modal"));m.addClass(animationService.modalAnimated.slideOutDown)})},this.openTxpModal=function(tx,copayers){},this.setAddress=function(forceNew){self.addrError=null;var fc=profileService.focusedClient;if(fc&&(forceNew||!self.addr[fc.credentials.walletId])){if(indexScope.shared_address&&forceNew)throw Error("attempt to generate for shared address");self.generatingAddress=!0,$timeout(function(){addressService.getAddress(fc.credentials.walletId,forceNew,function(err,addr){self.generatingAddress=!1,err?self.addrError=err:addr&&(self.addr[fc.credentials.walletId]=addr),$timeout(function(){$scope.$digest()})})})}},this.copyAddress=function(addr){isCordova?(window.cordova.plugins.clipboard.copy(addr),window.plugins.toast.showShortCenter(gettextCatalog.getString("Copied to clipboard"))):nodeWebkit.isDefined()&&nodeWebkit.writeToClipboard(addr)},this.shareAddress=function(addr){isCordova&&((isMobile.Android()||isMobile.Windows())&&(window.ignoreMobilePause=!0),window.plugins.socialsharing.share(self.protocol+":"+addr,null,null,null))},this.openCustomizedAmountModal=function(addr){$rootScope.modalOpened=!0;var self=this,fc=profileService.focusedClient,ModalInstanceCtrl=function($scope,$modalInstance){$scope.addr=addr,$scope.color=fc.backgroundColor,$scope.unitName=self.unitName,$scope.unitValue=self.unitValue,$scope.unitDecimals=self.unitDecimals,$scope.bbUnitValue=walletSettings.bbUnitValue,$scope.bbUnitName=walletSettings.bbUnitName,$scope.isCordova=isCordova,$scope.buttonLabel=gettextCatalog.getString("Generate QR Code"),$scope.protocol=conf.program,Object.defineProperty($scope,"_customAmount",{get:function(){return $scope.customAmount},set:function(newValue){$scope.customAmount=newValue},enumerable:!0,configurable:!0}),$scope.submitForm=function(form){if(0===$scope.index.arrBalances.length)return console.log("openCustomizedAmountModal: no balances yet");var amount=form.amount.$modelValue,asset=$scope.index.arrBalances[$scope.index.assetIndex].asset;if(!asset)throw Error("no asset");var amountInSmallestUnits="base"===asset?parseInt((amount*$scope.unitValue).toFixed(0)):asset===constants.BLACKBYTES_ASSET?parseInt((amount*$scope.bbUnitValue).toFixed(0)):amount;$timeout(function(){$scope.customizedAmountUnit=amount+" "+("base"===asset?$scope.unitName:asset===constants.BLACKBYTES_ASSET?$scope.bbUnitName:"of "+asset),$scope.amountInSmallestUnits=amountInSmallestUnits,$scope.asset_param="base"===asset?"":"&asset="+encodeURIComponent(asset)},1)},$scope.shareAddress=function(uri){isCordova&&((isMobile.Android()||isMobile.Windows())&&(window.ignoreMobilePause=!0),window.plugins.socialsharing.share(uri,null,null,null))},$scope.cancel=function(){breadcrumbs.add("openCustomizedAmountModal: cancel"),$modalInstance.dismiss("cancel")}},modalInstance=$modal.open({templateUrl:"views/modals/customized-amount.html",windowClass:animationService.modalAnimated.slideUp,controller:ModalInstanceCtrl,scope:$scope}),disableCloseModal=$rootScope.$on("closeModal",function(){breadcrumbs.add("openCustomizedAmountModal: on closeModal"),modalInstance.dismiss("cancel")});modalInstance.result["finally"](function(){$rootScope.modalOpened=!1,disableCloseModal();var m=angular.element(document.getElementsByClassName("reveal-modal"));m.addClass(animationService.modalAnimated.slideOutDown)})};var unwatchSpendUnconfirmed=$scope.$watch("currentSpendUnconfirmed",function(newVal,oldVal){newVal!=oldVal&&($scope.currentSpendUnconfirmed=newVal)});$scope.$on("$destroy",function(){unwatchSpendUnconfirmed()}),this.resetError=function(){this.error=this.success=null},this.bindTouchDown=function(tries){var self=this;if(tries=tries||0,!(tries>5)){var e=document.getElementById("menu-walletHome");if(!e)return $timeout(function(){self.bindTouchDown(++tries)},500);$log.debug("Binding touchstart elements..."),["hamburger","menu-walletHome","menu-send","menu-receive","menu-history"].forEach(function(id){var e=document.getElementById(id);e&&e.addEventListener("touchstart",function(){try{event.preventDefault()}catch(e){}angular.element(e).triggerHandler("click")},!0)})}},this.hideMenuBar=lodash.debounce(function(hide){hide?($rootScope.hideMenuBar=!0,this.bindTouchDown()):$rootScope.hideMenuBar=!1,$rootScope.$digest()},100),this.formFocus=function(what){isCordova&&!this.isWindowsPhoneApp&&this.hideMenuBar(what),this.isWindowsPhoneApp&&(what?"amount"==what?this.hideAddress=!0:"msg"==what&&(this.hideAddress=!0,this.hideAmount=!0):(this.hideAddress=!1,this.hideAmount=!1),$timeout(function(){$rootScope.$digest()},1))},this.setSendFormInputs=function(){Object.defineProperty($scope,"_amount",{get:function(){return $scope.__amount},set:function(newValue){$scope.__amount=newValue,self.resetError()},enumerable:!0,configurable:!0}),Object.defineProperty($scope,"_address",{get:function(){return $scope.__address},set:function(newValue){$scope.__address=self.onAddressChange(newValue),$scope.sendForm&&$scope.sendForm.address.$valid&&(self.lockAddress=!0)},enumerable:!0,configurable:!0});profileService.focusedClient;this.hideNote=!0},this.setSendError=function(err){var fc=profileService.focusedClient,prefix=fc.credentials.m>1?gettextCatalog.getString("Could not create payment proposal"):gettextCatalog.getString("Could not send payment");this.error=prefix+": "+err,console.log(this.error),$timeout(function(){$scope.$digest()},1)},this.setOngoingProcess=function(name){var self=this;self.blockUx=!!name,isCordova?name?(window.plugins.spinnerDialog.hide(),window.plugins.spinnerDialog.show(null,name+"...",!0)):window.plugins.spinnerDialog.hide():(self.onGoingProcess=name,$timeout(function(){$rootScope.$apply()}))},this.submitForm=function(){if(0===$scope.index.arrBalances.length)return console.log("send payment: no balances yet");var fc=profileService.focusedClient,unitValue=this.unitValue,bbUnitValue=this.bbUnitValue;isCordova&&this.isWindowsPhoneApp&&(this.hideAddress=!1,this.hideAmount=!1);var form=$scope.sendForm;if(!form)return console.log("form is gone");if(self.bSendAll&&form.amount.$setValidity("validAmount",!0),form.$invalid)return void(this.error=gettext("Unable to send transaction proposal"));if(fc.isPrivKeyEncrypted())return void profileService.unlockFC(null,function(err){return err?self.setSendError(gettextCatalog.getString(err.message)):self.submitForm()});1==self.observed&&($scope.index.showTitle=0,self.showTitle=1);var comment=form.comment.$modelValue;if(comment){var msg="Could not add message to imported wallet without shared encrypting key";return $log.warn(msg),self.setSendError(gettext(msg))}var asset=$scope.index.arrBalances[$scope.index.assetIndex].asset;console.log("asset "+asset);var address=form.address.$modelValue,recipient_device_address=assocDeviceAddressesByPaymentAddress[address],amount=form.amount.$modelValue,merkle_proof="";form.merkle_proof&&form.merkle_proof.$modelValue&&(merkle_proof=form.merkle_proof.$modelValue.trim()),"base"===asset&&(amount*=unitValue),asset===constants.BLACKBYTES_ASSET&&(amount*=bbUnitValue),amount=Math.round(amount);var current_payment_key=""+asset+address+amount;return current_payment_key===self.current_payment_key?$rootScope.$emit("Local/ShowErrorAlert","This payment is already under way"):(self.current_payment_key=current_payment_key,indexScope.setOngoingProcess(gettext("sending"),!0),void $timeout(function(){profileService.requestTouchid(function(err){function composeAndSend(to_address){var arrSigningDeviceAddresses=[];fc.credentials.m<fc.credentials.n?$scope.index.copayers.forEach(function(copayer){(copayer.me||copayer.signs)&&arrSigningDeviceAddresses.push(copayer.device_address)}):indexScope.shared_address&&(arrSigningDeviceAddresses=indexScope.copayers.map(function(copayer){return copayer.device_address})),breadcrumbs.add("sending payment in "+asset),profileService.bKeepUnlocked=!0;var opts={shared_address:indexScope.shared_address,merkle_proof:merkle_proof,asset:asset,to_address:to_address,amount:amount,send_all:self.bSendAll,arrSigningDeviceAddresses:arrSigningDeviceAddresses,recipient_device_address:recipient_device_address};self.sendtoaddress=opts.to_address,self.sendamount=opts.amount/1e6+"MN";var eventListeners=eventBus.listenerCount("apiTowalletHome");self.reCallApiToWalletHome=function(account,is_change,address_index,text_to_sign,cb){var coin="livenet"==profileService.focusedClient.credentials.network?"0":"1",path="m/44'/"+coin+"'/"+account+"'/"+is_change+"/"+address_index,xPrivKey=new Bitcore.HDPrivateKey.fromString(profileService.focusedClient.credentials.xPrivKey),privateKey=xPrivKey.derive(path).privateKey,privKeyBuf=privateKey.bn.toBuffer({size:32}),signature=ecdsaSig.sign(text_to_sign,privKeyBuf);cb(signature),eventBus.once("apiTowalletHome",self.reCallApiToWalletHome)},self.callApiToWalletHome=function(account,is_change,address_index,text_to_sign,cb){var coin="livenet"==profileService.focusedClient.credentials.network?"0":"1",path="m/44'/"+coin+"'/"+account+"'/"+is_change+"/"+address_index,obj={type:"h2",sign:text_to_sign.toString("base64"),path:path,addr:opts.to_address,amount:opts.amount,v:Math.floor(9e3*Math.random()+1e3)};self.text_to_sign_qr="TTT:"+JSON.stringify(obj),$timeout(function(){profileService.tempNum2=obj.v,$scope.$apply()},10),eventBus.once("apiTowalletHome",self.callApiToWalletHome);var finishListener=eventBus.listenerCount("finishScaned");finishListener>0&&eventBus.removeAllListeners("finishScaned"),eventBus.once("finishScaned",function(signature){cb(signature)})},eventListeners>0?(eventBus.removeAllListeners("apiTowalletHome"),fc.observed?eventBus.once("apiTowalletHome",self.callApiToWalletHome):eventBus.once("apiTowalletHome",self.reCallApiToWalletHome)):fc.observed?eventBus.once("apiTowalletHome",self.callApiToWalletHome):eventBus.once("apiTowalletHome",self.reCallApiToWalletHome),fc.sendMultiPayment(opts,function(err){if(indexScope.setOngoingProcess(gettext("sending"),!1),breadcrumbs.add("done payment in "+asset+", err="+err),delete self.current_payment_key,profileService.bKeepUnlocked=!1,err)return"object"==typeof err?(err=JSON.stringify(err),eventBus.emit("nonfatal_error","error object from sendMultiPayment: "+err,new Error)):err.match(/device address/)?err="This is a private asset, please send it only by clicking links from chat":err.match(/no funded/)?err=gettextCatalog.getString("Not enough spendable funds"):err.match(/connection closed/)?err=gettextCatalog.getString("[internal] connection closed"):err.match(/one of the cosigners refused to sign/)?err=gettextCatalog.getString("one of the cosigners refused to sign"):err.match(/funds from/)?err=err.substring(err.indexOf("from")+4,err.indexOf("for"))+gettextCatalog.getString(err.substr(0,err.indexOf("from")))+gettextCatalog.getString(". It needs atleast ")+parseInt(err.substring(err.indexOf("for")+3,err.length))/1e6+"MN":"close"==err&&(err="suspend transaction."),1==self.observed&&($scope.index.showTitle=1,self.showTitle=0),self.setSendError(err);var binding=self.binding;if(self.resetForm(),$rootScope.$emit("NewOutgoingTx"),recipient_device_address){if(eventBus.emit("sent_payment",recipient_device_address,amount||"all",asset,!!binding),binding&&binding.reverseAmount){if(!my_address)throw Error("my address not known");var paymentRequestCode="TTT:"+my_address+"?amount="+binding.reverseAmount+"&asset="+encodeURIComponent(binding.reverseAsset),paymentRequestText="[reverse payment]("+paymentRequestCode+")";device.sendMessageToDevice(recipient_device_address,"text",paymentRequestText);var body=correspondentListService.formatOutgoingMessage(paymentRequestText);correspondentListService.addMessageEvent(!1,recipient_device_address,body),device.readCorrespondent(recipient_device_address,function(correspondent){correspondent.my_record_pref&&correspondent.peer_record_pref&&chatStorage.store(correspondent.device_address,body,0,"html")}),walletDefinedByKeys.issueNextAddress(fc.credentials.walletId,0,function(){})}}else $rootScope.$emit("Local/SetTab","walletHome")})}if(err)return profileService.lockFC(),indexScope.setOngoingProcess(gettext("sending"),!1),self.error=err,void $timeout(function(){delete self.current_payment_key,$scope.$digest()},1);var device=require("trustnote-common/device.js");if(self.binding){if(!recipient_device_address)throw Error("recipient device address not known");var my_address,walletDefinedByAddresses=require("trustnote-common/wallet_defined_by_addresses.js"),walletDefinedByKeys=require("trustnote-common/wallet_defined_by_keys.js");walletDefinedByKeys.issueNextAddress(fc.credentials.walletId,0,function(addressInfo){if(my_address=addressInfo.address,"reverse_payment"===self.binding.type)var arrSeenCondition=["seen",{what:"output",address:my_address,asset:self.binding.reverseAsset,amount:self.binding.reverseAmount}],arrDefinition=["or",[["and",[["address",address],arrSeenCondition]],["and",[["address",my_address],["not",arrSeenCondition],["in data feed",[[configService.TIMESTAMPER_ADDRESS],"timestamp",">",Date.now()+Math.round(3600*self.binding.timeout*1e3)]]]]]],assocSignersByPath={"r.0.0":{address:address,member_signing_path:"r",device_address:recipient_device_address},"r.1.0":{address:my_address,member_signing_path:"r",device_address:device.getMyDeviceAddress()}};else{var arrEventCondition,arrExplicitEventCondition=["in data feed",[[self.binding.oracle_address],self.binding.feed_name,"=",self.binding.feed_value]],arrMerkleEventCondition=["in merkle",[[self.binding.oracle_address],self.binding.feed_name,self.binding.feed_value]];if("explicit"===self.binding.feed_type)arrEventCondition=arrExplicitEventCondition;else if("merkle"===self.binding.feed_type)arrEventCondition=arrMerkleEventCondition;else{if("either"!==self.binding.feed_type)throw Error("unknown feed type: "+self.binding.feed_type);arrEventCondition=["or",[arrMerkleEventCondition,arrExplicitEventCondition]]}var arrDefinition=["or",[["and",[["address",address],arrEventCondition]],["and",[["address",my_address],["in data feed",[[configService.TIMESTAMPER_ADDRESS],"timestamp",">",Date.now()+Math.round(3600*self.binding.timeout*1e3)]]]]]],assocSignersByPath={"r.0.0":{address:address,member_signing_path:"r",device_address:recipient_device_address},"r.1.0":{address:my_address,member_signing_path:"r",device_address:device.getMyDeviceAddress()}};"merkle"!==self.binding.feed_type&&"either"!==self.binding.feed_type||(assocSignersByPath["merkle"===self.binding.feed_type?"r.0.1":"r.0.1.0"]={address:"",member_signing_path:"r",device_address:recipient_device_address})}walletDefinedByAddresses.createNewSharedAddress(arrDefinition,assocSignersByPath,{ifError:function(err){
delete self.current_payment_key,indexScope.setOngoingProcess(gettext("sending"),!1),self.setSendError(err)},ifOk:function(shared_address){composeAndSend(shared_address)}})})}else composeAndSend(address)})},100))},this.closeColdPay=function(){eventBus.emit("finishScaned","close")};var assocDeviceAddressesByPaymentAddress={};this.canSendExternalPayment=function(){if(0===$scope.index.arrBalances.length)return!0;if(!$scope.index.arrBalances[$scope.index.assetIndex].is_private)return!0;var form=$scope.sendForm;if(!form||!form.address)return!0;var address=form.address.$modelValue,recipient_device_address=assocDeviceAddressesByPaymentAddress[address];return!!recipient_device_address},this.deviceAddressIsKnown=function(){if(0===$scope.index.arrBalances.length)return!1;var form=$scope.sendForm;if(!form||!form.address)return!1;var address=form.address.$modelValue,recipient_device_address=assocDeviceAddressesByPaymentAddress[address];return!!recipient_device_address},this.openBindModal=function(){$rootScope.modalOpened=!0;var fc=profileService.focusedClient,form=$scope.sendForm;if(form&&form.address){var ModalInstanceCtrl=(form.address,function($scope,$modalInstance){$scope.color=fc.backgroundColor,$scope.arrPublicAssetInfos=indexScope.arrBalances.filter(function(b){return!b.is_private}).map(function(b){var info={asset:b.asset};return"base"===b.asset?info.displayName=self.unitName:b.asset===constants.BLACKBYTES_ASSET?info.displayName=self.bbUnitName:info.displayName="of "+b.asset.substr(0,4),info}),$scope.binding={type:"reverse_payment",timeout:4,reverseAsset:"base",feed_type:"either"},self.binding&&($scope.binding.type=self.binding.type,$scope.binding.timeout=self.binding.timeout,"reverse_payment"===self.binding.type?($scope.binding.reverseAsset=self.binding.reverseAsset,$scope.binding.reverseAmount=getAmountInDisplayUnits(self.binding.reverseAmount,self.binding.reverseAsset)):($scope.binding.oracle_address=self.binding.oracle_address,$scope.binding.feed_name=self.binding.feed_name,$scope.binding.feed_value=self.binding.feed_value,$scope.binding.feed_type=self.binding.feed_type)),$scope.oracles=configService.oracles,$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.bind=function(){var binding={type:$scope.binding.type};"reverse_payment"===binding.type?(binding.reverseAsset=$scope.binding.reverseAsset,binding.reverseAmount=getAmountInSmallestUnits($scope.binding.reverseAmount,$scope.binding.reverseAsset)):(binding.oracle_address=$scope.binding.oracle_address,binding.feed_name=$scope.binding.feed_name,binding.feed_value=$scope.binding.feed_value,binding.feed_type=$scope.binding.feed_type),binding.timeout=$scope.binding.timeout,self.binding=binding,$modalInstance.dismiss("done")}}),modalInstance=$modal.open({templateUrl:"views/modals/bind.html",windowClass:animationService.modalAnimated.slideUp,controller:ModalInstanceCtrl}),disableCloseModal=$rootScope.$on("closeModal",function(){modalInstance.dismiss("cancel")});modalInstance.result["finally"](function(){$rootScope.modalOpened=!1,disableCloseModal();var m=angular.element(document.getElementsByClassName("reveal-modal"));m.addClass(animationService.modalAnimated.slideOutDown)})}},this.setToAddress=function(to){var form=$scope.sendForm;return form&&form.address?(form.address.$setViewValue(to),form.address.$isValid=!0,form.address.$render(),void(this.lockAddress=!0)):console.log("form.address has disappeared")},this.setForm=function(to,amount,comment,asset,recipient_device_address){this.resetError(),delete this.binding;var form=$scope.sendForm;if(!form||!form.address)return console.log("form.address has disappeared");if(to&&(form.address.$setViewValue(to),form.address.$isValid=!0,form.address.$render(),this.lockAddress=!0,recipient_device_address&&(assocDeviceAddressesByPaymentAddress[to]=recipient_device_address)),amount?("base"===asset&&(amount/=this.unitValue),asset===constants.BLACKBYTES_ASSET&&(amount/=this.bbUnitValue),this.lockAmount=!0,$timeout(function(){form.amount.$setViewValue(""+amount),form.amount.$isValid=!0,form.amount.$render()})):(this.lockAmount=!1,form.amount.$pristine=!0,form.amount.$setViewValue(""),form.amount.$render()),form.merkle_proof&&(form.merkle_proof.$setViewValue(""),form.merkle_proof.$render()),comment&&(form.comment.$setViewValue(comment),form.comment.$isValid=!0,form.comment.$render()),asset){var assetIndex=lodash.findIndex($scope.index.arrBalances,{asset:asset});if(assetIndex<0)throw Error("failed to find asset index of asset "+asset);$scope.index.assetIndex=assetIndex,this.lockAsset=!0}else this.lockAsset=!1},this.resetForm=function(){this.resetError(),delete this.binding,this.lockAsset=!1,this.lockAddress=!1,this.lockAmount=!1,this.hideAdvSend=!0,$scope.currentSpendUnconfirmed=configService.getSync().wallet.spendUnconfirmed,this._amount=this._address=null,this.bSendAll=!1;var form=$scope.sendForm;form&&form.amount&&(form.amount.$pristine=!0,form.amount.$setViewValue(""),form.amount&&form.amount.$render(),form.merkle_proof&&(form.merkle_proof.$setViewValue(""),form.merkle_proof.$render()),form.comment&&(form.comment.$setViewValue(""),form.comment.$render()),form.$setPristine(),form.address&&(form.address.$pristine=!0,form.address.$setViewValue(""),form.address.$render())),$timeout(function(){$rootScope.$digest()},1)},this.setSendAll=function(){var form=$scope.sendForm;if(!form||!form.amount)return console.log("form.amount has disappeared");if(0!==indexScope.arrBalances.length)if("base"===indexScope.arrBalances[indexScope.assetIndex].asset)this._amount=null,this.bSendAll=!0,form.amount.$setViewValue(""),form.amount.$setValidity("validAmount",!0),form.amount.$render();else{var full_amount=indexScope.arrBalances[indexScope.assetIndex].stable;indexScope.arrBalances[indexScope.assetIndex].asset===constants.BLACKBYTES_ASSET&&(full_amount/=this.bbUnitValue),form.amount.$setViewValue(""+full_amount),form.amount.$render()}},this.setFromUri=function(uri){var objRequest;return require("trustnote-common/uri.js").parseUri(uri,{ifError:function(err){},ifOk:function(_objRequest){objRequest=_objRequest}}),objRequest?(objRequest.amount&&this.setForm(objRequest.address,objRequest.amount),objRequest.address):uri},this.onAddressChange=function(value){return this.resetError(),value?0===value.indexOf(self.protocol+":")?this.setFromUri(value):value:""},this.getUnitName=function(){return this.unitName},this.openTxModal=function(btx){$rootScope.modalOpened=!0;var self=this,fc=profileService.focusedClient,ModalInstanceCtrl=function($scope,$modalInstance){$scope.btx=btx;var assetIndex=lodash.findIndex(indexScope.arrBalances,{asset:btx.asset});$scope.isPrivate=indexScope.arrBalances[assetIndex].is_private,$scope.settings=walletSettings,$scope.color=fc.backgroundColor,$scope.n=fc.credentials.n,$scope.getAmount=function(amount){return self.getAmount(amount)},$scope.getUnitName=function(){return self.getUnitName()},$scope.openInExplorer=function(){var testnet=home.isTestnet?"testnet":"",url="https://"+testnet+"testexplorer.trustnote.org/#"+btx.unit;"undefined"!=typeof nw?nw.Shell.openExternal(url):isCordova&&cordova.InAppBrowser.open(url,"_system")},$scope.copyAddress=function(addr){addr&&self.copyAddress(addr)},$scope.showCorrespondentList=function(){self.showCorrespondentListToReSendPrivPayloads(btx)},$scope.reSendPrivateMultiSigPayment=function(){function success(){$timeout(function(){notification.success(gettextCatalog.getString("Success"),gettextCatalog.getString("Private payloads sent",{}))})}var indivisible_asset=require("trustnote-common/indivisible_asset"),wallet_defined_by_keys=require("trustnote-common/wallet_defined_by_keys"),walletDefinedByAddresses=require("trustnote-common/wallet_defined_by_addresses"),fc=profileService.focusedClient;indivisible_asset.restorePrivateChains(btx.asset,btx.unit,btx.addressTo,function(arrRecipientChains,arrCosignerChains){indexScope.shared_address?walletDefinedByAddresses.forwardPrivateChainsToOtherMembersOfAddresses(arrCosignerChains,[indexScope.shared_address],null,success):wallet_defined_by_keys.forwardPrivateChainsToOtherMembersOfWallets(arrCosignerChains,[fc.credentials.walletId],null,success)})},$scope.cancel=function(){breadcrumbs.add("dismiss tx details");try{$modalInstance.dismiss("cancel")}catch(e){}}},modalInstance=$modal.open({templateUrl:"views/modals/tx-details.html",windowClass:animationService.modalAnimated.slideRight,controller:ModalInstanceCtrl}),disableCloseModal=$rootScope.$on("closeModal",function(){breadcrumbs.add("on closeModal tx details"),modalInstance.dismiss("cancel")});modalInstance.result["finally"](function(){$rootScope.modalOpened=!1,disableCloseModal();var m=angular.element(document.getElementsByClassName("reveal-modal"));m.addClass(animationService.modalAnimated.slideOutRight)})},this.showCorrespondentListToReSendPrivPayloads=function(btx){$rootScope.modalOpened=!0;var self=this,fc=profileService.focusedClient,ModalInstanceCtrl=function($scope,$modalInstance,$timeout,go,notification){$scope.btx=btx,$scope.settings=walletSettings,$scope.color=fc.backgroundColor,$scope.readList=function(){$scope.error=null,correspondentListService.list(function(err,ab){return err?void($scope.error=err):($scope.list=ab,void $scope.$digest())})},$scope.sendPrivatePayments=function(correspondent){var indivisible_asset=require("trustnote-common/indivisible_asset"),wallet_general=require("trustnote-common/wallet_general");indivisible_asset.restorePrivateChains(btx.asset,btx.unit,btx.addressTo,function(arrRecipientChains,arrCosignerChains){wallet_general.sendPrivatePayments(correspondent.device_address,arrRecipientChains,!0,null,function(){modalInstance.dismiss("cancel"),go.history(),$timeout(function(){notification.success(gettextCatalog.getString("Success"),gettextCatalog.getString("Private payloads sent",{}))})})})},$scope.back=function(){self.openTxModal(btx)}},modalInstance=$modal.open({templateUrl:"views/modals/correspondentListToReSendPrivPayloads.html",windowClass:animationService.modalAnimated.slideRight,controller:ModalInstanceCtrl}),disableCloseModal=$rootScope.$on("closeModal",function(){modalInstance.dismiss("cancel")});modalInstance.result["finally"](function(){$rootScope.modalOpened=!1,disableCloseModal();var m=angular.element(document.getElementsByClassName("reveal-modal"));m.addClass(animationService.modalAnimated.slideOutRight)})},this.hasAction=function(actions,action){return actions.hasOwnProperty("create")},this._doSendAll=function(amount){this.setForm(null,amount,null)},this.sendAll=function(amount,feeStr){var self=this,msg=gettextCatalog.getString("{{fee}} will be deducted for bitcoin networking fees",{fee:feeStr});confirmDialog.show(msg,function(confirmed){confirmed&&self._doSendAll(amount)})},this.bindTouchDown(),this.setSendFormInputs(),profileService.focusedClient&&profileService.focusedClient.isComplete()&&this.setAddress();var db=require("trustnote-common/db.js"),async=require("async");db.query("SELECT device_address FROM extended_pubkeys",function(rows){var my_device_address=profileService.profile.my_device_address;if(my_device_address)for(var i=0;i<rows.length;i++)if(rows[i].device_address!==my_device_address){var arrQueries=[],definition_template_old='["sig",{"pubkey":"$pubkey@'+rows[i].device_address+'"}]',definition_template_new='["sig",{"pubkey":"$pubkey@'+my_device_address+'"}]';db.addQuery(arrQueries,"UPDATE extended_pubkeys SET device_address='"+my_device_address+"' WHERE device_address='"+rows[i].device_address+"'"),db.addQuery(arrQueries,"UPDATE wallets SET definition_template='"+definition_template_new+"' WHERE definition_template='"+definition_template_old+"'"),db.addQuery(arrQueries,"UPDATE wallet_signing_paths SET device_address='"+my_device_address+"' WHERE device_address='"+rows[i].device_address+"'"),async.series(arrQueries,function(){})}db.query("CREATE TABLE IF NOT EXISTS tcode (wallet CHAR(44) NOT NULL,num CHAR(16) NOT NULL,code CHAR(16) NOT NUll,amount BIGINT NOT NULL,is_spent TINYINT NOT NULL DEFAULT 0,creation_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,UNIQUE(wallet, num, code),FOREIGN KEY(wallet) REFERENCES wallets(wallet));",function(rows){})})}),window.version="1.1.6",window.commitHash="821a3ca",angular.element(document).ready(function(){var startAngular=function(){angular.bootstrap(document,["copayApp"])};void 0!==window.cordova?document.addEventListener("deviceready",function(){document.addEventListener("menubutton",function(){window.location="#/preferences"},!1),window.plugins.touchid.isAvailable(function(msg){window.touchidAvailable=!0},function(msg){window.touchidAvailable=!1}),startAngular()},!1):startAngular()})}).call(this,require("_process"),require("buffer").Buffer)},{"../angular-bitcore-wallet-client/bitcore-wallet-client/index.js":1,"./fileStorage.js":421,_process:309,async:26,"bitcore-lib":34,"bitcore-mnemonic":107,buffer:151,crypto:181,events:215,fs:147,jszip:244,"nw.gui":void 0,os:276,secp256k1:325,"trustnote-common/bots.js":364,"trustnote-common/breadcrumbs.js":365,"trustnote-common/chat_storage.js":368,"trustnote-common/conf":370,"trustnote-common/conf.js":370,"trustnote-common/constants.js":371,"trustnote-common/db":372,"trustnote-common/db.js":372,"trustnote-common/desktop_app.js":374,"trustnote-common/device":375,"trustnote-common/device.js":375,"trustnote-common/event_bus.js":378,"trustnote-common/indivisible_asset":381,"trustnote-common/light_wallet.js":384,"trustnote-common/mutex.js":388,"trustnote-common/my_witnesses":389,"trustnote-common/my_witnesses.js":389,"trustnote-common/network":391,"trustnote-common/network.js":391,"trustnote-common/object_hash.js":392,"trustnote-common/object_length":393,"trustnote-common/signature.js":399,"trustnote-common/storage.js":402,"trustnote-common/uri.js":403,"trustnote-common/validation_utils.js":405,"trustnote-common/wallet.js":406,"trustnote-common/wallet_defined_by_addresses":407,"trustnote-common/wallet_defined_by_addresses.js":407,"trustnote-common/wallet_defined_by_keys":408,"trustnote-common/wallet_defined_by_keys.js":408,"trustnote-common/wallet_general":409,"trustnote-common/wallet_general.js":409}]},{},[422]);